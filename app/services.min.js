"use strict";invoicesUnlimited.factory("accountFactory",["userFactory","roleFactory",function(e,t){var n=e,r={entity:[]},i=function(){var e;return n.get?e=n.get("accountInfo"):n.entity[0]&&n.entity[0].get&&(e=n.entity[0].get("accountInfo")),e?e.fetch().then(function(e){return setObjectOperations({object:e,fieldName:"accountInfo",parent:n.entity.length?n.entity[0]:null,fields:null}),r.entity.pop(),r.entity.push(e),r}):(r.empty=!0,e)};return r.clearAllOnLogOut=function(){r.entity.length=0},r.load=function(){return r.entity.length?r.entity[0]:i()},r.createNew=function(e){if(!r.entity.length){var i=new(Parse.Object.extend("AccountInfo"));return i.setACL(t.createACL()),i.save(e,{success:function(e){setObjectOperations({object:e,fieldName:"accountInfo",parent:n.entity.length?n.entity[0]:null,fields:void 0}),r.entity.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}})}},r}]),invoicesUnlimited.factory("businessFactory",["userFactory","roleFactory","$rootScope","$state",function(e,t,n,r){var i=e,a={entity:[]},o=["businessName","city","zipCode","streetName","state","phoneNumber"],s=function(){var e;return i.get?e=i.get("businessInfo"):i.entity[0]&&i.entity[0].get&&(e=i.entity[0].get("businessInfo")),e?e.fetch().then(function(e){return setObjectOperations({object:e,fieldName:"businessInfo",parent:i.entity.length?i.entity[0]:null,fields:o}),a.entity.pop(),a.entity.push(e),a},function(e){console.log(e.message),i.logout().then(function(){hideLoader(),resetColorTheme(),r.go("login")},function(e){r.go("login")})}):(a.empty=!0,e)};return a.clearAllOnLogOut=function(){a.entity.length=0},a.load=function(){return a.entity.length?a:s()},a.createNew=function(e){if(!a.entity.length){var n=new(Parse.Object.extend("BusinessInfo"));return n.setACL(t.createACL()),n.save(e,{success:function(e){setObjectOperations({object:e,fieldName:"businessInfo",parent:i.entity.length?i.entity[0]:null,fields:o}),a.entity.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}})}},a}]),invoicesUnlimited.factory("cleanDataService",["businessFactory","coreFactory","projectUserFactory","roleFactory","currencyFactory","organizationFactory","preferencesFactory","accountFactory","principalFactory","signatureFactory",function(e,t,n,r,i,a,o,s,c,u){return{clearAllOnLogOut:function(){e.clearAllOnLogOut(),t.clearAllOnLogOut(),n.clearAllOnLogOut(),r.clearAllOnLogOut(),i.clearAllOnLogOut(),a.clearAllOnLogOut(),o.clearAllOnLogOut(),s.clearAllOnLogOut(),c.clearAllOnLogOut(),u.clearAllOnLogOut()}}}]),invoicesUnlimited.factory("commentFactory",["userFactory",function(e){if(e){var t=function(e){e&&(setObjectOperations({object:e,fieldName:void 0,parent:void 0,fields:n}),this.date=e.date.formatDate("DD/MM/YY hh:mm",!0),this.entity=e)};t.createNewComment=function(e,t){var n=new(Parse.Object.extend("Comments")),r=new Parse.ACL;return r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0),n.setACL(r),n.save(e)};var n=["date","comment","name"];return t}}]),invoicesUnlimited.factory("contactPersonFactory",["userFactory",function(e){if(!e.entity.length)return{};var t=["email","phone","mobile","lastname","firstname","salutation","defaultPerson"];return function(e){setObjectOperations({object:e,fields:t}),this.id=e.get("objectId"),this.entity=e,this.fieldNames=t,this.save=function(){return this.entity.save()},this.destroy=function(e){if(!e)return this.entity.destroy();e.entity.remove("contactPersons",this.entity);var t=this;return e.save().then(function(e){return t.entity.destroy()},function(e){})}}}]),invoicesUnlimited.factory("coreFactory",["userFactory","customerFactory","creditNoteFactory","invoicesFactory","itemFactory","expenseCategoryFactory","queryService",function(e,t,n,r,i,a,o){var s=e,c={};if(s)return c.clearAllOnLogOut=function(){c.allCustomers=void 0},c.getAllCustomers=function(e){return c.allCustomers&&!e?c.allCustomers:"General Employee"==s.entity[0].get("role")?o.ext.find("Customer","userID",s.entity.length?s.entity[0]:{},[{name:"include",param:"contactPersons"}]).then(function(e){var n=[];return e.forEach(function(e){if(!e.attributes.isDeleted){var r=new t(e);n.push(r)}}),c.allCustomers=n,n}):o.ext.find("Customer","organization",s.entity.length?s.entity[0].get("selectedOrganization"):{},[{name:"include",param:"contactPersons"}]).then(function(e){var n=[];return e.forEach(function(e){if(!e.attributes.isDeleted){var r=new t(e);n.push(r)}}),c.allCustomers=n,n})},c.getAllInvoices=function(e){var t=new Parse.Query("Invoices");return e.method?t[e.method](e.name,e.val1,e.val2,e.val3):t.equalTo(e.name,e.val1),t.include("comments"),t.include("payment"),t.limit(1e3),t.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new r(e))}),t})},c.getAllCreditNotes=function(e){var t=new Parse.Query("CreditNotes");return e.method?t[e.method](e.name,e.val1,e.val2,e.val3):t.equalTo(e.name,e.val1),t.limit(1e3),t.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new n(e,"customerBalance"))}),t})},c.getAllItems=function(e){var t=new Parse.Query("Item");return t.equalTo("organization",e.organization),t.notEqualTo("isDeleted",1),t.include("tax"),t.limit(1e3),t.find().then(function(e){var t=[];return e.forEach(function(e){e.get("title").indexOf("Misc. Item")<0&&t.push(new i(e))}),t})},c.getAllItemsIncludingDelete=function(e){var t=new Parse.Query("Item");return t.equalTo("organization",e.organization),t.include("tax"),t.limit(1e3),t.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new i(e))}),t})},c.getUserRole=function(e){var t=new Parse.Query(Parse.Role);return t.equalTo("users",e),t.first().then(function(e){return e},function(e){console.log(e)})},c.getDefaultExpenseCategories=function(){var e=new Parse.Query("CategoryDefaults");return e.select("color","name","notes"),e.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new a(e))}),t})},c.getExpenseCategories=function(e){var t=new Parse.Query("Category");return t.equalTo("organization",e.organization),t.select("color","name","notes"),t.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new a(e))}),t})},c.getInvoiceTemplates=function(){var e=new Parse.Query("InvoiceTemplate");return e.select("name","templatePreview"),e.find()},c.getGeneralPrefs=function(e){return e.get("selectedOrganization").fetch()},c}]),invoicesUnlimited.factory("creditNoteService",["$q","creditNoteFactory","itemService","currencyFilter","currencyFactory",function(e,t,n,r,i){function a(e,t){return t.items=[],e.forEach(function(e){var n={title:e.selectedItem.entity.title,rate:e.selectedItem.entity.rate,expenseId:e.selectedItem.entity.expanseId};e.selectedItem.tax&&(n.tax=e.selectedItem.tax),t.items.push(n)}),n.createItems(t).then(function(t){for(var n=0;n<e.length;++n)e[n].selectedItem=t[n];return e})}function o(e,t){var n=new t.objectType;return n.setACL(t.acl),n.set("userID",t.user),n.set("organization",t.organization),n.set("item",e.selectedItem.entity),n.set("quantity",Number(e.quantity)),n.set("amount",Number(e.amount)),e.selectedTax&&n.set("tax",Parse.Object.extend("Tax").createWithoutData(e.selectedTax.id)),n}function s(e,t,n){return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:t}}).then(function(t){var r='Connect.open("GET", "uppage.xml"',i='Connect.open("GET", "'+e+'"';return i=i.replace("http:","https:"),t=t.replace(r,i),r="background: url(icn-card.png) no-repeat",i="background: url("+n+") no-repeat",i=i.replace("http:","https:"),t=t.replace(r,i),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:t}}).then(function(e){return e})})}function c(e,t,n){return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:t}}).then(function(t){var n='Connect.open("GET", "'+e+'"';return n=n.replace("http:","https:"),t=t.replace('Connect.open("GET", "uppage.xml"',n),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:t}}).then(function(e){return e},function(e){console.log(e)})})}function u(e,t,n,i){return $.ajax({type:"GET",url:"proxy.php",dataType:"xml",data:{address:e}}).then(function(e){var a=new X2JS,o=a.xml2json(e),s=o.items.label,c="$",u=1;s["invoice-title"]="Credit Note",s.billType="estimate",s["list-header-total"]="Total",s.headerTitle="",s["longmsg-title"]="Notes",s["ordernotes-title"]="Terms & Conditions",s.copyright="",s.disablePay="true",s["due-text"]="",s["due-price"]="",s["received-text"]="",s["received-price"]="",s.thanksmsg="",s["website-link"]="",s["website-name"]="",s["tip-text"]=s["tip-price"]="",o.items.shippingCharges="",o.items.shippingChargesPrice="",o.items.adjustments="",o.items.adjustmentsPrice="",s.discountPlace={text:""},s.paymentMadeText="Refund Made",s.creditsAppliedText="Credits Used",s.refundedText="Remaining Credits",s.ordernotes=n.get("terms"),s.longmsg=n.get("notes"),s["body-date"]=formatDate(n.get("creditNoteDate"),"MMM D, YYYY"),s["past-due"]=s["body-date"],s.purchaseOrderNumber=n.get("reference")?"Ref.# "+n.get("reference"):"",s.refid=n.get("creditNumber"),o.items.customFields.customField=void 0,o.items.attachments.attachment=void 0;var d=t.get("colorTheme");d?"appBlueColor"==d?s["app-color"]="#327DF5":"appSeagreenColor"==d?s["app-color"]="#23AA92":"appGreenColor"==d?s["app-color"]="#0EA81C":"appYellowColor"==d?s["app-color"]="#EDE005":"appBrownColor"==d?s["app-color"]="#E87605":"appRedColor"==d?s["app-color"]="#E80000":"appPinkColor"==d?s["app-color"]="#E657A3":"appPurpleColor"==d&&(s["app-color"]="#7F5CBF"):s["app-color"]="#327DF5",s.mailtotxt=t.get("email");var m=n.get("organization");m&&(s.mailto="mailto:"+m.get("email"),s.title="Credit from "+m.get("name"),m.get("logo")&&(s.logo=m.get("logo").url()));var f=t.get("businessInfo");if(f){var p=[f.get("streetName"),f.get("city"),f.get("state"),f.get("zipCode")];m.get("displayCountry")&&p.push(t.get("country")),s.addres1=p.join(", "),s["business-name"]=f.get("businessName"),s.nr=f.get("phoneNumber")}var g=n.get("customer");if(g){var h=g.get("email");s.clientmail=h,s.clientmailto="mailto:"+h,g.get("salutation")?s.clientname=g.get("salutation")+" "+g.get("displayName"):s.clientname=g.get("displayName"),s.clientnr=g.get("phone"),g.get("currency")&&(s["body-currency"]=g.get("currency").split(" ")[0]);var v=i.filter(function(e){return e.entity.title==g.get("currency")})[0];v&&(c=v.entity.currencySymbol,(u=v.entity.exchangeRate)||(u=1))}var y=o.items,x=o.items.label.taxes,b=0,P=0,w=n.get("creditNoteItems");if(w){y.itemRow=[],x.tax=[];for(var T=0;T<w.length;++T){var O=w[T].get("item").get("title"),j=w[T].get("quantity"),N=w[T].get("amount");P+=N;var C={name:O,qty:j,price:r(N*u,c,2)};y.itemRow.push(C);var I=w[T].get("tax");if(I){var F=I.get("title")+" ("+I.get("value")+"%)",E=l(w[T],I);b+=E;var A={name:F,value:r(E*u,c,2)};x.tax.push(A)}}x.tax.length||(x.tax=void 0)}else y.itemRow=void 0,x.tax=void 0;var D=P+b;s.subtotalprice=r(P*u,c,2);var z=D;s["total-price3"]=s["body-price"]=r(z*u,c,2);var q=n.get("refundsMade")||0,L=n.get("creditsUsed")||0;s.paymentMadePrice=r(q*u,c,2),s.creditsAppliedPrice=r(L*u,c,2);var R=z-q-L;return s.refundtotal=r(R*u,c,2),e=a.json2xml_str(o),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:e}}).then(function(e){return e})})}function l(e,t){var n=t.get("type"),r=t.get("value"),i=t.get("compound"),a=e.get("amount"),o=0;return 1==n?o=a*r*.01:2==n&&(o=a*r*.01,i&&(o=o*i*.01)),o}function d(e){var t=e.get("organizations");return t?t[0]:void 0}return{test:function(){console.log("working")},checkCreditNoteNumAvailable:function(e){var t=Parse.Object.extend("CreditNotes"),n=new Parse.Query(t);return n.equalTo("organization",e.organization),n.equalTo("creditNumber",e.creditNumber),n.select("creditNumber"),n.first().then(function(e){return!e})},getCustomerCreditNotes:function(e){var n=Parse.Object.extend("CreditNotes"),r=new Parse.Query(n);return r.select("remainingCredits","creditsUsed","creditNumber"),r.equalTo("customer",e),r.notEqualTo("status","Closed"),r.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"apply2Invoice"}))}),n})},getCreditNoteDetails:function(e){var n=Parse.Object.extend("CreditNotes"),r=new Parse.Query(n);return r.include("comments"),r.include("refunds"),r.include("customer.contactPersons"),r.include("customer"),r.get(e).then(function(e){return new t(e,{operation:"details"})})},addRefunds:function(t,n){var r=[],i=Parse.Object.extend("Refund"),a=new Parse.ACL;a.setPublicReadAccess(!0),a.setPublicWriteAccess(!0);for(var o=0;o<t.length;++o){var s=new i;s.setACL(a),r.push(s.save(t[o]))}return e.all(r)},getCreditNote:function(e){var n=Parse.Object.extend("CreditNotes"),r=new Parse.Query(n);return r.include("creditNoteItems"),r.get(e).then(function(e){return new t(e,{operation:"getCreditNote"})})},listCreditNotes:function(e){var n=d(e);if(n){var r=Parse.Object.extend("Customer");new Parse.Query(r).notEqualTo("isDeleted",1);var i=Parse.Object.extend("CreditNotes"),a=new Parse.Query(i);return a.equalTo("organization",n),a.include("customer"),a.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"listCreditNotes"}))}),n})}},getPreferences:function(e){var t=d(e);if(!t){var n="user: "+e.id+" has no Organization assigned.";return Parse.Promise.error(n)}var r={},i=Parse.Object.extend("Preferencies"),a=new Parse.Query(i);return a.equalTo("organization",t),a.first().then(function(e){r.numAutoGen=e.get("creditAg"),r.notes=e.get("creditNotes"),r.terms=e.get("creditTerms")}).then(function(){var e=Parse.Object.extend("Organization");return(a=new Parse.Query(e)).select("dateFormat","creditNumber"),a.get(t.id).then(function(e){r.dateFormat=e.get("dateFormat"),r.creditNumber=e.get("creditNumber")}).then(function(){return r})})},setPreferences:function(e,t){var n=d(e);if(!n){var r="user: "+e.id+" has no Organization assigned.";return Parse.Promise.error(r)}var i=[];t.creditAg&&n.set("creditNumber",t.creditNumber),i.push(n.save());var a=Parse.Object.extend("Preferencies"),o=new Parse.Query(a);return o.equalTo("organization",n),o.first().then(function(e){return e.set("creditAg",t.creditAg),e.set("creditNotes",t.notes),e.set("creditTerms",t.terms),i.push(e.save()),Parse.Promise.when(i)})},createNewCreditNote:function(e,t,n){var r=[],i=new Parse.ACL;i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0);var o=Parse.Promise.as(void 0),s=[],c=[];t.forEach(function(e){e.selectedItem.create?s.push(e):c.push(e)});var u={user:e.userID,organization:e.organization,acl:i};return a(s,u).then(function(e){return t=c.concat(e),o}).then(function(n){var a=Parse.Object.extend("CreditNoteItem");return t.forEach(function(t){var n=new a;n.setACL(i),n.set("userID",e.userID),n.set("organization",e.organization),n.set("item",t.selectedItem.entity),n.set("quantity",Number(t.quantity)),n.set("amount",Number(t.amount)),t.selectedTax&&n.set("tax",Parse.Object.extend("Tax").createWithoutData(t.selectedTax.id)),r.push(n)}),Parse.Object.saveAll(r).then(function(t){var n=new(Parse.Object.extend("CreditNotes"));return n.setACL(i),e.creditNoteItems=t,n.save(e).then(function(e){return e.get("organization").fetch().then(function(e){var t=e.get("creditNumber").split("-"),n=Number(t[1])+1,r=t[0]+"-"+formatInvoiceNumber(n,t[1].length);return e.set("creditNumber",r),e.save()}).then(function(t){return console.log("creditNote created successfully"),e})})})})},updateCreditNote:function(e,t,n,r,i,s){var c=[],u=[],l=[],d=[],m={},f=Parse.Object.extend("CreditNoteItem"),p=new Parse.ACL;p.setPublicReadAccess(!0),p.setPublicWriteAccess(!0),t.forEach(function(e){e.selectedItem.create?l.push(e):e.id?m[e.id]=e:d.push(e)});var g={acl:p,user:r,organization:r.get("organizations")[0],objectType:f};return a(l,g).then(function(t){t.forEach(function(e){e.id?m[e.id]=e:d.push(e)}),d=d.map(function(e){return o(e,g)});for(var n=e.creditItems,r=0;r<n.length;++r){var i=m[n[r].entity.id];i?(n[r].entity.set("item",i.selectedItem.entity),n[r].entity.set("quantity",Number(i.quantity)),n[r].entity.set("amount",Number(i.amount)),i.selectedTax?n[r].entity.set("tax",Parse.Object.extend("Tax").createWithoutData(i.selectedTax.id)):n[r].entity.unset("tax"),c.push(n[r].entity)):u.push(n[r].entity)}return c=c.concat(d),Parse.Object.destroyAll(u)}).then(function(e){return Parse.Object.saveAll(c)}).then(function(t){return e.entity.set("creditNoteItems",t),e.entity.save()}).then(function(e){return e})},createCreditNoteReceipt:function(e){var t=Parse.Object.extend("CreditNotes"),n=new Parse.Query(t);n.include("creditNoteItems","customer","creditNoteItems.item","creditNoteItems.item.tax","organization","userID","userID.defaultTemplate","userID.businessInfo");var r={};return n.get(e).then(function(e){r.creditNoteObj=e;var t=e.get("userID");return i.loadAllOfCurrentUser().then(function(n){var i=t.get("defaultTemplate");if(i){var a=i.get("templateData");return r.htmlFile=i.get("templateHTML"),r.emailHtmlFile=i.get("emailHTML"),r.cardUrl=i.get("linkedFile").url(),u(a.url(),t,e,n)}var o=Parse.Object.extend("InvoiceTemplate"),s=new Parse.Query(o);return s.equalTo("name","Template 1"),s.first().then(function(i){var a=i.get("templateData");return r.htmlFile=i.get("templateHTML"),r.emailHtmlFile=i.get("emailHTML"),r.cardUrl=i.get("linkedFile").url(),u(a.url(),t,e,n)})})}).then(function(e){return new Parse.File("test1.xml",{base64:e},"text/xml").save()}).then(function(e){return r.xml=e,c(e.url(),r.emailHtmlFile.url(),r.cardUrl)}).then(function(e){return new Parse.File("test2.html",{base64:e},"text/html").save()}).then(function(e){return r.emailHtml=e,s(r.xml.url(),r.htmlFile.url(),r.cardUrl)}).then(function(e){return new Parse.File("test2.html",{base64:e},"text/html").save()}).then(function(e){return r.creditNoteObj.set("creditLabels",r.xml),r.creditNoteObj.set("creditReceipt",e),r.creditNoteObj.set("emailReceipt",r.emailHtml),r.creditNoteObj.save()}).then(function(e){return e})},sendCreditNoteText:function(e){var n=new t(e,{operation:"sendReceipt"}),i=n.entity.get("customer");if(i=i.get("mobile"))var a=i,o=n.customer.displayName,s=r(n.entity.remainingCredits,"$",2),c=n.organization.name,u=n.entity.creditReceipt.url(),l=o+", "+c+" has sent you Credit Note of "+s+". ";return Parse.Cloud.run("createShortUrl",{link:u}).then(function(t){return Parse.Cloud.run("sendSms",{to:a,body:l+t.data.data.url}).then(function(t){return console.log(t),e},function(t){return console.error(t),e})})},sendCreditNoteTextToNumber:function(e,n){var i=new t(e,{operation:"sendReceipt"}),a=n;if(a)var o=a,s=i.customer.displayName,c=r(i.entity.remainingCredits,"$",2),u=i.organization.name,l=i.entity.creditReceipt.url(),d=s+", "+u+" has sent you Credit Note of "+c+". ";return Parse.Cloud.run("createShortUrl",{link:l}).then(function(t){return Parse.Cloud.run("sendSms",{to:o,body:d+t.data.data.url}).then(function(t){return console.log(t),e},function(t){return console.error(t),e})})},sendCreditNoteReceiptToEmail:function(e,n){var r=new t(e,{operation:"sendReceipt"}),i=r.entity.emailReceipt.url();return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:i}}).then(function(t){var i=n,a="Credit Note From "+r.organization.name;t=(t=t.replace("<!DOCTYPE html>","")).trim();var o=1,s=document.createElement("iframe");return document.body.appendChild(s),s.src="about:blank",s.style.display="none",s.setAttribute("id","myFrame"),s.contentWindow.document.open(),s.contentWindow.document.write(t),s.contentWindow.document.close(),s.onload=function(){return o=0,Parse.Cloud.run("sendMailgunHtml",{toEmail:i,fromEmail:"no-reply@invoicesunlimited.com",subject:a,html:"<html>"+$("#myFrame").contents().find("html").html()+"</html>"}).then(function(t){return console.log(t),e})},e})},sendCreditNoteReceipt:function(e){var n=new t(e,{operation:"sendReceipt"}),r=n.entity.emailReceipt.url();return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:r}}).then(function(t){if(n.entity.customerEmails)var r=n.entity.customerEmails[0],i="Credit Note From "+n.organization.name;t=(t=t.replace("<!DOCTYPE html>","")).trim();var a=1,o=document.createElement("iframe");return document.body.appendChild(o),o.style.display="none",o.setAttribute("id","myFrame"),o.contentWindow.document.open(),o.contentWindow.document.write(t),o.contentWindow.document.close(),o.onload=function(){return a=0,Parse.Cloud.run("sendMailgunHtml",{toEmail:r,fromEmail:"no-reply@invoicesunlimited.com",subject:i,html:"<html>"+$("#myFrame").contents().find("html").html()+"</html>"}).then(function(t){return console.log(t),e})},e})}}}]),invoicesUnlimited.factory("currencyFactory",["userFactory","roleFactory","currencyFactoryService",function(e,t,n){var r=e,i={entity:[]},a=["currencySymbol","decimalPlace","format","title"],o=function(){var e;return r.get?e=r.get("currency"):r.entity[0]&&r.entity[0].get&&(e=r.entity[0].get("currency")),e?e.fetch().then(function(e){return setObjectOperations({object:e,fieldName:"currency",parent:r.entity.length?r.entity[0]:null,fields:a}),i.entity.pop(),i.entity.push(e),i},function(e){console.log(e.message)}):(i.empty=!0,e)};return i.clearAllOnLogOut=function(){i.entity.length=0},i.load=function(){return i.entity.length?i:o()},i.createNew=function(e){if(!i.entity.length){var n=new(Parse.Object.extend("Currency"));return n.setACL(t.createACL()),n.save(e,{success:function(e){setObjectOperations({object:e,fieldName:"currency",parent:r.entity.length?r.entity[0]:null,fields:a}),i.entity.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}}).then(function(e){return[r.save({currency:e}),e]},errorCallback).then(function(e){return e[1]},function(e){})}},i.loadAll=function(e){var t=Parse.Object.extend("Currency"),r=new Parse.Query(t);return r.equalTo("organization",e.organization),r.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new n(e))}),t})},i.loadAllOfCurrentUser=function(){var t=Parse.Object.extend("Currency"),r=new Parse.Query(t);return r.equalTo("organization",e.entity[0].get("selectedOrganization")),r.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new n(e))}),t})},i.createNewCurrency=function(e,t){var r=new Parse.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0);var i=new(Parse.Object.extend("Currency"));return i.setACL(r),i.save(e).then(function(e){return new n(e)})},i.saveEditedCurrency=function(e){return e.save().then(function(e){return new n(e)})},i}]),invoicesUnlimited.factory("customerFactory",["userFactory","contactPersonFactory","appFields",function(e,t,n){return e.entity.length?function(e){setObjectOperations({object:e,fields:n.customer});var r=e.get("contactPersons");r&&(r=r.filter(function(e){if(e)return e}).map(function(e){return new t(e)})),this.id=e.get("objectId"),this.entity=e,this.contactPersons=r,this.save=function(e){if(arguments.length)return this.entity.save(e);var t=this;return this.entity.save().then(function(e){return t.id||(t.id=e.id),e})},this.destroy=function(){for(var e in this)"entity"!=e&&this.hasOwnProperty(e)&&delete this[e];return this.entity.destroy()}}:{}}]),invoicesUnlimited.factory("estimateService",["$q","estimateFactory","itemService","currencyFilter","currencyFactory",function(e,t,n,r,i){function a(e,t){return t.items=[],e.forEach(function(e){var n={title:e.selectedItem.entity.title,rate:e.selectedItem.entity.rate,expenseId:e.selectedItem.entity.expanseId};e.selectedItem.tax&&(n.tax=e.selectedItem.tax),t.items.push(n)}),n.createItems(t).then(function(t){for(var n=0;n<e.length;++n)e[n].selectedItem=t[n];return e})}function o(e,t){var n=new t.objectType;n.setACL(t.acl),n.set("userID",t.user),n.set("organization",t.organization),n.set("item",e.selectedItem.entity),n.set("quantity",Number(e.quantity)),n.set("amount",Number(e.amount));var r=Number(e.discount);return 0==r?n.unset("discount"):n.set("discount",r),e.selectedTax&&n.set("tax",Parse.Object.extend("Tax").createWithoutData(e.selectedTax.id)),n}function s(e,t,n){return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:t}}).then(function(t){t.replace("&lt;","<"),t.replace("&gt;",">");var r='Connect.open("GET", "uppage.xml"',i='Connect.open("GET", "'+e+'"';return i=i.replace("http:","https:"),t=t.replace(r,i),r="background: url(icn-card.png) no-repeat",i="background: url("+n+") no-repeat",i=i.replace("http:","https:"),t=t.replace(r,i),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:t}}).then(function(e){return e})})}function c(e,t,n){return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:t}}).then(function(t){var n='Connect.open("GET", "'+e+'"';return n=n.replace("http:","https:"),t=t.replace('Connect.open("GET", "uppage.xml"',n),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:t}}).then(function(e){return e},function(e){console.log(e)})})}function u(e,t,n,i){return $.ajax({type:"GET",url:"proxy.php",dataType:"xml",data:{address:e}}).then(function(e){var a=new X2JS,o=a.xml2json(e),s=o.items.label,c="$",u=1;s["invoice-title"]="Estimate",s.billType="estimate",s["list-header-total"]="Total",s["longmsg-title"]="Notes",s["ordernotes-title"]="Terms & Conditions",s.refundedText="Estimated Total",s.headerTitle="",s.copyright="",s.disablePay="true",s["due-text"]="",s["due-price"]="",s["received-text"]="",s["received-price"]="",s.thanksmsg="",s["website-link"]="",s["website-name"]="",s["tip-text"]=s["tip-price"]="",s.ordernotes=n.get("termsConditions"),s.longmsg=n.get("notes"),s["body-date"]=formatDate(n.get("estimateDate"),"MMM D, YYYY"),s["past-due"]=s["body-date"];var d=n.get("referenceNumber");s.purchaseOrderNumber=d?"Ref.# "+d:"",s.refid=n.get("estimateNumber");var m=o.items.customFields;m.customField=[];var f=n.get("salesPerson");f&&m.customField.push({name:"Sales Person",value:f});var p=n.get("customFields");if(p)for(D=0;D<p.length;++D){var g=Object.keys(p[D])[0],h=p[D][g];m.customField.push({name:g,value:h})}m.customField.length||(m.customField=void 0);var v=o.items.attachments,y=n.get("estimateFiles");if(y){v.attachment=[];for(D=0;D<y.length;++D)v.attachment.push(y[D].url())}else v.attachment=void 0;var x=t.get("colorTheme");x?"appBlueColor"==x?s["app-color"]="#327DF5":"appSeagreenColor"==x?s["app-color"]="#23AA92":"appGreenColor"==x?s["app-color"]="#0EA81C":"appYellowColor"==x?s["app-color"]="#EDE005":"appBrownColor"==x?s["app-color"]="#E87605":"appRedColor"==x?s["app-color"]="#E80000":"appPinkColor"==x?s["app-color"]="#E657A3":"appPurpleColor"==x&&(s["app-color"]="#7F5CBF"):s["app-color"]="#327DF5",s.mailtotxt=t.get("email");var b=n.get("organization");b&&(s.mailto="mailto:"+b.get("email"),s.title="Estimate from "+b.get("name"),b.get("logo")&&(s.logo=b.get("logo").url()));var P=t.get("businessInfo");if(P){var w=[P.get("streetName"),P.get("city"),P.get("state"),P.get("zipCode")];b.get("displayCountry")&&w.push(t.get("country")),s.addres1=w.join(", "),s["business-name"]=P.get("businessName"),s.nr=P.get("phoneNumber")}var T=n.get("customer");if(T){var O=T.get("email");s.clientmail=O,s.clientmailto="mailto:"+O,T.get("salutation")?s.clientname=T.get("salutation")+" "+T.get("displayName"):s.clientname=T.get("displayName"),s.clientnr=T.get("phone"),T.get("currency")&&(s["body-currency"]=T.get("currency").split(" ")[0]);var j=i.filter(function(e){return e.entity.title==T.get("currency")})[0];j&&(c=j.entity.currencySymbol,(u=j.entity.exchangeRate)||(u=1))}var N=n.get("discountType");s.discountPlace={text:2==N?"before":3==N?"after":""};var C=o.items,I=o.items.label.taxes,F=0,E=0,A=n.get("estimateItems");if(A){C.itemRow=[],I.tax=[];for(var D=0;D<A.length;++D){var z=A[D].get("item").get("title"),q=A[D].get("quantity"),L=A[D].get("amount"),R=A[D].get("discount")||0;E+=L*(.01*(100-R));var S={name:z,qty:q,price:r(L*u,c,2)};1==N&&(S.discount=R||0),C.itemRow.push(S);var Q=A[D].get("tax");if(Q){var k=Q.get("title")+" ("+Q.get("value")+"%)",U=n.get("discounts")||0,W=0;F+=W=2==N?l(L*(.01*(100-U)),Q):l(L,Q);var M={name:k,value:r(W*u,c,2)};I.tax.push(M)}}I.tax.length||(I.tax=void 0)}else C.itemRow=void 0,I.tax=void 0;var U=n.get("discounts")||0,H=n.get("shippingCharges")||0,G=n.get("adjustments")||0,B=E+F,Y=.01*(100-U);o.items.shippingChargesPrice="",o.items.shippingCharges="",o.items.adjustmentsPrice="",o.items.adjustments="",2==N?B=E*Y+F:3==N&&(B=(E+F)*Y),U?(s.discountNameBottom={text:"Discount "+U+"%:"},s.discountPriceBottom={text:U+"%"},U=Math.abs(B-E-F),s.discountAmount={text:r(U*u,c,2)}):s.discountAmount=s.discountNameBottom=s.discountPriceBottom="",s.subtotalprice=r(E*u,c,2);var _=B+H+G;s["total-price3"]=s["body-price"]=r(_*u,c,2);s.paymentMadePrice=r(0*u,c,2),s.creditsAppliedPrice=r(0*u,c,2);var X=_-0-0;return s.refundtotal=r(X*u,c,2),e=a.json2xml_str(o),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:e}}).then(function(e){return e})})}function l(e,t){var n=t.get("type"),r=t.get("value"),i=t.get("compound"),a=0;return 1==n?a=e*r*.01:2==n&&(a=e*r*.01,i&&(a=a*i*.01)),a}function d(e){var t=e.get("organizations");return t?t[0]:void 0}return{test:function(){console.log("working")},checkEstimateNumAvailable:function(e){var t=Parse.Object.extend("Estimates"),n=new Parse.Query(t);return n.equalTo("organization",e.organization),n.equalTo("estimateNumber",e.estimateNumber),n.select("estimateNumber"),n.first().then(function(e){return!e})},getEstimateDetails:function(e){var n=Parse.Object.extend("Estimates"),r=new Parse.Query(n);return r.include("comments"),r.include("customer.contactPersons"),r.include("customer"),r.get(e).then(function(e){return new t(e,{operation:"details"})})},getEstimate:function(e){var n=Parse.Object.extend("Estimates"),r=new Parse.Query(n);return r.include("estimateItems"),r.get(e).then(function(e){return new t(e,{operation:"getEstimate"})})},listEstimates:function(e){var n=d(e);if(n){var r=Parse.Object.extend("Customer");new Parse.Query(r).notEqualTo("isDeleted",1);var i=Parse.Object.extend("Estimates"),a=new Parse.Query(i);return a.equalTo("organization",n),a.include("customer"),a.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"listEstimates"}))}),n})}},getPreferences:function(e){var t=d(e);if(!t){var n="user: "+e.id+" has no Organization assigned.";return Parse.Promise.error(n)}var r={},i=Parse.Object.extend("Preferencies"),a=new Parse.Query(i);return a.equalTo("organization",t),a.first().then(function(e){r.discountType=e.get("invoiceDiscount"),r.numAutoGen=e.get("estimateAg"),r.shipCharges=e.get("invoiceShippingCharges"),r.adjustments=e.get("invoiceAdjustments"),r.salesPerson=e.get("invoiceSalesPerson"),r.thanksNote=e.get("invoiceThanksNotes"),r.notes=e.get("estimateNotes"),r.terms=e.get("estimateTerms")}).then(function(){var e=Parse.Object.extend("Organization");return(a=new Parse.Query(e)).select("dateFormat","estimateFields","estimateNumber"),a.get(t.id).then(function(e){r.dateFormat=e.get("dateFormat"),r.customFields=e.get("estimateFields"),r.estimateNumber=e.get("estimateNumber")}).then(function(){return r})})},setPreferences:function(e,t){var n=d(e);if(!n){var r="user: "+e.id+" has no Organization assigned.";return Parse.Promise.error(r)}var i=[];n.set("estimateFields",t.customFields),t.estimateAg&&n.set("estimateNumber",t.estimateNumber),i.push(n.save());var a=Parse.Object.extend("Preferencies"),o=new Parse.Query(a);return o.equalTo("organization",n),o.first().then(function(e){return e.set("estimateAg",t.estimateAg),e.set("estimateNotes",t.notes),e.set("estimateTerms",t.terms),i.push(e.save()),Parse.Promise.when(i)})},createNewEstimate:function(t,n,r,i){var o=[],s=new Parse.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0);var c=void 0,u=void 0;if(i.length){u=[];var l=[];i.forEach(function(e){if(e.exist)delete e.exist,delete e.fileName,u.push(e);else{var t=new Parse.File(e.name,e);l.push(t.save())}}),c=e.all(l).then(function(e){return e&&(u=u.concat(e)),u})}else c=Parse.Promise.as(void 0);var d=[],m=[];n.forEach(function(e){e.selectedItem.create?d.push(e):m.push(e)});var f={user:t.userID,organization:t.organization,acl:s};return a(d,f).then(function(e){return n=m.concat(e),c}).then(function(e){var r=Parse.Object.extend("EstimateItem");return n.forEach(function(e){var n=new r;n.setACL(s),n.set("userID",t.userID),n.set("organization",t.organization),n.set("item",e.selectedItem.entity),n.set("quantity",Number(e.quantity)),n.set("amount",Number(e.amount));var i=Number(e.discount);0!=i&&n.set("discount",i),e.selectedTax&&n.set("tax",Parse.Object.extend("Tax").createWithoutData(e.selectedTax.id)),o.push(n)}),Parse.Object.saveAll(o).then(function(n){var r=new(Parse.Object.extend("Estimates"));return r.setACL(s),r.set("estimateFiles",e),t.estimateItems=n,r.save(t).then(function(e){return e.get("organization").fetch().then(function(e){var t=e.get("estimateNumber").split("-"),n=Number(t[1])+1,r=t[0]+"-"+formatInvoiceNumber(n,t[1].length);return e.set("estimateNumber",r),e.save()}).then(function(t){return console.log("estimate created successfully"),e})})})})},updateEstimate:function(t,n,r,i,s,c){var u=[],l=[],d=[],m=[],f={},p=Parse.Object.extend("EstimateItem"),g=new Parse.ACL;g.setPublicReadAccess(!0),g.setPublicWriteAccess(!0),n.forEach(function(e){e.selectedItem.create?d.push(e):e.id?f[e.id]=e:m.push(e)});var h={acl:g,user:i,organization:i.get("organizations")[0],objectType:p},v=void 0,y=void 0;if(c.length){y=[];var x=[];c.forEach(function(e){if(e.exist)delete e.exist,delete e.fileName,y.push(e);else{var t=new Parse.File(e.name,e);x.push(t.save())}}),v=e.all(x)}else v=Parse.Promise.as(void 0);return v.then(function(e){return e&&(y=y.concat(e)),t.entity.set("estimateFiles",y),a(d,h)}).then(function(e){e.forEach(function(e){e.id?f[e.id]=e:m.push(e)}),m=m.map(function(e){return o(e,h)});for(var n=t.estimateItems,r=0;r<n.length;++r){var i=f[n[r].entity.id];if(i){n[r].entity.set("item",i.selectedItem.entity),n[r].entity.set("quantity",Number(i.quantity)),n[r].entity.set("amount",Number(i.amount));var a=Number(i.discount);0==a?n[r].entity.unset("discount"):n[r].entity.set("discount",a),i.selectedTax?n[r].entity.set("tax",Parse.Object.extend("Tax").createWithoutData(i.selectedTax.id)):n[r].entity.unset("tax"),u.push(n[r].entity)}else l.push(n[r].entity)}return u=u.concat(m),Parse.Object.destroyAll(l)}).then(function(e){return Parse.Object.saveAll(u)}).then(function(e){return t.entity.set("estimateItems",e),t.entity.save()}).then(function(e){return e})},createEstimateReceipt:function(e){var t=Parse.Object.extend("Estimates"),n=new Parse.Query(t);n.include("estimateItems","customer","estimateItems.item","estimateItems.tax","organization","userID","userID.defaultTemplate","userID.businessInfo");var r={};return n.get(e).then(function(e){r.estimateObj=e;var t=e.get("userID");return i.loadAllOfCurrentUser().then(function(n){var i=t.get("defaultTemplate");if(i){var a=i.get("templateData");return r.htmlFile=i.get("templateHTML"),r.emailHtmlFile=i.get("emailHTML"),r.cardUrl=i.get("linkedFile").url(),u(a.url(),t,e,n)}var o=Parse.Object.extend("InvoiceTemplate"),s=new Parse.Query(o);return s.equalTo("name","Template 1"),s.first().then(function(i){var a=i.get("templateData");return r.htmlFile=i.get("templateHTML"),r.emailHtmlFile=i.get("emailHTML"),r.cardUrl=i.get("linkedFile").url(),u(a.url(),t,e,n)})})}).then(function(e){return new Parse.File("test1.xml",{base64:e},"text/xml").save()}).then(function(e){return r.xml=e,c(e.url(),r.emailHtmlFile.url(),r.cardUrl)}).then(function(e){return new Parse.File("test2.html",{base64:e},"text/html").save()}).then(function(e){return r.emailHtml=e,s(r.xml.url(),r.htmlFile.url(),r.cardUrl)}).then(function(e){return new Parse.File("test2.html",{base64:e},"text/html").save()}).then(function(e){return r.estimateObj.set("estimateLabels",r.xml),r.estimateObj.set("estimateReceipt",e),r.estimateObj.set("emailReceipt",r.emailHtml),r.estimateObj.save()}).then(function(e){return e})},sendEstimetText:function(e){var n=new t(e,{operation:"sendReceipt"}),i=n.entity.get("customer");if(i=i.get("mobile"))var a=i,o=n.customer.displayName,s=r(n.entity.totalAmount,"$",2),c=n.organization.name,u=n.entity.estimateReceipt.url(),l=o+", "+c+" has sent you an estimate of "+s+". ";return Parse.Cloud.run("createShortUrl",{link:u}).then(function(t){return Parse.Cloud.run("sendSms",{to:a,body:l+t.data.data.url}).then(function(t){return console.log(t),e},function(t){return console.error(t),e})})},sendEstimetTextToNumber:function(e,n){var i=new t(e,{operation:"sendReceipt"}),a=n,o=i.customer.displayName,s=r(i.entity.totalAmount,"$",2),c=i.organization.name,u=i.entity.estimateReceipt.url(),l=o+", "+c+" has sent you an estimate of "+s+". ";return Parse.Cloud.run("createShortUrl",{link:u}).then(function(t){return Parse.Cloud.run("sendSms",{to:a,body:l+t.data.data.url}).then(function(t){return console.log(t),e},function(t){return console.error(t),e})})},sendEstimateReceiptToEmail:function(e,n){var r=new t(e,{operation:"sendReceipt"}),i=r.entity.emailReceipt.url();return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:i}}).then(function(t){var i=n,a="Estimate From "+r.organization.name;t=(t=t.replace("<!DOCTYPE html>","")).trim();var o=1,s=document.createElement("iframe");return document.body.appendChild(s),s.src="about:blank",s.style.display="none",s.setAttribute("id","myFrameEstimate"),s.contentWindow.document.open(),s.contentWindow.document.write(t),s.contentWindow.document.close(),s.onload=function(){return o=0,Parse.Cloud.run("sendMailgunHtml",{toEmail:i,fromEmail:"no-reply@invoicesunlimited.com",subject:a,html:"<html>"+$("#myFrameEstimate").contents().find("html").html()+"</html>"}).then(function(t){return console.log(t),e})},e})},sendEstimateReceipt:function(e){var n=new t(e,{operation:"sendReceipt"}),r=n.entity.estimateReceipt.url();return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:r}}).then(function(t){if(n.entity.customerEmails)var r=n.entity.customerEmails[0],i="Estimate From "+n.organization.name;t=(t=t.replace("<!DOCTYPE html>","")).trim();var a=1,o=document.createElement("iframe");return document.body.appendChild(o),o.style.display="none",o.setAttribute("id","myFrame"),o.contentWindow.document.open(),o.contentWindow.document.write(t),o.contentWindow.document.close(),o.onload=function(){return a=0,Parse.Cloud.run("sendMailgunHtml",{toEmail:r,fromEmail:"no-reply@invoicesunlimited.com",subject:i,html:"<html>"+$("#myFrame").contents().find("html").html()+"</html>"}).then(function(t){return console.log(t),e})},e})}}}]),invoicesUnlimited.factory("expenseCategoryService",["expenseCategoryFactory",function(e){return{createNewCategory:function(t,n){var r=new Parse.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0);var i=new(Parse.Object.extend("Category"));return i.setACL(r),i.save(t).then(function(t){return new e(t)})},saveEditedCategory:function(t){return t.save().then(function(t){return new e(t)})}}}]),invoicesUnlimited.factory("expenseService",["$q","expenseFactory",function(e,t){function n(e){var t=e.get("organizations");return t?t[0]:void 0}return{getExpensesForSummary:function(e){var n=Parse.Object.extend("Expanses"),r=new Parse.Query(n);return r.equalTo("organization",e.organization),r.include("customer"),r.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"summary"}))}),n})},getExpenseDetails:function(e){var n=Parse.Object.extend("Expanses"),r=new Parse.Query(n);return r.include("customer"),r.get(e).then(function(e){return new t(e,{operation:"details"})})},getExpense:function(e){var n=Parse.Object.extend("Expanses"),r=new Parse.Query(n);return r.include("customer"),r.get(e).then(function(e){return new t(e,{operation:"getExpense"})})},getCustomerExpenses:function(e){var n=new Parse.Query("Expanses");return n.equalTo("organization",e.organization),n.equalTo("customer",e.customer),n.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"getCustomerExpenses"}))}),n})},listExpenses:function(e){var r=n(e);if(r){var i=Parse.Object.extend("Expanses"),a=new Parse.Query(i);return a.equalTo("organization",r),a.include("customer"),a.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"listExpenses"}))}),n})}},createNewExpense:function(t,n,r){var i=new Parse.ACL;i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0);var a=void 0,o=void 0;if(r.length){var s=[];o=[],r.forEach(function(e){if(e.exist)delete e.exist,delete e.fileName,delete e.fileName1,o.push(e);else{var t=new Parse.File(e.name,e);s.push(t.save())}}),a=e.all(s).then(function(e){return e&&(o=o.concat(e)),o})}else a=Parse.Promise.as(void 0);return t.tax&&(t.tax=Parse.Object.extend("Tax").createWithoutData(t.tax.id)),a.then(function(e){var n=new(Parse.Object.extend("Expanses"));return n.setACL(i),n.set("expenseFiles",e),n.save(t)})},updateExpense:function(t,n){t.tax?t.tax=Parse.Object.extend("Tax").createWithoutData(t.tax.id):t.unset("tax");var r=void 0,i=[];if(n.length){i=[];var a=[];n.forEach(function(e){if(e.exist)delete e.exist,delete e.fileName,i.push(e);else{var t=new Parse.File(e.name,e);a.push(t.save())}}),r=e.all(a)}else r=Parse.Promise.as(void 0);return r.then(function(e){return e&&(i=i.concat(e)),t.set("expenseFiles",i),t.save()})}}}]),invoicesUnlimited.factory("invoiceService",["$q","invoiceFactory","itemService","currencyFilter","userFactory","currencyFactory",function(e,t,n,r,i,a){function o(e,t){return t.items=[],e.forEach(function(e){var n={title:e.selectedItem.entity.title,rate:e.selectedItem.entity.rate,expenseId:e.selectedItem.entity.expanseId};e.selectedItem.tax&&(n.tax=e.selectedItem.tax),t.items.push(n)}),n.createItems(t).then(function(t){for(var n=0;n<e.length;++n)e[n].selectedItem=t[n];return e})}function s(e,t){var n=new t.objectType;n.setACL(t.acl),n.set("userID",t.user),n.set("organization",t.organization),n.set("item",e.selectedItem.entity),n.set("quantity",Number(e.quantity)),n.set("amount",Number(e.amount));var r=Number(e.discount);return 0==r?n.unset("discount"):n.set("discount",r),e.selectedTax&&n.set("tax",Parse.Object.extend("Tax").createWithoutData(e.selectedTax.id)),n}function c(e){var t=p(e);if(!t){var n="user: "+e.id+" has no Organization assigned.";return Parse.Promise.error(n)}var r={},i=Parse.Object.extend("Preferencies"),a=new Parse.Query(i);return a.equalTo("organization",t),a.first().then(function(e){r.discountType=e.get("invoiceDiscount"),r.numAutoGen=e.get("invoiceAg"),r.shipCharges=e.get("invoiceShippingCharges"),r.adjustments=e.get("invoiceAdjustments"),r.salesPerson=e.get("invoiceSalesPerson"),r.thanksNote=e.get("invoiceThanksNotes"),r.notes=e.get("invoiceNotes"),r.terms=e.get("invoiceTerms"),r.itemDescOnInvoice=e.get("itemDescOnInvoice")}).then(function(){var e=Parse.Object.extend("Organization");return(a=new Parse.Query(e)).select("dateFormat","invoiceFields","invoiceNumber","displayCountry"),a.get(t.id).then(function(e){r.dateFormat=e.get("dateFormat"),r.customFields=e.get("invoiceFields"),r.invoiceNumber=e.get("invoiceNumber"),r.displayCountry=e.get("displayCountry")}).then(function(){return r})})}function u(e,t,n){return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:t}}).then(function(t){var r='Connect.open("GET", "uppage.xml"',i='Connect.open("GET", "'+e+'"';return i=i.replace("http:","https:"),t=t.replace(r,i),r="background: url(icn-card.png) no-repeat",i="background: url("+n+") no-repeat",i=i.replace("http:","https:"),t=t.replace(r,i),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:t}}).then(function(e){return e},function(e){console.log(e)})})}function l(e,t,n){return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:t}}).then(function(t){var n='Connect.open("GET", "'+e+'"';return n=n.replace("http:","https:"),t=t.replace('Connect.open("GET", "uppage.xml"',n),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:t}}).then(function(e){return e},function(e){console.log(e)})})}function d(e,t,n,i,a,o,s){return $.ajax({type:"GET",url:"proxy.php",dataType:"xml",data:{address:e}}).then(function(e){var o=new X2JS,c=o.xml2json(e),u=c.items.label,l="$",d=1;u.invoiceId=i,u["invoice-title"]="Invoice",u.billType="invoice",u["list-header-total"]="Total",u.headerTitle="Payment Due",u["longmsg-title"]="Notes",u["ordernotes-title"]="Terms & Conditions",u.copyright="",u.disablePay="",u["due-text"]="",u["due-price"]="",u["received-text"]="",u["received-price"]="",u.thanksmsg="",u["website-link"]="",u["website-name"]="",u.ordernotes=n.get("terms"),u.longmsg=n.get("notes"),u["body-date"]=formatDate(n.get("invoiceDate"),"MMM D, YYYY"),u["past-due"]=formatDate(n.get("dueDate"),"MMM D, YYYY"),u.purchaseOrderNumber=n.get("poNumber")?"Order # "+n.get("poNumber"):"",u.refid=n.get("invoiceNumber");var p=c.items.customFields;p.customField=[];var h=n.get("salesPerson");h&&p.customField.push({name:"Sales Person",value:h});var v=n.get("customFields");if(v)for(S=0;S<v.length;++S){var y=Object.keys(v[S])[0],x=v[S][y];p.customField.push({name:y,value:x})}p.customField.length||(p.customField=void 0);var b=c.items.attachments,P=n.get("invoiceFiles");if(P){b.attachment=[];for(S=0;S<P.length;++S)b.attachment.push(P[S].url())}else b.attachment=void 0;var w=t.get("colorTheme");w?"appBlueColor"==w?u["app-color"]="#327DF5":"appSeagreenColor"==w?u["app-color"]="#23AA92":"appGreenColor"==w?u["app-color"]="#0EA81C":"appYellowColor"==w?u["app-color"]="#EDE005":"appBrownColor"==w?u["app-color"]="#E87605":"appRedColor"==w?u["app-color"]="#E80000":"appPinkColor"==w?u["app-color"]="#E657A3":"appPurpleColor"==w&&(u["app-color"]="#7F5CBF"):u["app-color"]="#327DF5",u.mailtotxt=t.get("email"),g&&(u.logo=g);var T=n.get("organization");T&&(u.mailto="mailto:"+T.get("email"),u.title="Invoice from "+T.get("name"),T.get("logo")&&(u.logo=T.get("logo").url()));var O=t.get("businessInfo");if(O){var j=[O.get("streetName"),O.get("city"),O.get("state"),O.get("zipCode")];a.displayCountry&&j.push(t.get("country"));var N=O.get("streetName")+"<br>"+O.get("city")+", "+O.get("state")+" "+O.get("zipCode");a.displayCountry&&(N=N+"<br>"+t.get("country")),u.addres1=N,u["business-name"]=O.get("businessName"),u.nr=O.get("phoneNumber")}var C=n.get("customer");if(C){var I=C.get("email");u.clientmail=I,u.clientmailto="mailto:"+I,C.get("salutation")?u.clientname=C.get("salutation")+" "+C.get("displayName"):u.clientname=C.get("displayName"),u.clientnr=C.get("phone"),C.get("currency")&&(u["body-currency"]=C.get("currency").split(" ")[0]);var F=s.filter(function(e){return e.entity.title==C.get("currency")})[0];F&&(F.entity.currencySymbol&&(l=F.entity.currencySymbol),F.entity.exchangeRate&&(d=F.entity.exchangeRate))}var E=n.get("discountType");u.discountPlace={text:2==E?"before":3==E?"after":""};var A=c.items,D=c.items.label.taxes,z=0,q=0,L=n.get("invoiceItems");if(L){A.itemRow=[],D.tax=[];for(var R=[],S=0;S<L.length;++S){var Q=L[S].get("item").get("title"),k=L[S].get("quantity"),U=L[S].get("amount"),W=L[S].get("discount")||0,M=L[S].get("item").get("itemDescription");q+=U*(.01*(100-W));var H={name:Q,qty:k,price:r(U*d,l,2)};M&&1==a.itemDescOnInvoice&&(H.desc=M),1==E&&(H.discount=W||0),A.itemRow.push(H);var G=L[S].get("tax");if(G){var B=G.get("title")+" ("+G.get("value")+"%)",Y=0,_=n.get("discounts")||0;z+=Y=2==E?f(U*(.01*(100-_)),G):f(U*(.01*(100-W)),G);for(var X={name:B,value:Y},J=!1,Z=0;Z<R.length;++Z)if(R[Z].name==B){J=!0,R[Z].value+=Y;break}J||R.push(X)}}R.forEach(function(e){e.value=r(e.value*d,l,2),D.tax.push(e)}),D.tax.length||(D.tax=void 0)}else A.itemRow=void 0,D.tax=void 0;var K=n.get("lateFee"),V=(n.get("status"),0);if(K){u["tip-text"]="Late Fee";var ee=K.get("price"),te=K.get("type");"$"==te?(V=ee,u["tip-price"]=r(ee*d,l,2)):"%"==te&&(V=q*ee*.01,u["tip-price"]=r(V*d,l,2),u["tip-text"]="Late Fee("+ee+te+")")}else u["tip-text"]=u["tip-price"]="";var _=n.get("discounts")||0,ne=n.get("shippingCharges")||0,re=n.get("adjustments"),ie=q+z,ae=.01*(100-_);a.shipCharges?(c.items.shippingChargesPrice=r(ne*d,l,2),c.items.shippingCharges="SHIPPING CHARGES"):(c.items.shippingChargesPrice="",c.items.shippingCharges=""),ne=n.get("shippingCharges")||0,re?(c.items.adjustmentsPrice=r(re*d,l,2),c.items.adjustments="ADJUSTMENTS"):(c.items.adjustmentsPrice="",c.items.adjustments=""),re=n.get("adjustments")||0,2==E?ie=q*ae+z:3==E&&(ie=(q+z)*ae),void 0!=_?(u.discountNameBottom={text:"Discount ("+_+"%)"},u.discountPriceBottom={text:_+"%"},_=Math.abs(ie-q-z),u.discountAmount={text:r(-1*_*d,l,2)}):u.discountAmount=u.discountNameBottom=u.discountPriceBottom="",u.subtotalprice=r(q*d,l,2);var oe=ie+ne+re+V;u["total-price4"]=r(oe*d,l,2);var se=ie+ne+re;u["total-price3"]=u["body-price"]=r(se*d,l,2);var ce=n.get("paymentMade")||0,ue=n.get("creditApplied")||0;u.paymentMadePrice=r(ce*d,l,2),u.creditsAppliedPrice=r(ue*d,l,2);var le=(oe=parseFloat(oe.toFixed(2)))-ce-ue;u["due-price"]=r(le*d,l,2);var de=(se=parseFloat(se.toFixed(2)))-ce-ue;return u.refundtotal=r(de*d,l,2),de>0?(u.headerTitle="Payment Due",u.disablePay="false"):(u.headerTitle="Paid Date",u.disablePay="true"),e=o.json2xml_str(c),m(e,n).then(function(t){return t.save().then(function(t){return u.pdf=t.url(),e=o.json2xml_str(c),$.ajax({type:"POST",url:"./assets/php/convert_base64.php",data:{str:e}}).then(function(e){var n={};return n.newXml=e,n.pdf=t,n},function(e){console.log(e)})},function(e){console.error(e)})},function(e){console.error(e)})})}function m(e,t){e=$.parseXML(e);var n=$(e).find("itemRow"),r=($(e).find("modsRow"),$(e).find("attachment")),a=$(e).find("customField"),o=$(e).find("tax");$("<td></td>");$(e).find("billType").text().includes("estimate")&&($(".footer .info").hide(),$(".payment-due").hide()),$("#invoice-items-header").html(""),/^[\s]*$/.test(n.first().find("discount").text())?$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),$(".invoice-items").remove(),n.each(function(e){var t="<span class='fc0'>"+$(this).children("name").text()+"</span><br>"+$(this).children("desc").text();if(/^[\s]*$/.test(n.first().find("discount").text())){var r=$("<tr class='invoice-items'></tr>"),i=$("<td class='ff1 fc1 invoice-item-title' style='width: 50mm;' colspan='2'>"+t+"</td>"),a=$("<td class='ff1 fc0  invoice-item-qty' colspan='2'>"+$(this).children("qty").text()+"</td>"),o=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");r.append(i).append(a).append(o),$("#invoice-items-header").after($(r))}else{var r=$("<tr class='invoice-items'></tr>"),i=$("<td class='ff1 fc1 invoice-item-title' style='width: 50mm;' colspan='2'>"+t+"</td>"),a=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("qty").text()+"</td>"),s=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("discount").text()+"</td>"),o=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");r.append(i).append(a).append(s).append(o),$("#invoice-items-header").after($(r))}}),$(".invoice-taxes").remove(),o.each(function(){var e=$("<tr class='invoice-taxes'></tr>"),t=$("<td colspan='3' class=''></td>"),n=$("<td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).children("name").text()+"</td>"),r=$("<td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).children("value").text()+"</td>");e.append(t).append(n).append(r),$("#invoice-subtotal").after($(e))});var s=$('<tr class="salestax"></tr>');$("tr.adjustments").after(s),a.each(function(){$(".customFields").append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children("name").text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children("value").text()+"</p></div>"))}),r.each(function(){var e=$(this).text();e=(e=e.substring(e.indexOf("_")+1,e.length)).replace(/%20/g," "),$(".attach").append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+"'>"+e+"</a><br><br>")}),$("table tbody tr").each(function(){0==$(this).children().text().length&&$(this).addClass("hideOnMob")});var c=$(e).find("invoiceId").text();$("#pay-link").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+c),$("#pay-link-2").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+c);var u=$(e).find("items");return console.log(u),u.each(function(){var e=new Date(Date.parse($(this).find("past-due").text())),t=new Date(Date.now());e=new Date(e.setHours(0,0,0,0)),t=new Date(e.setHours(0,0,0,0)),e.getTime()>=t.getTime()||"Invalid Date"===e.toString()?($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("green-status")):($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("red-status"));o=$(this).find("headerTitle").text();$(".payment-due p:first").append(o);"true"===$(this).find("disablePay").text()&&($(".btn-border-pay").addClass("disable"),$(".info.cl").addClass("disable"),$(".payment-due").removeClass("red-status"),$(".payment-due").addClass("green-status"));var n=$(this).find("discountAmount").text(),r=$('<tr class="discount"></tr>');r.append($('<td class="discountNm" colspan="3"></td>').html("Discount")),r.append($('<td class="discountPr"></td>').html(n)),"after"==$(this).find("discountPlace text").text()?$(".salestax:last").after(r):"before"==$(this).find("discountPlace text").text()&&$(".salestax:first").before(r);a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountNameBottom").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountAmount").text()+"</td></tr>");if("after"==$(this).find("discountPlace text").text()?$(".invoice-taxes:last").after($(a)):"before"==$(this).find("discountPlace text").text()&&$("#invoice-subtotal").after($(a)),$(this).find("adjustments").text().length>0){var a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustments").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustmentsPrice").text()+"</td></tr>");$("#invoice-subtotal").after($(a))}$(this).find("shippingCharges").text().length>0&&(a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingCharges").text()+"</td><td class='ff1 fc1 ' style=' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingChargesPrice").text()+"</td></tr>"),$("#invoice-subtotal").after($(a)));var o=$(this).find("headerTitle").text(),s=$(this).find("past-due").text();o?$("#pdf-title").text(o+"   "+s):($("#pdf-title").text(""),$(".top-bar").css("height","0mm"),$(".top-bar").css("border-bottom","0mm"));var c=$(this).find("ordernotes-title").text(),u=$(this).find("ordernotes").text();u?($("#pdf-terms-title").text(c),$("#pdf-terms").text(u)):($("#pdf-terms-title").text(""),$("#pdf-terms").text(""),$("#pdf-terms-title").hide(),$("#pdf-terms").hide()),$("#pdf-business-name").text(i.entity[0].get("company")),$("#pdf-invoice-title").text($(this).find("invoice-title").text()),$("#pdf-invoice-number").text($(this).find("refid").text()),$("#pdf-order-number").text("   "+$(this).find("purchaseOrderNumber").text()),$("#pdf-amount-received").text($(this).find("body-price").text()),$("#pdf-date").text($(this).find("body-date").text()),$("#pdf-subtotal").text($(this).find("subtotalprice").text()),$("#pdf-payment-made").text($(this).find("paymentMadePrice").text()),$("#pdf-total").text($(this).find("total-price3").text()),$("#pdf-total-top").text($(this).find("total-price3").text()),$("#pdf-credit-applied").text($(this).find("creditsAppliedPrice").text()),$("#pdf-amount-due").text($(this).find("refundtotal").text()),$("#pdf-payment-name").text($(this).find("title").text()),$("#pdf-currency").text($(this).find("body-currency").text()),$("#pdf-total-text").text($(this).find("refundedText").text()),$("#pdf-payment-text").text($(this).find("paymentMadeText").text()),$("#pdf-credit-text").text($(this).find("creditsAppliedText").text()),$(this).find("total-price3").text().length>9&&$(".pdf-top-values").css("font-size",24-2*($(this).find("total-price3").text().length-9));var l=$(this).find("addres1").text();$("#pdf-address").html(l);var d=$(this).find("longmsg").text();if(0!=d.length){var m=$(this).find("longmsg-title").text();$("#pdf-notes-title").html(m),$("#pdf-notes").html(d)}else $("#pdf-notes-title").html(""),$("#pdf-notes").html(""),$("#pdf-notes-title").hide(),$("#pdf-notes").hide();var f=$(this).find("mailto").text();$("#user-mail").attr("href",f);var p=$(this).find("mailtotxt").text();$("#user-mail").text(p);var g=$(this).find("clientmailto").text();$("#client-mail").attr("href",g);var h=$(this).find("clientmail").text();$("#client-mail").text(h);var v=$(this).find("clientname").text();$("#client-name").text(v);var y=$(this).find("nr").text();$("#user-phone").attr("href","tel:"+y),$("#user-phone").text(y)}),$.ajax({method:"POST",type:"POST",url:"generatePDF.php",data:{html:$(".pdf-page").html()}}).then(function(e){return new Parse.File("receipt.pdf",{base64:e})},function(e){console.error(e)})}function f(e,t){var n=t.get("type"),r=t.get("value"),i=t.get("compound"),a=0;return 1==n?a=e*r*.01:2==n&&(a=e*r*.01,i&&(a=a*i*.01)),a}function p(e){var t=e.get("organizations");return t?t[0]:void 0}return{test:function(){console.log("working")},checkInvoiceNumAvailable:function(e){var t=Parse.Object.extend("Invoices"),n=new Parse.Query(t);return n.equalTo("organization",e.organization),n.equalTo("invoiceNumber",e.invoiceNumber),n.select("invoiceNumber"),n.first().then(function(e){return!e})},addPayments:function(t,n){var r=[],i=Parse.Object.extend("Payment"),a=new Parse.ACL;a.setPublicReadAccess(!0),a.setPublicWriteAccess(!0);for(var o=0;o<t.length;++o){var s=new i;s.setACL(a),r.push(s.save(t[o]))}return e.all(r)},getInvoicesForSummary:function(e){var n=Parse.Object.extend("Customer"),r=new Parse.Query(n);r.notEqualTo("isDeleted",1);var i=Parse.Object.extend("Invoices"),a=new Parse.Query(i);return a.matchesQuery("customer",r),a.equalTo("organization",e.organization),a.limit(1e3),a.select("invoiceDate","dueDate","status","balanceDue","lateFee","total"),a.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"summary"}))}),n})},getInvoiceDetails:function(e){var n=Parse.Object.extend("Invoices"),r=new Parse.Query(n);return r.include("comments","payment","invoiceInfo","customer","customer.contactPersons"),r.get(e).then(function(e){return new t(e,{operation:"details"})})},getInvoice:function(e){var n=Parse.Object.extend("Invoices"),r=new Parse.Query(n);return r.include("invoiceItems"),r.get(e).then(function(e){return new t(e,{operation:"getInvoice"})})},copyInInvoiceInfo:function(t){var n=t.get("invoiceInfo");if(n)console.log("used old");else{console.log("new created");var r=Parse.Object.extend("InvoiceInfo");n=new r}n.set("sendNotifications",i.entity[0].get("getInvoiceNotification")),n.set("invoiceDate",t.get("invoiceDate")),n.set("dueDate",t.get("dueDate")),n.set("referenceNumber",t.get("invoiceNumber")),n.set("totalAmount",String(t.get("total")));var a,o,s=[];return o=e.when(t.get("userID").fetch()).then(function(e){return a=e,n.set("userId",a.id),n.set("email",a.get("email")),n.set("phone",a.get("phonenumber")),a.get("selectedOrganization").fetch()}).then(function(e){return n.set("organizationLogo",e.get("logo")),a.get("businessInfo").fetch()}).then(function(e){n.set("businessName",e.get("businessName"));var t=Parse.Object.extend("Preferencies"),r=new Parse.Query(t);return r.select("invoiceNotes"),r.equalTo("userID",a),r.first()}).then(function(e){n.set("emailReceipt",e.get("invoiceNotes"))}),s.push(o),o=e.when(t.get("customer").fetch()).then(function(e){n.set("clientName",e.get("displayName")),n.set("clientEmail",e.get("email")),n.set("clientPhone",e.get("phone"))}),s.push(o),e.all(s).then(function(){return n.save()}).then(function(e){t.set("invoiceInfo",e);var n=t.get("dueDate"),r=new Date;return n.setHours(0,0,0,0),r.setHours(0,0,0,0),n<r&&t.set("status","Overdue"),t.save().then(function(t){return e})})},updateInvoice:function(t,n,r,i,a,c){var u=[],l=[],d=[],m=[],f={},p=Parse.Object.extend("InvoiceItems"),g=new Parse.ACL;g.setPublicReadAccess(!0),g.setPublicWriteAccess(!0),n.forEach(function(e){e.selectedItem.create?d.push(e):e.id?f[e.id]=e:m.push(e)});var h={acl:g,user:i,organization:i.get("organizations")[0],objectType:p},v=void 0,y=[];if(c.length){y=[];var x=[];c.forEach(function(e){if(e.exist)delete e.exist,delete e.fileName,y.push(e);else{var t=new Parse.File(e.fileName,e);x.push(t.save())}}),v=e.all(x)}else v=Parse.Promise.as(void 0);return v.then(function(e){return e&&(y=y.concat(e)),t.entity.set("invoiceFiles",y),o(d,h)}).then(function(e){e.forEach(function(e){e.id?f[e.id]=e:m.push(e)}),m=m.map(function(e){return s(e,h)});for(var n=t.invoiceItems,r=0;r<n.length;++r){var i=f[n[r].entity.id];if(i){n[r].entity.set("item",i.selectedItem.entity),n[r].entity.set("quantity",Number(i.quantity)),n[r].entity.set("amount",Number(i.amount));var a=Number(i.discount);0==a?n[r].entity.unset("discount"):n[r].entity.set("discount",a),i.selectedTax?n[r].entity.set("tax",Parse.Object.extend("Tax").createWithoutData(i.selectedTax.id)):n[r].entity.unset("tax"),u.push(n[r].entity)}else l.push(n[r].entity)}return u=u.concat(m),Parse.Object.destroyAll(l)}).then(function(e){return Parse.Object.saveAll(u)}).then(function(e){return t.entity.set("invoiceItems",e),t.entity.save()}).then(function(e){return e})},createNewInvoice:function(t,n,r,i){var a=[],s=new Parse.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0);var c=void 0,u=void 0;if(i.length){u=[];var l=[];i.forEach(function(e){if(e.exist)delete e.exist,delete e.fileName,u.push(e);else{var t=new Parse.File(e.fileName,e);l.push(t.save())}}),c=e.all(l).then(function(e){return e&&(u=u.concat(e)),u})}else c=Parse.Promise.as(void 0);var d=[],m=[];n.forEach(function(e){e.selectedItem.create?d.push(e):m.push(e)});var f={user:t.userID,organization:t.organization,acl:s};return o(d,f).then(function(e){return n=m.concat(e),c}).then(function(e){var r=Parse.Object.extend("InvoiceItems");return n.forEach(function(e){var n=new r;n.setACL(s),n.set("userID",t.userID),n.set("organization",t.organization),n.set("item",e.selectedItem.entity),n.set("quantity",Number(e.quantity)),n.set("amount",Number(e.amount));var i=Number(e.discount);0!=i&&n.set("discount",i),e.selectedTax&&n.set("tax",Parse.Object.extend("Tax").createWithoutData(e.selectedTax.id)),a.push(n)}),Parse.Object.saveAll(a).then(function(n){var r=new(Parse.Object.extend("Invoices"));return r.setACL(s),r.set("invoiceFiles",e),t.invoiceItems=n,r.save(t).then(function(e){return e.get("organization").fetch().then(function(e){var t=e.get("invoiceNumber").split("-"),n=Number(t[1])+1,r=t[0]+"-"+formatInvoiceNumber(n,t[1].length);return e.set("invoiceNumber",r),e.save()}).then(function(t){return console.log("invoice created successfully"),e})})})})},getPreferences:function(e){var t=p(e);if(!t){var n="user: "+e.id+" has no Organization assigned.";return Parse.Promise.error(n)}var r={},i=Parse.Object.extend("Preferencies"),a=new Parse.Query(i);return a.equalTo("organization",t),a.first().then(function(e){r.discountType=e.get("invoiceDiscount"),r.numAutoGen=e.get("invoiceAg"),r.shipCharges=e.get("invoiceShippingCharges"),r.adjustments=e.get("invoiceAdjustments"),r.salesPerson=e.get("invoiceSalesPerson"),r.thanksNote=e.get("invoiceThanksNotes"),r.notes=e.get("invoiceNotes"),r.terms=e.get("invoiceTerms"),r.itemDescOnInvoice=e.get("itemDescOnInvoice")}).then(function(){var e=Parse.Object.extend("Organization");return(a=new Parse.Query(e)).select("dateFormat","invoiceFields","invoiceNumber","displayCountry"),a.get(t.id).then(function(e){r.dateFormat=e.get("dateFormat"),r.customFields=e.get("invoiceFields"),r.invoiceNumber=e.get("invoiceNumber"),r.displayCountry=e.get("displayCountry")}).then(function(){return r})})},setPreferences:function(e,t){var n=p(e);if(!n){var r="user: "+e.id+" has no Organization assigned.";return Parse.Promise.error(r)}var i=[];n.set("invoiceFields",t.customFields),t.invoiceAg&&n.set("invoiceNumber",t.invoiceNumber),i.push(n.save());var a=Parse.Object.extend("Preferencies"),o=new Parse.Query(a);return o.equalTo("organization",n),o.first().then(function(e){return e.set("invoiceAg",t.invoiceAg),e.set("invoiceSalesPerson",t.salesPerson),e.set("invoiceDiscount",t.discountType),e.set("invoiceAdjustments",t.adjustments),e.set("invoiceShippingCharges",t.shipCharges),e.set("invoiceNotes",t.notes),e.set("invoiceTerms",t.terms),e.set("invoiceThanksNotes",t.thanksNote),e.set("itemDescOnInvoice",t.itemDescOnInvoice),i.push(e.save()),Parse.Promise.when(i)})},listInvoices:function(e){var n=p(e);if(n){var r=Parse.Object.extend("Customer");new Parse.Query(r).notEqualTo("isDeleted",1);var i=Parse.Object.extend("Invoices"),a=new Parse.Query(i);return a.equalTo("organization",n),a.include("customer"),a.include("lateFee"),a.limit(1e3),a.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"listInvoices"}))}),n})}},createInvoiceReceipt:function(t,n){var r=Parse.Object.extend("Invoices"),i=new Parse.Query(r);i.include("invoiceItems","customer","lateFee","invoiceItems.item","invoiceItems.tax","organization","userID","userID.defaultTemplate","userID.businessInfo");var o={};return i.get(t).then(function(e){o.invoiceObj=e;var t=e.get("userID"),r=e.get("organization").get("logo");return g=r?r._url:void 0,c(t).then(function(i){return a.loadAllOfCurrentUser().then(function(a){var s=t.get("defaultTemplate");if(s){var c=s.get("templateData");return o.htmlFile=s.get("templateHTML"),o.emailHtmlFile=s.get("emailHTML"),o.cardUrl=s.get("linkedFile").url(),d(c.url(),t,e,n,i,r,a)}var u=Parse.Object.extend("InvoiceTemplate"),l=new Parse.Query(u);return l.equalTo("name","Template 1"),l.first().then(function(s){var c=s.get("templateData");return o.htmlFile=s.get("templateHTML"),o.emailHtmlFile=s.get("emailHTML"),o.cardUrl=s.get("linkedFile").url(),d(c.url(),t,e,n,i,r,a)})})})}).then(function(t){return e.when(t).then(function(e){var t=e.newXml,n=new Parse.File("test1.xml",{base64:t},"text/xml");return o.pdf=e.pdf,n.save()})}).then(function(e){return o.xml=e,l(e.url(),o.emailHtmlFile.url(),o.cardUrl)}).then(function(e){return new Parse.File("test2.html",{base64:e},"text/html").save()}).then(function(e){return o.emailHtml=e,u(o.xml.url(),o.htmlFile.url(),o.cardUrl)}).then(function(e){return new Parse.File("test2.html",{base64:e},"text/html").save()}).then(function(e){return o.invoiceObj.set("invoiceLabels",o.xml),o.invoiceObj.set("emailReceipt",o.emailHtml),o.invoiceObj.set("invoiceReceipt",e),o.invoiceObj.set("pdfReceipt",o.pdf),o.invoiceObj.set("hasPdfReceipt",!0),o.invoiceObj.save()}).then(function(e){return e})},sendInvoiceText:function(e){var n=new t(e,{operation:"sendReceipt"}),a=n.entity.get("customer");if(a=a.get("mobile"))var o=a,s=n.customer.displayName,c=r(n.entity.balanceDue,"$",2),u=i.entity[0].get("company"),l=n.entity.invoiceReceipt.url(),d=s+", "+u+" has sent you an invoice of "+c+". ";return Parse.Cloud.run("createShortUrl",{link:l}).then(function(t){return Parse.Cloud.run("sendSms",{to:o,body:d+t.data.data.url}).then(function(t){return console.log(t),e},function(t){return console.error(t),e})})},sendInvoiceTextToNumber:function(e,n){var a=new t(e,{operation:"sendReceipt"}),o=n;if(o)var s=o,c=a.customer.displayName,u=r(a.entity.balanceDue,"$",2),l=i.entity[0].get("company"),d=a.entity.invoiceReceipt.url(),m=c+", "+l+" has sent you an invoice of "+u+". ";return Parse.Cloud.run("createShortUrl",{link:d}).then(function(t){return Parse.Cloud.run("sendSms",{to:s,body:m+t.data.data.url}).then(function(t){return console.log(t),e},function(t){return console.error(t),e})})},sendInvoiceReceipt:function(e){var n=new t(e,{operation:"sendReceipt"}),r=n.entity.invoiceReceipt.url();return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:r}}).then(function(t){var r=void 0,a=i.entity[0].get("company"),o=(n.entity.invoiceReceipt.url(),"Invoice From "+a);if(n.entity.customerEmails)r=n.entity.customerEmails[0];else{var s=n.entity.get("customer");r=s.get("email")}t=(t=t.replace("<!DOCTYPE html>","")).trim();var c=1,u=document.getElementById("targetframe1");return u.src="about:blank",u.contentWindow.document.open(),u.contentWindow.document.write(t),u.contentWindow.document.close(),u.onload=function(){return c=0,Parse.Cloud.run("sendMailgunHtml",{toEmail:r,fromEmail:"no-reply@invoicesunlimited.com",subject:o,html:"<html>"+$("#targetframe1").contents().find("html").html()+"</html>"}).then(function(t){return console.log(t),e})},Promise.resolve("")})},sendInvoiceReceiptToEmail:function(e,n){var r=new t(e,{operation:"sendReceipt"}),a=r.entity.emailReceipt.url();return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:a}}).then(function(t){var a=n,o=i.entity[0].get("company"),s=(r.entity.invoiceReceipt.url(),"Invoice From "+o);t=(t=t.replace("<!DOCTYPE html>","")).trim();var c=1,u=document.getElementById("targetframe1");return u.src="about:blank",u.contentWindow.document.open(),u.contentWindow.document.write(t),u.contentWindow.document.close(),u.onload=function(){return c=0,Parse.Cloud.run("sendMailgunHtml",{toEmail:a,fromEmail:"no-reply@invoicesunlimited.com",subject:s,html:"<html>"+$("#targetframe1").contents().find("html").html()+"</html>"}).then(function(t){return console.log(t),e})},Promise.resolve("")})},downloadInvoiceReceipt:function(e){var n=new t(e,{operation:"sendReceipt"}),r=n.entity.invoiceReceipt.url();return $.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:r}}).then(function(e){if(n.entity.customerEmails)n.entity.customerEmails[0],n.organization.name,n.entity.invoiceReceipt.url();e=(e=e.replace("<!DOCTYPE html>","")).trim();var t=document.createElement("iframe");return document.body.appendChild(t),t.style.display="none",t.setAttribute("id","myFrame"),t.contentWindow.document.open(),t.contentWindow.document.write(e),t.contentWindow.document.close(),t.onload=function(){var e=t.contentWindow.document.getElementsByTagName("body");e=e.innerHTML;var n='<page id="page-container">'+$("#myFrame").contents().find("body").html()+"</page>";$.ajax({method:"POST",type:"POST",url:"generatePDF.php",data:{html:n}}).then(function(e){})},Promise.resolve("")})}};var g}]),invoicesUnlimited.factory("invoicesFactory",["userFactory","commentFactory","paymentFactory",function(e,t,n){if(e){var r=["total","status","invoiceNumber","invoiceDate","dueDate","balanceDue","customer","payment"];return function(e){if(e){setObjectOperations({object:e,fieldName:void 0,parent:void 0,fields:r});var i=e.get("comments");i&&(i=i.map(function(e){return new t(e)}),this.comments=i);var a=e.get("payment");a&&(a=a.map(function(e){return new n(e)}),this.payments=a),this.invoiceDate=e.invoiceDate.toISOString().slice(0,10).split("-").reverse().join("/"),this.entity=e}}}}]),invoicesUnlimited.factory("itemService",["$q","itemFactory",function(e,t){return{test:function(){console.log("working")},createItems:function(e){if(e.items.length<1)return Parse.Promise.as([]);var n=[],r=Parse.Object.extend("Item");return e.items.forEach(function(t){var i=new r;i.set("userID",e.user),i.set("organization",e.organization),i.setACL(e.acl),i.set("title",t.title),i.set("rate",String(t.rate)),t.tax&&i.set("tax",Parse.Object.extend("Tax").createWithoutData(t.tax.id)),t.desc&&i.set("itemDescription",t.desc),t.expenseId&&i.set("expanseId",t.expenseId),n.push(i)}),Parse.Object.saveAll(n).then(function(e){return e=e.map(function(e){return new t(e)})})},getItemNames:function(e){var t=new Parse.Query("Item");return t.equalTo("organization",e.organization),t.select("title"),t.find()}}}]),invoicesUnlimited.factory("lateFeeService",["lateFeeFactory",function(e){return{getAllLateFees:function(t){var n=new Parse.Query("LateFee");return n.equalTo("organization",t.organization),n.select("name","price","type"),n.find().then(function(t){return t.map(function(t){return new e(t)})})},createLateFee:function(t,n){var r=new(Parse.Object.extend("LateFee")),i=new Parse.ACL;return i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0),r.setACL(i),console.log(t),r.save(t).then(function(t){return new e(t)},function(e){console.log(e.message)})},updateLateFee:function(t){return t.save().then(function(t){return new e(t)})}}}]),invoicesUnlimited.factory("organizationFactory",["userFactory",function(e){var t=e,n={entity:[],entities:[]},r=["creditNumber","portalURL","dateFormat","fiscalYearStart","name","fieldSeparator","estimateNumber","invoiceNumber","companyAddress","language","timeZone","email"],i=function(e,i){return e.fetch().then(function(e){return setObjectOperations({object:e,fieldName:i,parent:t.entity.length?t.entity[0]:null,fields:r}),"entity"==i&&n[i].pop(),n[i].push(e),n},function(e){console.log(e.message)})},a=function(){var e;return t.get?e=t.get("selectedOrganization"):t.entity[0]&&t.entity[0].get&&(e=t.entity[0].get("selectedOrganization")),e?i(e,"entity"):(n.empty=!0,e)};return n.clearAllOnLogOut=function(){n.entity.length=0,n.entities.length=0},n.load=function(){return n.entity.length?n:a()},n.createNew=function(e){if(!n.entity.length)return(new(Parse.Object.extend("Organization"))).save(e,{success:function(e){setObjectOperations({object:e,fieldName:"selectedOrganization",parent:t.entity.length?t.entity[0]:null,fields:r}),n.entity.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}}).then(function(e){return t.entity[0].add("organizations",e),[t.save({selectedOrganization:e}),e]},errorCallback).then(function(e){return e[1]},errorCallback)},n.createNewWithoutSelect=function(e){if(!n.entity.length)return(new(Parse.Object.extend("Organization"))).save(e,{success:function(e){setObjectOperations({object:e,fields:r}),n.entities.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}}).then(function(e){return t.entity[0].add("organizations",e),[t.save(),e]},errorCallback).then(function(e){return e[1]},errorCallback)},n}]),invoicesUnlimited.factory("preferencesFactory",["userFactory","roleFactory",function(e,t){var n={entity:[]},r=["invoiceShippingCharges","creditNotes","invoiceThanksNotes","creditTerms","invoiceDiscount","invoiceNotes","estimateNotes","invoiceTerms","estimateTerms","invoiceAdjustments","invoiceSalesPerson","invoiceAg","estimateAg","creditAg"],i=function(){if(e.entity.length){var t=new Parse.Query("Preferencies");return t.equalTo("userID",e.entity[0]),t.first().then(function(e){return setObjectOperations({object:e,fields:r}),n.entity.pop(),n.entity.push(e),n},function(e){console.log(e.message)})}};return n.clearAllOnLogOut=function(){n.entity.length=0},n.load=function(){return n.entity.length?n:i()},n.createNew=function(e){if(!n.entity.length){var i=new(Parse.Object.extend("Preferencies"));return i.setACL(t.createACL()),i.save(e,{success:function(e){setObjectOperations({object:e,fields:r}),n.entity.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}})}},n}]),invoicesUnlimited.factory("principalFactory",["userFactory","roleFactory",function(e,t){var n=e,r={entity:[]},i=function(){var e;return n.get?e=n.get("principalInfo"):n.entity[0]&&n.entity[0].get&&(e=n.entity[0].get("principalInfo")),e?e.fetch().then(function(e){return setObjectOperations({object:e,fieldName:"principalInfo",parent:n.entity.length?n.entity[0]:null,fields:null}),r.entity.pop(),r.entity.push(e),r},function(e){console.log(e.message)}):(r.empty=!0,e)};return r.clearAllOnLogOut=function(){r.entity.length=0},r.load=function(){return r.entity.length?r.entity[0]:i()},r.createNew=function(e){if(!r.entity.length){var i=new(Parse.Object.extend("PrincipalInfo"));return i.setACL(t.createACL()),i.save(e,{success:function(e){setObjectOperations({object:e,fieldName:"principalInfo",parent:n.entity.length?n.entity[0]:null,fields:void 0}),r.entity.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}})}},r}]),invoicesUnlimited.factory("projectService",["projectFactory","itemService","currencyFilter",function(e,t,n){function r(e,t){t.timesheets=[],Parse.Promise.as([]);var n=[],r=[],i=Parse.Object.extend("Timesheets");return e.forEach(function(e){if(e.attributes)n.push(e);else{var a=new i;a.set("userID",t.user),a.set("organization",t.organization),a.setACL(t.acl),a.set("user",e.user),a.set("task",e.task),a.set("date",e.date),a.set("notes",e.notes),a.set("hoursSpent",e.hoursSpent),a.set("minutesSpent",e.minutesSpent),r.push(a)}}),Parse.Object.saveAll(r).then(function(e){return e.concat(n)})}function i(e,t){Parse.Promise.as([]);var n=[],r=[],i=Parse.Object.extend("Staff");return e.forEach(function(e){if(e.entity)e.entity.set("chosenUser",e.user),e.entity.staffHours=e.staffHours,r.push(e.entity);else{var a=new i;a.set("userID",t.user),a.set("organization",t.organization),a.setACL(t.acl),a.set("chosenUser",e.user),a.set("staffHours",e.staffHours),n.push(a)}}),Parse.Object.saveAll(n.concat(r)).then(function(e){return e})}function a(e){var t=e.get("organizations");return t?t[0]:void 0}return{test:function(){console.log("working")},checkProjectNameAvailable:function(e){var t=Parse.Object.extend("Projects"),n=new Parse.Query(t);return n.equalTo("organization",e.organization),n.equalTo("projectName",e.projectName),n.select("projectName"),n.first().then(function(e){return!e})},listProjects:function(t){var n=a(t);if(n){var r=Parse.Object.extend("Projects"),i=new Parse.Query(r);return i.equalTo("organization",n),i.include("customer"),i.include("users.chosenUser"),i.find().then(function(t){var n=[];return t.forEach(function(t){n.push(new e(t,{operation:"listProjects"}))}),n})}},getProjectDetails:function(t){var n=Parse.Object.extend("Projects"),r=new Parse.Query(n);return r.include("customer"),r.include("tasks"),r.include("users.chosenUser"),r.include("timeSheets.task"),r.include("timeSheets.user"),r.get(t).then(function(t){return new e(t,{operation:"details"})})},getProject:function(t){var n=Parse.Object.extend("Projects"),r=new Parse.Query(n);return r.include("customer"),r.include("tasks"),r.include("users.chosenUser"),r.include("timeSheets.task"),r.include("timeSheets.user"),r.include("timesheets"),r.get(t).then(function(t){return new e(t,{operation:"getProject"})})},createNewProject:function(e,t,n,a){var o=new Parse.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0);var s={user:e.userID,organization:e.organization,acl:o},c=new Parse.Object("Projects",e);return c.setACL(o),r(a,s).then(function(e){return c.set("timeSheets",e),i(n,s).then(function(e){return c.set("users",e),c.save().then(function(e){return console.log("project created successfully"),e})})})},updateProject:function(e,t,n,a,o){var s=new Parse.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0);var c={acl:s,user:t,organization:t.get("organizations")[0]};return r(a,c).then(function(t){return e.entity.set("timeSheets",t),i(o,c).then(function(t){return e.entity.set("users",t),e.entity.save().then(function(e){return console.log("project created successfully"),e})})})}}}]),invoicesUnlimited.service("queryService",["userFactory",function(e){this.find=function(e){var t;if(arguments.length>1){var n=arguments;return(t=new Parse.Query(n[0])).equalTo(n[1],n[2]),t.limit(1e3),t.find()}return(t=new Parse.Query(e.className)).equalTo(e.field,e.value),t.limit(1e3),t.find()},this.ext={},this.ext.find=function(e){var t;if(arguments.length>1){var n=arguments;return(t=new Parse.Query(n[0])).equalTo(n[1],n[2]),n[3].forEach(function(e){t[e.name](e.param)}),t.limit(1e3),t.find()}return(t=new Parse.Query(e.className)).equalTo(e.field,e.value),e.methods.forEach(function(e){t[e.name](e.param)}),t.limit(1e3),t.find()},this.first=function(e){var t=new Parse.Query(e.className);return t.equalTo(e.field,e.value),t.first()}}]),invoicesUnlimited.factory("reportsService",["$q","invoiceFactory","creditNoteFactory",function(e,t,n){return{salesByCustomer:function(e){var n=Parse.Object.extend("Invoices"),r=new Parse.Query(n);return r.equalTo("organization",e.organization),r.exists("payment"),r.greaterThanOrEqualTo("invoiceDate",e.fromDate),r.lessThanOrEqualTo("invoiceDate",e.toDate),r.include("customer"),r.limit(1e3),r.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"salesByCustomerReport"}))}),n})},salesByItem:function(e){var n=Parse.Object.extend("Invoices"),r=new Parse.Query(n);return r.equalTo("organization",e.organization),r.exists("payment"),r.greaterThanOrEqualTo("invoiceDate",e.fromDate),r.lessThanOrEqualTo("invoiceDate",e.toDate),r.include("invoiceItems"),r.limit(1e3),r.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"salesByItemReport"}))}),n})},customerCredit:function(e){var t=Parse.Object.extend("CreditNotes"),r=new Parse.Query(t);return r.equalTo("organization",e.organization),r.notEqualTo("status","Closed"),r.greaterThanOrEqualTo("creditNoteDate",e.fromDate),r.lessThanOrEqualTo("creditNoteDate",e.toDate),r.include("customer"),r.limit(1e3),r.find().then(function(e){var t=[];return e.forEach(function(e){t.push(new n(e,{operation:"customerCredit"}))}),t})},customerBalance:function(e){var n=Parse.Object.extend("Invoices"),r=new Parse.Query(n);return r.equalTo("organization",e.organization),r.include("customer"),r.limit(1e3),r.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"customerBalance"}))}),n})},invoiceAging:function(e){var n=Parse.Object.extend("Invoices"),r=new Parse.Query(n);return r.equalTo("organization",e.organization),r.notEqualTo("status","Paid"),r.include("customer"),r.include("lateFee"),r.limit(1e3),r.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"invoiceAging"}))}),n})},paymentsReceived:function(e){var n=Parse.Object.extend("Invoices"),r=new Parse.Query(n);return r.equalTo("organization",e.organization),r.exists("payment"),r.greaterThanOrEqualTo("invoiceDate",e.fromDate),r.lessThanOrEqualTo("invoiceDate",e.toDate),r.include("customer","payment"),r.limit(1e3),r.find().then(function(e){var n=[];return e.forEach(function(e){n.push(new t(e,{operation:"paymentsReceived"}))}),n})},expenseByCategory:function(e){var t=Parse.Object.extend("Expanses"),n=new Parse.Query(t);return n.equalTo("organization",e.organization),n.greaterThanOrEqualTo("expanseDate",e.fromDate),n.lessThanOrEqualTo("expanseDate",e.toDate),n.select("category","amount"),n.limit(1e3),n.find()}}}]),invoicesUnlimited.factory("roleFactory",["userFactory",function(e){var t=e.entity,n={entity:[]},r=function(){if(t.length){if(n.entity.length)return Promise.resolve(n);var e=new Parse.Query(Parse.Role);return e.equalTo("users",t[0]),e.first().then(function(e){return n.entity.pop(),n.entity.push(e),n},function(e){return console.log(e.message),e})}};return n.clearAllOnLogOut=function(){n.entity.length=0},n.addUser=function(e){return n.entity.length?(n.entity[0].getUsers().add(e),n.entity[0].save()):r().then(function(){return n.entity[0].getUsers().add(e),n.entity[0].save()})},n.load=function(){return r()},n.getRole=function(e){var t=new Parse.Query(Parse.Role);return t.equalTo("name",e.name),t.first()},n.createNew=function(e){if(!n.entity.length)return n.getRole(e).then(function(t){var r=new Parse.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0);var i=t||new Parse.Role(e.name,r);return i.getUsers().add(e.userID),i.save({success:function(e){n.entity.pop(),n.entity.push(e),console.log(e.className+" created")},error:function(e){console.log(e.message)}})})},n.createACL=function(){if(n.entity.length){var e=new Parse.ACL;return e.setPublicReadAccess(!0),e.setPublicWriteAccess(!0),e}},n}]),invoicesUnlimited.factory("signatureFactory",["userFactory","roleFactory",function(e,t){var n=e,r={entity:[]},i=function(){var e;return n.get?e=n.get("signatureImage"):n.entity[0]&&n.entity[0].get&&(e=n.entity[0].get("signatureImage")),e?e.fetch().then(function(e){return setObjectOperations({object:e,fieldName:"signatureImage",parent:n.entity.length?n.entity[0]:null,fields:void 0}),r.entity.pop(),r.entity.push(e),r},function(e){console.log(e.message)}):(r.empty=!0,e)};return r.clearAllOnLogOut=function(){r.entity.length=0},r.load=function(){return r.entity.length?r.entity[0]:i()},r.createNew=function(e){if(!r.entity.length){var i=new(Parse.Object.extend("Signature"));return i.setACL(t.createACL()),i.save(e,{success:function(e){setObjectOperations({object:e,fieldName:"signatureImage",parent:n.entity.length?n.entity[0]:null,fields:void 0}),r.entity.push(e),console.log(e.className+" created")},error:function(e,t){console.log(t.message)}})}},r}]),invoicesUnlimited.factory("taxService",["$q",function(e){function t(e){var t=e.get("organizations");if(t)return t[0];var n="user: "+e.id+" has no Organization assigned.";return void console.log(n)}function n(e,t){return e.set("title",t.taxName),e.set("value",Number(t.taxRate)),e.set("compound",t.isCompound?1:0),e.save().then(function(e){console.log("taxId: "+e.id+" updated.")})}function r(e,t,n){var r=new Parse.Query(n);return r.equalTo("type",2),r.find().then(function(n){for(var r=0;r<n.length;++r)for(var i=n[r].get("associatedTaxes"),a=0;a<i.length;++a)if(i[a].id==t.id){var o=n[r].get("value");n[r].set("value",o+e),n[r].save().then(function(e){console.log("Tax Group: "+e.id+" updated.")});break}})}return{getTaxes:function(n,r){showLoader();var i=t(n);if(!i)return hideLoader(),void r([]);var a=new Parse.Query("Tax"),o=e.defer();a.equalTo("organization",i),a.find().then(function(e){o.resolve(e)},function(e){o.reject(results)}),o.promise.then(function(e){for(var t=[],n=0;n<e.length;++n){var i=e[n];t.push({id:i.id,name:i.get("title")+(2==i.get("type")?" (Tax Group)":""),rate:i.get("value"),type:i.get("type"),isCompound:Boolean(i.get("compound")),compound:i.get("compound"),entity:i})}hideLoader(),r(t)}).catch(function(e){hideLoader(),r([])})},saveNewGroupTax:function(e,n){var r=t(e.user);if(r){e.userID=e.user,delete e.user,e.organization=r,e.type=2;var i=new Parse.ACL;i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0);var a=new(Parse.Object.extend("Tax"));a.setACL(i),a.save(e,{success:function(e){n(e)},error:function(e,t){n("Failed to create new Tax, error code:"+t.message)}})}},saveNewTax:function(e,n){var r=t(e.user);if(r){e.userID=e.user,delete e.user,e.organization=r,e.type=1;var i=new Parse.ACL;i.setPublicReadAccess(!0),i.setPublicWriteAccess(!0);var a=new(Parse.Object.extend("Tax"));a.setACL(i),a.save(e,{success:function(e){n(e)},error:function(e,t){n("Failed to create new Tax, error code:"+t.message)}})}},saveEditedTax:function(e){var t=Parse.Object.extend("Tax");return new Parse.Query(t).get(e.taxId).then(function(i){var a=i.get("value"),o=Number(e.taxRate)-a;return n(i,e).then(function(){return r(o,i,t)})})}}}]),invoicesUnlimited.factory("userFactory",["appFields",function(e){function t(){return r.entity.length?r.entity[0].get("organizations")[0].fetch().then(function(e){return r.commonData.dateFormat=e.get("dateFormat"),Promise.resolve("")}):Promise.reject("")}var n=Parse.User.current()||{justLoggedIn:!1,entity:[]},r={entity:[],commonData:{}};if(Parse.User.current()){var i=Parse.User.current();setObjectOperations({object:i,fields:e.user}),r.entity.push(i)}return r.getField=function(e){return isEmpty(r.commonData)?t().then(function(){return r.commonData[e]}):Promise.resolve(r.commonData[e])},r.login=function(t,n,i){r.entity.length&&r.entity[0].id||Parse.User.logIn(t.username,t.password,{success:function(t){r.justLoggedIn=!0,setObjectOperations({object:t,fields:e.user}),r.entity.push(t),console.log("Logged in successfuly!"),n()},error:function(e,t){console.log(t.message),i(t)}})},r.logout=function(){return Parse.User.logOut().then(function(){n.entity&&n.entity.pop(),n.justLoggedIn&&(n.justLoggedIn=!1),r.entity.pop(),r.commonData={}})},r.signup=function(t){return(new Parse.User).signUp(t,{success:function(t){setObjectOperations({object:t,fields:e.user}),r.entity.pop(),r.entity.push(t);var n=new(Parse.Object.extend("ProjectUser"));return n.set("userID",t),n.set("companyName",t.get("company")),n.set("status","Activated"),n.set("role","Main"),n.set("userName",t.get("username")),n.set("emailID",t.get("email")),n.set("title",t.get("fullName")),n.set("organization",t.get("selectedOrganization")),n.save(null,{success:function(e){console.log(e.className+" created")},error:function(e,t){console.log(t.message)}})},error:function(e,t){console.log(t.message)}})},r.save=function(e){if(r.entity.length)return void 0===e&&(e=null),r.entity[0].save(e);console.log("Unable to save user. The user is undefined")},r}]);