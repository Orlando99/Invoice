'use strict';invoicesUnlimited.factory('accountFactory',['userFactory','roleFactory',function(e,a){var r,s=e,o={entity:[]},c=function(){var d,l='accountInfo';return s.get?d=s.get(l):s.entity[0]&&s.entity[0].get&&(d=s.entity[0].get(l)),d?d.fetch().then(function(u){return setObjectOperations({object:u,fieldName:l,parent:s.entity.length?s.entity[0]:null,fields:null}),o.entity.pop(),o.entity.push(u),o}):(o.empty=!0,d)};return o.clearAllOnLogOut=function(){o.entity.length=0},o.load=function(){return o.entity.length?o.entity[0]:c()},o.createNew=function(l){if(!o.entity.length){var d=Parse.Object.extend('AccountInfo'),u=new d;return u.setACL(a.createACL()),u.save(l,{success:function(m){setObjectOperations({object:m,fieldName:'accountInfo',parent:s.entity.length?s.entity[0]:null,fields:r}),o.entity.push(m),console.log(m.className+' created')},error:function(m,g){console.log(g.message)}})}},o}]);'use strict',invoicesUnlimited.factory('businessFactory',['userFactory','roleFactory','$rootScope','$state',function(e,a,s,o){var r=e,c={entity:[]},l=['businessName','city','zipCode','streetName','state','phoneNumber'],d=function(){var m,u='businessInfo';return r.get?m=r.get(u):r.entity[0]&&r.entity[0].get&&(m=r.entity[0].get(u)),m?m.fetch().then(function(g){return setObjectOperations({object:g,fieldName:u,parent:r.entity.length?r.entity[0]:null,fields:l}),c.entity.pop(),c.entity.push(g),c},function(g){console.log(g.message),r.logout().then(function(){hideLoader(),resetColorTheme(),o.go('login')},function(){o.go('login')})}):(c.empty=!0,m)};return c.clearAllOnLogOut=function(){c.entity.length=0},c.load=function(){return c.entity.length?c:d()},c.createNew=function(u){if(!c.entity.length){var m=Parse.Object.extend('BusinessInfo'),g=new m;return g.setACL(a.createACL()),g.save(u,{success:function(h){setObjectOperations({object:h,fieldName:'businessInfo',parent:r.entity.length?r.entity[0]:null,fields:l}),c.entity.push(h),console.log(h.className+' created')},error:function(h,y){console.log(y.message)}})}},c}]);'use strict',invoicesUnlimited.factory('cleanDataService',['businessFactory','coreFactory','projectUserFactory','roleFactory','currencyFactory','organizationFactory','preferencesFactory','accountFactory','principalFactory','signatureFactory',function(e,a,s,o,r,c,l,d,u,m){return{clearAllOnLogOut:function(){e.clearAllOnLogOut(),a.clearAllOnLogOut(),s.clearAllOnLogOut(),o.clearAllOnLogOut(),r.clearAllOnLogOut(),c.clearAllOnLogOut(),l.clearAllOnLogOut(),d.clearAllOnLogOut(),u.clearAllOnLogOut(),m.clearAllOnLogOut()}}}]);'use strict',invoicesUnlimited.factory('commentFactory',['userFactory',function(e){if(e){var s=function(r){r&&(setObjectOperations({object:r,fieldName:void 0,parent:void 0,fields:o}),this.date=r.date.formatDate('DD/MM/YY hh:mm',!0),this.entity=r)};s.createNewComment=function(r){var l=Parse.Object.extend('Comments'),d=new l,u=new Parse.ACL;return u.setPublicReadAccess(!0),u.setPublicWriteAccess(!0),d.setACL(u),d.save(r)};var o=['date','comment','name'];return s}}]);'use strict',invoicesUnlimited.factory('contactPersonFactory',['userFactory',function(e){if(!e.entity.length)return{};var o=['email','phone','mobile','lastname','firstname','salutation','defaultPerson'];return function(r){setObjectOperations({object:r,fields:o}),this.id=r.get('objectId'),this.entity=r,this.fieldNames=o,this.save=function(){return this.entity.save()},this.destroy=function(c){if(!c)return this.entity.destroy();c.entity.remove('contactPersons',this.entity);var l=this;return c.save().then(function(){return l.entity.destroy()},function(){debugger})}}}]);'use strict',invoicesUnlimited.factory('coreFactory',['userFactory','customerFactory','creditNoteFactory','invoicesFactory','itemFactory','expenseCategoryFactory','queryService',function(e,a,s,o,r,c,l){var d=e,u={};if(d)return u.clearAllOnLogOut=function(){u.allCustomers=void 0},u.getAllCustomers=function(m){return u.allCustomers&&!m?u.allCustomers:'General Employee'==d.entity[0].get('role')?l.ext.find('Customer','userID',d.entity.length?d.entity[0]:{},[{name:'include',param:'contactPersons'}]).then(function(g){var h=[];return g.forEach(function(y){if(!y.attributes.isDeleted){var f=new a(y);h.push(f)}}),u.allCustomers=h,h}):l.ext.find('Customer','organization',d.entity.length?d.entity[0].get('selectedOrganization'):{},[{name:'include',param:'contactPersons'}]).then(function(g){var h=[];return g.forEach(function(y){if(!y.attributes.isDeleted){var f=new a(y);h.push(f)}}),u.allCustomers=h,h})},u.getAllInvoices=function(m){var g=new Parse.Query('Invoices');return m.method?g[m.method](m.name,m.val1,m.val2,m.val3):g.equalTo(m.name,m.val1),g.include('comments'),g.include('payment'),g.limit(1e3),g.find().then(function(h){var y=[];return h.forEach(function(f){y.push(new o(f))}),y})},u.getAllCreditNotes=function(m){var g=new Parse.Query('CreditNotes');return m.method?g[m.method](m.name,m.val1,m.val2,m.val3):g.equalTo(m.name,m.val1),g.limit(1e3),g.find().then(function(h){var y=[];return h.forEach(function(f){y.push(new s(f,'customerBalance'))}),y})},u.getAllItems=function(m){var g=new Parse.Query('Item');return g.equalTo('organization',m.organization),g.notEqualTo('isDeleted',1),g.include('tax'),g.limit(1e3),g.find().then(function(h){var y=[];return h.forEach(function(f){0>f.get('title').indexOf('Misc. Item')&&y.push(new r(f))}),y})},u.getAllItemsIncludingDelete=function(m){var g=new Parse.Query('Item');return g.equalTo('organization',m.organization),g.include('tax'),g.limit(1e3),g.find().then(function(h){var y=[];return h.forEach(function(f){y.push(new r(f))}),y})},u.getUserRole=function(m){var g=new Parse.Query(Parse.Role);return g.equalTo('users',m),g.first().then(function(h){return h},function(h){console.log(h)})},u.getDefaultExpenseCategories=function(){var m=new Parse.Query('CategoryDefaults');return m.select('color','name','notes'),m.find().then(function(g){var h=[];return g.forEach(function(y){h.push(new c(y))}),h})},u.getExpenseCategories=function(m){var g=new Parse.Query('Category');return g.equalTo('organization',m.organization),g.select('color','name','notes'),g.find().then(function(h){var y=[];return h.forEach(function(f){y.push(new c(f))}),y})},u.getInvoiceTemplates=function(){var m=new Parse.Query('InvoiceTemplate');return m.select('name','templatePreview'),m.find()},u.getGeneralPrefs=function(m){var g=m.get('selectedOrganization');return g.fetch()},u}]);'use strict',invoicesUnlimited.factory('creditNoteService',['$q','creditNoteFactory','itemService','currencyFilter','currencyFactory',function(e,a,s,o,r){function c(y,f){return f.items=[],y.forEach(function(b){var v={title:b.selectedItem.entity.title,rate:b.selectedItem.entity.rate,expenseId:b.selectedItem.entity.expanseId};b.selectedItem.tax&&(v.tax=b.selectedItem.tax),f.items.push(v)}),s.createItems(f).then(function(b){for(var v=0;v<y.length;++v)y[v].selectedItem=b[v];return y})}function l(y,f){var b=new f.objectType;return b.setACL(f.acl),b.set('userID',f.user),b.set('organization',f.organization),b.set('item',y.selectedItem.entity),b.set('quantity',+y.quantity),b.set('amount',+y.amount),y.selectedTax&&b.set('tax',Parse.Object.extend('Tax').createWithoutData(y.selectedTax.id)),b}function d(y,f,b){return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:f}}).then(function(v){var T='Connect.open("GET", "uppage.xml"',C='Connect.open("GET", "'+y+'"';return C=C.replace('http:','https:'),v=v.replace(T,C),T='background: url(icn-card.png) no-repeat',C='background: url('+b+') no-repeat',C=C.replace('http:','https:'),v=v.replace(T,C),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:v}}).then(function(O){return O})})}function u(y,f){return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:f}}).then(function(v){var C='Connect.open("GET", "'+y+'"';return C=C.replace('http:','https:'),v=v.replace('Connect.open("GET", "uppage.xml"',C),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:v}}).then(function(O){return O},function(O){console.log(O)})})}function m(y,f,b,v){return $.ajax({type:'GET',url:'proxy.php',dataType:'xml',data:{address:y}}).then(function(T){var C=new X2JS,O=C.xml2json(T),N=O.items.label,I='$',F=1;N['invoice-title']='Credit Note',N.billType='estimate',N['list-header-total']='Total',N.headerTitle='',N['longmsg-title']='Notes',N['ordernotes-title']='Terms & Conditions',N.copyright='',N.disablePay='true',N['due-text']='',N['due-price']='',N['received-text']='',N['received-price']='',N.thanksmsg='',N['website-link']='',N['website-name']='',N['tip-text']=N['tip-price']='',O.items.shippingCharges='',O.items.shippingChargesPrice='',O.items.adjustments='',O.items.adjustmentsPrice='',N.discountPlace={text:''},N.paymentMadeText='Refund Made',N.creditsAppliedText='Credits Used',N.refundedText='Remaining Credits',N.ordernotes=b.get('terms'),N.longmsg=b.get('notes'),N['body-date']=formatDate(b.get('creditNoteDate'),'MMM D, YYYY'),N['past-due']=N['body-date'],N.purchaseOrderNumber=b.get('reference')?'Ref.# '+b.get('reference'):'',N.refid=b.get('creditNumber');var E=O.items.customFields;E.customField=void 0;var A=O.items.attachments;A.attachment=void 0;var P=f.get('colorTheme');P?'appBlueColor'==P?N['app-color']='#327DF5':'appSeagreenColor'==P?N['app-color']='#23AA92':'appGreenColor'==P?N['app-color']='#0EA81C':'appYellowColor'==P?N['app-color']='#EDE005':'appBrownColor'==P?N['app-color']='#E87605':'appRedColor'==P?N['app-color']='#E80000':'appPinkColor'==P?N['app-color']='#E657A3':'appPurpleColor'==P&&(N['app-color']='#7F5CBF'):N['app-color']='#327DF5',N.mailtotxt=f.get('email');var z=b.get('organization');if(z){N.mailto='mailto:'+z.get('email'),N.title='Credit from '+z.get('name');var D=z.get('logo');D&&(N.logo=z.get('logo').url())}var q=f.get('businessInfo');if(q){var L=[q.get('streetName'),q.get('city'),q.get('state'),q.get('zipCode')];z.get('displayCountry')&&L.push(f.get('country')),N.addres1=L.join(', '),N['business-name']=q.get('businessName'),N.nr=q.get('phoneNumber')}var R=b.get('customer');if(R){var w=R.get('email');N.clientmail=w,N.clientmailto='mailto:'+w,N.clientname=R.get('salutation')?R.get('salutation')+' '+R.get('displayName'):R.get('displayName'),N.clientnr=R.get('phone'),R.get('currency')&&(N['body-currency']=R.get('currency').split(' ')[0]);var S=v.filter(function(se){return se.entity.title==R.get('currency')})[0];S&&(I=S.entity.currencySymbol,F=S.entity.exchangeRate,!F&&(F=1))}var k=O.items,Q=O.items.label.taxes,W=0,U=0,M=b.get('creditNoteItems');if(M){k.itemRow=[],Q.tax=[];for(var H=0;H<M.length;++H){var G=M[H].get('item').get('title'),B=M[H].get('quantity'),Y=M[H].get('amount');U+=Y;var _={name:G,qty:B,price:o(Y*F,I,2)};k.itemRow.push(_);var X=M[H].get('tax');if(X){var J=X.get('title')+' ('+X.get('value')+'%)',Z=g(M[H],X);W+=Z;var K=o(Z*F,I,2);Q.tax.push({name:J,value:K})}}Q.tax.length||(Q.tax=void 0)}else k.itemRow=void 0,Q.tax=void 0;var ee=U+W;N.subtotalprice=o(U*F,I,2);var te=ee;N['total-price3']=N['body-price']=o(te*F,I,2);var ie=b.get('refundsMade')||0,ne=b.get('creditsUsed')||0;N.paymentMadePrice=o(ie*F,I,2),N.creditsAppliedPrice=o(ne*F,I,2);return N.refundtotal=o((te-ie-ne)*F,I,2),T=C.json2xml_str(O),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:T}}).then(function(se){return se})})}function g(y,f){var b=f.get('type'),v=f.get('value'),T=f.get('compound'),C=y.get('amount'),O=0;return 1==b?O=0.01*(C*v):2==b&&(O=0.01*(C*v),T&&(O=0.01*(O*T))),O}function h(y){var f=y.get('organizations');return f?f[0]:void 0}return{test:function(){console.log('working')},checkCreditNoteNumAvailable:function(y){var f=Parse.Object.extend('CreditNotes'),b=new Parse.Query(f);return b.equalTo('organization',y.organization),b.equalTo('creditNumber',y.creditNumber),b.select('creditNumber'),b.first().then(function(v){return!v})},getCustomerCreditNotes:function(y){var f=Parse.Object.extend('CreditNotes'),b=new Parse.Query(f);return b.select('remainingCredits','creditsUsed','creditNumber'),b.equalTo('customer',y),b.notEqualTo('status','Closed'),b.find().then(function(v){var T=[];return v.forEach(function(C){T.push(new a(C,{operation:'apply2Invoice'}))}),T})},getCreditNoteDetails:function(y){var f=Parse.Object.extend('CreditNotes'),b=new Parse.Query(f);return b.include('comments'),b.include('refunds'),b.include('customer.contactPersons'),b.include('customer'),b.get(y).then(function(v){var T=new a(v,{operation:'details'});return T})},addRefunds:function(y){var b=[],v=Parse.Object.extend('Refund'),T=new Parse.ACL;T.setPublicReadAccess(!0),T.setPublicWriteAccess(!0);for(var O,C=0;C<y.length;++C)O=new v,O.setACL(T),b.push(O.save(y[C]));return e.all(b)},getCreditNote:function(y){var f=Parse.Object.extend('CreditNotes'),b=new Parse.Query(f);return b.include('creditNoteItems'),b.get(y).then(function(v){var T=new a(v,{operation:'getCreditNote'});return T})},listCreditNotes:function(y){var f=h(y);if(f){var b=Parse.Object.extend('Customer'),v=new Parse.Query(b);v.notEqualTo('isDeleted',1);var T=Parse.Object.extend('CreditNotes'),C=new Parse.Query(T);return C.equalTo('organization',f),C.include('customer'),C.find().then(function(O){var N=[];return O.forEach(function(I){N.push(new a(I,{operation:'listCreditNotes'}))}),N})}},getPreferences:function(y){var f=h(y);if(!f){var b='user: '+y.id+' has no Organization assigned.';return Parse.Promise.error(b)}var v={},T=Parse.Object.extend('Preferencies'),C=new Parse.Query(T);return C.equalTo('organization',f),C.first().then(function(O){v.numAutoGen=O.get('creditAg'),v.notes=O.get('creditNotes'),v.terms=O.get('creditTerms')}).then(function(){var O=Parse.Object.extend('Organization');return C=new Parse.Query(O),C.select('dateFormat','creditNumber'),C.get(f.id).then(function(N){v.dateFormat=N.get('dateFormat'),v.creditNumber=N.get('creditNumber')}).then(function(){return v})})},setPreferences:function(y,f){var b=h(y);if(!b){var v='user: '+y.id+' has no Organization assigned.';return Parse.Promise.error(v)}var T=[];f.creditAg&&b.set('creditNumber',f.creditNumber),T.push(b.save());var C=Parse.Object.extend('Preferencies'),O=new Parse.Query(C);return O.equalTo('organization',b),O.first().then(function(N){return N.set('creditAg',f.creditAg),N.set('creditNotes',f.notes),N.set('creditTerms',f.terms),T.push(N.save()),Parse.Promise.when(T)})},createNewCreditNote:function(y,f){var v=[],T=new Parse.ACL;T.setPublicReadAccess(!0),T.setPublicWriteAccess(!0);var C=Parse.Promise.as(void 0),O=[],N=[];f.forEach(function(F){F.selectedItem.create?O.push(F):N.push(F)});var I={user:y.userID,organization:y.organization,acl:T};return c(O,I).then(function(F){return f=N.concat(F),C}).then(function(){var E=Parse.Object.extend('CreditNoteItem');return f.forEach(function(A){var P=new E;P.setACL(T),P.set('userID',y.userID),P.set('organization',y.organization),P.set('item',A.selectedItem.entity),P.set('quantity',+A.quantity),P.set('amount',+A.amount),A.selectedTax&&P.set('tax',Parse.Object.extend('Tax').createWithoutData(A.selectedTax.id)),v.push(P)}),Parse.Object.saveAll(v).then(function(A){var P=Parse.Object.extend('CreditNotes'),z=new P;return z.setACL(T),y.creditNoteItems=A,z.save(y).then(function(D){return D.get('organization').fetch().then(function(q){var L=q.get('creditNumber'),R=L.split('-'),w=+R[1]+1,S=R[0]+'-'+formatInvoiceNumber(w,R[1].length);return q.set('creditNumber',S),q.save()}).then(function(){return console.log('creditNote created successfully'),D})})})})},updateCreditNote:function(y,f,b,v){var O=[],N=[],I=[],F=[],E={},A=Parse.Object.extend('CreditNoteItem'),P=new Parse.ACL;P.setPublicReadAccess(!0),P.setPublicWriteAccess(!0),f.forEach(function(D){D.selectedItem.create?I.push(D):D.id?E[D.id]=D:F.push(D)});var z={acl:P,user:v,organization:v.get('organizations')[0],objectType:A};return c(I,z).then(function(D){D.forEach(function(w){w.id?E[w.id]=w:F.push(w)}),F=F.map(function(w){return l(w,z)});for(var R,q=y.creditItems,L=0;L<q.length;++L)R=E[q[L].entity.id],R?(q[L].entity.set('item',R.selectedItem.entity),q[L].entity.set('quantity',+R.quantity),q[L].entity.set('amount',+R.amount),R.selectedTax?q[L].entity.set('tax',Parse.Object.extend('Tax').createWithoutData(R.selectedTax.id)):q[L].entity.unset('tax'),O.push(q[L].entity)):N.push(q[L].entity);return O=O.concat(F),Parse.Object.destroyAll(N)}).then(function(){return Parse.Object.saveAll(O)}).then(function(D){return y.entity.set('creditNoteItems',D),y.entity.save()}).then(function(D){return D})},createCreditNoteReceipt:function(y){var f=Parse.Object.extend('CreditNotes'),b=new Parse.Query(f);b.include('creditNoteItems','customer','creditNoteItems.item','creditNoteItems.item.tax','organization','userID','userID.defaultTemplate','userID.businessInfo');var v={};return b.get(y).then(function(T){v.creditNoteObj=T;var C=T.get('userID');return r.loadAllOfCurrentUser().then(function(O){var N=C.get('defaultTemplate');if(!N){var I=Parse.Object.extend('InvoiceTemplate'),F=new Parse.Query(I);return F.equalTo('name','Template 1'),F.first().then(function(A){var P=A.get('templateData');return v.htmlFile=A.get('templateHTML'),v.emailHtmlFile=A.get('emailHTML'),v.cardUrl=A.get('linkedFile').url(),m(P.url(),C,T,O)})}var E=N.get('templateData');return v.htmlFile=N.get('templateHTML'),v.emailHtmlFile=N.get('emailHTML'),v.cardUrl=N.get('linkedFile').url(),m(E.url(),C,T,O)})}).then(function(T){var C=new Parse.File('test1.xml',{base64:T},'text/xml');return C.save()}).then(function(T){return v.xml=T,u(T.url(),v.emailHtmlFile.url(),v.cardUrl)}).then(function(T){var C=new Parse.File('test2.html',{base64:T},'text/html');return C.save()}).then(function(T){return v.emailHtml=T,d(v.xml.url(),v.htmlFile.url(),v.cardUrl)}).then(function(T){var C=new Parse.File('test2.html',{base64:T},'text/html');return C.save()}).then(function(T){return v.creditNoteObj.set('creditLabels',v.xml),v.creditNoteObj.set('creditReceipt',T),v.creditNoteObj.set('emailReceipt',v.emailHtml),v.creditNoteObj.save()}).then(function(T){return T})},sendCreditNoteText:function(y){var f=new a(y,{operation:'sendReceipt'}),b=f.entity.get('customer');if(b=b.get('mobile'),b)var v=b,T=f.customer.displayName,C=o(f.entity.remainingCredits,'$',2),O=f.organization.name,N=f.entity.creditReceipt.url(),I=T+', '+O+' has sent you Credit Note of '+C+'. ';return Parse.Cloud.run('createShortUrl',{link:N}).then(function(F){return Parse.Cloud.run('sendSms',{to:v,body:I+F.data.data.url}).then(function(E){return console.log(E),y},function(E){return console.error(E),y})})},sendCreditNoteTextToNumber:function(y,f){var b=new a(y,{operation:'sendReceipt'}),v=f;if(v)var T=v,C=b.customer.displayName,O=o(b.entity.remainingCredits,'$',2),N=b.organization.name,I=b.entity.creditReceipt.url(),F=C+', '+N+' has sent you Credit Note of '+O+'. ';return Parse.Cloud.run('createShortUrl',{link:I}).then(function(E){return Parse.Cloud.run('sendSms',{to:T,body:F+E.data.data.url}).then(function(A){return console.log(A),y},function(A){return console.error(A),y})})},sendCreditNoteReceiptToEmail:function(y,f){var b=new a(y,{operation:'sendReceipt'}),v=b.entity.emailReceipt.url();return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:v}}).then(function(T){var O=b.organization.name;T=T.replace('<!DOCTYPE html>',''),T=T.trim();var F=1,E=document.createElement('iframe');return document.body.appendChild(E),E.src='about:blank',E.style.display='none',E.setAttribute('id','myFrame'),E.contentWindow.document.open(),E.contentWindow.document.write(T),E.contentWindow.document.close(),E.onload=function(){return F=0,Parse.Cloud.run('sendMailgunHtml',{toEmail:f,fromEmail:'no-reply@invoicesunlimited.com',subject:'Credit Note From '+O,html:'<html>'+$('#myFrame').contents().find('html').html()+'</html>'}).then(function(A){return console.log(A),y})},y})},sendCreditNoteReceipt:function(y){var f=new a(y,{operation:'sendReceipt'}),b=f.entity.emailReceipt.url();return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:b}}).then(function(v){if(f.entity.customerEmails)var T=f.entity.customerEmails[0],C=f.organization.name,O='Credit Note From '+C;v=v.replace('<!DOCTYPE html>',''),v=v.trim();var I=1,F=document.createElement('iframe');return document.body.appendChild(F),F.style.display='none',F.setAttribute('id','myFrame'),F.contentWindow.document.open(),F.contentWindow.document.write(v),F.contentWindow.document.close(),F.onload=function(){return I=0,Parse.Cloud.run('sendMailgunHtml',{toEmail:T,fromEmail:'no-reply@invoicesunlimited.com',subject:O,html:'<html>'+$('#myFrame').contents().find('html').html()+'</html>'}).then(function(E){return console.log(E),y})},y})}}}]);'use strict',invoicesUnlimited.factory('currencyFactory',['userFactory','roleFactory','currencyFactoryService',function(e,a,s){var o=e,r={entity:[]},c=['currencySymbol','decimalPlace','format','title'],l=function(){var u,d='currency';return o.get?u=o.get(d):o.entity[0]&&o.entity[0].get&&(u=o.entity[0].get(d)),u?u.fetch().then(function(m){return setObjectOperations({object:m,fieldName:d,parent:o.entity.length?o.entity[0]:null,fields:c}),r.entity.pop(),r.entity.push(m),r},function(m){console.log(m.message)}):(r.empty=!0,u)};return r.clearAllOnLogOut=function(){r.entity.length=0},r.load=function(){return r.entity.length?r:l()},r.createNew=function(d){if(!r.entity.length){var u=Parse.Object.extend('Currency'),m=new u;return m.setACL(a.createACL()),m.save(d,{success:function(g){setObjectOperations({object:g,fieldName:'currency',parent:o.entity.length?o.entity[0]:null,fields:c}),r.entity.push(g),console.log(g.className+' created')},error:function(g,h){console.log(h.message)}}).then(function(g){return[o.save({currency:g}),g]},errorCallback).then(function(g){return g[1]},function(){debugger})}},r.loadAll=function(d){var u=Parse.Object.extend('Currency'),m=new Parse.Query(u);return m.equalTo('organization',d.organization),m.find().then(function(g){var h=[];return g.forEach(function(y){h.push(new s(y))}),h})},r.loadAllOfCurrentUser=function(){var d=Parse.Object.extend('Currency'),u=new Parse.Query(d);return u.equalTo('organization',e.entity[0].get('selectedOrganization')),u.find().then(function(m){var g=[];return m.forEach(function(h){g.push(new s(h))}),g})},r.createNewCurrency=function(d){var m=new Parse.ACL;m.setPublicReadAccess(!0),m.setPublicWriteAccess(!0);var g=Parse.Object.extend('Currency'),h=new g;return h.setACL(m),h.save(d).then(function(y){return new s(y)})},r.saveEditedCurrency=function(d){return d.save().then(function(u){return new s(u)})},r}]);'use strict',invoicesUnlimited.factory('customerFactory',['userFactory','contactPersonFactory','appFields',function(e,a,s){if(!e.entity.length)return{};return function(c){setObjectOperations({object:c,fields:s.customer});var l=c.get('contactPersons');l&&(l=l.filter(function(d){if(d)return d}).map(function(d){return new a(d)})),this.id=c.get('objectId'),this.entity=c,this.contactPersons=l,this.save=function(d){if(arguments.length)return this.entity.save(d);var u=this;return this.entity.save().then(function(m){return u.id||(u.id=m.id),m})},this.destroy=function(){for(var d in this)'entity'!=d&&this.hasOwnProperty(d)&&delete this[d];return this.entity.destroy()}}}]);'use strict',invoicesUnlimited.factory('estimateService',['$q','estimateFactory','itemService','currencyFilter','currencyFactory',function(e,a,s,o,r){function c(y,f){return f.items=[],y.forEach(function(b){var v={title:b.selectedItem.entity.title,rate:b.selectedItem.entity.rate,expenseId:b.selectedItem.entity.expanseId};b.selectedItem.tax&&(v.tax=b.selectedItem.tax),f.items.push(v)}),s.createItems(f).then(function(b){for(var v=0;v<y.length;++v)y[v].selectedItem=b[v];return y})}function l(y,f){var b=new f.objectType;b.setACL(f.acl),b.set('userID',f.user),b.set('organization',f.organization),b.set('item',y.selectedItem.entity),b.set('quantity',+y.quantity),b.set('amount',+y.amount);var v=+y.discount;return 0==v?b.unset('discount'):b.set('discount',v),y.selectedTax&&b.set('tax',Parse.Object.extend('Tax').createWithoutData(y.selectedTax.id)),b}function d(y,f,b){return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:f}}).then(function(v){v.replace('&lt;','<'),v.replace('&gt;','>');var T='Connect.open("GET", "uppage.xml"',C='Connect.open("GET", "'+y+'"';return C=C.replace('http:','https:'),v=v.replace(T,C),T='background: url(icn-card.png) no-repeat',C='background: url('+b+') no-repeat',C=C.replace('http:','https:'),v=v.replace(T,C),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:v}}).then(function(O){return O})})}function u(y,f){return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:f}}).then(function(v){var C='Connect.open("GET", "'+y+'"';return C=C.replace('http:','https:'),v=v.replace('Connect.open("GET", "uppage.xml"',C),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:v}}).then(function(O){return O},function(O){console.log(O)})})}function m(y,f,b,v){return $.ajax({type:'GET',url:'proxy.php',dataType:'xml',data:{address:y}}).then(function(T){var C=new X2JS,O=C.xml2json(T),N=O.items.label,I='$',F=1;N['invoice-title']='Estimate',N.billType='estimate',N['list-header-total']='Total',N['longmsg-title']='Notes',N['ordernotes-title']='Terms & Conditions',N.refundedText='Estimated Total',N.headerTitle='',N.copyright='',N.disablePay='true',N['due-text']='',N['due-price']='',N['received-text']='',N['received-price']='',N.thanksmsg='',N['website-link']='',N['website-name']='',N['tip-text']=N['tip-price']='',N.ordernotes=b.get('termsConditions'),N.longmsg=b.get('notes'),N['body-date']=formatDate(b.get('estimateDate'),'MMM D, YYYY'),N['past-due']=N['body-date'];var E=b.get('referenceNumber');N.purchaseOrderNumber=E?'Ref.# '+E:'',N.refid=b.get('estimateNumber');var A=O.items.customFields;A.customField=[];var P=b.get('salesPerson');P&&A.customField.push({name:'Sales Person',value:P});var z=b.get('customFields');if(z)for(var D=0;D<z.length;++D){var q=Object.keys(z[D])[0],L=z[D][q];A.customField.push({name:q,value:L})}A.customField.length||(A.customField=void 0);var R=O.items.attachments,w=b.get('estimateFiles');if(w){R.attachment=[];for(var D=0;D<w.length;++D)R.attachment.push(w[D].url())}else R.attachment=void 0;var S=f.get('colorTheme');S?'appBlueColor'==S?N['app-color']='#327DF5':'appSeagreenColor'==S?N['app-color']='#23AA92':'appGreenColor'==S?N['app-color']='#0EA81C':'appYellowColor'==S?N['app-color']='#EDE005':'appBrownColor'==S?N['app-color']='#E87605':'appRedColor'==S?N['app-color']='#E80000':'appPinkColor'==S?N['app-color']='#E657A3':'appPurpleColor'==S&&(N['app-color']='#7F5CBF'):N['app-color']='#327DF5',N.mailtotxt=f.get('email');var k=b.get('organization');if(k){N.mailto='mailto:'+k.get('email'),N.title='Estimate from '+k.get('name');var Q=k.get('logo');Q&&(N.logo=k.get('logo').url())}var W=f.get('businessInfo');if(W){var U=[W.get('streetName'),W.get('city'),W.get('state'),W.get('zipCode')];k.get('displayCountry')&&U.push(f.get('country')),N.addres1=U.join(', '),N['business-name']=W.get('businessName'),N.nr=W.get('phoneNumber')}var M=b.get('customer');if(M){var H=M.get('email');N.clientmail=H,N.clientmailto='mailto:'+H,N.clientname=M.get('salutation')?M.get('salutation')+' '+M.get('displayName'):M.get('displayName'),N.clientnr=M.get('phone'),M.get('currency')&&(N['body-currency']=M.get('currency').split(' ')[0]);var G=v.filter(function(fe){return fe.entity.title==M.get('currency')})[0];G&&(I=G.entity.currencySymbol,F=G.entity.exchangeRate,!F&&(F=1))}var B=b.get('discountType');N.discountPlace={text:2==B?'before':3==B?'after':''};var Y=O.items,_=O.items.label.taxes,X=0,J=0,Z=b.get('estimateItems');if(Z){Y.itemRow=[],_.tax=[];for(var D=0;D<Z.length;++D){var K=Z[D].get('item').get('title'),V=Z[D].get('quantity'),ee=Z[D].get('amount'),te=Z[D].get('discount')||0;J+=ee*(0.01*(100-te));var ie={name:K,qty:V,price:o(ee*F,I,2)};1==B&&(ie.discount=te?te:0),Y.itemRow.push(ie);var ne=Z[D].get('tax');if(ne){var ae=ne.get('title')+' ('+ne.get('value')+'%)',se=b.get('discounts')||0,oe=0;oe=2==B?g(ee*(0.01*(100-se)),ne):g(ee,ne),X+=oe;var re=o(oe*F,I,2);_.tax.push({name:ae,value:re})}}_.tax.length||(_.tax=void 0)}else Y.itemRow=void 0,_.tax=void 0;var se=b.get('discounts')||0,le=b.get('shippingCharges')||0,de=b.get('adjustments')||0,ue=J+X,me=0.01*(100-se);O.items.shippingChargesPrice='',O.items.shippingCharges='',O.items.adjustmentsPrice='',O.items.adjustments='',2==B?ue=J*me+X:3==B&&(ue=(J+X)*me),se?(N.discountNameBottom={text:'Discount '+se+'%:'},N.discountPriceBottom={text:se+'%'},se=Math.abs(ue-J-X),N.discountAmount={text:o(se*F,I,2)}):N.discountAmount=N.discountNameBottom=N.discountPriceBottom='',N.subtotalprice=o(J*F,I,2);var pe=ue+le+de;N['total-price3']=N['body-price']=o(pe*F,I,2);var ge=0,he=0;N.paymentMadePrice=o(ge*F,I,2),N.creditsAppliedPrice=o(he*F,I,2);return N.refundtotal=o((pe-ge-he)*F,I,2),T=C.json2xml_str(O),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:T}}).then(function(fe){return fe})})}function g(y,f){var b=f.get('type'),v=f.get('value'),T=f.get('compound'),C=0;return 1==b?C=0.01*(y*v):2==b&&(C=0.01*(y*v),T&&(C=0.01*(C*T))),C}function h(y){var f=y.get('organizations');return f?f[0]:void 0}return{test:function(){console.log('working')},checkEstimateNumAvailable:function(y){var f=Parse.Object.extend('Estimates'),b=new Parse.Query(f);return b.equalTo('organization',y.organization),b.equalTo('estimateNumber',y.estimateNumber),b.select('estimateNumber'),b.first().then(function(v){return!v})},getEstimateDetails:function(y){var f=Parse.Object.extend('Estimates'),b=new Parse.Query(f);return b.include('comments'),b.include('customer.contactPersons'),b.include('customer'),b.get(y).then(function(v){var T=new a(v,{operation:'details'});return T})},getEstimate:function(y){var f=Parse.Object.extend('Estimates'),b=new Parse.Query(f);return b.include('estimateItems'),b.get(y).then(function(v){var T=new a(v,{operation:'getEstimate'});return T})},listEstimates:function(y){var f=h(y);if(f){var b=Parse.Object.extend('Customer'),v=new Parse.Query(b);v.notEqualTo('isDeleted',1);var T=Parse.Object.extend('Estimates'),C=new Parse.Query(T);return C.equalTo('organization',f),C.include('customer'),C.find().then(function(O){var N=[];return O.forEach(function(I){N.push(new a(I,{operation:'listEstimates'}))}),N})}},getPreferences:function(y){var f=h(y);if(!f){var b='user: '+y.id+' has no Organization assigned.';return Parse.Promise.error(b)}var v={},T=Parse.Object.extend('Preferencies'),C=new Parse.Query(T);return C.equalTo('organization',f),C.first().then(function(O){v.discountType=O.get('invoiceDiscount'),v.numAutoGen=O.get('estimateAg'),v.shipCharges=O.get('invoiceShippingCharges'),v.adjustments=O.get('invoiceAdjustments'),v.salesPerson=O.get('invoiceSalesPerson'),v.thanksNote=O.get('invoiceThanksNotes'),v.notes=O.get('estimateNotes'),v.terms=O.get('estimateTerms')}).then(function(){var O=Parse.Object.extend('Organization');return C=new Parse.Query(O),C.select('dateFormat','estimateFields','estimateNumber'),C.get(f.id).then(function(N){v.dateFormat=N.get('dateFormat'),v.customFields=N.get('estimateFields'),v.estimateNumber=N.get('estimateNumber')}).then(function(){return v})})},setPreferences:function(y,f){var b=h(y);if(!b){var v='user: '+y.id+' has no Organization assigned.';return Parse.Promise.error(v)}var T=[];b.set('estimateFields',f.customFields),f.estimateAg&&b.set('estimateNumber',f.estimateNumber),T.push(b.save());var C=Parse.Object.extend('Preferencies'),O=new Parse.Query(C);return O.equalTo('organization',b),O.first().then(function(N){return N.set('estimateAg',f.estimateAg),N.set('estimateNotes',f.notes),N.set('estimateTerms',f.terms),T.push(N.save()),Parse.Promise.when(T)})},createNewEstimate:function(y,f,b,v){var T=[],C=new Parse.ACL;C.setPublicReadAccess(!0),C.setPublicWriteAccess(!0);var O,N;if(v.length){N=[];var I=[];v.forEach(function(P){if(P.exist)delete P.exist,delete P.fileName,N.push(P);else{var z=new Parse.File(P.name,P);I.push(z.save())}}),O=e.all(I).then(function(P){return P&&(N=N.concat(P)),N})}else O=Parse.Promise.as(void 0);var F=[],E=[];f.forEach(function(P){P.selectedItem.create?F.push(P):E.push(P)});var A={user:y.userID,organization:y.organization,acl:C};return c(F,A).then(function(P){return f=E.concat(P),O}).then(function(P){var z=Parse.Object.extend('EstimateItem');return f.forEach(function(D){var q=new z;q.setACL(C),q.set('userID',y.userID),q.set('organization',y.organization),q.set('item',D.selectedItem.entity),q.set('quantity',+D.quantity),q.set('amount',+D.amount);var L=+D.discount;0!=L&&q.set('discount',L),D.selectedTax&&q.set('tax',Parse.Object.extend('Tax').createWithoutData(D.selectedTax.id)),T.push(q)}),Parse.Object.saveAll(T).then(function(D){var q=Parse.Object.extend('Estimates'),L=new q;return L.setACL(C),L.set('estimateFiles',P),y.estimateItems=D,L.save(y).then(function(R){return R.get('organization').fetch().then(function(w){var S=w.get('estimateNumber'),k=S.split('-'),Q=+k[1]+1,W=k[0]+'-'+formatInvoiceNumber(Q,k[1].length);return w.set('estimateNumber',W),w.save()}).then(function(){return console.log('estimate created successfully'),R})})})})},updateEstimate:function(y,f,b,v,T,C){var O=[],N=[],I=[],F=[],E={},A=Parse.Object.extend('EstimateItem'),P=new Parse.ACL;P.setPublicReadAccess(!0),P.setPublicWriteAccess(!0),f.forEach(function(R){R.selectedItem.create?I.push(R):R.id?E[R.id]=R:F.push(R)});var z={acl:P,user:v,organization:v.get('organizations')[0],objectType:A},D,q;if(C.length){q=[];var L=[];C.forEach(function(R){if(R.exist)delete R.exist,delete R.fileName,q.push(R);else{var w=new Parse.File(R.name,R);L.push(w.save())}}),D=e.all(L)}else D=Parse.Promise.as(void 0);return D.then(function(R){return R&&(q=q.concat(R)),y.entity.set('estimateFiles',q),c(I,z)}).then(function(R){R.forEach(function(W){W.id?E[W.id]=W:F.push(W)}),F=F.map(function(W){return l(W,z)});for(var k,w=y.estimateItems,S=0;S<w.length;++S)if(k=E[w[S].entity.id],!k)N.push(w[S].entity);else{w[S].entity.set('item',k.selectedItem.entity),w[S].entity.set('quantity',+k.quantity),w[S].entity.set('amount',+k.amount);var Q=+k.discount;0==Q?w[S].entity.unset('discount'):w[S].entity.set('discount',Q),k.selectedTax?w[S].entity.set('tax',Parse.Object.extend('Tax').createWithoutData(k.selectedTax.id)):w[S].entity.unset('tax'),O.push(w[S].entity)}return O=O.concat(F),Parse.Object.destroyAll(N)}).then(function(){return Parse.Object.saveAll(O)}).then(function(R){return y.entity.set('estimateItems',R),y.entity.save()}).then(function(R){return R})},createEstimateReceipt:function(y){var f=Parse.Object.extend('Estimates'),b=new Parse.Query(f);b.include('estimateItems','customer','estimateItems.item','estimateItems.tax','organization','userID','userID.defaultTemplate','userID.businessInfo');var v={};return b.get(y).then(function(T){v.estimateObj=T;var C=T.get('userID');return r.loadAllOfCurrentUser().then(function(O){var N=C.get('defaultTemplate');if(!N){var I=Parse.Object.extend('InvoiceTemplate'),F=new Parse.Query(I);return F.equalTo('name','Template 1'),F.first().then(function(A){var P=A.get('templateData');return v.htmlFile=A.get('templateHTML'),v.emailHtmlFile=A.get('emailHTML'),v.cardUrl=A.get('linkedFile').url(),m(P.url(),C,T,O)})}var E=N.get('templateData');return v.htmlFile=N.get('templateHTML'),v.emailHtmlFile=N.get('emailHTML'),v.cardUrl=N.get('linkedFile').url(),m(E.url(),C,T,O)})}).then(function(T){var C=new Parse.File('test1.xml',{base64:T},'text/xml');return C.save()}).then(function(T){return v.xml=T,u(T.url(),v.emailHtmlFile.url(),v.cardUrl)}).then(function(T){var C=new Parse.File('test2.html',{base64:T},'text/html');return C.save()}).then(function(T){return v.emailHtml=T,d(v.xml.url(),v.htmlFile.url(),v.cardUrl)}).then(function(T){var C=new Parse.File('test2.html',{base64:T},'text/html');return C.save()}).then(function(T){return v.estimateObj.set('estimateLabels',v.xml),v.estimateObj.set('estimateReceipt',T),v.estimateObj.set('emailReceipt',v.emailHtml),v.estimateObj.save()}).then(function(T){return T})},sendEstimetText:function(y){var f=new a(y,{operation:'sendReceipt'}),b=f.entity.get('customer');if(b=b.get('mobile'),b)var v=b,T=f.customer.displayName,C=o(f.entity.totalAmount,'$',2),O=f.organization.name,N=f.entity.estimateReceipt.url(),I=T+', '+O+' has sent you an estimate of '+C+'. ';return Parse.Cloud.run('createShortUrl',{link:N}).then(function(F){return Parse.Cloud.run('sendSms',{to:v,body:I+F.data.data.url}).then(function(E){return console.log(E),y},function(E){return console.error(E),y})})},sendEstimetTextToNumber:function(y,f){var b=new a(y,{operation:'sendReceipt'}),T=b.customer.displayName,C=o(b.entity.totalAmount,'$',2),O=b.organization.name,N=b.entity.estimateReceipt.url();return Parse.Cloud.run('createShortUrl',{link:N}).then(function(F){return Parse.Cloud.run('sendSms',{to:f,body:T+', '+O+' has sent you an estimate of '+C+'. '+F.data.data.url}).then(function(E){return console.log(E),y},function(E){return console.error(E),y})})},sendEstimateReceiptToEmail:function(y,f){var b=new a(y,{operation:'sendReceipt'}),v=b.entity.emailReceipt.url();return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:v}}).then(function(T){var O=b.organization.name;T=T.replace('<!DOCTYPE html>',''),T=T.trim();var F=1,E=document.createElement('iframe');return document.body.appendChild(E),E.src='about:blank',E.style.display='none',E.setAttribute('id','myFrameEstimate'),E.contentWindow.document.open(),E.contentWindow.document.write(T),E.contentWindow.document.close(),E.onload=function(){return F=0,Parse.Cloud.run('sendMailgunHtml',{toEmail:f,fromEmail:'no-reply@invoicesunlimited.com',subject:'Estimate From '+O,html:'<html>'+$('#myFrameEstimate').contents().find('html').html()+'</html>'}).then(function(A){return console.log(A),y})},y})},sendEstimateReceipt:function(y){var f=new a(y,{operation:'sendReceipt'}),b=f.entity.estimateReceipt.url();return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:b}}).then(function(v){if(f.entity.customerEmails)var T=f.entity.customerEmails[0],C=f.organization.name,O='Estimate From '+C;v=v.replace('<!DOCTYPE html>',''),v=v.trim();var I=1,F=document.createElement('iframe');return document.body.appendChild(F),F.style.display='none',F.setAttribute('id','myFrame'),F.contentWindow.document.open(),F.contentWindow.document.write(v),F.contentWindow.document.close(),F.onload=function(){return I=0,Parse.Cloud.run('sendMailgunHtml',{toEmail:T,fromEmail:'no-reply@invoicesunlimited.com',subject:O,html:'<html>'+$('#myFrame').contents().find('html').html()+'</html>'}).then(function(E){return console.log(E),y})},y})}}}]);'use strict',invoicesUnlimited.factory('expenseCategoryService',['expenseCategoryFactory',function(e){return{createNewCategory:function(a){var o=new Parse.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0);var r=Parse.Object.extend('Category'),c=new r;return c.setACL(o),c.save(a).then(function(l){return new e(l)})},saveEditedCategory:function(a){return a.save().then(function(s){return new e(s)})}}}]);'use strict',invoicesUnlimited.factory('expenseService',['$q','expenseFactory',function(e,a){function s(o){var r=o.get('organizations');return r?r[0]:void 0}return{getExpensesForSummary:function(o){var r=Parse.Object.extend('Expanses'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.include('customer'),c.find().then(function(l){var d=[];return l.forEach(function(u){d.push(new a(u,{operation:'summary'}))}),d})},getExpenseDetails:function(o){var r=Parse.Object.extend('Expanses'),c=new Parse.Query(r);return c.include('customer'),c.get(o).then(function(l){var d=new a(l,{operation:'details'});return d})},getExpense:function(o){var r=Parse.Object.extend('Expanses'),c=new Parse.Query(r);return c.include('customer'),c.get(o).then(function(l){var d=new a(l,{operation:'getExpense'});return d})},getCustomerExpenses:function(o){var r=new Parse.Query('Expanses');return r.equalTo('organization',o.organization),r.equalTo('customer',o.customer),r.find().then(function(c){var l=[];return c.forEach(function(d){l.push(new a(d,{operation:'getCustomerExpenses'}))}),l})},listExpenses:function(o){var r=s(o);if(r){var c=Parse.Object.extend('Expanses'),l=new Parse.Query(c);return l.equalTo('organization',r),l.include('customer'),l.find().then(function(d){var u=[];return d.forEach(function(m){u.push(new a(m,{operation:'listExpenses'}))}),u})}},createNewExpense:function(o,r,c){var l=new Parse.ACL;l.setPublicReadAccess(!0),l.setPublicWriteAccess(!0);var d,u;if(c.length){var m=[];u=[],c.forEach(function(g){if(g.exist)delete g.exist,delete g.fileName,delete g.fileName1,u.push(g);else{var h=new Parse.File(g.name,g);m.push(h.save())}}),d=e.all(m).then(function(g){return g&&(u=u.concat(g)),u})}else d=Parse.Promise.as(void 0);return o.tax&&(o.tax=Parse.Object.extend('Tax').createWithoutData(o.tax.id)),d.then(function(g){var h=Parse.Object.extend('Expanses'),y=new h;return y.setACL(l),y.set('expenseFiles',g),y.save(o)})},updateExpense:function(o,r){o.tax?o.tax=Parse.Object.extend('Tax').createWithoutData(o.tax.id):o.unset('tax');var c,l=[];if(r.length){l=[];var d=[];r.forEach(function(u){if(u.exist)delete u.exist,delete u.fileName,l.push(u);else{var m=new Parse.File(u.name,u);d.push(m.save())}}),c=e.all(d)}else c=Parse.Promise.as(void 0);return c.then(function(u){return u&&(l=l.concat(u)),o.set('expenseFiles',l),o.save()})}}}]);'use strict',invoicesUnlimited.factory('invoiceService',['$q','invoiceFactory','itemService','currencyFilter','userFactory','currencyFactory',function(e,a,s,o,r,c){function l(T,C){return C.items=[],T.forEach(function(O){var N={title:O.selectedItem.entity.title,rate:O.selectedItem.entity.rate,expenseId:O.selectedItem.entity.expanseId};O.selectedItem.tax&&(N.tax=O.selectedItem.tax),C.items.push(N)}),s.createItems(C).then(function(O){for(var N=0;N<T.length;++N)T[N].selectedItem=O[N];return T})}function d(T,C){var O=new C.objectType;O.setACL(C.acl),O.set('userID',C.user),O.set('organization',C.organization),O.set('item',T.selectedItem.entity),O.set('quantity',+T.quantity),O.set('amount',+T.amount);var N=+T.discount;return 0==N?O.unset('discount'):O.set('discount',N),T.selectedTax&&O.set('tax',Parse.Object.extend('Tax').createWithoutData(T.selectedTax.id)),O}function u(T){var C=b(T);if(!C){var O='user: '+T.id+' has no Organization assigned.';return Parse.Promise.error(O)}var N={},I=Parse.Object.extend('Preferencies'),F=new Parse.Query(I);return F.equalTo('organization',C),F.first().then(function(E){N.discountType=E.get('invoiceDiscount'),N.numAutoGen=E.get('invoiceAg'),N.shipCharges=E.get('invoiceShippingCharges'),N.adjustments=E.get('invoiceAdjustments'),N.salesPerson=E.get('invoiceSalesPerson'),N.thanksNote=E.get('invoiceThanksNotes'),N.notes=E.get('invoiceNotes'),N.terms=E.get('invoiceTerms'),N.itemDescOnInvoice=E.get('itemDescOnInvoice')}).then(function(){var E=Parse.Object.extend('Organization');return F=new Parse.Query(E),F.select('dateFormat','invoiceFields','invoiceNumber','displayCountry'),F.get(C.id).then(function(A){N.dateFormat=A.get('dateFormat'),N.customFields=A.get('invoiceFields'),N.invoiceNumber=A.get('invoiceNumber'),N.displayCountry=A.get('displayCountry')}).then(function(){return N})})}function m(T,C,O){return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:C}}).then(function(N){var I='Connect.open("GET", "uppage.xml"',F='Connect.open("GET", "'+T+'"';return F=F.replace('http:','https:'),N=N.replace(I,F),I='background: url(icn-card.png) no-repeat',F='background: url('+O+') no-repeat',F=F.replace('http:','https:'),N=N.replace(I,F),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:N}}).then(function(E){return E},function(E){console.log(E)})})}function g(T,C){return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:C}}).then(function(N){var F='Connect.open("GET", "'+T+'"';return F=F.replace('http:','https:'),N=N.replace('Connect.open("GET", "uppage.xml"',F),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:N}}).then(function(E){return E},function(E){console.log(E)})})}function h(T,C,O,N,I,F,E){return $.ajax({type:'GET',url:'proxy.php',dataType:'xml',data:{address:T}}).then(function(A){var P=new X2JS,z=P.xml2json(A),D=z.items.label,q='$',L=1;D.invoiceId=N,D['invoice-title']='Invoice',D.billType='invoice',D['list-header-total']='Total',D.headerTitle='Payment Due',D['longmsg-title']='Notes',D['ordernotes-title']='Terms & Conditions',D.copyright='',D.disablePay='',D['due-text']='',D['due-price']='',D['received-text']='',D['received-price']='',D.thanksmsg='',D['website-link']='',D['website-name']='',D.ordernotes=O.get('terms'),D.longmsg=O.get('notes'),D['body-date']=formatDate(O.get('invoiceDate'),'MMM D, YYYY'),D['past-due']=formatDate(O.get('dueDate'),'MMM D, YYYY'),D.purchaseOrderNumber=O.get('poNumber')?'Order # '+O.get('poNumber'):'',D.refid=O.get('invoiceNumber');var R=z.items.customFields;R.customField=[];var w=O.get('salesPerson');w&&R.customField.push({name:'Sales Person',value:w});var S=O.get('customFields');if(S)for(var k=0;k<S.length;++k){var Q=Object.keys(S[k])[0],W=S[k][Q];R.customField.push({name:Q,value:W})}R.customField.length||(R.customField=void 0);var U=z.items.attachments,M=O.get('invoiceFiles');if(M){U.attachment=[];for(var k=0;k<M.length;++k)U.attachment.push(M[k].url())}else U.attachment=void 0;var H=C.get('colorTheme');H?'appBlueColor'==H?D['app-color']='#327DF5':'appSeagreenColor'==H?D['app-color']='#23AA92':'appGreenColor'==H?D['app-color']='#0EA81C':'appYellowColor'==H?D['app-color']='#EDE005':'appBrownColor'==H?D['app-color']='#E87605':'appRedColor'==H?D['app-color']='#E80000':'appPinkColor'==H?D['app-color']='#E657A3':'appPurpleColor'==H&&(D['app-color']='#7F5CBF'):D['app-color']='#327DF5',D.mailtotxt=C.get('email'),v&&(D.logo=v);var G=O.get('organization');if(G){D.mailto='mailto:'+G.get('email'),D.title='Invoice from '+G.get('name');var B=G.get('logo');B&&(D.logo=G.get('logo').url())}var Y=C.get('businessInfo');if(Y){var _=[Y.get('streetName'),Y.get('city'),Y.get('state'),Y.get('zipCode')];I.displayCountry&&_.push(C.get('country'));var X=Y.get('streetName')+'<br>'+Y.get('city')+', '+Y.get('state')+' '+Y.get('zipCode');I.displayCountry&&(X=X+'<br>'+C.get('country')),D.addres1=X,D['business-name']=Y.get('businessName'),D.nr=Y.get('phoneNumber')}var J=O.get('customer');if(J){var Z=J.get('email');D.clientmail=Z,D.clientmailto='mailto:'+Z,D.clientname=J.get('salutation')?J.get('salutation')+' '+J.get('displayName'):J.get('displayName'),D.clientnr=J.get('phone'),J.get('currency')&&(D['body-currency']=J.get('currency').split(' ')[0]);var K=E.filter(function(Le){return Le.entity.title==J.get('currency')})[0];K&&(K.entity.currencySymbol&&(q=K.entity.currencySymbol),K.entity.exchangeRate&&(L=K.entity.exchangeRate))}var V=O.get('discountType');D.discountPlace={text:2==V?'before':3==V?'after':''};var ee=z.items,te=z.items.label.taxes,ie=0,ne=0,ae=O.get('invoiceItems');if(ae){ee.itemRow=[],te.tax=[];for(var se=[],k=0;k<ae.length;++k){var oe=ae[k].get('item').get('title'),re=ae[k].get('quantity'),ce=ae[k].get('amount'),le=ae[k].get('discount')||0,de=ae[k].get('item').get('itemDescription');ne+=ce*(0.01*(100-le));var ue={name:oe,qty:re,price:o(ce*L,q,2)};de&&1==I.itemDescOnInvoice&&(ue.desc=de),1==V&&(ue.discount=le?le:0),ee.itemRow.push(ue);var me=ae[k].get('tax');if(me){var pe=me.get('title')+' ('+me.get('value')+'%)',ge=0,he=O.get('discounts')||0;ge=2==V?f(ce*(0.01*(100-he)),me):f(ce*(0.01*(100-le)),me),ie+=ge;for(var ye={name:pe,value:ge},fe=!1,xe=0;xe<se.length;++xe)if(se[xe].name==pe){fe=!0,se[xe].value+=ge;break}fe||se.push(ye)}}se.forEach(function(Le){Le.value=o(Le.value*L,q,2),te.tax.push(Le)}),te.tax.length||(te.tax=void 0)}else ee.itemRow=void 0,te.tax=void 0;var be=O.get('lateFee'),ve=O.get('status'),Te=0;if(be){D['tip-text']='Late Fee';var Ce=be.get('price'),je=be.get('type');'$'==je?(Te=Ce,D['tip-price']=o(Ce*L,q,2)):'%'==je&&(Te=0.01*(ne*Ce),D['tip-price']=o(Te*L,q,2),D['tip-text']='Late Fee('+Ce+je+')')}else D['tip-text']=D['tip-price']='';var he=O.get('discounts')||0,Oe=O.get('shippingCharges')||0,Ne=O.get('adjustments'),Ie=ne+ie,Fe=0.01*(100-he);I.shipCharges?(z.items.shippingChargesPrice=o(Oe*L,q,2),z.items.shippingCharges='SHIPPING CHARGES'):(z.items.shippingChargesPrice='',z.items.shippingCharges=''),Oe=O.get('shippingCharges')||0,Ne?(z.items.adjustmentsPrice=o(Ne*L,q,2),z.items.adjustments='ADJUSTMENTS'):(z.items.adjustmentsPrice='',z.items.adjustments=''),Ne=O.get('adjustments')||0,2==V?Ie=ne*Fe+ie:3==V&&(Ie=(ne+ie)*Fe),void 0==he?D.discountAmount=D.discountNameBottom=D.discountPriceBottom='':(D.discountNameBottom={text:'Discount ('+he+'%)'},D.discountPriceBottom={text:he+'%'},he=Math.abs(Ie-ne-ie),D.discountAmount={text:o(-1*he*L,q,2)}),D.subtotalprice=o(ne*L,q,2);var Ee=Ie+Oe+Ne+Te;D['total-price4']=o(Ee*L,q,2);var Ae=Ie+Oe+Ne;D['total-price3']=D['body-price']=o(Ae*L,q,2);var Pe=O.get('paymentMade')||0,ze=O.get('creditApplied')||0;D.paymentMadePrice=o(Pe*L,q,2),D.creditsAppliedPrice=o(ze*L,q,2),Ee=parseFloat(Ee.toFixed(2));var De=Ee-Pe-ze;D['due-price']=o(De*L,q,2),Ae=parseFloat(Ae.toFixed(2));var qe=Ae-Pe-ze;return D.refundtotal=o(qe*L,q,2),0<qe?(D.headerTitle='Payment Due',D.disablePay='false'):(D.headerTitle='Paid Date',D.disablePay='true'),A=P.json2xml_str(z),y(A,O).then(function(Le){return Le.save().then(function(Re){return D.pdf=Re.url(),A=P.json2xml_str(z),$.ajax({type:'POST',url:'./assets/php/convert_base64.php',data:{str:A}}).then(function(we){return{newXml:we,pdf:Re}},function(we){console.log(we)})},function(Re){debugger;console.error(Re)})},function(Le){debugger;console.error(Le)})})}function y(T){T=$.parseXML(T);var O=$(T).find('itemRow'),N=$(T).find('modsRow'),I=$(T).find('attachment'),F=$(T).find('customField'),E=$(T).find('tax'),A=$('<td></td>');$(T).find('billType').text().includes('estimate')&&($('.footer .info').hide(),$('.payment-due').hide()),$('#invoice-items-header').html(''),/^[\s]*$/.test(O.first().find('discount').text())?$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),$('.invoice-items').remove(),O.each(function(){var L='<span class=\'fc0\'>'+$(this).children('name').text()+'</span><br>'+$(this).children('desc').text()+'';if(!/^[\s]*$/.test(O.first().find('discount').text())){var R=$('<tr class=\'invoice-items\'></tr>'),w=$('<td class=\'ff1 fc1 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+L+'</td>'),S=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('qty').text()+'</td>'),k=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('discount').text()+'</td>'),Q=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');R.append(w).append(S).append(k).append(Q),$('#invoice-items-header').after($(R))}else{var R=$('<tr class=\'invoice-items\'></tr>'),w=$('<td class=\'ff1 fc1 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+L+'</td>'),S=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'2\'>'+$(this).children('qty').text()+'</td>'),Q=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');R.append(w).append(S).append(Q),$('#invoice-items-header').after($(R))}}),$('.invoice-taxes').remove(),E.each(function(){var q=$('<tr class=\'invoice-taxes\'></tr>'),L=$('<td colspan=\'3\' class=\'\'></td>'),R=$('<td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).children('name').text()+'</td>'),w=$('<td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).children('value').text()+'</td>');q.append(L).append(R).append(w),$('#invoice-subtotal').after($(q))});var P=$('<tr class="salestax"></tr>');$('tr.adjustments').after(P),F.each(function(){var q=$('.customFields');q.append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children('name').text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children('value').text()+'</p></div>'))}),I.each(function(){var q=$(this).text();q=q.substring(q.indexOf('_')+1,q.length),q=q.replace(/%20/g,' '),$('.attach').append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+'\'>'+q+'</a><br><br>')}),$('table tbody tr').each(function(){0==$(this).children().text().length&&$(this).addClass('hideOnMob')});var z=$(T).find('invoiceId').text();$('#pay-link').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+z),$('#pay-link-2').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+z);var D=$(T).find('items');return console.log(D),D.each(function(){var q=new Date(Date.parse($(this).find('past-due').text())),L=new Date(Date.now());q=new Date(q.setHours(0,0,0,0)),L=new Date(q.setHours(0,0,0,0)),q.getTime()>=L.getTime()||'Invalid Date'===q.toString()?($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('green-status')):($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('red-status'));var R=$(this).find('headerTitle').text();$('.payment-due p:first').append(R);var w=$(this).find('disablePay').text();'true'===w&&($('.btn-border-pay').addClass('disable'),$('.info.cl').addClass('disable'),$('.payment-due').removeClass('red-status'),$('.payment-due').addClass('green-status'));var k=$(this).find('discountAmount').text(),Q=$('<tr class="discount"></tr>');Q.append($('<td class="discountNm" colspan="3"></td>').html('Discount')),Q.append($('<td class="discountPr"></td>').html(k)),'after'==$(this).find('discountPlace text').text()?$('.salestax:last').after(Q):'before'==$(this).find('discountPlace text').text()&&$('.salestax:first').before(Q);var W=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountNameBottom').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountAmount').text()+'</td></tr>');if('after'==$(this).find('discountPlace text').text()?$('.invoice-taxes:last').after($(W)):'before'==$(this).find('discountPlace text').text()&&$('#invoice-subtotal').after($(W)),0<$(this).find('adjustments').text().length){var W=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustments').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustmentsPrice').text()+'</td></tr>');$('#invoice-subtotal').after($(W))}0<$(this).find('shippingCharges').text().length&&(W=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingCharges').text()+'</td><td class=\'ff1 fc1 \' style=\' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingChargesPrice').text()+'</td></tr>'),$('#invoice-subtotal').after($(W)));var R=$(this).find('headerTitle').text(),U=$(this).find('past-due').text();R?$('#pdf-title').text(R+'   '+U):($('#pdf-title').text(''),$('.top-bar').css('height','0mm'),$('.top-bar').css('border-bottom','0mm'));var M=$(this).find('ordernotes-title').text(),H=$(this).find('ordernotes').text();H?($('#pdf-terms-title').text(M),$('#pdf-terms').text(H)):($('#pdf-terms-title').text(''),$('#pdf-terms').text(''),$('#pdf-terms-title').hide(),$('#pdf-terms').hide()),$('#pdf-business-name').text(r.entity[0].get('company')),$('#pdf-invoice-title').text($(this).find('invoice-title').text()),$('#pdf-invoice-number').text($(this).find('refid').text()),$('#pdf-order-number').text('   '+$(this).find('purchaseOrderNumber').text()),$('#pdf-amount-received').text($(this).find('body-price').text()),$('#pdf-date').text($(this).find('body-date').text()),$('#pdf-subtotal').text($(this).find('subtotalprice').text()),$('#pdf-payment-made').text($(this).find('paymentMadePrice').text()),$('#pdf-total').text($(this).find('total-price3').text()),$('#pdf-total-top').text($(this).find('total-price3').text()),$('#pdf-credit-applied').text($(this).find('creditsAppliedPrice').text()),$('#pdf-amount-due').text($(this).find('refundtotal').text()),$('#pdf-payment-name').text($(this).find('title').text()),$('#pdf-currency').text($(this).find('body-currency').text()),$('#pdf-total-text').text($(this).find('refundedText').text()),$('#pdf-payment-text').text($(this).find('paymentMadeText').text()),$('#pdf-credit-text').text($(this).find('creditsAppliedText').text()),9<$(this).find('total-price3').text().length&&$('.pdf-top-values').css('font-size',24-2*($(this).find('total-price3').text().length-9));var G=$(this).find('addres1').text();$('#pdf-address').html(G);var B=$(this).find('longmsg').text();if(0!=B.length){var Y=$(this).find('longmsg-title').text();$('#pdf-notes-title').html(Y),$('#pdf-notes').html(B)}else $('#pdf-notes-title').html(''),$('#pdf-notes').html(''),$('#pdf-notes-title').hide(),$('#pdf-notes').hide();var _=$(this).find('mailto').text();$('#user-mail').attr('href',_);var X=$(this).find('mailtotxt').text();$('#user-mail').text(X);var J=$(this).find('clientmailto').text();$('#client-mail').attr('href',J);var Z=$(this).find('clientmail').text();$('#client-mail').text(Z);var K=$(this).find('clientname').text();$('#client-name').text(K);var V=$(this).find('nr').text();$('#user-phone').attr('href','tel:'+V),$('#user-phone').text(V)}),$.ajax({method:'POST',type:'POST',url:'generatePDF.php',data:{html:$('.pdf-page').html()}}).then(function(q){var L=new Parse.File('receipt.pdf',{base64:q});return L},function(q){console.error(q);debugger})}function f(T,C){var O=C.get('type'),N=C.get('value'),I=C.get('compound'),F=0;return 1==O?F=0.01*(T*N):2==O&&(F=0.01*(T*N),I&&(F=0.01*(F*I))),F}function b(T){var C=T.get('organizations');return C?C[0]:void 0}return{test:function(){console.log('working')},checkInvoiceNumAvailable:function(T){var C=Parse.Object.extend('Invoices'),O=new Parse.Query(C);return O.equalTo('organization',T.organization),O.equalTo('invoiceNumber',T.invoiceNumber),O.select('invoiceNumber'),O.first().then(function(N){return!N})},addPayments:function(T){var O=[],N=Parse.Object.extend('Payment'),I=new Parse.ACL;I.setPublicReadAccess(!0),I.setPublicWriteAccess(!0);for(var E,F=0;F<T.length;++F)E=new N,E.setACL(I),O.push(E.save(T[F]));return e.all(O)},getInvoicesForSummary:function(T){var C=Parse.Object.extend('Customer'),O=new Parse.Query(C);O.notEqualTo('isDeleted',1);var N=Parse.Object.extend('Invoices'),I=new Parse.Query(N);return I.matchesQuery('customer',O),I.equalTo('organization',T.organization),I.limit(1e3),I.select('invoiceDate','dueDate','status','balanceDue','lateFee','total'),I.find().then(function(F){var E=[];return F.forEach(function(A){E.push(new a(A,{operation:'summary'}))}),E})},getInvoiceDetails:function(T){var C=Parse.Object.extend('Invoices'),O=new Parse.Query(C);return O.include('comments','payment','invoiceInfo','customer','customer.contactPersons','lateFee'),O.get(T).then(function(N){var I=new a(N,{operation:'details'});return I})},getInvoice:function(T){var C=Parse.Object.extend('Invoices'),O=new Parse.Query(C);return O.include('invoiceItems'),O.get(T).then(function(N){var I=new a(N,{operation:'getInvoice'});return I})},copyInInvoiceInfo:function(T){var C=T.get('invoiceInfo');if(!C){console.log('new created');var O=Parse.Object.extend('InvoiceInfo');C=new O}else console.log('used old');C.set('sendNotifications',r.entity[0].get('getInvoiceNotification')),C.set('invoiceDate',T.get('invoiceDate')),C.set('dueDate',T.get('dueDate')),C.set('referenceNumber',T.get('invoiceNumber')),C.set('totalAmount',T.get('balanceDue')+'');var N,I,F=[];return I=e.when(T.get('userID').fetch()).then(function(E){return N=E,C.set('userId',N.id),C.set('email',N.get('email')),C.set('phone',N.get('phonenumber')),N.get('selectedOrganization').fetch()}).then(function(E){return C.set('organizationLogo',E.get('logo')),N.get('businessInfo').fetch()}).then(function(E){C.set('businessName',E.get('businessName'));var A=Parse.Object.extend('Preferencies'),P=new Parse.Query(A);return P.select('invoiceNotes'),P.equalTo('userID',N),P.first()}).then(function(E){C.set('emailReceipt',E.get('invoiceNotes'))}),F.push(I),I=e.when(T.get('customer').fetch()).then(function(E){C.set('clientName',E.get('displayName')),C.set('clientEmail',E.get('email')),C.set('clientPhone',E.get('phone'))}),F.push(I),e.all(F).then(function(){return C.save()}).then(function(E){T.set('invoiceInfo',E);var A=T.get('dueDate'),P=new Date;return A.setHours(0,0,0,0),P.setHours(0,0,0,0),A<P&&T.set('status','Overdue'),T.save().then(function(){return E})})},updateInvoice:function(T,C,O,N,I,F){var E=[],A=[],P=[],z=[],D={},q=Parse.Object.extend('InvoiceItems'),L=new Parse.ACL;L.setPublicReadAccess(!0),L.setPublicWriteAccess(!0),C.forEach(function(Q){Q.selectedItem.create?P.push(Q):Q.id?D[Q.id]=Q:z.push(Q)});var R={acl:L,user:N,organization:N.get('organizations')[0],objectType:q},w,S=[];if(F.length){S=[];var k=[];F.forEach(function(Q){if(Q.exist)delete Q.exist,delete Q.fileName,S.push(Q);else{var W=new Parse.File(Q.fileName,Q);k.push(W.save())}}),w=e.all(k)}else w=Parse.Promise.as(void 0);return w.then(function(Q){return Q&&(S=S.concat(Q)),T.entity.set('invoiceFiles',S),l(P,R)}).then(function(Q){Q.forEach(function(G){G.id?D[G.id]=G:z.push(G)}),z=z.map(function(G){return d(G,R)});for(var M,W=T.invoiceItems,U=0;U<W.length;++U)if(M=D[W[U].entity.id],!M)A.push(W[U].entity);else{W[U].entity.set('item',M.selectedItem.entity),W[U].entity.set('quantity',+M.quantity),W[U].entity.set('amount',+M.amount);var H=+M.discount;0==H?W[U].entity.unset('discount'):W[U].entity.set('discount',H),M.selectedTax?W[U].entity.set('tax',Parse.Object.extend('Tax').createWithoutData(M.selectedTax.id)):W[U].entity.unset('tax'),E.push(W[U].entity)}return E=E.concat(z),Parse.Object.destroyAll(A)}).then(function(){return Parse.Object.saveAll(E)}).then(function(Q){return T.entity.set('invoiceItems',Q),T.entity.save()}).then(function(Q){return Q})},createNewInvoice:function(T,C,O,N){var I=[],F=new Parse.ACL;F.setPublicReadAccess(!0),F.setPublicWriteAccess(!0);var E,A;if(N.length){A=[];var P=[];N.forEach(function(L){if(L.exist)delete L.exist,delete L.fileName,A.push(L);else{var R=new Parse.File(L.fileName,L);P.push(R.save())}}),E=e.all(P).then(function(L){return L&&(A=A.concat(L)),A})}else E=Parse.Promise.as(void 0);var z=[],D=[];C.forEach(function(L){L.selectedItem.create?z.push(L):D.push(L)});var q={user:T.userID,organization:T.organization,acl:F};return l(z,q).then(function(L){return C=D.concat(L),E}).then(function(L){var R=Parse.Object.extend('InvoiceItems');return C.forEach(function(w){var S=new R;S.setACL(F),S.set('userID',T.userID),S.set('organization',T.organization),S.set('item',w.selectedItem.entity),S.set('quantity',+w.quantity),S.set('amount',+w.amount);var k=+w.discount;0!=k&&S.set('discount',k),w.selectedTax&&S.set('tax',Parse.Object.extend('Tax').createWithoutData(w.selectedTax.id)),I.push(S)}),Parse.Object.saveAll(I).then(function(w){var S=Parse.Object.extend('Invoices'),k=new S;return k.setACL(F),k.set('invoiceFiles',L),T.invoiceItems=w,k.save(T).then(function(Q){return Q.get('organization').fetch().then(function(W){var U=W.get('invoiceNumber'),M=U.split('-'),H=+M[1]+1,G=M[0]+'-'+formatInvoiceNumber(H,M[1].length);return W.set('invoiceNumber',G),W.save()}).then(function(){return console.log('invoice created successfully'),Q})})})})},getPreferences:function(T){var C=b(T);if(!C){var O='user: '+T.id+' has no Organization assigned.';return Parse.Promise.error(O)}var N={},I=Parse.Object.extend('Preferencies'),F=new Parse.Query(I);return F.equalTo('organization',C),F.first().then(function(E){N.discountType=E.get('invoiceDiscount'),N.numAutoGen=E.get('invoiceAg'),N.shipCharges=E.get('invoiceShippingCharges'),N.adjustments=E.get('invoiceAdjustments'),N.salesPerson=E.get('invoiceSalesPerson'),N.thanksNote=E.get('invoiceThanksNotes'),N.notes=E.get('invoiceNotes'),N.terms=E.get('invoiceTerms'),N.itemDescOnInvoice=E.get('itemDescOnInvoice')}).then(function(){var E=Parse.Object.extend('Organization');return F=new Parse.Query(E),F.select('dateFormat','invoiceFields','invoiceNumber','displayCountry'),F.get(C.id).then(function(A){N.dateFormat=A.get('dateFormat'),N.customFields=A.get('invoiceFields'),N.invoiceNumber=A.get('invoiceNumber'),N.displayCountry=A.get('displayCountry')}).then(function(){return N})})},setPreferences:function(T,C){var O=b(T);if(!O){var N='user: '+T.id+' has no Organization assigned.';return Parse.Promise.error(N)}var I=[];O.set('invoiceFields',C.customFields),C.invoiceAg&&O.set('invoiceNumber',C.invoiceNumber),I.push(O.save());var F=Parse.Object.extend('Preferencies'),E=new Parse.Query(F);return E.equalTo('organization',O),E.first().then(function(A){return A.set('invoiceAg',C.invoiceAg),A.set('invoiceSalesPerson',C.salesPerson),A.set('invoiceDiscount',C.discountType),A.set('invoiceAdjustments',C.adjustments),A.set('invoiceShippingCharges',C.shipCharges),A.set('invoiceNotes',C.notes),A.set('invoiceTerms',C.terms),A.set('invoiceThanksNotes',C.thanksNote),A.set('itemDescOnInvoice',C.itemDescOnInvoice),I.push(A.save()),Parse.Promise.when(I)})},listInvoices:function(T){var C=b(T);if(C){var O=Parse.Object.extend('Customer'),N=new Parse.Query(O);N.notEqualTo('isDeleted',1);var I=Parse.Object.extend('Invoices'),F=new Parse.Query(I);return F.equalTo('organization',C),F.include('customer'),F.include('lateFee'),F.limit(1e3),F.find().then(function(E){var A=[];return E.forEach(function(P){A.push(new a(P,{operation:'listInvoices'}))}),A})}},createInvoiceReceipt:function(T,C){var O=Parse.Object.extend('Invoices'),N=new Parse.Query(O);N.include('invoiceItems','customer','lateFee','invoiceItems.item','invoiceItems.tax','organization','userID','userID.defaultTemplate','userID.businessInfo');var I={};return N.get(T).then(function(F){I.invoiceObj=F;var E=F.get('userID'),A=F.get('organization'),P=A.get('logo');return v=P?P._url:void 0,u(E).then(function(z){return c.loadAllOfCurrentUser().then(function(D){var q=E.get('defaultTemplate');if(!q){var L=Parse.Object.extend('InvoiceTemplate'),R=new Parse.Query(L);return R.equalTo('name','Template 1'),R.first().then(function(S){var k=S.get('templateData');return I.htmlFile=S.get('templateHTML'),I.emailHtmlFile=S.get('emailHTML'),I.cardUrl=S.get('linkedFile').url(),h(k.url(),E,F,C,z,P,D)})}var w=q.get('templateData');return I.htmlFile=q.get('templateHTML'),I.emailHtmlFile=q.get('emailHTML'),I.cardUrl=q.get('linkedFile').url(),h(w.url(),E,F,C,z,P,D)})})}).then(function(F){return e.when(F).then(function(E){var A=E.newXml,P=new Parse.File('test1.xml',{base64:A},'text/xml');return I.pdf=E.pdf,P.save()})}).then(function(F){return I.xml=F,g(F.url(),I.emailHtmlFile.url(),I.cardUrl)}).then(function(F){var E=new Parse.File('test2.html',{base64:F},'text/html');return E.save()}).then(function(F){return I.emailHtml=F,m(I.xml.url(),I.htmlFile.url(),I.cardUrl)}).then(function(F){var E=new Parse.File('test2.html',{base64:F},'text/html');return E.save()}).then(function(F){return I.invoiceObj.set('invoiceLabels',I.xml),I.invoiceObj.set('emailReceipt',I.emailHtml),I.invoiceObj.set('invoiceReceipt',F),I.invoiceObj.set('pdfReceipt',I.pdf),I.invoiceObj.set('hasPdfReceipt',!0),I.invoiceObj.save()}).then(function(F){return F})},sendInvoiceText:function(T){var C=new a(T,{operation:'sendReceipt'}),O=C.entity.get('customer');if(O=O.get('mobile'),O)var N=O,I=C.customer.displayName,F=o(C.entity.balanceDue,'$',2),E=r.entity[0].get('company'),A=C.entity.invoiceReceipt.url(),P=I+', '+E+' has sent you an invoice of '+F+'. ';return Parse.Cloud.run('createShortUrl',{link:A}).then(function(z){return Parse.Cloud.run('sendSms',{to:N,body:P+z.data.data.url}).then(function(D){return console.log(D),T},function(D){return console.error(D),T})})},sendInvoiceTextToNumber:function(T,C){var O=new a(T,{operation:'sendReceipt'}),N=C;if(N)var I=N,F=O.customer.displayName,E=o(O.entity.balanceDue,'$',2),A=r.entity[0].get('company'),P=O.entity.invoiceReceipt.url(),z=F+', '+A+' has sent you an invoice of '+E+'. ';return Parse.Cloud.run('createShortUrl',{link:P}).then(function(D){return Parse.Cloud.run('sendSms',{to:I,body:z+D.data.data.url}).then(function(q){return console.log(q),T},function(q){return console.error(q),T})})},sendInvoiceReceipt:function(T){var C=new a(T,{operation:'sendReceipt'}),O=C.entity.invoiceReceipt.url();return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:O}}).then(function(N){var I,F=r.entity[0].get('company'),E=C.entity.invoiceReceipt.url();if(C.entity.customerEmails)I=C.entity.customerEmails[0];else{var z=C.entity.get('customer');I=z.get('email')}N=N.replace('<!DOCTYPE html>',''),N=N.trim();var D=1,q=document.getElementById('targetframe1');return q.src='about:blank',q.contentWindow.document.open(),q.contentWindow.document.write(N),q.contentWindow.document.close(),q.onload=function(){return D=0,Parse.Cloud.run('sendMailgunHtml',{toEmail:I,fromEmail:'no-reply@invoicesunlimited.com',subject:'Invoice From '+F,html:'<html>'+$('#targetframe1').contents().find('html').html()+'</html>'}).then(function(L){return console.log(L),T})},Promise.resolve('')})},sendInvoiceReceiptToEmail:function(T,C){var O=new a(T,{operation:'sendReceipt'}),N=O.entity.emailReceipt.url();return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:N}}).then(function(I){var E=r.entity[0].get('company'),A=O.entity.invoiceReceipt.url();I=I.replace('<!DOCTYPE html>',''),I=I.trim();var D=1,q=document.getElementById('targetframe1');return q.src='about:blank',q.contentWindow.document.open(),q.contentWindow.document.write(I),q.contentWindow.document.close(),q.onload=function(){return D=0,Parse.Cloud.run('sendMailgunHtml',{toEmail:C,fromEmail:'no-reply@invoicesunlimited.com',subject:'Invoice From '+E,html:'<html>'+$('#targetframe1').contents().find('html').html()+'</html>'}).then(function(L){return console.log(L),T})},Promise.resolve('')})},downloadInvoiceReceipt:function(T){var C=new a(T,{operation:'sendReceipt'}),O=C.entity.invoiceReceipt.url();return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:O}}).then(function(N){if(C.entity.customerEmails)var I=C.entity.customerEmails[0],F=C.organization.name,E=C.entity.invoiceReceipt.url();N=N.replace('<!DOCTYPE html>',''),N=N.trim();var D=document.createElement('iframe');return document.body.appendChild(D),D.style.display='none',D.setAttribute('id','myFrame'),D.contentWindow.document.open(),D.contentWindow.document.write(N),D.contentWindow.document.close(),D.onload=function(){var q=D.contentWindow.document.getElementsByTagName('body');q=q.innerHTML;var L='<page id="page-container">'+$('#myFrame').contents().find('body').html()+'</page>';debugger;$.ajax({method:'POST',type:'POST',url:'generatePDF.php',data:{html:L}}).then(function(){debugger})},Promise.resolve('')})}};var v=void 0}]);'use strict',invoicesUnlimited.factory('invoicesFactory',['userFactory','commentFactory','paymentFactory',function(e,a,s){if(e){var r=function(l){if(l){setObjectOperations({object:l,fieldName:void 0,parent:void 0,fields:c});var d=l.get('comments');d&&(d=d.map(function(m){return new a(m)}),this.comments=d);var u=l.get('payment');u&&(u=u.map(function(m){return new s(m)}),this.payments=u),this.invoiceDate=l.invoiceDate.toISOString().slice(0,10).split('-').reverse().join('/'),this.entity=l}},c=['total','status','invoiceNumber','invoiceDate','dueDate','balanceDue','customer','payment'];return r}}]);'use strict',invoicesUnlimited.factory('itemService',['$q','itemFactory',function(e,a){return{test:function(){console.log('working')},createItems:function(s){if(1>s.items.length)return Parse.Promise.as([]);var o=[],r=Parse.Object.extend('Item');return s.items.forEach(function(c){var l=new r;l.set('userID',s.user),l.set('organization',s.organization),l.setACL(s.acl),l.set('title',c.title),l.set('rate',c.rate+''),c.tax&&l.set('tax',Parse.Object.extend('Tax').createWithoutData(c.tax.id)),c.desc&&l.set('itemDescription',c.desc),c.expenseId&&l.set('expanseId',c.expenseId),o.push(l)}),Parse.Object.saveAll(o).then(function(c){return c=c.map(function(l){return new a(l)}),c})},getItemNames:function(s){var o=new Parse.Query('Item');return o.equalTo('organization',s.organization),o.select('title'),o.find()}}}]);'use strict',invoicesUnlimited.factory('lateFeeService',['lateFeeFactory',function(e){return{getAllLateFees:function(a){var s=new Parse.Query('LateFee');return s.equalTo('organization',a.organization),s.select('name','price','type'),s.find().then(function(o){return o.map(function(r){return new e(r)})})},createLateFee:function(a){var o=Parse.Object.extend('LateFee'),r=new o,c=new Parse.ACL;return c.setPublicReadAccess(!0),c.setPublicWriteAccess(!0),r.setACL(c),console.log(a),r.save(a).then(function(l){return new e(l)},function(l){console.log(l.message)})},updateLateFee:function(a){return a.save().then(function(s){return new e(s)})}}}]);'use strict',invoicesUnlimited.factory('organizationFactory',['userFactory',function(e){var a=e,s={entity:[],entities:[]},o=['creditNumber','portalURL','dateFormat','fiscalYearStart','name','fieldSeparator','estimateNumber','invoiceNumber','companyAddress','language','timeZone','email'],r=function(d,u){return d.fetch().then(function(m){return setObjectOperations({object:m,fieldName:u,parent:a.entity.length?a.entity[0]:null,fields:o}),'entity'==u&&s[u].pop(),s[u].push(m),s},function(m){console.log(m.message)})},c=function(){var u,d='selectedOrganization';return a.get?u=a.get(d):a.entity[0]&&a.entity[0].get&&(u=a.entity[0].get(d)),u?r(u,'entity'):(s.empty=!0,u)};return s.clearAllOnLogOut=function(){s.entity.length=0,s.entities.length=0},s.load=function(){return s.entity.length?s:c()},s.createNew=function(d){if(!s.entity.length){var u=Parse.Object.extend('Organization'),m=new u;return m.save(d,{success:function(g){setObjectOperations({object:g,fieldName:'selectedOrganization',parent:a.entity.length?a.entity[0]:null,fields:o}),s.entity.push(g),console.log(g.className+' created')},error:function(g,h){console.log(h.message)}}).then(function(g){return a.entity[0].add('organizations',g),[a.save({selectedOrganization:g}),g]},errorCallback).then(function(g){return g[1]},errorCallback)}},s.createNewWithoutSelect=function(d){if(!s.entity.length){var u=Parse.Object.extend('Organization'),m=new u;return m.save(d,{success:function(g){setObjectOperations({object:g,fields:o}),s.entities.push(g),console.log(g.className+' created')},error:function(g,h){console.log(h.message)}}).then(function(g){return a.entity[0].add('organizations',g),[a.save(),g]},errorCallback).then(function(g){return g[1]},errorCallback)}},s}]);'use strict',invoicesUnlimited.factory('preferencesFactory',['userFactory','roleFactory',function(e,a){var o={entity:[]},r=['invoiceShippingCharges','creditNotes','invoiceThanksNotes','creditTerms','invoiceDiscount','invoiceNotes','estimateNotes','invoiceTerms','estimateTerms','invoiceAdjustments','invoiceSalesPerson','invoiceAg','estimateAg','creditAg'],c=function(){if(e.entity.length){var l=new Parse.Query('Preferencies');return l.equalTo('userID',e.entity[0]),l.first().then(function(d){return setObjectOperations({object:d,fields:r}),o.entity.pop(),o.entity.push(d),o},function(d){console.log(d.message)})}};return o.clearAllOnLogOut=function(){o.entity.length=0},o.load=function(){return o.entity.length?o:c()},o.createNew=function(l){if(!o.entity.length){var d=Parse.Object.extend('Preferencies'),u=new d;return u.setACL(a.createACL()),u.save(l,{success:function(m){setObjectOperations({object:m,fields:r}),o.entity.push(m),console.log(m.className+' created')},error:function(m,g){console.log(g.message)}})}},o}]);'use strict',invoicesUnlimited.factory('principalFactory',['userFactory','roleFactory',function(e,a){var r,s=e,o={entity:[]},c=function(){var d,l='principalInfo';return s.get?d=s.get(l):s.entity[0]&&s.entity[0].get&&(d=s.entity[0].get(l)),d?d.fetch().then(function(u){return setObjectOperations({object:u,fieldName:l,parent:s.entity.length?s.entity[0]:null,fields:null}),o.entity.pop(),o.entity.push(u),o},function(u){console.log(u.message)}):(o.empty=!0,d)};return o.clearAllOnLogOut=function(){o.entity.length=0},o.load=function(){debugger;return o.entity.length?o.entity[0]:c()},o.createNew=function(l){if(!o.entity.length){var d=Parse.Object.extend('PrincipalInfo'),u=new d;return u.setACL(a.createACL()),u.save(l,{success:function(m){setObjectOperations({object:m,fieldName:'principalInfo',parent:s.entity.length?s.entity[0]:null,fields:r}),o.entity.push(m),console.log(m.className+' created')},error:function(m,g){console.log(g.message)}})}},o}]);'use strict',invoicesUnlimited.factory('projectService',['projectFactory','itemService','currencyFilter',function(e){function o(d,u){u.timesheets=[],Parse.Promise.as([]);var m=[],g=[],h=Parse.Object.extend('Timesheets');return d.forEach(function(y){if(y.attributes)m.push(y);else{var f=new h;f.set('userID',u.user),f.set('organization',u.organization),f.setACL(u.acl),f.set('user',y.user),f.set('task',y.task),f.set('date',y.date),f.set('notes',y.notes),f.set('hoursSpent',y.hoursSpent),f.set('minutesSpent',y.minutesSpent),g.push(f)}}),Parse.Object.saveAll(g).then(function(y){return y.concat(m)})}function c(d,u){Parse.Promise.as([]);var m=[],g=[],h=Parse.Object.extend('Staff');return d.forEach(function(y){if(y.entity)y.entity.set('chosenUser',y.user),y.entity.staffHours=y.staffHours,g.push(y.entity);else{var f=new h;f.set('userID',u.user),f.set('organization',u.organization),f.setACL(u.acl),f.set('chosenUser',y.user),f.set('staffHours',y.staffHours),m.push(f)}}),Parse.Object.saveAll(m.concat(g)).then(function(y){return y})}function l(d){var u=d.get('organizations');return u?u[0]:void 0}return{test:function(){console.log('working')},checkProjectNameAvailable:function(d){var u=Parse.Object.extend('Projects'),m=new Parse.Query(u);return m.equalTo('organization',d.organization),m.equalTo('projectName',d.projectName),m.select('projectName'),m.first().then(function(g){return!g})},listProjects:function(d){var u=l(d);if(u){var m=Parse.Object.extend('Projects'),g=new Parse.Query(m);return g.equalTo('organization',u),g.include('customer'),g.include('users.chosenUser'),g.find().then(function(h){var y=[];return h.forEach(function(f){y.push(new e(f,{operation:'listProjects'}))}),y})}},getProjectDetails:function(d){var u=Parse.Object.extend('Projects'),m=new Parse.Query(u);return m.include('customer'),m.include('tasks'),m.include('users.chosenUser'),m.include('timeSheets.task'),m.include('timeSheets.user'),m.get(d).then(function(g){var h=new e(g,{operation:'details'});return h})},getProject:function(d){var u=Parse.Object.extend('Projects'),m=new Parse.Query(u);return m.include('customer'),m.include('tasks'),m.include('users.chosenUser'),m.include('timeSheets.task'),m.include('timeSheets.user'),m.include('timesheets'),m.get(d).then(function(g){var h=new e(g,{operation:'getProject'});return h})},createNewProject:function(d,u,m,g){var h=new Parse.ACL;h.setPublicReadAccess(!0),h.setPublicWriteAccess(!0);var y={user:d.userID,organization:d.organization,acl:h},f=new Parse.Object('Projects',d);return f.setACL(h),o(g,y).then(function(b){return f.set('timeSheets',b),c(m,y).then(function(v){return f.set('users',v),f.save().then(function(T){return console.log('project created successfully'),T})})})},updateProject:function(d,u,m,g,h){var y=new Parse.ACL;y.setPublicReadAccess(!0),y.setPublicWriteAccess(!0);var f={acl:y,user:u,organization:u.get('organizations')[0]};return o(g,f).then(function(b){return d.entity.set('timeSheets',b),c(h,f).then(function(v){return d.entity.set('users',v),d.entity.save().then(function(T){return console.log('project created successfully'),T})})})}}}]);'use strict',invoicesUnlimited.service('queryService',['userFactory',function(e){this.find=function(s){var o;if(1<arguments.length){var r=arguments;return o=new Parse.Query(r[0]),o.equalTo(r[1],r[2]),o.limit(1e3),o.find()}return o=new Parse.Query(s.className),o.equalTo(s.field,s.value),o.limit(1e3),o.find()},this.ext={},this.ext.find=function(s){var o;if(1<arguments.length){var r=arguments;return o=new Parse.Query(r[0]),o.equalTo(r[1],r[2]),r[3].forEach(function(c){o[c.name](c.param)}),o.limit(1e3),o.find()}return o=new Parse.Query(s.className),o.equalTo(s.field,s.value),s.methods.forEach(function(c){o[c.name](c.param)}),o.limit(1e3),o.find()},this.first=function(s){var o=new Parse.Query(s.className);return o.equalTo(s.field,s.value),o.first()}}]);'use strict',invoicesUnlimited.factory('reportsService',['$q','invoiceFactory','creditNoteFactory',function(e,a,s){return{salesByCustomer:function(o){var r=Parse.Object.extend('Invoices'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.exists('payment'),c.greaterThanOrEqualTo('invoiceDate',o.fromDate),c.lessThanOrEqualTo('invoiceDate',o.toDate),c.include('customer'),c.limit(1e3),c.find().then(function(l){var d=[];return l.forEach(function(u){d.push(new a(u,{operation:'salesByCustomerReport'}))}),d})},salesByItem:function(o){var r=Parse.Object.extend('Invoices'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.exists('payment'),c.greaterThanOrEqualTo('invoiceDate',o.fromDate),c.lessThanOrEqualTo('invoiceDate',o.toDate),c.include('invoiceItems'),c.limit(1e3),c.find().then(function(l){var d=[];return l.forEach(function(u){d.push(new a(u,{operation:'salesByItemReport'}))}),d})},customerCredit:function(o){var r=Parse.Object.extend('CreditNotes'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.notEqualTo('status','Closed'),c.greaterThanOrEqualTo('creditNoteDate',o.fromDate),c.lessThanOrEqualTo('creditNoteDate',o.toDate),c.include('customer'),c.limit(1e3),c.find().then(function(l){var d=[];return l.forEach(function(u){d.push(new s(u,{operation:'customerCredit'}))}),d})},customerBalance:function(o){var r=Parse.Object.extend('Invoices'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.include('customer'),c.limit(1e3),c.find().then(function(l){var d=[];return l.forEach(function(u){d.push(new a(u,{operation:'customerBalance'}))}),d})},invoiceAging:function(o){var r=Parse.Object.extend('Invoices'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.notEqualTo('status','Paid'),c.include('customer'),c.include('lateFee'),c.limit(1e3),c.find().then(function(l){var d=[];return l.forEach(function(u){d.push(new a(u,{operation:'invoiceAging'}))}),d})},paymentsReceived:function(o){var r=Parse.Object.extend('Invoices'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.exists('payment'),c.greaterThanOrEqualTo('invoiceDate',o.fromDate),c.lessThanOrEqualTo('invoiceDate',o.toDate),c.include('customer','payment'),c.limit(1e3),c.find().then(function(l){var d=[];return l.forEach(function(u){d.push(new a(u,{operation:'paymentsReceived'}))}),d})},expenseByCategory:function(o){var r=Parse.Object.extend('Expanses'),c=new Parse.Query(r);return c.equalTo('organization',o.organization),c.greaterThanOrEqualTo('expanseDate',o.fromDate),c.lessThanOrEqualTo('expanseDate',o.toDate),c.select('category','amount'),c.limit(1e3),c.find()}}}]);'use strict',invoicesUnlimited.factory('roleFactory',['userFactory',function(e){var a=e.entity,s={entity:[]},o=function(){if(a.length){if(s.entity.length)return Promise.resolve(s);var r=new Parse.Query(Parse.Role);return r.equalTo('users',a[0]),r.first().then(function(c){return s.entity.pop(),s.entity.push(c),s},function(c){return console.log(c.message),c})}};return s.clearAllOnLogOut=function(){s.entity.length=0},s.addUser=function(r){return s.entity.length?(s.entity[0].getUsers().add(r),s.entity[0].save()):o().then(function(){return s.entity[0].getUsers().add(r),s.entity[0].save()})},s.load=function(){return o()},s.getRole=function(r){var c=new Parse.Query(Parse.Role);return c.equalTo('name',r.name),c.first()},s.createNew=function(r){return s.entity.length?void 0:s.getRole(r).then(function(c){var l=new Parse.ACL;l.setPublicReadAccess(!0),l.setPublicWriteAccess(!0);var d=c?c:new Parse.Role(r.name,l);return d.getUsers().add(r.userID),d.save({success:function(u){s.entity.pop(),s.entity.push(u),console.log(u.className+' created')},error:function(u){console.log(u.message)}})})},s.createACL=function(){if(s.entity.length){var r=new Parse.ACL;return r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0),r}},s}]);'use strict',invoicesUnlimited.factory('signatureFactory',['userFactory','roleFactory',function(e,a){var r,s=e,o={entity:[]},c=function(){var d,l='signatureImage';return s.get?d=s.get(l):s.entity[0]&&s.entity[0].get&&(d=s.entity[0].get(l)),d?d.fetch().then(function(u){return setObjectOperations({object:u,fieldName:l,parent:s.entity.length?s.entity[0]:null,fields:r}),o.entity.pop(),o.entity.push(u),o},function(u){console.log(u.message)}):(o.empty=!0,d)};return o.clearAllOnLogOut=function(){o.entity.length=0},o.load=function(){return o.entity.length?o.entity[0]:c()},o.createNew=function(l){if(!o.entity.length){var d=Parse.Object.extend('Signature'),u=new d;return u.setACL(a.createACL()),u.save(l,{success:function(m){setObjectOperations({object:m,fieldName:'signatureImage',parent:s.entity.length?s.entity[0]:null,fields:r}),o.entity.push(m),console.log(m.className+' created')},error:function(m,g){console.log(g.message)}})}},o}]);'use strict',invoicesUnlimited.factory('taxService',['$q',function(e){function a(r){var c=r.get('organizations');if(!c){var l='user: '+r.id+' has no Organization assigned.';return console.log(l),void 0}return c[0]}function s(r,c){return r.set('title',c.taxName),r.set('value',+c.taxRate),r.set('compound',c.isCompound?1:0),r.save().then(function(l){console.log('taxId: '+l.id+' updated.')})}function o(r,c,l){var d=new Parse.Query(l);return d.equalTo('type',2),d.find().then(function(u){for(var g,m=0;m<u.length;++m){g=u[m].get('associatedTaxes');for(var h=0;h<g.length;++h)if(g[h].id==c.id){var y=u[m].get('value');u[m].set('value',y+r),u[m].save().then(function(f){console.log('Tax Group: '+f.id+' updated.')});break}}})}return{getTaxes:function(r,c){showLoader();var l=a(r);if(!l)return hideLoader(),void c([]);var d=new Parse.Query('Tax'),u=e.defer();d.equalTo('organization',l),d.find().then(function(m){u.resolve(m)},function(){u.reject(results)}),u.promise.then(function(m){for(var y,g=[],h=0;h<m.length;++h)y=m[h],g.push({id:y.id,name:y.get('title')+(2==y.get('type')?' (Tax Group)':''),rate:y.get('value'),type:y.get('type'),isCompound:!!y.get('compound'),compound:y.get('compound'),entity:y});hideLoader(),c(g)}).catch(function(){hideLoader(),c([])})},saveNewGroupTax:function(r,c){var l=a(r.user);if(l){r.userID=r.user,delete r.user,r.organization=l,r.type=2;var d=new Parse.ACL;d.setPublicReadAccess(!0),d.setPublicWriteAccess(!0);var u=Parse.Object.extend('Tax'),m=new u;m.setACL(d),m.save(r,{success:function(g){c(g)},error:function(g,h){c('Failed to create new Tax, error code:'+h.message)}})}},saveNewTax:function(r,c){var l=a(r.user);if(l){r.userID=r.user,delete r.user,r.organization=l,r.type=1;var d=new Parse.ACL;d.setPublicReadAccess(!0),d.setPublicWriteAccess(!0);var u=Parse.Object.extend('Tax'),m=new u;m.setACL(d),m.save(r,{success:function(g){c(g)},error:function(g,h){c('Failed to create new Tax, error code:'+h.message)}})}},saveEditedTax:function(r){var c=Parse.Object.extend('Tax'),l=new Parse.Query(c);return l.get(r.taxId).then(function(d){var u=d.get('value'),m=+r.taxRate-u;return s(d,r).then(function(){return o(m,d,c)})})}}}]);'use strict',invoicesUnlimited.factory('userFactory',['appFields',function(e){function a(){return r.entity.length?r.entity[0].get('organizations')[0].fetch().then(function(l){return r.commonData.dateFormat=l.get('dateFormat'),Promise.resolve('')}):Promise.reject('')}var o=Parse.User.current()||{justLoggedIn:!1,entity:[]},r={entity:[],commonData:{}};if(Parse.User.current()){var c=Parse.User.current();setObjectOperations({object:c,fields:e.user}),r.entity.push(c)}return function(){r.getField=function(l){return isEmpty(r.commonData)?a().then(function(){return r.commonData[l]}):Promise.resolve(r.commonData[l])},r.login=function(l,d,u){r.entity.length&&r.entity[0].id||Parse.User.logIn(l.username,l.password,{success:function(m){r.justLoggedIn=!0,setObjectOperations({object:m,fields:e.user}),r.entity.push(m),console.log('Logged in successfuly!'),d()},error:function(m,g){console.log(g.message),u(g)}})},r.logout=function(){return Parse.User.logOut().then(function(){o.entity&&o.entity.pop(),o.justLoggedIn&&(o.justLoggedIn=!1),r.entity.pop(),r.commonData={}})},r.signup=function(l){var d=new Parse.User;return d.signUp(l,{success:function(u){setObjectOperations({object:u,fields:e.user}),r.entity.pop(),r.entity.push(u);var m=Parse.Object.extend('ProjectUser'),g=new m;return g.set('userID',u),g.set('companyName',u.get('company')),g.set('status','Activated'),g.set('role','Main'),g.set('userName',u.get('username')),g.set('emailID',u.get('email')),g.set('title',u.get('fullName')),g.set('organization',u.get('selectedOrganization')),g.save(null,{success:function(h){console.log(h.className+' created')},error:function(h,y){console.log(y.message)}})},error:function(u,m){console.log(m.message)}})},r.save=function(l){return r.entity.length?(void 0===l&&(l=null),r.entity[0].save(l)):void console.log('Unable to save user. The user is undefined')}}(),r}]);