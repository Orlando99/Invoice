'use strict';$(document).ready(function(){$(document).on('click','.menu',function(){var o=$(this).children('.submenu')[0];$('.menu .submenu').toArray().filter(function(r){return r!=o&&$(r).hasClass('showsub')}).forEach(function(r){$(r).removeClass('showsub')}),$(this).children('.submenu').toggleClass('showsub')})}),invoicesUnlimited.controller('CustomersController',['$scope','$rootScope','$state','$uibModal','userFactory','contactPersonFactory','customerFactory','coreFactory','expenseService','invoicesFactory','$controller','$q','appFields','currencyFilter','currencyFactory',function(o,r,l,u,y,h,g,C,T,D,I,N,F,U,P){function S(te){return o.customers.findIndex(function(se){return te==se.entity.id})}function k(){var te=l.params.customerId,se=S(te);-1==se?l.go('dashboard.customers.all'):(o.selectedCustomer=o.customers[se],o.selectedCustomerId=te)}function E(){o.currencyObj={title:void 0,currencySymbol:void 0,decimalPlace:'0',format:'###,###,###',exchangeRate:void 0},$('#addCurrencyForm').validate({rules:{currencyCode:'required',currencySymbol:'required',exchangeRate:{number:!0,min:0,required:!0}}}),$('#addCurrencyForm').validate().resetForm(),$('.new-currency').addClass('show')}function R(){var te=[];te.push(N.when(T.getCustomerExpenses({organization:H,customer:o.selectedCustomer.entity}))),te.push(N.when(H.fetch())),N.all(te).then(function(se){o.selectedCustomer.expenses=se[0];var ae=se[1],ne=ae.get('fiscalYearStart'),ie=getrotateCount(ne),oe=0,re=0,le=[0,0,0,0,0,0,0,0,0,0,0,0],de=[0,0,0,0,0,0,0,0,0,0,0,0],ce=['#0ea81c','#c31e1e'],me=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];o.selectedCustomer.invoices.forEach(function(ye){var he=ye.entity.invoiceDate.getMonth();le[he]+=ye.entity.total,oe+=ye.entity.total}),o.selectedCustomer.expenses.forEach(function(ye){var he=ye.entity.expanseDate.getMonth();de[he]+=ye.entity.amount,re+=ye.entity.amount}),me.rotate(ie),le.rotate(ie),de.rotate(ie),o.totalIncome=U(oe,'$',2),o.totalExpense=U(re,'$',2);var ue=$('#barchart'),pe=new Chart(ue,{type:'bar',data:{labels:me,datasets:[{backgroundColor:ce[0],data:le},{backgroundColor:ce[1],data:de}]},options:{responsive:!0,legend:{display:!1},scales:{xAxes:[{gridLines:{display:!1}}],yAxes:[{gridLines:{display:!0},ticks:{beginAtZero:!0,userCallback:function(ye){return A(ye.toFixed(2))}}}]}}})})}function A(te){return te.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}function B(te){N.when(C.getAllCustomers(te)).then(function(se){o.customers=se.sort(function(ne,ie){return alphabeticalSort(ne.entity.displayName,ie.entity.displayName)}),o.displayedCustomers=o.customers;var ae=[C.getAllInvoices({method:'containedIn',name:'customer',val1:se.map(function(ne){return ne.entity})}),C.getAllCreditNotes({method:'containedIn',name:'customer',val1:se.map(function(ne){return ne.entity})})];return N.all(ae)}).then(function(se){var ae=se[0],ne=se[1],ie=o.customers.length;o.customers.forEach(function(oe){oe.invoices=ae.filter(function(re){return re.entity.get('customer').id==oe.entity.id}),oe.creditNotes=ne.filter(function(re){return re.entity.get('customer').id==oe.entity.id}),oe.entity.unusedCredits||(oe.entity.unusedCredits=0),oe.entity.outstanding||(oe.entity.outstanding=0),oe.comments=oe.invoices.reduce(function(re,le){return le.comments?re.concat(le.comments):re.concat([])},[])}),o.customers.forEach(function(oe){var re=0;oe.invoices.forEach(function(de){re+=de.entity.balanceDue}),oe.entity.set('outstanding',re);var le=0;oe.creditNotes.forEach(function(de){le+=de.entity.remainingCredits}),oe.entity.set('unusedCredits',le)}),J.details(l.current.name)?V(q):J.edit(l.current.name)?(V(q),X()):J.emailContact(l.current.name)&&k(),o.sortByCustomerName(),hideLoader()},function(se){debugger;console.error(se)})}function M(){var te={translation:{Z:{pattern:/[1]/,optional:!0},Y:{pattern:/[0-02-9]/}}};$('#workPhone').mask('Z (Y00) 000-0000',te),$('#mobilePhone').mask('Z (Y00) 000-0000',te),$('#billFax').mask('Z (Y00) 000-0000',te),$('#shipFax').mask('Z (Y00) 000-0000',te)}var q=l.params.customerId,O=y,H=O.entity[0].get('organizations')[0];if(!O.entity.length)return void l.go('login');if('Sales'==y.entity[0].get('role'))return void l.go('dashboard.sales.invoices.all');y.getField('dateFormat').then(function(te){o.dateFormat=te}),o.displayNameClicked=!1,$('.tutorial').hide();N.defer();I('DashboardController',{$scope:o,$state:l}),o.nextClicked=function(){$('.tutorial').hide()},o.skipTutorial=function(){fromTutorial=!1,l.go('dashboard')},$('#edit-customer-form').validate({rules:{firstName:'required',mobilePhone:{required:!1,minlength:14}},messages:{firstName:'Please enter first name',mobilePhone:{minlength:'Please enter a valid phone number'}}}),o.selectedCustomer,o.selectedCustomerId,o.customers=[],o.comments=[],o.shipping={setShippingTheSame:!1,tempShippingAddress:{}};for(var W=function(te){var se='',ae=function(ne){return ne?ne:''};return(te.Street||te.City||te['State/Province']||te['Zip/Postal Code']||te.Country||te.Fax)&&(te.Fax?se+=ae(te.Street)+'\n'+ae(te.City)+'\n'+ae(te['State/Province'])+'\n'+ae(te['Zip/Postal Code'])+'\n'+ae(te.Country)+'\nFax: '+ae(te.Fax):se+=ae(te.Street)+'\n'+ae(te.City)+'\n'+ae(te['State/Province'])+'\n'+ae(te['Zip/Postal Code'])+'\n'+ae(te.Country)+'\n'+ae(te.Fax)),se},K=function(te){var se='',ae=function(ne){return ne?ne:''};return(te.Street||te.City||te['State/Province']||te['Zip/Postal Code']||te.Country||te.Fax)&&(te.Fax?se+=ae(te.Street)+'\n'+ae(te.City)+'\n'+ae(te['State/Province'])+'\n'+ae(te['Zip/Postal Code'])+'\n'+ae(te.Country)+'\nFax: '+ae(te.Fax):se+=ae(te.Street)+'\n'+ae(te.City)+'\n'+ae(te['State/Province'])+'\n'+ae(te['Zip/Postal Code'])+'\n'+ae(te.Country)+'\n'+ae(te.Fax)),se},V=function(te){var se=S(te);-1==se?l.go('dashboard.customers.all'):(Z(o.customers[se]),o.selectedCustomerId=te)},_=['trixInitialize','trixChange','trixSelectionChange','trixFocus','trixBlur','trixFileAccept','trixAttachmentAdd','trixAttachmentRemove'],Y=0;Y<_.length;Y++)o[_[Y]]=function(te){console.info('Event type:',te.type)};o.trixBlur=function(te,se){console.info('Event type:',te.type),o.trix=se.element.innerHTML},o.sendMail=function(){if($('#send-email-form').validate({rules:{toEmail:'required',subject:'required'},messages:{toEmail:'Please select email',subject:'Please enter subject'}}),!!$('#send-email-form').valid()){var te=o.selectedCustomer,se=o.trix,ae=$('#toEmail').val(),ne=$('#subject').val();debugger;showLoader(),Parse.Cloud.run('sendMailgunHtml',{toEmail:ae.join(', '),fromEmail:o.selectedCustomer.entity.displayName+' <no-reply@invoicesunlimited.com>',subject:ne,html:se}).then(function(ie){console.log(ie),showSnackbar('Email sent. Redirecting...'),hideLoader(),setTimeout(function(){l.go('dashboard.customers.details',{customerId:o.selectedCustomerId})},2e3)})}},o.cancelSendingEmail=function(){l.go('dashboard.customers.details',{customerId:o.selectedCustomerId})};var X=function(){o.selectedCustomerEdit=$.extend(!0,{},o.selectedCustomer.entity),o.billingAddressEdit=$.extend(!0,{},o.selectedCustomer.billingAddressJSON),o.shippingAddressEdit=$.extend(!0,{},o.selectedCustomer.shippingAddressJSON),o.shipping.setShippingTheSame=o.selectedCustomer.entity.get('isSameAddress')};o.NewExpense=function(){l.go('dashboard.expenses.new',{customerId:o.selectedCustomer.entity.id})},o.NewInvoice=function(){l.go('dashboard.sales.invoices.new',{customerId:o.selectedCustomer.entity.id})},o.NewCreditNote=function(){l.go('dashboard.sales.creditnotes.new',{customerId:o.selectedCustomer.entity.id})},o.NewEstimate=function(){l.go('dashboard.sales.estimates.new',{customerId:o.selectedCustomer.entity.id})};var Z=function(te){$('#toEmail').select2('close'),o.selectedCustomer=te;var se=o.dateFormat.toUpperCase().replace(/E/g,'d');o.selectedCustomer.invoices.forEach(function(re){re.invoiceDate=formatDate(re.entity.invoiceDate,se)}),o.selectedCustomer.comments.forEach(function(re){re&&(re.date=formatDate(re.entity.date,se))}),o.comments=o.selectedCustomer.comments,o.sortByDate();var ae=o.selectedCustomer.entity;ae.notes&&(o.selectedCustomer.notes=ae.notes);var ne={};ae.billingAddress&&(ne=JSON.parse(ae.billingAddress));var ie={};ae.shippingAddress&&(ie=JSON.parse(ae.shippingAddress)),o.selectedCustomer.billingAddress=W(ne),o.selectedCustomer.billingAddressJSON=ne,o.selectedCustomer.shippingAddress=K(ie),o.selectedCustomer.shippingAddressJSON=ie,o.receivables=0;o.payments=[],o.selectedCustomer.invoices.forEach(function(re){re.payments&&re.payments.forEach(function(le){var de=le,ce=o.dateFormat.toUpperCase().replace(/E/g,'d');le.mode='Credit Card'==le.entity.mode?'CC '+le.entity.lastFourDigits:le.entity.mode,de.date=formatDate(le.entity.date,ce),de.amount=U(le.entity.amount,'$',2),de.invoiceNumber=re.entity.invoiceNumber,o.payments.push(de)}),o.receivables+=re.entity.balanceDue}),o.receivables=o.receivables.toFixed(2),o.receivables=U(o.receivables,'$',2),R()};(function(){N.when(P.loadAll({organization:O.entity[0].get('selectedOrganization')})).then(function(te){o.currencies=te})})(),o.customerCurrencyChanged=function(){'dummy'==o.selectedCustomerEdit.currency&&(o.selectedCustomerEdit.currency='',E())},o.currencyChanged=function(){o.currencyObj&&(o.currencyObj.currencySymbol=o.currencyObj.title.split(' ')[0])},o.saveNewCurrency=function(){if($('#addCurrencyForm').valid()){showLoader();var te=o.currencyObj;te.userID=O.entity[0],te.organization=O.entity[0].get('selectedOrganization'),te.decimalPlace=+te.decimalPlace,te.exchangeRate=+te.exchangeRate||void 0,N.when(C.getUserRole(O.entity[0])).then(function(se){return P.createNewCurrency(te,se)},function(se){console.log(se)}).then(function(se){o.currencies.push(se),o.selectedCustomerEdit.currency=se.entity.title,$('.new-currency').removeClass('show'),hideLoader()})}};var J={details:function(te){return te.endsWith('details')},customers:function(te){return te.endsWith('customers')},edit:function(te){return!!te.includes('customers')&&te.endsWith('edit')},newCustomer:function(te){return te.endsWith('new')},emailContact:function(te){return te.endsWith('emailContact')}};o.setShippingAddress=function(){return o.selectedCustomer&&!o.shipping.setShippingTheSame?void(o.shippingAddressEdit=o.shipping.tempShippingAddress):void(o.selectedCustomer&&(o.shipping.tempShippingAddress=o.shippingAddressEdit,o.shippingAddressEdit=$.extend(!0,{},o.billingAddressEdit)))},o.saveSelectedCustomer=function(){if(o.selectedCustomer&&o.shipping.setShippingTheSame&&(o.shippingAddressEdit=$.extend(!0,{},o.billingAddressEdit)),!$('#edit-customer-form').valid()){var te=$('#edit-customer-form').validate(),se=$(te.errorList[0].element).offset().top-30;return void scrollToOffset(se)}o.shipping.setShippingTheSame?o.selectedCustomer.entity.set('isSameAddress',!0):o.selectedCustomer.entity.isSameAddress=!1;var ae=o.selectedCustomer;for(var ne in ae.billingAddressJSON=o.billingAddressEdit,ae.shippingAddressJSON=o.shippingAddressEdit,o.selectedCustomerEdit.billingAddress=JSON.stringify(ae.billingAddressJSON),o.selectedCustomerEdit.shippingAddress=JSON.stringify(ae.shippingAddressJSON),o.selectedCustomerEdit)F.customer.some(function(re){return ne==re})&&(ae.entity[ne]=o.selectedCustomerEdit[ne]);o.shipping.setShippingTheSame?ae.entity.set('isSameAddress',!0):ae.entity.set('isSameAddress',!1);var ie=[],oe=ae.entity.get('primaryContact');debugger;oe?(oe.set('email',ae.entity.get('email')),oe.set('mobile',ae.entity.get('mobile')),oe.set('phone',ae.entity.get('phone')),ie.push(oe.save())):(oe=ae.contactPersons.filter(function(re){return re.entity.get('defaultPerson')})[0],oe&&(oe.entity.set('email',ae.entity.get('email')),oe.entity.set('mobile',ae.entity.get('mobile')),oe.entity.set('phone',ae.entity.get('phone')),ae.entity.set('primaryContact',oe.entity),ie.push(oe.save()))),ie.push(ae.save()),N.all(ie).then(function(){ae.billingAddress=W(ae.entity.billingAddress),o.selectedCustomerEdit=null,o.billingAddressEdit=null,o.shippingAddressEdit=K(ae.entity.shippingAddress),l.go('dashboard.customers.details',{customerId:o.selectedCustomerId})},function(re){console.error(re);debugger})},o.deleteSelectedCustomer=function(){showLoader(),o.selectedCustomer.entity.set('isDeleted',1),N.when(o.selectedCustomer.entity.save()).then(function(){o.selectedCustomer=null,o.customers.splice(S(o.selectedCustomerId),1),o.selectedCustomerId=null,hideLoader(),l.go('dashboard.customers.all')})},o.deleteCustomer=function(te){te?(showLoader(),o.selectedCustomer.entity.set('isDeleted',1),N.when(o.selectedCustomer.entity.save()).then(function(){o.selectedCustomer=null,o.customers.splice(S(o.selectedCustomerId),1),o.selectedCustomerId=null,hideLoader(),l.go('dashboard.customers.all')})):$('.confirm-delete').removeClass('show')},o.confirmDelete=function(){$('.confirm-delete').addClass('show')},o.changeStatus=function(te){showLoader(),o.selectedCustomer.entity.set('status',te),o.selectedCustomer.entity.save().then(function(){hideLoader()},function(se){console.log(se.message)})},o.cancelSaveSelectedCustomer=function(){o.selectedCustomerEdit=null,l.go('dashboard.customers.details',{customerId:o.selectedCustomerId})};o.sortByCustomerName=function(){debugger;'none'===$('#nameD').css('display')?(o.customers.sort(function(te,se){return te.entity.displayName||(te.entity.displayName=''),se.entity.displayName||(se.entity.displayName=''),te.entity.displayName.localeCompare(se.entity.displayName)}),$('#nameD').css({display:'inline-table'}),$('#nameDUp').css({display:'none'})):(o.customers.sort(function(te,se){return te.entity.displayName||(te.entity.displayName=''),se.entity.displayName||(se.entity.displayName=''),se.entity.displayName.localeCompare(te.entity.displayName)}),$('#nameDUp').css({display:'inline-table'}),$('#nameD').css({display:'none'})),$('#custNameD').css({display:'none'}),$('#emailD').css({display:'none'}),$('#workphoneD').css({display:'none'}),$('#receivableD').css({display:'none'}),$('#creditsD').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#emailDUp').css({display:'none'}),$('#workphoneDUp').css({display:'none'}),$('#receivableDUp').css({display:'none'}),$('#creditsDUp').css({display:'none'})},o.sortByCompanyName=function(){o.customers.sort(function(te,se){return te.entity.companyName||(te.entity.companyName=''),se.entity.companyName||(se.entity.companyName=''),te.entity.companyName.localeCompare(se.entity.companyName)}),'none'===$('#custNameD').css('display')?(o.customers.sort(function(te,se){return te.entity.companyName||(te.entity.companyName=''),se.entity.companyName||(se.entity.companyName=''),te.entity.companyName.localeCompare(se.entity.companyName)}),$('#custNameD').css({display:'inline-table'}),$('#custNameDUp').css({display:'none'})):(o.customers.sort(function(te,se){return te.entity.companyName||(te.entity.companyName=''),se.entity.companyName||(se.entity.companyName=''),se.entity.companyName.localeCompare(te.entity.companyName)}),$('#custNameDUp').css({display:'inline-table'}),$('#custNameD').css({display:'none'})),$('#nameD').css({display:'none'}),$('#emailD').css({display:'none'}),$('#workphoneD').css({display:'none'}),$('#receivableD').css({display:'none'}),$('#creditsD').css({display:'none'}),$('#nameDUp').css({display:'none'}),$('#emailDUp').css({display:'none'}),$('#workphoneDUp').css({display:'none'}),$('#receivableDUp').css({display:'none'}),$('#creditsDUp').css({display:'none'})},o.sortByEmail=function(){'none'===$('#emailD').css('display')?(o.customers.sort(function(te,se){return te.entity.email||(te.entity.email=''),se.entity.email||(se.entity.email=''),te.entity.email.localeCompare(se.entity.email)}),$('#emailD').css({display:'inline-table'}),$('#emailDUp').css({display:'none'})):(o.customers.sort(function(te,se){return te.entity.email||(te.entity.email=''),se.entity.email||(se.entity.email=''),se.entity.email.localeCompare(te.entity.email)}),$('#emailDUp').css({display:'inline-table'}),$('#emailD').css({display:'none'})),$('#nameD').css({display:'none'}),$('#custNameD').css({display:'none'}),$('#workphoneD').css({display:'none'}),$('#receivableD').css({display:'none'}),$('#creditsD').css({display:'none'}),$('#nameDUp').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#workphoneDUp').css({display:'none'}),$('#receivableDUp').css({display:'none'}),$('#creditsDUp').css({display:'none'})},o.sortByPhone=function(){o.customers.sort(function(te,se){return te.entity.mobile||(te.entity.mobile=''),se.entity.mobile||(se.entity.mobile=''),te.entity.mobile.localeCompare(se.entity.mobile)}),'none'===$('#workphoneD').css('display')?(o.customers.sort(function(te,se){return te.entity.mobile||(te.entity.mobile=''),se.entity.mobile||(se.entity.mobile=''),te.entity.mobile.localeCompare(se.entity.mobile)}),$('#workphoneD').css({display:'inline-table'}),$('#workphoneDUp').css({display:'none'})):(o.customers.sort(function(te,se){return te.entity.mobile||(te.entity.mobile=''),se.entity.mobile||(se.entity.mobile=''),se.entity.mobile.localeCompare(te.entity.mobile)}),$('#workphoneDUp').css({display:'inline-table'}),$('#workphoneD').css({display:'none'})),$('#nameD').css({display:'none'}),$('#custNameD').css({display:'none'}),$('#emailD').css({display:'none'}),$('#receivableD').css({display:'none'}),$('#creditsD').css({display:'none'}),$('#nameDUp').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#emailDUp').css({display:'none'}),$('#receivableDUp').css({display:'none'}),$('#creditsDUp').css({display:'none'})},o.sortByReceivable=function(){'none'===$('#receivableD').css('display')?(o.customers.sort(function(te,se){return te.entity.outstanding-se.entity.outstanding}),$('#receivableD').css({display:'inline-table'}),$('#receivableDUp').css({display:'none'})):(o.customers.sort(function(te,se){return se.entity.outstanding-te.entity.outstanding}),$('#receivableDUp').css({display:'inline-table'}),$('#receivableD').css({display:'none'})),$('#nameD').css({display:'none'}),$('#custNameD').css({display:'none'}),$('#emailD').css({display:'none'}),$('#workphoneD').css({display:'none'}),$('#creditsD').css({display:'none'}),$('#nameDUp').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#emailDUp').css({display:'none'}),$('#workphoneDUp').css({display:'none'}),$('#creditsDUp').css({display:'none'})},o.sortByCredits=function(){'none'===$('#creditsD').css('display')?(o.customers.sort(function(te,se){return te.entity.unusedCredits-se.entity.unusedCredits}),$('#creditsD').css({display:'inline-table'}),$('#creditsDUp').css({display:'none'})):(o.customers.sort(function(te,se){return se.entity.unusedCredits-te.entity.unusedCredits}),$('#creditsDUp').css({display:'inline-table'}),$('#creditsD').css({display:'none'})),$('#nameD').css({display:'none'}),$('#custNameD').css({display:'none'}),$('#emailD').css({display:'none'}),$('#workphoneD').css({display:'none'}),$('#receivableD').css({display:'none'}),$('#nameDUp').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#emailDUp').css({display:'none'}),$('#workphoneDUp').css({display:'none'}),$('#receivableDUp').css({display:'none'})},o.sortByDate=function(){'none'===$('#date').css('display')?(o.comments.sort(function(te,se){return te.entity.date>se.entity.date?-1:te.entity.date<se.entity.date?1:0}),$('#date').css({display:'inline-table'}),$('#dateUp').css({display:'none'})):(o.comments.sort(function(te,se){return se.entity.date>te.entity.date?-1:se.entity.date<te.entity.date?1:0}),$('#dateUp').css({display:'inline-table'}),$('#date').css({display:'none'})),$('#user').css({display:'none'}),$('#userUp').css({display:'none'})},o.sortByUser=function(){'none'===$('#user').css('display')?(o.comments.sort(function(te,se){te.entity.name.localeCompare(se.entity.name)}),$('#user').css({display:'inline-table'}),$('#userUp').css({display:'none'})):(o.comments.sort(function(te,se){se.entity.name.localeCompare(te.entity.name)}),$('#userUp').css({display:'inline-table'}),$('#user').css({display:'none'})),$('#date').css({display:'none'}),$('#dateUp').css({display:'none'}),o.comments.sort(function(te,se){return te.entity.name.localeCompare(se.entity.name)})},o.deleteContact=function(te){showLoader(),o.selectedCustomer.contactPersons[te].destroy(o.selectedCustomer).then(function(){o.selectedCustomer.contactPersons.splice(te,1),o.$$phase||o.$apply(),hideLoader()},function(se){console.log(se.message)})},o.editContact=function(te,se){var ae=te;o.selectedCustomer.contactPersons[se]=angular.copy(ae);var ne=u.open({animation:!0,templateUrl:'modal-contact',controller:'ModalContactController',windowClass:'modalWindow fade in',backdropClass:'popup-modal show fade in',backdrop:!0,resolve:{title:function(){return'Edit Contact Person'},contact:function(){return ae},customer:function(){return o.selectedCustomer}}});ne.result.then(function(ie){o.selectedCustomer.contactPersons[se]=ie},function(){console.log('dismiss modal')})},$('#addContactForm').validate({rules:{firstname:'required',lastname:'required'},messages:{firstname:'Please specify your estimated montly credit card sales!',lastname:'Please specify your bank name!'}}),o.createContact=function(){var te=u.open({animation:!0,templateUrl:'modal-contact',controller:'ModalContactController',backdropClass:'popup-modal show fade in',windowClass:'modalWindow fade in',backdrop:!0,resolve:{title:function(){return'Add Contact Person'},contact:function(){console.log('Resolve Contact');var se=Parse.Object.extend('ContactPerson'),ae=new h(new se());return ae.entity.set('userID',O.entity[0]),ae},customer:function(){return o.selectedCustomer}}});te.result.then(function(se){o.selectedCustomer.contactPersons.push(se)},function(){console.log('dismiss modal')})},r.$on('$viewContentLoaded',function(){if(J.edit(l.current.name)||J.newCustomer(l.current.name))M();else if(J.emailContact(l.current.name)){var se=o.selectedCustomer.contactPersons,ae=[];se.forEach(function(ie){ie.entity.email&&ae.push({id:ie.entity.email,text:ie.entity.email})}),$('#toEmail').html(''),$('#toEmail').select2({data:ae,placeholder:'Select Email'}),o.trix=''}});var Q=r.$on('$stateChangeStart',function(te,se,ae,ne){if(se.name.includes('customers')||(Q(),Q=null),J.customers(se.name)||J.newCustomer(se.name))o.selectedCustomer=null,o.selectedCustomerId=null;else if(J.details(se.name)){if(isNaN(parseInt(ae.customerId))&&ne.name.endsWith('new'))return void te.preventDefault();V(ae.customerId)}else J.emailContact(se.name)?k():J.edit(se.name)?(V(ae.customerId),X()):ne.name.endsWith('new')&&B(!0)});B();var ee=function(){if(!o.displayNameClicked){var ae=o.selectedCustomerEdit;if(ae){if(!ae.firstName&&!ae.lastName)return void(ae.displayName='');ae.displayName='',ae.displayName+=ae.firstName?ae.firstName:'',ae.displayName+=' ',ae.displayName+=ae.lastName?ae.lastName:''}}};o.searchObject={},o.search=function(){o.searchObject.searchText&&(o.searchObject.searchText.length?o.customers=o.displayedCustomers.filter(function(te){return te.entity.displayName||(te.entity.displayName=''),te.entity.companyName||(te.entity.companyName=''),te.entity.email||(te.entity.email=''),te.entity.phone||(te.entity.phone=''),te.entity.outstanding||(te.entity.outstanding=''),te.entity.unusedCredits||(te.entity.unusedCredits=''),te.entity.displayName.toLowerCase().includes(o.searchObject.searchText.toLowerCase())||te.entity.companyName.toLowerCase().includes(o.searchObject.searchText.toLowerCase())||te.entity.email.toLowerCase().includes(o.searchObject.searchText.toLowerCase())||te.entity.phone.toLowerCase().includes(o.searchObject.searchText.toLowerCase())||te.entity.outstanding.toLowerCase().includes(o.searchObject.searchText.toLowerCase())||te.entity.unusedCredits.toLowerCase().includes(o.searchObject.searchText.toLowerCase())}):o.customers=o.displayedCustomers)},o.$watch('selectedCustomerEdit.firstName',ee),o.$watch('selectedCustomerEdit.lastName',ee),o.availableCurrencies=['ADP - Andorran Peseta','AED - United Arab Emirates Dirham','AFN - Afghan Afghani','ALL - Albanian Lek','AMD - Armenian Dram','ANG - Netherlands Antillean Guilder','AOA - Angolan Kwanza','ARA - Argentine Austral','ARS - Argentine Peso','ATS - Austrian Schilling','AUD - Australian Dollar','AWG - Aruban Florin','AZN - Azerbaijani Manat','BAM - Bosnia-Herzegovina Convertible Mark','BBD - Barbadian Dollar','BDT - Bangladeshi Taka','BEC - Belgian Franc (convertible)','BEF - Belgian Franc','BEL - Belgian Franc (financial)','BGL - Bulgarian Hard Lev','BGM - Bulgarian Socialist Lev','BGN - Bulgarian Lev','BHD - Bahraini Dinar','BIF - Burundian Franc','BMD - Bermudan Dollar','BND - Brunei Dollar','BOB - Bolivian Boliviano','BOP - Bolivian Peso','BOV - Bolivian Mvdol','BRL - Brazilian Real','BSD - Bahamian Dollar','BTN - Bhutanese Ngultrum','BUK - Burmese Kyat','BWP - Botswanan Pula','BYR - Belarusian Ruble','BZD - Belize Dollar','CAD - Canadian Dollar','CDF - Congolese Franc','CHE - WIR Euro','CHF - Swiss Franc','CHW - WIR Franc','CLE - Chilean Escudo','CLF - Chilean Unit of Account (UF)','CLP - Chilean Peso','CNX - Chinese People\u2019s Bank Dollar','CNY - Chinese Yuan','COP - Colombian Peso','COU - Colombian Real Value Unit','CRC - Costa Rican Col\xF3n','CSK - Czechoslovak Hard Koruna','CUC - Cuban Convertible Peso','CUP - Cuban Peso','CVE - Cape Verdean Escudo','CYP - Cypriot Pound','CZK - Czech Republic Koruna','DDM - East German Mark','DEM - German Mark','DJF - Djiboutian Franc','DKK - Danish Krone','DOP - Dominican Peso','DZD - Algerian Dinar','ECS - Ecuadorian Sucre','ECV - Ecuadorian Unit of Constant Value','EEK - Estonian Kroon','EGP - Egyptian Pound','ERN - Eritrean Nakfa','ESA - Spanish Peseta (A account)','ESB - Spanish Peseta (convertible account)','ESP - Spanish Peseta','ETB - Ethiopian Birr','EUR - Euro','FIM - Finnish Markka','FJD - Fijian Dollar','FKP - Falkland Islands Pound','FRF - French Franc','GBP - British Pound','GEK - Georgian Kupon Larit','GEL - Georgian Lari','GHS - Ghanaian Cedi','GIP - Gibraltar Pound','GMD - Gambian Dalasi','GNF - Guinean Franc','GNS - Guinean Syli','GQE - Equatorial Guinean Ekwele','GRD - Greek Drachma','GTQ - Guatemalan Quetzal','GWE - Portuguese Guinea Escudo','GWP - Guinea-Bissau Peso','GYD - Guyanaese Dollar','HKD - Hong Kong Dollar','HNL - Honduran Lempira','HRD - Croatian Dinar','HRK - Croatian Kuna','HTG - Haitian Gourde','HUF - Hungarian Forint','IDR - Indonesian Rupiah','IEP - Irish Pound','ILP - Israeli Pound','ILS - Israeli New Sheqel','INR - Indian Rupee','IQD - Iraqi Dinar','IRR - Iranian Rial','ISK - Icelandic Kr\xF3na','ITL - Italian Lira','JMD - Jamaican Dollar','JOD - Jordanian Dinar','JPY - Japanese Yen','KES - Kenyan Shilling','KGS - Kyrgystani Som','KHR - Cambodian Riel','KMF - Comorian Franc','KPW - North Korean Won','KRW - South Korean Won','KWD - Kuwaiti Dinar','KYD - Cayman Islands Dollar','KZT - Kazakhstani Tenge','LAK - Laotian Kip','LBP - Lebanese Pound','LKR - Sri Lankan Rupee','LRD - Liberian Dollar','LSL - Lesotho Loti','LTL - Lithuanian Litas','LTT - Lithuanian Talonas','LUC - Luxembourgian Convertible Franc','LUF - Luxembourgian Franc','LUL - Luxembourg Financial Franc','LVL - Latvian Lats','LVR - Latvian Ruble','LYD - Libyan Dinar','MAD - Moroccan Dirham','MAF - Moroccan Franc','MCF - Monegasque Franc','MDC - Moldovan Cupon','MDL - Moldovan Leu','MGA - Malagasy Ariary','MGF - Malagasy Franc','MKD - Macedonian Denar','MLF - Malian Franc','MMK - Myanmar Kyat','MNT - Mongolian Tugrik','MOP - Macanese Pataca','MRO - Mauritanian Ouguiya','MTL - Maltese Lira','MTP - Maltese Pound','MUR - Mauritian Rupee','MVR - Maldivian Rufiyaa','MWK - Malawian Kwacha','MXN - Mexican Peso','MXV - Mexican Investment Unit','MYR - Malaysian Ringgit','MZE - Mozambican Escudo','MZN - Mozambican Metical','NAD - Namibian Dollar','NGN - Nigerian Naira','NIO - Nicaraguan C\xF3rdoba','NLG - Dutch Guilder','NOK - Norwegian Krone','NPR - Nepalese Rupee','NZD - New Zealand Dollar','OMR - Omani Rial','PAB - Panamanian Balboa','PEI - Peruvian Inti','PEN - Peruvian Nuevo Sol','PGK - Papua New Guinean Kina','PHP - Philippine Peso','PKR - Pakistani Rupee','PLN - Polish Zloty','PTE - Portuguese Escudo','PYG - Paraguayan Guarani','QAR - Qatari Rial','RHD - Rhodesian Dollar','RON - Romanian Leu','RSD - Serbian Dinar','RUB - Russian Ruble','RWF - Rwandan Franc','SAR - Saudi Riyal','SBD - Solomon Islands Dollar','SCR - Seychellois Rupee','SDG - Sudanese Pound','SEK - Swedish Krona','SGD - Singapore Dollar','SHP - St. Helena Pound','SIT - Slovenian Tolar','SKK - Slovak Koruna','SLL - Sierra Leonean Leone','SOS - Somali Shilling','SRD - Surinamese Dollar','SRG - Surinamese Guilder','SSP - South Sudanese Pound','STD - S\xE3o Tom\xE9 & Pr\xEDncipe Dobra','SUR - Soviet Rouble','SVC - Salvadoran Col\xF3n','SYP - Syrian Pound','SZL - Swazi Lilangeni','THB - Thai Baht','TJR - Tajikistani Ruble','TJS - Tajikistani Somoni','TMT - Turkmenistani Manat','TND - Tunisian Dinar','TOP - Tongan Pa\u02BBanga','TPE - Timorese Escudo','TRY - Turkish Lira','TTD - Trinidad & Tobago Dollar','TWD - New Taiwan Dollar','TZS - Tanzanian Shilling','UAH - Ukrainian Hryvnia','UAK - Ukrainian Karbovanets','UGX - Ugandan Shilling','USD - US Dollar','USN - US Dollar (Next day)','USS - US Dollar (Same day)','UYI - Uruguayan Peso (Indexed Units)','UYU - Uruguayan Peso','UZS - Uzbekistani Som','VEF - Venezuelan Bol\xEDvar','VND - Vietnamese Dong','VUV - Vanuatu Vatu','WST - Samoan Tala','XAF - Central African CFA Franc','XAG - Silver','XAU - Gold','XBA - European Composite Unit','XBB - European Monetary Unit','XBC - European Unit of Account (XBC)','XBD - European Unit of Account (XBD)','XCD - East Caribbean Dollar','XDR - Special Drawing Rights','XEU - European Currency Unit','XFO - French Gold Franc','XFU - French UIC-Franc','XOF - West African CFA Franc','XPD - Palladium','XPF - CFP Franc','XPT - Platinum','XRE - RINET Funds','XSU - Sucre','XTS - Testing Currency Code','XUA - ADB Unit of Account','XXX - Unknown Currency','YDD - Yemeni Dinar','YER - Yemeni Rial','ZAL - South African Rand (financial)','ZAR - South African Rand','ZMW - Zambian Kwacha']}]);'use strict',invoicesUnlimited.controller('ModalContactController',['$scope','$uibModalInstance','contact','customer','title',function(o,r,l,u,y){o.contact=l,o.title=y,o.Save=function(){$('#addContactForm').validate({rules:{firstname:'required',lastname:'required',mobile:{required:!1,minlength:14},phone:{required:!1,minlength:14},email:{required:!1,email:!0}},messages:{firstname:'Please enter first name',lastname:'Please enter last name',mobile:{minlength:'Please enter a valid phone number'},phone:{minlength:'Please enter a valid phone number'},email:{email:'Please enter a valid email address'}}});$('#addContactForm').valid()&&(showLoader(),o.contact.save().then(function(){return u.contactPersons.some(function(C){return C.entity.id==o.contact.entity.id})?void 0:(u.entity.add('contactPersons',o.contact.entity),u.save())},function(){debugger}).then(function(){hideLoader(),r.close(o.contact)}))},o.Cancel=function(){r.dismiss('Close')},$('.workPhone').mask('(000) 000-0000'),$('.mobilePhone').mask('9 (999) 999-9999',mobileOptions),o.maskPhones=function(){$('.workPhone').mask('(000) 000-0000'),$('.mobilePhone').mask('9 (999) 999-9999',mobileOptions)}}]);'use strict',invoicesUnlimited.controller('NewCustomerController',['$scope','$rootScope','$state','userFactory','contactPersonFactory','customerFactory','$controller','$q','coreFactory','currencyFactory',function(o,r,l,u,y,h,g,C,T,D){function I(R){if(0==R.which||8==R.which||32==R.which)return!0;if(32==R.which)return!0;var A=/[a-zA-Z0-9-]+$/,B=String.fromCharCode(R.charCode?R.charCode:R.which);return!!A.test(B)||(R.preventDefault(),!1)}function F(){var R=P.entity[0].get('currency');o.defaultCurrencyIndex=o.currencies.findIndex(function(A){return A.entity.id==R.id}),o.newCustomer.entity.currency=o.currencies[o.defaultCurrencyIndex].entity.title}function U(){o.currencyObj={title:void 0,currencySymbol:void 0,decimalPlace:'0',format:'###,###,###',exchangeRate:void 0},$('#addCurrencyForm').validate({rules:{currencyCode:'required',currencySymbol:'required',exchangeRate:{number:!0,min:0,required:!0}}}),$('#addCurrencyForm').validate().resetForm(),$('.new-currency').addClass('show')}var P=u;if(!P.entity.length)return void l.go('login');if('Sales'==u.entity[0].get('role'))return void l.go('dashboard.sales.invoices.all');fromTutorial?$('.tutorial').show():$('.tutorial').hide(),o.displayNameClicked=!1,$('#workPhone').mask('(999) 999-9999'),$('#mobilePhone').mask('9 (999) 999-9999',mobileOptions),$('.alphaNumericField').keypress(function(R){I(R)});var S=C.defer(),k={Street:'',Fax:'',City:'','Zip/Postal Code':'',Country:'','State/Province':''};g('DashboardController',{$scope:o,$state:l}),hideLoader();var L=Parse.Object.extend('Customer');o.newCustomer=new h(new L()),o.newCustomer.entity.set('userID',P.entity[0]),o.newCustomer.entity.set('status','active'),o.newCustomer.entity.paymentTerms='Due on Receipt',o.newCustomer.billingAddress=Object.create(k),o.newCustomer.shippingAddress=Object.create(k),function(){C.when(D.loadAll({organization:P.entity[0].get('selectedOrganization')})).then(function(R){o.currencies=R,F()})}(),o.shipping={setShippingTheSame:!1,tempShippingAddress:{}},$('#new-customer-form').validate({rules:{firstName:'required',mobilePhone:{required:!1,minlength:14},phoneNumber:{required:!1,minlength:14},email:{required:!1,email:!0}},messages:{firstName:'Please enter first name',mobilePhone:{minlength:'Please enter a valid phone number'},phoneNumber:{minlength:'Please enter a valid phone number'},email:{email:'Please enter a valid email address'}}}),o.customerCurrencyChanged=function(){'dummy'==o.newCustomer.entity.currency&&(o.newCustomer.entity.currency='',U())},o.currencyChanged=function(){o.currencyObj&&(o.currencyObj.currencySymbol=o.currencyObj.title.split(' ')[0])},o.saveNewCurrency=function(){if($('#addCurrencyForm').valid()){showLoader();var R=o.currencyObj;R.userID=P.entity[0],R.organization=P.entity[0].get('selectedOrganization'),R.decimalPlace=+R.decimalPlace,R.exchangeRate=+R.exchangeRate||void 0,C.when(T.getUserRole(P.entity[0])).then(function(A){return D.createNewCurrency(R,A)},function(A){console.log(A)}).then(function(A){o.currencies.push(A),o.newCustomer.entity.currency=A.entity.title,$('.new-currency').removeClass('show'),hideLoader()})}},o.setShippingAddress=function(){return o.newCustomer&&!o.shipping.setShippingTheSame?void(o.newCustomer.shippingAddress=o.shipping.tempShippingAddress):void(o.newCustomer&&(o.shipping.tempShippingAddress=o.newCustomer.shippingAddress,o.newCustomer.shippingAddress=$.extend(!0,{},o.newCustomer.billingAddress)))},o.saveCustomer=function(){if(o.newCustomer&&o.shipping.setShippingTheSame&&(o.newCustomer.shippingAddress=$.extend(!0,{},o.newCustomer.billingAddress)),!$('#new-customer-form').valid()){var R=$('#new-customer-form').validate(),A=$(R.errorList[0].element).offset().top-30;return void scrollToOffset(A)}showLoader(),o.newCustomer.entity.billingAddress=JSON.stringify(o.newCustomer.billingAddress),o.newCustomer.entity.shippingAddress=JSON.stringify(o.newCustomer.shippingAddress),o.shipping.setShippingTheSame?o.newCustomer.entity.set('isSameAddress',!0):o.newCustomer.entity.set('isSameAddress',!1);var B=Parse.Object.extend('ContactPerson'),M=new y(new B()),q=o.newCustomer;M.entity.set('userID',P.entity[0]),M.entity.set('defaultPerson',1),['email','phone','mobile','lastName','firstName','salutaion'].forEach(function(O){M.entity[O.toLowerCase()]=o.newCustomer.entity[O]}),o.newCustomer.entity.firstname||(M.entity.firstname=o.newCustomer.entity.displayName.split(' ')[0]),M.save().then(function(){o.newCustomer.entity.add('contactPersons',M.entity),o.newCustomer.entity.set('primaryContact',M.entity),o.newCustomer.entity.set('organization',P.entity[0].get('selectedOrganization')),o.newCustomer.save().then(function(O){o.newCustomer=new h(new L()),o.newCustomer.entity.set('userID',P.entity[0]),o.newCustomer.billingAddress=Object.create(k),o.newCustomer.shippingAddress=Object.create(k),hideLoader(),T.clearAllOnLogOut(),l.params.backLink?l.params.invoiceId?l.go(l.params.backLink,{customerId:O.id,invoiceId:l.params.invoiceId}):l.params.estimateId?l.go(l.params.backLink,{customerId:O.id,estimateId:l.params.estimateId}):l.params.creditNoteId?l.go(l.params.backLink,{customerId:O.id,creditNoteId:l.params.creditNoteId}):l.params.expenseId?l.go(l.params.backLink,{customerId:O.id,expenseId:l.params.expenseId}):l.go(l.params.backLink,{customerId:O.id}):fromTutorial?(fromTutorial=!1,l.go('dashboard')):l.go('dashboard.customers.all',{},{reload:'dashboard.customers'})})})};var E=function(){if(!o.displayNameClicked){var B=o.newCustomer.entity;if(!B.firstName&&!B.lastName)return void(B.displayName='');B.displayName='',B.displayName+=B.firstName?B.firstName:'',B.displayName+=' ',B.displayName+=B.lastName?B.lastName:''}};o.$watch('newCustomer.entity.firstName',E),o.$watch('newCustomer.entity.lastName',E),o.cancelSaveCustomer=function(){window.history.go(-1)},o.nextClicked=function(){$('.tutorial').hide()},o.skipTutorial=function(){fromTutorial=!1,l.go('dashboard')},o.availableCurrencies=['ADP - Andorran Peseta','AED - United Arab Emirates Dirham','AFN - Afghan Afghani','ALL - Albanian Lek','AMD - Armenian Dram','ANG - Netherlands Antillean Guilder','AOA - Angolan Kwanza','ARA - Argentine Austral','ARS - Argentine Peso','ATS - Austrian Schilling','AUD - Australian Dollar','AWG - Aruban Florin','AZN - Azerbaijani Manat','BAM - Bosnia-Herzegovina Convertible Mark','BBD - Barbadian Dollar','BDT - Bangladeshi Taka','BEC - Belgian Franc (convertible)','BEF - Belgian Franc','BEL - Belgian Franc (financial)','BGL - Bulgarian Hard Lev','BGM - Bulgarian Socialist Lev','BGN - Bulgarian Lev','BHD - Bahraini Dinar','BIF - Burundian Franc','BMD - Bermudan Dollar','BND - Brunei Dollar','BOB - Bolivian Boliviano','BOP - Bolivian Peso','BOV - Bolivian Mvdol','BRL - Brazilian Real','BSD - Bahamian Dollar','BTN - Bhutanese Ngultrum','BUK - Burmese Kyat','BWP - Botswanan Pula','BYR - Belarusian Ruble','BZD - Belize Dollar','CAD - Canadian Dollar','CDF - Congolese Franc','CHE - WIR Euro','CHF - Swiss Franc','CHW - WIR Franc','CLE - Chilean Escudo','CLF - Chilean Unit of Account (UF)','CLP - Chilean Peso','CNX - Chinese People\u2019s Bank Dollar','CNY - Chinese Yuan','COP - Colombian Peso','COU - Colombian Real Value Unit','CRC - Costa Rican Col\xF3n','CSK - Czechoslovak Hard Koruna','CUC - Cuban Convertible Peso','CUP - Cuban Peso','CVE - Cape Verdean Escudo','CYP - Cypriot Pound','CZK - Czech Republic Koruna','DDM - East German Mark','DEM - German Mark','DJF - Djiboutian Franc','DKK - Danish Krone','DOP - Dominican Peso','DZD - Algerian Dinar','ECS - Ecuadorian Sucre','ECV - Ecuadorian Unit of Constant Value','EEK - Estonian Kroon','EGP - Egyptian Pound','ERN - Eritrean Nakfa','ESA - Spanish Peseta (A account)','ESB - Spanish Peseta (convertible account)','ESP - Spanish Peseta','ETB - Ethiopian Birr','EUR - Euro','FIM - Finnish Markka','FJD - Fijian Dollar','FKP - Falkland Islands Pound','FRF - French Franc','GBP - British Pound','GEK - Georgian Kupon Larit','GEL - Georgian Lari','GHS - Ghanaian Cedi','GIP - Gibraltar Pound','GMD - Gambian Dalasi','GNF - Guinean Franc','GNS - Guinean Syli','GQE - Equatorial Guinean Ekwele','GRD - Greek Drachma','GTQ - Guatemalan Quetzal','GWE - Portuguese Guinea Escudo','GWP - Guinea-Bissau Peso','GYD - Guyanaese Dollar','HKD - Hong Kong Dollar','HNL - Honduran Lempira','HRD - Croatian Dinar','HRK - Croatian Kuna','HTG - Haitian Gourde','HUF - Hungarian Forint','IDR - Indonesian Rupiah','IEP - Irish Pound','ILP - Israeli Pound','ILS - Israeli New Sheqel','INR - Indian Rupee','IQD - Iraqi Dinar','IRR - Iranian Rial','ISK - Icelandic Kr\xF3na','ITL - Italian Lira','JMD - Jamaican Dollar','JOD - Jordanian Dinar','JPY - Japanese Yen','KES - Kenyan Shilling','KGS - Kyrgystani Som','KHR - Cambodian Riel','KMF - Comorian Franc','KPW - North Korean Won','KRW - South Korean Won','KWD - Kuwaiti Dinar','KYD - Cayman Islands Dollar','KZT - Kazakhstani Tenge','LAK - Laotian Kip','LBP - Lebanese Pound','LKR - Sri Lankan Rupee','LRD - Liberian Dollar','LSL - Lesotho Loti','LTL - Lithuanian Litas','LTT - Lithuanian Talonas','LUC - Luxembourgian Convertible Franc','LUF - Luxembourgian Franc','LUL - Luxembourg Financial Franc','LVL - Latvian Lats','LVR - Latvian Ruble','LYD - Libyan Dinar','MAD - Moroccan Dirham','MAF - Moroccan Franc','MCF - Monegasque Franc','MDC - Moldovan Cupon','MDL - Moldovan Leu','MGA - Malagasy Ariary','MGF - Malagasy Franc','MKD - Macedonian Denar','MLF - Malian Franc','MMK - Myanmar Kyat','MNT - Mongolian Tugrik','MOP - Macanese Pataca','MRO - Mauritanian Ouguiya','MTL - Maltese Lira','MTP - Maltese Pound','MUR - Mauritian Rupee','MVR - Maldivian Rufiyaa','MWK - Malawian Kwacha','MXN - Mexican Peso','MXV - Mexican Investment Unit','MYR - Malaysian Ringgit','MZE - Mozambican Escudo','MZN - Mozambican Metical','NAD - Namibian Dollar','NGN - Nigerian Naira','NIO - Nicaraguan C\xF3rdoba','NLG - Dutch Guilder','NOK - Norwegian Krone','NPR - Nepalese Rupee','NZD - New Zealand Dollar','OMR - Omani Rial','PAB - Panamanian Balboa','PEI - Peruvian Inti','PEN - Peruvian Nuevo Sol','PGK - Papua New Guinean Kina','PHP - Philippine Peso','PKR - Pakistani Rupee','PLN - Polish Zloty','PTE - Portuguese Escudo','PYG - Paraguayan Guarani','QAR - Qatari Rial','RHD - Rhodesian Dollar','RON - Romanian Leu','RSD - Serbian Dinar','RUB - Russian Ruble','RWF - Rwandan Franc','SAR - Saudi Riyal','SBD - Solomon Islands Dollar','SCR - Seychellois Rupee','SDG - Sudanese Pound','SEK - Swedish Krona','SGD - Singapore Dollar','SHP - St. Helena Pound','SIT - Slovenian Tolar','SKK - Slovak Koruna','SLL - Sierra Leonean Leone','SOS - Somali Shilling','SRD - Surinamese Dollar','SRG - Surinamese Guilder','SSP - South Sudanese Pound','STD - S\xE3o Tom\xE9 & Pr\xEDncipe Dobra','SUR - Soviet Rouble','SVC - Salvadoran Col\xF3n','SYP - Syrian Pound','SZL - Swazi Lilangeni','THB - Thai Baht','TJR - Tajikistani Ruble','TJS - Tajikistani Somoni','TMT - Turkmenistani Manat','TND - Tunisian Dinar','TOP - Tongan Pa\u02BBanga','TPE - Timorese Escudo','TRY - Turkish Lira','TTD - Trinidad & Tobago Dollar','TWD - New Taiwan Dollar','TZS - Tanzanian Shilling','UAH - Ukrainian Hryvnia','UAK - Ukrainian Karbovanets','UGX - Ugandan Shilling','USD - US Dollar','USN - US Dollar (Next day)','USS - US Dollar (Same day)','UYI - Uruguayan Peso (Indexed Units)','UYU - Uruguayan Peso','UZS - Uzbekistani Som','VEF - Venezuelan Bol\xEDvar','VND - Vietnamese Dong','VUV - Vanuatu Vatu','WST - Samoan Tala','XAF - Central African CFA Franc','XAG - Silver','XAU - Gold','XBA - European Composite Unit','XBB - European Monetary Unit','XBC - European Unit of Account (XBC)','XBD - European Unit of Account (XBD)','XCD - East Caribbean Dollar','XDR - Special Drawing Rights','XEU - European Currency Unit','XFO - French Gold Franc','XFU - French UIC-Franc','XOF - West African CFA Franc','XPD - Palladium','XPF - CFP Franc','XPT - Platinum','XRE - RINET Funds','XSU - Sucre','XTS - Testing Currency Code','XUA - ADB Unit of Account','XXX - Unknown Currency','YDD - Yemeni Dinar','YER - Yemeni Rial','ZAL - South African Rand (financial)','ZAR - South African Rand','ZMW - Zambian Kwacha']}]);'use strict',invoicesUnlimited.controller('ExpenseCategoryController',['$q','$scope','$state','$controller','userFactory','expenseService','coreFactory','expenseCategoryFactory','expenseCategoryService',function(o,r,l,u,y,h,g,C,T){if(!y.entity.length)return console.log('User not logged in'),void 0;if('Sales'==y.entity[0].get('role'))return void l.go('dashboard.sales.invoices.all');var N=y.entity[0],F=N.get('organizations')[0];u('DashboardController',{$scope:r,$state:l}),function(){showLoader(),o.when(g.getExpenseCategories({organization:F})).then(function(U){r.categories=U.sort(function(S,k){return alphabeticalSort(S.entity.name,k.entity.name)}),colorCodeToValue,r,r.shouldDelete=Array(r.categories.length);for(var P=0;P<r.categories.length;++P)r.shouldDelete[P]=!1,r.catColors.push(colorCodeToValue(r.categories[P].entity.get('color')));hideLoader()},function(U){hideLoader(),console.log(U.message)})}(),function(){for(var U=[],P=0;P<colorCount;++P)U.push(colorCodeToValue(P));r.colors=U}(),r.catColors=[],r.deleteCategories=function(){for(var U=r.shouldDelete,P=[],S=0;S<r.categories.length;++S)r.shouldDelete[S]&&P.push(r.categories[S].entity);return 0<P.length?void(showLoader(),Parse.Object.destroyAll(P).then(function(){hideLoader(),window.location.reload()})):void ShowMessage('No category selected!','error')},r.toggleCheck=function(){for(var U=0;U<r.categories.length;++U)r.shouldDelete[U]=r.selectAll},r.setColor=function(U){r.selectedColor=colorCodeToValue(U),r.newCategory&&(r.newCategory.colorCode=U),r.editCategory&&(r.editCategory.colorCode=U)},r.prepareAddCategory=function(){r.selectedColor=colorCodeToValue(0),r.newCategory={name:'',desc:'',colorCode:0},$('#addCategoryForm').validate({rules:{name:'required'}}),$('#addCategoryForm').validate().resetForm()},r.showCategoryDetail=function(U){var P=r.categories[U];r.editCategoryIndex=U,r.selectedColor=colorCodeToValue(P.entity.color),r.editCategory={name:P.entity.name,desc:P.entity.notes,colorCode:P.entity.color},$('#editCategoryForm').validate({rules:{name:'required'}}),$('#editCategoryForm').validate().resetForm(),$('.edit-category').addClass('show')},r.createNewCategory=function(){if($('#addCategoryForm').valid()){showLoader();var U={userID:N,organization:F,name:r.newCategory.name,notes:r.newCategory.desc,color:r.newCategory.colorCode};o.when(g.getUserRole(N)).then(function(P){return T.createNewCategory(U,P)}).then(function(P){r.categories.unshift(P),$('.new-category').removeClass('show'),window.location.reload(),hideLoader()})}},r.saveEditedCategory=function(){if($('#editCategoryForm').valid()){showLoader();var U=r.categories[r.editCategoryIndex];U.entity.set('name',r.editCategory.name),U.entity.set('notes',r.editCategory.desc),U.entity.set('color',r.editCategory.colorCode),o.when(T.saveEditedCategory(U.entity)).then(function(P){r.categories[r.editCategoryIndex]=P,$('.edit-category').removeClass('show'),window.location.reload(),hideLoader()})}}}]);'use strict',invoicesUnlimited.controller('ExpenseController',['$q','$scope','$state','$controller','userFactory','expenseService','coreFactory','taxService','currencyFilter',function(o,r,l,u,y,h,g,C,T){function D(A){A||(A=l.current.name),L.expenses(A)?P():L.details(A)?I():L.newExpense(A)?F():L.edit(A)&&N()}function I(){var A=l.params.expenseId;A&&(showLoader(),o.when(h.getExpenseDetails(A)).then(function(B){B.amount=T(B.entity.amount,'$',2),B.date=formatDate(B.entity.expanseDate,'dddd, MMMM DD, YYYY'),B.attachments?(r.attachments=B.attachments,r.attachments.forEach(function(M){M.fileName=M.name(),M.fileName1=M.fileName.substring(M.fileName.indexOf('_')+1,M.fileName.length),M.fileUrl=M.url()})):r.attachments=[],r.expense=B,hideLoader()},function(B){console.log(B.message),hideLoader()}))}function N(){var A=l.params.expenseId;if(A)return showLoader(),o.when(U()).then(function(){return o.when(h.getExpense(A))}).then(function(B){r.expense=B.entity,r.expenseType={types:[{name:'Non Billable',value:'Non-Billable'},{name:'Billable',value:'Billable'}]};var M='Billable'==B.entity.status?1:0;r.expenseType.selectedType=r.expenseType.types[M],r.todayDate=B.entity.expanseDate,r.amount=B.entity.amount,r.refNumber=B.entity.referenceNumber,r.notes=B.entity.notes,r.selectedCategory=r.categories.filter(function(G){return B.entity.category==G.entity.name})[0];var q=l.params.customerId;if(q)r.selectedCustomer=r.customers.filter(function(G){return q===G.entity.id})[0];else{var O=B.entity.get('customer');O&&(r.selectedCustomer=r.customers.filter(function(G){return O.id==G.entity.id})[0])}B.entity.tax&&(r.selectedTax=r.taxes.filter(function(G){return B.entity.tax.id==G.id})[0]);var H=B.entity.expenseFiles;H?(H.forEach(function(G){G.fileName=G.name(),G.fileName1=G.fileName.substring(G.fileName.indexOf('_')+1,G.fileName.length),G.exist=!0}),r.files=H):r.files=[],hideLoader()})}function F(){showLoader();var A=l.params.expenseId;o.when(U()).then(function(){if(A)o.when(h.getExpense(A)).then(function(q){r.expense=q,r.expenseType={types:[{name:'Non Billable',value:'Non-Billable'},{name:'Billable',value:'Billable'}],selectedType:{name:'Non Billable',value:'Non-Billable'}};var O='Billable'==q.entity.status?1:0;r.expenseType.selectedType=r.expenseType.types[O],r.todayDate=q.entity.expanseDate,r.amount=q.entity.amount,r.refNumber=q.entity.referenceNumber,r.notes=q.entity.notes,r.selectedCategory=r.categories.filter(function(W){return q.entity.category==W.entity.name})[0];var H=q.entity.get('customer');H&&(r.selectedCustomer=r.customers.filter(function(W){return H.id==W.entity.id})[0]),q.entity.tax&&(r.selectedTax=r.taxes.filter(function(W){return q.entity.tax.id==W.id})[0]);var G=q.entity.expenseFiles;G?(G.forEach(function(W){W.fileName=W.name(),W.fileName1=W.fileName.substring(W.fileName.indexOf('_')+1,W.fileName.length),W.exist=!0}),r.files=G):r.files=[]});else{r.expenseType={types:[{name:'Non Billable',value:'Non-Billable'},{name:'Billable',value:'Billable'}],selectedType:{name:'Non Billable',value:'Non-Billable'}};var M=l.params.customerId;M&&(r.expenseType.selectedType=r.expenseType.types[1],r.selectedCustomer=r.customers.filter(function(q){return q.entity.id==M})[0]),r.files=[],r.todayDate=new Date,hideLoader()}})}function U(){var A=[],B=null;return B=o.when(g.getExpenseCategories({organization:k})).then(function(M){r.categories=M.sort(function(q,O){return alphabeticalSort(q.entity.name,O.entity.name)})}),A.push(B),B=C.getTaxes(S,function(M){r.taxes=M}),A.push(B),B=o.when(g.getAllCustomers()).then(function(M){M=M.filter(function(q){return'active'==q.entity.status}),r.customers=M.sort(function(q,O){return alphabeticalSort(q.entity.displayName,O.entity.displayName)}),r.customers.forEach(function(q){q.fullName=q.entity.salutation?q.entity.salutation+' '+q.entity.displayName:q.entity.displayName}),L.newExpense(l.current.name)&&(r.customers=r.customers.concat([createCustomerOpener])),L.edit(l.current.name)&&(r.customers=r.customers.concat([createCustomerOpener]))}),A.push(B),B=o.when(g.getUserRole(S)).then(function(M){r.userRole=M}),A.push(B),o.all(A)}function P(){showLoader(),o.when(h.listExpenses(S)).then(function(A){var B=r.dateFormat.toUpperCase().replace(/E/g,'d');A.forEach(function(M){switch(M.entity.status){case'Non-Billable':M.statusClass='text-color-normalize';break;case'Billable':M.statusClass='text-positive';break;default:M.statusClass='text-danger';}M.entity.get('expenseFiles')&&(M.attachments=M.entity.get('expenseFiles').length),M.expenseDate=formatDate(M.entity.expanseDate,B),M.amount=T(M.entity.amount,'$',2)}),r.expenseList=A,r.allExpenses=A,r.displayedExpenses=A,r.currentExpenses='All Expenses',r.sortByDate(),hideLoader()},function(A){hideLoader(),console.log(A.message)})}if(!y.entity.length)return console.log('User not logged in'),void 0;var S=y.entity[0],k=S.get('organizations')[0];u('DashboardController',{$scope:r,$state:l});var L={details:function(A){return A.endsWith('expenses.details')},expenses:function(A){return A.endsWith('expenses.all')},edit:function(A){return A.endsWith('expenses.edit')},newExpense:function(A){return A.endsWith('expenses.new')}};$('#addExpenseForm').validate({rules:{expCategory:'required',date:'required',amount:{required:!0,min:0.01}},messages:{expCategory:'Please select an expense category',date:'Please specify expense date',amount:{required:'Please enter expense amount'}}});var E=y.entity[0].currency.attributes;if(E.exchangeRate)r.currentCurrency=E;else{var R={currencySymbol:'$',exchangeRate:1};r.currentCurrency=R,E=R}y.getField('dateFormat').then(function(A){r.dateFormat=A,o.when(y.entity[0].currency.fetch()).then(function(B){if(E=B.attributes,E.exchangeRate)r.currentCurrency=E;else{var M={currencySymbol:'$',exchangeRate:1};r.currentCurrency=M,E=M}D()})}),$('#editExpenseForm').validate({rules:{expCategory:'required',date:'required',amount:{required:!0,min:0.01}},messages:{expCategory:'Please select an expense category',date:'Please specify expense date',amount:{required:'Please enter expense amount'},customer:'Please select a customer'}}),r.dateOptions={showWeeks:!1},r.cloneExpense=function(A){l.go('dashboard.expenses.new',{expenseId:A})},r.sortByCatName=function(){'none'===$('#catname').css('display')?(r.expenseList.sort(function(A,B){return A.entity.category.localeCompare(B.entity.category)}),$('#catname').css({display:'inline-table'}),$('#catnameUp').css({display:'none'})):(r.expenseList.sort(function(A,B){return B.entity.category.localeCompare(A.entity.category)}),$('#catnameUp').css({display:'inline-table'}),$('#catname').css({display:'none'})),$('#date').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByDate=function(){'none'===$('#dateUp').css('display')?(r.expenseList.sort(function(A,B){return B.entity.expanseDate>A.entity.expanseDate?-1:B.entity.expanseDate<A.entity.expanseDate?1:0}),$('#dateUp').css({display:'inline-table'}),$('#date').css({display:'none'})):(r.expenseList.sort(function(A,B){return A.entity.expanseDate>B.entity.expanseDate?-1:A.entity.expanseDate<B.entity.expanseDate?1:0}),$('#date').css({display:'inline-table'}),$('#dateUp').css({display:'none'})),$('#catname').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#catnameUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByReferenceNumber=function(){'none'===$('#refno').css('display')?(r.expenseList.sort(function(A,B){return A.entity.referenceNumber.localeCompare(B.entity.referenceNumber)}),$('#refno').css({display:'inline-table'}),$('#refnoUp').css({display:'none'})):(r.expenseList.sort(function(A,B){return B.entity.referenceNumber.localeCompare(A.entity.referenceNumber)}),$('#refnoUp').css({display:'inline-table'}),$('#refno').css({display:'none'})),$('#date').css({display:'none'}),$('#catname').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#catnameUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByCustomerName=function(){'none'===$('#cusname').css('display')?(r.expenseList.sort(function(A,B){return A.customer.displayName.localeCompare(B.customer.displayName)}),$('#cusname').css({display:'inline-table'}),$('#cusnameUp').css({display:'none'})):(r.expenseList.sort(function(A,B){return B.customer.displayName.localeCompare(A.customer.displayName)}),$('#cusnameUp').css({display:'inline-table'}),$('#cusname').css({display:'none'})),$('#date').css({display:'none'}),$('#catname').css({display:'none'}),$('#refno').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#catnameUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByStatus=function(){'none'===$('#status').css('display')?(r.expenseList.sort(function(A,B){return A.entity.status.localeCompare(B.entity.status)}),$('#status').css({display:'inline-table'}),$('#statusUp').css({display:'none'})):(r.expenseList.sort(function(A,B){return B.entity.status.localeCompare(A.entity.status)}),$('#statusUp').css({display:'inline-table'}),$('#status').css({display:'none'})),$('#date').css({display:'none'}),$('#catname').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#catnameUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByAmount=function(){r.expenseList.sort(function(A,B){return B.entity.get('amount')-A.entity.get('amount')}),'none'===$('#amount').css('display')?(r.expenseList.sort(function(A,B){return B.entity.get('amount')-A.entity.get('amount')}),$('#amount').css({display:'inline-table'}),$('#amountUp').css({display:'none'})):(r.expenseList.sort(function(A,B){return A.entity.get('amount')-B.entity.get('amount')}),$('#amountUp').css({display:'inline-table'}),$('#amount').css({display:'none'})),$('#date').css({display:'none'}),$('#catname').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#catnameUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'})},r.deleteExpense=function(){r.expense&&(showLoader(),r.expense.entity.destroy().then(function(){hideLoader(),l.go('dashboard.expenses.all')}))},r.showMenu=function(){$('.filtermenu').hasClass('show')?$('.filtermenu').removeClass('show'):$('.filtermenu').addClass('show')},r.billableExpenses=function(){r.expenseList=r.allExpenses.filter(function(A){return'Billable'==A.entity.status}),r.displayedExpenses=r.expenseList,r.currentExpenses='Billable Expenses',$('.filtermenu').removeClass('show')},r.nonBillableExpenses=function(){r.expenseList=r.allExpenses.filter(function(A){return'Non-Billable'==A.entity.status}),r.displayedExpenses=r.expenseList,r.currentExpenses='Non-Billable Expenses',$('.filtermenu').removeClass('show')},r.invoicedExpenses=function(){r.expenseList=r.allExpenses.filter(function(A){return'Invoiced'==A.entity.status}),r.displayedExpenses=r.expenseList,r.currentExpenses='Invoiced Expenses',$('.filtermenu').removeClass('show')},r.showAllExpenses=function(){r.expenseList=r.allExpenses.filter(function(){return!0}),r.displayedExpenses=r.expenseList,r.currentExpenses='All Expenses',$('.filtermenu').removeClass('show')},r.saveNewExpense=function(){if(!$('#addExpenseForm').valid()){var A=$('#addExpenseForm').validate(),B=$(A.errorList[0].element).offset().top-30;return void scrollToOffset(B)}showLoader();var M={userID:S,organization:k,tax:r.selectedTax,amount:r.amount,referenceNumber:r.refNumber,category:r.selectedCategory.entity.name,expanseDate:r.todayDate,notes:r.notes,status:r.expenseType.selectedType.value,currency:'USD - US Dollar'};r.selectedCustomer&&(M.customer=r.selectedCustomer.entity),M.billable='Billable'==M.status?'Yes':'No',h.createNewExpense(M,r.userRole,r.files).then(function(q){hideLoader(),console.log(q),l.go('dashboard.expenses.all')},function(q){hideLoader(),console.log(q.message)})},r.saveEditedExpense=function(){if(!$('#editExpenseForm').valid()){var A=$('#editExpenseForm').validate(),B=$(A.errorList[0].element).offset().top-30;return void scrollToOffset(B)}showLoader();var M=r.expense;M.set('tax',r.selectedTax),M.set('amount',r.amount),M.set('referenceNumber',r.refNumber),M.set('category',r.selectedCategory.entity.name),M.set('expanseDate',r.todayDate),M.set('notes',r.notes),M.set('status',r.expenseType.selectedType.value),r.selectedCustomer?M.set('customer',r.selectedCustomer.entity):M.unset('customer'),'Billable'==r.expenseType.selectedType.value?M.set('billable','Yes'):M.set('billable','No'),h.updateExpense(M,r.files).then(function(q){console.log(q),hideLoader(),l.go('dashboard.expenses.all')},function(q){hideLoader(),console.log(q.message)})},r.cancel=function(){l.go('dashboard.expenses.all')},r.addNewFile=function(A){var B=A.files[0];B.fileName=B.name,B.fileName1=B.fileName.substring(B.fileName.indexOf('_')+1,B.fileName.length),r.files.push(B),r.$$phase||r.$apply()},r.removeFile=function(A){r.files.splice(A,1)},r.customerSelected=function(){return L.newExpense(l.current.name)&&r.selectedCustomer.dummy?void l.go('dashboard.customers.new',{backLink:l.current.name}):L.edit(l.current.name)&&r.selectedCustomer.dummy?void l.go('dashboard.customers.new',{backLink:l.current.name,expenseId:l.params.expenseId}):void(!r.selectedCustomer&&(r.expenseType.selectedType=r.expenseType.types[0]))},r.openDatePicker=function(A){1===A?r.openPicker1=!0:void 0},r.addAttachment=function(A){var B=A.files[0];if(B){showLoader();var M=r.expense.entity,q=new Parse.File(B.name,B);o.when(q.save()).then(function(O){var H=M.get('expenseFiles');return H?H.push(O):H=[O],M.set('expenseFiles',H),M.save()}).then(function(){l.reload(),hideLoader()})}},r.search=function(){r.expenseList=r.searchText.length?r.displayedExpenses.filter(function(A){return A.entity.referenceNumber||(A.entity.referenceNumber=''),A.expenseDate||(A.expenseDate=''),A.entity.category||(A.entity.category=''),A.entity.referenceNumber||(A.entity.referenceNumber=''),A.customer||(A.customer=''),A.entity.status||(A.entity.status=''),A.amount||(A.amount=''),A.customer?A.expenseDate.toLowerCase().includes(r.searchText.toLowerCase())||A.entity.category.toLowerCase().includes(r.searchText.toLowerCase())||A.entity.referenceNumber.toString().toLowerCase().includes(r.searchText.toLowerCase())||A.customer.displayName.toLowerCase().includes(r.searchText.toLowerCase())||A.entity.status.toLowerCase().includes(r.searchText.toLowerCase())||A.amount.toLowerCase().includes(r.searchText.toLowerCase()):A.expenseDate.toLowerCase().includes(r.searchText.toLowerCase())||A.entity.category.toLowerCase().includes(r.searchText.toLowerCase())||A.entity.referenceNumber.toString().toLowerCase().includes(r.searchText.toLowerCase())||A.entity.status.toLowerCase().includes(r.searchText.toLowerCase())||A.amount.toLowerCase().includes(r.searchText.toLowerCase())}):r.displayedExpenses}}]);'use strict',invoicesUnlimited.controller('CloneProjectController',['$scope','$state','$controller','$q','userFactory','projectService','coreFactory','taxService','commentFactory','taskFactory','currencyFilter','projectUserFactory','appFields','$uibModal',function(o,r,l,u,y,h,g,C,T,D,I,N,F,U,P,S,k,L){function A(){var _=r.params.projectId;_&&(showLoader(),u.when(K()).then(function(){return u.when(h.getProject(_))}).then(function(Y){return console.log(Y),o.project=Y,o.project.entity=Y.entity.clone(),o.selectedCustomer=o.customers.filter(function(X){return Y.entity.get('customer').id==X.entity.id})[0],u.when(O())}).then(function(){B()},function(Y){hideLoader(),console.log(Y.message)}))}function B(){var _=o.project;o.projectName=_.entity.get('projectName'),o.projectDescription=_.entity.get('projectDescription')||'',o.billingMethod=_.entity.get('billingMethod'),o.projectBillingHours=_.entity.get('projectBillingHours')||0,o.projectBillingAmount=_.entity.get('projectBillingAmount')||0,o.hasBudget=_.entity.get('hasBudget')?1:0,o.budgetType=_.entity.get('budgetType'),o.projectBudgetCost=_.entity.get('projectBudgetCost')||0,o.projectBudgetHours=_.entity.get('projectBudgetHours')||0,o.tasks=_.tasks,o.staffUsers=_.users,o.timesheets=[],_.timesheets.forEach(function(Y){var X=o.dateFormat.toUpperCase().replace(/E/g,'d');Y.date=formatDate(Y.attributes.date,X),o.timesheets.push(Y);var Z=Y.get('hoursSpent'),J=Y.get('minutesSpent');Z=10>Z?'0'+Z:''+Z,J=10>J?'0'+J:''+J,Y.hours=Z,Y.minutes=J}),o.timesheetTasks=[],_.tasks.forEach(function(Y){o.timesheetTasks.push(Y)}),o.timesheetTasks.push(createTaskOpener),o.timesheetDate=new Date,hideLoader()}function M(){var _=o.project.entity;_.set('customer',o.selectedCustomer.entity),_.set('projectName',o.projectName),_.set('projectDescription',o.projectDescription),_.set('billingMethod',o.billingMethod),_.set('projectBillingHours',o.projectBillingHours),_.set('projectBillingAmount',o.projectBillingAmount);var Y=[];return o.tasks.forEach(function(X){X.entity?Y.push(X.entity):Y.push(X)}),_.set('tasks',angular.copy(Y)),1==o.hasBudget?(_.set('hasBudget',!0),_.set('budgetType',o.budgetType),_.set('projectBudgetCost',o.projectBudgetCost),_.set('projectBudgetHours',o.projectBudgetHours)):_.set('hasBudget',!1),h.updateProject(o.project,L,o.userRole,o.timesheets,o.staffUsers).then(function(X){return X})}function q(){var _=$('#editProjectForm').validate();_.showErrors({projectName:'Project with this name already exists'})}function O(){}function W(){var _=U.open({animation:!0,templateUrl:'modal-user',controller:'NewUserController',backdrop:!0,appendTo:angular.element(document.querySelector('#view')),windowTemplateUrl:'modal-window',resolve:{user:function(){var Y=Parse.Object.extend(Parse.User),X=new Y;return setObjectOperations({object:X,fields:F.user}),X},method:function(){return'create'},title:function(){return'Add User'}}});_.result.then(function(Y){setObjectOperations({object:Y,fields:F.user});N.createNew({emailID:Y.email,role:Y.role,userName:Y.username,country:Y.country,title:Y.fullName,organization:Y.selectedOrganization,companyName:Y.company,userID:y.entity[0],status:'Activated'}).then(function(Z){o.$apply(function(){o.users.pop(),o.users.push(Z),o.users.push(createUserOpener),o.fromTimesheet?o.timesheetUser=Z:o.newUser=Z,o.fromTimesheet=!1})},function(Z){console.log(Z.message)})},function(){console.log('Dismiss modal')})}function K(){var _=[],Y=null;return Y=u.when(g.getAllCustomers()).then(function(X){o.customers=X.sort(function(Z,J){return alphabeticalSort(Z.entity.displayName,J.entity.displayName)})}),_.push(Y),Y=u.when(N.getAll()).then(function(X){o.users=X.map(function(J){return setObjectOperations({object:J,fields:F.projectUser}),J}),o.users.push(createUserOpener)}),_.push(Y),Y=u.when(g.getUserRole(L)).then(function(X){o.userRole=X}),_.push(Y),u.all(_)}if(!y.entity.length)return console.log('User not logged in'),void 0;var L=y.entity[0],V=L.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),$('#editProjectForm').validate({rules:{customer:'required',projectName:'required',billingMethod:'required',projectBillingHours:'required',projectBillingAmount:'required',budgetType:'required',projectBudgetCost:'required',projectBudgetHours:'required'},messages:{customer:'Please select a customer',projectName:'Please enter project name',billingMethod:'Please select a billing method',projectBillingHours:'Please enter Rate/Hour',projectBillingAmount:'Please enter Project Cost',budgetType:'Please select budget type',projectBudgetCost:'Please enter amount',projectBudgetHours:'Please enter hours'}}),$('#addTimesheetForm').validate({rules:{timesheetDate:'required',timesheetHours:'required',timesheetMinutes:'required',timesheetUser:'required',timesheetTask:'required'},messages:{timesheetDate:'Please select a date',timesheetHours:'Please enter hours',timesheetMinutes:'Please enter minutes',timesheetUser:'Please select user',timesheetTask:'Please select task'}}),$('#editTimesheetForm').validate({rules:{editTimesheetDate:'required',editTimesheetHours:'required',editTimesheetMinutes:'required',editTimesheetUser:'required',editTimesheetTask:'required'},messages:{editTimesheetDate:'Please select a date',editTimesheetHours:'Please enter hours',editTimesheetMinutes:'Please enter minutes',editTimesheetUser:'Please select user',editTimesheetTask:'Please select task'}}),$('#addTaskForm').validate({rules:{newTaskName:'required'},messages:{newTaskName:'Please enter task name'}}),$('#editTaskForm').validate({rules:{editTaskName:'required'},messages:{editTaskName:'Please enter task name'}}),$('#addUserForm').validate({rules:{newUser:'required'},messages:{newTaskName:'Please select a user'}}),showLoader(),y.getField('dateFormat').then(function(_){o.dateFormat=_,A()}),o.dateOptions={showWeeks:!1},o.editTask=function(_){o.selectedTaskIndex=_,o.tasks[_].entity?(o.editTaskName=o.tasks[_].entity.taskName,o.editTaskDescription=o.tasks[_].entity.taskDescription,o.editTaskCost=o.tasks[_].entity.taskCost):(o.editTaskName=o.tasks[_].attributes.taskName,o.editTaskDescription=o.tasks[_].attributes.taskDescription,o.editTaskCost=o.tasks[_].attributes.taskCost),$('.edit-task').addClass('show')},o.updateTask=function(){if($('#editTaskForm').valid()){var _=o.selectedTaskIndex;showLoader(),o.tasks[_].entity?(o.tasks[_].entity.taskName=o.editTaskName,o.tasks[_].entity.taskDescription=o.editTaskDescription,o.tasks[_].entity.taskCost=o.editTaskCost,o.tasks[_].entity.save().then(function(){$('.edit-task').removeClass('show'),hideLoader()})):(o.tasks[_].attributes.taskName=o.editTaskName,o.tasks[_].attributes.taskDescription=o.editTaskDescription,o.tasks[_].attributes.taskCost=o.editTaskCost,o.tasks[_].save().then(function(){$('.edit-task').removeClass('show'),hideLoader()}))}},o.editTimesheet=function(_){o.selectedTimesheetIndex=_,o.selectedTimesheetList=o.timesheets[_],o.editTimesheetTask=new D(o.timesheets[_].attributes.task),setObjectOperations({object:o.timesheets[_].attributes.user,fields:F.projectUser}),o.staffUsers.forEach(function(X){X.user.userName==o.timesheets[_].attributes.user.userName&&(o.timesheetUser=X)});var Y=o.dateFormat.toUpperCase().replace(/E/g,'d');o.editTimesheetDate=formatDate(o.timesheets[_].date,Y),o.editTimesheetDescription=o.timesheets[_].attributes.notes,o.editTimesheetHours=parseInt(o.timesheets[_].hours),o.editTimesheetMinutes=parseInt(o.timesheets[_].minutes),$('.edit-timesheet').addClass('show')},o.updateTimesheet=function(){var _=o.selectedTimesheetIndex;showLoader(),o.timesheets[_].set('date',o.timesheetDate),o.timesheets[_].set('task',o.editTimesheetTask.entity),o.timesheets[_].set('user',o.timesheetUser);var Y=new Date;Y.subtractHours(o.editTimesheetHours),Y.subtractMinutes(o.editTimesheetMinutes);var Z=10>o.editTimesheetHours?'0'+o.editTimesheetHours:''+o.editTimesheetHours,J=10>o.editTimesheetMinutes?'0'+o.editTimesheetMinutes:''+o.editTimesheetMinutes;o.timesheets[_].set('timeSpent',Y),o.timesheets[_].hours=Z,o.timesheets[_].minutes=J,o.timesheets[_].set('notes',o.timesheetDescription),o.timesheets[_].save().then(function(){$('.edit-timesheet').removeClass('show'),hideLoader()})},o.addTimesheet=function(){$('.new-timesheet').addClass('show')},o.saveTimesheet=function(){if($('#addTimesheetForm').valid()){var _=o.dateFormat.toUpperCase().replace(/E/g,'d'),Y;Y=o.timesheetTask.entity?o.timesheetTask.entity:o.timesheetTask;var X=new Date;X.subtractHours(o.timesheetHours),X.subtractMinutes(o.timesheetMinutes),o.timesheets.push({user:o.timesheetUser.attributes.chosenUser||o.timesheetUser,task:Y,date:formatDate(o.timesheetDate,_),sheetDate:o.timesheetDate,notes:o.timesheetDescription,timeSpent:X,hours:10>o.timesheetHours?'0'+o.timesheetHours:''+o.timesheetHours,minutes:10>o.timesheetMinutes?'0'+o.timesheetMinutes:''+o.timesheetMinutes,hoursSpent:o.timesheetHours,minutesSpent:o.timesheetMinutes}),o.timesheetUser='',o.timesheetTask='',o.timesheetDate=new Date,o.timesheetDescription='',$('.new-timesheet').removeClass('show')}},o.removeTimesheet=function(_){o.timesheets.splice(_,1)},o.removeTask=function(_){o.tasks.splice(_,1),o.timesheetTasks.splice(_,1),o.timesheetTask='',o.$$phase||o.$apply()},o.addTask=function(){$('.new-task').addClass('show'),o.fromTimesheet=!1},o.taskChanged=function(){o.timesheetTask.dummy&&(o.fromTimesheet=!0,o.timesheetTask='',$('.new-task').addClass('show'))},o.addNewTask=function(){if($('#addTaskForm').valid()){showLoader();var _=new Parse.ACL;_.setPublicReadAccess(!0),_.setPublicWriteAccess(!0);var Y=Parse.Object.extend('Task'),X=new Y;return X.set('userID',L),X.set('organization',V),X.setACL(_),X.set('taskName',o.newTaskName),X.set('taskDescription',o.newTaskDescription),X.set('taskCost',o.newTaskCost),X.save().then(function(Z){Z=new D(Z),o.tasks.push(Z),o.timesheetTasks.pop(),o.timesheetTasks.push(Z),o.timesheetTasks.push(createTaskOpener),o.fromTimesheet&&(o.timesheetTask=Z),$('.new-task').removeClass('show'),o.newTaskName='',o.newTaskDescription='',o.newTaskCost='',o.$$phase||o.$apply(),hideLoader()})}},o.addNewUser=function(){$('#addUserForm').valid()&&(o.staffUsers.push({user:o.newUser,staffHours:o.staffHours}),$('.add-user').removeClass('show'))},o.removeUser=function(_){o.staffUsers.splice(_,1)},o.addUser=function(){$('.add-user').addClass('show')},o.openDatePicker=function(_){1===_?o.openPicker1=!0:2===_?o.openPicker2=!0:void 0},o.saveProject=function(){$('#editProjectForm').valid()&&(showLoader(),u.when(h.checkProjectNameAvailable({projectName:o.projectName,organization:V})).then(function(_){return _?void M().then(function(Y){hideLoader(),console.log(Y),r.go('dashboard.projects.details',{projectId:Y.id})},function(Y){hideLoader(),console.log(Y.message)}):(hideLoader(),q(),scrollToOffset(),Promise.reject('Project with this name already exists'))}))},o.cancel=function(){r.go('dashboard.projects.all')},o.userChanged=function(){if(o.newUser.dummy)return o.fromTimesheet=!1,W(),void(o.newUser='')},o.timesheetUserChanged=function(){if(o.timesheetUser.dummy)return o.fromTimesheet=!0,W(),void(o.newUser='')},o.customerChanged=function(){}}]);'use strict',invoicesUnlimited.controller('CreateProjectController',['$scope','$state','$controller','$q','userFactory','projectService','coreFactory','taxService','commentFactory','currencyFilter','projectUserFactory','appFields','$uibModal',function(o,r,l,u,y,h,g,C,T,D,I,N,F,U,P,S,k){function A(){o.projectUsers=[],o.tasks=[],o.timesheetTasks=[],o.timesheetTasks.push(createTaskOpener),o.timesheets=[],o.timesheetDate=new Date,o.hasBudget=0;for(var K=r.params.customerId,V=0,_;V<o.users.length;++V)_=k.get('username'),o.users[V].userName==_&&(o.projectUsers.push({user:o.users[V]}),o.users.splice(V,1));K&&(o.selectedCustomer=o.customers.filter(function(Y){return Y.entity.id==K})[0],B()),hideLoader()}function B(){if(o.selectedCustomer.dummy)return void r.go('dashboard.customers.new',{backLink:r.current.name})}function q(){var K=F.open({animation:!0,templateUrl:'modal-user',controller:'NewUserController',backdrop:!0,appendTo:angular.element(document.querySelector('#view')),windowTemplateUrl:'modal-window',resolve:{user:function(){var V=Parse.Object.extend(Parse.User),_=new V;return setObjectOperations({object:_,fields:N.user}),_},method:function(){return'create'},title:function(){return'Add User'}}});K.result.then(function(V){setObjectOperations({object:V,fields:N.user});I.createNew({emailID:V.email,role:V.role,userName:V.username,country:V.country,title:V.fullName,organization:V.selectedOrganization,companyName:V.company,userID:y.entity[0],status:'Activated'}).then(function(Y){o.$apply(function(){o.users.pop(),o.users.push(Y),o.users.push(createUserOpener),o.newUser=Y})},function(Y){console.log(Y.message)})},function(){console.log('Dismiss modal')})}function O(){var K=$('#addProjectForm').validate();K.showErrors({projectName:'Project with this name already exists'})}if(!y.entity.length)return console.log('User not logged in'),void 0;var k=y.entity[0],W=k.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){showLoader();var K=[],V=null;V=u.when(g.getAllCustomers()).then(function(_){_=_.filter(function(Y){return'active'==Y.entity.status}),o.customers=_.sort(function(Y,X){return alphabeticalSort(Y.entity.displayName,X.entity.displayName)}),o.customers.forEach(function(Y){Y.fullName=Y.entity.salutation?Y.entity.salutation+' '+Y.entity.displayName:Y.entity.displayName}),o.customers.push(createCustomerOpener)}),K.push(V),V=u.when(I.getAll()).then(function(_){o.users=_.map(function(X){return setObjectOperations({object:X,fields:N.projectUser}),X}),o.users.push(createUserOpener)}),K.push(V),V=u.when(g.getUserRole(k)).then(function(_){o.userRole=_}),K.push(V),V=y.getField('dateFormat').then(function(_){o.dateFormat=_}),K.push(V),u.all(K).then(function(){A()},function(_){hideLoader(),console.log(_.message)})}(),$('#addProjectForm').validate({rules:{customer:'required',projectName:'required',billingMethod:'required',projectBillingHours:'required',projectBillingAmount:'required',budgetType:'required',projectBudgetCost:'required',projectBudgetHours:'required'},messages:{customer:'Please select a customer',projectName:'Please enter project name',billingMethod:'Please select a billing method',projectBillingHours:'Please enter Rate/Hour',projectBillingAmount:'Please enter Project Cost',budgetType:'Please select budget type',projectBudgetCost:'Please enter amount',projectBudgetHours:'Please enter hours'}}),$('#addTimesheetForm').validate({rules:{timesheetDate:'required',timesheetHours:{required:!0,digits:!0,min:0},timesheetMinutes:{required:!0,digits:!0,min:0,max:59},timesheetUser:'required',timeSheetTask:'required'},messages:{timesheetDate:'Please select a date',timesheetHours:{required:'Please enter hours',digits:'Enter valid hours',min:'Please enter valid hours'},timesheetMinutes:{required:'Please enter minutes',digits:'Enter valid minutes',min:'Please enter valid minutes',max:'Minutes must be less than 60'},timesheetUser:'Please select user',timeSheetTask:'Please select task'}}),$('#addTaskForm').validate({rules:{newTaskName:'required'},messages:{newTaskName:'Please enter task name'}}),$('#addUserForm').validate({rules:{newUser:'required'},messages:{newTaskName:'Please select a user'}}),o.dateOptions={showWeeks:!1},o.openDatePicker=function(K){1===K?o.openPicker1=!0:void 0},o.removeTimesheet=function(K){o.timesheets.splice(K,1)},o.customerChanged=B,o.timeSheetUserChanged=function(){if(o.timesheetUser.dummy)return q(),void(o.timesheetUser='')},o.userChanged=function(){if(o.newUser.dummy)return q(),void(o.newUser='')},o.prepareToEditUser=function(K){o.userIndex=K,o.editUser=o.projectUsers[o.userIndex].user,o.editStaffHours=o.projectUsers[o.userIndex].staffHours,o.editusers=[],angular.copy(o.users,o.editusers),o.editusers.pop(),o.editusers.push(o.editUser),o.editusers.push(createUserOpener),$('.edit-user').addClass('show')},o.updateUser=function(){o.projectUsers[o.userIndex].user=o.editUser,o.projectUsers[o.userIndex].staffHours=o.editStaffHours,$('.edit-user').removeClass('show')},o.saveTimesheet=function(){if($('#addTimesheetForm').valid()){var K=new Date;K.subtractHours(o.timesheetHours),K.subtractMinutes(o.timesheetMinutes);var V=o.timesheetTask.get('taskHours')||0;o.timesheetTask.set('taskHours',o.timesheetHours+o.timesheetMinutes/60+V),o.timesheetTask.save().then(function(){}),o.timesheets.push({user:o.timesheetUser.user,task:o.timesheetTask,date:o.timesheetDate,notes:o.timesheetDescription,timeSpent:K,hours:10>o.timesheetHours?'0'+o.timesheetHours:''+o.timesheetHours,minutes:10>o.timesheetMinutes?'0'+o.timesheetMinutes:''+o.timesheetMinutes,hoursSpent:o.timesheetHours,minutesSpent:o.timesheetMinutes}),o.timesheetUser='',o.timesheetTask='',o.timesheetDate=new Date,o.timesheetDescription='',o.timesheetHours=void 0,o.timesheetMinutes=void 0,$('.new-timesheet').removeClass('show')}},o.$watch('hasBudget',function(K){0==K&&(o.budgetType='')}),o.saveProject=function(){$('#addProjectForm').valid()&&(showLoader(),u.when(h.checkProjectNameAvailable({projectName:o.projectName,organization:W})).then(function(K){if(!K)return hideLoader(),O(),scrollToOffset(),Promise.reject('Project with this name already exists');var V=!1;1==o.hasBudget&&(V=!0);var _={userID:k,organization:W,customer:o.selectedCustomer.entity,projectName:o.projectName,projectDescription:o.projectDescription,billingMethod:o.billingMethod,hasBudget:V,projectBillingAmount:o.projectBillingAmount,projectBillingHours:o.projectBillingHours,budgetType:o.budgetType,projectBudgetCost:o.projectBudgetCost,projectBudgetHours:o.projectBudgetHours,tasks:o.tasks};return h.createNewProject(_,o.userRole,o.projectUsers,o.timesheets).then(function(){hideLoader(),r.go('dashboard.projects.all')})}))},o.cancel=function(){r.go('dashboard.projects.all')},o.addTask=function(){$('.new-task').addClass('show'),o.fromTimesheet=!1},o.addNewTask=function(){if($('#addTaskForm').valid()){showLoader();var K=new Parse.ACL;K.setPublicReadAccess(!0),K.setPublicWriteAccess(!0);var V=Parse.Object.extend('Task'),_=new V;return _.set('userID',k),_.set('organization',W),_.setACL(K),_.set('taskName',o.newTaskName),_.set('taskDescription',o.newTaskDescription),o.newTaskCost&&_.set('taskCost',o.newTaskCost),_.save().then(function(Y){o.tasks.push(Y),o.timesheetTasks.pop(),o.timesheetTasks.push(Y),o.timesheetTasks.push(createTaskOpener),o.fromTimesheet&&(o.timesheetTask=Y),$('.new-task').removeClass('show'),o.newTaskName='',o.newTaskDescription='',o.newTaskCost='',o.$$phase||o.$apply(),hideLoader()},function(Y){console.log(Y)})}},o.taskChanged=function(){o.timesheetTask.dummy&&(o.fromTimesheet=!0,o.timesheetTask='',$('.new-task').addClass('show'))},o.addTimesheet=function(){$('.new-timesheet').addClass('show')},o.addNewUser=function(){$('#addUserForm').valid()&&(o.projectUsers.push({user:o.newUser,staffHours:o.staffHours}),o.users=o.users.filter(function(K){return K!==o.newUser}),$('.add-user').removeClass('show'))},o.removeUser=function(K){o.users.pop(),o.users.push(o.projectUsers[K].user),o.users.push(createUserOpener),o.projectUsers.splice(K,1)},o.removeTask=function(K){o.tasks.splice(K,1),o.timesheetTasks.splice(K,1),o.timesheetTask='',o.$$phase||o.$apply()},o.addUser=function(){$('.add-user').addClass('show')}}]);'use strict',invoicesUnlimited.controller('ProjectDetailController',['$q','$scope','$state','$sce','$controller','userFactory','projectService','coreFactory','projectUserFactory','commentFactory','currencyFilter','appFields',function(o,r,l,u,y,h,g,C,T,D,I,N){function F(){var R=l.params.projectId;if(R){var A=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'],B=['#0ea81c','#c31e1e'],M=[0,0,0,0,0,0,0,0,0,0,0,0],q=[0,0,0,0,0,0,0,0,0,0,0,0];showLoader(),o.when(g.getProjectDetails(R)).then(function(O){r.project=O.entity,r.customer=O.entity.get('customer'),r.tasks=O.tasks,r.staff=O.users,r.actualProject=O,r.staff&&r.staff.forEach(function(Y){for(var X=0;X<r.users.length;++X)if(r.users[X].id==Y.user.id){r.users.splice(X,1);break}}),r.unbilledHours=0,r.billedHours=0,r.billableHours=0;var H=0,G=0,W=0,K=0,V=0,_=0;O.timesheets?(O.timesheets.forEach(function(Y){var X=Y.get('hoursSpent'),Z=Y.get('minutesSpent');r.staff&&r.staff.forEach(function(ee){if(ee.user.userName==Y.get('user').get('userName')){if(ee.loggedHours?(ee.loggedHours+=X,ee.loggedHours+=parseInt(Math.floor((ee.loggedMinutes+Z)/60)),ee.loggedMinutes=(ee.loggedMinutes+Z)%60):(ee.loggedHours=X+parseInt(Math.floor(Z/60)),ee.loggedMinutes=Z%60,ee.unbilledHours=0,ee.unbilledMinutes=0,ee.unbilledTime='00:00'),!Y.get('isBilled')){ee.unbilledHours+=X,ee.unbilledHours+=parseInt(Math.floor((ee.unbilledMinutes+Z)/60)),ee.unbilledMinutes=(ee.unbilledMinutes+Z)%60;var te=10>ee.unbilledHours?'0'+ee.unbilledHours:ee.unbilledHours+'',se=10>ee.unbilledMinutes?'0'+ee.unbilledMinutes:ee.unbilledMinutes+'';ee.unbilledTime=U(te)+':'+se}var te=10>ee.loggedHours?'0'+ee.loggedHours:ee.loggedHours+'',se=10>ee.loggedMinutes?'0'+ee.loggedMinutes:ee.loggedMinutes+'';ee.loggedTime=U(te)+':'+se}else ee.loggedHours||(ee.loggedHours=0,ee.loggedMinutes=0,ee.loggedTime='00:00',ee.unbilledHours=0,ee.unbilledMinutes=0,ee.unbilledTime='00:00')}),r.tasks&&r.tasks.forEach(function(ee){if(ee.loggedHours||(ee.loggedHours=0,ee.loggedMinutes=0,ee.billedHours=0,ee.billedMinutes=0,ee.unbilledHours=0,ee.unbilledMinutes=0,ee.loggedTime='00:00',ee.billedTime='00:00',ee.unbilledTime='00:00'),ee.entity.id==Y.get('task').id){ee.loggedHours+=X,ee.loggedHours+=parseInt(Math.floor((ee.loggedMinutes+Z)/60)),ee.loggedMinutes=(ee.loggedMinutes+Z)%60;var te=10>ee.loggedHours?'0'+ee.loggedHours:ee.loggedHours+'',se=10>ee.loggedMinutes?'0'+ee.loggedMinutes:ee.loggedMinutes+'';ee.loggedTime=U(te)+':'+se,Y.get('isBilled')?(ee.billedHours+=X,ee.billedHours+=parseInt(Math.floor((ee.billedMinutes+Z)/60)),ee.billedMinutes=(ee.billedMinutes+Z)%60,te=10>ee.billedHours?'0'+ee.billedHours:ee.billedHours+'',se=10>ee.billedMinutes?'0'+ee.billedMinutes:ee.billedMinutes+'',ee.billedTime=U(te)+':'+se):(ee.unbilledHours+=X,ee.unbilledHours+=parseInt(Math.floor((ee.unbilledMinutes+Z)/60)),ee.unbilledMinutes=(ee.unbilledMinutes+Z)%60,te=10>ee.unbilledHours?'0'+ee.unbilledHours:ee.unbilledHours+'',se=10>ee.unbilledMinutes?'0'+ee.unbilledMinutes:ee.unbilledMinutes+'',ee.unbilledTime=U(te)+':'+se)}});var J=Y.get('date'),Q=J.getMonth();M[Q]+=X+parseInt(Math.floor(Z/60)),Y.get('isBilled')?(V+=X,_+=Z):(W+=X,K+=Z,q[Q]+=X+parseInt(Math.floor(Z/60))),X+=parseInt(Math.floor(Z/60)),Z%=60,X=10>X?'0'+X:''+X,Z=10>Z?'0'+Z:''+Z,Y.time=U(X)+':'+Z}),1>O.timesheets.length&&(r.staff&&r.staff.forEach(function(Y){Y.loggedHours||(Y.loggedHours=0,Y.loggedMinutes=0,Y.loggedTime='00:00',Y.unbilledHours=0,Y.unbilledMinutes=0,Y.unbilledTime='00:00')}),r.tasks&&r.tasks.forEach(function(Y){Y.loggedHours||(Y.loggedHours=0,Y.loggedMinutes=0,Y.billedHours=0,Y.billedMinutes=0,Y.unbilledHours=0,Y.unbilledMinutes=0,Y.loggedTime='00:00',Y.billedTime='00:00',Y.unbilledTime='00:00')}))):(r.staff&&r.staff.forEach(function(Y){Y.loggedHours||(Y.loggedHours=0,Y.loggedMinutes=0,Y.loggedTime='00:00',Y.unbilledHours=0,Y.unbilledMinutes=0,Y.unbilledTime='00:00')}),r.tasks&&r.tasks.forEach(function(Y){Y.loggedHours||(Y.loggedHours=0,Y.loggedMinutes=0,Y.billedHours=0,Y.billedMinutes=0,Y.unbilledHours=0,Y.unbilledMinutes=0,Y.loggedTime='00:00',Y.billedTime='00:00',Y.unbilledTime='00:00')})),H=W+V,G=K+_,H+=G/60,G%=60,H=10>H?'0'+Math.floor(H):Math.floor(H),G=10>G?'0'+Math.floor(G):Math.floor(G),r.billableHours=U(H)+':'+G,W+=K/60,K%=60,W=10>W?'0'+Math.floor(W):Math.floor(W),K=10>K?'0'+Math.floor(K):Math.floor(K),r.unbilledHours=U(W)+':'+K,V+=_/60,_%=60,V=10>V?'0'+Math.floor(V):Math.floor(V),_=10>_?'0'+Math.floor(_):Math.floor(_),r.billedHours=U(V)+':'+_,r.timesheets=O.timesheets,'Based on task hours'!=r.project.billingMethod&&$('.task').addClass('tasks-detail'),P(A,M,q,B),hideLoader()})}}function U(R){return R.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')}function P(R,A,B,M){var q=E.get('fiscalYearStart'),O=getrotateCount(q);R.rotate(O),A.rotate(O),B.rotate(O);var H=$('#projectchart'),G=new Chart(H,{type:'bar',data:{labels:R,datasets:[{label:'Billable Hours',backgroundColor:M[0],data:A},{label:'Unbilled Hours',backgroundColor:M[1],data:B}]},options:{responsive:!1,tooltipTemplate:'<%if (labels){%><%=labels%>:: <%}%><%= value %>',tooltips:{mode:'single',custom:function(W){W&&(W.title=[])},callbacks:{label:function(W,K){var V=K.datasets[W.datasetIndex].data[W.index],_=K.labels[W.index];return[W.xLabel+': '+U(parseFloat(V).toFixed(0))]}}},legend:{display:!0,position:'bottom'},scales:{yAxes:[{ticks:{beginAtZero:!0,userCallback:function(W){return U(W.toFixed(2))}}}]}}})}function S(R,A){Parse.Promise.as([]);var B=[],M=Parse.Object.extend('Staff'),q=new M;return q.set('userID',A.user),q.set('organization',A.organization),q.setACL(A.acl),q.set('chosenUser',R),q.set('staffHours',r.staffHours),B.push(q),Parse.Object.saveAll(B).then(function(O){var H=r.project.get('users');H?r.project.set('users',O.concat(H)):r.project.set('users',O),r.project.save().then(function(){$('.add-user').removeClass('show'),hideLoader(),l.reload()})})}function k(R,A){A.timesheets=[],Parse.Promise.as([]);var B=[],M=Parse.Object.extend('Timesheets'),q=new M;return q.set('userID',A.user),q.set('organization',A.organization),q.setACL(A.acl),q.set('user',R.user),q.set('task',R.task),q.set('date',R.date),q.set('notes',R.notes),q.set('hoursSpent',R.hoursSpent),q.set('minutesSpent',R.minutesSpent),B.push(q),Parse.Object.saveAll(B).then(function(O){var H=r.project.get('timeSheets');H?r.project.set('timeSheets',O.concat(H)):r.project.set('timeSheets',O);var H=R.task.get('taskHours')||0;R.task.set('taskHours',r.timesheetHours+r.timesheetMinutes/60+H),R.task.save().then(function(){r.project.save().then(function(){$('.new-timesheet').removeClass('show'),hideLoader(),l.reload()})})})}if(!h.entity.length)return console.log('User not logged in'),void 0;var L=h.entity[0],E=L.get('organizations')[0];y('DashboardController',{$scope:r,$state:l}),C.getUserRole(L).then(function(R){r.userRole=R}),h.getField('dateFormat').then(function(R){r.dateFormat=R}),T.getAll().then(function(R){r.users=R.map(function(A){return setObjectOperations({object:A,fields:N.projectUser}),A}),F()}),$('#addTaskForm').validate({rules:{newTaskName:'required'},messages:{newTaskName:'Please enter task name'}}),$('#addUserForm').validate({rules:{newUser:'required'},messages:{newUser:'Please select a user'}}),$('#addTimesheetForm').validate({rules:{timesheetDate:'required',timesheetHours:{required:!0,digits:!0,min:0},timesheetMinutes:{required:!0,digits:!0,min:0,max:59},timesheetUser:'required',timeSheetTask:'required'},messages:{timesheetDate:'Please select a date',timesheetHours:{required:'Please enter hours',digits:'Enter valid hours',min:'Please enter valid hours'},timesheetMinutes:{required:'Please enter minutes',digits:'Enter valid minutes',min:'Please enter valid minutes',max:'Minutes must be less than 60'},timesheetUser:'Please select user',timeSheetTask:'Please select task'}}),r.dateOptions={showWeeks:!1},r.deleteProjectClicked=function(){$('.confirmation-pop-up').addClass('show')},r.deleteProject=function(){var R=[],A=[];r.staff&&r.staff.forEach(function(O){R.push(O.entity)}),r.tasks&&r.tasks.forEach(function(O){A.push(O.entity)});var B=r.timesheets,M=[],q;q=o.when(Parse.Object.destroyAll(R)).then(function(){}),M.push(q),q=o.when(Parse.Object.destroyAll(A)).then(function(){}),M.push(q),showLoader(),o.all(M).then(function(){r.project.destroy().then(function(){hideLoader(),l.go('dashboard.projects.all')})})},r.prepareToAddTask=function(){$('#addTaskForm')[0].reset()},r.prepareToAddTimesheet=function(){r.timesheetDate=new Date},r.addNewTask=function(){if($('#addTaskForm').valid()){showLoader();var R=new Parse.ACL;R.setPublicReadAccess(!0),R.setPublicWriteAccess(!0);var A=Parse.Object.extend('Task'),B=new A;return B.set('userID',L),B.set('organization',E),B.setACL(R),B.set('taskName',r.newTaskName),B.set('taskDescription',r.newTaskDescription),B.set('taskCost',r.newTaskCost),B.save().then(function(M){var q=r.project.get('tasks');q?q.push(M):(q=[],q.push(M)),r.project.set('tasks',q),r.project.save().then(function(){$('.new-task').removeClass('show'),hideLoader(),window.location.reload()})})}},r.addNewUser=function(){if($('#addUserForm').valid()){showLoader();var R=new Parse.ACL;R.setPublicReadAccess(!0),R.setPublicWriteAccess(!0);var A={user:L,organization:r.project.get('organization'),acl:R};S(r.newUser,A)}},r.openDatePicker=function(R){1===R?r.openPicker1=!0:2===R?r.openPicker2=!0:void 0},r.addToInvoice=function(){r.invoiceDate=new Date,r.dataOnInvoice='1',r.itemName='1',$('.convert-invoice').addClass('show')},r.SavetoInvoice=function(){var R={invoiceDueDate:r.invoiceDate,dataOnInvoice:r.dataOnInvoice,itemNameToShow:r.itemName,project:r.actualProject};l.go('dashboard.sales.invoices.new',{projectId:R})},r.saveTimesheet=function(){if($('#addTimesheetForm').valid()){showLoader();var R=new Parse.ACL;R.setPublicReadAccess(!0),R.setPublicWriteAccess(!0);var A={user:L,organization:r.project.get('organization'),acl:R},B=new Date;B.subtractHours(r.timesheetHours),B.subtractMinutes(r.timesheetMinutes);var M={user:r.timesheetUser.user,task:r.timesheetTask.entity,date:r.timesheetDate,notes:r.timesheetDescription,timeSpent:B,hours:10>r.timesheetHours?'0'+r.timesheetHours:''+r.timesheetHours,minutes:10>r.timesheetMinutes?'0'+r.timesheetMinutes:''+r.timesheetMinutes,hoursSpent:r.timesheetHours,minutesSpent:r.timesheetMinutes};k(M,A),r.timesheetUser='',r.timesheetHours=void 0,r.timesheetMinutes=void 0,r.timesheetTask='',r.timesheetDate=new Date,r.timesheetDescription=''}}}]);'use strict',invoicesUnlimited.controller('ProjectsController',['$q','$scope','$state','$controller','userFactory','projectService','coreFactory','taxService','expenseService','commentFactory','taskFactory','currencyFilter','projectUserFactory','appFields','$uibModal',function(o,r,l,u,y,h,g,C,T,D,I,N,F,U,P,S,k,L,E){function B(Z){Z||(Z=l.current.name),X.projects(Z)?(console.log('its in list'),M()):X.newProject(Z)?console.log('its in new'):X.edit(Z)&&(console.log('its in edit'),q())}function M(){showLoader(),o.when(h.listProjects(E)).then(function(Z){r.projectList=[],r.displayedProject=[],Z.forEach(function(J){J.entity.projectBillingAmount||(J.entity.projectBillingAmount=0)}),'General Employee'==E.get('role')?Z.forEach(function(J){var Q=J.entity.get('users');if(Q)for(var ee=0;ee<Q.length;++ee)if(Q[ee].get('chosenUser').get('userName')==E.get('username')){r.projectList.push(J),r.displayedProject.push(J);break}}):(r.projectList=Z,r.displayedProject=Z),r.sortByLatest(),hideLoader()},function(Z){hideLoader(),console.log(Z.message)})}function q(){var Z=l.params.projectId;Z&&(showLoader(),o.when(_()).then(function(){return o.when(h.getProject(Z))}).then(function(J){return console.log(J),r.project=J,r.selectedCustomer=r.customers.filter(function(Q){return J.entity.get('customer').id==Q.entity.id})[0],o.when(G())}).then(function(){O()},function(J){hideLoader(),console.log(J.message)}))}function O(){var Z=r.project;if(r.projectName=Z.entity.get('projectName'),r.projectDescription=Z.entity.get('projectDescription')||'',r.billingMethod=Z.entity.get('billingMethod'),r.projectBillingHours=Z.entity.get('projectBillingHours')||0,r.projectBillingAmount=Z.entity.get('projectBillingAmount')||0,r.hasBudget=Z.entity.get('hasBudget')?1:0,r.budgetType=Z.entity.get('budgetType'),r.projectBudgetCost=Z.entity.get('projectBudgetCost')||0,r.projectBudgetHours=Z.entity.get('projectBudgetHours')||0,r.projectUsers=[],r.tasks=Z.tasks,r.staffUsers=Z.users,r.staffUsers)for(var J=0;J<r.users.length;++J)for(var Q=0;Q<r.staffUsers.length;++Q)r.users[J].userName==r.staffUsers[Q].user.get('userName')&&r.users.splice(J,1);r.timesheets=[],Z.timesheets&&Z.timesheets.forEach(function(ee){var te=r.dateFormat.toUpperCase().replace(/E/g,'d');ee.date=formatDate(ee.attributes.date,te),r.timesheets.push(ee);var se=ee.get('hoursSpent'),ae=ee.get('minutesSpent');se=10>se?'0'+se:''+se,ae=10>ae?'0'+ae:''+ae,ee.hours=se,ee.minutes=ae}),r.timesheetTasks=[],Z.tasks&&Z.tasks.forEach(function(ee){r.timesheetTasks.push(ee)}),r.timesheetTasks.push(createTaskOpener),r.timesheetDate=new Date,hideLoader()}function H(){var Z=r.project.entity;Z.set('customer',r.selectedCustomer.entity),Z.set('projectName',r.projectName),Z.set('projectDescription',r.projectDescription),Z.set('billingMethod',r.billingMethod),Z.set('projectBillingHours',r.projectBillingHours),Z.set('projectBillingAmount',r.projectBillingAmount);var J=[];return r.tasks.forEach(function(Q){Q.entity?J.push(Q.entity):J.push(Q)}),Z.set('tasks',angular.copy(J)),1==r.hasBudget?(Z.set('hasBudget',!0),Z.set('budgetType',r.budgetType),Z.set('projectBudgetCost',r.projectBudgetCost),Z.set('projectBudgetHours',r.projectBudgetHours)):Z.set('hasBudget',!1),h.updateProject(r.project,E,r.userRole,r.timesheets,r.staffUsers).then(function(Q){return Q})}function G(){}function V(){var Z=P.open({animation:!0,templateUrl:'modal-user',controller:'NewUserController',backdrop:!0,appendTo:angular.element(document.querySelector('#view')),windowTemplateUrl:'modal-window',resolve:{user:function(){var J=Parse.Object.extend(Parse.User),Q=new J;return setObjectOperations({object:Q,fields:U.user}),Q},method:function(){return'create'},title:function(){return'Add User'}}});Z.result.then(function(J){setObjectOperations({object:J,fields:U.user});F.createNew({emailID:J.email,role:J.role,userName:J.username,country:J.country,title:J.fullName,organization:J.selectedOrganization,companyName:J.company,userID:y.entity[0],status:'Activated'}).then(function(ee){r.$apply(function(){r.users.pop(),r.users.push(ee),r.users.push(createUserOpener),r.fromTimesheet?r.timesheetUser=ee:r.newUser=ee,r.fromTimesheet=!1})},function(ee){console.log(ee.message)})},function(){console.log('Dismiss modal')})}function _(){var Z=[],J=null;return J=o.when(g.getAllCustomers()).then(function(Q){r.customers=Q.sort(function(ee,te){return alphabeticalSort(ee.entity.displayName,te.entity.displayName)}),r.customers.forEach(function(ee){ee.fullName=ee.entity.salutation?ee.entity.salutation+' '+ee.entity.displayName:ee.entity.displayName})}),Z.push(J),J=o.when(F.getAll()).then(function(Q){r.users=Q.map(function(te){return setObjectOperations({object:te,fields:U.projectUser}),te}),r.users.push(createUserOpener)}),Z.push(J),J=o.when(g.getUserRole(E)).then(function(Q){r.userRole=Q}),Z.push(J),o.all(Z)}if(!y.entity.length)return console.log('User not logged in'),void 0;var E=y.entity[0],Y=E.get('organizations')[0];u('DashboardController',{$scope:r,$state:l}),$('#editProjectForm').validate({rules:{customer:'required',projectName:'required',billingMethod:'required',projectBillingHours:'required',projectBillingAmount:'required',budgetType:'required',projectBudgetCost:'required',projectBudgetHours:'required'},messages:{customer:'Please select a customer',projectName:'Please enter project name',billingMethod:'Please select a billing method',projectBillingHours:'Please enter Rate/Hour',projectBillingAmount:'Please enter Project Cost',budgetType:'Please select budget type',projectBudgetCost:'Please enter amount',projectBudgetHours:'Please enter hours'}}),$('#addTimesheetForm').validate({rules:{timesheetDate:'required',timesheetHours:{required:!0,digits:!0,min:0},timesheetMinutes:{required:!0,digits:!0,min:0,max:59},timesheetUser:'required',timeSheetTask:'required'},messages:{timesheetDate:'Please select a date',timesheetHours:{required:'Please enter hours',digits:'Enter valid hours',min:'Please enter valid hours'},timesheetMinutes:{required:'Please enter minutes',digits:'Enter valid minutes',min:'Please enter valid minutes',max:'Minutes must be less than 60'},timesheetUser:'Please select user',timeSheetTask:'Please select task'}}),$('#editTimesheetForm').validate({rules:{editTimesheetDate:'required',editTimesheetHours:'required',editTimesheetMinutes:'required',editTimesheetUser:'required',editTimesheetTask:'required'},messages:{editTimesheetDate:'Please select a date',editTimesheetHours:'Please enter hours',editTimesheetMinutes:'Please enter minutes',editTimesheetUser:'Please select user',editTimesheetTask:'Please select task'}}),$('#addTaskForm').validate({rules:{newTaskName:'required'},messages:{newTaskName:'Please enter task name'}}),$('#editTaskForm').validate({rules:{editTaskName:'required'},messages:{editTaskName:'Please enter task name'}}),$('#addUserForm').validate({rules:{newUser:'required'},messages:{newTaskName:'Please select a user'}});var X={details:function(Z){return Z.endsWith('projects.details')},projects:function(Z){return Z.endsWith('projects.all')},edit:function(Z){return Z.endsWith('projects.edit')},newProject:function(Z){return Z.endsWith('projects.new')}};showLoader(),y.getField('dateFormat').then(function(Z){r.dateFormat=Z,B()}),r.dateOptions={showWeeks:!1},r.editTask=function(Z){r.selectedTaskIndex=Z,r.editTaskName=r.tasks[Z].entity.taskName,r.editTaskDescription=r.tasks[Z].entity.taskDescription,r.editTaskCost=r.tasks[Z].entity.taskCost,$('.edit-task').addClass('show')},r.updateTask=function(){if($('#editTaskForm').valid()){var Z=r.selectedTaskIndex;showLoader(),r.tasks[Z].entity.taskName=r.editTaskName,r.tasks[Z].entity.taskDescription=r.editTaskDescription,r.tasks[Z].entity.taskCost=r.editTaskCost,r.tasks[Z].entity.save().then(function(){$('.edit-task').removeClass('show'),hideLoader()})}},r.editTimesheet=function(Z){r.selectedTimesheetIndex=Z,r.selectedTimesheetList=r.timesheets[Z],r.editTimesheetTask=new I(r.timesheets[Z].attributes.task),setObjectOperations({object:r.timesheets[Z].attributes.user,fields:U.projectUser}),r.staffUsers.forEach(function(Q){Q.user.userName==r.timesheets[Z].attributes.user.userName&&(r.timesheetUser=Q)});var J=r.dateFormat.toUpperCase().replace(/E/g,'d');r.editTimesheetDate=formatDate(r.timesheets[Z].date,J),r.editTimesheetDescription=r.timesheets[Z].attributes.notes,r.editTimesheetHours=parseInt(r.timesheets[Z].hours),r.editTimesheetMinutes=parseInt(r.timesheets[Z].minutes),$('.edit-timesheet').addClass('show')},r.updateTimesheet=function(){var Z=r.selectedTimesheetIndex;showLoader(),r.timesheets[Z].set('date',r.timesheetDate),r.timesheets[Z].set('task',r.editTimesheetTask.entity),r.timesheets[Z].set('user',r.timesheetUser.user);var J=new Date;J.subtractHours(r.editTimesheetHours),J.subtractMinutes(r.editTimesheetMinutes);var Q=10>r.editTimesheetHours?'0'+r.editTimesheetHours:''+r.editTimesheetHours,ee=10>r.editTimesheetMinutes?'0'+r.editTimesheetMinutes:''+r.editTimesheetMinutes;r.timesheets[Z].set('hoursSpent',r.editTimesheetHours),r.timesheets[Z].set('minutesSpent',r.editTimesheetMinutes),r.timesheets[Z].hours=Q,r.timesheets[Z].minutes=ee,r.timesheets[Z].set('notes',r.timesheetDescription),r.timesheets[Z].save().then(function(){$('.edit-timesheet').removeClass('show'),hideLoader()})},r.addTimesheet=function(){$('.new-timesheet').addClass('show')},r.saveTimesheet=function(){if($('#addTimesheetForm').valid()){var Z=r.dateFormat.toUpperCase().replace(/E/g,'d'),J;J=r.timesheetTask.entity,r.timesheets.push({user:r.timesheetUser.user,task:J,date:formatDate(r.timesheetDate,Z),sheetDate:r.timesheetDate,notes:r.timesheetDescription,hours:10>r.timesheetHours?'0'+r.timesheetHours:''+r.timesheetHours,minutes:10>r.timesheetMinutes?'0'+r.timesheetMinutes:''+r.timesheetMinutes,hoursSpent:r.timesheetHours,minutesSpent:r.timesheetMinutes}),r.timesheetUser='',r.timesheetTask='',r.timesheetDate=new Date,r.timesheetDescription='',$('.new-timesheet').removeClass('show')}},r.removeTimesheet=function(Z){r.timesheets.splice(Z,1)},r.removeTask=function(Z){r.tasks.splice(Z,1),r.timesheetTasks.splice(Z,1),r.timesheetTask='',r.$$phase||r.$apply()},r.addTask=function(){$('.new-task').addClass('show'),r.fromTimesheet=!1},r.taskChanged=function(){r.timesheetTask.dummy&&(r.fromTimesheet=!0,r.timesheetTask='',$('.new-task').addClass('show'))},r.addNewTask=function(){if($('#addTaskForm').valid()){showLoader();var Z=new Parse.ACL;Z.setPublicReadAccess(!0),Z.setPublicWriteAccess(!0);var J=Parse.Object.extend('Task'),Q=new J;return Q.set('userID',E),Q.set('organization',Y),Q.setACL(Z),Q.set('taskName',r.newTaskName),Q.set('taskDescription',r.newTaskDescription),Q.set('taskCost',r.newTaskCost),Q.save().then(function(ee){ee=new I(ee),r.tasks.push(ee),r.timesheetTasks.pop(),r.timesheetTasks.push(ee),r.timesheetTasks.push(createTaskOpener),r.fromTimesheet&&(r.timesheetTask=ee),$('.new-task').removeClass('show'),r.newTaskName='',r.newTaskDescription='',r.newTaskCost='',r.$$phase||r.$apply(),hideLoader()})}},r.addNewUser=function(){$('#addUserForm').valid()&&(r.staffUsers.push({user:r.newUser,staffHours:r.staffHours}),$('.add-user').removeClass('show'))},r.prepareToEditUser=function(Z){r.userIndex=Z,r.editUser=r.staffUsers[r.userIndex].user,r.editStaffHours=r.staffUsers[r.userIndex].staffHours,r.editusers=[],angular.copy(r.users,r.editusers),r.editusers.pop(),r.editusers.push(r.editUser),r.editusers.push(createUserOpener),$('.edit-user').addClass('show')},r.updateUser=function(){r.staffUsers[r.userIndex].user=r.editUser,r.staffUsers[r.userIndex].staffHours=r.editStaffHours,$('.edit-user').removeClass('show')},r.removeUser=function(Z){r.users.pop(),r.users.push(r.staffUsers[Z].user),r.users.push(createUserOpener),r.staffUsers.splice(Z,1)},r.addUser=function(){$('.add-user').addClass('show')},r.openDatePicker=function(Z){1===Z?r.openPicker1=!0:2===Z?r.openPicker2=!0:void 0},r.saveProject=function(){$('#editProjectForm').valid()&&(showLoader(),H().then(function(Z){hideLoader(),console.log(Z),l.go('dashboard.projects.details',{projectId:Z.id})},function(Z){hideLoader(),console.log(Z.message)}))},r.cancel=function(){l.go('dashboard.projects.all')},r.userChanged=function(){if(r.newUser.dummy)return r.fromTimesheet=!1,V(),void(r.newUser='')},r.sortByLatest=function(){r.projectList.sort(function(Z,J){return Z.entity.createdAt>J.entity.createdAt?-1:Z.entity.createdAt<J.entity.createdAt?1:0})},r.sortByName=function(){'none'===$('#nameD').css('display')?(r.projectList.sort(function(Z,J){return J.entity.projectName.localeCompare(Z.entity.projectName)}),$('#nameD').css({display:'inline-table'}),$('#nameDUp').css({display:'none'})):(r.projectList.sort(function(Z,J){return Z.entity.projectName.localeCompare(J.entity.projectName)}),$('#nameDUp').css({display:'inline-table'}),$('#nameD').css({display:'none'})),$('#custNameD').css({display:'none'}),$('#descD').css({display:'none'}),$('#billMD').css({display:'none'}),$('#priceD').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#descDUp').css({display:'none'}),$('#billMDUp').css({display:'none'}),$('#priceDUp').css({display:'none'})},r.sortByCustomer=function(){'none'===$('#custNameD').css('display')?(r.projectList.sort(function(Z,J){return Z.customer.displayName.localeCompare(J.customer.displayName)}),$('#custNameD').css({display:'inline-table'}),$('#custNameDUp').css({display:'none'})):(r.projectList.sort(function(Z,J){return J.customer.displayName.localeCompare(Z.customer.displayName)}),$('#custNameDUp').css({display:'inline-table'}),$('#custNameD').css({display:'none'})),$('#nameD').css({display:'none'}),$('#descD').css({display:'none'}),$('#billMD').css({display:'none'}),$('#priceD').css({display:'none'}),$('#nameDUp').css({display:'none'}),$('#descDUp').css({display:'none'}),$('#billMDUp').css({display:'none'}),$('#priceDUp').css({display:'none'})},r.timesheetUserChanged=function(){if(r.timesheetUser.dummy)return r.fromTimesheet=!0,V(),void(r.newUser='')},r.sortByDesc=function(){'none'===$('#descD').css('display')?(r.projectList.sort(function(Z,J){return Z.entity.projectDescription||(Z.entity.projectDescription=''),J.entity.projectDescription||(J.entity.projectDescription=''),J.entity.projectDescription.localeCompare(Z.entity.projectDescription)}),$('#descD').css({display:'inline-table'}),$('#descDUp').css({display:'none'})):(r.projectList.sort(function(Z,J){return Z.entity.projectDescription||(Z.entity.projectDescription=''),J.entity.projectDescription||(J.entity.projectDescription=''),Z.entity.projectDescription.localeCompare(J.entity.projectDescription)}),$('#descDUp').css({display:'inline-table'}),$('#descD').css({display:'none'})),$('#nameDUp').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#billMDUp').css({display:'none'}),$('#priceDUp').css({display:'none'}),$('#nameD').css({display:'none'}),$('#custNameD').css({display:'none'}),$('#billMD').css({display:'none'}),$('#priceD').css({display:'none'})},r.sortByBilling=function(){'none'===$('#billMD').css('display')?(r.projectList.sort(function(Z,J){return Z.entity.billingMethod?J.entity.billingMethod?Z.entity.billingMethod.localeCompare(J.entity.billingMethod):1:-1}),$('#billMD').css({display:'inline-table'}),$('#billMDUp').css({display:'none'})):(r.projectList.sort(function(Z,J){return Z.entity.billingMethod?J.entity.billingMethod?J.entity.billingMethod.localeCompare(Z.entity.billingMethod):1:-1}),$('#billMDUp').css({display:'inline-table'}),$('#billMD').css({display:'none'})),$('#nameDUp').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#descDUp').css({display:'none'}),$('#priceDUp').css({display:'none'}),$('#nameD').css({display:'none'}),$('#custNameD').css({display:'none'}),$('#descD').css({display:'none'}),$('#priceD').css({display:'none'})},r.sortByAmount=function(){'none'===$('#priceD').css('display')?(r.projectList.sort(function(Z,J){return Z.entity.projectBillingAmount||(Z.entity.projectBillingAmount=0),J.entity.projectBillingAmount||(J.entity.projectBillingAmount=0),Z.entity.projectBillingAmount-J.entity.projectBillingAmount}),$('#priceD').css({display:'inline-table'}),$('#priceDUp').css({display:'none'})):(r.projectList.sort(function(Z,J){return Z.entity.projectBillingAmount||(Z.entity.projectBillingAmount=0),J.entity.projectBillingAmount||(J.entity.projectBillingAmount=0),J.entity.projectBillingAmount-Z.entity.projectBillingAmount}),$('#priceDUp').css({display:'inline-table'}),$('#priceD').css({display:'none'})),$('#nameDUp').css({display:'none'}),$('#custNameDUp').css({display:'none'}),$('#descDUp').css({display:'none'}),$('#billMDUp').css({display:'none'}),$('#nameD').css({display:'none'}),$('#custNameD').css({display:'none'}),$('#descD').css({display:'none'}),$('#billMD').css({display:'none'})},r.customerChanged=function(){},r.search=function(){r.projectList=r.searchText.length?r.displayedProject.filter(function(Z){return Z.entity.projectName||(Z.entity.projectName=''),Z.customer.displayName||(Z.customer.displayName=''),Z.entity.projectDescription||(Z.entity.projectDescription=''),Z.entity.billingMethod||(Z.entity.billingMethod=''),Z.entity.projectBillingAmount||(Z.entity.projectBillingAmount=''),Z.entity.projectName.toLowerCase().includes(r.searchText.toLowerCase())||Z.customer.displayName.toLowerCase().includes(r.searchText.toLowerCase())||Z.entity.projectDescription.toLowerCase().includes(r.searchText.toLowerCase())||Z.entity.billingMethod.toLowerCase().includes(r.searchText.toLowerCase())||Z.entity.projectBillingAmount.toString().toLowerCase().includes(r.searchText.toLowerCase())}):r.displayedProject}}]);'use strict',invoicesUnlimited.controller('CustomerBalanceController',['$scope','$state','$controller','$q','userFactory','reportsService','reportsCommon','currencyFilter','creditNoteService',function(o,r,l,u,y,h,g,C){if(!y.entity.length)return console.log('User not logged in'),void 0;var I=y.entity[0],N=I.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){o.dateRanges=g.getDateRanges(),o.selectedDateRange=o.dateRanges[1],o.fromDate=new Date,o.fromDate.setHours(0),o.fromDate.setMinutes(0),o.toDate=new Date,y.getField('dateFormat').then(function(F){o.dateFormat=F,o.generateReport()})}(),o.dateOptions={showWeeks:!1},o.dateRangeChanged=function(){g.dateRangeChanged({_scope:o})},o.openDatePicker=function(F){g.openDatePicker({_scope:o,n:F})},o.generateReport=function(){var F=o.toDate,U=new Date,P=o.toDate;showLoader();var S={toDate:o.toDate,organization:N},k=[];k.push(h.customerBalance(S)),k.push(h.customerCredit(S)),u.all(k).then(function(L){var E=L[0],R=L[1],A=[],B={},M=0;E.forEach(function(G){var W=G.customer.id,K=G.entity.balanceDue;B[W]?(B[W].balanceDue+=K,B[W].count+=1):(B[W]={name:G.customer.displayName,balanceDue:K,count:1,availableCredit:0},A.push(W)),M+=K});var q=0;R.forEach(function(G){var W=G.customer.id,K=G.entity.remainingCredits;B[W]?B[W].availableCredit+=K:(B[W]={name:G.customer.displayName,availableCredit:K,balanceDue:0,count:1},A.push(W)),q+=K});var O=0;A.forEach(function(G){console.log('info[id].balanceDue = '+B[G].balanceDue),B[G].customerBalance=B[G].balanceDue-B[G].availableCredit,O+=B[G].customerBalance,B[G].customerBalanceStr=C(B[G].customerBalance,'$',2),B[G].balanceDueStr=C(B[G].balanceDue,'$',2),B[G].availableCreditStr=C(B[G].availableCredit,'$',2)}),o.info=B,o.ids=A,o.totalBalanceStr=C(M,'$',2),o.totalCreditStr=C(q,'$',2),o.totalCustomerBalanceStr=C(O,'$',2);var H=o.dateFormat.toUpperCase().replace(/E/g,'d');o.toDateStr=formatDate(o.toDate,H),o.sortByName(),hideLoader()})},o.sortByName=function(){o.ids.sort(function(F,U){return o.info[F].name.localeCompare(o.info[U].name)}),'none'===$('#name').css('display')?(o.ids.sort(function(F,U){return o.info[F].name.localeCompare(o.info[U].name)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.ids.sort(function(F,U){return o.info[U].name.localeCompare(o.info[F].name)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#credit').css({display:'none'}),$('#balance').css({display:'none'}),$('#creditUp').css({display:'none'}),$('#balanceUp').css({display:'none'}),$('#customerbalance').css({display:'none'}),$('#customerbalanceUp').css({display:'none'})},o.sortByCredit=function(){'none'===$('#credit').css('display')?(o.ids.sort(function(F,U){return o.info[U].availableCredit-o.info[F].availableCredit}),$('#credit').css({display:'inline-table'}),$('#creditUp').css({display:'none'})):(o.ids.sort(function(F,U){return o.info[F].availableCredit-o.info[U].availableCredit}),$('#creditUp').css({display:'inline-table'}),$('#credit').css({display:'none'})),$('#balanceUp').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#balance').css({display:'none'}),$('#name').css({display:'none'}),$('#customerbalance').css({display:'none'}),$('#customerbalanceUp').css({display:'none'})},o.sortByBalance=function(){o.ids.sort(function(F,U){return o.info[U].balanceDue-o.info[F].balanceDue}),'none'===$('#balance').css('display')?(o.ids.sort(function(F,U){return o.info[U].balanceDue-o.info[F].balanceDue}),$('#balance').css({display:'inline-table'}),$('#balanceUp').css({display:'none'})):(o.ids.sort(function(F,U){return o.info[F].balanceDue-o.info[U].balanceDue}),$('#balanceUp').css({display:'inline-table'}),$('#balance').css({display:'none'})),$('#name').css({display:'none'}),$('#credit').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#creditUp').css({display:'none'}),$('#customerbalance').css({display:'none'}),$('#customerbalanceUp').css({display:'none'})},o.sortByCustomerBalance=function(){'none'===$('#customerbalance').css('display')?(o.ids.sort(function(F,U){return o.info[U].customerBalance-o.info[F].customerBalance}),$('#customerbalance').css({display:'inline-table'}),$('#customerbalanceUp').css({display:'none'})):(o.ids.sort(function(F,U){return o.info[F].customerBalance-o.info[U].customerBalance}),$('#customerbalanceUp').css({display:'inline-table'}),$('#customerbalance').css({display:'none'})),$('#balance').css({display:'none'}),$('#name').css({display:'none'}),$('#credit').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#creditUp').css({display:'none'}),$('#balanceUp').css({display:'none'})}}]);'use strict',invoicesUnlimited.controller('ExpenseByCategoryController',['$scope','$state','$controller','$q','userFactory','reportsService','reportsCommon','currencyFilter',function(o,r,l,u,y,h,g,C){if(!y.entity.length)return console.log('User not logged in'),void 0;var D=y.entity[0],I=D.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){o.dateRanges=g.getDateRanges(),o.selectedDateRange=o.dateRanges[1],o.fromDate=new Date,o.fromDate.setHours(0),o.fromDate.setMinutes(0),o.toDate=new Date,y.getField('dateFormat').then(function(N){o.dateFormat=N,o.generateReport()})}(),o.dateOptions={showWeeks:!1},o.dateRangeChanged=function(){g.dateRangeChanged({_scope:o})},o.openDatePicker=function(N){g.openDatePicker({_scope:o,n:N})},o.generateReport=function(){var N=o.toDate,F=new Date,U=o.fromDate,P=o.toDate;if(N>F)return ShowMessage('Select a valid Date!','error'),!1;if(U>P)return ShowMessage('The from date can\'t be after the to date.','error'),!1;showLoader();var S={fromDate:o.fromDate,toDate:o.toDate,organization:I};u.when(h.expenseByCategory(S)).then(function(k){var L=[],E={},R=0;k.forEach(function(B){var M=B.get('category'),q=B.get('amount');R+=q,E[M]?(E[M].amount+=q,E[M].count+=1):(L.push(M),E[M]={amount:q,count:1})}),L.forEach(function(B){E[B].amountStr=C(E[B].amount,'$',2)}),o.categories=L,o.info=E;var A=o.dateFormat.toUpperCase().replace(/E/g,'d');o.totalStr=C(R,'$',2),o.fromDateStr=formatDate(o.fromDate,A),o.toDateStr=formatDate(o.toDate,A),o.sortByName(),hideLoader()})},o.sortByName=function(){'none'===$('#name').css('display')?(o.categories.sort(function(N,F){return N.localeCompare(F)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.categories.sort(function(N,F){return F.localeCompare(N)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#count').css({display:'none'}),$('#amount').css({display:'none'}),$('#countUp').css({display:'none'}),$('#amountUp').css({display:'none'})},o.sortByCount=function(){'none'===$('#count').css('display')?(o.categories.sort(function(N,F){return o.info[F].count-o.info[N].count}),$('#count').css({display:'inline-table'}),$('#countUp').css({display:'none'})):(o.categories.sort(function(N,F){return o.info[N].count-o.info[F].count}),$('#countUp').css({display:'inline-table'}),$('#count').css({display:'none'})),$('#name').css({display:'none'}),$('#amount').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#amountUp').css({display:'none'})},o.sortByAmount=function(){'none'===$('#amount').css('display')?(o.categories.sort(function(N,F){return o.info[F].amount-o.info[N].amount}),$('#amount').css({display:'inline-table'}),$('#amountUp').css({display:'none'})):(o.categories.sort(function(N,F){return o.info[N].amount-o.info[F].amount}),$('#amountUp').css({display:'inline-table'}),$('#amount').css({display:'none'})),$('#name').css({display:'none'}),$('#count').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#countUp').css({display:'none'})}}]);'use strict',invoicesUnlimited.controller('InvoiceAgingController',['$scope','$state','$controller','$q','userFactory','reportsService','reportsCommon','currencyFilter',function(o,r,l,u,y,h,g,C){if(!y.entity.length)return console.log('User not logged in'),void 0;var D=y.entity[0],I=D.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){o.dateRanges=g.getDateRanges(),o.selectedDateRange=o.dateRanges[1],o.fromDate=new Date,o.fromDate.setHours(0),o.fromDate.setMinutes(0),o.toDate=new Date,y.getField('dateFormat').then(function(N){o.dateFormat=N,o.generateReport()})}(),o.dateRangeChanged=function(){g.dateRangeChanged({_scope:o})},o.openDatePicker=function(N){g.openDatePicker({_scope:o,n:N})},o.generateReport=function(){var N=o.toDate,F=new Date,U=o.toDate;showLoader();var P={toDate:o.toDate,organization:I};u.when(h.invoiceAging(P)).then(function(S){var k=[],L={},R=0,A=0,M=o.toDate.getTime(),q=0;S.forEach(function(H){var G=H.customer.id,W=H.entity.balanceDue;if(H.entity.lateFee){var K=H.entity.lateFee,V=K.get('price'),_=K.get('type'),Y=0;'$'==_?Y=V:'%'==_&&(Y=0.01*(W*V)),W+=Y}L[G]?(L[G].balanceDue+=W,L[G].count+=1):(L[G]={name:H.customer.displayName,balanceDue:W,count:1,overDueDays:0},k.push(G));var X=H.entity.invoiceDate.getTime(),Z=Math.round(Math.ceil(Math.abs(M-X)/8.64e7));L[G].overDueDays+=Z-1,A+=Z-1,R+=W,S[q].overDueDays1=Z-1,S[q].entity.balanceDueStr=C(W,'$',2),q++}),k.forEach(function(H){L[H].balanceDueStr=C(L[H].balanceDue,'$',2)}),o.invoices1=S,o.info=L,o.ids=k,o.totalOverDueDays=A,o.totalBalanceStr=C(R,'$',2);var O=o.dateFormat.toUpperCase().replace(/E/g,'d');o.toDateStr=formatDate(o.toDate,O),o.sortByInvoiceNo(),hideLoader()})},o.sortByInvoiceNo=function(){'none'===$('#invoiceno').css('display')?(o.invoices1.sort(function(N,F){var U=parseInt(N.entity.invoiceNumber.split('-')[1]),P=parseInt(F.entity.invoiceNumber.split('-')[1]);return U-P}),$('#invoiceno').css({display:'inline-table'}),$('#invoicenoUp').css({display:'none'})):(o.invoices1.sort(function(N,F){var U=parseInt(N.entity.invoiceNumber.split('-')[1]),P=parseInt(F.entity.invoiceNumber.split('-')[1]);return P-U}),$('#invoicenoUp').css({display:'inline-table'}),$('#invoiceno').css({display:'none'})),$('#name').css({display:'none'}),$('#days').css({display:'none'}),$('#balance').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#daysUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},o.sortByName=function(){'none'===$('#name').css('display')?(o.invoices1.sort(function(N,F){return N.customer.displayName.localeCompare(F.customer.displayName)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.invoices1.sort(function(N,F){return F.customer.displayName.localeCompare(N.customer.displayName)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#days').css({display:'none'}),$('#balance').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#daysUp').css({display:'none'}),$('#balanceUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'})},o.sortByDays=function(){o.invoices1.sort(function(N,F){return F.overDueDays1-N.overDueDays1}),'none'===$('#days').css('display')?(o.invoices1.sort(function(N,F){return F.overDueDays1-N.overDueDays1}),$('#days').css({display:'inline-table'}),$('#daysUp').css({display:'none'})):(o.invoices1.sort(function(N,F){return N.overDueDays1-F.overDueDays1}),$('#daysUp').css({display:'inline-table'}),$('#days').css({display:'none'})),$('#name').css({display:'none'}),$('#balance').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#balanceUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'})},o.sortByBalance=function(){'none'===$('#balance').css('display')?(o.invoices1.sort(function(N,F){return F.entity.balanceDue-N.entity.balanceDue}),$('#balance').css({display:'inline-table'}),$('#balanceUp').css({display:'none'})):(o.invoices1.sort(function(N,F){return N.entity.balanceDue-F.entity.balanceDue}),$('#balanceUp').css({display:'inline-table'}),$('#balance').css({display:'none'})),$('#name').css({display:'none'}),$('#days').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#daysUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'})}}]);'use strict',invoicesUnlimited.controller('PaymentsReceivedController',['$scope','$state','$controller','$q','userFactory','reportsService','reportsCommon','currencyFilter',function(o,r,l,u,y,h,g,C){if(!y.entity.length)return console.log('User not logged in'),void 0;var D=y.entity[0],I=D.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){o.dateRanges=g.getDateRanges(),o.selectedDateRange=o.dateRanges[1],o.fromDate=new Date,o.fromDate.setHours(0),o.fromDate.setMinutes(0),o.toDate=new Date,y.getField('dateFormat').then(function(N){o.dateFormat=N,o.generateReport()})}(),o.dateOptions={showWeeks:!1},o.dateRangeChanged=function(){g.dateRangeChanged({_scope:o})},o.openDatePicker=function(N){g.openDatePicker({_scope:o,n:N})},o.generateReport=function(){var N=o.toDate,F=new Date,U=o.fromDate,P=o.toDate;if(N>F)return ShowMessage('Select a valid Date!','error'),!1;if(U>P)return ShowMessage('The from date can\'t be after the to date.','error'),!1;showLoader();var S={fromDate:o.fromDate,toDate:o.toDate,organization:I};u.when(h.paymentsReceived(S)).then(function(k){var L=[],E=0,R=o.dateFormat.toUpperCase().replace(/E/g,'d');k.forEach(function(A){var B=A.payments;B.forEach(function(M){L.push({displayName:A.customer.get('displayName'),date:formatDate(A.entity.invoiceDate,R),amount:C(M.entity.amount,'$',2)}),E+=M.entity.amount})}),o.info=L,o.totalStr=C(E,'$',2),o.fromDateStr=formatDate(o.fromDate,R),o.toDateStr=formatDate(o.toDate,R),o.sortByDate(),hideLoader()})},o.sortByName=function(){o.info.sort(function(N,F){return N.displayName.localeCompare(F.displayName)}),'none'===$('#name').css('display')?(o.info.sort(function(N,F){return N.displayName.localeCompare(F.displayName)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.info.sort(function(N,F){return F.displayName.localeCompare(N.displayName)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#date').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#amountUp').css({display:'none'})},o.sortByDate=function(){'none'===$('#date').css('display')?(o.info.sort(function(N,F){return N.date.localeCompare(F.date)}),$('#date').css({display:'inline-table'}),$('#dateUp').css({display:'none'})):(o.info.sort(function(N,F){return F.date.localeCompare(N.date)}),$('#dateUp').css({display:'inline-table'}),$('#date').css({display:'none'})),$('#nameUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#name').css({display:'none'}),$('#amount').css({display:'none'})},o.sortByAmount=function(){'none'===$('#amount').css('display')?(o.info.sort(function(N,F){return N.amount.localeCompare(F.amount)}),$('#amount').css({display:'inline-table'}),$('#amountUp').css({display:'none'})):(o.info.sort(function(N,F){return F.amount.localeCompare(N.amount)}),$('#amountUp').css({display:'inline-table'}),$('#amount').css({display:'none'})),$('#name').css({display:'none'}),$('#date').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#dateUp').css({display:'none'})}}]);'use strict',invoicesUnlimited.controller('SalesByCustomerController',['$scope','$state','$controller','$q','userFactory','reportsService','reportsCommon','currencyFilter',function(o,r,l,u,y,h,g,C){if(!y.entity.length)return console.log('User not logged in'),void 0;var D=y.entity[0],I=D.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){o.dateRanges=g.getDateRanges(),o.selectedDateRange=o.dateRanges[1],o.fromDate=new Date,o.fromDate.setHours(0),o.fromDate.setMinutes(0),o.toDate=new Date,y.getField('dateFormat').then(function(N){o.dateFormat=N,o.generateReport()})}(),o.dateOptions={showWeeks:!1},o.dateRangeChanged=function(){g.dateRangeChanged({_scope:o})},o.openDatePicker=function(N){g.openDatePicker({_scope:o,n:N})},o.generateReport=function(){var N=o.toDate,F=new Date,U=o.fromDate,P=o.toDate;if(N>F)return ShowMessage('Select a valid Date!','error'),!1;if(U>P)return ShowMessage('The from date can\'t be after the to date.','error'),!1;showLoader();var S={fromDate:o.fromDate,toDate:o.toDate,organization:I};u.when(h.salesByCustomer(S)).then(function(k){var L=[],E={},R=0,A=0;k.forEach(function(M){var q=M.customer.id,O=M.entity.total;E[q]?(E[q].amount+=O,E[q].count+=1):(E[q]={name:M.customer.displayName,amount:O,count:1},L.push(q)),R+=O}),L.forEach(function(M){E[M].amountStr=C(E[M].amount,'$',2),A+=E[M].count}),o.infoObj=E,o.ids=L,o.totalInvoices=A,o.totalSalesStr=C(R,'$',2);var B=o.dateFormat.toUpperCase().replace(/E/g,'d');o.fromDateStr=formatDate(o.fromDate,B),o.toDateStr=formatDate(o.toDate,B),o.sortByName(),hideLoader()})},o.sortByName=function(){'none'===$('#name').css('display')?(o.ids.sort(function(N,F){return o.infoObj[N].name.localeCompare(o.infoObj[F].name)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.ids.sort(function(N,F){return o.infoObj[F].name.localeCompare(o.infoObj[N].name)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#count').css({display:'none'}),$('#tax').css({display:'none'}),$('#countUp').css({display:'none'}),$('#taxUp').css({display:'none'})},o.sortByInvoiceCount=function(){'none'===$('#count').css('display')?(o.ids.sort(function(N,F){return o.infoObj[F].count-o.infoObj[N].count}),$('#count').css({display:'inline-table'}),$('#countUp').css({display:'none'})):(o.ids.sort(function(N,F){return o.infoObj[N].count-o.infoObj[F].count}),$('#countUp').css({display:'inline-table'}),$('#count').css({display:'none'})),$('#name').css({display:'none'}),$('#tax').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#taxUp').css({display:'none'})},o.sortByTax=function(){o.ids.sort(function(N,F){return o.infoObj[F].amount-o.infoObj[N].amount}),'none'===$('#tax').css('display')?(o.ids.sort(function(N,F){return o.infoObj[N].name.localeCompare(o.infoObj[F].name)}),$('#tax').css({display:'inline-table'}),$('#taxUp').css({display:'none'})):(o.ids.sort(function(N,F){return o.infoObj[F].name.localeCompare(o.infoObj[N].name)}),$('#taxUp').css({display:'inline-table'}),$('#tax').css({display:'none'})),$('#name').css({display:'none'}),$('#count').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#countUp').css({display:'none'})}}]);'use strict',invoicesUnlimited.controller('SalesByItemController',['$scope','$state','$controller','$q','userFactory','reportsService','reportsCommon','itemService','currencyFilter',function(o,r,l,u,y,h,g,C,T){function I(U){var P=[],S={};U.forEach(function(R){var A=R.entity.id,B=R.invoiceItems;B.forEach(function(M){var q=M.entity.item.id,O=S[q];O?(O.amount+=M.entity.amount,!O.inv_ids.find(function(H){return H==A})&&O.inv_ids.push(A)):(P.push(q),S[q]={amount:M.entity.amount,inv_ids:[A]})})});var k=0,L=0;P.forEach(function(R){S[R].amountStr=T(S[R].amount,'$',2),S[R].count=S[R].inv_ids.length+1,k+=S[R].amount,L+=S[R].count,S[R].name=o.items.find(function(A){return A.id==R}).get('title')}),o.ids=P,o.info=S,o.totalInvoices=L,o.totalStr=T(k,'$',2),o.sortByName();var E=o.dateFormat.toUpperCase().replace(/E/g,'d');o.fromDateStr=formatDate(o.fromDate,E),o.toDateStr=formatDate(o.toDate,E)}if(!y.entity.length)return console.log('User not logged in'),void 0;var N=y.entity[0],F=N.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){o.dateRanges=g.getDateRanges(),o.selectedDateRange=o.dateRanges[1],o.fromDate=new Date,o.fromDate.setHours(0),o.fromDate.setMinutes(0),o.toDate=new Date;var U=[],P;P=y.getField('dateFormat').then(function(S){o.dateFormat=S}),U.push(P),P=C.getItemNames({organization:F}).then(function(S){o.items=S}),U.push(P),u.all(U).then(function(){o.generateReport()})}(),o.dateOptions={showWeeks:!1},o.dateRangeChanged=function(){g.dateRangeChanged({_scope:o})},o.openDatePicker=function(U){g.openDatePicker({_scope:o,n:U})},o.generateReport=function(){var U=o.toDate,P=new Date,S=o.fromDate,k=o.toDate;if(U>P)return ShowMessage('Select a valid Date!','error'),!1;if(S>k)return ShowMessage('The from date can\'t be after the to date.','error'),!1;showLoader();var L={fromDate:o.fromDate,toDate:o.toDate,organization:F};u.when(h.salesByItem(L)).then(function(E){I(E),hideLoader()})},o.sortByName=function(){'none'===$('#name').css('display')?(o.ids.sort(function(U,P){return o.info[U].name.localeCompare(o.info[P].name)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.ids.sort(function(U,P){return o.info[P].name.localeCompare(o.info[U].name)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#count').css({display:'none'}),$('#tax').css({display:'none'}),$('#countUp').css({display:'none'}),$('#taxUp').css({display:'none'})},o.sortByInvoiceCount=function(){'none'===$('#count').css('display')?(o.ids.sort(function(U,P){return o.info[P].count-o.info[U].count}),$('#count').css({display:'inline-table'}),$('#countUp').css({display:'none'})):(o.ids.sort(function(U,P){return o.info[U].count-o.info[P].count}),$('#countUp').css({display:'inline-table'}),$('#count').css({display:'none'})),$('#name').css({display:'none'}),$('#tax').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#taxUp').css({display:'none'})},o.sortByTax=function(){'none'===$('#tax').css('display')?(o.ids.sort(function(U,P){return o.info[P].amount-o.info[U].amount}),$('#tax').css({display:'inline-table'}),$('#taxUp').css({display:'none'})):(o.ids.sort(function(U,P){return o.info[U].amount-o.info[P].amount}),$('#taxUp').css({display:'inline-table'}),$('#tax').css({display:'none'})),$('#name').css({display:'none'}),$('#count').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#countUp').css({display:'none'})}}]);'use strict',invoicesUnlimited.controller('CreateCreditNoteController',['$scope','$state','$controller','$q','userFactory','creditNoteService','coreFactory','taxService','expenseService','currencyFilter','commentFactory','salesCommon',function(o,r,l,u,y,h,g,C,T,D,I,N){function F(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:1,digits:!0,messages:{required:'Please provide item quantity',min:'quantity should be >= 1',digits:'quantity must be integer'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0',number:'Please enter a valid price'}})})}function P(){1==o.prefs.numAutoGen?(o.creditNo=o.prefs.creditNumber,o.disableCreditNo=!0):(o.creditNo='',o.disableCreditNo=!1),o.notes=o.prefs.notes,o.terms=o.prefs.terms,o.todayDate=new Date,o.subTotalStr=D(0,'$',2),o.creditItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var W=r.params.customerId,K=r.params.expenseId;W&&(o.selectedCustomer=o.customers.filter(function(V){return V.entity.id==W})[0],q(),K&&u.when(M()).then(function(){o.addCreditItem(),o.creditItems[0].selectedItem=o.items.filter(function(V){return V.entity.expanseId==K})[0],o.creditItems[0].selectedItem.create=!0,o.itemChanged(0)})),hideLoader()}function S(){var W={userID:H,organization:G,customer:o.selectedCustomer.entity,creditNoteDate:o.todayDate,creditNumber:o.creditNo,status:'Open',subTotal:+o.subTotal,creditsUsed:0,refundsMade:0,total:+o.total,remainingCredits:+o.total,reference:o.refNumber,notes:o.notes,terms:o.terms},K=o.selectedCustomer.entity.email;return K&&(W.customerEmails=[K]),h.createNewCreditNote(W,o.creditItems,o.userRole).then(function(V){return A('Credit Note created for '+D(V.attributes.total,'$',2)+' amount',!0,V)})}function k(){return S().then(function(W){return h.createCreditNoteReceipt(W.id).then(function(K){return L(K),K})})}function L(W){o.contacts.forEach(function(K){K.selected&&h.sendCreditNoteReceiptToEmail(W,K.contact).then(function(){A('Credit Note emailed to '+K.contact,!0,W)})}),o.mobileContacts.forEach(function(K){K.selected&&h.sendCreditNoteTextToNumber(W,K.contact).then(function(){A('Credit Note texted to '+K.contact,!0,W)})})}function E(){F();var W=$('#addCreditNoteForm').valid(),K=$('#itemInfoForm').valid();if(W&&K)return!0;var V;W?!K&&(V=$('#itemInfoForm').validate()):V=$('#addCreditNoteForm').validate();var _=$(V.errorList[0].element).offset().top-30;return scrollToOffset(_),!1}function R(){E()&&(showLoader(),u.when(h.checkCreditNoteNumAvailable({creditNumber:o.creditNo,organization:G})).then(function(W){return W?k():(B(),scrollToOffset(),Promise.reject('Credit Note with this number already exists'))}).then(function(W){hideLoader(),r.go('dashboard.sales.creditnotes.details',{creditNoteId:W.id})},function(W){hideLoader(),console.log(W)}))}function A(W,K,V){var _={userID:H,organization:G,name:H.get('username'),date:new Date,isAutomaticallyGenerated:K,comment:W};if(H.get('isTrackUsage')||!K){var Y={};return u.when(g.getUserRole(H)).then(function(X){return I.createNewComment(_,X)}).then(function(X){Y.commentObj=X;var Z=V.get('comments');return Z?Z.push(X):Z=[X],V.set('comments',Z),V.save()})}}function B(){var W=$('#addCreditNoteForm').validate();W.showErrors({creditNumber:'Credit Note with this number already exists'})}function M(){return u.when(T.getCustomerExpenses({organization:G,customer:o.selectedCustomer.entity})).then(function(W){for(var K=[],V=0;V<W.length;++V)if('Yes'==W[V].entity.get('billable'))for(var _=0;_<o.expenseItems.length;++_)W[V].entity.id==o.expenseItems[_].entity.expanseId&&K.push(o.expenseItems[_]);for(var Y=[],V=0;V<W.length;++V)if('No'!=W[V].entity.get('billable')){var X=W[V].entity,Z=K.some(function(oe){return X.category==oe.entity.title&&X.amount==+oe.entity.rate});Z||Y.push({create:!0,tax:X.tax,entity:{title:X.category,rate:X.amount+'',expanseId:X.id}})}o.actualItems.pop();var J=o.actualItems.concat(K,Y);return o.creditItems=o.creditItems.filter(function(Q){return!Q.selectedItem||Q.selectedItem.create?!1:J.some(function(ee){return ee.entity.id==Q.selectedItem.entity.id})}),'Sales'!=H.get('role')&&J.push(createItemOpener),o.items=J})}function q(){return o.selectedCustomer.dummy?void r.go('dashboard.customers.new',{backLink:r.current.name}):void(showLoader(),u.when(M()).then(function(){1>o.creditItems.length?(o.addCreditItem(),o.totalTax=0,o.subTotal=0,o.subTotalStr=D(0,'$',2),o.reCalculateTotal()):O(),hideLoader()}))}function O(){var W=o.creditItems,K=0,V=0;o.itemTaxes=[],W.forEach(function(_){if(K+=_.amount*(0.01*(100-_.discount)),_.taxValue=calculateTax(_.amount,_.selectedTax),V+=_.taxValue,_.selectedTax){var Y=-1;o.itemTaxes.length&&(Y=o.itemTaxes.findIndex(function(X){return X.name==_.selectedTax.name})),-1==Y?o.itemTaxes.push({nameValue:_.selectedTax.name+' ('+_.selectedTax.rate+'%)',amount:D(_.taxValue,'$',2),count:1,name:_.selectedTax.name,amountValue:_.taxValue}):(o.itemTaxes[Y].amountValue+=_.taxValue,o.itemTaxes[Y].count++,o.itemTaxes[Y].amount=D(o.itemTaxes[Y].amountValue,'$',2),o.itemTaxes[Y].nameValue=_.selectedTax.name+' ('+_.selectedTax.rate+'%)')}}),o.totalTax=V,o.subTotal=K,o.subTotalStr=D(K,'$',2),o.reCalculateTotal()}if(!y.entity.length)return console.log('User not logged in'),void 0;var H=y.entity[0],G=H.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){showLoader();var W=[],K=null;K=u.when(g.getAllCustomers()).then(function(V){V=V.filter(function(_){return'active'==_.entity.status}),o.customers=V.sort(function(_,Y){return alphabeticalSort(_.entity.displayName,Y.entity.displayName)}),o.customers.forEach(function(_){_.fullName=_.entity.salutation?_.entity.salutation+' '+_.entity.displayName:_.entity.displayName}),'Sales'!=H.get('role')&&o.customers.push(createCustomerOpener)}),W.push(K),K=u.when(g.getAllItems({organization:G})).then(function(V){o.actualItems=V.filter(function(_){return!_.entity.expanseId}),o.expenseItems=V.filter(function(_){return _.entity.expanseId}),o.items=o.actualItems,'Sales'!=H.get('role')&&o.items.push(createItemOpener)}),W.push(K),K=u.when(h.getPreferences(H)).then(function(V){o.prefs=V}),W.push(K),K=u.when(g.getUserRole(H)).then(function(V){o.userRole=V}),W.push(K),K=C.getTaxes(H,function(V){o.taxes=V}),W.push(K),K=y.getField('dateFormat').then(function(V){o.dateFormat=V}),W.push(K),u.all(W).then(function(){P()},function(V){hideLoader(),console.log(V.message)})}(),$('#addCreditNoteForm').validate({rules:{customer:'required',creditNumber:'required',creditCreateDate:'required'},messages:{customer:'Please select a customer',creditNumber:'Please enter credit note number',creditCreateDate:'Please provide credit note Create date'}}),$('#itemInfoForm').validate(),o.dateOptions={showWeeks:!1},o.save=function(){E()&&(showLoader(),u.when(h.checkCreditNoteNumAvailable({creditNumber:o.creditNo,organization:G})).then(function(W){return W?S():(B(),scrollToOffset(),Promise.reject('Credit Note with this number already exists'))}).then(function(W){hideLoader(),r.go('dashboard.sales.creditnotes.details',{creditNoteId:W.id})},function(W){hideLoader(),console.log(W)}))},o.saveAndSend=function(){if(E()){$('#emailText-error').hide();var W=o.selectedCustomer.entity.get('contactPersons');o.contacts=[],o.mobileContacts=[],W.length&&W.forEach(function(K){var V=K.get('firstname')?K.get('firstname'):'',_=K.get('lastname')?K.get('lastname'):'',Y=1==K.get('defaultPerson'),X=V+' '+_;K.get('email')&&o.contacts.push({selected:Y,contact:K.get('email'),contactName:'('+X+') '+K.get('email')}),K.get('phone')&&o.mobileContacts.push({selected:!1,contact:K.get('phone'),contactName:'('+X+') '+K.get('phone')}),K.get('mobile')&&o.mobileContacts.push({selected:Y,contact:K.get('mobile'),contactName:'('+X+') '+K.get('mobile')})}),o.contacts.length||o.mobileContacts.length?$('.email-text').addClass('show'):ShowMessage('The customer does not have a email or phone number in their profile. Please select save.','error')}},o.sendReceipt=function(){debugger;var W=0,K=0;o.contacts.forEach(function(V){V.selected&&W++}),o.mobileContacts.forEach(function(V){V.selected&&K++}),0<W||0<K?R():$('#emailText-error').show()},o.cancel=function(){r.go('dashboard.sales.creditnotes.all')},o.customerChanged=q,o.openDatePicker=function(W){1===W?o.openPicker1=!0:void 0},o.addCreditItem=function(){o.creditItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},o.removeCreditItem=function(W){1<o.creditItems.length?(o.creditItems.splice(W,1),O()):console.log('there should be atleast 1 item in a creditNote')},o.prepareCreateItem=function(){N.prepareCreateItem({_scope:o})},o.createNewItem=function(){N.createNewCreditItem({_scope:o,user:H,organization:G})},o.itemChanged=function(W){console.log('item changed');var K=o.creditItems[W];if(K.selectedItem.dummy)return K.selectedItem=null,$('.new-item').addClass('show'),o.itemChangedIndex=W,void o.prepareCreateItem();K.rate=+K.selectedItem.entity.rate;var V=K.selectedItem.tax;if(!V)K.selectedTax='';else for(var _=o.taxes,Y=0;Y<_.length;++Y)if(V.id==_[Y].id){K.selectedTax=_[Y];break}o.reCalculateItemAmount(W)},o.reCalculateTotal=function(){var W=+o.subTotal||0,K=+o.totalTax||0;o.total=W+K,o.totalStr=D(o.total,'$',2)},o.taxChanged=function(W){if(console.log('tax changed'),-1!=W){var K=o.creditItems[W];if(!K.selectedTax)O();else if(K.selectedTax.dummy)return o.currentItem=W,o.taxName=null,o.taxRate=null,K.selectedTax=null,void $('.new-tax').addClass('show')}else if(o.newItem.tax.dummy)return o.currentItem=W,o.newItem.tax=null,o.taxName=null,o.taxRate=null,void $('.new-tax').addClass('show');O()},o.saveNewTax=function(){N.createNewCreditTax({_scope:o,user:H},function(){O(),o.$$phase||o.$apply()})},o.reCalculateItemAmount=function(W){var K=o.creditItems[W];K.selectedItem&&(K.amount=K.rate*K.quantity,O())}}]);'use strict',invoicesUnlimited.controller('CreditNoteController',['$q','$scope','$state','$controller','userFactory','creditNoteService','coreFactory','taxService','expenseService','commentFactory','currencyFilter',function(o,r,l,u,y,h,g,C,T,D,I){function N(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:1,digits:!0,messages:{required:'Please provide item quantity',min:'quantity should be >= 1',digits:'quantity must be integer'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0',number:'Please enter a valid price'}})})}function F(W){W||(W=l.current.name),G.creditnotes(W)?(console.log('its in list'),q()):G.newCreditnotes(W)?console.log('its in new'):G.edit(W)&&(console.log('its in edit'),U())}function U(){var W=l.params.creditNoteId;if(W){var K=l.params.customerId;showLoader(),o.when(M()).then(function(){return o.when(h.getCreditNote(W))}).then(function(V){return console.log(V),r.creditNote=V,r.creditItems=[],r.deletedItems=[],r.itemsWithOutId=0,r.itemsWithIdinDel=0,r.selectedCustomer=K?r.customers.filter(function(_){return K===_.entity.id})[0]:r.customers.filter(function(_){return V.entity.get('customer').id===_.entity.id})[0],o.when(B())}).then(function(){P()},function(V){hideLoader(),console.log(V.message)})}}function P(){var W=r.creditNote;r.creditNo=W.entity.creditNumber,r.refNumber=W.entity.reference,r.disableCreditNo=!(1!=r.prefs.numAutoGen),r.todayDate=W.entity.creditNoteDate,r.notes=W.entity.notes,r.terms=W.entity.terms,'Sent'==W.entity.status&&(r.previouslySent=!0);for(var K=0;K<W.creditItems.length;++K){var V=W.creditItems[K].entity,_=V.get('item'),Y={};Y.selectedItem=r.items.filter(function(X){if(X.entity.id===_.id){Y.id=V.id,Y.rate=V.amount/V.quantity,Y.quantity=V.quantity,Y.discount=0,Y.taxValue=0,Y.amount=V.amount;var Z=V.get('tax');return Y.selectedTax=Z?r.taxes.filter(function(J){return J.id==Z.id})[0]:void 0,!0}return!1})[0],r.creditItems.push(Y)}A(),hideLoader()}function S(W){var K=r.creditNote.entity;K.set('customer',r.selectedCustomer.entity),K.set('creditNoteDate',r.todayDate),K.set('creditNumber',r.creditNo),K.set('subTotal',+r.subTotal),K.set('total',+r.total),K.set('remainingCredits',+r.total),K.set('reference',r.refNumber),K.set('notes',r.notes),K.set('terms',r.terms);var V=r.selectedCustomer.entity.email;return V?K.set('customerEmails',[V]):K.unset('customerEmails'),h.updateCreditNote(r.creditNote,r.creditItems,r.deletedItems,O,r.userRole).then(function(_){return k('Credit Note edited',!0),W.generateReceipt?h.createCreditNoteReceipt(_.id):_})}function k(W,K){var V={userID:O,organization:H,name:O.get('username'),date:new Date,isAutomaticallyGenerated:K,comment:W};if(O.get('isTrackUsage')||!K){var _={};o.when(g.getUserRole(O)).then(function(Y){return D.createNewComment(V,Y)}).then(function(Y){_.commentObj=Y;var X=r.creditNote.entity,Z=X.get('comments');return Z?Z.push(Y):Z=[Y],X.set('comments',Z),X.save()})}}function L(){return S({generateReceipt:!1}).then(function(W){return h.createCreditNoteReceipt(W.id).then(function(K){return h.sendCreditNoteReceipt(K)})})}function E(){N();var W=$('#editCreditNoteForm').valid(),K=$('#itemInfoForm').valid();if(W&&K)return!0;var V;W?!K&&(V=$('#itemInfoForm').validate()):V=$('#editCreditNoteForm').validate();var _=$(V.errorList[0].element).offset().top-30;return scrollToOffset(_),!1}function R(){var W=r.itemsWithIdinDel,K=r.itemsWithOutId;if(!(0>=W||0>=K)){var V=0,_=r.creditItems;r.deletedItems.forEach(function(Y){if(Y.id)for(;V<_.length;++V)if(!_[V].id)return _[V].id=Y.id,Y.id=void 0,--r.itemsWithIdinDel,void--r.itemsWithOutId}),r.deletedItems=r.deletedItems.filter(function(Y){return!!Y.id})}}function A(){var W=r.creditItems,K=0,V=0;r.itemTaxes=[],W.forEach(function(_){if(K+=_.amount*(0.01*(100-_.discount)),_.taxValue=calculateTax(_.amount,_.selectedTax),V+=_.taxValue,_.selectedTax){var Y=-1;r.itemTaxes.length&&(Y=r.itemTaxes.findIndex(function(X){return X.name==_.selectedTax.name})),-1==Y?r.itemTaxes.push({nameValue:_.selectedTax.name+' ('+_.selectedTax.rate+'%)',amount:I(_.taxValue,'$',2),count:1,name:_.selectedTax.name,amountValue:_.taxValue}):(r.itemTaxes[Y].amountValue+=_.taxValue,r.itemTaxes[Y].count++,r.itemTaxes[Y].amount=I(r.itemTaxes[Y].amountValue,'$',2),r.itemTaxes[Y].nameValue=_.selectedTax.name+' ('+_.selectedTax.rate+'%)')}}),r.totalTax=V,r.subTotal=K,r.subTotalStr=I(K,'$',2),r.reCalculateTotal()}function B(){return o.when(T.getCustomerExpenses({organization:H,customer:r.selectedCustomer.entity})).then(function(W){for(var K=[],V=0;V<W.length;++V)if('Yes'==W[V].entity.get('billable'))for(var _=0;_<r.expenseItems.length;++_)W[V].entity.id==r.expenseItems[_].entity.expanseId&&K.push(r.expenseItems[_]);for(var Y=[],V=0;V<W.length;++V)if('No'!=W[V].entity.get('billable')){var X=W[V].entity,Z=K.some(function(me){return X.category==me.entity.title&&X.amount==+me.entity.rate});Z||Y.push({create:!0,tax:X.tax,entity:{title:X.category,rate:X.amount+'',expanseId:X.id}})}var J=r.actualItems.concat(K,Y);return r.creditItems=r.creditItems.filter(function(Q){return!Q.selectedItem||Q.selectedItem.create?!1:J.some(function(ee){return ee.entity.id==Q.selectedItem.entity.id})}),r.items=J})}function M(){var W=[],K=null;return g.clearAllOnLogOut(),K=o.when(g.getAllCustomers()).then(function(V){r.customers=V.sort(function(_,Y){return alphabeticalSort(_.entity.displayName,Y.entity.displayName)}),r.customers.forEach(function(_){_.fullName=_.entity.salutation?_.entity.salutation+' '+_.entity.displayName:_.entity.displayName}),'Sales'!=O.get('role')&&r.customers.push(createCustomerOpener)}),W.push(K),K=o.when(g.getAllItemsIncludingDelete({organization:H})).then(function(V){r.actualItems=V.filter(function(_){return!_.entity.expanseId}),r.expenseItems=V.filter(function(_){return _.entity.expanseId}),r.items=r.actualItems}),W.push(K),K=o.when(h.getPreferences(O)).then(function(V){r.prefs=V}),W.push(K),K=o.when(g.getUserRole(O)).then(function(V){r.userRole=V}),W.push(K),K=C.getTaxes(O,function(V){r.taxes=V}),W.push(K),o.all(W)}function q(){showLoader(),o.when(h.listCreditNotes(O)).then(function(W){var K=r.dateFormat.toUpperCase().replace(/E/g,'d');W.forEach(function(V){switch(V.entity.status){case'Open':V.statusClass='text-positive';break;case'Closed':V.statusClass='text-danger';break;default:V.statusClass='text-color-normalize';}V.creditNoteDate=formatDate(V.entity.creditNoteDate,K),V.total=I(V.entity.total,'$',2),V.remainingCredits=I(V.entity.remainingCredits,'$',2)}),r.creditNoteList=W,r.allcreditNoteList=W,r.displayedCreditNotes=W,r.sortByDate(),hideLoader()},function(W){hideLoader(),console.log(W.message)})}if(!y.entity.length)return console.log('User not logged in'),void 0;var O=y.entity[0],H=O.get('organizations')[0];u('DashboardController',{$scope:r,$state:l});var G={details:function(W){return W.endsWith('creditnotes.details')},creditnotes:function(W){return W.endsWith('creditnotes.all')},edit:function(W){return W.endsWith('creditnotes.edit')},newCreditnotes:function(W){return W.endsWith('creditnotes.new')}};y.getField('dateFormat').then(function(W){r.dateFormat=W,F()}),$('#editCreditNoteForm').validate({rules:{customer:'required',creditNumber:'required',creditCreateDate:'required'},messages:{customer:'Please select a customer',creditNumber:'Please enter credit note number',creditCreateDate:'Please provide credit note Create date'}}),$('#itemInfoForm').validate(),r.dateOptions={showWeeks:!1},r.save=function(){E()&&(showLoader(),R(),S({generateReceipt:!0}).then(function(W){hideLoader(),console.log(W),l.go('dashboard.sales.creditnotes.details',{creditNoteId:W.id})},function(W){hideLoader(),console.log(W.message)}))},r.saveAndSend=function(){E()&&(showLoader(),R(),L().then(function(W){hideLoader(),console.log(W),l.go('dashboard.sales.creditnotes.all')},function(W){hideLoader(),console.log(W)}))},r.cancel=function(){l.go('dashboard.sales.creditnotes.all')},r.addCreditItem=function(){var W=r.deletedItems.pop();W?--r.itemsWithIdinDel:(W={id:void 0},++r.itemsWithOutId),W.selectedItem=void 0,W.selectedTax=void 0,W.rate=0,W.quantity=1,W.discount=0,W.taxValue=0,W.amount=0,r.creditItems.push(W)},r.removeCreditItem=function(W){if(1<r.creditItems.length){var K=r.creditItems.splice(W,1)[0];K.id?(++r.itemsWithIdinDel,r.deletedItems.push(K)):--r.itemsWithOutId,A()}else console.log('there should be atleast 1 item in a creditNote')},r.openDatePicker=function(W){1===W?r.openPicker1=!0:void 0},r.reCalculateTotal=function(){var W=+r.subTotal||0,K=+r.totalTax||0;r.total=W+K,r.totalStr=I(r.total,'$',2)},r.reCalculateItemAmount=function(W){var K=r.creditItems[W];K.selectedItem&&(K.amount=K.rate*K.quantity,A())},r.itemChanged=function(W){var K=r.creditItems[W];K.rate=+K.selectedItem.entity.rate;var V=K.selectedItem.tax;if(!V)K.selectedTax='';else for(var _=r.taxes,Y=0;Y<_.length;++Y)if(V.id==_[Y].id){K.selectedTax=_[Y];break}r.reCalculateItemAmount(W)},r.customerChanged=function(){return r.selectedCustomer.dummy?void l.go('dashboard.customers.new',{backLink:l.current.name,creditNoteId:l.params.creditNoteId}):void(showLoader(),o.when(B()).then(function(){1>r.creditItems.length?(r.addCreditItem(),r.totalTax=0,r.subTotal=0,r.subTotalStr=I(0,'$',2),r.reCalculateTotal()):A(),hideLoader()}))},r.sortByCreditNote=function(){'none'===$('#creditnote').css('display')?(r.creditNoteList.sort(function(W,K){return W.entity.creditNumber.localeCompare(K.entity.creditNumber)}),$('#creditnote').css({display:'inline-table'}),$('#creditnoteUp').css({display:'none'})):(r.creditNoteList.sort(function(W,K){return K.entity.creditNumber.localeCompare(W.entity.creditNumber)}),$('#creditnoteUp').css({display:'inline-table'}),$('#creditnote').css({display:'none'})),$('#date').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByDate=function(){'none'===$('#date').css('display')?(r.creditNoteList.sort(function(W,K){return W.entity.creditNoteDate>K.entity.creditNoteDate?-1:W.entity.creditNoteDate<K.entity.creditNoteDate?1:0}),$('#date').css({display:'inline-table'}),$('#dateUp').css({display:'none'})):(r.creditNoteList.sort(function(W,K){return K.entity.creditNoteDate>W.entity.creditNoteDate?-1:K.entity.creditNoteDate<W.entity.creditNoteDate?1:0}),$('#dateUp').css({display:'inline-table'}),$('#date').css({display:'none'})),$('#creditnote').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#creditnoteUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByRefNum=function(){'none'===$('#refno').css('display')?(r.creditNoteList.sort(function(W,K){return W.entity.reference||(W.entity.reference=''),K.entity.reference||(K.entity.reference=''),W.entity.reference.localeCompare(K.entity.reference)}),$('#refno').css({display:'inline-table'}),$('#refnoUp').css({display:'none'})):(r.creditNoteList.sort(function(W,K){return W.entity.reference||(W.entity.reference=''),K.entity.reference||(K.entity.reference=''),K.entity.reference.localeCompare(W.entity.reference)}),$('#refnoUp').css({display:'inline-table'}),$('#refno').css({display:'none'})),$('#date').css({display:'none'}),$('#creditnote').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#creditnoteUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByCusName=function(){r.creditNoteList.sort(function(W,K){return W.customer.displayName.localeCompare(K.customer.displayName)}),'none'===$('#cusname').css('display')?(r.creditNoteList.sort(function(W,K){return W.customer.displayName.localeCompare(K.customer.displayName)}),$('#cusname').css({display:'inline-table'}),$('#cusnameUp').css({display:'none'})):(r.creditNoteList.sort(function(W,K){return K.customer.displayName.localeCompare(W.customer.displayName)}),$('#cusnameUp').css({display:'inline-table'}),$('#cusname').css({display:'none'})),$('#date').css({display:'none'}),$('#creditnote').css({display:'none'}),$('#refno').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#creditnoteUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByStatus=function(){'none'===$('#status').css('display')?(r.creditNoteList.sort(function(W,K){return W.entity.status.localeCompare(K.entity.status)}),$('#status').css({display:'inline-table'}),$('#statusUp').css({display:'none'})):(r.creditNoteList.sort(function(W,K){return K.entity.status.localeCompare(W.entity.status)}),$('#statusUp').css({display:'inline-table'}),$('#status').css({display:'none'})),$('#date').css({display:'none'}),$('#creditnote').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#creditnoteUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByAmount=function(){r.creditNoteList.sort(function(W,K){return K.entity.total-W.entity.total}),'none'===$('#amount').css('display')?(r.creditNoteList.sort(function(W,K){return K.entity.total-W.entity.total}),$('#amount').css({display:'inline-table'}),$('#amountUp').css({display:'none'})):(r.creditNoteList.sort(function(W,K){return W.entity.total-K.entity.total}),$('#amountUp').css({display:'inline-table'}),$('#amount').css({display:'none'})),$('#date').css({display:'none'}),$('#creditnote').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#balance').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#creditnoteUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByBalance=function(){'none'===$('#balance').css('display')?(r.creditNoteList.sort(function(W,K){return K.entity.remainingCredits-W.entity.remainingCredits}),$('#balance').css({display:'inline-table'}),$('#balanceUp').css({display:'none'})):(r.creditNoteList.sort(function(W,K){return W.entity.remainingCredits-K.entity.remainingCredits}),$('#balanceUp').css({display:'inline-table'}),$('#balance').css({display:'none'})),$('#date').css({display:'none'}),$('#creditnote').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#creditnoteUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.showMenu=function(){$('.filtermenu').hasClass('show')?$('.filtermenu').removeClass('show'):$('.filtermenu').addClass('show')},r.currentCreditNotes='All Credit Notes',r.allCreditNotes=function(){r.creditNoteList=r.allcreditNoteList.filter(function(){return!0}),r.displayedCreditNotes=r.creditNoteList,r.currentCreditNotes='All Credit Notes',$('.filtermenu').removeClass('show')},r.openCreditNotes=function(){r.creditNoteList=r.allcreditNoteList.filter(function(W){return'Open'==W.entity.status}),r.displayedCreditNotes=r.creditNoteList,r.currentCreditNotes='Open Credit Notes',$('.filtermenu').removeClass('show')},r.closedCreditNotes=function(){r.creditNoteList=r.allcreditNoteList.filter(function(W){return'Closed'==W.entity.status}),r.displayedCreditNotes=r.creditNoteList,r.currentCreditNotes='Closed Credit Notes',$('.filtermenu').removeClass('show')},r.voidCreditNotes=function(){r.estimateList=r.allcreditNoteList.filter(function(W){return'Void'==W.entity.status}),r.displayedCreditNotes=r.estimateList,r.currentCreditNotes='Void Credit Notes',$('.filtermenu').removeClass('show')},r.search=function(){r.creditNoteList=r.searchText.length?r.displayedCreditNotes.filter(function(W){return W.creditNoteDate||(W.creditNoteDate=''),W.entity.creditNumber||(W.entity.creditNumber=''),W.entity.reference||(W.entity.reference=''),W.customer.displayName||(W.customer.displayName=''),W.entity.status||(W.entity.status=''),W.total||(W.total=''),W.remainingCredits||(W.remainingCredits=''),W.creditNoteDate.toLowerCase().includes(r.searchText.toLowerCase())||W.entity.creditNumber.toLowerCase().includes(r.searchText.toLowerCase())||W.entity.reference.toLowerCase().includes(r.searchText.toLowerCase())||W.customer.displayName.toLowerCase().includes(r.searchText.toLowerCase())||W.entity.status.toLowerCase().includes(r.searchText.toLowerCase())||W.total.toLowerCase().includes(r.searchText.toLowerCase())||W.remainingCredits.toLowerCase().includes(r.searchText.toLowerCase())}):r.displayedCreditNotes}}]);'use strict',invoicesUnlimited.controller('CreditNoteDetailController',['$q','$scope','$state','$sce','$controller','userFactory','creditNoteService','coreFactory','commentFactory','currencyFilter',function(o,r,l,u,y,h,g,C,T,D){function I(){var E=l.params.creditNoteId;E&&(scrollToOffset(),showLoader(),o.when(g.getCreditNoteDetails(E)).then(function(R){var A=R.entity.get('userID');'General Employee'==h.entity[0].get('role')?h.entity[0].id==A.id&&(r.isOwner=!0):r.isOwner=!0,1==R.entity.get('customer').get('isDeleted')&&(r.isOwner=!1),console.log(R),r.creditNote=R,r.creditNo=R.entity.creditNumber,R.payments?(R.payments.forEach(function(M){M.date=formatDate(M.entity.date,L),M.amount=D(M.entity.amount*S.exchangeRate,S.currencySymbol,2)}),r.payments=R.payments):r.payments=[],R.comments&&R.comments.forEach(function(M){M.date=formatDate(M.entity.date,L)}),r.comments=R.comments;var B=R.entity.creditReceipt;return B?Promise.resolve(B):g.createCreditNoteReceipt(E).then(function(M){return M.get('creditReceipt')})}).then(function(R){r.templateUrl=u.trustAsResourceUrl(R.url());debugger;return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:R.url()}}).then(function(A){var B=document.getElementById('creditFrame');B.src='about:blank',B.contentWindow.document.open(),B.contentWindow.document.write(A),B.contentWindow.document.close(),hideLoader()})},function(R){hideLoader(),console.log(R.message)}))}function N(E,R){var A={userID:U,organization:P,name:U.get('username'),date:new Date,isAutomaticallyGenerated:R,comment:E};if(U.get('isTrackUsage')||!R){var B={};return o.when(C.getUserRole(U)).then(function(M){return T.createNewComment(A,M)}).then(function(M){B.commentObj=M;var q=r.creditNote.entity,O=q.get('comments');return O?O.push(M):O=[M],q.set('comments',O),q.save()}).then(function(M){var q=new T(B.commentObj);return q.date=formatDate(q.entity.date,L),r.comments?r.comments.push(q):r.comments=[q],console.log(q),M})}}function F(E){var R=$(E).find('itemRow'),A=$(E).find('modsRow'),B=$(E).find('attachment'),M=$(E).find('customField'),q=$(E).find('tax'),O=$('<td></td>');$(E).find('billType').text().includes('estimate')&&($('.footer .info').hide(),$('.payment-due').hide()),/^[\s]*$/.test(R.first().find('discount').text())?$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),R.each(function(){if(!/^[\s]*$/.test(R.first().find('discount').text())){var V=$('<tr class=\'invoice-items\'></tr>'),_=$('<td class=\'ff1 fc0 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+$(this).children('name').text()+'</td>'),Y=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('qty').text()+'</td>'),X=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('discount').text()+'</td>'),Z=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');V.append(_).append(Y).append(X).append(Z),$('#invoice-items-header').after($(V))}else{var V=$('<tr class=\'invoice-items\'></tr>'),_=$('<td class=\'ff1 fc0 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+$(this).children('name').text()+'</td>'),Y=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'2\'>'+$(this).children('qty').text()+'</td>'),Z=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');V.append(_).append(Y).append(Z),$('#invoice-items-header').after($(V))}}),q.each(function(){var K=$('<tr class=\'invoice-taxes\'></tr>'),V=$('<td colspan=\'3\' class=\'\'></td>'),_=$('<td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).children('name').text()+'</td>'),Y=$('<td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).children('value').text()+'</td>');K.append(V).append(_).append(Y),$('#invoice-subtotal').after($(K))});var H=$('<tr class="salestax"></tr>');$('tr.adjustments').after(H),M.each(function(){var K=$('.customFields');K.append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children('name').text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children('value').text()+'</p></div>'))}),B.each(function(){var K=$(this).text();K=K.substring(K.indexOf('_')+1,K.length),K=K.replace(/%20/g,' '),$('.attach').append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+'\'>'+K+'</a><br><br>')}),$('table tbody tr').each(function(){0==$(this).children().text().length&&$(this).addClass('hideOnMob')});var G=$(E).find('invoiceId').text();$('#pay-link').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+G),$('#pay-link-2').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+G);var W=$(E).find('items');console.log(W),W.each(function(){var K=new Date(Date.parse($(this).find('past-due').text())),V=new Date(Date.now());K=new Date(K.setHours(0,0,0,0)),V=new Date(K.setHours(0,0,0,0)),K.getTime()>=V.getTime()||'Invalid Date'===K.toString()?($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('green-status')):($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('red-status'));var _=$(this).find('headerTitle').text();$('.payment-due p:first').append(_);var Y=$(this).find('disablePay').text();'true'===Y&&($('.btn-border-pay').addClass('disable'),$('.info.cl').addClass('disable'),$('.payment-due').removeClass('red-status'),$('.payment-due').addClass('green-status'));var Z=$(this).find('discountAmount').text(),J=$('<tr class="discount"></tr>');J.append($('<td class="discountNm" colspan="3"></td>').html('Discount')),J.append($('<td class="discountPr"></td>').html(Z)),'after'==$(this).find('discountPlace text').text()?$('.salestax:last').after(J):'before'==$(this).find('discountPlace text').text()&&$('.salestax:first').before(J);var Q=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountNameBottom').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountAmount').text()+'</td></tr>');if('after'==$(this).find('discountPlace text').text()?$('.invoice-taxes:last').after($(Q)):'before'==$(this).find('discountPlace text').text()&&$('#invoice-subtotal').after($(Q)),0<$(this).find('adjustments').text().length){var Q=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustments').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustmentsPrice').text()+'</td></tr>');$('#invoice-subtotal').after($(Q))}0<$(this).find('shippingCharges').text().length&&(Q=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingCharges').text()+'</td><td class=\'ff1 fc1 \' style=\' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingChargesPrice').text()+'</td></tr>'),$('#invoice-subtotal').after($(Q)));var _=$(this).find('headerTitle').text(),ee=$(this).find('past-due').text();_?$('#pdf-title').text(_+'   '+ee):($('#pdf-title').text(''),$('.top-bar').css('height','0mm'),$('.top-bar').css('border-bottom','0mm')),$('#pdf-business-name').text(h.entity[0].get('company')),$('#pdf-invoice-title').text($(this).find('invoice-title').text()),$('#pdf-invoice-number').text($(this).find('refid').text()),$('#pdf-amount-received').text($(this).find('body-price').text()),$('#pdf-date').text($(this).find('body-date').text()),$('#pdf-subtotal').text($(this).find('subtotalprice').text()),$('#pdf-payment-made').text($(this).find('paymentMadePrice').text()),$('#pdf-total').text($(this).find('total-price3').text()),$('#pdf-total-top').text($(this).find('total-price3').text()),$('#pdf-credit-applied').text($(this).find('creditsAppliedPrice').text()),$('#pdf-amount-due').text($(this).find('refundtotal').text()),$('#pdf-payment-name').text($(this).find('title').text()),$('#pdf-currency').text($(this).find('body-currency').text()),$('#pdf-total-text').text($(this).find('refundedText').text()),$('#pdf-payment-text').text($(this).find('paymentMadeText').text()),$('#pdf-credit-text').text($(this).find('creditsAppliedText').text());var te=$(this).find('addres1').text();$('#pdf-address').html(te);var se=$(this).find('longmsg').text();if(0!=se.length){var ae=$(this).find('longmsg-title').text();$('#pdf-notes-title').html(ae),$('#pdf-notes').html(se)}else $('#pdf-notes-title').html(''),$('#pdf-notes').html(''),$('#pdf-notes-title').hide(),$('#pdf-notes').hide();var ne=$(this).find('ordernotes-title').text(),ie=$(this).find('ordernotes').text();ie?($('#pdf-terms-title').text(ne),$('#pdf-terms').text(ie)):($('#pdf-terms-title').text(''),$('#pdf-terms').text(''),$('#pdf-terms-title').hide(),$('#pdf-terms').hide());var oe=$(this).find('mailto').text();$('#user-mail').attr('href',oe);var re=$(this).find('mailtotxt').text();$('#user-mail').text(re);var le=$(this).find('clientmailto').text();$('#client-mail').attr('href',le);var de=$(this).find('clientmail').text();$('#client-mail').text(de);var ce=$(this).find('clientname').text();$('#client-name').text(ce);var me=$(this).find('nr').text();$('#user-phone').attr('href','tel:'+me),$('#user-phone').text(me);var ue=$(this).find('refid').text();$('.visa-card').append(ue);var pe=$(this).find('purchaseOrderNumber').text();$('.purchase-order').append(pe);var ye=$(this).find('invoice-title').text();$('.invoice-details-1 h1').append(ye);var he=$(this).find('list-header-total').text();$('.list-header li:first-child span').append(he);var ge=$(this).find('list-header-date').text();$('.list-header li:nth-child(2) span').append(ge);var fe=$(this).find('list-header-currency').text();$('.list-header li:nth-child(3) span').append(fe);var xe=$(this).find('body-price').text();$('.list-body li:first-child span').append(xe);var be=$(this).find('body-date').text();$('.list-body li:nth-child(2) span').append(be);var be=$(this).find('body-currency').text();$('.list-body li:nth-child(3) span').append(be);var ve=$(this).find('th1').text();$('.content.cl th.item').append(ve);var Ce=$(this).find('addres1').text();$('.invoice-details-1 .info-2 p .adr').append(Ce);var Te=$(this).find('website-link').text();$('.invoice-details-1 .info-2 .website a').attr('href',Te);var De=$(this).find('website-name').text();$('.invoice-details-1 .info-2 .website a span').append(De);var oe=$(this).find('mailto').text();$('.invoice-details-1 .info-2 .mailto a').attr('href',oe);var re=$(this).find('mailtotxt').text();$('.invoice-details-1 .info-2 .mailto a span').append(re);var me=$(this).find('nr').text();$('.invoice-details-1 .info-2 .nr a').attr('href',me),$('.invoice-details-1 .info-2 .nr a span').append(me);var Ie=$(this).find('thanksmsg').text();$('.invoice-details-2 .info-1 p:nth-child(1)').append(Ie);var se=$(this).find('longmsg').text();if(0!=se.length){var ae=$(this).find('longmsg-title').text();$('.notes_para_head').html(ae),$('.notes_para').html(se)}var Ne=$(this).find('to').text();$('.invoice-details-2 .info-2 p:first-child').append(Ne);var ce=$(this).find('clientname').text();$('.invoice-details-2 .info-2 .list-client li:first-child span').append(ce);var we=$(this).find('clientnr').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(2) a').attr('href',we),$('.invoice-details-2 .info-2 .list-client li:nth-child(2) a span').append(we);var le=$(this).find('clientmailto').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(3) a').attr('href',le);var de=$(this).find('clientmail').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(3) a span').append(de);var ne=$(this).find('ordernotes-title').text(),ie=$(this).find('ordernotes').text();$('.orderNotes').append(ne),$('.orderNotesValues').append(ie);var Fe=$(this).find('subtotal').text();$('td.subtotal').append(Fe);var Ue=$(this).find('adjustments').text();$('td.adjustments').append(Ue);var Pe=$(this).find('adjustmentsPrice').text();$('td.adjustments-price').append(Pe);var Se=$(this).find('shippingCharges').text();$('td.shippingCharges').append(Se);var ke=$(this).find('shippingChargesPrice').text();$('td.shipping-charges-price').append(ke);var Le=$(this).find('total-price').text(),Ee=$(this).find('salestax').text();$('.salestax').append(Ee);var je=$(this).find('paymentMadeText').text(),Re=$(this).find('paymentMadePrice').text();$('td.payment-made-text').append(je),$('td.payment-made-price').append(Re);var Ae=$(this).find('paymentRefundMadeText').text(),Be=$(this).find('paymentRefundMadePrice').text();''==Ae?($('td.payment-refund-made-text').hide(),$('td.payment-refund-made-price').hide()):($('td.payment-refund-made-text').append(Ae),$('td.payment-refund-made-price').append(Be));var Me=$(this).find('creditsAppliedText').text(),$e=$(this).find('creditsAppliedPrice').text();$('td.credits-applied-text').append(Me),$('td.credits-applied-price').append($e);var qe=$(this).find('total-price2').text();$('.total-price2').append(qe);var Oe=$(this).find('total-price3').text();$('.total-price3').append(Oe);var ze=$(this).find('totaltext').text();$('.totl').append(ze);var He=$(this).find('refundtotal').text();$('td.refund-total').append(He);var Ge=$(this).find('refundedText').text();$('.refund-price').append(Ge);var We=$(this).find('total-price4').text();$('.total-price4').append(We);var Ke=$(this).find('saletax').text();$('.saletax').append(Ke);var Ve=$(this).find('paymentmsg').text();$('.footer .info p:first-child').append(Ve);var _e=$(this).find('signup').text();$('.footer .info p span').append(_e);var Ye=$(this).find('copyright').text();$('.copyright p').append(Ye);var Xe=$(this).find('title').text();$('head title').append(Xe);var Ze=$(this).find('item4price').text();$('.price .item4price').append(Ze);var Je=$(this).find('subtotalprice').text();$('.subtotal-price').append(Je);var Qe=$(this).find('received-text').text();$('.received-text').append(Qe);var et=$(this).find('received-price').text();$('.received-price').append(et);var tt=$(this).find('due-text').text();$('.due-text').append(tt);var at=$(this).find('due-price');$('.due-price').append(at);var nt=$(this).find('tip-text');$('.tip-text').append(nt);var it=$(this).find('tip-price');$('.tip-price').append(it)}),$.ajax({method:'POST',type:'POST',url:'generatePDF.php',data:{html:$('.pdf-page').html()}}).then(function(K){var V=document.getElementById('pdfLink');V.href='data:application/octet-stream;base64,'+K,V.click();debugger},function(K){console.error(K);debugger})}if(!h.entity.length)return console.log('User not logged in'),void 0;var U=h.entity[0],P=U.get('organizations')[0];y('DashboardController',{$scope:r,$state:l});var S=h.entity[0].currency.attributes;if(S.exchangeRate)r.currentCurrency=S;else{var k={currencySymbol:'$',exchangeRate:1};r.currentCurrency=k,S=k}var L;h.getField('dateFormat').then(function(E){r.dateFormat=E,L=r.dateFormat.toUpperCase().replace(/E/g,'d'),I()}),r.isOwner=!1,r.dateOptions={showWeeks:!1},r.changeTemplate=function(){showLoader(),o.when(C.getInvoiceTemplates()).then(function(E){var R=U.get('defaultTemplate'),A=[];E.forEach(function(B){var M={entity:B,name:B.get('name'),url:B.get('templatePreview').url()};M.isDefault=R||'Template 1'!=M.name?R.id==B.id:!0,A.push(M)}),r.templates=A,$('.change-template').addClass('show'),hideLoader()},function(E){console.log(E.message),hideLoader()})},r.setDefaultTemplate=function(E){showLoader(),r.templates.forEach(function(A){A.isDefault=!1}),r.templates[E].isDefault=!0,r.creditNote.entity.unset('creditReceipt'),U.set('defaultTemplate',r.templates[E].entity);var R=[];R.push(U.save()),R.push(r.creditNote.entity.save()),o.all(R).then(function(){hideLoader(),$('.change-template').removeClass('show'),console.log('default template selected'),l.reload()},function(A){hideLoader(),console.log(A,message)})},r.prepareAddPayment=function(){r.paymentDate=new Date,r.paymentAmount=r.creditNote.entity.remainingCredits.toFixed(2),r.paymentRef=''+Math.random().toString(10).substr(2,6),r.paymentModes=['Check','Cash','Bank Transfer','Bank Remittance'],r.selectedPaymentMode='Cash',$('#paymentForm').validate({rules:{paymentDate:'required',paymentAmount:{required:!0,number:!0,min:0.01,max:r.creditNote.entity.remainingCredits.toFixed(2)},paymentRef:'required',paymentMode:'required'},messages:{paymentDate:'Please select date',paymentAmount:{required:'Please enter refund amount',number:'Please enter valid amount',min:'Amount must be greater than 0',max:'Amount cannot be greater than remaining credits'},paymentRef:'Please enter reference number',paymentMode:'Please select refund mode'}}),$('#paymentForm').validate().resetForm()},r.addPayment=function(){if($('#paymentForm').valid()){showLoader();var E={userID:U,organization:P,date:r.paymentDate,mode:r.selectedPaymentMode,amount:+r.paymentAmount,reference:r.paymentRef,notes:r.paymentNotes,deleted:!1},R=r.creditNote.entity;R.unset('creditReceipt'),R.increment('refundsMade',E.amount),R.increment('remainingCredits',-E.amount),0>=R.remainingCredits?R.set('status','Closed'):R.set('status','Open');var A=o.when(C.getUserRole(U));A.then(function(B){return o.when(g.addRefunds([E],B))}).then(function(B){var M=R.get('refunds');return M=M?M.concat(B):B,R.set('refunds',M),R.save()}).then(function(){var B='Refund made for '+D(r.paymentAmount,'$',2)+' amount';N(B,!0).then(function(){hideLoader(),l.reload()})})}},r.textReceipt=function(){$('#text-error').hide();var E=r.creditNote.entity.get('customer'),R=E.get('contactPersons');return r.mobileContacts=[],R.length&&R.forEach(function(A){var B=A.get('firstname')?A.get('firstname'):'',M=A.get('lastname')?A.get('lastname'):'',q=1==A.get('defaultPerson'),O=B+' '+M;A.get('phone')&&r.mobileContacts.push({selected:!1,contact:A.get('phone'),contactName:'('+O+') '+A.get('phone')}),A.get('mobile')&&r.mobileContacts.push({selected:q,contact:A.get('mobile'),contactName:'('+O+') '+A.get('mobile')})}),r.mobileContacts.length?void $('.text-popup').addClass('show'):void ShowMessage('Please Enter Mobile for Customer!','error')},r.sendText=function(){var E=0;return r.mobileContacts.forEach(function(R){R.selected&&E++}),1>E?void $('#text-error').show():void(showLoader(),r.mobileContacts.forEach(function(R){R.selected&&g.sendCreditNoteTextToNumber(r.creditNote.entity,R.contact).then(function(){N('Credit Note texted to '+R.contact,!0),$('.text-popup').removeClass('show'),hideLoader()})}))},r.emailReceipt=function(){$('#email-error').hide();var E=r.creditNote.entity.get('customer'),R=E.get('contactPersons');return r.contacts=[],R.length&&R.forEach(function(A){var B=A.get('firstname')?A.get('firstname'):'',M=A.get('lastname')?A.get('lastname'):'',q=1==A.get('defaultPerson');A.get('email')&&r.contacts.push({selected:q,contact:A.get('email'),contactName:'('+(B+' '+M)+') '+A.get('email')})}),r.contacts.length?void $('.email-popup').addClass('show'):void ShowMessage('Please Enter Email for Customer!','error')},r.sendEmail=function(){var E=0;return r.contacts.forEach(function(R){R.selected&&E++}),1>E?void $('#email-error').show():void(showLoader(),r.contacts.forEach(function(R){R.selected&&g.sendCreditNoteReceiptToEmail(r.creditNote.entity,R.contact).then(function(){N('Credit Note emailed to '+R.contact,!0),$('.email-popup').removeClass('show'),hideLoader()})}))},r.creditNotePrinted=function(){N('Credit Note printed',!0)},r.addComment=function(){if(!r.newComment)return void $('.add-comment').removeClass('show');showLoader();var E={userID:U,organization:P,name:U.get('username'),date:new Date,isAutomaticallyGenerated:!1,comment:r.newComment},R={};o.when(C.getUserRole(U)).then(function(A){return T.createNewComment(E,A)}).then(function(A){R.commentObj=A;var B=r.creditNote.entity,M=B.get('comments');return M?M.push(A):M=[A],B.set('comments',M),B.save()}).then(function(){var A=new T(R.commentObj);A.date=formatDate(A.entity.date,L),r.comments?r.comments.push(A):r.comments=[A],console.log(A),$('.add-comment').removeClass('show'),r.newComment='',hideLoader()})},r.downloadInvoice=function(){var E=r.creditNote.entity.get('creditLabels')._url;debugger;var R=new XMLHttpRequest;R.open('GET',E,!1),R.setRequestHeader('Content-Type','text/xml'),R.send(null),F(R.responseXML)}}]);'use strict',invoicesUnlimited.controller('CloneEstimateController',['$scope','$state','$controller','$q','userFactory','estimateService','coreFactory','taxService','expenseService','currencyFilter',function(o,r,l,u,y,h,g,C,T,D){function I(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:1,digits:!0,messages:{required:'Please provide item quantity',min:'quantity should be >= 1',digits:'quantity must be integer'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0'}})}),$('.check-discount').each(function(){$(this).rules('remove'),$(this).rules('add',{min:0,max:100,number:!0,messages:{min:'discount should be >= 0',max:'discount should be <= 100'}})})}function F(){var q=[],O=null;return O=u.when(g.getAllCustomers()).then(function(H){o.customers=H.sort(function(G,W){return alphabeticalSort(G.entity.displayName,W.entity.displayName)})}),q.push(O),O=u.when(g.getAllItems({organization:B})).then(function(H){o.actualItems=H.filter(function(G){return!G.entity.expanseId}),o.expenseItems=H.filter(function(G){return G.entity.expanseId}),o.items=o.actualItems}),q.push(O),O=u.when(h.getPreferences(A)).then(function(H){o.prefs=H}),q.push(O),O=u.when(g.getUserRole(A)).then(function(H){o.userRole=H}),q.push(O),O=C.getTaxes(A,function(H){o.taxes=H}),q.push(O),u.all(q)}function U(){var q=o.estimate;switch(1==o.prefs.numAutoGen?(o.estimateNo=o.prefs.estimateNumber,o.disableEstNo=!0):(o.estimateNo='',o.disableEstNo=!1),o.refNumber=q.entity.referenceNumber||'',o.todayDate=new Date,o.prefs.discountType){case 0:o.itemLevelTax=!1,o.invoiceLevelTax=!1;break;case 1:o.itemLevelTax=!0,o.invoiceLevelTax=!1;break;case 2:case 3:o.itemLevelTax=!1,o.invoiceLevelTax=!0;}o.discount=q.entity.discounts,o.notes=q.entity.notes,o.terms=q.entity.termsConditions,o.showShippingCharges=!1,o.showAdjustments=!1,o.prefs.salesPerson&&(o.salesPerson=q.entity.salesPerson||'',o.showSalesPerson=!0),'Draft'!=q.entity.status&&(o.previouslySent=!0);var O=q.entity.estimateFiles;O?(O.forEach(function(Y){Y.fileName=Y.name(),Y.exist=!0}),o.files=O):o.files=[];for(var H=0;H<q.estimateItems.length;++H){var G=q.estimateItems[H].entity,W=G.get('item'),K={};K.selectedItem=o.items.filter(function(Y){if(Y.entity.id===W.id){K.id=G.id,K.rate=G.amount/G.quantity,K.quantity=G.quantity,K.discount=G.discount||0,K.taxValue=0,K.amount=G.amount;var X=G.get('tax');return K.selectedTax=X?o.taxes.filter(function(Z){return Z.id===X.id})[0]:void 0,!0}return!1})[0],o.estimateItems.push(K)}var V=[];o.prefs.customFields&&o.prefs.customFields.forEach(function(Y){'YES'==Y.isChecked&&V.push({name:Y.name,value:''})});var _=q.entity.customFields;_&&_.length&&V.forEach(function(Y){for(var X=0;X<_.length;++X)if(_[X][Y.name]){Y.value=_[X][Y.name];break}}),o.customFields=V,S(),hideLoader()}function P(){return u.when(T.getCustomerExpenses({organization:B,customer:o.selectedCustomer.entity})).then(function(q){for(var O=[],H=0;H<q.length;++H)for(var G=0;G<o.expenseItems.length;++G)q[H].entity.id==o.expenseItems[G].entity.expanseId&&O.push(o.expenseItems[G]);for(var W=[],H=0;H<q.length;++H){var K=q[H].entity,V=O.some(function(Y){return K.category==Y.entity.title&&K.amount==+Y.entity.rate});V||W.push({create:!0,tax:K.tax,entity:{title:K.category,rate:K.amount+'',expanseId:K.id}})}var _=o.actualItems.concat(O,W);return o.estimateItems=o.estimateItems.filter(function(Y){return!Y.selectedItem||Y.selectedItem.create?!1:_.some(function(X){return X.entity.id==Y.selectedItem.entity.id})}),o.items=_})}function S(){var q=o.estimateItems,O=0,H=0;o.itemTaxes=[],q.forEach(function(G){O+=G.amount*(0.01*(100-G.discount)),G.taxValue=calculateTax(G.amount,G.selectedTax),H+=G.taxValue,G.selectedTax&&o.itemTaxes.push({nameValue:G.selectedTax.name+' ('+G.selectedTax.rate+'%)',amount:D(G.taxValue,'$',2)})}),o.totalTax=H,o.subTotal=O,o.subTotalStr=D(O,'$',2),o.reCalculateTotal()}function k(){var q={userID:A,organization:B,customer:o.selectedCustomer.entity,estimateDate:o.todayDate,estimateNumber:o.estimateNo,status:'Draft',discountType:o.prefs.discountType,discounts:o.discount,shippingCharges:o.shippingCharges,adjustments:o.adjustments,subTotal:+o.subTotal,totalAmount:+o.total,referenceNumber:o.refNumber,salesPerson:o.salesPerson,notes:o.notes,termsConditions:o.terms};if(o.customFields.length){var O=[];o.customFields.forEach(function(G){if(G.value){var W={};W[G.name]=G.value,O.push(W)}}),O.length&&(q.customFields=O)}var H=o.selectedCustomer.entity.email;return H&&(q.customerEmails=[H]),h.createNewEstimate(q,o.estimateItems,o.userRole,o.files)}function L(){return k().then(function(q){return h.createEstimateReceipt(q.id).then(function(O){return h.sendEstimateReceipt(O)})})}function E(){I();var q=$('#addEstimateForm').valid(),O=$('#itemInfoForm').valid(),H=$('#extrasForm').valid();if(q&&O&&H)return!0;var G;q?O?!H&&(G=$('#extrasForm').validate()):G=$('#itemInfoForm').validate():G=$('#addEstimateForm').validate();var W=$(G.errorList[0].element).offset().top-30;return scrollToOffset(W),!1}function R(){var q=$('#addEstimateForm').validate();q.showErrors({estimateNumber:'Estimate with this number already exists'})}if(!y.entity.length)return console.log('User not logged in'),void 0;var A=y.entity[0],B=A.get('organizations')[0];l('DashboardController',{$scope:o,$state:r});var M=r.params.estimateId;M&&(function(){showLoader(),u.when(F()).then(function(){return u.when(h.getEstimate(M))}).then(function(q){return console.log(q),o.estimate=q,o.estimateItems=[],o.deletedItems=[],o.itemsWithOutId=0,o.itemsWithIdinDel=0,o.selectedCustomer=o.customers.filter(function(O){return q.entity.get('customer').id==O.entity.id})[0],u.when(P())}).then(function(){U()},function(q){hideLoader(),console.log(q.message)})}(),$('#addEstimateForm').validate({rules:{customer:'required',estimateNumber:'required',estimateCreateDate:'required'},messages:{customer:'Please select a customer',estimateNumber:'Please enter estimate number',estimateCreateDate:'Please provide estimate Create date'}}),$('#extrasForm').validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$('#itemInfoForm').validate(),o.dateOptions={showWeeks:!1},o.addNewFile=function(q){var O=q.files[0],H=O.name;return H.toLowerCase().endsWith('.pdf')||H.toLowerCase().endsWith('.png')||H.toLowerCase().endsWith('.jpg')||H.toLowerCase().endsWith('.jpeg')?void($('#file-error').hide(),O.fileName=O.name,o.files.push(O),!o.$$phase&&o.$apply()):void $('#file-error').show()},o.removeFile=function(q){o.files.splice(q,1)},o.openDatePicker=function(q){1===q?o.openPicker1=!0:void 0},o.addEstimateItem=function(){o.estimateItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},o.removeEstimateItem=function(q){1<o.estimateItems.length?(o.estimateItems.splice(q,1),S()):console.log('there should be atleast 1 item in an estimate')},o.reCalculateTotal=function(){var q=+o.subTotal||0,O=+o.discount||0,H=+o.shippingCharges||0,G=+o.adjustments||0,W=+o.totalTax||0,K=q+W,V=0.01*(100-O);2==o.prefs.discountType?K=q*V+W:3==o.prefs.discountType&&(K=(q+W)*V),O=Math.abs(K-q-W),o.total=K+H+G,o.discountStr=D(O,'$',2),o.shippingChargesStr=D(H,'$',2),o.adjustmentsStr=D(G,'$',2),o.totalStr=D(o.total,'$',2)},o.reCalculateItemAmount=function(q){var O=o.estimateItems[q];O.selectedItem&&(O.amount=O.rate*O.quantity,S())},o.itemChanged=function(q){var O=o.estimateItems[q];O.rate=+O.selectedItem.entity.rate;var H=O.selectedItem.tax;if(!H)O.selectedTax='';else for(var G=o.taxes,W=0;W<G.length;++W)if(H.id==G[W].id){O.selectedTax=G[W];break}o.reCalculateItemAmount(q)},o.customerChanged=function(){showLoader(),u.when(P()).then(function(){1>o.estimateItems.length?(o.addEstimateItem(),o.totalTax=0,o.subTotal=0,o.subTotalStr=D(0,'$',2),o.reCalculateTotal()):S(),hideLoader()})},o.cancel=function(){r.go('dashboard.sales.estimates.all')},o.save=function(){E()&&(showLoader(),u.when(h.checkEstimateNumAvailable({estimateNumber:o.estimateNo,organization:B})).then(function(q){return q?k():(R(),scrollToOffset(),Promise.reject('Estimate with this number already exists'))}).then(function(){hideLoader(),r.go('dashboard.sales.estimates.all')},function(q){hideLoader(),console.log(q)}))},o.saveAndSend=function(){E()&&(showLoader(),u.when(h.checkEstimateNumAvailable({estimateNumber:o.estimateNo,organization:B})).then(function(q){return q?L():(R(),scrollToOffset(),Promise.reject('Estimate with this number already exists'))}).then(function(){hideLoader(),r.go('dashboard.sales.estimates.all')},function(q){hideLoader(),console.log(q)}))})}]);'use strict',invoicesUnlimited.controller('CreateEstimateController',['$scope','$state','$controller','$q','userFactory','estimateService','coreFactory','taxService','commentFactory','expenseService','currencyFilter','salesCommon',function(o,r,l,u,y,h,g,C,T,D,I,N){function F(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:1,digits:!0,messages:{required:'Please provide item quantity',min:'quantity should be >= 1',digits:'quantity must be integer'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0',number:'Please enter a valid price'}})}),$('.check-discount').each(function(){$(this).rules('remove'),$(this).rules('add',{min:0,max:100,number:!0,messages:{min:'discount should be >= 0',max:'discount should be <= 100'}})})}function P(){switch(1==o.prefs.numAutoGen?(o.estimateNo=o.prefs.estimateNumber,o.disableEstNo=!0):(o.estimateNo='',o.disableEstNo=!1),o.notes=o.prefs.notes,o.terms=o.prefs.terms,o.files=[],o.todayDate=new Date,o.subTotalStr=I(0,'$',2),o.prefs.discountType){case 0:o.itemLevelTax=!1,o.invoiceLevelTax=!1;break;case 1:o.itemLevelTax=!0,o.invoiceLevelTax=!1;break;case 2:case 3:o.itemLevelTax=!1,o.invoiceLevelTax=!0,o.discountStr=I(0,'$',2);}o.showShippingCharges=!1,o.showAdjustments=!1,o.prefs.salesPerson&&(o.showSalesPerson=!0),o.estimateItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var W=r.params.customerId,K=r.params.expenseId;W&&(o.selectedCustomer=o.customers.filter(function(_){return _.entity.id==W})[0],L(),K&&u.when(k()).then(function(){o.addEstimateItem(),o.estimateItems[0].selectedItem=o.items.filter(function(_){return _.entity.expanseId==K})[0],o.estimateItems[0].selectedItem.create=!0,o.itemChanged(0)}));var V=[];o.prefs.customFields&&o.prefs.customFields.forEach(function(_){'YES'==_.isChecked&&V.push({name:_.name,value:''})}),o.customFields=V,hideLoader()}function S(){var W=o.estimateItems,K=0,V=0;o.itemTaxes=[],W.forEach(function(_){K+=_.amount*(0.01*(100-_.discount));var Y=+o.discount||0;if(_.taxValue=2==o.prefs.discountType?calculateTax(_.amount*(0.01*(100-Y)),_.selectedTax):calculateTax(_.amount,_.selectedTax),V+=_.taxValue,_.selectedTax){var X=-1;o.itemTaxes.length&&(X=o.itemTaxes.findIndex(function(Z){return Z.name==_.selectedTax.name})),-1==X?o.itemTaxes.push({nameValue:_.selectedTax.name+' ('+_.selectedTax.rate+'%)',amount:I(_.taxValue,'$',2),count:1,name:_.selectedTax.name,amountValue:_.taxValue}):(o.itemTaxes[X].amountValue+=_.taxValue,o.itemTaxes[X].count++,o.itemTaxes[X].amount=I(o.itemTaxes[X].amountValue,'$',2),o.itemTaxes[X].nameValue=_.selectedTax.name+' ('+_.selectedTax.rate+'%)')}}),o.totalTax=V,o.subTotal=K,o.subTotalStr=I(K,'$',2),o.reCalculateTotal()}function k(){return u.when(D.getCustomerExpenses({organization:G,customer:o.selectedCustomer.entity})).then(function(W){for(var K=[],V=0;V<W.length;++V)if('Yes'==W[V].entity.get('billable'))for(var _=0;_<o.expenseItems.length;++_)W[V].entity.id==o.expenseItems[_].entity.expanseId&&K.push(o.expenseItems[_]);for(var Y=[],V=0;V<W.length;++V)if('No'!=W[V].entity.get('billable')){var X=W[V].entity,Z=K.some(function(ue){return X.category==ue.entity.title&&X.amount==+ue.entity.rate});Z||Y.push({create:!0,tax:X.tax,entity:{title:X.category,rate:X.amount+'',expanseId:X.id}})}o.actualItems.pop();var J=o.actualItems.concat(K,Y);return o.estimateItems=o.estimateItems.filter(function(Q){return!Q.selectedItem||Q.selectedItem.create?!1:J.some(function(ee){return ee.entity.id==Q.selectedItem.entity.id})}),'Sales'!=H.get('role')&&J.push(createItemOpener),o.items=J})}function L(){return o.selectedCustomer.dummy?void r.go('dashboard.customers.new',{backLink:r.current.name}):void(showLoader(),u.when(k()).then(function(){1>o.estimateItems.length?(o.addEstimateItem(),o.totalTax=0,o.subTotal=0,o.subTotalStr=I(0,'$',2),o.reCalculateTotal()):S(),hideLoader()}))}function E(){var W={userID:H,organization:G,customer:o.selectedCustomer.entity,estimateDate:o.todayDate,estimateNumber:o.estimateNo,status:'Draft',discountType:o.prefs.discountType,discounts:o.discount,shippingCharges:o.shippingCharges,adjustments:o.adjustments,subTotal:+o.subTotal,totalAmount:+o.total,referenceNumber:o.refNumber,salesPerson:o.salesPerson,notes:o.notes,termsConditions:o.terms};if(o.customFields.length){var K=[];o.customFields.forEach(function(_){if(_.value){var Y={};Y[_.name]=_.value,K.push(Y)}}),K.length&&(W.customFields=K)}var V=o.selectedCustomer.entity.email;return V&&(W.customerEmails=[V]),h.createNewEstimate(W,o.estimateItems,o.userRole,o.files).then(function(_){return M('Estimate created for '+I(_.attributes.totalAmount,'$',2)+' amount',!0,_),_})}function R(){return E().then(function(W){return h.createEstimateReceipt(W.id).then(function(K){var V=K.get('status');return'Draft'==V&&(K.set('status','Sent'),K.save()),A(K),K})})}function A(W){o.contacts.forEach(function(K){K.selected&&h.sendEstimateReceiptToEmail(W,K.contact).then(function(){M('Estimate emailed to '+K.contact,!0,W)})}),o.mobileContacts.forEach(function(K){K.selected&&h.sendEstimetTextToNumber(W,K.contact).then(function(){M('Estimate texted to '+K.contact,!0,W)})})}function B(){F();var W=$('#addEstimateForm').valid(),K=$('#itemInfoForm').valid(),V=$('#extrasForm').valid();if(W&&K&&V)return!0;var _;W?K?!V&&(_=$('#extrasForm').validate()):_=$('#itemInfoForm').validate():_=$('#addEstimateForm').validate();var Y=$(_.errorList[0].element).offset().top-30;return scrollToOffset(Y),!1}function M(W,K,V){var _={userID:H,organization:G,name:H.get('username'),date:new Date,isAutomaticallyGenerated:!1,comment:W};if(H.get('isTrackUsage')||!K){var Y={};u.when(g.getUserRole(H)).then(function(X){return T.createNewComment(_,X)}).then(function(X){Y.commentObj=X;var Z=V.get('comments');Z?Z.push(X):Z=[X],V.set('comments',Z),V.save()})}}function q(){B()&&(showLoader(),u.when(h.checkEstimateNumAvailable({estimateNumber:o.estimateNo,organization:G})).then(function(W){return W?R():(O(),scrollToOffset(),Promise.reject('Estimate with this number already exists'))}).then(function(W){hideLoader(),r.go('dashboard.sales.estimates.details',{estimateId:W.id})},function(W){hideLoader(),r.go('dashboard.sales.estimates.all'),console.log(W)}))}function O(){var W=$('#addEstimateForm').validate();W.showErrors({estimateNumber:'Estimate with this number already exists'})}if(!y.entity.length)return console.log('User not logged in'),void 0;var H=y.entity[0],G=H.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),function(){showLoader();var W=[],K=null;K=u.when(g.getAllCustomers()).then(function(V){V=V.filter(function(_){return'active'==_.entity.status}),o.customers=V.sort(function(_,Y){return alphabeticalSort(_.entity.displayName,Y.entity.displayName)}),o.customers.forEach(function(_){_.fullName=_.entity.salutation?_.entity.salutation+' '+_.entity.displayName:_.entity.displayName}),'Sales'!=H.get('role')&&o.customers.push(createCustomerOpener)}),W.push(K),K=u.when(g.getAllItems({organization:G})).then(function(V){o.actualItems=V.filter(function(_){return!_.entity.expanseId}),o.expenseItems=V.filter(function(_){return _.entity.expanseId}),o.items=o.actualItems,'Sales'!=H.get('role')&&o.items.push(createItemOpener)}),W.push(K),K=u.when(h.getPreferences(H)).then(function(V){o.prefs=V}),W.push(K),K=u.when(g.getUserRole(H)).then(function(V){o.userRole=V}),W.push(K),K=C.getTaxes(H,function(V){o.taxes=V,'Sales'!=H.get('role')&&o.taxes.push(createTaxOpener)}),W.push(K),K=y.getField('dateFormat').then(function(V){o.dateFormat=V}),W.push(K),u.all(W).then(function(){P()},function(V){hideLoader(),console.log(V.message)})}(),$('#addEstimateForm').validate({rules:{customer:'required',estimateNumber:'required',estimateCreateDate:'required'},messages:{customer:'Please select a customer',estimateNumber:'Please enter estimate number',estimateCreateDate:'Please provide estimate Create date'}}),$('#extrasForm').validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$('#itemInfoForm').validate(),o.dateOptions={showWeeks:!1},o.openDatePicker=function(W){1===W?o.openPicker1=!0:void 0},o.addNewFile=function(W){var K=W.files[0],V=K.name;if(0<=V.toLowerCase().indexOf('^')&&(V=V.replace('^','')),!(V.toLowerCase().endsWith('.pdf')||V.toLowerCase().endsWith('.png')||V.toLowerCase().endsWith('.jpg')||V.toLowerCase().endsWith('.jpeg')))return void $('#file-error').show();$('#file-error').hide();var _=W.files[0].size;return 5242880<_?void $('#file-size-error').show():void($('#file-size-error').hide(),K.fileName=V,o.files.push(K),!o.$$phase&&o.$apply())},o.removeFile=function(W){o.files.splice(W,1)},o.addEstimateItem=function(){o.estimateItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},o.removeEstimateItem=function(W){1<o.estimateItems.length?(o.estimateItems.splice(W,1),S()):console.log('there should be atleast 1 item in an estimate')},o.reCalculateTotal=function(){var W=+o.subTotal||0,K=+o.discount||0,V=+o.shippingCharges||0,_=+o.adjustments||0,Y=+o.totalTax||0,X=W+Y,Z=0.01*(100-K);2==o.prefs.discountType?X=W*Z+Y:3==o.prefs.discountType&&(X=(W+Y)*Z),K=Math.abs(X-W-Y),o.total=X+V+_,o.discountStr=I(K,'$',2),o.shippingChargesStr=I(V,'$',2),o.adjustmentsStr=I(_,'$',2),o.totalStr=I(o.total,'$',2)},o.reCalculateSubTotal=S,o.reCalculateItemAmount=function(W){var K=o.estimateItems[W];K.selectedItem&&(K.amount=K.rate*K.quantity,S())},o.prepareCreateItem=function(){N.prepareCreateItem({_scope:o})},o.createNewItem=function(){N.createNewEstimateItem({_scope:o,user:H,organization:G})},o.itemChanged=function(W){var K=o.estimateItems[W];if(K.selectedItem.dummy)return K.selectedItem=null,$('.new-item').addClass('show'),o.itemChangedIndex=W,void o.prepareCreateItem();K.rate=+K.selectedItem.entity.rate;var V=K.selectedItem.tax;if(!V)K.selectedTax='';else for(var _=o.taxes,Y=0;Y<_.length;++Y)if(V.id==_[Y].id){K.selectedTax=_[Y];break}o.reCalculateItemAmount(W)},o.customerChanged=L,o.cancel=function(){r.go('dashboard.sales.estimates.all')},o.save=function(){B()&&(showLoader(),u.when(h.checkEstimateNumAvailable({estimateNumber:o.estimateNo,organization:G})).then(function(W){return W?E():(O(),scrollToOffset(),Promise.reject('Estimate with this number already exists'))}).then(function(W){hideLoader(),r.go('dashboard.sales.estimates.details',{estimateId:W.id})},function(W){hideLoader(),console.log(W)}))},o.saveAndSend=function(){if(B()){$('#emailText-error').hide();var W=o.selectedCustomer.entity.get('contactPersons');o.contacts=[],o.mobileContacts=[],W.length&&W.forEach(function(K){var V=K.get('firstname')?K.get('firstname'):'',_=K.get('lastname')?K.get('lastname'):'',Y=1==K.get('defaultPerson'),X=V+' '+_;K.get('email')&&o.contacts.push({selected:Y,contact:K.get('email'),contactName:'('+X+') '+K.get('email')}),K.get('phone')&&o.mobileContacts.push({selected:!1,contact:K.get('phone'),contactName:'('+X+') '+K.get('phone')}),K.get('mobile')&&o.mobileContacts.push({selected:Y,contact:K.get('mobile'),contactName:'('+X+') '+K.get('mobile')})}),o.contacts.length||o.mobileContacts.length?$('.email-text').addClass('show'):ShowMessage('The customer does not have a email or phone number in their profile. Please select save.','error')}},o.sendReceipt=function(){debugger;var W=0,K=0;o.contacts.forEach(function(V){V.selected&&W++}),o.mobileContacts.forEach(function(V){V.selected&&K++}),0<W||0<K?q():$('#emailText-error').show()},o.taxChanged=function(W){if(console.log('tax changed'),-1!=W){var K=o.estimateItems[W];if(!K.selectedTax)S();else if(K.selectedTax.dummy)return o.currentItem=W,o.taxName=null,o.taxRate=null,K.selectedTax=null,void $('.new-tax').addClass('show')}else if(o.newItem.tax.dummy)return o.currentItem=W,o.newItem.tax=null,o.taxName=null,o.taxRate=null,void $('.new-tax').addClass('show');S()},o.saveNewTax=function(){N.createNewEstimateTax({_scope:o,user:H},function(){S(),o.$$phase||o.$apply()})}}]);'use strict',invoicesUnlimited.controller('EstimateController',['$q','$scope','$state','$controller','userFactory','estimateService','coreFactory','taxService','expenseService','commentFactory','currencyFilter',function(o,r,l,u,y,h,g,C,T,D,I){function N(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:1,digits:!0,messages:{required:'Please provide item quantity',min:'quantity should be >= 1',digits:'quantity must be integer'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0',number:'Please enter a valid price'}})}),$('.check-discount').each(function(){$(this).rules('remove'),$(this).rules('add',{min:0,max:100,number:!0,messages:{min:'discount should be >= 0',max:'discount should be <= 100'}})})}function F(K){K||(K=l.current.name),W.estimates(K)?(console.log('its in list'),O()):W.newEstimate(K)?console.log('its in new'):W.edit(K)&&(console.log('its in edit'),U())}function U(){var K=l.params.estimateId;if(K){var V=l.params.customerId;showLoader(),o.when(q()).then(function(){return o.when(h.getEstimate(K))}).then(function(_){return console.log(_),r.estimate=_,r.estimateItems=[],r.deletedItems=[],r.itemsWithOutId=0,r.itemsWithIdinDel=0,r.selectedCustomer=V?r.customers.filter(function(Y){return V===Y.entity.id})[0]:r.customers.filter(function(Y){return _.entity.get('customer').id===Y.entity.id})[0],o.when(B())}).then(function(){P()},function(_){hideLoader(),console.log(_.message)})}}function P(){var K=r.estimate;switch(r.estimateNo=K.entity.estimateNumber,r.refNumber=K.entity.referenceNumber||'',r.disableEstNo=1==r.prefs.numAutoGen,r.todayDate=K.entity.estimateDate,r.prefs.discountType){case 0:r.itemLevelTax=!1,r.invoiceLevelTax=!1;break;case 1:r.itemLevelTax=!0,r.invoiceLevelTax=!1;break;case 2:case 3:r.itemLevelTax=!1,r.invoiceLevelTax=!0;}r.discount=K.entity.discounts,r.notes=K.entity.notes,r.terms=K.entity.termsConditions,r.showShippingCharges=!1,r.showAdjustments=!1,r.prefs.salesPerson&&(r.salesPerson=K.entity.salesPerson||'',r.showSalesPerson=!0),'Draft'!=K.entity.status&&(r.previouslySent=!0);for(var V=0;V<K.estimateItems.length;++V){var _=K.estimateItems[V].entity,Y=_.get('item'),X={};X.selectedItem=r.items.filter(function(ee){if(ee.entity.id===Y.id){X.id=_.id,X.rate=_.amount/_.quantity,X.quantity=_.quantity,X.discount=_.discount||0,X.taxValue=0,X.amount=_.amount;var te=_.get('tax');return X.selectedTax=te?r.taxes.filter(function(se){return se.id===te.id})[0]:void 0,!0}return!1})[0],r.estimateItems.push(X)}var Z=K.entity.estimateFiles;Z?(Z.forEach(function(ee){ee.fileName=ee.name(),ee.fileName1=ee.fileName.substring(ee.fileName.indexOf('_')+1,ee.fileName.length),ee.exist=!0}),r.files=Z):r.files=[];var J=[];r.prefs.customFields&&r.prefs.customFields.forEach(function(ee){'YES'==ee.isChecked&&J.push({name:ee.name,value:''})});var Q=K.entity.customFields;Q&&Q.length&&J.forEach(function(ee){for(var te=0;te<Q.length;++te)if(Q[te][ee.name]){ee.value=Q[te][ee.name];break}}),r.customFields=J,A(),hideLoader()}function S(){var K=r.itemsWithIdinDel,V=r.itemsWithOutId;if(!(0>=K||0>=V)){var _=0,Y=r.estimateItems;r.deletedItems.forEach(function(X){if(X.id)for(;_<Y.length;++_)if(!Y[_].id)return Y[_].id=X.id,X.id=void 0,--r.itemsWithIdinDel,void--r.itemsWithOutId}),r.deletedItems=r.deletedItems.filter(function(X){return!!X.id})}}function k(K){var V=r.estimate.entity;if(V.set('customer',r.selectedCustomer.entity),V.set('estimateDate',r.todayDate),V.set('estimateNumber',r.estimateNo),V.set('discountType',r.prefs.discountType),V.set('discounts',r.discount),V.set('shippingCharges',r.shippingCharges),V.set('adjustments',r.adjustments),V.set('subTotal',+r.subTotal),V.set('totalAmount',+r.total),V.set('referenceNumber',r.refNumber),V.set('salesPerson',r.salesPerson),V.set('notes',r.notes),V.set('termsConditions',r.terms),r.customFields.length){var _=[];r.customFields.forEach(function(X){if(X.value){var Z={};Z[X.name]=X.value,_.push(Z)}}),_.length?V.set('customFields',_):V.unset('customFields')}var Y=r.selectedCustomer.entity.email;return Y?V.set('customerEmails',[Y]):V.unset('customerEmails'),h.updateEstimate(r.estimate,r.estimateItems,r.deletedItems,H,r.userRole,r.files).then(function(X){return L('Estimate edited',!0),K.generateReceipt?h.createEstimateReceipt(X.id):X})}function L(K,V){var _={userID:H,organization:G,name:H.get('username'),date:new Date,isAutomaticallyGenerated:!1,comment:K};if(H.get('isTrackUsage')||!V){var Y={};o.when(g.getUserRole(H)).then(function(X){return D.createNewComment(_,X)}).then(function(X){Y.commentObj=X;var Z=r.estimate.entity,J=Z.get('comments');return J?J.push(X):J=[X],Z.set('comments',J),Z.save()})}}function E(){return k({generateReceipt:!1}).then(function(K){return h.createEstimateReceipt(K.id).then(function(V){return h.sendEstimateReceipt(V)})})}function R(){N();var K=$('#editEstimateForm').valid(),V=$('#itemInfoForm').valid(),_=$('#extrasForm').valid();if(K&&V&&_)return!0;var Y;K?V?!_&&(Y=$('#extrasForm').validate()):Y=$('#itemInfoForm').validate():Y=$('#editEstimateForm').validate();var X=$(Y.errorList[0].element).offset().top-30;return scrollToOffset(X),!1}function A(){var K=r.estimateItems,V=0,_=0;r.itemTaxes=[],K.forEach(function(Y){V+=Y.amount*(0.01*(100-Y.discount));var X=+r.discount||0;if(Y.taxValue=2==r.prefs.discountType?calculateTax(Y.amount*(0.01*(100-X)),Y.selectedTax):calculateTax(Y.amount,Y.selectedTax),_+=Y.taxValue,Y.selectedTax){var Z=-1;r.itemTaxes.length&&(Z=r.itemTaxes.findIndex(function(J){return J.name==Y.selectedTax.name})),-1==Z?r.itemTaxes.push({nameValue:Y.selectedTax.name+' ('+Y.selectedTax.rate+'%)',amount:I(Y.taxValue,'$',2),count:1,name:Y.selectedTax.name,amountValue:Y.taxValue}):(r.itemTaxes[Z].amountValue+=Y.taxValue,r.itemTaxes[Z].count++,r.itemTaxes[Z].amount=I(r.itemTaxes[Z].amountValue,'$',2),r.itemTaxes[Z].nameValue=Y.selectedTax.name+' ('+Y.selectedTax.rate+'%)')}}),r.totalTax=_,r.subTotal=V,r.subTotalStr=I(V,'$',2),r.reCalculateTotal()}function B(){return o.when(T.getCustomerExpenses({organization:G,customer:r.selectedCustomer.entity})).then(function(K){for(var V=[],_=0;_<K.length;++_)if('Yes'==K[_].entity.get('billable'))for(var Y=0;Y<r.expenseItems.length;++Y)K[_].entity.id==r.expenseItems[Y].entity.expanseId&&V.push(r.expenseItems[Y]);for(var X=[],_=0;_<K.length;++_)if('No'!=K[_].entity.get('billable')){var Z=K[_].entity,J=V.some(function(pe){return Z.category==pe.entity.title&&Z.amount==+pe.entity.rate});J||X.push({create:!0,tax:Z.tax,entity:{title:Z.category,rate:Z.amount+'',expanseId:Z.id}})}var Q=r.actualItems.concat(V,X);return r.estimateItems=r.estimateItems.filter(function(ee){return!ee.selectedItem||ee.selectedItem.create?!1:Q.some(function(te){return te.entity.id==ee.selectedItem.entity.id})}),r.items=Q})}function q(){var K=[],V=null;return V=o.when(g.getAllCustomers()).then(function(_){r.customers=_.sort(function(Y,X){return alphabeticalSort(Y.entity.displayName,X.entity.displayName)}),r.customers.forEach(function(Y){Y.fullName=Y.entity.salutation?Y.entity.salutation+' '+Y.entity.displayName:Y.entity.displayName}),'Sales'!=H.get('role')&&r.customers.push(createCustomerOpener)}),K.push(V),V=o.when(g.getAllItems({organization:G})).then(function(_){r.actualItems=_.filter(function(Y){return!Y.entity.expanseId}),r.expenseItems=_.filter(function(Y){return Y.entity.expanseId}),r.items=r.actualItems}),K.push(V),V=o.when(h.getPreferences(H)).then(function(_){r.prefs=_}),K.push(V),V=o.when(g.getUserRole(H)).then(function(_){r.userRole=_}),K.push(V),V=C.getTaxes(H,function(_){r.taxes=_}),K.push(V),o.all(K)}function O(){showLoader(),o.when(h.listEstimates(H)).then(function(K){var V=r.dateFormat.toUpperCase().replace(/E/g,'d');K.forEach(function(_){switch(_.entity.status){case'Draft':case'Sent':_.statusClass='text-color-normalize';break;case'Invoiced':case'Accepted':_.statusClass='text-positive';break;case'Declined':_.statusClass='text-danger';break;default:_.statusClass='text-color-normalize';}_.entity.get('estimateFiles')&&(_.attachments=1),_.estimateDate=formatDate(_.entity.estimateDate,V),_.totalAmount=I(_.entity.totalAmount,'$',2)}),r.estimateList=K,r.allestimateList=K,r.displayInvoice=K,r.sortByDate(),hideLoader()},function(K){hideLoader(),console.log(K.message)})}if(!y.entity.length)return console.log('User not logged in'),void 0;var H=y.entity[0],G=H.get('organizations')[0];u('DashboardController',{$scope:r,$state:l});var W={details:function(K){return K.endsWith('estimates.details')},estimates:function(K){return K.endsWith('estimates.all')},edit:function(K){return K.endsWith('estimates.edit')},newEstimate:function(K){return K.endsWith('estimates.new')}};y.getField('dateFormat').then(function(K){r.dateFormat=K,F()}),$('#editEstimateForm').validate({rules:{customer:'required',estimateNumber:'required',estimateCreateDate:'required'},messages:{customer:'Please select a customer',estimateNumber:'Please enter estimate number',estimateCreateDate:'Please provide estimate Create date'}}),$('#extrasForm').validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$('#itemInfoForm').validate(),r.dateOptions={showWeeks:!1},r.addNewFile=function(K){var V=K.files[0],_=V.name;if(0<=_.toLowerCase().indexOf('^')&&(_=_.replace('^','')),!(_.toLowerCase().endsWith('.pdf')||_.toLowerCase().endsWith('.png')||_.toLowerCase().endsWith('.jpg')||_.toLowerCase().endsWith('.jpeg')))return void $('#file-error').show();$('#file-error').hide();var Y=K.files[0].size;return 5242880<Y?void $('#file-size-error').show():void($('#file-size-error').hide(),V.fileName=_,r.files.push(V),!r.$$phase&&r.$apply())},r.removeFile=function(K){r.files.splice(K,1)},r.addEstimateItem=function(){var K=r.deletedItems.pop();K?--r.itemsWithIdinDel:(K={id:void 0},++r.itemsWithOutId),K.selectedItem=void 0,K.selectedTax=void 0,K.rate=0,K.quantity=1,K.discount=0,K.taxValue=0,K.amount=0,r.estimateItems.push(K)},r.removeEstimateItem=function(K){if(1<r.estimateItems.length){var V=r.estimateItems.splice(K,1)[0];V.id?(++r.itemsWithIdinDel,r.deletedItems.push(V)):--r.itemsWithOutId,A()}else console.log('there should be atleast 1 item in an estimate')},r.save=function(){R()&&(showLoader(),S(),k({generateReceipt:!0}).then(function(K){hideLoader(),console.log(K),l.go('dashboard.sales.estimates.details',{estimateId:K.id})},function(K){hideLoader(),console.log(K.message)}))},r.saveAndSend=function(){R()&&(showLoader(),S(),E().then(function(K){hideLoader(),console.log(K),l.go('dashboard.sales.estimates.all')},function(K){hideLoader(),console.log(K)}))},r.cancel=function(){l.go('dashboard.sales.estimates.all')},r.openDatePicker=function(K){1===K?r.openPicker1=!0:void 0},r.reCalculateTotal=function(){var K=+r.subTotal||0,V=+r.discount||0,_=+r.shippingCharges||0,Y=+r.adjustments||0,X=+r.totalTax||0,Z=K+X,J=0.01*(100-V);2==r.prefs.discountType?Z=K*J+X:3==r.prefs.discountType&&(Z=(K+X)*J),V=Math.abs(Z-K-X),r.total=Z+_+Y,r.discountStr=I(V,'$',2),r.shippingChargesStr=I(_,'$',2),r.adjustmentsStr=I(Y,'$',2),r.totalStr=I(r.total,'$',2)},r.reCalculateSubTotal=A,r.reCalculateItemAmount=function(K){var V=r.estimateItems[K];V.selectedItem&&(V.amount=V.rate*V.quantity,A())},r.itemChanged=function(K){var V=r.estimateItems[K];V.rate=+V.selectedItem.entity.rate;var _=V.selectedItem.tax;if(!_)V.selectedTax='';else for(var Y=r.taxes,X=0;X<Y.length;++X)if(_.id==Y[X].id){V.selectedTax=Y[X];break}r.reCalculateItemAmount(K)},r.customerChanged=function(){return r.selectedCustomer.dummy?void l.go('dashboard.customers.new',{backLink:l.current.name,estimateId:l.params.estimateId}):void(showLoader(),o.when(B()).then(function(){1>r.estimateItems.length?(r.addEstimateItem(),r.totalTax=0,r.subTotal=0,r.subTotalStr=I(0,'$',2),r.reCalculateTotal()):A(),hideLoader()}))},r.sortByEstimateNumber=function(){r.estimateList.sort(function(K,V){return K.entity.estimateNumber.localeCompare(V.entity.estimateNumber)}),'none'===$('#estimate').css('display')?(r.estimateList.sort(function(K,V){return K.entity.estimateNumber.localeCompare(V.entity.estimateNumber)}),$('#estimate').css({display:'inline-table'}),$('#estimateUp').css({display:'none'})):(r.estimateList.sort(function(K,V){return V.entity.estimateNumber.localeCompare(K.entity.estimateNumber)}),$('#estimateUp').css({display:'inline-table'}),$('#estimate').css({display:'none'})),$('#date').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByDate=function(){'none'===$('#date').css('display')?(r.estimateList.sort(function(K,V){return K.entity.estimateDate>V.entity.estimateDate?-1:K.entity.estimateDate<V.entity.estimateDate?1:0}),$('#date').css({display:'inline-table'}),$('#dateUp').css({display:'none'})):(r.estimateList.sort(function(K,V){return V.entity.estimateDate>K.entity.estimateDate?-1:V.entity.estimateDate<K.entity.estimateDate?1:0}),$('#dateUp').css({display:'inline-table'}),$('#date').css({display:'none'})),$('#estimate').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#estimateUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByRefNo=function(){'none'===$('#refno').css('display')?(r.estimateList.sort(function(K,V){return K.entity.referenceNumber.localeCompare(V.entity.referenceNumber)}),$('#refno').css({display:'inline-table'}),$('#refnoUp').css({display:'none'})):(r.estimateList.sort(function(K,V){return V.entity.referenceNumber.localeCompare(K.entity.referenceNumber)}),$('#refnoUp').css({display:'inline-table'}),$('#refno').css({display:'none'})),$('#date').css({display:'none'}),$('#estimate').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#estimateUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByCustomerName=function(){'none'===$('#cusname').css('display')?(r.estimateList.sort(function(K,V){return K.customer.displayName.localeCompare(V.customer.displayName)}),$('#cusname').css({display:'inline-table'}),$('#cusnameUp').css({display:'none'})):(r.estimateList.sort(function(K,V){return V.customer.displayName.localeCompare(K.customer.displayName)}),$('#cusnameUp').css({display:'inline-table'}),$('#cusname').css({display:'none'})),$('#date').css({display:'none'}),$('#estimate').css({display:'none'}),$('#refno').css({display:'none'}),$('#status').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#estimateUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByStatus=function(){'none'===$('#status').css('display')?(r.estimateList.sort(function(K,V){return K.entity.status.localeCompare(V.entity.status)}),$('#status').css({display:'inline-table'}),$('#statusUp').css({display:'none'})):(r.estimateList.sort(function(K,V){return V.entity.status.localeCompare(K.entity.status)}),$('#statusUp').css({display:'inline-table'}),$('#status').css({display:'none'})),$('#date').css({display:'none'}),$('#estimate').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#estimateUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByAmount=function(){'none'===$('#amount').css('display')?(r.estimateList.sort(function(K,V){return K.entity.totalAmount-V.entity.totalAmount}),$('#amount').css({display:'inline-table'}),$('#amountUp').css({display:'none'})):(r.estimateList.sort(function(K,V){return V.entity.totalAmount-K.entity.totalAmount}),$('#amountUp').css({display:'inline-table'}),$('#amount').css({display:'none'})),$('#date').css({display:'none'}),$('#estimate').css({display:'none'}),$('#refno').css({display:'none'}),$('#cusname').css({display:'none'}),$('#status').css({display:'none'}),$('#duedate').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#estimateUp').css({display:'none'}),$('#refnoUp').css({display:'none'}),$('#cusnameUp').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#duedateUp').css({display:'none'})},r.showMenu=function(){$('.filtermenu').hasClass('show')?$('.filtermenu').removeClass('show'):$('.filtermenu').addClass('show')},r.currentEstimates='All Estimates',r.allEstimates=function(){r.estimateList=r.allestimateList.filter(function(){return!0}),r.displayInvoice=r.estimateList,r.currentEstimates='All Estimates',$('.filtermenu').removeClass('show')},r.draftEstimates=function(){r.estimateList=r.allestimateList.filter(function(K){return'Draft'==K.entity.status}),r.displayInvoice=r.estimateList,r.currentEstimates='Draft Estimate',$('.filtermenu').removeClass('show')},r.sentEstimates=function(){r.estimateList=r.allestimateList.filter(function(K){return'Sent'==K.entity.status}),r.displayInvoice=r.estimateList,r.currentEstimates='Sent Estimates',$('.filtermenu').removeClass('show')},r.invoicedEstimates=function(){r.estimateList=r.allestimateList.filter(function(K){return'Invoiced'==K.entity.status}),r.displayInvoice=r.estimateList,r.currentEstimates='Invoiced Estimates',$('.filtermenu').removeClass('show')},r.search=function(){r.estimateList=r.searchText.length?r.displayInvoice.filter(function(K){return K.estimateDate||(K.estimateDate=''),K.entity.estimateNumber||(K.entity.estimateNumber=''),K.entity.referenceNumber||(K.entity.referenceNumber=''),K.customer.displayName||(K.customer.displayName=''),K.statusClass||(K.statusClass=''),K.entity.status||(K.entity.status=''),K.totalAmount||(K.totalAmount=''),K.estimateDate.toLowerCase().includes(r.searchText.toLowerCase())||K.entity.estimateNumber.toLowerCase().includes(r.searchText.toLowerCase())||K.entity.referenceNumber.toLowerCase().includes(r.searchText.toLowerCase())||K.customer.displayName.toLowerCase().includes(r.searchText.toLowerCase())||K.statusClass.toLowerCase().includes(r.searchText.toLowerCase())||K.entity.status.toLowerCase().includes(r.searchText.toLowerCase())||K.totalAmount.toLowerCase().includes(r.searchText.toLowerCase())}):r.displayInvoice}}]);'use strict',invoicesUnlimited.controller('EstimateDetailController',['$q','$scope','$state','$sce','$controller','userFactory','estimateService','coreFactory','commentFactory','currencyFilter',function(o,r,l,u,y,h,g,C,T){function I(){scrollToOffset();var k=l.params.estimateId;k&&(showLoader(),o.when(g.getEstimateDetails(k)).then(function(L){var E=L.entity.get('userID');'General Employee'==h.entity[0].get('role')?h.entity[0].id==E.id&&(r.isOwner=!0):r.isOwner=!0,1==L.entity.get('customer').get('isDeleted')&&(r.isOwner=!1),r.estimate=L,r.estimateNo=L.entity.estimateNumber,L.comments&&L.comments.forEach(function(A){A.date=formatDate(A.entity.date,S)}),r.comments=L.comments;var R=L.entity.estimateReceipt;return L.attachments?(L.attachments.forEach(function(A){A.fileName=A.name(),A.fileName1=A.fileName.substring(A.fileName.indexOf('_')+1,A.fileName.length),A.fileUrl=A.url()}),r.attachments=L.attachments):r.attachments=[],R?Promise.resolve(R):g.createEstimateReceipt(k).then(function(A){return A.get('estimateReceipt')})}).then(function(L){r.templateUrl=u.trustAsResourceUrl(L.url());debugger;return $.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:L.url()}}).then(function(E){var R=document.getElementById('estimateFrame');R.src='about:blank',R.contentWindow.document.open(),R.contentWindow.document.write(E),R.contentWindow.document.close(),hideLoader()})},function(L){hideLoader(),console.log(L.message)}))}function N(k,L){var E={userID:U,organization:P,name:U.get('username'),date:new Date,isAutomaticallyGenerated:!1,comment:k};if(U.get('isTrackUsage')||!L){var R={};o.when(C.getUserRole(U)).then(function(A){return T.createNewComment(E,A)}).then(function(A){R.commentObj=A;var B=r.estimate.entity,M=B.get('comments');return M?M.push(A):M=[A],B.set('comments',M),B.save()}).then(function(){var A=new T(R.commentObj);A.date=formatDate(A.entity.date,S),r.comments?r.comments.push(A):r.comments=[A],console.log(A)})}}function F(k){var L=$(k).find('itemRow'),E=$(k).find('modsRow'),R=$(k).find('attachment'),A=$(k).find('customField'),B=$(k).find('tax'),M=$('<td></td>');$(k).find('billType').text().includes('estimate')&&($('.footer .info').hide(),$('.payment-due').hide()),/^[\s]*$/.test(L.first().find('discount').text())?$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),L.each(function(){if(!/^[\s]*$/.test(L.first().find('discount').text())){var W=$('<tr class=\'invoice-items\'></tr>'),K=$('<td class=\'ff1 fc0 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+$(this).children('name').text()+'</td>'),V=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('qty').text()+'</td>'),_=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('discount').text()+'</td>'),Y=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');W.append(K).append(V).append(_).append(Y),$('#invoice-items-header').after($(W))}else{var W=$('<tr class=\'invoice-items\'></tr>'),K=$('<td class=\'ff1 fc0 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+$(this).children('name').text()+'</td>'),V=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'2\'>'+$(this).children('qty').text()+'</td>'),Y=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');W.append(K).append(V).append(Y),$('#invoice-items-header').after($(W))}}),B.each(function(){var G=$('<tr class=\'invoice-taxes\'></tr>'),W=$('<td colspan=\'3\' class=\'\'></td>'),K=$('<td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).children('name').text()+'</td>'),V=$('<td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).children('value').text()+'</td>');G.append(W).append(K).append(V),$('#invoice-subtotal').after($(G))});var q=$('<tr class="salestax"></tr>');$('tr.adjustments').after(q),A.each(function(){var G=$('.customFields');G.append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children('name').text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children('value').text()+'</p></div>'))}),R.each(function(){var G=$(this).text();G=G.substring(G.indexOf('_')+1,G.length),G=G.replace(/%20/g,' '),$('.attach').append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+'\'>'+G+'</a><br><br>')}),$('table tbody tr').each(function(){0==$(this).children().text().length&&$(this).addClass('hideOnMob')});var O=$(k).find('invoiceId').text();$('#pay-link').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+O),$('#pay-link-2').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+O);var H=$(k).find('items');console.log(H),H.each(function(){var G=new Date(Date.parse($(this).find('past-due').text())),W=new Date(Date.now());G=new Date(G.setHours(0,0,0,0)),W=new Date(G.setHours(0,0,0,0)),G.getTime()>=W.getTime()||'Invalid Date'===G.toString()?($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('green-status')):($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('red-status'));var K=$(this).find('headerTitle').text();$('.payment-due p:first').append(K);var V=$(this).find('disablePay').text();'true'===V&&($('.btn-border-pay').addClass('disable'),$('.info.cl').addClass('disable'),$('.payment-due').removeClass('red-status'),$('.payment-due').addClass('green-status'));var Y=$(this).find('discountAmount').text(),X=$('<tr class="discount"></tr>');X.append($('<td class="discountNm" colspan="3"></td>').html('Discount')),X.append($('<td class="discountPr"></td>').html(Y)),'after'==$(this).find('discountPlace text').text()?$('.salestax:last').after(X):'before'==$(this).find('discountPlace text').text()&&$('.salestax:first').before(X);var Z=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountNameBottom').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountAmount').text()+'</td></tr>');if('after'==$(this).find('discountPlace text').text()?$('.invoice-taxes:last').after($(Z)):'before'==$(this).find('discountPlace text').text()&&$('#invoice-subtotal').after($(Z)),0<$(this).find('adjustments').text().length){var Z=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustments').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustmentsPrice').text()+'</td></tr>');$('#invoice-subtotal').after($(Z))}0<$(this).find('shippingCharges').text().length&&(Z=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingCharges').text()+'</td><td class=\'ff1 fc1 \' style=\' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingChargesPrice').text()+'</td></tr>'),$('#invoice-subtotal').after($(Z)));var K=$(this).find('headerTitle').text(),J=$(this).find('past-due').text();K?$('#pdf-title').text(K+'   '+J):($('#pdf-title').text(''),$('.top-bar').css('height','0mm'),$('.top-bar').css('border-bottom','0mm'));var Q=$(this).find('ordernotes-title').text(),ee=$(this).find('ordernotes').text();ee?($('#pdf-terms-title').text(Q),$('#pdf-terms').text(ee)):($('#pdf-terms-title').text(''),$('#pdf-terms').text(''),$('#pdf-terms-title').hide(),$('#pdf-terms').hide()),$('#pdf-business-name').text(h.entity[0].get('company')),$('#pdf-invoice-title').text($(this).find('invoice-title').text()),$('#pdf-invoice-number').text($(this).find('refid').text()),$('#pdf-amount-received').text($(this).find('body-price').text()),$('#pdf-date').text($(this).find('body-date').text()),$('#pdf-subtotal').text($(this).find('subtotalprice').text()),$('#pdf-payment-made').text($(this).find('paymentMadePrice').text()),$('#pdf-total').text($(this).find('total-price3').text()),$('#pdf-total-top').text($(this).find('total-price3').text()),$('#pdf-credit-applied').text($(this).find('creditsAppliedPrice').text()),$('#pdf-amount-due').text($(this).find('refundtotal').text()),$('#pdf-payment-name').text($(this).find('title').text()),$('#pdf-currency').text($(this).find('body-currency').text()),$('#pdf-total-text').text($(this).find('refundedText').text()),$('#pdf-payment-text').text($(this).find('paymentMadeText').text()),$('#pdf-credit-text').text($(this).find('creditsAppliedText').text());var te=$(this).find('addres1').text();$('#pdf-address').html(te);var se=$(this).find('longmsg').text();if(0!=se.length){var ae=$(this).find('longmsg-title').text();$('#pdf-notes-title').html(ae),$('#pdf-notes').html(se)}else $('#pdf-notes-title').html(''),$('#pdf-notes').html(''),$('#pdf-notes-title').hide(),$('#pdf-notes').hide();var ne=$(this).find('mailto').text();$('#user-mail').attr('href',ne);var ie=$(this).find('mailtotxt').text();$('#user-mail').text(ie);var oe=$(this).find('clientmailto').text();$('#client-mail').attr('href',oe);var re=$(this).find('clientmail').text();$('#client-mail').text(re);var le=$(this).find('clientname').text();$('#client-name').text(le);var de=$(this).find('nr').text();$('#user-phone').attr('href','tel:'+de),$('#user-phone').text(de);var ce=$(this).find('refid').text();$('.visa-card').append(ce);var me=$(this).find('purchaseOrderNumber').text();$('.purchase-order').append(me);var ue=$(this).find('invoice-title').text();$('.invoice-details-1 h1').append(ue);var pe=$(this).find('list-header-total').text();$('.list-header li:first-child span').append(pe);var ye=$(this).find('list-header-date').text();$('.list-header li:nth-child(2) span').append(ye);var he=$(this).find('list-header-currency').text();$('.list-header li:nth-child(3) span').append(he);var ge=$(this).find('body-price').text();$('.list-body li:first-child span').append(ge);var fe=$(this).find('body-date').text();$('.list-body li:nth-child(2) span').append(fe);var fe=$(this).find('body-currency').text();$('.list-body li:nth-child(3) span').append(fe);var xe=$(this).find('th1').text();$('.content.cl th.item').append(xe);var be=$(this).find('addres1').text();$('.invoice-details-1 .info-2 p .adr').append(be);var ve=$(this).find('website-link').text();$('.invoice-details-1 .info-2 .website a').attr('href',ve);var Ce=$(this).find('website-name').text();$('.invoice-details-1 .info-2 .website a span').append(Ce);var ne=$(this).find('mailto').text();$('.invoice-details-1 .info-2 .mailto a').attr('href',ne);var ie=$(this).find('mailtotxt').text();$('.invoice-details-1 .info-2 .mailto a span').append(ie);var de=$(this).find('nr').text();$('.invoice-details-1 .info-2 .nr a').attr('href',de),$('.invoice-details-1 .info-2 .nr a span').append(de);var Te=$(this).find('thanksmsg').text();$('.invoice-details-2 .info-1 p:nth-child(1)').append(Te);var se=$(this).find('longmsg').text();if(0!=se.length){var ae=$(this).find('longmsg-title').text();$('.notes_para_head').html(ae),$('.notes_para').html(se)}var De=$(this).find('to').text();$('.invoice-details-2 .info-2 p:first-child').append(De);var le=$(this).find('clientname').text();$('.invoice-details-2 .info-2 .list-client li:first-child span').append(le);var Ie=$(this).find('clientnr').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(2) a').attr('href',Ie),$('.invoice-details-2 .info-2 .list-client li:nth-child(2) a span').append(Ie);var oe=$(this).find('clientmailto').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(3) a').attr('href',oe);var re=$(this).find('clientmail').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(3) a span').append(re);var Q=$(this).find('ordernotes-title').text(),ee=$(this).find('ordernotes').text();$('.orderNotes').append(Q),$('.orderNotesValues').append(ee);var Ne=$(this).find('subtotal').text();$('td.subtotal').append(Ne);var we=$(this).find('adjustments').text();$('td.adjustments').append(we);var Fe=$(this).find('adjustmentsPrice').text();$('td.adjustments-price').append(Fe);var Ue=$(this).find('shippingCharges').text();$('td.shippingCharges').append(Ue);var Pe=$(this).find('shippingChargesPrice').text();$('td.shipping-charges-price').append(Pe);var Se=$(this).find('total-price').text(),ke=$(this).find('salestax').text();$('.salestax').append(ke);var Le=$(this).find('paymentMadeText').text(),Ee=$(this).find('paymentMadePrice').text();$('td.payment-made-text').append(Le),$('td.payment-made-price').append(Ee);var je=$(this).find('paymentRefundMadeText').text(),Re=$(this).find('paymentRefundMadePrice').text();''==je?($('td.payment-refund-made-text').hide(),$('td.payment-refund-made-price').hide()):($('td.payment-refund-made-text').append(je),$('td.payment-refund-made-price').append(Re));var Ae=$(this).find('creditsAppliedText').text(),Be=$(this).find('creditsAppliedPrice').text();$('td.credits-applied-text').append(Ae),$('td.credits-applied-price').append(Be);var Me=$(this).find('total-price2').text();$('.total-price2').append(Me);var $e=$(this).find('total-price3').text();$('.total-price3').append($e);var qe=$(this).find('totaltext').text();$('.totl').append(qe);var Oe=$(this).find('refundtotal').text();$('td.refund-total').append(Oe);var ze=$(this).find('refundedText').text();$('.refund-price').append(ze);var He=$(this).find('total-price4').text();$('.total-price4').append(He);var Ge=$(this).find('saletax').text();$('.saletax').append(Ge);var We=$(this).find('paymentmsg').text();$('.footer .info p:first-child').append(We);var Ke=$(this).find('signup').text();$('.footer .info p span').append(Ke);var Ve=$(this).find('copyright').text();$('.copyright p').append(Ve);var _e=$(this).find('title').text();$('head title').append(_e);var Ye=$(this).find('item4price').text();$('.price .item4price').append(Ye);var Xe=$(this).find('subtotalprice').text();$('.subtotal-price').append(Xe);var Ze=$(this).find('received-text').text();$('.received-text').append(Ze);var Je=$(this).find('received-price').text();$('.received-price').append(Je);var Qe=$(this).find('due-text').text();$('.due-text').append(Qe);var et=$(this).find('due-price');$('.due-price').append(et);var tt=$(this).find('tip-text');$('.tip-text').append(tt);var at=$(this).find('tip-price');$('.tip-price').append(at)}),$.ajax({method:'POST',type:'POST',url:'generatePDF.php',data:{html:$('.pdf-page').html()}}).then(function(G){var W=document.getElementById('pdfLink');W.href='data:application/octet-stream;base64,'+G,W.click();debugger},function(G){console.error(G);debugger})}if(!h.entity.length)return console.log('User not logged in'),void 0;var U=h.entity[0],P=U.get('organizations')[0];y('DashboardController',{$scope:r,$state:l});var S;h.getField('dateFormat').then(function(k){r.dateFormat=k,S=r.dateFormat.toUpperCase().replace(/E/g,'d'),I()}),r.isOwner=!1,r.dateOptions={showWeeks:!1},r.changeTemplate=function(){showLoader(),o.when(C.getInvoiceTemplates()).then(function(k){var L=U.get('defaultTemplate'),E=[];k.forEach(function(R){var A={entity:R,name:R.get('name'),url:R.get('templatePreview').url()};A.isDefault=L||'Template 1'!=A.name?L.id==R.id:!0,E.push(A)}),r.templates=E,$('.change-template').addClass('show'),hideLoader()},function(k){console.log(k.message),hideLoader()})},r.setDefaultTemplate=function(k){showLoader(),r.templates.forEach(function(E){E.isDefault=!1}),r.templates[k].isDefault=!0,r.estimate.entity.unset('estimateReceipt'),U.set('defaultTemplate',r.templates[k].entity);var L=[];L.push(U.save()),L.push(r.estimate.entity.save()),o.all(L).then(function(){hideLoader(),$('.change-template').removeClass('show'),console.log('default template selected'),l.reload()},function(E){hideLoader(),console.log(E,message)})},r.textReceipt=function(){$('#text-error').hide();var k=r.estimate.entity.get('customer'),L=k.get('contactPersons');return r.mobileContacts=[],L.length&&L.forEach(function(E){var R=E.get('firstname')?E.get('firstname'):'',A=E.get('lastname')?E.get('lastname'):'',B=1==E.get('defaultPerson'),M=R+' '+A;E.get('phone')&&r.mobileContacts.push({selected:!1,contact:E.get('phone'),contactName:'('+M+') '+E.get('phone')}),E.get('mobile')&&r.mobileContacts.push({selected:B,contact:E.get('mobile'),contactName:'('+M+') '+E.get('mobile')})}),r.mobileContacts.length?void $('.text-popup').addClass('show'):void ShowMessage('Please Enter Mobile for Customer!','error')},r.sendText=function(){var k=0;return r.mobileContacts.forEach(function(L){L.selected&&k++}),1>k?void $('#text-error').show():void(showLoader(),r.mobileContacts.forEach(function(L){L.selected&&g.sendEstimetTextToNumber(r.estimate.entity,L.contact).then(function(){N('Estimate texted to '+L.contact,!0),$('.text-popup').removeClass('show'),hideLoader()})}))},r.emailReceipt=function(){$('#email-error').hide();var k=r.estimate.entity.get('customer'),L=k.get('contactPersons');return r.contacts=[],L.length&&L.forEach(function(E){var R=E.get('firstname')?E.get('firstname'):'',A=E.get('lastname')?E.get('lastname'):'',B=1==E.get('defaultPerson');E.get('email')&&r.contacts.push({selected:B,contact:E.get('email'),contactName:'('+(R+' '+A)+') '+E.get('email')})}),r.contacts.length?void $('.email-popup').addClass('show'):void ShowMessage('Please Enter Email for Customer!','error')},r.sendEmail=function(){var k=0;return r.contacts.forEach(function(L){L.selected&&k++}),1>k?void $('#email-error').show():void(showLoader(),r.contacts.forEach(function(L){L.selected&&g.sendEstimateReceiptToEmail(r.estimate.entity,L.contact).then(function(){N('Estimate emailed to '+L.contact,!0),$('.email-popup').removeClass('show'),hideLoader()})}))},r.deleteEstimate=function(){showLoader();var k=r.estimate.entity,L=[],E;['comments','estimateItems'].forEach(function(R){E=k.get(R),E&&(L=L.concat(E))}),Parse.Object.destroyAll(L).then(function(){return k.destroy()}).then(function(){hideLoader(),l.go('dashboard.sales.estimates.all')})},r.addAttachment=function(k){var L=k.files[0];if(L){var E=L.name;if(!(E.toLowerCase().endsWith('.pdf')||E.toLowerCase().endsWith('.png')||E.toLowerCase().endsWith('.jpg')||E.toLowerCase().endsWith('.jpeg')))return void $('#file-error').show();$('#file-error').hide(),0<=E.toLowerCase().indexOf('^')&&(E=E.replace('^',''));var R=k.files[0].size;if(5242880<R)return void $('#file-size-error').show();$('#file-size-error').hide(),showLoader();var A=r.estimate.entity,B=new Parse.File(E,L);o.when(B.save()).then(function(M){var q=A.get('estimateFiles');return q?q.push(M):q=[M],A.set('estimateFiles',q),A.unset('estimateReceipt'),A.save()}).then(function(){l.reload(),hideLoader()})}},r.estimatePrinted=function(){N('Estimate printed',!0)},r.estimateCloned=function(){N('Estimate cloned',!0)},r.copyToClipboard=function(){var k=document.createElement('input');k.setAttribute('value',r.templateUrl),document.body.appendChild(k),k.select(),document.execCommand('copy'),document.body.removeChild(k),showSnackbar('Estimate link copied to your clipboard.')},r.addComment=function(){if(!r.newComment)return void $('.add-comment').removeClass('show');showLoader();var k={userID:U,organization:P,name:U.get('username'),date:new Date,isAutomaticallyGenerated:!1,comment:r.newComment},L={};o.when(C.getUserRole(U)).then(function(E){return T.createNewComment(k,E)}).then(function(E){L.commentObj=E;var R=r.estimate.entity,A=R.get('comments');return A?A.push(E):A=[E],R.set('comments',A),R.save()}).then(function(){var E=new T(L.commentObj);E.date=formatDate(E.entity.date,S),r.comments?r.comments.push(E):r.comments=[E],console.log(E),$('.add-comment').removeClass('show'),hideLoader()})},r.downloadInvoice=function(){var k=r.estimate.entity.get('estimateLabels')._url;debugger;var L=new XMLHttpRequest;L.open('GET',k,!1),L.setRequestHeader('Content-Type','text/xml'),L.send(null),F(L.responseXML)}}]);'use strict',invoicesUnlimited.controller('CloneInvoiceController',['$scope','$state','$controller','$q','userFactory','invoiceService','coreFactory','commentFactory','taxService','expenseService','lateFeeService','currencyFilter','itemService','salesCommon',function(o,r,l,u,y,h,g,C,T,D,I,N,F,U){function P(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0.01,number:!0,messages:{required:'Please provide item quantity',min:'Quantity should be > 0',number:'Quantity must be number'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0',number:'Please enter a valid price'}})}),$('.check-discount').each(function(){$(this).rules('remove'),$(this).rules('add',{min:0,max:100,number:!0,messages:{min:'Discount should be greater than 0',max:'Discount should be less than 100%'}})})}function S(se){var ae=se.entity;return ae.name+' '+ae.price+' ('+ae.type+')'}function k(){return o.invoiceItems=[],o.selectedCustomer=o.customers.filter(function(se){return o.invoice.entity.get('customer').id===se.entity.id})[0],u.when(U.customerChangedHelper({organization:X,_scope:o})).then(function(){return U.fillInvoiceForm(o)}).then(function(){o.invoiceNo=o.prefs.invoiceNumber,U.addValidationExceptItems(o),U.reCalculateSubTotal(o),hideLoader()})}function L(){o.prefs.shipCharges&&!o.shippingCharges&&(o.shippingCharges=0),o.prefs.adjustments&&!o.adjustments&&(o.adjustments=0);var se={userID:Y,organization:X,customer:o.selectedCustomer.entity,invoiceDate:o.todayDate,invoiceNumber:o.invoiceNo,status:'Draft',discountType:o.prefs.discountType,discounts:o.discount,shippingCharges:o.shippingCharges,adjustments:o.adjustments,subTotal:+(+o.subTotal).toFixed(2),total:+(+o.total).toFixed(2),balanceDue:+(+o.total).toFixed(2),poNumber:o.poNumber,salesPerson:o.salesPerson,notes:o.notes,terms:o.terms,paymentTerms:o.paymentTerms.selectedTerm.name};if(o.customFields.length){var ae=[];o.customFields.forEach(function(oe){if(oe.value){var re={};re[oe.name]=oe.value,ae.push(re)}}),ae.length&&(se.customFields=ae)}o.selectedLateFee&&(se.lateFee=o.selectedLateFee.entity),0<o.paymentTerms.selectedTerm.value&&(se.dueDate=o.dueDate);var ne=o.selectedCustomer.entity.email;if(ne&&(se.customerEmails=[ne]),o.projectId&&(o.projectId.project.timesheets.forEach(function(oe){oe.set('isBilled',1);var re=oe.get('task');re.set('billedHours',re.get('taskHours')),oe.set('task',re)}),Parse.Object.saveAll(o.projectId.project.timesheets)),r.params.expenseId){var ie=new Parse.Query('Expanses');ie.equalTo('objectId',r.params.expenseId),ie.first().then(function(oe){oe.set('status','Invoiced'),oe.save()})}return h.createNewInvoice(se,o.invoiceItems,o.userRole,o.files).then(function(oe){return h.copyInInvoiceInfo(oe).then(function(re){return o.invoiceInfo=re,oe})})}function E(){return L().then(function(se){return h.createInvoiceReceipt(se.id,o.invoiceInfo.id).then(function(ae){var ne=ae.get('status');return'Draft'==ne&&(ae.set('status','Sent'),ae.save()),R(ae),ae})})}function R(se){o.contacts.forEach(function(ae){ae.selected&&h.sendInvoiceReceiptToEmail(se,ae.contact).then(function(){q('Invoice emailed to '+ae.contact,!0,se)})}),o.mobileContacts.forEach(function(ae){ae.selected&&h.sendInvoiceTextToNumber(se,ae.contact).then(function(){q('Invoice texted to '+ae.contact,!0,se)})})}function A(){var se=$('#addInvoiceForm').validate();se.showErrors({invoiceNumber:'Invoice with this number already exists'})}function B(){P();var se=$('#addInvoiceForm').valid(),ae=$('#itemInfoForm').valid(),ne=$('#extrasForm').valid();if(se&&ae&&ne)return!0;var ie;se?ae?!ne&&(ie=$('#extrasForm').validate()):ie=$('#itemInfoForm').validate():ie=$('#addInvoiceForm').validate();var oe=$(ie.errorList[0].element).offset().top-30;return scrollToOffset(oe),!1}function M(){o.latefeeName='',o.latefeeTypes=['%','$'],o.selectedFeeType=o.latefeeTypes[0],o.latefeeAmount='',$('#addLateFeeForm').validate({rules:{name:'required',type:'required',amount:{required:!0,number:!0,min:0.01}}}),$('#addLateFeeForm').validate().resetForm()}function q(se,ae,ne){var ie={userID:Y,organization:X,name:Y.get('username'),date:new Date,isAutomaticallyGenerated:ae,comment:se};if(Y.get('isTrackUsage')||!ae){var oe={};return u.when(g.getUserRole(Y)).then(function(re){return C.createNewComment(ie,re)}).then(function(re){oe.commentObj=re;var le=ne.get('comments');return le?le.push(re):le=[re],ne.set('comments',le),ne.save()}).then(function(re){return re})}}function O(){B()&&(showLoader(),u.when(h.checkInvoiceNumAvailable({invoiceNumber:o.invoiceNo,organization:X})).then(function(se){return se?E():($('.email-text').removeClass('show'),A(),scrollToOffset(),Promise.reject('Invoice with this number already exists'))}).then(function(se){q('Invoice created for '+N(se.attributes.balanceDue,'$',2)+' amount',!0,se).then(function(ae){hideLoader(),r.go('dashboard.sales.invoices.details',{invoiceId:ae.id})})},function(se){hideLoader(),console.log(se)}))}function H(se){return 10>se&&(se='0'+se),se}function G(se){return'.'+se.split('.').pop()}function W(){var se=o.invoiceItems,ae=0,ne=0;o.itemTaxes=[],se.forEach(function(ie){ae+=ie.amount*(0.01*(100-ie.discount));var oe=+o.discount||0;if(ie.taxValue=2==o.prefs.discountType?calculateTax(ie.amount*(0.01*(100-oe)),ie.selectedTax):calculateTax(ie.amount*(0.01*(100-ie.discount)),ie.selectedTax),ne+=ie.taxValue,ie.selectedTax){var re=-1;if(2==ie.selectedTax.type){var le=ie.selectedTax.entity.get('associatedTaxes');le.forEach(function(de){re=-1,o.itemTaxes.length&&(re=o.itemTaxes.findIndex(function(me){return me.name==de.get('title')}));var ce=0;de.get('compound')?(ce=0.01*(ie.amount*(ie.selectedTax.rate-de.get('value'))),ce=0.01*((ie.amount+ce)*de.get('value'))):ce=0.01*(ie.amount*de.get('value')),-1==re?o.itemTaxes.push({nameValue:de.get('title')+' ('+de.get('value')+'%)',amount:N(ce,'$',2),count:1,name:de.get('title'),amountValue:ce}):(o.itemTaxes[re].amountValue+=ce,o.itemTaxes[re].count++,o.itemTaxes[re].amount=N(o.itemTaxes[re].amountValue,'$',2))})}else o.itemTaxes.length&&(re=o.itemTaxes.findIndex(function(de){return de.name==ie.selectedTax.name})),-1==re?o.itemTaxes.push({nameValue:ie.selectedTax.name+' ('+ie.selectedTax.rate+'%)',amount:N(ie.taxValue,'$',2),count:1,name:ie.selectedTax.name,amountValue:ie.taxValue}):(o.itemTaxes[re].amountValue+=ie.taxValue,o.itemTaxes[re].count++,o.itemTaxes[re].amount=N(o.itemTaxes[re].amountValue,'$',2))}}),o.totalTax=ne,o.subTotal=ae,o.subTotalStr=N(ae*Z.exchangeRate,Z.currencySymbol,2),o.reCalculateTotal()}function K(){o.items.pop();var se=o.selectedCustomer.entity.get('paymentTerms');return se?o.paymentTerms.terms.forEach(function(ae){ae.name==se&&(o.paymentTerms.selectedTerm=ae)}):o.paymentTerms.selectedTerm={name:'Due on Receipt',value:1},o.hasDueDate=!0,o.calculateDueDate(),u.when(D.getCustomerExpenses({organization:X,customer:o.selectedCustomer.entity})).then(function(ae){for(var ne=[],ie=0;ie<ae.length;++ie)if('Yes'==ae[ie].entity.get('billable'))for(var oe=0;oe<o.expenseItems.length;++oe)ae[ie].entity.id==o.expenseItems[oe].entity.expanseId&&ne.push(o.expenseItems[oe]);for(var re=[],ie=0;ie<ae.length;++ie)if('No'!=ae[ie].entity.get('billable')){var le=ae[ie].entity,de=ne.some(function(ye){return le.category==ye.entity.title&&le.amount==+ye.entity.rate});de||re.push({create:!0,tax:le.tax,entity:{title:le.category,rate:le.amount+'',expanseId:le.id}})}var ce=o.actualItems.concat(ne,re);return o.invoiceItems=o.invoiceItems.filter(function(me){return!me.selectedItem||me.selectedItem.create?!1:ce.some(function(ue){return ue.entity.id==me.selectedItem.entity.id})}),'Sales'!=Y.get('role')&&ce.push(createItemOpener),o.items=ce})}function _(se){if(se=se.split(',').join(''),-1!==se.indexOf('.')){for(;/(\d+)(\d{3})/.test(se.toString());)se=se.toString().replace(/(\d+)(\d{3})/,'$1,$2');var ae=se.length-se.indexOf('.');3==ae&&$('.add_item_price').attr('maxlength',se.length)}else for($('.add_item_price').attr('maxlength',50);/(\d+)(\d{3})/.test(se.toString());)se=se.toString().replace(/(\d+)(\d{3})/,'$1,$2');return se}if(!y.entity.length)return console.log('User not logged in'),void 0;var Y=y.entity[0],X=Y.get('organizations')[0];l('DashboardController',{$scope:o,$state:r});var Z=y.entity[0].currency.attributes;if(Z.exchangeRate)o.currentCurrency=Z;else{var J={currencySymbol:'$',exchangeRate:1};o.currentCurrency=J,Z=J}$.validator.addMethod('notBackDate',function(){return o.todayDate<=o.dueDate}),$('#addTaxForm').validate({rules:{name:'required',rate:{required:!0,number:!0}},messages:{name:'Please enter Tax name',rate:{required:'tax rate is required',number:'please enter a valid rate(number)'}}}),$('#addInvoiceForm').validate({onkeyup:function(se){$(se).valid()},rules:{customer:'required',invoiceNumber:'required',invoiceCreateDate:'required',invoiceDueDate:{required:!0}},messages:{customer:'Please select a customer',invoiceNumber:'Please enter invoice number',invoiceCreateDate:'Please provide invoice Create date',invoiceDueDate:{required:'Please provide invoice Due date'}}}),$('#extrasForm').validate({rules:{discount:{number:!0,min:0,max:100},shipCharges:{number:!0,min:0},adjustment:{number:!0}},messages:{discount:{number:'Must be a number',min:'Discount can not be less than 0',max:'Discount should be less than 100%'}}}),$('#itemInfoForm').validate();var Q=r.params.invoiceId;Q||r.go('dashboard.sales.invoices.all'),o.dateOptions={showWeeks:!1};var ee=[],te=null;te=u.when(h.getInvoice(Q)).then(function(se){o.invoice=se}),ee.push(te),te=u.when(U.loadRequiredData({user:Y,organization:X,_scope:o})),ee.push(te),u.all(ee).then(function(){k()}),o.save=function(){B()&&(showLoader(),u.when(h.checkInvoiceNumAvailable({invoiceNumber:o.invoiceNo,organization:X})).then(function(se){return se?L():(A(),scrollToOffset(),Promise.reject('Invoice with this number already exists'))}).then(function(se){q('Invoice created for '+N(se.attributes.balanceDue,'$',2)+' amount',!0,se).then(function(ae){hideLoader(),r.go('dashboard.sales.invoices.details',{invoiceId:ae.id})})},function(se){hideLoader(),console.log(se)}))},o.lateFeeChanged=function(){o.selectedLateFee&&o.selectedLateFee.dummy&&(o.selectedLateFee='',M(),$('.add-latefee').addClass('show'))},o.addLateFee=function(){if($('#addLateFeeForm').valid()){showLoader();var se={userID:Y,organization:X,name:o.latefeeName,type:o.selectedFeeType,price:+o.latefeeAmount};u.when(g.getUserRole(Y)).then(function(ae){return I.createLateFee(se,ae)}).then(function(ae){ae.toStr=S(ae),o.lateFeeList.pop(),o.lateFeeList.push(ae),'Sales'!=Y.get('role')&&o.lateFeeList.push(createLateFeeOpener),o.selectedLateFee=ae,$('.add-latefee').removeClass('show'),hideLoader()})}},o.saveAndSend=function(){if(B()){$('#emailText-error').hide();var se=o.selectedCustomer.entity.get('contactPersons');o.contacts=[],o.mobileContacts=[],se.length&&se.forEach(function(ae){var ne=ae.get('firstname')?ae.get('firstname'):'',ie=ae.get('lastname')?ae.get('lastname'):'',oe=1==ae.get('defaultPerson'),re=ne+' '+ie;ae.get('email')&&o.contacts.push({selected:oe,contact:ae.get('email'),contactName:'('+re+') '+ae.get('email')}),ae.get('phone')&&o.mobileContacts.push({selected:!1,contact:ae.get('phone'),contactName:'('+re+') '+ae.get('phone')}),ae.get('mobile')&&o.mobileContacts.push({selected:oe,contact:ae.get('mobile'),contactName:'('+re+') '+ae.get('mobile')})}),o.contacts.length||o.mobileContacts.length?$('.email-text').addClass('show'):ShowMessage('The customer does not have a email or phone number in their profile. Please select save.','error')}},o.sendReceipt=function(){debugger;var se=0,ae=0;o.contacts.forEach(function(ne){ne.selected&&se++}),o.mobileContacts.forEach(function(ne){ne.selected&&ae++}),0<se||0<ae?O():$('#emailText-error').show()},o.cancel=function(){r.go('dashboard.sales.invoices.all')},o.addNewFile=function(se){var ae=se.files[0],ne=ae.name;if(0<=ne.toLowerCase().indexOf('^')&&(ne=ne.replace('^','')),!(ne.toLowerCase().endsWith('.pdf')||ne.toLowerCase().endsWith('.png')||ne.toLowerCase().endsWith('.jpg')||ne.toLowerCase().endsWith('.jpeg')))return void $('#file-error').show();$('#file-error').hide();var ie=se.files[0].size;if(5242880<ie)return void $('#file-size-error').show();$('#file-size-error').hide(),ae.fileName=ne,o.files.push(ae);for(var oe=0;oe<o.files.length;++oe)o.files[oe].fileName='Attachment '+H(oe+1)+G(o.files[oe].fileName);o.$$phase||o.$apply()},o.removeFile=function(se){o.files.splice(se,1);for(var ae=0;ae<o.files.length;++ae)o.files[ae].fileName='Attachment '+H(ae+1)+G(o.files[ae].fileName)},o.calculateDueDate=function(){var se=new Date(o.todayDate);se.setHours(0),1!=o.paymentTerms.selectedTerm.value&&(se=se.addDays(o.paymentTerms.selectedTerm.value)),o.dueDate=se},o.paymentTermsChanged=function(){o.hasDueDate=0!=o.paymentTerms.selectedTerm.value,o.hasDueDate&&o.calculateDueDate()},o.openDatePicker=function(se){1===se?o.openPicker1=!0:2===se?o.openPicker2=!0:void 0},o.addInvoiceItem=function(){o.invoiceItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},o.reCalculateTotal=function(){var se=+o.subTotal||0,ae=+o.discount||0,ne=+o.shippingCharges||0,ie=+o.adjustments||0,oe=+o.totalTax||0,re=se+oe,le=0.01*(100-ae);2==o.prefs.discountType?re=se*le+oe:3==o.prefs.discountType&&(re=(se+oe)*le),ae=Math.abs(re-se-oe),o.total=re+ne+ie,o.discountStr=N(ae*Z.exchangeRate,Z.currencySymbol,2),o.shippingChargesStr=N(ne*Z.exchangeRate,Z.currencySymbol,2),o.adjustmentsStr=N(ie*Z.exchangeRate,Z.currencySymbol,2),o.totalStr=N(o.total*Z.exchangeRate,Z.currencySymbol,2)},o.reCalculateSubTotal=W,o.reCalculateItemAmount=function(se){var ae=o.invoiceItems[se];ae.selectedItem&&(ae.amount=ae.rate*ae.quantity,W())},o.removeInvoiceItem=function(se){1<o.invoiceItems.length?(o.invoiceItems.splice(se,1),W()):console.log('there should be atleast 1 item in an invoice')},o.itemChanged=function(se){console.log('item changed');var ae=o.invoiceItems[se];if(ae.selectedItem.dummy)return ae.selectedItem=null,$('.new-item').addClass('show'),o.itemChangedIndex=se,void o.prepareCreateItem();ae.rate=+ae.selectedItem.entity.rate;var ne=ae.selectedItem.tax;if(!ne)ae.selectedTax='';else for(var ie=o.taxes,oe=0;oe<ie.length;++oe)if(ne.id==ie[oe].id){ae.selectedTax=ie[oe];break}o.reCalculateItemAmount(se)},o.taxChanged=function(se){if(console.log('tax changed'),-1!=se){var ae=o.invoiceItems[se];if(!ae.selectedTax)W();else if(ae.selectedTax.dummy)return o.currentItem=se,o.taxName=null,o.taxRate=null,ae.selectedTax=null,void $('.new-tax').addClass('show')}else if(o.newItem.tax.dummy)return o.currentItem=se,o.newItem.tax=null,o.taxName=null,o.taxRate=null,void $('.new-tax').addClass('show');W()},o.customerChanged=function(){return o.selectedCustomer.dummy?void r.go('dashboard.customers.new',{backLink:r.current.name}):void(showLoader(),u.when(K()).then(function(){1>o.invoiceItems.length?(o.addInvoiceItem(),o.totalTax=0,o.subTotal=0,o.subTotalStr=N(0*Z.exchangeRate,Z.currencySymbol,2),o.reCalculateTotal()):W(),hideLoader()}))},o.prepareCreateItem=function(){U.prepareCreateItem({_scope:o})},o.createNewItem=function(){U.createNewItem({_scope:o,user:Y,organization:X})},o.saveNewTax=function(){$('#addTaxForm').valid()&&U.createNewTax({_scope:o,user:Y},function(){W(),o.$$phase||o.$apply()})},$('.add_item_price').keyup(function(){$(this).val(_($(this).val()))})}]);'use strict',invoicesUnlimited.controller('CreateInvoiceController',['$scope','$state','$controller','$q','userFactory','invoiceService','coreFactory','commentFactory','taxService','expenseService','lateFeeService','currencyFilter','itemService','salesCommon','estimateService','$rootScope',function(o,r,l,u,y,h,g,C,T,D,I,N,F,U,P){function k(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0.01,number:!0,messages:{required:'Please provide item quantity',min:'Quantity should be > 0',number:'Quantity must be number'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0',number:'Please enter a valid price'}})}),$('.check-discount').each(function(){$(this).rules('remove'),$(this).rules('add',{min:0,max:100,number:!0,messages:{min:'Discount should be greater than 0',max:'Discount should be less than 100%'}})})}function L(ne){var ie=ne.entity;return ie.name+' '+ie.price+' ('+ie.type+')'}function E(){showLoader();var ne=[],ie=null;ie=u.when(g.getAllCustomers()).then(function(oe){oe=oe.filter(function(re){return'active'==re.entity.status}),o.customers=oe.sort(function(re,le){return alphabeticalSort(re.entity.displayName,le.entity.displayName)}),o.customers.forEach(function(re){re.fullName=re.entity.salutation?re.entity.salutation+' '+re.entity.displayName:re.entity.displayName}),'Sales'!=se.get('role')&&o.customers.push(createCustomerOpener)}),ne.push(ie),ie=u.when(g.getAllItems({organization:ae})).then(function(oe){o.actualItems=oe.filter(function(re){return!re.entity.expanseId&&0>re.entity.title.indexOf('Misc. Item')}),o.expenseItems=oe.filter(function(re){return re.entity.expanseId}),o.items=o.actualItems,'Sales'!=se.get('role')&&o.items.push(createItemOpener)}),ne.push(ie),ie=u.when(h.getPreferences(se)).then(function(oe){o.prefs=oe}),ne.push(ie),ie=u.when(g.getUserRole(se)).then(function(oe){o.userRole=oe}),ne.push(ie),ie=T.getTaxes(se,function(oe){o.taxes=oe,'Sales'!=se.get('role')&&o.taxes.push(createTaxOpener)}),ne.push(ie),ie=I.getAllLateFees({organization:ae}).then(function(oe){o.lateFeeList=oe.map(function(re){return re.toStr=L(re),re}),'Sales'!=se.get('role')&&o.lateFeeList.push(createLateFeeOpener)}),ne.push(ie),ie=y.getField('dateFormat').then(function(oe){o.dateFormat=oe}),ne.push(ie),u.all(ne).then(function(){R()},function(oe){hideLoader(),console.log(oe.message)})}function R(){switch(1==o.prefs.numAutoGen?(o.invoiceNo=o.prefs.invoiceNumber,o.disableInvNo=!0):(o.invoiceNo='',o.disableInvNo=!1),o.notes=o.prefs.notes,o.terms=o.prefs.terms,o.paymentTerms={terms:[{name:'Off',value:0},{name:'Due on Receipt',value:1},{name:'Net 7',value:7},{name:'Net 10',value:10},{name:'Net 30',value:30},{name:'Net 60',value:60},{name:'Net 90',value:90}],selectedTerm:{name:'Due on Receipt',value:1}},o.files=[],o.hasDueDate=!0,o.todayDate=new Date,o.calculateDueDate(),o.subTotalStr=N(0*ee.exchangeRate,ee.currencySymbol,2),o.prefs.discountType){case 0:o.itemLevelTax=!1,o.invoiceLevelTax=!1;break;case 1:o.itemLevelTax=!0,o.invoiceLevelTax=!1;break;case 2:o.itemLevelTax=!1,o.invoiceLevelTax=!0,o.discountStr=N(0*ee.exchangeRate,ee.currencySymbol,2);break;case 3:$('#discountD').insertAfter('#taxD'),o.itemLevelTax=!1,o.invoiceLevelTax=!0,o.discountStr=N(0*ee.exchangeRate,ee.currencySymbol,2);}o.prefs.shipCharges&&(o.showShippingCharges=!0,o.shippingChargesStr=N(0*ee.exchangeRate,ee.currencySymbol,2)),o.prefs.adjustments&&(o.showAdjustments=!0,o.adjustmentsStr=N(0*ee.exchangeRate,ee.currencySymbol,2)),o.prefs.salesPerson&&(o.showSalesPerson=!0),o.invoiceItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var ne=r.params.customerId,ie=r.params.expenseId,oe=r.params.projectId,re=r.params.estimateId;ne&&(o.selectedCustomer=o.customers.filter(function(de){return de.entity.id==ne})[0],J(),ie&&u.when(Z()).then(function(){o.invoiceItems.length||o.addInvoiceItem(),o.invoiceItems[0].selectedItem=o.items.filter(function(ce){return ce.entity.expanseId==ie})[0],o.invoiceItems[0].selectedItem.create=!0,o.itemChanged(0);var de=new Parse.Query('Expanses');de.equalTo('objectId',r.params.expenseId),de.first().then(function(ce){o.notes=ce.get('notes'),o.dueDate=ce.get('expanseDate'),o.todayDate=ce.get('expanseDate'),o.poNumber=ce.get('referenceNumber'),o.$$phase||o.$apply()})})),oe&&B(oe),re&&A(re);var le=[];o.prefs.customFields&&o.prefs.customFields.forEach(function(de){'YES'==de.isChecked&&le.push({name:de.name,value:''})}),o.customFields=le,hideLoader()}function A(ne){u.when(P.getEstimate(ne)).then(function(ie){o.estimate=ie,o.selectedCustomer=o.customers.filter(function(oe){return o.estimate.entity.get('customer').id===oe.entity.id})[0],J(),u.when(Z()).then(function(){o.poNumber=ie.entity.referenceNumber||'',o.files=[];var oe=ie.entity.estimateFiles;switch(oe?(oe.forEach(function(me){me.fileName=me.name(),me.exist=!0}),o.files=oe):o.files=[],o.prefs.discountType){case 0:o.itemLevelTax=!1,o.invoiceLevelTax=!1;break;case 1:o.itemLevelTax=!0,o.invoiceLevelTax=!1;break;case 2:case 3:o.itemLevelTax=!1,o.invoiceLevelTax=!0;}o.notes=ie.entity.notes,o.terms=ie.entity.termsConditions,o.prefs.salesPerson&&(o.salesPerson=ie.entity.salesPerson||'',o.showSalesPerson=!0),o.invoiceItems=[];for(var re=0;re<ie.estimateItems.length;++re){var le=ie.estimateItems[re].entity,de=le.get('item'),ce={};ce.selectedItem=o.items.filter(function(me){if(me.entity.id===de.id){ce.id=le.id,ce.rate=le.amount/le.quantity,ce.quantity=le.quantity,ce.discount=le.discount||0,ce.taxValue=0,ce.amount=le.amount;var ue=le.get('tax');return ce.selectedTax=ue?o.taxes.filter(function(pe){return pe.id===ue.id})[0]:void 0,!0}return!1})[0],o.invoiceItems.push(ce)}o.reCalculateSubTotal(),hideLoader()})})}function B(ne){o.selectedCustomer=o.customers.filter(function(ie){return ie.entity.id==ne.project.entity.customer.id})[0],J(),o.invoiceItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}],u.when(Z()).then(function(){if(1==ne.dataOnInvoice){var ie=0,oe=0;if('Based on project hours'==ne.project.entity.get('billingMethod')){ie=ne.project.entity.get('projectBillingHours');for(var re=ne.project.timesheets,le=0;le<re.length;++le)if(!re[le].get('isBilled')){var de=re[le].time,ce=parseInt(de.split(':')[0]),me=parseInt(de.split(':')[1]);ce+=me/60,ce=parseFloat(ce.toFixed(2)),oe+=ce}}else if('Fixed cost for project'==ne.project.entity.get('billingMethod'))ie=ne.project.entity.projectBillingAmount,oe=1;else if('Based on task hours'==ne.project.entity.get('billingMethod')){ie=0;var re=ne.project.timesheets;oe=1;for(var le=0;le<re.length;++le)if(!re[le].get('isBilled')){var de=re[le].time,ce=parseInt(de.split(':')[0]),me=parseInt(de.split(':')[1]);ce+=me/60,ce=parseFloat(ce.toFixed(2));var ue=re[le].get('task').get('taskCost');ue||(ue=0),ie+=ce*ue}}else if('Based on staff hours'==ne.project.entity.get('billingMethod')){ie=0;var re=ne.project.timesheets;oe=1;for(var le=0;le<re.length;++le)if(!re[le].get('isBilled')){var de=re[le].time,ce=parseInt(de.split(':')[0]),me=parseInt(de.split(':')[1]);ce+=me/60,ce=parseFloat(ce.toFixed(2));var pe=ne.project.users.findIndex(function(Te){return Te.user.id==re[le].get('user').id}),ye=ne.project.users[pe].entity.staffHours;ye||(ye=0),ie+=ce*ye}}var he={create:!0,entity:{rate:ie,title:ne.project.entity.projectName}};o.items.pop(),o.items.push(he),'Sales'!=se.get('role')&&o.items.push(createItemOpener),o.invoiceItems[0]={selectedItem:he,selectedTax:void 0,rate:ie,quantity:oe,discount:0,amount:0},o.itemChanged(0)}else if(2==ne.dataOnInvoice){if(ne.project.timesheets){o.items.pop();var ge=0;'Based on project hours'==ne.project.entity.get('billingMethod')&&(ge=ne.project.entity.get('projectBillingHours'));for(var re=ne.project.timesheets,fe=[],le=0;le<re.length;++le)if(!re[le].get('isBilled')){var de=re[le].time,ce=parseInt(de.split(':')[0]),me=parseInt(de.split(':')[1]);ce+=me/60,ce=parseFloat(ce.toFixed(2));var xe=re[le].get('task'),be=fe.findIndex(function(De){return De.id==xe.id});0<=be?fe[be].quantity+=ce:'Based on project hours'==ne.project.entity.get('billingMethod')?fe.push({taskName:xe.get('taskName'),quantity:ce,taskRate:ge,id:xe.id}):'Based on task hours'==ne.project.entity.get('billingMethod')&&fe.push({taskName:xe.get('taskName'),quantity:ce,taskRate:xe.get('taskCost'),id:xe.id})}var ve=0;fe.forEach(function(Ce){var Te;1==ne.itemNameToShow&&(Te=ne.project.entity.projectName);var De={create:!0,entity:{rate:Ce.taskRate,title:Te}};o.items.push(De),o.addInvoiceItem(),o.invoiceItems[ve]={selectedItem:De,selectedTax:void 0,rate:Ce.taskRate,quantity:Ce.quantity,discount:0,amount:0},o.itemChanged(ve),ve++}),'Sales'!=se.get('role')&&o.items.push(createItemOpener)}}else if(3==ne.dataOnInvoice){if(ne.project.timesheets){o.items.pop();var ge=0;'Based on project hours'==ne.project.entity.get('billingMethod')&&(ge=ne.project.entity.get('projectBillingHours'));for(var re=ne.project.timesheets,le=0;le<re.length;++le)if(!re[le].get('isBilled')){var de=re[le].time,ce=parseInt(de.split(':')[0]),me=parseInt(de.split(':')[1]);ce+=me/60,ce=parseFloat(ce.toFixed(2));var ie=0;if('Based on task hours'==ne.project.entity.get('billingMethod'))ie=re[le].get('task').get('taskCost'),ie||(ie=0);else if('Based on staff hours'==ne.project.entity.get('billingMethod')){var pe=ne.project.users.findIndex(function(Ie){return Ie.user.id==re[le].get('user').id});ie=ne.project.users[pe].entity.staffHours,ie||(ie=0)}else ie=ge;var he={create:!0,entity:{rate:ie,title:ne.project.entity.projectName}};o.items.push(he),o.addInvoiceItem(),o.invoiceItems[le]={selectedItem:he,selectedTax:void 0,rate:ie,quantity:ce,discount:0,amount:0},o.itemChanged(le)}'Sales'!=se.get('role')&&o.items.push(createItemOpener)}}else if(4==ne.dataOnInvoice&&ne.project.timesheets){o.items.pop();var ge=0;'Based on project hours'==ne.project.entity.get('billingMethod')&&(ge=ne.project.entity.get('projectBillingHours'));for(var re=ne.project.timesheets,fe=[],le=0;le<re.length;++le)if(!re[le].get('isBilled')){var de=re[le].time,ce=parseInt(de.split(':')[0]),me=parseInt(de.split(':')[1]);ce+=me/60,ce=parseFloat(ce.toFixed(2));var xe=re[le].get('user'),be=fe.findIndex(function(Ne){return Ne.id==xe.id});if(0<=be)fe[be].quantity+=ce;else if('Based on project hours'==ne.project.entity.get('billingMethod'))fe.push({taskName:xe.get('userName'),quantity:ce,taskRate:ge,id:xe.id});else if('Based on staff hours'==ne.project.entity.get('billingMethod')){var pe=ne.project.users.findIndex(function(Ne){return Ne.user.id==xe.id}),ye=ne.project.users[pe].entity.staffHours;ye||(ye=0),fe.push({taskName:xe.get('userName'),quantity:ce,taskRate:ye,id:xe.id})}}var ve=0;fe.forEach(function(Ce){var Te;1==ne.itemNameToShow&&(Te=ne.project.entity.projectName);var De={create:!0,entity:{rate:Ce.taskRate,title:Te}};o.items.push(De),o.addInvoiceItem(),o.invoiceItems[ve]={selectedItem:De,selectedTax:void 0,rate:Ce.taskRate,quantity:Ce.quantity,discount:0,amount:0},o.itemChanged(ve),ve++}),'Sales'!=se.get('role')&&o.items.push(createItemOpener)}})}function M(){o.prefs.shipCharges&&!o.shippingCharges&&(o.shippingCharges=0),o.prefs.adjustments&&!o.adjustments&&(o.adjustments=0);var ne={userID:se,organization:ae,customer:o.selectedCustomer.entity,invoiceDate:o.todayDate,invoiceNumber:o.invoiceNo,status:'Draft',discountType:o.prefs.discountType,discounts:o.discount,shippingCharges:o.shippingCharges,adjustments:o.adjustments,subTotal:+(+o.subTotal).toFixed(2),total:+(+o.total).toFixed(2),balanceDue:+(+o.total).toFixed(2),poNumber:o.poNumber,salesPerson:o.salesPerson,notes:o.notes,terms:o.terms,paymentTerms:o.paymentTerms.selectedTerm.name};if(o.customFields.length){var ie=[];o.customFields.forEach(function(le){if(le.value){var de={};de[le.name]=le.value,ie.push(de)}}),ie.length&&(ne.customFields=ie)}o.selectedLateFee&&(ne.lateFee=o.selectedLateFee.entity),0<o.paymentTerms.selectedTerm.value&&(ne.dueDate=o.dueDate);var oe=o.selectedCustomer.entity.email;if(oe&&(ne.customerEmails=[oe]),o.projectId&&(o.projectId.project.timesheets.forEach(function(le){le.set('isBilled',1);var de=le.get('task');de.set('billedHours',de.get('taskHours')),le.set('task',de)}),Parse.Object.saveAll(o.projectId.project.timesheets)),r.params.expenseId){var re=new Parse.Query('Expanses');re.equalTo('objectId',r.params.expenseId),re.first().then(function(le){le.set('status','Invoiced'),le.save()})}return o.estimate&&(o.estimate.entity.set('status','Invoiced'),o.estimate.entity.save().then(function(){})),h.createNewInvoice(ne,o.invoiceItems,o.userRole,o.files).then(function(le){return h.copyInInvoiceInfo(le).then(function(de){return o.invoiceInfo=de,le})})}function q(){return M().then(function(ne){return h.createInvoiceReceipt(ne.id,o.invoiceInfo.id).then(function(ie){var oe=ie.get('status');return'Draft'==oe&&(ie.set('status','Sent'),ie.save()),O(ie),ie})})}function O(ne){o.sendEmail(o.contacts,ne),o.sendText(o.mobileContacts,ne)}function H(){var ne=$('#addInvoiceForm').validate();ne.showErrors({invoiceNumber:'Invoice with this number already exists'})}function G(){k();var ne=$('#addInvoiceForm').valid(),ie=$('#itemInfoForm').valid(),oe=$('#extrasForm').valid();if(ne&&ie&&oe)return!0;var re;ne?ie?!oe&&(re=$('#extrasForm').validate()):re=$('#itemInfoForm').validate():re=$('#addInvoiceForm').validate();var le=$(re.errorList[0].element).offset().top-30;return scrollToOffset(le),!1}function W(){o.latefeeName='',o.latefeeTypes=['%','$'],o.selectedFeeType=o.latefeeTypes[0],o.latefeeAmount='',$('#addLateFeeForm').validate({rules:{name:'required',type:'required',amount:{required:!0,number:!0,min:0.01}}}),$('#addLateFeeForm').validate().resetForm()}function K(ne,ie,oe){var re={userID:se,organization:ae,name:se.get('username'),date:new Date,isAutomaticallyGenerated:ie,comment:ne};if(se.get('isTrackUsage')||!ie){var le={};return u.when(g.getUserRole(se)).then(function(de){return C.createNewComment(re,de)}).then(function(de){le.commentObj=de;var ce=oe.get('comments');return ce?ce.push(de):ce=[de],oe.set('comments',ce),oe.save()}).then(function(de){return de})}}function V(){G()&&(showLoader(),u.when(h.checkInvoiceNumAvailable({invoiceNumber:o.invoiceNo,organization:ae})).then(function(ne){return ne?q():($('.email-text').removeClass('show'),H(),scrollToOffset(),Promise.reject('Invoice with this number already exists'))}).then(function(ne){K('Invoice created for '+N(ne.attributes.balanceDue,'$',2)+' amount',!0,ne).then(function(){}),hideLoader(),r.go('dashboard.sales.invoices.details',{invoiceId:ne.id})},function(ne){hideLoader(),console.log(ne)}))}function _(ne){return 10>ne&&(ne='0'+ne),ne}function Y(ne){return'.'+ne.split('.').pop()}function X(){var ne=o.invoiceItems,ie=0,oe=0;o.itemTaxes=[],ne.forEach(function(re){ie+=re.amount*(0.01*(100-re.discount));var le=+o.discount||0;if(re.taxValue=2==o.prefs.discountType?calculateTax(re.amount*(0.01*(100-le)),re.selectedTax):calculateTax(re.amount*(0.01*(100-re.discount)),re.selectedTax),oe+=re.taxValue,re.selectedTax){var de=-1;if(2==re.selectedTax.type){var ce=re.selectedTax.entity.get('associatedTaxes');ce.forEach(function(me){de=-1,o.itemTaxes.length&&(de=o.itemTaxes.findIndex(function(pe){return pe.name==me.get('title')}));var ue=0;me.get('compound')?(ue=0.01*(re.amount*(re.selectedTax.rate-me.get('value'))),ue=0.01*((re.amount+ue)*me.get('value'))):ue=0.01*(re.amount*me.get('value')),-1==de?o.itemTaxes.push({nameValue:me.get('title')+' ('+me.get('value')+'%)',amount:N(ue,'$',2),count:1,name:me.get('title'),amountValue:ue}):(o.itemTaxes[de].amountValue+=ue,o.itemTaxes[de].count++,o.itemTaxes[de].amount=N(o.itemTaxes[de].amountValue,'$',2))})}else o.itemTaxes.length&&(de=o.itemTaxes.findIndex(function(me){return me.name==re.selectedTax.name})),-1==de?o.itemTaxes.push({nameValue:re.selectedTax.name+' ('+re.selectedTax.rate+'%)',amount:N(re.taxValue,'$',2),count:1,name:re.selectedTax.name,amountValue:re.taxValue}):(o.itemTaxes[de].amountValue+=re.taxValue,o.itemTaxes[de].count++,o.itemTaxes[de].amount=N(o.itemTaxes[de].amountValue,'$',2))}}),o.totalTax=oe,o.subTotal=ie,o.subTotalStr=N(ie*ee.exchangeRate,ee.currencySymbol,2),o.reCalculateTotal()}function Z(){o.items[o.items.length-1].dummy&&o.items.pop();var ne=o.selectedCustomer.entity.get('paymentTerms');return ne?o.paymentTerms.terms.forEach(function(ie){ie.name==ne&&(o.paymentTerms.selectedTerm=ie)}):o.paymentTerms.selectedTerm={name:'Due on Receipt',value:1},o.hasDueDate=!0,o.calculateDueDate(),u.when(D.getCustomerExpenses({organization:ae,customer:o.selectedCustomer.entity})).then(function(ie){for(var oe=[],re=0;re<ie.length;++re)if('Yes'==ie[re].entity.get('billable'))for(var le=0;le<o.expenseItems.length;++le)ie[re].entity.id==o.expenseItems[le].entity.expanseId&&oe.push(o.expenseItems[le]);for(var de=[],re=0;re<ie.length;++re)if('No'!=ie[re].entity.get('billable')){var ce=ie[re].entity,me=oe.some(function(he){return ce.category==he.entity.title&&ce.amount==+he.entity.rate});me||de.push({create:!0,tax:ce.tax,entity:{title:ce.category,rate:ce.amount+'',expanseId:ce.id}})}var ue=o.actualItems.concat(oe,de);return o.invoiceItems=o.invoiceItems.filter(function(pe){return!pe.selectedItem||pe.selectedItem.create?!1:ue.some(function(ye){return ye.entity.id==pe.selectedItem.entity.id})}),'Sales'!=se.get('role')&&ue.push(createItemOpener),o.items=ue})}function J(){return o.selectedCustomer.dummy?void r.go('dashboard.customers.new',{backLink:r.current.name}):void(showLoader(),u.when(Z()).then(function(){1>o.invoiceItems.length?(o.addInvoiceItem(),o.totalTax=0,o.subTotal=0,o.subTotalStr=N(0*ee.exchangeRate,ee.currencySymbol,2),o.reCalculateTotal()):X(),hideLoader()}))}function Q(ne){if(ne=ne.split(',').join(''),-1!==ne.indexOf('.')){for(;/(\d+)(\d{3})/.test(ne.toString());)ne=ne.toString().replace(/(\d+)(\d{3})/,'$1,$2');var ie=ne.length-ne.indexOf('.');3==ie&&$('.add_item_price').attr('maxlength',ne.length)}else for($('.add_item_price').attr('maxlength',50);/(\d+)(\d{3})/.test(ne.toString());)ne=ne.toString().replace(/(\d+)(\d{3})/,'$1,$2');return ne}if(!y.entity.length)return console.log('User not logged in'),void 0;var ee=y.entity[0].currency.attributes;if(ee.exchangeRate)o.currentCurrency=ee;else{var te={currencySymbol:'$',exchangeRate:1};o.currentCurrency=te,ee=te}var se=y.entity[0],ae=se.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),u.when(y.entity[0].currency.fetch()).then(function(ne){if(ee=ne.attributes,ee.exchangeRate)o.currentCurrency=ee;else{var ie={currencySymbol:'$',exchangeRate:1};o.currentCurrency=ie,ee=ie}E()}),$.validator.addMethod('notBackDate',function(){return o.todayDate<=o.dueDate}),$('#addTaxForm').validate({rules:{name:'required',rate:{required:!0,number:!0}},messages:{name:'Please enter Tax name',rate:{required:'tax rate is required',number:'please enter a valid rate(number)'}}}),$('#addInvoiceForm').validate({onkeyup:function(ne){$(ne).valid()},rules:{customer:'required',invoiceNumber:'required',invoiceCreateDate:'required',invoiceDueDate:{required:!0}},messages:{customer:'Please select a customer',invoiceNumber:'Please enter invoice number',invoiceCreateDate:'Please provide invoice Create date',invoiceDueDate:{required:'Please provide invoice Due date'}}}),$('#extrasForm').validate({rules:{discount:{number:!0,min:0,max:100},shipCharges:{number:!0,min:0},adjustment:{number:!0}},messages:{discount:{number:'Must be a number',min:'Discount can not be less than 0',max:'Discount should be less than 100%'}}}),$('#itemInfoForm').validate(),o.projectId=r.params.projectId,o.dateOptions={showWeeks:!1},o.save=function(){G()&&(showLoader(),u.when(h.checkInvoiceNumAvailable({invoiceNumber:o.invoiceNo,organization:ae})).then(function(ne){return ne?M():(H(),scrollToOffset(),Promise.reject('Invoice with this number already exists'))}).then(function(ne){K('Invoice created for '+N(ne.attributes.balanceDue,'$',2)+' amount',!0,ne).then(function(ie){hideLoader(),r.go('dashboard.sales.invoices.details',{invoiceId:ie.id})})},function(ne){hideLoader(),console.log(ne)}))},o.lateFeeChanged=function(){o.selectedLateFee&&o.selectedLateFee.dummy&&(o.selectedLateFee='',W(),$('.add-latefee').addClass('show'))},o.addLateFee=function(){if($('#addLateFeeForm').valid()){showLoader();var ne={userID:se,organization:ae,name:o.latefeeName,type:o.selectedFeeType,price:+o.latefeeAmount};u.when(g.getUserRole(se)).then(function(ie){return I.createLateFee(ne,ie)}).then(function(ie){ie.toStr=L(ie),o.lateFeeList.pop(),o.lateFeeList.push(ie),'Sales'!=se.get('role')&&o.lateFeeList.push(createLateFeeOpener),o.selectedLateFee=ie,$('.add-latefee').removeClass('show'),hideLoader()})}},o.saveAndSend=function(){if(G()){$('#emailText-error').hide();var ne=o.selectedCustomer.entity.get('contactPersons');o.contacts=[],o.mobileContacts=[],ne.length&&ne.forEach(function(ie){var oe=ie.get('firstname')?ie.get('firstname'):'',re=ie.get('lastname')?ie.get('lastname'):'',le=1==ie.get('defaultPerson'),de=oe+' '+re;ie.get('email')&&o.contacts.push({selected:le,contact:ie.get('email'),contactName:'('+de+') '+ie.get('email')}),ie.get('phone')&&o.mobileContacts.push({selected:!1,contact:ie.get('phone'),contactName:'('+de+') '+ie.get('phone')}),ie.get('mobile')&&o.mobileContacts.push({selected:le,contact:ie.get('mobile'),contactName:'('+de+') '+ie.get('mobile')})}),o.contacts.length||o.mobileContacts.length?$('.email-text').addClass('show'):ShowMessage('The customer does not have a email or phone number in their profile. Please select save.','error')}},o.sendReceipt=function(){debugger;var ne=0,ie=0;o.contacts.forEach(function(oe){oe.selected&&ne++}),o.mobileContacts.forEach(function(oe){oe.selected&&ie++}),0<ne||0<ie?V():$('#emailText-error').show()},o.cancel=function(){r.go('dashboard.sales.invoices.all')},o.addNewFile=function(ne){var ie=ne.files[0],oe=ie.name;if(0<=oe.toLowerCase().indexOf('^')&&(oe=oe.replace('^','')),!(oe.toLowerCase().endsWith('.pdf')||oe.toLowerCase().endsWith('.png')||oe.toLowerCase().endsWith('.jpg')||oe.toLowerCase().endsWith('.jpeg')))return void $('#file-error').show();$('#file-error').hide();var re=ne.files[0].size;if(5242880<re)return void $('#file-size-error').show();$('#file-size-error').hide(),ie.fileName=oe,o.files.push(ie);for(var le=0;le<o.files.length;++le)o.files[le].fileName='Attachment '+_(le+1)+Y(o.files[le].fileName);o.$$phase||o.$apply()},o.removeFile=function(ne){o.files.splice(ne,1);for(var ie=0;ie<o.files.length;++ie)o.files[ie].fileName='Attachment '+_(ie+1)+Y(o.files[ie].fileName)},o.calculateDueDate=function(){var ne=new Date(o.todayDate);ne.setHours(0),1!=o.paymentTerms.selectedTerm.value&&(ne=ne.addDays(o.paymentTerms.selectedTerm.value)),o.dueDate=ne},o.paymentTermsChanged=function(){o.hasDueDate=0!=o.paymentTerms.selectedTerm.value,o.hasDueDate&&o.calculateDueDate()},o.openDatePicker=function(ne){1===ne?o.openPicker1=!0:2===ne?o.openPicker2=!0:void 0},o.addInvoiceItem=function(){o.invoiceItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},o.reCalculateTotal=function(){var ne=+o.subTotal||0,ie=+o.discount||0,oe=+o.shippingCharges||0,re=+o.adjustments||0,le=+o.totalTax||0,de=ne+le,ce=0.01*(100-ie);2==o.prefs.discountType?de=ne*ce+le:3==o.prefs.discountType&&(de=(ne+le)*ce),ie=Math.abs(de-ne-le),o.total=de+oe+re,o.discountStr=N(ie*ee.exchangeRate,ee.currencySymbol,2),o.shippingChargesStr=N(oe*ee.exchangeRate,ee.currencySymbol,2),o.adjustmentsStr=N(re*ee.exchangeRate,ee.currencySymbol,2),o.totalStr=N(o.total*ee.exchangeRate,ee.currencySymbol,2)},o.reCalculateSubTotal=X,o.reCalculateItemAmount=function(ne){var ie=o.invoiceItems[ne];ie.selectedItem&&(ie.amount=ie.rate*ie.quantity,X())},o.removeInvoiceItem=function(ne){1<o.invoiceItems.length?(o.invoiceItems.splice(ne,1),X()):console.log('there should be atleast 1 item in an invoice')},o.itemChanged=function(ne){console.log('item changed');var ie=o.invoiceItems[ne];if(ie.selectedItem.dummy)return ie.selectedItem=null,$('.new-item').addClass('show'),o.itemChangedIndex=ne,void o.prepareCreateItem();ie.rate=+ie.selectedItem.entity.rate;var oe=ie.selectedItem.tax;if(!oe)ie.selectedTax='';else for(var re=o.taxes,le=0;le<re.length;++le)if(oe.id==re[le].id){ie.selectedTax=re[le];break}o.reCalculateItemAmount(ne)},o.taxChanged=function(ne){if(console.log('tax changed'),-1!=ne){var ie=o.invoiceItems[ne];if(!ie.selectedTax)X();else if(ie.selectedTax.dummy)return o.currentItem=ne,o.taxName=null,o.taxRate=null,ie.selectedTax=null,void $('.new-tax').addClass('show')}else if(o.newItem.tax.dummy)return o.currentItem=ne,o.newItem.tax=null,o.taxName=null,o.taxRate=null,void $('.new-tax').addClass('show');X()},o.customerChanged=J,o.printSelected=function(){},o.prepareCreateItem=function(){U.prepareCreateItem({_scope:o})},o.createNewItem=function(){U.createNewItem({_scope:o,user:se,organization:ae})},o.saveNewTax=function(){$('#addTaxForm').valid()&&U.createNewTax({_scope:o,user:se},function(){X(),o.$$phase||o.$apply()})},$('.add_item_price').keyup(function(){$(this).val(Q($(this).val()))})}]);'use strict',invoicesUnlimited.controller('EstimateToInvoiceController',['$scope','$state','$controller','$q','userFactory','invoiceService','salesCommon','estimateService',function(o,r,l,u,y,h,g,C){function T(){return o.invoiceItems=[],o.selectedCustomer=o.customers.filter(function(P){return o.estimate.entity.get('customer').id===P.entity.id})[0],u.when(g.customerChangedHelper({organization:I,_scope:o})).then(function(){var P=o.estimate;o.invoiceNo=o.prefs.invoiceNumber,o.poNumber=P.entity.referenceNumber||'',o.disableInvNo=1==o.prefs.numAutoGen,o.paymentTerms={terms:[{name:'Off',value:0},{name:'Due on Receipt',value:1},{name:'Net 7',value:7},{name:'Net 10',value:10},{name:'Net 30',value:30},{name:'Net 60',value:60},{name:'Net 90',value:90}],selectedTerm:{name:'Due on Receipt',value:1}},o.hasDueDate=!0,o.todayDate=new Date,g.calculateDueDate(o),o.files=[];var S=P.entity.estimateFiles;switch(S?(S.forEach(function(B){B.fileName=B.name(),B.exist=!0}),o.files=S):o.files=[],o.prefs.discountType){case 0:o.itemLevelTax=!1,o.invoiceLevelTax=!1;break;case 1:o.itemLevelTax=!0,o.invoiceLevelTax=!1;break;case 2:case 3:o.itemLevelTax=!1,o.invoiceLevelTax=!0;}o.notes=P.entity.notes,o.terms=P.entity.termsConditions,o.prefs.shipCharges&&(o.shippingCharges=P.entity.shippingCharges,o.showShippingCharges=!0),o.prefs.adjustments&&(o.adjustments=P.entity.adjustments,o.showAdjustments=!0),o.prefs.salesPerson&&(o.salesPerson=P.entity.salesPerson||'',o.showSalesPerson=!0),o.invoiceItems=[];for(var k=0;k<P.estimateItems.length;++k){var L=P.estimateItems[k].entity,E=L.get('item'),R={};R.selectedItem=o.items.filter(function(B){if(B.entity.id===E.id){R.id=L.id,R.rate=L.amount/L.quantity,R.quantity=L.quantity,R.discount=L.discount||0,R.taxValue=0,R.amount=L.amount;var M=L.get('tax');return R.selectedTax=M?o.taxes.filter(function(q){return q.id===M.id})[0]:void 0,!0}return!1})[0],o.invoiceItems.push(R)}var A=[];o.prefs.customFields&&o.prefs.customFields.forEach(function(B){'YES'==B.isChecked&&A.push({name:B.name,value:''})}),o.customFields=A,g.addValidationExceptItems(o),g.reCalculateSubTotal(o),hideLoader()})}if(!y.entity.length)return console.log('User not logged in'),void 0;var D=y.entity[0],I=D.get('organizations')[0];l('DashboardController',{$scope:o,$state:r});var N=r.params.estimateId;if(N){var F=[],U=null;U=u.when(C.getEstimate(N)).then(function(P){o.estimate=P}),F.push(U),U=u.when(g.loadRequiredData({user:D,organization:I,_scope:o})),F.push(U),u.all(F).then(function(){T()}),o.save=function(){g.save({_scope:o,user:D,organization:I})},o.saveAndSend=function(){g.saveAndSend({_scope:o,user:D,organization:I})},o.cancel=function(){r.go('dashboard.sales.invoices.all')},o.addNewFile=function(P){var S=P.files[0];S.fileName=S.name,o.files.push(S),o.$$phase||o.$apply()},o.removeFile=function(P){o.files.splice(P,1)},o.calculateDueDate=function(){g.calculateDueDate(o)},o.paymentTermsChanged=function(){g.paymentTermsChanged(o)},o.openDatePicker=function(P){1===P?o.openPicker1=!0:2===P?o.openPicker2=!0:void 0},o.addInvoiceItem=function(){g.addInvoiceItem(o)},o.reCalculateTotal=function(){g.reCalculateTotal(o)},o.reCalculateItemAmount=function(P){g.reCalculateItemAmount({index:P,_scope:o})},o.removeInvoiceItem=function(P){g.removeInvoiceItem({index:P,_scope:o})},o.itemChanged=function(P){g.itemChanged({index:P,_scope:o})},o.customerChanged=function(){g.customerChanged({organization:I,_scope:o})},o.prepareCreateItem=function(){g.prepareCreateItem({_scope:o})},o.createNewItem=function(){g.createNewItem({_scope:o,user:D,organization:I})}}}]);'use strict',invoicesUnlimited.controller('InvoiceController',['$q','$scope','$state','$controller','userFactory','invoiceService','coreFactory','taxService','expenseService','lateFeeService','commentFactory','currencyFilter','salesCommon',function(o,r,l,u,y,h,g,C,T,D,I,N,F){function U(){$('.check-item').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please select an item'}})}),$('.check-qty').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:1,number:!0,messages:{required:'Please provide item quantity',min:'Quantity should be greater than 1',number:'Quantity must be number'}})}),$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0,number:!0,messages:{required:'Please provide item rate',min:'rate should be >= 0',number:'Please enter a valid price'}})}),$('.check-discount').each(function(){$(this).rules('remove'),$(this).rules('add',{min:0,max:100,number:!0,messages:{min:'Discount should be greater than 0',max:'Discount should be less than 100%'}})})}function P(Q){Q||(Q=l.current.name),J.invoices(Q)?K():J.newInvoice(Q)||J.edit(Q)&&S()}function S(){var Q=l.params.invoiceId;if(Q){var ee=l.params.customerId;showLoader(),o.when(W()).then(function(){return o.when(h.getInvoice(Q))}).then(function(te){return r.invoice=te,r.invoiceItems=[],r.deletedItems=[],r.itemsWithOutId=0,r.itemsWithIdinDel=0,r.selectedCustomer=ee?r.customers.filter(function(se){return ee===se.entity.id})[0]:r.customers.filter(function(se){return te.entity.get('customer').id===se.entity.id})[0],o.when(H())}).then(function(){k()},function(te){hideLoader(),console.log(te.message)})}}function k(){var Q=r.invoice;r.invoiceNo=Q.entity.invoiceNumber,r.poNumber=Q.entity.poNumber||'',r.disableInvNo=1==r.prefs.numAutoGen,r.todayDate=Q.entity.invoiceDate,r.dueDate=Q.entity.dueDate,r.paymentTerms={terms:[{name:'Off',value:0},{name:'Due on Receipt',value:1},{name:'Net 7',value:7},{name:'Net 10',value:10},{name:'Net 30',value:30},{name:'Net 60',value:60},{name:'Net 90',value:90}]},r.hasDueDate=!!Q.entity.dueDate,r.paymentTerms.selectedTerm=r.hasDueDate?Q.entity.paymentTerms?r.paymentTerms.terms.filter(function(ce){return ce.name==Q.entity.paymentTerms})[0]:r.paymentTerms.terms[1]:r.paymentTerms.terms[0];var ee=Q.entity.lateFee;if(ee)for(var te=r.lateFeeList,se=0;se<te.length;++se)if(te[se].entity.id==ee.id){r.selectedLateFee=te[se];break}var ae=Q.entity.invoiceFiles;switch(ae?(ae.forEach(function(ce){ce.fileName=ce.name(),ce.fileName1=ce.fileName.substring(ce.fileName.indexOf('_')+1,ce.fileName.length),ce.exist=!0}),r.files=ae):r.files=[],r.lastFileNumber=r.files.length,r.prefs.discountType){case 0:r.itemLevelTax=!1,r.invoiceLevelTax=!1;break;case 1:r.itemLevelTax=!0,r.invoiceLevelTax=!1;break;case 2:case 3:r.itemLevelTax=!1,r.invoiceLevelTax=!0;}r.discount=Q.entity.discounts,r.notes=Q.entity.notes,r.terms=Q.entity.terms,(r.prefs.shipCharges||Q.entity.shippingCharges)&&(r.shippingCharges=Q.entity.shippingCharges,r.showShippingCharges=!0),(r.prefs.adjustments||Q.entity.adjustments)&&(r.adjustments=Q.entity.adjustments,r.showAdjustments=!0),r.prefs.salesPerson&&(r.salesPerson=Q.entity.salesPerson||'',r.showSalesPerson=!0),'Sent'==Q.entity.status&&(r.previouslySent=!0);for(var ne=[],se=0;se<Q.invoiceItems.length;++se){var ie=Q.invoiceItems[se].entity,oe=ie.get('item'),re={};re.selectedItem=r.items.filter(function(ce){if(ce.entity.id===oe.id){re.id=ie.id,re.rate=ie.amount/ie.quantity,re.quantity=ie.quantity,re.discount=ie.discount||0,re.taxValue=0,re.amount=ie.amount;var me=ie.get('tax');return re.selectedTax=me?r.taxes.filter(function(ue){return ue.id===me.id})[0]:void 0,0<=ce.entity.title.indexOf('Misc. Item')&&ne.push(ce.entity.id),!0}return!1})[0],r.invoiceItems.push(re)}r.items=r.items.filter(function(ce){if(0<=ce.entity.title.indexOf('Misc. Item')){var me=ne.indexOf(ce.entity.id);return!!(0<=me)}return!0});var le=[];r.prefs.customFields&&r.prefs.customFields.forEach(function(ce){'YES'==ce.isChecked&&le.push({name:ce.name,value:''})});var de=Q.entity.customFields;de&&de.length&&le.forEach(function(ce){for(var me=0;me<de.length;++me)if(de[me][ce.name]){ce.value=de[me][ce.name];break}}),r.customFields=le,O(),hideLoader()}function L(){console.log('came');var Q=r.itemsWithIdinDel,ee=r.itemsWithOutId;if(!(0>=Q||0>=ee)){var te=0,se=r.invoiceItems;r.deletedItems.forEach(function(ae){if(ae.id)for(;te<se.length;++te)if(!se[te].id)return se[te].id=ae.id,ae.id=void 0,--r.itemsWithIdinDel,void--r.itemsWithOutId}),r.deletedItems=r.deletedItems.filter(function(ae){return!!ae.id})}}function E(Q){var ee=r.invoice.entity;if(ee.set('customer',r.selectedCustomer.entity),ee.set('invoiceDate',r.todayDate),ee.set('invoiceNumber',r.invoiceNo),ee.set('discountType',r.prefs.discountType),ee.set('discounts',r.discount),ee.set('shippingCharges',r.shippingCharges),ee.set('adjustments',r.adjustments),ee.set('subTotal',+(+r.subTotal).toFixed(2)),ee.set('balanceDue',+(+r.total).toFixed(2)-ee.get('total')+ee.get('balanceDue')),ee.set('total',+(+r.total).toFixed(2)),ee.set('poNumber',r.poNumber),ee.set('salesPerson',r.salesPerson),ee.set('notes',r.notes),ee.set('terms',r.terms),r.customFields.length){var te=[];r.customFields.forEach(function(ne){if(ne.value){var ie={};ie[ne.name]=ne.value,te.push(ie)}}),te.length?ee.set('customFields',te):ee.unset('customFields')}if(r.selectedLateFee?ee.set('lateFee',r.selectedLateFee.entity):ee.unset('lateFee'),ee.set('paymentTerms',r.paymentTerms.selectedTerm.name),0<r.paymentTerms.selectedTerm.value){ee.set('dueDate',r.dueDate);var se=new Date;se.setHours(23),'Overdue'==ee.get('status')&&r.dueDate>se&&ee.set('status','Draft')}else ee.unset('dueDate'),'Overdue'==ee.get('status')&&ee.set('status','Draft');var ae=r.selectedCustomer.entity.email;return ae?ee.set('customerEmails',[ae]):ee.unset('customerEmails'),h.updateInvoice(r.invoice,r.invoiceItems,r.deletedItems,X,r.userRole,r.files).then(function(ne){return h.copyInInvoiceInfo(ne).then(function(){if(R('Invoice edited',!0),Q.generateReceipt){var le=ne.get('invoiceInfo');return le&&(le=le.id),h.createInvoiceReceipt(ne.id,le)}return ne})})}function R(Q,ee){var te={userID:X,organization:Z,name:X.get('username'),date:new Date,isAutomaticallyGenerated:ee,comment:Q};if(X.get('isTrackUsage')||!ee){var se={};o.when(g.getUserRole(X)).then(function(ae){return I.createNewComment(te,ae)}).then(function(ae){se.commentObj=ae;var ne=r.invoice.entity,ie=ne.get('comments');return ie?ie.push(ae):ie=[ae],ne.set('comments',ie),ne.save()})}}function A(){return E({generateReceipt:!1}).then(function(Q){return h.copyInInvoiceInfo(Q).then(function(ee){return h.createInvoiceReceipt(Q.id,ee.id)}).then(function(ee){return h.sendInvoiceReceipt(ee)})})}function B(){U();var Q=$('#editInvoiceForm').valid(),ee=$('#itemInfoForm').valid(),te=$('#extrasForm').valid();if(Q&&ee&&te)return!0;var se;Q?ee?!te&&(se=$('#extrasForm').validate()):se=$('#itemInfoForm').validate():se=$('#editInvoiceForm').validate();var ae=$(se.errorList[0].element).offset().top-30;return scrollToOffset(ae),!1}function M(Q){return 10>Q&&(Q='0'+Q),Q}function q(Q){return'.'+Q.split('.').pop()}function O(){var Q=r.invoiceItems,ee=0,te=0;r.itemTaxes=[],Q.forEach(function(se){ee+=se.amount*(0.01*(100-se.discount));var ae=+r.discount||0;if(se.taxValue=2==r.prefs.discountType?calculateTax(se.amount*(0.01*(100-ae)),se.selectedTax):calculateTax(se.amount*(0.01*(100-se.discount)),se.selectedTax),te+=se.taxValue,se.selectedTax){var ne=-1;if(2==se.selectedTax.type){var ie=se.selectedTax.entity.get('associatedTaxes');ie.forEach(function(oe){ne=-1,r.itemTaxes.length&&(ne=r.itemTaxes.findIndex(function(le){return le.name==oe.get('title')}));var re=0;oe.get('compound')?(re=0.01*(se.amount*(se.selectedTax.rate-oe.get('value'))),re=0.01*((se.amount+re)*oe.get('value'))):re=0.01*(se.amount*oe.get('value')),-1==ne?r.itemTaxes.push({nameValue:oe.get('title')+' ('+oe.get('value')+'%)',amount:N(re,'$',2),count:1,name:oe.get('title'),amountValue:re}):(r.itemTaxes[ne].amountValue+=re,r.itemTaxes[ne].count++,r.itemTaxes[ne].amount=N(r.itemTaxes[ne].amountValue,'$',2))})}else r.itemTaxes.length&&(ne=r.itemTaxes.findIndex(function(oe){return oe.name==se.selectedTax.name})),-1==ne?r.itemTaxes.push({nameValue:se.selectedTax.name+' ('+se.selectedTax.rate+'%)',amount:N(se.taxValue,'$',2),count:1,name:se.selectedTax.name,amountValue:se.taxValue}):(r.itemTaxes[ne].amountValue+=se.taxValue,r.itemTaxes[ne].count++,r.itemTaxes[ne].amount=N(r.itemTaxes[ne].amountValue,'$',2))}}),r.totalTax=te,r.subTotal=ee,r.subTotalStr=N(ee*_.exchangeRate,_.currencySymbol,2),r.reCalculateTotal()}function H(){return r.items.pop(),o.when(T.getCustomerExpenses({organization:Z,customer:r.selectedCustomer.entity})).then(function(Q){for(var ee=[],te=0;te<Q.length;++te)if('No'!=Q[te].entity.get('billable'))for(var se=0;se<r.expenseItems.length;++se)Q[te].entity.id==r.expenseItems[se].entity.expanseId&&ee.push(r.expenseItems[se]);for(var ae=[],te=0;te<Q.length;++te)if('No'!=Q[te].entity.get('billable')){var ne=Q[te].entity,ie=ee.some(function(we){return ne.category==we.entity.title&&ne.amount==+we.entity.rate});ie||ae.push({create:!0,tax:ne.tax,entity:{title:ne.category,rate:ne.amount+'',expanseId:ne.id}})}var oe=r.actualItems.concat(ee,ae);return r.invoiceItems=r.invoiceItems.filter(function(re){return!re.selectedItem||re.selectedItem.create?!1:oe.some(function(le){return le.entity.id==re.selectedItem.entity.id})}),'Sales'!=X.get('role')&&oe.push(createItemOpener),r.items=oe})}function G(Q){var ee=Q.entity;return ee.name+' '+ee.price+' ('+ee.type+')'}function W(){var Q=[],ee=null;return ee=o.when(g.getAllCustomers()).then(function(te){te=te.filter(function(se){return'active'==se.entity.status}),r.customers=te.sort(function(se,ae){return alphabeticalSort(se.entity.displayName,ae.entity.displayName)}),r.customers.forEach(function(se){se.fullName=se.entity.salutation?se.entity.salutation+' '+se.entity.displayName:se.entity.displayName}),'Sales'!=X.get('role')&&r.customers.push(createCustomerOpener)}),Q.push(ee),ee=o.when(g.getAllItemsIncludingDelete({organization:Z})).then(function(te){r.actualItems=te.filter(function(se){return!se.entity.expanseId}),r.expenseItems=te.filter(function(se){return se.entity.expanseId}),r.items=r.actualItems,'Sales'!=X.get('role')&&r.items.push(createItemOpener)}),Q.push(ee),ee=o.when(h.getPreferences(X)).then(function(te){r.prefs=te}),Q.push(ee),ee=o.when(g.getUserRole(X)).then(function(te){r.userRole=te}),Q.push(ee),ee=C.getTaxes(X,function(te){r.taxes=te,'Sales'!=X.get('role')&&r.taxes.push(createTaxOpener)}),Q.push(ee),ee=D.getAllLateFees({organization:Z}).then(function(te){r.lateFeeList=te.map(function(se){return se.toStr=G(se),se}),'Sales'!=X.get('role')&&r.lateFeeList.push(createLateFeeOpener)}),Q.push(ee),o.all(Q)}function K(){showLoader(),o.when(h.listInvoices(X)).then(function(Q){var ee=r.dateFormat.toUpperCase().replace(/E/g,'d');Q.forEach(function(te){switch(te.entity.status){case'Unpaid':te.statusClass='text-color-normalize';break;case'Paid':te.statusClass='text-paid';break;case'Overdue':te.statusClass='text-overdue';break;case'Partial Paid':te.statusClass='text-partialpaid';break;case'Sent':te.statusClass='text-sent';break;case'Refunded':te.statusClass='text-danger';break;case'Partial Refunded':te.statusClass='text-danger';break;default:te.statusClass='text-color-normalize';}te.entity.get('invoiceFiles')&&(te.attachments=te.entity.get('invoiceFiles').length),te.invoiceDate=formatDate(te.entity.invoiceDate,ee);var se=0;if(te.entity.dueDate){te.dueDate=formatDate(te.entity.dueDate,ee);var ae=te.entity.dueDate;ae.setHours(23),ae.setMinutes(59),ae.setSeconds(59);var ne=new Date,ie=te.entity.balanceDue*_.exchangeRate,oe=te.entity.total*_.exchangeRate;if(ne>ae&&te.entity.get('lateFee')){var re=te.entity.get('lateFee'),le=re.get('price'),de=re.get('type');'$'==de?se=le:'%'==de&&(se=0.01*(ie*le))}}else te.dueDate='';te.balanceDue=N(ie+se,_.currencySymbol,2),te.total=N(oe+se,_.currencySymbol,2)}),Q=Q.reverse(),r.invoiceList=Q,r.allInvoices=Q,r.displayedInvoices=Q,r.sortByDate(),hideLoader()},function(Q){hideLoader(),console.log(Q.message)})}function V(){r.latefeeName='',r.latefeeTypes=['%','$'],r.selectedFeeType=r.latefeeTypes[0],r.latefeeAmount='',$('#addLateFeeForm').validate({rules:{name:'required',type:'required',amount:{required:!0,number:!0,min:0.01}}}),$('#addLateFeeForm').validate().resetForm()}if(!y.entity.length)return console.log('User not logged in'),void 0;var _=y.entity[0].currency.attributes;if(_.exchangeRate)r.currentCurrency=_;else{var Y={currencySymbol:'$',exchangeRate:1};r.currentCurrency=Y,_=Y}var X=y.entity[0],Z=X.get('organizations')[0];u('DashboardController',{$scope:r,$state:l});var J={details:function(Q){return Q.endsWith('invoices.details')},invoices:function(Q){return Q.endsWith('invoices.all')},edit:function(Q){return Q.endsWith('invoices.edit')},newInvoice:function(Q){return Q.endsWith('invoices.new')}};y.getField('dateFormat').then(function(Q){r.dateFormat=Q,o.when(y.entity[0].currency.fetch()).then(function(ee){if(_=ee.attributes,_.exchangeRate)r.currentCurrency=_;else{var te={currencySymbol:'$',exchangeRate:1};r.currentCurrency=te,_=te}P()})}),$.validator.addMethod('notBackDate',function(){return r.todayDate<=r.dueDate}),$('#addTaxForm').validate({rules:{name:'required',rate:{required:!0,number:!0}},messages:{name:'Please enter Tax name',rate:{required:'tax rate is required',number:'please enter a valid rate(number)'}}}),$('#editInvoiceForm').validate({rules:{customer:'required',invoiceNumber:'required',invoiceCreateDate:'required',invoiceDueDate:{required:!0}},messages:{customer:'Please select a customer',invoiceNumber:'Please enter invoice number',invoiceCreateDate:'Please provide invoice Create date',invoiceDueDate:{required:'Please provide invoice Due date'}}}),$('#extrasForm').validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$('#itemInfoForm').validate(),r.dateOptions={showWeeks:!1},r.addInvoiceItem=function(){var Q=r.deletedItems.pop();Q?--r.itemsWithIdinDel:(Q={id:void 0},++r.itemsWithOutId),Q.selectedItem=void 0,Q.selectedTax=void 0,Q.rate=0,Q.quantity=1,Q.discount=0,Q.taxValue=0,Q.amount=0,r.invoiceItems.push(Q)},r.removeInvoiceItem=function(Q){if(1<r.invoiceItems.length){var ee=r.invoiceItems.splice(Q,1)[0];ee.id?(++r.itemsWithIdinDel,r.deletedItems.push(ee)):--r.itemsWithOutId,O()}else console.log('there should be atleast 1 item in an invoice')},r.save=function(){B()&&(showLoader(),L(),E({generateReceipt:!0}).then(function(Q){hideLoader(),console.log(Q),l.go('dashboard.sales.invoices.details',{invoiceId:Q.id})},function(Q){hideLoader(),console.log(Q.message)}))},r.saveAndSend=function(){B()&&(showLoader(),L(),A().then(function(Q){hideLoader(),console.log(Q),l.go('dashboard.sales.invoices.all')},function(Q){hideLoader(),console.log(Q)}))},r.addNewFile=function(Q){var ee=Q.files[0],te=ee.name;if(0<=te.toLowerCase().indexOf('^')&&(te=te.replace('^','')),!(te.toLowerCase().endsWith('.pdf')||te.toLowerCase().endsWith('.png')||te.toLowerCase().endsWith('.jpg')||te.toLowerCase().endsWith('.jpeg')))return void $('#file-error').show();$('#file-error').hide();var se=Q.files[0].size;return 5242880<se?void $('#file-size-error').show():void($('#file-size-error').hide(),te='Attachment '+M(++r.lastFileNumber)+q(te),ee.fileName=te,ee.fileName1=te,r.files.push(ee),!r.$$phase&&r.$apply())},r.removeFile=function(Q){r.files.splice(Q,1)},r.cancel=function(){l.go('dashboard.sales.invoices.all')},r.calculateDueDate=function(){var Q=new Date(r.todayDate);Q.setHours(0),1!=r.paymentTerms.selectedTerm.value&&(Q=Q.addDays(r.paymentTerms.selectedTerm.value)),r.dueDate=Q},r.paymentTermsChanged=function(){r.hasDueDate=0!=r.paymentTerms.selectedTerm.value,r.hasDueDate&&r.calculateDueDate()},r.openDatePicker=function(Q){2==Q&&1<r.paymentTerms.selectedTerm.value||(2===Q?r.openPicker2=!0:void 0)},r.reCalculateTotal=function(){var Q=+r.subTotal||0,ee=+r.discount||0,te=+r.shippingCharges||0,se=+r.adjustments||0,ae=+r.totalTax||0,ne=Q+ae,ie=0.01*(100-ee);2==r.prefs.discountType?ne=Q*ie+ae:3==r.prefs.discountType&&(ne=(Q+ae)*ie),ee=Math.abs(ne-Q-ae),r.total=ne+te+se,r.discountStr=N(ee*_.exchangeRate,_.currencySymbol,2),r.shippingChargesStr=N(te*_.exchangeRate,_.currencySymbol,2),r.adjustmentsStr=N(se*_.exchangeRate,_.currencySymbol,2),r.totalStr=N(r.total*_.exchangeRate,_.currencySymbol,2)},r.reCalculateItemAmount=function(Q){var ee=r.invoiceItems[Q];ee.selectedItem&&(ee.amount=ee.rate*ee.quantity,O())},r.taxChanged=function(Q){if(console.log('tax changed'),-1!=Q){var ee=r.invoiceItems[Q];if(!ee.selectedTax)O();else if(ee.selectedTax.dummy)return r.currentItem=Q,r.taxName=null,r.taxRate=null,ee.selectedTax=null,void $('.new-tax').addClass('show')}else if(r.newItem.tax.dummy)return r.currentItem=Q,r.newItem.tax=null,r.taxName=null,r.taxRate=null,void $('.new-tax').addClass('show');O()},r.itemChanged=function(Q){var ee=r.invoiceItems[Q];if(ee.selectedItem.dummy)return ee.selectedItem=null,$('.new-item').addClass('show'),r.itemChangedIndex=Q,void r.prepareCreateItem();ee.rate=+ee.selectedItem.entity.rate;var te=ee.selectedItem.tax;if(!te)ee.selectedTax='';else for(var se=r.taxes,ae=0;ae<se.length;++ae)if(te.id==se[ae].id){ee.selectedTax=se[ae];break}r.reCalculateItemAmount(Q)},r.customerChanged=function(){return r.selectedCustomer.dummy?void l.go('dashboard.customers.new',{backLink:l.current.name,invoiceId:l.params.invoiceId}):void(showLoader(),o.when(H()).then(function(){1>r.invoiceItems.length?(r.addInvoiceItem(),r.totalTax=0,r.subTotal=0,r.subTotalStr=N(0,_.currencySymbol,2),r.reCalculateTotal()):O(),hideLoader()}))},r.sortByStatus=function(){r.invoiceList.sort(function(Q,ee){return Q.entity.status.localeCompare(ee.entity.status)}),'none'===$('#status').css('display')?(r.invoiceList.sort(function(Q,ee){return Q.entity.status.localeCompare(ee.entity.status)}),$('#status').css({display:'inline-table'}),$('#statusUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return ee.entity.status.localeCompare(Q.entity.status)}),$('#statusUp').css({display:'inline-table'}),$('#status').css({display:'none'})),$('#date').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#orderno').css({display:'none'}),$('#custname').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'}),$('#ordernoUp').css({display:'none'}),$('#custnameUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByInvoiveNumber=function(){'none'===$('#invoiceno').css('display')?(r.invoiceList.sort(function(Q,ee){return ee.entity.invoiceNumber.localeCompare(Q.entity.invoiceNumber)}),$('#invoiceno').css({display:'inline-table'}),$('#invoicenoUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return Q.entity.invoiceNumber.localeCompare(ee.entity.invoiceNumber)}),$('#invoicenoUp').css({display:'inline-table'}),$('#invoiceno').css({display:'none'})),$('#status').css({display:'none'}),$('#date').css({display:'none'}),$('#orderno').css({display:'none'}),$('#custname').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#ordernoUp').css({display:'none'}),$('#custnameUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByOrderNumber=function(){$('#status').css({display:'none'}),$('#date').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#custname').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'}),$('#custnameUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'}),'none'===$('#orderno').css('display')?(r.invoiceList.sort(function(Q,ee){return Q.entity.poNumber.localeCompare(ee.entity.poNumber)}),$('#orderno').css({display:'inline-table'}),$('#ordernoUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return ee.entity.poNumber.localeCompare(Q.entity.poNumber)}),$('#ordernoUp').css({display:'inline-table'}),$('#orderno').css({display:'none'}))},r.sortByBalance=function(){'none'===$('#balance').css('display')?(r.invoiceList.sort(function(Q,ee){return ee.entity.balanceDue-Q.entity.balanceDue}),$('#balance').css({display:'inline-table'}),$('#balanceUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return Q.entity.balanceDue-ee.entity.balanceDue}),$('#balanceUp').css({display:'inline-table'}),$('#balance').css({display:'none'})),$('#status').css({display:'none'}),$('#date').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#orderno').css({display:'none'}),$('#custname').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'}),$('#ordernoUp').css({display:'none'}),$('#custnameUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'})},r.sortByAmount=function(){'none'===$('#amount').css('display')?(r.invoiceList.sort(function(Q,ee){return ee.entity.total-Q.entity.total}),$('#amount').css({display:'inline-table'}),$('#amountUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return Q.entity.total-ee.entity.total}),$('#amountUp').css({display:'inline-table'}),$('#amount').css({display:'none'})),$('#status').css({display:'none'}),$('#date').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#orderno').css({display:'none'}),$('#custname').css({display:'none'}),$('#duedate').css({display:'none'}),$('#balance').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'}),$('#ordernoUp').css({display:'none'}),$('#custnameUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByCustomerName=function(){'none'===$('#custname').css('display')?(r.invoiceList.sort(function(Q,ee){return Q.customer.displayName.localeCompare(ee.customer.displayName)}),$('#custname').css({display:'inline-table'}),$('#custnameUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return ee.customer.displayName.localeCompare(Q.customer.displayName)}),$('#custnameUp').css({display:'inline-table'}),$('#custname').css({display:'none'})),$('#status').css({display:'none'}),$('#date').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#orderno').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'}),$('#ordernoUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByDate=function(){'none'===$('#date').css('display')?(r.invoiceList.sort(function(Q,ee){return Q.entity.invoiceDate>ee.entity.invoiceDate?-1:Q.entity.invoiceDate<ee.entity.invoiceDate?1:0}),$('#date').css({display:'inline-table'}),$('#dateUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return ee.entity.invoiceDate>Q.entity.invoiceDate?-1:ee.entity.invoiceDate<Q.entity.invoiceDate?1:0}),$('#dateUp').css({display:'inline-table'}),$('#date').css({display:'none'})),$('#status').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#orderno').css({display:'none'}),$('#custname').css({display:'none'}),$('#duedate').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'}),$('#ordernoUp').css({display:'none'}),$('#custnameUp').css({display:'none'}),$('#duedateUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.sortByDueDate=function(){r.invoiceList.sort(function(Q,ee){return ee.dueDate.localeCompare(Q.dueDate)}),'none'===$('#duedate').css('display')?(r.invoiceList.sort(function(Q,ee){return Q.entity.dueDate>ee.entity.dueDate?-1:Q.entity.dueDate<ee.entity.dueDate?1:0}),$('#duedate').css({display:'inline-table'}),$('#duedateUp').css({display:'none'})):(r.invoiceList.sort(function(Q,ee){return ee.entity.dueDate>Q.entity.dueDate?-1:ee.entity.dueDate<Q.entity.dueDate?1:0}),$('#duedateUp').css({display:'inline-table'}),$('#duedate').css({display:'none'})),$('#status').css({display:'none'}),$('#date').css({display:'none'}),$('#invoiceno').css({display:'none'}),$('#orderno').css({display:'none'}),$('#custname').css({display:'none'}),$('#amount').css({display:'none'}),$('#balance').css({display:'none'}),$('#statusUp').css({display:'none'}),$('#dateUp').css({display:'none'}),$('#invoicenoUp').css({display:'none'}),$('#ordernoUp').css({display:'none'}),$('#custnameUp').css({display:'none'}),$('#amountUp').css({display:'none'}),$('#balanceUp').css({display:'none'})},r.lateFeeChanged=function(){r.selectedLateFee&&r.selectedLateFee.dummy&&(r.selectedLateFee='',V(),$('.add-latefee').addClass('show'))},r.addLateFee=function(){if($('#addLateFeeForm').valid()){showLoader();var Q={userID:X,organization:Z,name:r.latefeeName,type:r.selectedFeeType,price:+r.latefeeAmount};o.when(g.getUserRole(X)).then(function(ee){return D.createLateFee(Q,ee)}).then(function(ee){ee.toStr=G(ee),r.lateFeeList.pop(),r.lateFeeList.push(ee),'Sales'!=X.get('role')&&r.lateFeeList.push(createLateFeeOpener),r.selectedLateFee=ee,$('.add-latefee').removeClass('show'),hideLoader()})}},r.prepareCreateItem=function(){F.prepareCreateItem({_scope:r})},r.createNewItem=function(){F.createNewItem({_scope:r,user:X,organization:Z})},r.saveNewTax=function(){$('#addTaxForm').valid()&&F.createNewTax({_scope:r,user:X},function(){O(),r.$$phase||r.$apply()})},r.showMenu=function(){$('.filtermenu').hasClass('show')?$('.filtermenu').removeClass('show'):$('.filtermenu').addClass('show')},r.currentInvoice='All Invoices',r.showAllInvoices=function(){r.invoiceList=r.allInvoices.filter(function(){return!0}),r.displayedInvoices=r.allInvoices,r.currentInvoice='All Expenses',$('.filtermenu').removeClass('show')},r.sentInvoices=function(){r.invoiceList=r.allInvoices.filter(function(Q){return'Sent'==Q.entity.status}),r.displayedInvoices=r.invoiceList,r.currentInvoice='Sent Invoices',$('.filtermenu').removeClass('show')},r.overdueInvoices=function(){r.invoiceList=r.allInvoices.filter(function(Q){return'Overdue'==Q.entity.status}),r.displayedInvoices=r.invoiceList,r.currentInvoice='Overdue Invoices',$('.filtermenu').removeClass('show')},r.draftInvoices=function(){r.invoiceList=r.allInvoices.filter(function(Q){return'Draft'==Q.entity.status}),r.displayedInvoices=r.invoiceList,r.currentInvoice='Draft Invoices',$('.filtermenu').removeClass('show')},r.paidInvoices=function(){r.invoiceList=r.allInvoices.filter(function(Q){return'Paid'==Q.entity.status}),r.currentInvoice='Paid Invoices',r.displayedInvoices=r.invoiceList,$('.filtermenu').removeClass('show')},r.partialPaidInvoices=function(){r.invoiceList=r.allInvoices.filter(function(Q){return'Partial Paid'==Q.entity.status}),r.displayedInvoices=r.invoiceList,r.currentInvoice='Partial Paid Invoices',$('.filtermenu').removeClass('show')},r.refundedInvoices=function(){r.invoiceList=r.allInvoices.filter(function(Q){return'Refunded'==Q.entity.status}),r.displayedInvoices=r.invoiceList,r.currentInvoice='Refunded Invoices',$('.filtermenu').removeClass('show')},r.search=function(){r.invoiceList=r.searchText.length?r.displayedInvoices.filter(function(Q){return Q.entity.status||(Q.entity.status=''),Q.invoiceDate||(Q.invoiceDate=''),Q.entity.invoiceNumber||(Q.entity.invoiceNumber=''),Q.entity.poNumber||(Q.entity.poNumber=''),Q.customer.displayName||(Q.customer.displayName=''),Q.dueDate||(Q.dueDate=''),Q.total||(Q.total=''),Q.balanceDue||(Q.balanceDue=''),Q.entity.status.toLowerCase().includes(r.searchText.toLowerCase())||Q.invoiceDate.toLowerCase().includes(r.searchText.toLowerCase())||Q.entity.invoiceNumber.toLowerCase().includes(r.searchText.toLowerCase())||Q.entity.poNumber.toLowerCase().includes(r.searchText.toLowerCase())||Q.customer.displayName.toLowerCase().includes(r.searchText.toLowerCase())||Q.dueDate.toLowerCase().includes(r.searchText.toLowerCase())||Q.total.toLowerCase().includes(r.searchText.toLowerCase())||Q.balanceDue.toLowerCase().includes(r.searchText.toLowerCase())}):r.displayedInvoices}}]);'use strict',invoicesUnlimited.controller('InvoiceDetailController',['$q','$scope','$state','$sce','$controller','userFactory','invoiceService','creditNoteService','coreFactory','commentFactory','currencyFilter','$rootScope',function(o,r,l,u,y,h,g,C,T,D,I,N){function F(){scrollToOffset();var G=l.params.invoiceId;G&&(showLoader(),o.when(g.getInvoiceDetails(G)).then(function(W){var K=W.entity.get('userID');'General Employee'==h.entity[0].get('role')?h.entity[0].id==K.id&&(r.isOwner=!0):r.isOwner=!0,1==W.entity.get('customer').get('isDeleted')&&(r.isOwner=!1);var V=r.dateFormat.toUpperCase().replace(/E/g,'d');r.invoice=W,r.invoiceNo=W.entity.invoiceNumber,W.comments&&W.comments.forEach(function(X){X.date=formatDate(X.entity.date,V)}),r.comments=W.comments,r.invoiceInfo=W.entity.invoiceInfo,r.showPayLink=!1,0<W.entity.balanceDue&&(r.showPayLink=!0),W.payments?(W.payments.forEach(function(X){X.date=formatDate(X.entity.date,V),X.amount=I(X.entity.amount*B.exchangeRate,B.currencySymbol,2),X.mode='Credit Card'==X.entity.mode?'CC '+X.entity.lastFourDigits:X.entity.mode}),r.payments=W.payments):r.payments=[],W.attachments?(W.attachments.forEach(function(X){X.fileName=X.name(),X.fileName1=X.fileName.substring(X.fileName.indexOf('_')+1,X.fileName.length),X.fileUrl=X.url()}),r.attachments=W.attachments):r.attachments=[];var _=W.entity.invoiceReceipt,Y=W.entity.invoiceInfo;return Y&&(Y=Y.id),_&&W.entity.get('hasPdfReceipt')?(r.payLink='https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+Y,Promise.resolve(_)):Y?(r.payLink='https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+Y,g.createInvoiceReceipt(G,Y).then(function(X){return X.get('invoiceReceipt')})):g.copyInInvoiceInfo(W.entity).then(function(X){return Y=X.id,r.payLink='https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+Y,g.createInvoiceReceipt(G,Y).then(function(Z){return Z.get('invoiceReceipt')})})}).then(function(W){return r.templateUrl=u.trustAsResourceUrl(W.url()),$.ajax({type:'GET',url:'proxy.php',dataType:'html',data:{address:W.url()}}).then(function(K){var V=document.getElementById('targetframe');V.src='about:blank',V.contentWindow.document.open(),V.contentWindow.document.write(K),V.contentWindow.document.close(),hideLoader()})},function(W){hideLoader(),console.log(W.message)}))}function U(){var G=r.selectedPayment.entity.mode,W=r.selectedPayment.entity.deleted,K=r.invoiceInfo,V=K.get('paymentStatus');V=V.split(':'),V=V[V.length-1],V=V.replace(' ','');var _=q.get('AuthNet'),Y=q.get('AuthKey'),X=r.selectedPayment.entity.get('amount'),Z=r.selectedPayment.entity.get('lastFourDigits'),J=r.selectedPayment.entity.get('date'),Q=new Date,ee=Math.abs(Q-J)/3600000,te='';te=12>ee?'voidTransaction':'refundTransaction';var ae={HTML:'No',AuthNet:_,AuthKey:Y,TransID:V,CardNo:parseInt(Z),TranType:te,Amount:parseFloat(X)},ne=Object.assign({},ae,{});showLoader(),$.ajax({method:'POST',type:'POST',url:'refundAuth.php',data:ne,complete:function(ie){console.log('Reguest is done: '+ie)},error:function(ie){alert('ERROR: '+ie)},success:function(ie){var oe=ie.match(/[^,]+/g),re=ie.indexOf('Error');if(0>re){var le=r.selectedPayment.entity;le.set('deleted',!0);var de=r.invoiceInfo;de.set('paymentStatus',ie);var ce=r.invoice.entity;ce.unset('invoiceReceipt'),ce.increment('paymentMade',-le.amount),ce.increment('balanceDue',le.amount),0>=ce.get('paymentMade')?ce.set('status','Refunded'):ce.set('status','Partial Refunded');var me=[le.save(),ce.save(),de.save()],ue='Refund made for '+I(le.amount,'$',2)+' amount';me.push(E(ue,!0)),o.all(me).then(function(){$('.confirm-refund').removeClass('show'),$('.refund-payment').removeClass('show'),showSnackbar('Payment Refunded'),hideLoader(),setTimeout(function(){l.reload()},2e3)})}else $('.confirm-refund').removeClass('show'),$('.refund-payment').removeClass('show'),showSnackbar('Unable to refund payment. Contact Customer Support.'),hideLoader()}})}function P(){var G=r.selectedPayment.entity.mode,W=r.selectedPayment.entity.deleted,K=r.invoiceInfo,V=K.get('paymentStatus');V=V.split(','),V=V[V.length-1],V=V.replace(/\"/g,'');var _=q.get('EPNusername'),Y=q.get('EPNrestrictKey'),X=r.selectedPayment.entity.get('amount'),Z=r.selectedPayment.entity.get('date'),J=new Date,Q=Math.abs(J-Z)/3600000,ee='';ee=12>Q?'Void':'Return';var se={HTML:'No',ePNAccount:_,RestrictKey:Y,TransID:V,TranType:ee,Total:X},ae=Object.assign({},se,{});showLoader(),$.ajax({method:'GET',url:'refund.php',data:ae,complete:function(ne){console.log('Reguest is done: '+ne)},error:function(ne){alert('ERROR: '+ne)},success:function(ne){debugger;var ie=ne.match(/[^,]+/g);if(ie.length){var oe=r.selectedPayment.entity;oe.set('deleted',!0);var re=r.invoiceInfo;re.set('paymentStatus',ne);var le=r.invoice.entity;le.unset('invoiceReceipt'),le.increment('paymentMade',-oe.amount),le.increment('balanceDue',oe.amount),0>=le.get('paymentMade')?le.set('status','Refunded'):le.set('status','Partial Refunded');var de=[oe.save(),le.save(),re.save()],ce='Refund made for '+I(oe.amount,'$',2)+' amount';de.push(E(ce,!0)),o.all(de).then(function(){$('.confirm-refund').removeClass('show'),$('.refund-payment').removeClass('show'),showSnackbar('Payment Refunded'),hideLoader(),setTimeout(function(){l.reload()},2e3)})}else $('.confirm-refund').removeClass('show'),$('.refund-payment').removeClass('show'),showSnackbar('Unable to refund payment. Contact Customer Support.'),hideLoader()}})}function S(){showLoader();var G=r.selectedPayment.entity,W=G.get('creditNote');o.when(W.fetch()).then(function(){var V=W.get('creditsUsed'),_=W.get('remainingCredits');W.set('creditsUsed',V-G.amount),W.set('remainingCredits',_+G.amount),'Closed'==W.get('status')&&W.set('status','Open'),G.set('deleted',!0);var Y=r.invoice.entity;Y.unset('invoiceReceipt'),Y.increment('paymentMade',-G.amount),Y.increment('balanceDue',G.amount),0>=Y.get('paymentMade')?Y.set('status','Refunded'):Y.set('status','Partial Refunded');var X=[G.save(),W.save(),Y.save()],Z='Refund made for '+I(G.amount,'$',2)+' amount';X.push(E(Z,!0)),o.all(X).then(function(){$('.confirm-refund').removeClass('show'),$('.refund-payment').removeClass('show'),showSnackbar('Payment Refunded'),hideLoader(),setTimeout(function(){l.reload()},2e3)})})}function k(G){return 10>G&&(G='0'+G),G}function L(G){return'.'+G.split('.').pop()}function E(G,W){var K={userID:q,organization:O,name:q.get('username'),date:new Date,isAutomaticallyGenerated:W,comment:G};if(!q.get('isTrackUsage')&&W)return Promise.resolve('');var V={};return o.when(T.getUserRole(q)).then(function(_){return D.createNewComment(K,_)}).then(function(_){V.commentObj=_;var Y=r.invoice.entity,X=Y.get('comments');return X?X.push(_):X=[_],Y.set('comments',X),Y.save()}).then(function(_){var Y=new D(V.commentObj);return Y.date=formatDate(Y.entity.date,H),r.comments?r.comments.push(Y):r.comments=[Y],_})}function R(G,W){var K={userID:q,organization:O,name:q.get('username'),date:new Date,isAutomaticallyGenerated:W,comment:G};if(q.get('isTrackUsage')||!W){var V={};o.when(T.getUserRole(q)).then(function(_){return D.createNewComment(K,_)}).then(function(_){V.commentObj=_;var Y=r.invoice.entity,X=Y.get('comments');return X?X.push(_):X=[_],Y.set('comments',X),Y.save()}).then(function(_){var Y=new D(V.commentObj);return Y.date=formatDate(Y.entity.date,H),r.comments?r.comments.push(Y):r.comments=[Y],hideLoader(),l.reload(),_})}}function A(G){var W=$(G).find('itemRow'),K=$(G).find('modsRow'),V=$(G).find('attachment'),_=$(G).find('customField'),Y=$(G).find('tax'),X=$('<td></td>');$(G).find('billType').text().includes('estimate')&&($('.footer .info').hide(),$('.payment-due').hide()),/^[\s]*$/.test(W.first().find('discount').text())?$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$('#invoice-items-header').append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),W.each(function(){var te='<span>'+$(this).children('name').text()+'</span><br><span style=\'white-space: pre-wrap;word-wrap: break-word; color: #727272; font-size: 10pt;\'>'+$(this).children('desc').text()+'</span>';if(!/^[\s]*$/.test(W.first().find('discount').text())){var se=$('<tr class=\'invoice-items\'></tr>'),ae=$('<td class=\'ff1 fc0 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+te+'</td>'),ne=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('qty').text()+'</td>'),ie=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'1\'>'+$(this).children('discount').text()+'</td>'),oe=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');se.append(ae).append(ne).append(ie).append(oe),$('#invoice-items-header').after($(se))}else{var se=$('<tr class=\'invoice-items\'></tr>'),ae=$('<td class=\'ff1 fc0 invoice-item-title\' style=\'width: 50mm;\' colspan=\'2\'>'+te+'</td>'),ne=$('<td class=\'ff1 fc0  invoice-item-qty\' colspan=\'2\'>'+$(this).children('qty').text()+'</td>'),oe=$('<td class=\'ff1 fc0  invoice-item-cost\' colspan=\'2\'>'+$(this).children('price').text()+'</td>');se.append(ae).append(ne).append(oe),$('#invoice-items-header').after($(se))}}),Y.each(function(){var ee=$('<tr class=\'invoice-taxes\'></tr>'),te=$('<td colspan=\'3\' class=\'\'></td>'),se=$('<td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).children('name').text()+'</td>'),ae=$('<td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).children('value').text()+'</td>');ee.append(te).append(se).append(ae),$('#invoice-subtotal').after($(ee))});var Z=$('<tr class="salestax"></tr>');$('tr.adjustments').after(Z),_.each(function(){var ee=$('.customFields');ee.append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children('name').text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children('value').text()+'</p></div>'))}),V.each(function(){var ee=$(this).text();ee=ee.substring(ee.indexOf('_')+1,ee.length),ee=ee.replace(/%20/g,' '),$('.attach').append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+'\'>'+ee+'</a><br><br>')}),$('table tbody tr').each(function(){0==$(this).children().text().length&&$(this).addClass('hideOnMob')});var J=$(G).find('invoiceId').text();$('#pay-link').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+J),$('#pay-link-2').attr('href','https://app.invoicesunlimited.com/pay/?InvoiceInfoID='+J);var Q=$(G).find('items');console.log(Q),Q.each(function(){var ee=new Date(Date.parse($(this).find('past-due').text())),te=new Date(Date.now());ee=new Date(ee.setHours(0,0,0,0)),te=new Date(ee.setHours(0,0,0,0)),ee.getTime()>=te.getTime()||'Invalid Date'===ee.toString()?($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('green-status')):($('.payment-due p:last').append($(this).find('past-due').text()),$('.payment-due').addClass('red-status'));var se=$(this).find('headerTitle').text();$('.payment-due p:first').append(se);var ae=$(this).find('disablePay').text();'true'===ae&&($('.btn-border-pay').addClass('disable'),$('.info.cl').addClass('disable'),$('.payment-due').removeClass('red-status'),$('.payment-due').addClass('green-status'));var ie=$(this).find('discountAmount').text(),oe=$('<tr class="discount"></tr>');oe.append($('<td class="discountNm" colspan="3"></td>').html('Discount')),oe.append($('<td class="discountPr"></td>').html(ie)),'after'==$(this).find('discountPlace text').text()?$('.salestax:last').after(oe):'before'==$(this).find('discountPlace text').text()&&$('.salestax:first').before(oe);var re=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountNameBottom').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('discountAmount').text()+'</td></tr>');if('after'==$(this).find('discountPlace text').text()?$('.invoice-taxes:last').after($(re)):'before'==$(this).find('discountPlace text').text()&&$('#invoice-subtotal').after($(re)),0<$(this).find('adjustments').text().length){var re=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1\' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustments').text()+'</td><td class=\'ff1 fc1 \' style=\'padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('adjustmentsPrice').text()+'</td></tr>');$('#invoice-subtotal').after($(re))}0<$(this).find('shippingCharges').text().length&&(re=$('<tr class=\'invoice-adjustments\'><td colspan=\'3\' class=\'\'></td><td class=\'ff1 fc1 \' colspan=\'2\' style = \'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingCharges').text()+'</td><td class=\'ff1 fc1 \' style=\' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;\'>'+$(this).find('shippingChargesPrice').text()+'</td></tr>'),$('#invoice-subtotal').after($(re)));var se=$(this).find('headerTitle').text(),le=$(this).find('past-due').text();se?$('#pdf-title').text(se+'   '+le):($('#pdf-title').text(''),$('.top-bar').css('height','0mm'),$('.top-bar').css('border-bottom','0mm'));var de=$(this).find('ordernotes-title').text(),ce=$(this).find('ordernotes').text();ce?($('#pdf-terms-title').text(de),$('#pdf-terms').text(ce)):($('#pdf-terms-title').text(''),$('#pdf-terms').text(''),$('#pdf-terms-title').hide(),$('#pdf-terms').hide()),$('#pdf-business-name').text(h.entity[0].get('company')),$('#pdf-invoice-title').text($(this).find('invoice-title').text()),$('#pdf-invoice-number').text($(this).find('refid').text()),$('#pdf-amount-received').text($(this).find('body-price').text()),$('#pdf-date').text($(this).find('body-date').text()),$('#pdf-subtotal').text($(this).find('subtotalprice').text()),$('#pdf-payment-made').text($(this).find('paymentMadePrice').text()),$('#pdf-total').text($(this).find('total-price3').text()),$('#pdf-total-top').text($(this).find('total-price3').text()),$('#pdf-credit-applied').text($(this).find('creditsAppliedPrice').text()),$('#pdf-amount-due').text($(this).find('refundtotal').text()),$('#pdf-payment-name').text($(this).find('title').text()),$('#pdf-currency').text($(this).find('body-currency').text()),$('#pdf-total-text').text($(this).find('refundedText').text()),$('#pdf-payment-text').text($(this).find('paymentMadeText').text()),$('#pdf-credit-text').text($(this).find('creditsAppliedText').text());var me=$(this).find('addres1').text();$('#pdf-address').html(me);var ue=$(this).find('longmsg').text();if(0!=ue.length){var pe=$(this).find('longmsg-title').text();$('#pdf-notes-title').html(pe),$('#pdf-notes').html(ue)}else $('#pdf-notes-title').html(''),$('#pdf-notes').html(''),$('#pdf-notes-title').hide(),$('#pdf-notes').hide();var ye=$(this).find('mailto').text();$('#user-mail').attr('href',ye);var he=$(this).find('mailtotxt').text();$('#user-mail').text(he);var ge=$(this).find('clientmailto').text();$('#client-mail').attr('href',ge);var fe=$(this).find('clientmail').text();$('#client-mail').text(fe);var xe=$(this).find('clientname').text();$('#client-name').text(xe);var be=$(this).find('nr').text();$('#user-phone').attr('href','tel:'+be),$('#user-phone').text(be);var ve=$(this).find('refid').text();$('.visa-card').append(ve);var Ce=$(this).find('purchaseOrderNumber').text();$('.purchase-order').append(Ce);var Te=$(this).find('invoice-title').text();$('.invoice-details-1 h1').append(Te);var De=$(this).find('list-header-total').text();$('.list-header li:first-child span').append(De);var Ie=$(this).find('list-header-date').text();$('.list-header li:nth-child(2) span').append(Ie);var Ne=$(this).find('list-header-currency').text();$('.list-header li:nth-child(3) span').append(Ne);var we=$(this).find('body-price').text();$('.list-body li:first-child span').append(we);var Fe=$(this).find('body-date').text();$('.list-body li:nth-child(2) span').append(Fe);var Fe=$(this).find('body-currency').text();$('.list-body li:nth-child(3) span').append(Fe);var Ue=$(this).find('th1').text();$('.content.cl th.item').append(Ue);var Pe=$(this).find('addres1').text();$('.invoice-details-1 .info-2 p .adr').append(Pe);var Se=$(this).find('website-link').text();$('.invoice-details-1 .info-2 .website a').attr('href',Se);var ke=$(this).find('website-name').text();$('.invoice-details-1 .info-2 .website a span').append(ke);var ye=$(this).find('mailto').text();$('.invoice-details-1 .info-2 .mailto a').attr('href',ye);var he=$(this).find('mailtotxt').text();$('.invoice-details-1 .info-2 .mailto a span').append(he);var be=$(this).find('nr').text();$('.invoice-details-1 .info-2 .nr a').attr('href',be),$('.invoice-details-1 .info-2 .nr a span').append(be);var Le=$(this).find('thanksmsg').text();$('.invoice-details-2 .info-1 p:nth-child(1)').append(Le);var ue=$(this).find('longmsg').text();if(0!=ue.length){var pe=$(this).find('longmsg-title').text();$('.notes_para_head').html(pe),$('.notes_para').html(ue)}var Ee=$(this).find('to').text();$('.invoice-details-2 .info-2 p:first-child').append(Ee);var xe=$(this).find('clientname').text();$('.invoice-details-2 .info-2 .list-client li:first-child span').append(xe);var je=$(this).find('clientnr').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(2) a').attr('href',je),$('.invoice-details-2 .info-2 .list-client li:nth-child(2) a span').append(je);var ge=$(this).find('clientmailto').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(3) a').attr('href',ge);var fe=$(this).find('clientmail').text();$('.invoice-details-2 .info-2 .list-client li:nth-child(3) a span').append(fe);var de=$(this).find('ordernotes-title').text(),ce=$(this).find('ordernotes').text();$('.orderNotes').append(de),$('.orderNotesValues').append(ce);var Re=$(this).find('subtotal').text();$('td.subtotal').append(Re);var Ae=$(this).find('adjustments').text();$('td.adjustments').append(Ae);var Be=$(this).find('adjustmentsPrice').text();$('td.adjustments-price').append(Be);var Me=$(this).find('shippingCharges').text();$('td.shippingCharges').append(Me);var $e=$(this).find('shippingChargesPrice').text();$('td.shipping-charges-price').append($e);var qe=$(this).find('total-price').text(),Oe=$(this).find('salestax').text();$('.salestax').append(Oe);var ze=$(this).find('paymentMadeText').text(),He=$(this).find('paymentMadePrice').text();$('td.payment-made-text').append(ze),$('td.payment-made-price').append(He);var Ge=$(this).find('paymentRefundMadeText').text(),We=$(this).find('paymentRefundMadePrice').text();''==Ge?($('td.payment-refund-made-text').hide(),$('td.payment-refund-made-price').hide()):($('td.payment-refund-made-text').append(Ge),$('td.payment-refund-made-price').append(We));var Ke=$(this).find('creditsAppliedText').text(),Ve=$(this).find('creditsAppliedPrice').text();$('td.credits-applied-text').append(Ke),$('td.credits-applied-price').append(Ve);var _e=$(this).find('total-price2').text();$('.total-price2').append(_e);var Ye=$(this).find('total-price3').text();$('.total-price3').append(Ye);var Xe=$(this).find('totaltext').text();$('.totl').append(Xe);var Ze=$(this).find('refundtotal').text();$('td.refund-total').append(Ze);var Je=$(this).find('refundedText').text();$('.refund-price').append(Je);var Qe=$(this).find('total-price4').text();$('.total-price4').append(Qe);var et=$(this).find('saletax').text();$('.saletax').append(et);var tt=$(this).find('paymentmsg').text();$('.footer .info p:first-child').append(tt);var at=$(this).find('signup').text();$('.footer .info p span').append(at);var nt=$(this).find('copyright').text();$('.copyright p').append(nt);var it=$(this).find('title').text();$('head title').append(it);var ot=$(this).find('item4price').text();$('.price .item4price').append(ot);var rt=$(this).find('subtotalprice').text();$('.subtotal-price').append(rt);var lt=$(this).find('received-text').text();$('.received-text').append(lt);var dt=$(this).find('received-price').text();$('.received-price').append(dt);var ct=$(this).find('due-text').text();$('.due-text').append(ct);var mt=$(this).find('due-price');$('.due-price').append(mt);var ut=$(this).find('tip-text');$('.tip-text').append(ut);var pt=$(this).find('tip-price');$('.tip-price').append(pt)}),$.ajax({method:'POST',type:'POST',url:'generatePDF.php',data:{html:$('.pdf-page').html()}}).then(function(ee){if(r.isPrint){var te=window.open('data:application/pdf;base64,'+escape(ee));return te.print(),void l.reload()}var se=document.getElementById('pdfLink');se.href='data:application/octet-stream;base64,'+ee,se.click();debugger;l.reload()},function(ee){console.error(ee);debugger})}if(!h.entity.length)return console.log('User not logged in'),void 0;var B=h.entity[0].currency.attributes;if(B.exchangeRate)r.currentCurrency=B;else{var M={currencySymbol:'$',exchangeRate:1};r.currentCurrency=M,B=M}var q=h.entity[0],O=q.get('organizations')[0];y('DashboardController',{$scope:r,$state:l});var H;h.getField('dateFormat').then(function(G){r.dateFormat=G,H=r.dateFormat.toUpperCase().replace(/E/g,'d'),F()}),r.isOwner=!1,r.dateOptions={showWeeks:!1},r.changeTemplate=function(){showLoader(),o.when(T.getInvoiceTemplates()).then(function(G){var W=q.get('defaultTemplate'),K=[];G.forEach(function(V){var _={entity:V,name:V.get('name'),url:V.get('templatePreview').url()};_.isDefault=W||'Template 1'!=_.name?W.id==V.id:!0,K.push(_)}),r.templates=K,$('.change-template').addClass('show'),hideLoader()},function(G){console.log(G.message),hideLoader()})},r.setDefaultTemplate=function(G){showLoader(),r.templates.forEach(function(K){K.isDefault=!1}),r.templates[G].isDefault=!0,r.invoice.entity.unset('invoiceReceipt'),q.set('defaultTemplate',r.templates[G].entity);var W=[];W.push(q.save()),W.push(r.invoice.entity.save()),o.all(W).then(function(){hideLoader(),$('.change-template').removeClass('show'),console.log('default template selected'),l.reload()},function(K){hideLoader(),console.log(K,message)})},r.cloneInvoice=function(){o.when(E('Invoice cloned',!0)).then(function(){l.go('dashboard.sales.invoices.clone',{invoiceId:r.invoice.entity.id})})},r.editInvoice=function(){l.go('dashboard.sales.invoices.edit',{invoiceId:r.invoice.entity.id})},r.showAvailableCredits=function(){showLoader(),o.when(C.getCustomerCreditNotes(r.invoice.entity.get('customer'))).then(function(G){r.creditNotes=G;var W=0;G.forEach(function(_){W+=_.entity.remainingCredits}),r.totalCredit=W,r.balanceDue=r.invoice.entity.get('balanceDue'),r.totalCreditStr=I(W*B.exchangeRate,B.currencySymbol,2),r.balanceDueStr=I(r.balanceDue*B.exchangeRate,B.currencySymbol,2),r.creditUsed=r.balanceDue>W?W:r.balanceDue;var K=W-r.balanceDue;K=0<K?K:0,r.remainingCreditStr=I(K*B.exchangeRate,B.currencySymbol,2);var V=r.totalCredit>r.balanceDue?r.balanceDue:r.totalCredit;$('#applyCreditForm').validate({rules:{usedCredit:{required:!0,number:!0,min:0.01,max:V}}}),$('#applyCreditForm').validate().resetForm(),$('.apply-credit').addClass('show'),hideLoader()})},r.applyCredit=function(){if($('#applyCreditForm').valid()){showLoader(),r.creditNotes=r.creditNotes.sort(function(ae,ne){return ae.entity.remainingCredits-ne.entity.remainingCredits});for(var G=[],W=[],K=r.creditNotes,V=r.creditUsed,_=0;_<K.length&&!(0>=V);++_){var Y=K[_].entity.remainingCredits,X=K[_].entity.creditsUsed,Z=K[_].entity,J=0;Y<=V?(V-=Y,J=Y,Z.set('creditsUsed',X+Y),Z.set('remainingCredits',0),Z.set('status','Closed')):(Y-=V,J=V,Z.set('creditsUsed',X+V),Z.set('remainingCredits',Y),V=0),Z.unset('creditReceipt'),G.push(Z),W.push({userID:q,organization:O,creditNote:Z,date:new Date,mode:'Credit Note',amount:J,reference:Z.creditNumber})}V=r.creditUsed;var Q=r.invoice.entity,ee=Q.balanceDue-V;if(ee=1e-3>=ee?0:ee,!ee)Q.set('status','Paid');else{var ee=Q.get('dueDate'),te=new Date;ee.setHours(0,0,0,0),te.setHours(0,0,0,0),ee>te?Q.set('status','Partial Paid'):Q.set('status','Overdue')}Q.set('balanceDue',ee),Q.creditApplied?Q.set('creditApplied',Q.creditApplied+V):Q.set('creditApplied',V),Q.unset('invoiceReceipt');var se=[];se.push(Parse.Object.saveAll(G)),o.when(T.getUserRole(q)).then(function(ae){return g.addPayments(W,ae)}).then(function(ae){var ne=Q.get('payment');return ne=ne?ne.concat(ae):ae,Q.set('payment',ne),se.push(Q.save()),o.all(se)}).then(function(){var ae='Credit Note applied for '+I(r.creditUsed,'$',2)+' amount';R(ae,!0)})}},r.openDatePicker=function(G){1===G?r.openPicker1=!0:void 0},r.prepareAddPayment=function(){var G=r.invoice.entity.get('lateFee'),W=0;if(G){var K=G.get('price'),V=G.get('type');'$'==V?W=K:'%'==V&&(W=0.01*(subTotal*K))}debugger;r.paymentDate=new Date,r.paymentAmount=(r.invoice.entity.balanceDue+W).toFixed(2),r.paymentRef=''+Math.random().toString(10).substr(2,6),r.paymentModes=['Check','Cash','Bank Transfer','Bank Remittance'],r.selectedPaymentMode='Cash',$('#paymentForm').validate({rules:{paymentDate:'required',paymentAmount:{required:!0,number:!0,min:0.01,max:r.invoice.entity.balanceDue+W},paymentRef:'required',paymentMode:'required'},messages:{paymentDate:'Please select date',paymentAmount:{required:'Please enter payment amount',number:'Please enter valid amount',min:'Amount must be greater than 0',max:'Amount cannot be greater than balance due'},paymentRef:'Please enter reference number',paymentMode:'Please select payment mode'}}),$('#paymentForm').validate().resetForm()},r.addPayment=function(){if($('#paymentForm').valid()){showLoader();var G={userID:q,organization:O,date:r.paymentDate,mode:r.selectedPaymentMode,amount:+r.paymentAmount,reference:r.paymentRef,notes:r.paymentNotes},W=r.invoice.entity;W.unset('invoiceReceipt'),W.increment('paymentMade',G.amount),W.increment('balanceDue',-G.amount);var K=W.get('invoiceInfo');if(K.set('totalAmount',W.get('balanceDue')+''),K.save(),0>=W.balanceDue)W.set('status','Paid');else{var V=W.get('dueDate'),_=new Date;V.setHours(0,0,0,0),_.setHours(0,0,0,0),V>_?W.set('status','Partial Paid'):W.set('status','Overdue')}var Y=o.when(T.getUserRole(q));Y.then(function(X){return o.when(g.addPayments([G],X))}).then(function(X){var Z=W.get('payment');return Z=Z?Z.concat(X):X,W.set('payment',Z),W.save()}).then(function(){var X='Payment made for '+I(r.paymentAmount,'$',2)+' amount';E(X,!0).then(function(){hideLoader(),l.reload()})})}},r.showPaymentDetail=function(G){r.selectedPayment=r.payments[G];var W=r.selectedPayment.entity,K=W.mode,V=W.deleted;r.selectedPayment.disableRefund=!!V},r.refundPayment=function(){$('.confirm-refund').addClass('show')},r.doRefundPayment=function(){var G=r.selectedPayment.entity.mode,W=r.selectedPayment.entity.deleted;if(!W){if('Credit Card'==G){var K=r.invoiceInfo,V=K.get('paymentStatus');0<=V.indexOf('YAUTH')?P():U()}if('Credit Note'==G)return void S();if(!(W||'Cash'!=G&&'Check'!=G&&'Bank Transfer'!=G&&'Bank Remittance'!=G)){showLoader();var _=r.selectedPayment.entity;_.set('deleted',!0);var Y=r.invoice.entity;Y.unset('invoiceReceipt'),Y.increment('paymentMade',-_.amount),Y.increment('balanceDue',_.amount),0>=Y.get('paymentMade')?Y.set('status','Refunded'):Y.set('status','Partial Refunded');var X=[_.save(),Y.save()],Z='Refund made for '+I(_.amount,'$',2)+' amount';X.push(E(Z,!0)),o.all(X).then(function(){$('.confirm-refund').removeClass('show'),$('.refund-payment').removeClass('show'),showSnackbar('Payment Refunded'),hideLoader(),setTimeout(function(){l.reload()},2e3)})}}},r.addAttachment=function(G){var W=G.files[0];if(W){var K=W.name;if(!(K.toLowerCase().endsWith('.pdf')||K.toLowerCase().endsWith('.png')||K.toLowerCase().endsWith('.jpg')||K.toLowerCase().endsWith('.jpeg')))return void $('#file-error').show();$('#file-error').hide(),K='Attachment '+k(r.attachments.length+1)+L(K);var V=G.files[0].size;if(5242880<V)return void $('#file-size-error').show();$('#file-size-error').hide(),showLoader();var _=r.invoice.entity,Y=new Parse.File(K,W);o.when(Y.save()).then(function(X){var Z=_.get('invoiceFiles');return Z?Z.push(X):Z=[X],_.set('invoiceFiles',Z),_.unset('invoiceReceipt'),_.save()}).then(function(){E('File Attached',!0).then(function(){l.reload(),hideLoader()})})}},r.copyToClipboard=function(){var G=document.createElement('input');G.setAttribute('value',r.templateUrl),document.body.appendChild(G),G.select(),document.execCommand('copy'),document.body.removeChild(G),showSnackbar('Invoice link copied to your clipboard.')},r.textReceipt=function(){$('#text-error').hide();var G=r.invoice.entity.get('customer'),W=G.get('contactPersons');return r.mobileContacts=[],W.length&&W.forEach(function(K){var V=K.get('firstname')?K.get('firstname'):'',_=K.get('lastname')?K.get('lastname'):'',Y=1==K.get('defaultPerson'),X=V+' '+_;K.get('phone')&&r.mobileContacts.push({selected:!1,contact:K.get('phone'),contactName:'('+X+') '+K.get('phone')}),K.get('mobile')&&r.mobileContacts.push({selected:Y,contact:K.get('mobile'),contactName:'('+X+') '+K.get('mobile')})}),r.mobileContacts.length?void $('.text-popup').addClass('show'):void ShowMessage('Please Enter Mobile for Customer!','error')},r.sendText=function(){var G=0;if(r.mobileContacts.forEach(function(V){V.selected&&G++}),1>G)return void $('#text-error').show();if(showLoader(),'Draft'==r.invoice.entity.get('status')||'Sent'==r.invoice.entity.get('status')){var W=r.invoice.entity.get('dueDate'),K=new Date;W.setHours(0,0,0,0),K.setHours(0,0,0,0),W<K?r.invoice.entity.set('status','Overdue'):r.invoice.entity.set('status','Sent'),r.invoice.entity.save()}r.mobileContacts.forEach(function(V){V.selected&&g.sendInvoiceTextToNumber(r.invoice.entity,V.contact).then(function(){E('Invoice texted to '+V.contact,!0),$('.text-popup').removeClass('show'),hideLoader()})})},r.emailReceipt=function(){$('#email-error').hide();var G=r.invoice.entity.get('customer'),W=G.get('contactPersons');return r.contacts=[],W.length&&W.forEach(function(K){var V=K.get('firstname')?K.get('firstname'):'',_=K.get('lastname')?K.get('lastname'):'',Y=1==K.get('defaultPerson');K.get('email')&&r.contacts.push({selected:Y,contact:K.get('email'),contactName:'('+(V+' '+_)+') '+K.get('email')})}),r.contacts.length?void $('.email-popup').addClass('show'):void ShowMessage('Please Enter Email for Customer!','error')},r.sendEmail=function(){var G=0;if(r.contacts.forEach(function(V){V.selected&&G++}),1>G)return void $('#email-error').show();if($('.email-popup').removeClass('show'),'Draft'==r.invoice.entity.get('status')||'Sent'==r.invoice.entity.get('status')){var W=r.invoice.entity.get('dueDate'),K=new Date;W.setHours(0,0,0,0),K.setHours(0,0,0,0),W<K?r.invoice.entity.set('status','Overdue'):r.invoice.entity.set('status','Sent'),r.invoice.entity.save()}N.sendEmail(r.contacts,r.invoice.entity)},r.canDeleteInvoice=function(){r.invoice.entity.get('payment')?$('.cannot-delete').addClass('show'):$('.confirm-delete').addClass('show')},r.deleteInvoice=function(){if(r.invoice.entity.get('payment'))return void console.log('invoice cannot be deleted, it contains payments');showLoader();var G=r.invoice.entity,W=[],K;['comments','invoiceItems'].forEach(function(V){K=G.get(V),K&&(W=W.concat(K))}),['invoiceInfo','lateFee'].forEach(function(V){K=G.get(V),K&&W.push(K)}),Parse.Object.destroyAll(W).then(function(){return G.destroy()}).then(function(){hideLoader(),l.go('dashboard.sales.invoices.all')})},r.addComment=function(){if(!r.newComment)return void $('.add-comment').removeClass('show');showLoader();var G={userID:q,organization:O,name:q.get('username'),date:new Date,isAutomaticallyGenerated:!1,comment:r.newComment},W={};o.when(T.getUserRole(q)).then(function(K){return D.createNewComment(G,K)}).then(function(K){W.commentObj=K;var V=r.invoice.entity,_=V.get('comments');return _?_.push(K):_=[K],V.set('comments',_),V.save()}).then(function(){var K=new D(W.commentObj);K.date=formatDate(K.entity.date,H),r.comments?r.comments.push(K):r.comments=[K],console.log(K),$('.add-comment').removeClass('show'),hideLoader()})},r.invoicePrinted=function(){E('Invoice printed',!0),r.isPrint=!0;var G;if(r.invoice.entity.get('pdfReceipt')&&r.invoice.entity.get('hasPdfReceipt')&&(G=r.invoice.entity.get('pdfReceipt')._url),G)return void window.open(G);var W=r.invoice.entity.get('invoiceLabels')._url;debugger;var K=new XMLHttpRequest;K.open('GET',W,!1),K.setRequestHeader('Content-Type','text/xml'),K.send(null),A(K.responseXML)},r.downloadInvoice=function(){r.isPrint=!1;var G;if(r.invoice.entity.get('pdfReceipt')&&r.invoice.entity.get('hasPdfReceipt')&&(G=r.invoice.entity.get('pdfReceipt')._url),G){var W=document.getElementById('pdfLink'),K=G;return W.href=K,W.download='invoice.pdf',void W.click()}var V=r.invoice.entity.get('invoiceLabels')._url;debugger;var _=new XMLHttpRequest;_.open('GET',V,!1),_.setRequestHeader('Content-Type','text/xml'),_.send(null),A(_.responseXML)}}]);'use strict',invoicesUnlimited.controller('QuickInvoiceController',['$scope','$state','$controller','$q','userFactory','invoiceService','coreFactory','commentFactory','taxService','expenseService','lateFeeService','currencyFilter','itemService','salesCommon',function(o,r,l,u,y,h,g,C,T,D,I,N,F,U){function P(){$('.check-rate').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,min:0.01,number:!0,messages:{required:'Please enter an amount',min:'Please enter an amount',number:'Please enter a valid amount'}})})}function S(Z){var J=Z.entity;return J.name+' '+J.price+' ('+J.type+')'}function k(){showLoader();var Z=[],J=null;J=u.when(g.getAllCustomers()).then(function(Q){Q=Q.filter(function(ee){return'active'==ee.entity.status}),o.customers=Q.sort(function(ee,te){return alphabeticalSort(ee.entity.displayName,te.entity.displayName)}),o.customers.forEach(function(ee){ee.fullName=ee.entity.salutation?ee.entity.salutation+' '+ee.entity.displayName:ee.entity.displayName}),'Sales'!=Y.get('role')&&o.customers.push(createCustomerOpener)}),Z.push(J),J=u.when(g.getAllItems({organization:X})).then(function(Q){o.actualItems=Q.filter(function(ee){return!ee.entity.expanseId}),o.expenseItems=Q.filter(function(ee){return ee.entity.expanseId}),o.items=o.actualItems,o.items.push(createItemOpener)}),Z.push(J),J=u.when(h.getPreferences(Y)).then(function(Q){o.prefs=Q}),Z.push(J),J=u.when(g.getUserRole(Y)).then(function(Q){o.userRole=Q}),Z.push(J),J=T.getTaxes(Y,function(Q){o.taxes=Q,o.taxes.push(createTaxOpener)}),Z.push(J),J=I.getAllLateFees({organization:X}).then(function(Q){o.lateFeeList=Q.map(function(ee){return ee.toStr=S(ee),ee}),o.lateFeeList.push(createLateFeeOpener)}),Z.push(J),J=y.getField('dateFormat').then(function(Q){o.dateFormat=Q}),Z.push(J),u.all(Z).then(function(){L()},function(Q){hideLoader(),console.log(Q.message)})}function L(){switch(1==o.prefs.numAutoGen?(o.invoiceNo=o.prefs.invoiceNumber,o.disableInvNo=!0):(o.invoiceNo='',o.disableInvNo=!1),o.notes=o.prefs.notes,o.terms=o.prefs.terms,o.paymentTerms={terms:[{name:'Off',value:0},{name:'Due on Receipt',value:1},{name:'Net 7',value:7},{name:'Net 10',value:10},{name:'Net 30',value:30},{name:'Net 60',value:60},{name:'Net 90',value:90}],selectedTerm:{name:'Due on Receipt',value:1}},o.files=[],o.hasDueDate=!0,o.todayDate=new Date,o.calculateDueDate(),o.subTotalStr=N(0*V.exchangeRate,V.currencySymbol,2),o.prefs.discountType){case 0:o.itemLevelTax=!1,o.invoiceLevelTax=!1;break;case 1:o.itemLevelTax=!0,o.invoiceLevelTax=!1;break;case 2:case 3:o.itemLevelTax=!1,o.invoiceLevelTax=!0,o.discountStr=N(0*V.exchangeRate,V.currencySymbol,2);}o.prefs.shipCharges&&(o.showShippingCharges=!0,o.shippingChargesStr=N(0*V.exchangeRate,V.currencySymbol,2)),o.prefs.adjustments&&(o.showAdjustments=!0,o.adjustmentsStr=N(0*V.exchangeRate,V.currencySymbol,2)),o.prefs.salesPerson&&(o.showSalesPerson=!0);o.invoiceItems=[{selectedItem:{create:!0,entity:{rate:0,title:'Misc. Item'}},selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var J=r.params.customerId;J&&(o.selectedCustomer=o.customers.filter(function(Q){return Q.entity.id==J})[0],W()),hideLoader()}function E(){var Z={userID:Y,organization:X,customer:o.selectedCustomer.entity,invoiceDate:o.todayDate,invoiceNumber:o.invoiceNo,status:'Draft',discountType:o.prefs.discountType,discounts:o.discount,shippingCharges:o.shippingCharges,adjustments:o.adjustments,subTotal:+o.subTotal,total:+o.total,balanceDue:+o.total,poNumber:o.poNumber,salesPerson:o.salesPerson,notes:o.notes,terms:o.terms,paymentTerms:'Due on Receipt',dueDate:new Date},J=o.selectedCustomer.entity.email;if(J&&(Z.customerEmails=[J]),1==o.invoiceItems.length){var Q={create:!0,entity:{rate:o.invoiceItems[0].amount,title:'Misc. Item'}};o.invoiceItems[0].selectedItem=Q}else for(var ee=0,Q;ee<o.invoiceItems.length;ee++)Q={create:!0,entity:{rate:o.invoiceItems[ee].amount,title:'Misc. Item '+(ee+1)}},o.invoiceItems[ee].selectedItem=Q;return h.createNewInvoice(Z,o.invoiceItems,o.userRole,o.files).then(function(te){return h.copyInInvoiceInfo(te).then(function(se){return o.invoiceInfo=se,te})})}function R(){return E().then(function(Z){return h.createInvoiceReceipt(Z.id,o.invoiceInfo.id).then(function(J){return J.set('status','Sent'),J.save(),A(J),J})})}function A(Z){o.sendEmail(o.contacts,Z),o.sendText(o.mobileContacts,Z)}function B(){var Z=$('#addInvoiceForm').validate();Z.showErrors({invoiceNumber:'Invoice with this number already exists'})}function M(){P();var Z=$('#addInvoiceForm').valid(),J=$('#itemInfoForm').valid(),Q=$('#extrasForm').valid();if(Z&&J&&Q)return!0;var ee;Z?J?!Q&&(ee=$('#extrasForm').validate()):ee=$('#itemInfoForm').validate():ee=$('#addInvoiceForm').validate();var te=$(ee.errorList[0].element).offset().top-30;return scrollToOffset(te),!1}function q(Z,J,Q){var ee={userID:Y,organization:X,name:Y.get('username'),date:new Date,isAutomaticallyGenerated:J,comment:Z};if(Y.get('isTrackUsage')||!J){var te={};return u.when(g.getUserRole(Y)).then(function(se){return C.createNewComment(ee,se)}).then(function(se){te.commentObj=se;var ae=Q.get('comments');return ae?ae.push(se):ae=[se],Q.set('comments',ae),Q.save()}).then(function(se){return se})}}function O(){M()&&(showLoader(),u.when(h.checkInvoiceNumAvailable({invoiceNumber:o.invoiceNo,organization:X})).then(function(Z){return Z?R():(B(),scrollToOffset(),Promise.reject('Invoice with this number already exists'))}).then(function(Z){q('Invoice created for '+N(Z.attributes.balanceDue,'$',2)+' amount',!0,Z).then(function(){}),hideLoader(),r.go('dashboard.sales.invoices.details',{invoiceId:Z.id})},function(Z){hideLoader(),console.log(Z)}))}function H(){var Z=o.invoiceItems,J=0,Q=0;o.itemTaxes=[],Z.forEach(function(ee){J+=ee.amount*(0.01*(100-ee.discount)),ee.taxValue=calculateTax(ee.amount,ee.selectedTax),Q+=ee.taxValue}),o.totalTax=Q,o.subTotal=J,o.subTotalStr=N(J*V.exchangeRate,V.currencySymbol,2),o.reCalculateTotal()}function G(){o.items.pop();var Z=o.selectedCustomer.entity.get('paymentTerms');return Z?o.paymentTerms.terms.forEach(function(J){J.name==Z&&(o.paymentTerms.selectedTerm=J)}):o.paymentTerms.selectedTerm={name:'Due on Receipt',value:1},o.hasDueDate=!0,o.calculateDueDate(),u.when(D.getCustomerExpenses({organization:X,customer:o.selectedCustomer.entity})).then(function(J){for(var Q=[],ee=0;ee<J.length;++ee)if('Yes'==J[ee].entity.get('billable'))for(var te=0;te<o.expenseItems.length;++te)J[ee].entity.id==o.expenseItems[te].entity.expanseId&&Q.push(o.expenseItems[te]);for(var se=[],ee=0;ee<J.length;++ee)if('No'!=J[ee].entity.get('billable')){var ae=J[ee].entity,ne=Q.some(function(Fe){return ae.category==Fe.entity.title&&ae.amount==+Fe.entity.rate});ne||se.push({create:!0,tax:ae.tax,entity:{title:ae.category,rate:ae.amount+'',expanseId:ae.id}})}var ie=o.actualItems.concat(Q,se);return o.invoiceItems=o.invoiceItems.filter(function(oe){return!oe.selectedItem||oe.selectedItem.create?!1:ie.some(function(re){return re.entity.id==oe.selectedItem.entity.id})}),ie.push(createItemOpener),o.items=ie})}function W(){return o.selectedCustomer.dummy?void r.go('dashboard.customers.new',{backLink:r.current.name}):void(showLoader(),u.when(G()).then(function(){1>o.invoiceItems.length?(o.addInvoiceItem(),o.totalTax=0,o.subTotal=0,o.subTotalStr=N(0*V.exchangeRate,V.currencySymbol,2),o.reCalculateTotal()):H(),hideLoader()}))}function K(Z){if(Z=Z.split(',').join(''),-1!==Z.indexOf('.')){for(;/(\d+)(\d{3})/.test(Z.toString());)Z=Z.toString().replace(/(\d+)(\d{3})/,'$1,$2');var J=Z.length-Z.indexOf('.');3==J&&$('.add_item_price').attr('maxlength',Z.length)}else for($('.add_item_price').attr('maxlength',50);/(\d+)(\d{3})/.test(Z.toString());)Z=Z.toString().replace(/(\d+)(\d{3})/,'$1,$2');return Z}if(!y.entity.length)return console.log('User not logged in'),void 0;var V=y.entity[0].currency.attributes;if(V.exchangeRate)o.currentCurrency=V;else{var _={currencySymbol:'$',exchangeRate:1};o.currentCurrency=_,V=_}var Y=y.entity[0],X=Y.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),u.when(y.entity[0].currency.fetch()).then(function(Z){if(V=Z.attributes,V.exchangeRate)o.currentCurrency=V;else{var J={currencySymbol:'$',exchangeRate:1};o.currentCurrency=J,V=J}k()}),$('#addInvoiceForm').validate({onkeyup:function(Z){$(Z).valid()},rules:{customer:'required'},messages:{customer:'Please select a customer'}}),$('#itemInfoForm').validate(),o.save=function(){M()&&(showLoader(),u.when(h.checkInvoiceNumAvailable({invoiceNumber:o.invoiceNo,organization:X})).then(function(Z){return Z?E():(B(),scrollToOffset(),Promise.reject('Invoice with this number already exists'))}).then(function(Z){q('Invoice created for '+N(Z.attributes.balanceDue,'$',2)+' amount',!0,Z).then(function(J){hideLoader(),r.go('dashboard.sales.invoices.details',{invoiceId:J.id})})},function(Z){hideLoader(),console.log(Z)}))},o.saveAndSend=function(){if(M()){var Z=o.selectedCustomer.entity.get('contactPersons');o.contacts=[],o.mobileContacts=[],Z.length&&Z.forEach(function(J){var Q=J.get('firstname')?J.get('firstname'):'',ee=J.get('lastname')?J.get('lastname'):'',te=1==J.get('defaultPerson'),se=Q+' '+ee;J.get('email')&&o.contacts.push({selected:te,contact:J.get('email'),contactName:'('+se+') '+J.get('email')}),J.get('phone')&&o.mobileContacts.push({selected:!1,contact:J.get('phone'),contactName:'('+se+') '+J.get('phone')}),J.get('mobile')&&o.mobileContacts.push({selected:te,contact:J.get('mobile'),contactName:'('+se+') '+J.get('mobile')})}),o.contacts.length||o.mobileContacts.length?$('.email-text').addClass('show'):ShowMessage('The customer does not have a email or phone number in their profile. Please select save.','error')}},o.sendReceipt=function(){debugger;var Z=0,J=0;o.contacts.forEach(function(Q){Q.selected&&Z++}),o.mobileContacts.forEach(function(Q){Q.selected&&J++}),0<Z||0<J?O():$('#emailText-error').show()},o.cancel=function(){r.go('dashboard.sales.invoices.all')},o.calculateDueDate=function(){var Z=new Date(o.todayDate);Z.setHours(0),1!=o.paymentTerms.selectedTerm.value&&(Z=Z.addDays(o.paymentTerms.selectedTerm.value)),o.dueDate=Z},o.addInvoiceItem=function(){o.invoiceItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},o.reCalculateTotal=function(){var Z=+o.subTotal||0,J=+o.discount||0,Q=+o.shippingCharges||0,ee=+o.adjustments||0,te=+o.totalTax||0,se=Z+te,ae=0.01*(100-J);2==o.prefs.discountType?se=Z*ae+te:3==o.prefs.discountType&&(se=(Z+te)*ae),J=Math.abs(se-Z-te),o.total=se+Q+ee,o.discountStr=N(J*V.exchangeRate,V.currencySymbol,2),o.shippingChargesStr=N(Q*V.exchangeRate,V.currencySymbol,2),o.adjustmentsStr=N(ee*V.exchangeRate,V.currencySymbol,2),o.totalStr=N(o.total*V.exchangeRate,V.currencySymbol,2)},o.reCalculateSubTotal=H,o.reCalculateItemAmount=function(Z){var J=o.invoiceItems[Z];J.amount=J.rate*J.quantity,H()},o.removeInvoiceItem=function(Z){1<o.invoiceItems.length?(o.invoiceItems.splice(Z,1),H()):console.log('there should be atleast 1 item in an invoice')},o.itemChanged=function(Z){console.log('item changed');var J=o.invoiceItems[Z];if(J.selectedItem.dummy)return J.selectedItem=null,$('.new-item').addClass('show'),o.itemChangedIndex=Z,void o.prepareCreateItem();J.rate=+J.selectedItem.entity.rate;var Q=J.selectedItem.tax;if(!Q)J.selectedTax='';else for(var ee=o.taxes,te=0;te<ee.length;++te)if(Q.id==ee[te].id){J.selectedTax=ee[te];break}o.reCalculateItemAmount(Z)},o.customerChanged=W,o.prepareCreateItem=function(){U.prepareCreateItem({_scope:o})},o.createNewItem=function(){U.createNewItem({_scope:o,user:Y,organization:X})},$('.add_item_price').keyup(function(){$(this).val(K($(this).val()))})}]);'use strict',invoicesUnlimited.controller('AppPreferencesController',['$scope','$state','$controller','userFactory','businessFactory',function(o,r,l,u){var h=u;if(l('DashboardController',{$scope:o,$state:r}),h.entity[0].get('colorTheme')){var g=h.entity[0].get('colorTheme');g&&(g=g.replace(/app|Color/g,'').toLowerCase()),g&&$('.colors li a.'+g).parent().addClass('active')}if(!o.userLogo){var C=u.entity[0].get('selectedOrganization'),T=new Parse.Query('Organization');T.get(C.id,{success:function(D){o.org=D;var I=D.get('logo');o.userLogo=I?I._url:'./assets/images/user-icon.png',o.$$phase||o.$apply()},error:function(){}})}hideLoader(),fromTutorial?$('.tutorial').show():$('.tutorial').hide(),o.openingScreens=['Dashboard','Customer List','Invoices List','Expense List','Estimate List','Credit Notes List','Reports','Settings'],o.selectedScreen=h.entity[0].get('firstScreen'),h.entity[0].get('isTrackUsage')&&(o.trackUsage=!0),o.showConfirmationPopUp=function(){$('.confirmation-pop-up').addClass('show')},o.saveAppPreferences=function(){showLoader();var D=$('.colors li.active').find('a').attr('class'),I='app'+D[0].toUpperCase()+D.slice(1)+'Color';u.save({colorTheme:I,firstScreen:o.selectedScreen,isTrackUsage:o.trackUsage?1:0}).then(function(){hideLoader(),fromTutorial?r.go('dashboard.settings.taxes'):(showSnackbar('Save Successful. Reloading page in 3 sec...'),setTimeout(function(){window.location.reload()},2e3),hideLoader())})},o.nextClicked=function(){$('.tutorial').hide()}}]);'use strict',$(document).ready(function(){$.validator.addMethod('ConfirmPasswordMatch',function(o){return o==$('input[name=\'newPassword\']').val()},''),$.validator.addMethod('UserNameExists',function(){return!parseInt($('#username-exists').val())},'')}),invoicesUnlimited.controller('CompanyProfileController',['$scope','$state','$controller','userFactory','organizationFactory','businessFactory','$q',function(o,r,l,u,y,h,g){function C(U){return'.'+U.split('.').pop()}if(!u.entity.length)return console.log('User not logged in'),void 0;if($('#businessInfoForm').validate({onkeyup:function(U){$(U).valid()},onfocusout:!1,rules:{businessName:{required:!0},streetName:{required:!0},city:{required:!0},state:{required:!0},zipCode:{required:!0,minlength:5,digits:!0},country:{required:!0},phone:{required:!0}},messages:{businessName:{required:'Please enter business name'},streetName:{required:'Please enter street name'},city:{required:'Please enter city'},state:{required:'Please enter state'},zipCode:{required:'Please enter zip code',minlength:'Please enter valid zip code',digits:'Please enter valid zip code'},country:{required:'Please enter country'},phone:{required:'Please enter phone'}}}),$('#phoneForm').validate({onkeyup:function(U){$(U).valid()},onfocusout:!1,rules:{phoneNumber:{required:!0}},messages:{phoneNumber:{required:'Please enter Phone Number'}}}),$('.phone').mask('(999) 999-9999'),!o.userLogo){var D=u.entity[0].get('selectedOrganization'),I=new Parse.Query('Organization');I.get(D.id,{success:function(U){o.org=U;var P=U.get('logo');P?(o.userLogo=P._url,o.tempLogo=P._url):(o.userLogo='./assets/images/user-icon.png',o.tempLogo=void 0),o.$$phase||o.$apply()},error:function(){}})}else o.tempLogo=o.userLogo;var N=u.entity[0],F=N.get('organizations')[0];N?loadColorTheme(N):r.go('login'),l('DashboardController',{$scope:o,$state:r}),hideLoader(),N.get('EPNusername')&&N.get('EPNrestrictKey')&&N.get('merchantID')?o.enableBusinessInfo=!1:(o.enableBusinessInfo=!0,o.country=N.get('country')),o.removeLogo=function(){o.isDeleteLogo=!0,o.tempLogo=void 0,o.$apply()},o.saveAppPreferences=function(){var U=$('.colors li.active').find('a').attr('class'),P='app'+U[0].toUpperCase()+U.slice(1)+'Color';u.save({colorTheme:P}).then(function(){window.location.reload()})},o.addNewLogo=function(U){var P=U.files[0].name;if(!(P.endsWith('.png')||P.endsWith('.jpg')||P.endsWith('.jpeg')||P.endsWith('.PNG')||P.endsWith('.JPG')||P.endsWith('.JPEG')))return void ShowMessage('Invalid file format!','error');var S=new FileReader;S.onload=function(k){o.tempLogo=k.target.result,o.$apply()},S.readAsDataURL(U.files[0]),o.newLogo=U.files[0]},o.saveBusiness=function(){if(o.enableBusinessInfo){if(!$('#businessInfoForm').valid())return;}else if(!$('#phoneForm').valid())return;showLoader();var U=[];if(o.country&&(N.set('country',o.country),U.push(N.save())),U.push(o.businessInfo.save()),o.newLogo){var P=new Parse.File('logo'+C(o.newLogo.name),o.newLogo);U.push(P.save().then(function(S){o.org.set('logo',S),o.org.save().then(function(k){var L=k.get('logo');return o.userLogo=L._url,o.tempLogo=L._url,Promise.Resolve('')})}))}else o.isDeleteLogo&&(o.org.unset('logo'),U.push(o.org.save()));g.all(U).then(function(){hideLoader(),showSnackbar('Save Successful. Reloading page in 3 sec...'),setTimeout(function(){window.location.reload()},2e3)})}}]);'use strict',invoicesUnlimited.controller('CreditNoteSettingsController',['$q','$scope','$state','$controller','userFactory','creditNoteService',function(o,r,l,u,y,h){if(!y.entity.length)return console.log('User not logged in'),void 0;var C=y.entity[0];u('DashboardController',{$scope:r,$state:l}),function(){showLoader(),o.when(h.getPreferences(C)).then(function(T){r.prefs=T,console.log(T),r.creditAg=1==T.numAutoGen?'yes':'no',r.notes=T.notes,r.terms=T.terms;var D=T.creditNumber.split('-');r.prefix=D[0],r.nxtNumber=D[1],hideLoader()},function(T){hideLoader(),console.log(T.message)})}(),$('#settingsForm').validate({rules:{prefix:'required',nextNumber:{required:!0,digits:!0,min:1}}}),r.save=function(){if(!$('#settingsForm').valid()){var T=$('#settingsForm').validate(),D=$(T.errorList[0].element).offset().top-30;return void scrollToOffset(D)}showLoader();var I={creditAg:'yes'==r.creditAg?1:0,notes:r.notes,terms:r.terms};'yes'==r.creditAg&&(I.creditNumber=[r.prefix,r.nxtNumber].join('-')),o.when(h.setPreferences(C,I)).then(function(){showSnackbar('Save Successful. Reloading page in 3 sec...'),setTimeout(function(){l.reload()},2e3),hideLoader()},function(N){console.log(N.message),hideLoader()})}}]);'use strict',invoicesUnlimited.controller('CurrencyController',['$q','$scope','$state','$controller','userFactory','currencyFactory','coreFactory',function(o,r,l,u,y,h,g){function C(){o.when(h.loadAll({organization:I})).then(function(N){r.currencies=N,T(),hideLoader(),r.displayedCurrencies=N})}function T(){var N=D.get('currency');r.defaultCurrencyIndex=r.currencies.findIndex(function(F){return F.entity.id==N.id})}if(!y.entity.length)return console.log('User not logged in'),l.go('login'),void 0;var D,I;u('DashboardController',{$scope:r,$state:l}),o.when(y.entity[0].fetch()).then(function(N){D=N,I=D.get('organizations')[0],C()}),r.availableCurrencies=['ADP - Andorran Peseta','AED - United Arab Emirates Dirham','AFN - Afghan Afghani','ALL - Albanian Lek','AMD - Armenian Dram','ANG - Netherlands Antillean Guilder','AOA - Angolan Kwanza','ARA - Argentine Austral','ARS - Argentine Peso','ATS - Austrian Schilling','AUD - Australian Dollar','AWG - Aruban Florin','AZN - Azerbaijani Manat','BAM - Bosnia-Herzegovina Convertible Mark','BBD - Barbadian Dollar','BDT - Bangladeshi Taka','BEC - Belgian Franc (convertible)','BEF - Belgian Franc','BEL - Belgian Franc (financial)','BGL - Bulgarian Hard Lev','BGM - Bulgarian Socialist Lev','BGN - Bulgarian Lev','BHD - Bahraini Dinar','BIF - Burundian Franc','BMD - Bermudan Dollar','BND - Brunei Dollar','BOB - Bolivian Boliviano','BOP - Bolivian Peso','BOV - Bolivian Mvdol','BRL - Brazilian Real','BSD - Bahamian Dollar','BTN - Bhutanese Ngultrum','BUK - Burmese Kyat','BWP - Botswanan Pula','BYR - Belarusian Ruble','BZD - Belize Dollar','CAD - Canadian Dollar','CDF - Congolese Franc','CHE - WIR Euro','CHF - Swiss Franc','CHW - WIR Franc','CLE - Chilean Escudo','CLF - Chilean Unit of Account (UF)','CLP - Chilean Peso','CNX - Chinese People\u2019s Bank Dollar','CNY - Chinese Yuan','COP - Colombian Peso','COU - Colombian Real Value Unit','CRC - Costa Rican Col\xF3n','CSK - Czechoslovak Hard Koruna','CUC - Cuban Convertible Peso','CUP - Cuban Peso','CVE - Cape Verdean Escudo','CYP - Cypriot Pound','CZK - Czech Republic Koruna','DDM - East German Mark','DEM - German Mark','DJF - Djiboutian Franc','DKK - Danish Krone','DOP - Dominican Peso','DZD - Algerian Dinar','ECS - Ecuadorian Sucre','ECV - Ecuadorian Unit of Constant Value','EEK - Estonian Kroon','EGP - Egyptian Pound','ERN - Eritrean Nakfa','ESA - Spanish Peseta (A account)','ESB - Spanish Peseta (convertible account)','ESP - Spanish Peseta','ETB - Ethiopian Birr','EUR - Euro','FIM - Finnish Markka','FJD - Fijian Dollar','FKP - Falkland Islands Pound','FRF - French Franc','GBP - British Pound','GEK - Georgian Kupon Larit','GEL - Georgian Lari','GHS - Ghanaian Cedi','GIP - Gibraltar Pound','GMD - Gambian Dalasi','GNF - Guinean Franc','GNS - Guinean Syli','GQE - Equatorial Guinean Ekwele','GRD - Greek Drachma','GTQ - Guatemalan Quetzal','GWE - Portuguese Guinea Escudo','GWP - Guinea-Bissau Peso','GYD - Guyanaese Dollar','HKD - Hong Kong Dollar','HNL - Honduran Lempira','HRD - Croatian Dinar','HRK - Croatian Kuna','HTG - Haitian Gourde','HUF - Hungarian Forint','IDR - Indonesian Rupiah','IEP - Irish Pound','ILP - Israeli Pound','ILS - Israeli New Sheqel','INR - Indian Rupee','IQD - Iraqi Dinar','IRR - Iranian Rial','ISK - Icelandic Kr\xF3na','ITL - Italian Lira','JMD - Jamaican Dollar','JOD - Jordanian Dinar','JPY - Japanese Yen','KES - Kenyan Shilling','KGS - Kyrgystani Som','KHR - Cambodian Riel','KMF - Comorian Franc','KPW - North Korean Won','KRW - South Korean Won','KWD - Kuwaiti Dinar','KYD - Cayman Islands Dollar','KZT - Kazakhstani Tenge','LAK - Laotian Kip','LBP - Lebanese Pound','LKR - Sri Lankan Rupee','LRD - Liberian Dollar','LSL - Lesotho Loti','LTL - Lithuanian Litas','LTT - Lithuanian Talonas','LUC - Luxembourgian Convertible Franc','LUF - Luxembourgian Franc','LUL - Luxembourg Financial Franc','LVL - Latvian Lats','LVR - Latvian Ruble','LYD - Libyan Dinar','MAD - Moroccan Dirham','MAF - Moroccan Franc','MCF - Monegasque Franc','MDC - Moldovan Cupon','MDL - Moldovan Leu','MGA - Malagasy Ariary','MGF - Malagasy Franc','MKD - Macedonian Denar','MLF - Malian Franc','MMK - Myanmar Kyat','MNT - Mongolian Tugrik','MOP - Macanese Pataca','MRO - Mauritanian Ouguiya','MTL - Maltese Lira','MTP - Maltese Pound','MUR - Mauritian Rupee','MVR - Maldivian Rufiyaa','MWK - Malawian Kwacha','MXN - Mexican Peso','MXV - Mexican Investment Unit','MYR - Malaysian Ringgit','MZE - Mozambican Escudo','MZN - Mozambican Metical','NAD - Namibian Dollar','NGN - Nigerian Naira','NIO - Nicaraguan C\xF3rdoba','NLG - Dutch Guilder','NOK - Norwegian Krone','NPR - Nepalese Rupee','NZD - New Zealand Dollar','OMR - Omani Rial','PAB - Panamanian Balboa','PEI - Peruvian Inti','PEN - Peruvian Nuevo Sol','PGK - Papua New Guinean Kina','PHP - Philippine Peso','PKR - Pakistani Rupee','PLN - Polish Zloty','PTE - Portuguese Escudo','PYG - Paraguayan Guarani','QAR - Qatari Rial','RHD - Rhodesian Dollar','RON - Romanian Leu','RSD - Serbian Dinar','RUB - Russian Ruble','RWF - Rwandan Franc','SAR - Saudi Riyal','SBD - Solomon Islands Dollar','SCR - Seychellois Rupee','SDG - Sudanese Pound','SEK - Swedish Krona','SGD - Singapore Dollar','SHP - St. Helena Pound','SIT - Slovenian Tolar','SKK - Slovak Koruna','SLL - Sierra Leonean Leone','SOS - Somali Shilling','SRD - Surinamese Dollar','SRG - Surinamese Guilder','SSP - South Sudanese Pound','STD - S\xE3o Tom\xE9 & Pr\xEDncipe Dobra','SUR - Soviet Rouble','SVC - Salvadoran Col\xF3n','SYP - Syrian Pound','SZL - Swazi Lilangeni','THB - Thai Baht','TJR - Tajikistani Ruble','TJS - Tajikistani Somoni','TMT - Turkmenistani Manat','TND - Tunisian Dinar','TOP - Tongan Pa\u02BBanga','TPE - Timorese Escudo','TRY - Turkish Lira','TTD - Trinidad & Tobago Dollar','TWD - New Taiwan Dollar','TZS - Tanzanian Shilling','UAH - Ukrainian Hryvnia','UAK - Ukrainian Karbovanets','UGX - Ugandan Shilling','USD - US Dollar','USN - US Dollar (Next day)','USS - US Dollar (Same day)','UYI - Uruguayan Peso (Indexed Units)','UYU - Uruguayan Peso','UZS - Uzbekistani Som','VEF - Venezuelan Bol\xEDvar','VND - Vietnamese Dong','VUV - Vanuatu Vatu','WST - Samoan Tala','XAF - Central African CFA Franc','XAG - Silver','XAU - Gold','XBA - European Composite Unit','XBB - European Monetary Unit','XBC - European Unit of Account (XBC)','XBD - European Unit of Account (XBD)','XCD - East Caribbean Dollar','XDR - Special Drawing Rights','XEU - European Currency Unit','XFO - French Gold Franc','XFU - French UIC-Franc','XOF - West African CFA Franc','XPD - Palladium','XPF - CFP Franc','XPT - Platinum','XRE - RINET Funds','XSU - Sucre','XTS - Testing Currency Code','XUA - ADB Unit of Account','XXX - Unknown Currency','YDD - Yemeni Dinar','YER - Yemeni Rial','ZAL - South African Rand (financial)','ZAR - South African Rand','ZMW - Zambian Kwacha'],r.prepareAddCurrency=function(){r.currencyObj={title:void 0,currencySymbol:void 0,decimalPlace:'2',format:'###,###,###',exchangeRate:void 0},$('#addCurrencyForm').validate({rules:{currencyCode:'required',currencySymbol:'required',exchangeRate:{number:!0,min:0,required:!0}}}),$('#addCurrencyForm').validate().resetForm()},r.prepareEditCurrency=function(N){var F=r.currencies[N].entity;r.selectedIndex=N,r.currencyObj={title:F.title,currencySymbol:F.currencySymbol,decimalPlace:F.decimalPlace+'',format:F.format,exchangeRate:F.exchangeRate},$('.edit-currency').addClass('show'),$('#editCurrencyForm').validate({rules:{currencyCode:'required',currencySymbol:'required',exchangeRate:{number:!0,min:0}}}),$('#editCurrencyForm').validate().resetForm()},r.saveNewCurrency=function(){if($('#addCurrencyForm').valid()){showLoader();var N=r.currencyObj;N.userID=D,N.organization=I,N.decimalPlace=+N.decimalPlace,N.exchangeRate=+N.exchangeRate||void 0,o.when(g.getUserRole(D)).then(function(F){return h.createNewCurrency(N,F)}).then(function(F){r.currencies.push(F),$('.new-currency').removeClass('show'),hideLoader()})}},r.saveEditedCurrency=function(){if($('#editCurrencyForm').valid()){showLoader();var N=r.currencies[r.selectedIndex].entity,F=r.currencyObj;F.decimalPlace=+F.decimalPlace,F.exchangeRate=+F.exchangeRate||void 0,['title','currencySymbol','decimalPlace','format'].forEach(function(U){N.set(U,F[U])}),F.exchangeRate?N.set('exchangeRate',F.exchangeRate):N.unset('exchangeRate'),o.when(h.saveEditedCurrency(N)).then(function(U){r.currencies[r.selectedIndex]=U,$('.edit-currency').removeClass('show'),hideLoader()})}},r.setDefaultCurrency=function(){if(!r.currencies[r.selectedIndex].entity.exchangeRate)return void $('.add-exchangeRate').addClass('show');showLoader();var N=r.currencies[r.selectedIndex].entity;D.set('currency',N),o.when(D.save()).then(function(){T(),$('.edit-currency').removeClass('show'),hideLoader()})},r.deleteCurrency=function(){if(r.selectedIndex==r.defaultCurrencyIndex)return void $('.cannot-delete').addClass('show');showLoader();var N=r.currencies.splice(r.selectedIndex,1)[0];o.when(N.entity.destroy()).then(function(){T(),$('.edit-currency').removeClass('show'),hideLoader()})},r.deleteCurrencyClicked=function(N){return N==r.defaultCurrencyIndex?void $('.cannot-delete').addClass('show'):void(r.selectedIndex=N,$('.delete-currency').addClass('show'))},r.confirmDeleteCurrency=function(){if(r.selectedIndex==r.defaultCurrencyIndex)return void $('.cannot-delete').addClass('show');showLoader();var N=r.currencies.splice(r.selectedIndex,1)[0];o.when(N.entity.destroy()).then(function(){T(),$('.delete-currency').removeClass('show'),hideLoader()})},r.currencyChanged=function(){r.currencyObj&&(r.currencyObj.currencySymbol=r.currencyObj.title.split(' ')[0])},r.search=function(){r.currencies=r.searchText.length?r.displayedCurrencies.filter(function(N){return N.entity.title||(N.entity.title=''),N.entity.currencySymbol||(N.entity.currencySymbol=''),N.entity.exchangeRate||(N.entity.exchangeRate=''),N.entity.title.toLowerCase().includes(r.searchText.toLowerCase())||N.entity.currencySymbol.toLowerCase().includes(r.searchText.toLowerCase())||N.entity.exchangeRate.toString().toLowerCase().includes(r.searchText.toLowerCase())}):r.displayedCurrencies}}]);'use strict',invoicesUnlimited.controller('EstimateSettingsController',['$q','$scope','$state','$controller','userFactory','estimateService',function(o,r,l,u,y,h){function g(){$('.check-name').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please provide field name'}})})}if(!y.entity.length)return console.log('User not logged in'),void 0;var T=y.entity[0];u('DashboardController',{$scope:r,$state:l}),function(){showLoader(),o.when(h.getPreferences(T)).then(function(D){r.prefs=D,console.log(D),r.estimateAg=1==D.numAutoGen?'yes':'no',r.notes=D.notes,r.terms=D.terms;var I=D.estimateNumber.split('-');r.prefix=I[0],r.nxtNumber=I[1],r.customFields=D.customFields||[],r.customFields.forEach(function(N){N.checked=!('YES'!=N.isChecked)}),hideLoader()},function(D){hideLoader(),console.log(D.message)})}(),$('#settingsForm').validate({rules:{prefix:'required',nextNumber:{required:!0,digits:!0,min:1}}}),r.removeField=function(D){0<r.customFields.length&&r.customFields.splice(D,1)},r.addField=function(){r.customFields.push({name:'',isChecked:'',checked:!1})},r.save=function(){if(g(),!$('#settingsForm').valid()){var D=$('#settingsForm').validate(),I=$(D.errorList[0].element).offset().top-30;return void scrollToOffset(I)}showLoader();var N={estimateAg:'yes'==r.estimateAg?1:0,notes:r.notes,terms:r.terms};'yes'==r.estimateAg&&(N.estimateNumber=[r.prefix,r.nxtNumber].join('-'));var F=[];r.customFields.forEach(function(U){U.isChecked=U.checked?'YES':'NO',delete U.checked,F.push({isChecked:U.isChecked,name:U.name})}),N.customFields=F,o.when(h.setPreferences(T,N)).then(function(){showSnackbar('Save Successful. Reloading page in 3 sec...'),setTimeout(function(){l.reload()},2e3),hideLoader()},function(U){console.log(U.message),hideLoader()})}}]);'use strict',invoicesUnlimited.controller('InvoiceSettingsController',['$q','$scope','$state','$controller','userFactory','invoiceService','coreFactory','lateFeeService',function(o,r,l,u,y,h,g,C){function T(){$('.check-name').each(function(){$(this).rules('remove'),$(this).rules('add',{required:!0,messages:{required:'Please provide field name'}})})}function I(U){var P=U.entity;return P.name+' '+P.price+' ('+P.type+')'}if(!y.entity.length)return console.log('User not logged in'),void 0;var N=y.entity[0],F=N.get('organizations')[0];u('DashboardController',{$scope:r,$state:l}),function(){showLoader();var U=o.when(C.getAllLateFees({organization:F}));o.when(h.getPreferences(N)).then(function(P){r.prefs=P,r.invoiceAg=1==P.numAutoGen?'yes':'no',r.shipCharges=1==P.shipCharges?'yes':'no',r.adjustments=1==P.adjustments?'yes':'no',r.salesPerson=1==P.salesPerson?'yes':'no',r.itemDesc=1==P.itemDescOnInvoice?'yes':'no',r.invoiceNotification=1==N.get('getInvoiceNotification')?'yes':'no',r.notes=P.notes,r.terms=P.terms,r.showLateFee='no',r.invoiceThanksNotes=P.thanksNote,r.paymentConfirmation=0<P.thanksNote.length?'yes':'no';var S=P.invoiceNumber.split('-');switch(r.prefix=S[0],r.nxtNumber=S[1],r.customFields=P.customFields||[],r.customFields.forEach(function(k){k.checked='YES'==k.isChecked}),P.discountType){case 0:r.discounts='nodiscounts';break;case 1:r.discounts='atindividual';break;case 2:r.discounts='atinvoicelevel',r.discountPlace='before';break;case 3:r.discounts='atinvoicelevel',r.discountPlace='after';}return U}).then(function(P){r.lateFees=P,r.feeList=P.map(I),r.latefeeTypes=['%','$'],r.selectedFeeType='%',hideLoader()},function(P){hideLoader(),console.log(P.message)})}(),$('#settingsForm').validate({rules:{prefix:'required',nextNumber:{required:!0,digits:!0,min:1},discntplace:'required'}}),r.prepareAddFeeForm=function(){r.latefeeName='',r.selectedFeeType=r.latefeeTypes[0],r.latefeeAmount='',$('#addLateFeeForm').validate({rules:{name:'required',type:'required',amount:{required:!0,number:!0,min:0.01}}}),$('#addLateFeeForm').validate().resetForm()},r.addLateFee=function(){if($('#addLateFeeForm').valid()){showLoader();var U={userID:N,organization:F,name:r.latefeeName,type:r.selectedFeeType,price:+r.latefeeAmount};o.when(g.getUserRole(N)).then(function(P){return C.createLateFee(U,P)}).then(function(P){r.lateFees.push(P),r.feeList.push(I(P)),$('.add-latefee').removeClass('show'),hideLoader()})}},r.prepareEditFeeForm=function(){var U=r.lateFees[r.feeList.indexOf(r.selectedFee)];if(U){var U=U.entity;r.latefeeName=U.name,r.selectedFeeType=U.type,r.latefeeAmount=U.price,$('#editLateFeeForm').validate({rules:{name:'required',type:'required',amount:{required:!0,number:!0,min:0.01}}}),$('#editLateFeeForm').validate().resetForm()}},r.updateLateFee=function(){var U=r.feeList.indexOf(r.selectedFee),P=r.lateFees[U];P&&$('#editLateFeeForm').valid()&&(showLoader(),P=P.entity,P.set('name',r.latefeeName),P.set('type',r.selectedFeeType),P.set('price',+r.latefeeAmount),o.when(C.updateLateFee(P)).then(function(S){r.lateFees[U]=S,r.feeList[U]=I(S),r.selectedFee=r.feeList[U],$('.edit-latefee').removeClass('show'),hideLoader()}))},r.removeField=function(U){0<r.customFields.length&&r.customFields.splice(U,1)},r.addField=function(){r.customFields.push({name:'',isChecked:'',checked:!1})},r.save=function(){if(T(),!$('#settingsForm').valid()){var U=$('#settingsForm').validate(),P=$(U.errorList[0].element).offset().top-30;return void scrollToOffset(P)}showLoader();var S={invoiceAg:'yes'==r.invoiceAg?1:0,shipCharges:'yes'==r.shipCharges?1:0,adjustments:'yes'==r.adjustments?1:0,salesPerson:'yes'==r.salesPerson?1:0,itemDescOnInvoice:'yes'==r.itemDesc?1:0,notes:r.notes,terms:r.terms,thanksNote:'yes'==r.paymentConfirmation?r.invoiceThanksNotes:''};'yes'==r.invoiceAg&&(S.invoiceNumber=[r.prefix,r.nxtNumber].join('-'));var k=[];switch(r.customFields.forEach(function(L){L.isChecked=L.checked?'YES':'NO',delete L.checked,k.push({isChecked:L.isChecked,name:L.name})}),S.customFields=k,r.discounts){case'nodiscounts':S.discountType=0;break;case'atindividual':S.discountType=1;break;case'atinvoicelevel':S.discountType='before'==r.discountPlace?2:3;}N.set('getInvoiceNotification','yes'==r.invoiceNotification?1:0),N.save(),o.when(h.setPreferences(N,S)).then(function(){console.log('invoice prefs updated.'),showSnackbar('Save Successful. Reloading page in 3 sec...'),setTimeout(function(){l.reload()},2e3),hideLoader()},function(L){console.log(L.message),hideLoader()})}}]);'use strict',invoicesUnlimited.controller('ItemController',['$scope','$state','$controller','$q','userFactory','coreFactory','taxService','itemService',function(o,r,l,u,y,h,g,C){function T(k){if(k=k.split(',').join(''),-1!==k.indexOf('.')){for(;/(\d+)(\d{2})/.test(k.toString());)k=k.toString().replace(/(\d+)(\d{2})/,'$1,$2');var L=k.length-k.indexOf('.');3==L&&$('.add_item_price').attr('maxlength',k.length)}else for($('.add_item_price').attr('maxlength',50);/(\d+)(\d{2})/.test(k.toString());)k=k.toString().replace(/(\d+)(\d{2})/,'$1,$2');return k}function D(k){if(-1!=k.indexOf('.')){var L=k.length-k.indexOf('.');return 3==L&&$('.add_item_price').attr('maxlength',k.length),k}if(k=k.split(',').join(''),4<k.length){$('.add_item_price').attr('maxlength',50);var E=k.substring(k.length-4,k.length),R=k.substring(0,k.length-4);return I(R)+','+E}return k}function I(k){for(k=k.split(',').join('');/(\d+)(\d{3})/.test(k.toString());)k=k.toString().replace(/(\d+)(\d{3})/,'$1,$2');return k}function N(k){if(k=k.split(',').join(''),-1!==k.indexOf('.')){for(;/(\d+)(\d{3})/.test(k.toString());)k=k.toString().replace(/(\d+)(\d{3})/,'$1,$2');var L=k.length-k.indexOf('.');3==L&&$('.add_item_price').attr('maxlength',k.length)}else for($('.add_item_price').attr('maxlength',50);/(\d+)(\d{3})/.test(k.toString());)k=k.toString().replace(/(\d+)(\d{3})/,'$1,$2');return k}function U(){o.itemName='',o.itemRate1='',o.itemDesc='',o.itemTax=void 0}if(!y.entity.length)return console.log('User not logged in'),void 0;var P=y.entity[0];o.currency=P.get('currency'),o.currencyFormat=o.currency.get('format');var S=P.get('organizations')[0];l('DashboardController',{$scope:o,$state:r}),initalizeModalClasses(),function(){showLoader();var k,L=[];k=u.when(h.getAllItems({organization:S})).then(function(R){o.items=R.filter(function(A){return!A.entity.expanseId&&0>A.entity.title.indexOf('Misc. Item')}),o.displayedItems=o.items}),L.push(k),k=g.getTaxes(P,function(R){o.taxes=R}),L.push(k),u.all(L).then(function(){hideLoader(),o.sortByItemName()},function(R){console.log(R.message),hideLoader()})}(),$.validator.addMethod('CheckNumber',function(k){return!(2<k.split('.').length)}),$('#addItemForm').validate({rules:{name:'required',rate:{required:!0,CheckNumber:!0}},messages:{name:'Please enter Item name',rate:{required:'Item rate is required',CheckNumber:'Please enter a valid price.'}}}),$('#editItemForm').validate({rules:{name:'required',rate:{required:!0,CheckNumber:!0}},messages:{name:'Please enter Item name',rate:{required:'Item rate is required',CheckNumber:'Please enter a valid price.'}}}),$('.add_item_price').keyup(function(){'#,###,####'==o.currencyFormat?$(this).val(D($(this).val())):'##,##,##,##'==o.currencyFormat?$(this).val(T($(this).val())):$(this).val(N($(this).val()))}),o.sortByItemName=function(){'none'===$('#name').css('display')?(o.items.sort(function(k,L){return k.entity.title.localeCompare(L.entity.title)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.items.sort(function(k,L){return L.entity.title.localeCompare(k.entity.title)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#price').css({display:'none'}),$('#description').css({display:'none'}),$('#priceUp').css({display:'none'}),$('#descriptionUp').css({display:'none'})},o.sortByPrice=function(){'none'===$('#price').css('display')?(o.items.sort(function(k,L){return L.entity.rate-k.entity.rate}),$('#price').css({display:'inline-table'}),$('#priceUp').css({display:'none'})):(o.items.sort(function(k,L){return k.entity.rate-L.entity.rate}),$('#priceUp').css({display:'inline-table'}),$('#price').css({display:'none'})),$('#name').css({display:'none'}),$('#description').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#descriptionUp').css({display:'none'})},o.sortByDescription=function(){'none'===$('#description').css('display')?(o.items.sort(function(k,L){return k.entity.itemDescription.localeCompare(L.entity.itemDescription)}),$('#description').css({display:'inline-table'}),$('#descriptionUp').css({display:'none'})):(o.items.sort(function(k,L){return L.entity.itemDescription.localeCompare(k.entity.itemDescription)}),$('#descriptionUp').css({display:'inline-table'}),$('#description').css({display:'none'})),$('#name').css({display:'none'}),$('#price').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#priceUp').css({display:'none'})},o.clearAddItemFields=function(){U(),$('#addItemForm').validate().resetForm()},o.showItemDetail=function(k){$('#editItemForm').validate().resetForm(),$('.edit-item').addClass('show');var L=o.items[k];if(o.confirmItem=L,o.itemIndex=k,o.itemName=L.entity.title,o.itemRate1=L.entity.rate,o.itemDesc=L.entity.itemDescription,o.itemTax=void 0,L.tax)for(var E=o.taxes,R=0;R<E.length;++R)if(L.tax.id==E[R].id){o.itemTax=E[R];break}},o.confirmDelete=function(k){var L=o.items[k];L&&(o.itemIndex=k,o.confirmItem=L,$('.confirm-delete').addClass('show'))},o.deleteIteminModal=function(){$('.confirm-delete').addClass('show')},o.deleteItem=function(k){k?(showLoader(),o.items[o.itemIndex].entity.set('isDeleted',1),o.items[o.itemIndex].entity.save().then(function(){$('.confirm-delete').removeClass('show'),hideLoader(),r.reload()})):$('.confirm-delete').removeClass('show')},o.saveNewItem=function(){if($('#addItemForm').valid()){showLoader();var k={user:P,organization:S,items:[{title:o.itemName,rate:o.itemRate1.split(',').join(''),tax:o.itemTax,desc:o.itemDesc}]};u.when(h.getUserRole(P)).then(function(){var E=new Parse.ACL;return E.setPublicReadAccess(!0),E.setPublicWriteAccess(!0),k.acl=E,C.createItems(k)}).then(function(L){hideLoader(),fromTutorial?r.go('dashboard.customers.new'):(o.items.push(L[0]),$('.new-item').removeClass('show'))},function(L){$('.new-item').removeClass('show'),hideLoader(),console.log(L.message)})}},o.saveEditedItem=function(){if($('#editItemForm').valid()){var k=o.items[o.itemIndex];k&&(showLoader(),k=k.entity,k.set('title',o.itemName),k.set('rate',o.itemRate1.split(',').join('')),k.set('itemDescription',o.itemDesc),o.itemTax?k.set('tax',Parse.Object.extend('Tax').createWithoutData(o.itemTax.id)):k.unset('tax'),k.save().then(function(){r.reload()},function(L){$('.edit-item').removeClass('show'),hideLoader(),console.log(L.message)}))}},o.nextClicked=function(){$('.tutorial').hide()},o.closeAddItem=function(){$('.new-item').removeClass('show')},fromTutorial?($('.tutorial').show(),U(),$('#addItemForm').validate().resetForm(),$('.new-item').addClass('show')):$('.tutorial').hide(),o.search=function(){o.items=o.searchText.length?o.displayedItems.filter(function(k){return k.entity.title||(k.entity.title=''),k.entity.rate||(k.entity.rate=''),k.entity.itemDescription||(k.entity.itemDescription=''),k.entity.title.toLowerCase().includes(o.searchText.toLowerCase())||k.entity.rate.toLowerCase().includes(o.searchText.toLowerCase())||k.entity.itemDescription.toLowerCase().includes(o.searchText.toLowerCase())}):o.displayedItems}}]);'use strict',invoicesUnlimited.controller('PaymentsController',['$rootScope','$scope','$state','$controller','$q','userFactory','signUpFactory',function(o,r,l,u,y,h,g){if(!h.entity.length)return console.log('User not logged in'),void 0;var C=h.entity[0],T=C.get('organizations')[0];if(u('DashboardController',{$scope:r,$state:l}),g.setDefaultValues(),!r.userLogo){var D=h.entity[0].get('selectedOrganization'),I=new Parse.Query('Organization');I.get(D.id,{success:function(B){r.org=B;var M=B.get('logo');r.userLogo=M?M._url:'./assets/images/user-icon.png',r.$$phase||r.$apply()},error:function(){}})}var U='You have been approved to process credit cards.',P=C.get('businessInfo'),S=C.get('principalInfo'),k=C.get('accountInfo'),L=C.get('signatureImage'),E=C.get('merchantID'),R=C.get('EPNusername'),A=C.get('EPNrestrictKey');E?(r.approved=!0,r.infoMsg=U,r.merchantID=E,r.businessName=C.get('company'),r.accountSupportNumber='(800) 554-4777',r.softwareSupportNumber='(888) 995-1840',r.email='support@invoicesunlimited.com'):P&&S&&k&&L?E?(r.approved=!0,r.infoMsg=U,r.merchantID=E,r.businessName=C.get('company'),r.accountSupportNumber='(800) 554-4777',r.softwareSupportNumber='(888) 995-1840',r.email='support@invoicesunlimited.com'):(r.processingRequest=!0,r.infoMsg='Your application has been submitted. Please wait two business days for the approval process. <br/>If you have not heard anything from us within two business days, please call or email us at:',r.phoneNumber='(800) 554-4777',r.email='support@invoicesunlimited.com'):(r.incompleteProfile=!0,r.infoMsg='You have not completed the merchant account application. Please click continue below to resume where you left off.'),hideLoader(),r.sendEmail=function(){window.open('mailto:support@invoicesunlimited.com','_self')},r.continueProcess=function(){o.fromPaymentSettings=!0,P?S?k?!L&&l.go('signup.signature'):l.go('signup.account-info'):l.go('signup.business-info'):l.go('signup.business-info')}}]);'use strict',String.prototype.capitilize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},invoicesUnlimited.controller('SettingsController',['$q','$scope','$state','$controller','userFactory','coreFactory',function(o,r,l,u,y,h){function C(){console.log('xyzz'),r.users=[{name:N.get('username'),email:N.get('email'),role:N.get('role'),status:'Active',textClass:'text-positive'}],hideLoader()}function T(E){for(var R=[['dd','mm','yy'],['mm','dd','yy'],['yy','mm','dd'],['dd','mm','yyyy'],['mm','dd','yyyy'],['yyyy','mm','dd']],A=['dd mmm yyyy','eee, mmmm dd, yyyy','eeee, mmmm dd, yyyy','mmm dd, yyyy','mmmm dd, yyyy','yyyy mm dd'],B=[],M=0;M<R.length;++M)B.push({format:R[M].join(E),formatExample:R[M].join(E)+' ('+k[M].join(E)+')'});for(var M=0;M<A.length;++M)B.push({format:A[M],formatExample:A[M]+' ('+L[M]+')'});return B}function D(){showLoader(),r.timeZones={timeZones:['( PDT ) America/Los_Angeles ( Pacific Standard Time )','( GMT 5:00 ) Asia/Karachi ( Pakistan Standard Time )','( GMT 0:00 ) Dublin, Edinburgh, Lisbon, London ( Greenwich Mean Time )','( GMT -4:00 ) Canada ( Atlantic Standard Time )','( GMT -4:00 ) Santiago ( Pacific SA Standard Time )','( GMT -5:00 ) US & Canada ( Eastern Standard Time )','( GMT -5:00 ) Indiana (East) ( US Eastern Standard Time )','( GMT -6:00 ) ( Central America Standard Time )','( GMT -6:00 ) US & Canada ( Central Standard Time )','( GMT -7:00 ) US & Canada ( Mountain Standard Time )','( GMT -8:00 ) US & Canada ( Pacific Standard Time )','( GMT -9:00 ) ( Alaskan Standard Time )','( GMT -10:00 ) ( Hawaiian Standard Time )'],selectedTimeZone:''},r.months={months:['January','February','March','April','May','June','July','August','September','October','November','December'],selectedMonth:''},r.dateFormats={formats:[],selectedFormat:''},r.fieldSeparators={separators:['/','.',',','-'],selectedSeparator:''},o.when(h.getGeneralPrefs(N)).then(function(E){var R=E.get('timeZone'),A=E.get('fiscalYearStart'),B=E.get('dateFormat').toLowerCase(),M=E.get('fieldSeparator'),q=E.get('displayCountry');r.displayCountry=q?'yes':'no',r.timeZones.selectedTimeZone=r.timeZones.timeZones.filter(function(O){return O==R})[0],r.months.selectedMonth=r.months.months.filter(function(O){return O==A})[0],r.fieldSeparators.selectedSeparator=r.fieldSeparators.separators.filter(function(O){return O==M})[0],r.dateFormats.formats=T(r.fieldSeparators.selectedSeparator),r.dateFormats.selectedFormat=r.dateFormats.formats.filter(function(O){return O.format==B})[0],hideLoader()},function(E){hideLoader(),console.log(E.message)})}function I(){showLoader(),o.when(h.getInvoiceTemplates()).then(function(E){var R=N.get('defaultTemplate'),A=[];E.forEach(function(B){var M={entity:B,name:B.get('name'),url:B.get('templatePreview').url()};M.btnName='Set as Default',R||'Template 1'!=M.name?R&&(M.isDefault=R.id==B.id,M.btnName=M.isDefault?'Default':'Set as Default'):M.isDefault=!0,A.push(M)}),r.templates=A,hideLoader()},function(E){hideLoader(),console.log(E.message)})}if(!y.entity.length)return console.log('User not logged in'),l.go('login'),void 0;var N=y.entity[0],F=N.get('organizations')[0];if(u('DashboardController',{$scope:r,$state:l}),!r.userLogo){var U=y.entity[0].get('selectedOrganization'),P=new Parse.Query('Organization');P.get(U.id,{success:function(E){r.org=E;var R=E.get('logo');r.userLogo=R?R._url:'./assets/images/user-icon.png',r.$$phase||r.$apply()},error:function(){}})}var S={users:function(E){return E.endsWith('users')},general:function(E){return E.endsWith('general-preferences')},payments:function(E){return E.endsWith('payments')},templates:function(E){return E.endsWith('invoice-templates')}};(function(E){E||(E=l.current.name),S.users(E)?C():S.templates(E)?I():S.general(E)?D():hideLoader()})();var k=[['23','10','16'],['10','23','16'],['16','10','23'],['23','10','2016'],['10','23','2016'],['2016','10','23']],L=['10 Oct 2016','Mon, October 23, 2016','Monday, October 23, 2016','Oct 23, 2016','October 23, 2016','2016 10 23'];r.dateSeperatorChanged=function(){var E=r.dateFormats.formats.indexOf(r.dateFormats.selectedFormat);r.dateFormats.formats=T(r.fieldSeparators.selectedSeparator),r.dateFormats.selectedFormat=r.dateFormats.formats[E]},r.setDefaultPrefs=function(){showLoader();var E=r.dateFormats.selectedFormat.format.split('m').join('M');E=E.split('e').join('E'),F.set('timeZone',r.timeZones.selectedTimeZone),F.set('fiscalYearStart',r.months.selectedMonth),F.set('dateFormat',E),F.set('fieldSeparator',r.fieldSeparators.selectedSeparator),F.set('displayCountry','yes'==r.displayCountry),F.save().then(function(){y.commonData={},hideLoader(),showSnackbar('Save Successful'),console.log('general preferences are saved.')},function(R){hideLoader(),console.log(R.message)})},r.setDefaultTemplate=function(E){showLoader(),r.templates.forEach(function(R){R.isDefault=!1,R.btnName='Set as Default'}),r.templates[E].isDefault=!0,r.templates[E].btnName='Default',N.set('defaultTemplate',r.templates[E].entity),N.save().then(function(){hideLoader(),showSnackbar('Save Successful')},function(R){hideLoader(),console.log(R,message)})}}]);var digitsOnly=/[1234567890]/g,integerOnly=/[0-9\.]/g,alphaOnly=/[A-Za-z]/g,usernameOnly=/[0-9A-Za-z\._-]/g;invoicesUnlimited.controller('TaxController',['$scope','$state','$controller','userFactory','taxService',function(o,r,l,u,y){function h(){o.taxId=0,o.taxName='',o.taxRate='',o.isCompound=!1}function g(){y.getTaxes(D,function(I){o.taxes=I,o.displayedTaxes=o.taxes,o.sortByTaxName()})}function C(){o.taxGroupId=0,o.taxGroupName='',o.taxesForGroup=[],o.shouldAdd=[],o.taxes.forEach(function(I){2!=I.type&&(o.taxesForGroup.push(I),o.shouldAdd.push(!1))})}function T(I){o.taxGroupId=I.id,o.taxGroupName=I.entity.get('title'),o.taxesForGroup=[],o.shouldAdd=[],o.taxes.forEach(function(P){2!=P.type&&(o.taxesForGroup.push(P),o.shouldAdd.push(!1))});for(var N=I.entity.get('associatedTaxes'),F=0;F<N.length;++F)for(var U=0;U<o.taxesForGroup.length;++U)N[F].id==o.taxesForGroup[U].id&&(o.shouldAdd[U]=!0)}if(!u.entity.length)return console.log('User not logged in'),void 0;fromTutorial?($('.tutorial').show(),h(),$('#addTaxForm').validate().resetForm(),$('.new-tax').addClass('show')):$('.tutorial').hide();var D=u.entity[0];l('DashboardController',{$scope:o,$state:r}),g(),initalizeModalClasses(),h(),$('#addTaxForm').validate({rules:{name:'required',rate:{required:!0,number:!0}},messages:{name:'Please enter Tax name',rate:{required:'Tax percentage is required.',number:'Please enter a valid percentage.'}}}),$('#addTaxGroupForm').validate({rules:{name:'required'},messages:{name:'Please enter Tax Group name'}}),$('#editTaxGroupForm').validate({rules:{name:'required'},messages:{name:'Please enter Tax Group name'}}),$('#editTaxForm').validate({rules:{name:'required',rate:{required:!0,number:!0}},messages:{name:'Please enter Tax name',rate:{required:'Tax percentage is required.',number:'Please enter a valid percentage.'}}}),o.sortByTaxName=function(){'none'===$('#name').css('display')?(o.taxes.sort(function(I,N){return N.name.toLowerCase().localeCompare(I.name.toLowerCase())}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.taxes.sort(function(I,N){return I.name.toLowerCase().localeCompare(N.name.toLowerCase())}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#percentage').css({display:'none'}),$('#percentageUp').css({display:'none'})},o.sortByPercentage=function(){'none'===$('#percentage').css('display')?(o.taxes.sort(function(I,N){return I.rate<N.rate}),$('#percentage').css({display:'inline-table'}),$('#percentageUp').css({display:'none'})):(o.taxes.sort(function(I,N){return N.rate<I.rate}),$('#percentageUp').css({display:'inline-table'}),$('#percentage').css({display:'none'})),$('#name').css({display:'none'}),$('#nameUp').css({display:'none'})},o.print_values=function(){console.log('tax name: '+o.taxName),console.log('tax rate: '+o.taxRate),console.log('is compound: '+o.isCompound)},o.clearAddItemFields=function(){h(),$('#addTaxForm').validate().resetForm()},o.clearAddTaxGroupFields=function(){C(),$('#addTaxGroupForm').validate().resetForm()},o.saveNewGroupTax=function(){if($('#addTaxGroupForm').valid()){showLoader();for(var I=[],N=0,F=0,U=0,P=0;P<o.taxesForGroup.length;++P)o.shouldAdd[P]&&(I.push(o.taxesForGroup[P].entity),U+=o.taxesForGroup[P].rate,o.taxesForGroup[P].isCompound&&(F+=o.taxesForGroup[P].rate,N++));if(1<N)return ShowMessage('You can assign only one compund tax to a tax group.','error'),void hideLoader();if(1>I.length)return ShowMessage('You must select at least 1 tax.','error'),void hideLoader();var S={title:o.taxGroupName,value:U,compound:F,user:D,associatedTaxes:I};y.saveNewGroupTax(S,function(k){console.log(k),hideLoader(),fromTutorial?r.go('dashboard.settings.items'):($('.new-tax-group').removeClass('show'),g())})}},o.updateGroupTax=function(){if($('#editTaxGroupForm').valid()){showLoader();for(var I=[],N=0,F=0,U=0,P=0;P<o.taxesForGroup.length;++P)o.shouldAdd[P]&&(I.push(o.taxesForGroup[P].entity),U+=o.taxesForGroup[P].rate,o.taxesForGroup[P].isCompound&&(F+=o.taxesForGroup[P].rate,N++));if(1<N)return ShowMessage('You can assign only one compund tax to a tax group.','error'),void hideLoader();if(1>I.length)return ShowMessage('You must select at least 1 tax.','error'),void hideLoader();var S=o.selectedTax.entity;S.set('title',o.taxGroupName),S.set('value',U),S.set('compound',F),S.set('associatedTaxes',I),S.save().then(function(){$('.edit-tax-group').removeClass('show'),g()})}},o.saveNewTax=function(){if($('#addTaxForm').valid()){showLoader();var I={title:o.taxName,value:+o.taxRate,compound:o.isCompound?1:0,user:D};y.saveNewTax(I,function(N){console.log(N),hideLoader(),fromTutorial?r.go('dashboard.settings.items'):($('.new-tax').removeClass('show'),g())})}},o.nextClicked=function(){$('.tutorial').hide()},o.editTax=function(I){1==I.type?($('#editTaxForm').validate().resetForm(),$('.edit-tax').addClass('show'),o.taxId=I.id,o.taxName=I.name,o.taxRate=I.rate,o.isCompound=I.isCompound):(o.selectedTax=I,$('#editTaxGroupForm').validate().resetForm(),$('.edit-tax-group').addClass('show'),T(I))},o.saveEditedTax=function(){if($('#editTaxForm').valid()){var I={taxId:o.taxId,taxName:o.taxName,taxRate:o.taxRate,isCompound:o.isCompound},N=y.saveEditedTax(I);$('.edit-tax').removeClass('show'),N.then(function(){console.log('all done'),g()},function(F){console.log('from controller: '+F.message)})}},o.deleteTax=function(I){console.log('delete Click Now'),o.taxToDelete=I.id,$('.delete-tax').addClass('show')},o.confirmDelete=function(){showLoader();var I=Parse.Object.extend('Tax'),N=new Parse.Query(I);N.get(o.taxToDelete,{success:function(F){F.destroy().then(function(){hideLoader(),window.location.reload()})},error:function(F,U){hideLoader(),console.log(U)}})},o.deleteTaxWithotConfirm=function(){showLoader();var I=Parse.Object.extend('Tax'),N=new Parse.Query(I);N.get(o.taxId,{success:function(F){F.destroy().then(function(){hideLoader(),window.location.reload()})},error:function(F,U){hideLoader(),console.log(U)}})},o.search=function(){o.taxes=o.searchText.length?o.displayedTaxes.filter(function(I){return I.name||(I.name=''),I.rate||(I.rate=''),I.name.toLowerCase().includes(o.searchText.toLowerCase())||I.rate.toString().toLowerCase().includes(o.searchText.toLowerCase())}):o.displayedTaxes}}]);'use strict',$(document).ready(function(){$.validator.addMethod('ConfirmPasswordMatch',function(o){return o==$('input[name=\'newPassword\']').val()},''),$.validator.addMethod('UserNameExists',function(){return!parseInt($('#username-exists').val())},'')}),invoicesUnlimited.controller('UserProfileController',['$scope','$state','$controller','userFactory','organizationFactory','projectUserFactory','$q',function(o,r,l,u,y,h,g){function T(){o.existingPassword='',o.newPassword='',o.confirmPassword=''}if(!u.entity.length)return console.log('User not logged in'),r.go('login'),void 0;if(l('DashboardController',{$scope:o,$state:r}),!o.userLogo){var D=u.entity[0].get('selectedOrganization'),I=new Parse.Query('Organization');I.get(D.id,{success:function(F){o.org=F;var U=F.get('logo');o.userLogo=U?U._url:'./assets/images/user-icon.png',o.$$phase||o.$apply()},error:function(){}})}$('#user-info-form').validate({onkeyup:function(F){$(F).valid()},onfocusout:function(F){$(F).valid()},rules:{name:{required:!0},email:{required:!0,email:!0},username:{required:!0}},messages:{name:{required:'Please enter name!'},email:{required:'Please enter email!',email:'Please enter valid email'},username:{required:'Please enter username!'}}});var N=u.entity[0];h.getByUsername(N.get('username')).then(function(F){o.projectUser=F}),g.when(N.fetch()).then(function(){o.UserInfo={name:N.get('fullName'),email:N.get('email'),username:N.get('username'),country:N.get('country')},hideLoader()}),o.saveBusiness=function(){if($('#user-info-form').valid()){showLoader(),N.set('fullName',o.UserInfo.name),N.set('email',o.UserInfo.email),N.set('username',o.UserInfo.username),N.set('country',o.UserInfo.country);N.save().then(function(){o.projectUser?(o.projectUser.set('userName',N.get('username')),o.projectUser.set('country',N.get('country')),o.projectUser.set('emailID',N.get('email')),o.projectUser.set('title',N.get('fullName')),o.projectUser.save().then(function(){hideLoader(),showSnackbar('Save Successful. Reloading page in 3 sec...'),setTimeout(function(){window.location.reload()},2e3)})):(hideLoader(),showSnackbar('Save Successful. Reloading page in 3 sec...'),setTimeout(function(){window.location.reload()},2e3))},function(U){U.message.toLowerCase().includes('email')&&(o.emailError=U.message),U.message.toLowerCase().includes('username')&&(o.usernameError=U.message),o.$$phase||o.$apply(),hideLoader(),console.log(U.message);debugger})}},$('#changePasswordForm').validate({onkeyup:function(F){$(F).valid()},onfocusout:!1,rules:{existingPassword:{required:!0},newPassword:{required:!0,minlength:6},confirmPassword:{required:!0,ConfirmPasswordMatch:!0}},messages:{existingPassword:{required:'Please enter existing password !',minlength:'Password should contain atleast 6 characters'},newPassword:{required:'Please enter new password !',minlength:'Password should contain atleast 6 characters'},confirmPassword:{required:'Please confirm password !',ConfirmPasswordMatch:'Passwords do not match!'}}}),o.showModal=function(){$('#changePasswordModal').show()},o.closeModal=function(){$('#changePasswordModal').hide(),T()},o.updatePassword=function(){$('#changePasswordForm').valid()&&(showLoader(),Parse.User.logIn(u.entity[0].username,o.existingPassword,{success:function(F){F.set('password',o.newPassword),F.save().then(function(){$('#changePasswordModal').hide(),T(),hideLoader()})},error:function(F,U){console.log(U.message),hideLoader(),ShowMessage('Incorrect Existing Password!','error')}}))}}]);'use strict',invoicesUnlimited.controller('NewUserController',['$scope','$state','userFactory','roleFactory','$controller','$q','$uibModalInstance','user','method','title','appFields','queryService',function(o,r,l,u,y,h,g,C,T,D,I,N){function F(){o.user.set('password',o.user.password),o.user.set('colorTheme','appBlueColor'),o.user.set('isTrackUsage',1),o.user.set('getInvoiceNotification',1),o.user.set('subscription',!1),o.user.set('firstScreen','Dashboard'),o.user.set('tutorial',1),I.newCustomer.forEach(function(k){o.user.set(k,l.entity[0].get(k))});var S='Hello '+o.user.fullName+',<br/><br/>You have been invited by '+o.user.company+' to use Invoice Unlimited as '+o.user.role+'.<br/>Please visit the <a href=\'http://app.invoicesunlimited.com/\'>Link</a> and log in with your username and password listed below.<br/><br/>Username: '+o.user.username+'<br/>Password: '+o.user.password+'<br/><br/>Sent from Invoices Unlimited';o.user.save().then(function(k){var L=Parse.Object.extend('Preferencies'),E=new L;return E.set('invoiceShippingCharges',0),E.set('creditNotes','Thank you for your business. If you have any questions, please contact us as soon as possible.'),E.set('invoiceThanksNotes','Thank you for your payment. We appreciate your business and look forward to assisting you in the future.'),E.set('creditTerms',''),E.set('invoiceDiscount',0),E.set('invoiceNotes','Thank you for your business. If you have any questions, please contact us as soon as possible.'),E.set('estimateNotes','Thank you for your business. If you have any questions, please contact us as soon as possible.'),E.set('invoiceTerms',''),E.set('estimateTerms',''),E.set('invoiceAdjustments',0),E.set('invoiceSalesPerson',0),E.set('invoiceAg',1),E.set('estimateAg',1),E.set('creditAg',1),E.set('userID',k),E.set('organization',k.get('selectedOrganization')),E.save().then(function(){console.log('Preferencies created')},function(R){console.error(R)}),u.addUser(k)},function(k){return $('#userError').html(k.message),hideLoader(),h.reject()}).then(function(){return o.user.sendInvite?Parse.Cloud.run('sendMailgunHtml',{toEmail:o.user.email,fromEmail:'no-reply@invoicesunlimited.com',subject:'Invoice Unlimited Login',html:S}).then(function(L){debugger;return L},function(L){debugger;return L}):Parse.Promise.as(!0)},U).then(function(){hideLoader(),g.close(o.user)},U)}if(!l.entity.length)return g.dismiss('No signed in user'),void r.go('login');$('#userForm').validate({rules:{newusername:'required'},messages:{newusername:'Please enter username'}});var U=function(S){return S?void(console.log(S),hideLoader(),g.dismiss(S.message)):h.reject()};o.user=C,o.user.status=C.status,o.mustInvite=C.mustInvite,o.projectUser=C.projectUser,o.oldUserName=C.username,setObjectOperations({object:o.user,fields:I.user}),o.method=T,o.title=D,o.user.password='',o.user.sendInvite=!1,o.mustInvite&&(o.user.sendInvite=!0),o.delete=function(){debugger;return void $('.confirmation-pop-up').addClass('show')},o.update=function(){var S={};['username','fullName','email','role'].forEach(function(k){S[k]=o.user[k]}),showLoader(),Parse.Cloud.run('UpdateUser',{user:{id:o.user.id,params:S}}).then(function(){return N.ext.find({className:'ProjectUser',field:'userName',value:o.oldUserName,methods:[{name:'include',param:'userID'}]})},U).then(function(k){return k.length?k[0].save({role:o.user.role,userName:o.user.username,title:o.user.fullName,emailID:o.user.email,status:o.user.status}):Parse.Promise.as(!1)},U).then(function(k){hideLoader(),g.close(k)},U)};var P='';o.save=function(){if($('#userForm').validate({rules:{newusername:'required',fullName:'required',newemail:{required:!0,email:!0},password:{required:!0,minlength:6},role:'required'},messages:{newusername:'Please enter username',fullName:'Please enter full name',newemail:{required:'Please enter email',email:'Please enter valid email'},password:{required:'Please enter password',minlength:'Password must be at least 6 characters long'},role:'Please select role'}}),!!$('#userForm').valid()){P!=o.user.email&&(P=o.user.email);var S=document.querySelector('.modal-content form');S.checkValidity()&&(showLoader(),F())}},o.closeModal=function(){g.dismiss('Close')}}]);'use strict',invoicesUnlimited.controller('UsersController',['$scope','$state','$uibModal','$controller','$document','userFactory','projectUserFactory','queryService','appFields','$q',function(o,r,l,u,y,h,g,C,T,D){if(!h.entity.length)return void r.go('login');if(u('DashboardController',{$scope:o,$state:r}),!o.userLogo){var N=h.entity[0].get('selectedOrganization'),F=new Parse.Query('Organization');F.get(N.id,{success:function(U){o.org=U;var P=U.get('logo');o.userLogo=P?P._url:'./assets/images/user-icon.png',o.$$phase||o.$apply()},error:function(){}})}o.users=[],hideLoader(),o.deleteUserConfirm=function(U){o.currenDeleteIndex=U,$('.confirmation-pop-up').addClass('show')},o.deleteUser=function(U){debugger;showLoader();var P=o.users[U].get('userID');if($('.confirmation-pop-up').removeClass('show'),!!P){var S=Parse.Object.extend('User'),k=new Parse.Query(S);return k.equalTo('username',o.users[U].userName),k.first({success:function(L){Parse.Cloud.run('deleteUser',{identificator:L.id}).then(function(){return o.users[U].destroy()},function(E){console.log(E.message),hideLoader()}).then(function(){window.location.reload(),o.$apply(function(){o.users.splice(U,1)}),hideLoader()},function(E){E&&console.log(E.message),hideLoader()})},error:function(L){alert('Error: '+L.code+' '+L.message)}})}},o.editUser=function(U){o.currenDeleteIndex=U;var P=l.open({animation:!0,templateUrl:'modal-user',controller:'NewUserController',backdrop:!0,appendTo:angular.element(document.querySelector('#view')),windowTemplateUrl:'modal-window',resolve:{user:function(){var S=Parse.Object.extend('User'),k=new Parse.Query(S);return k.equalTo('username',o.users[U].userName),k.first({success:function(L){return setObjectOperations({object:L,fields:T.user}),L.status=o.users[U].status,L.projectUser=o.users[U],L},error:function(L){alert('Error: '+L.code+' '+L.message)}})},method:function(){return'update'},title:function(){return'Edit user'}}});P.result.then(function(S){setObjectOperations({object:S,fields:T.projectUser}),o.users[U]=S},function(S){console.log('Dismiss modal'),S&&S.deleted&&o.users.splice(U,1)})},o.createUser=function(){var U=l.open({animation:!0,templateUrl:'modal-user',controller:'NewUserController',backdrop:!0,appendTo:angular.element(document.querySelector('#view')),windowTemplateUrl:'modal-window',resolve:{user:function(){var P=Parse.Object.extend(Parse.User),S=new P;return setObjectOperations({object:S,fields:T.user}),S},method:function(){return'create'},title:function(){return'Add User'}}});U.result.then(function(P){setObjectOperations({object:P,fields:T.user});g.createNew({emailID:P.email,role:P.role,userName:P.username,country:P.country,title:P.fullName,organization:P.selectedOrganization,companyName:P.company,userID:h.entity[0],status:'Activated',organization:h.entity[0].get('selectedOrganization')}).then(function(k){showSnackbar('User Added successfully.'),o.$apply(function(){o.users.push(k)})},function(k){console.log(k.message)})},function(){console.log('Dismiss modal')})},o.inviteUser=function(){var U=l.open({animation:!0,templateUrl:'modal-user',controller:'NewUserController',backdrop:!0,appendTo:angular.element(document.querySelector('#view')),windowTemplateUrl:'modal-window',resolve:{user:function(){var P=Parse.Object.extend(Parse.User),S=new P;return setObjectOperations({object:S,fields:T.user}),S.mustInvite=!0,S},method:function(){return'create'},title:function(){return'Add User'}}});U.result.then(function(P){setObjectOperations({object:P,fields:T.user});g.createNew({emailID:P.email,role:P.role,userName:P.username,country:P.country,title:P.fullName,organization:P.selectedOrganization,companyName:P.company,userID:h.entity[0],status:'Activated'}).then(function(k){o.$apply(function(){o.users.push(k)})},function(k){console.log(k.message)})},function(){console.log('Dismiss modal')})},D.when(g.getAll()).then(function(U){o.users=U.map(function(S){return setObjectOperations({object:S,fields:T.projectUser}),S}),o.users=o.users.filter(function(S){return'Main'==S.role||S.userName==h.entity[0].get('username')?!1:!0}),o.dispalyedUsers=o.users,o.sortByUserName()}),o.sortByUserName=function(){'none'===$('#name').css('display')?(o.users.sort(function(U,P){return U.userName.localeCompare(P.userName)}),$('#name').css({display:'inline-table'}),$('#nameUp').css({display:'none'})):(o.users.sort(function(U,P){return P.userName.localeCompare(U.userName)}),$('#nameUp').css({display:'inline-table'}),$('#name').css({display:'none'})),$('#email').css({display:'none'}),$('#role').css({display:'none'}),$('#status').css({display:'none'}),$('#emailUp').css({display:'none'}),$('#roleUp').css({display:'none'}),$('#statusUp').css({display:'none'})},o.sortByemail=function(){o.users.sort(function(U,P){return U.emailID.localeCompare(P.emailID)}),'none'===$('#email').css('display')?(o.users.sort(function(U,P){return U.userName.localeCompare(P.userName)}),$('#email').css({display:'inline-table'}),$('#emailUp').css({display:'none'})):(o.users.sort(function(U,P){return P.userName.localeCompare(U.userName)}),$('#emailUp').css({display:'inline-table'}),$('#email').css({display:'none'})),$('#name').css({display:'none'}),$('#role').css({display:'none'}),$('#status').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#roleUp').css({display:'none'}),$('#statusUp').css({display:'none'})},o.sortByRole=function(){'none'===$('#role').css('display')?(o.users.sort(function(U,P){return U.role.localeCompare(P.role)}),$('#role').css({display:'inline-table'}),$('#roleUp').css({display:'none'})):(o.users.sort(function(U,P){return P.role.localeCompare(U.role)}),$('#roleUp').css({display:'inline-table'}),$('#role').css({display:'none'})),$('#name').css({display:'none'}),$('#email').css({display:'none'}),$('#status').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#emailUp').css({display:'none'}),$('#statusUp').css({display:'none'})},o.sortByStatus=function(){'none'===$('#status').css('display')?(o.users.sort(function(U,P){return U.status.localeCompare(P.status)}),$('#status').css({display:'inline-table'}),$('#statusUp').css({display:'none'})):(o.users.sort(function(U,P){return P.status.localeCompare(U.status)}),$('#statusUp').css({display:'inline-table'}),$('#status').css({display:'none'})),$('#name').css({display:'none'}),$('#email').css({display:'none'}),$('#role').css({display:'none'}),$('#nameUp').css({display:'none'}),$('#emailUp').css({display:'none'}),$('#roleUp').css({display:'none'})},o.search=function(){o.users=o.searchText.length?o.dispalyedUsers.filter(function(U){return U.userName||(U.userName=''),U.emailID||(U.emailID=''),U.role||(U.role=''),U.status||(U.status=''),U.userName.toLowerCase().includes(o.searchText.toLowerCase())||U.emailID.toLowerCase().includes(o.searchText.toLowerCase())||U.role.toLowerCase().includes(o.searchText.toLowerCase())||U.status.toLowerCase().includes(o.searchText.toLowerCase())}):o.dispalyedUsers}}]);