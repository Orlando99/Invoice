"use strict";$(document).ready(function(){$(document).on("click",".menu",function(){var e=$(this).children(".submenu")[0];$(".menu .submenu").toArray().filter(function(t){return t!=e&&$(t).hasClass("showsub")}).forEach(function(e){$(e).removeClass("showsub")}),$(this).children(".submenu").toggleClass("showsub")})}),invoicesUnlimited.controller("CustomersController",["$scope","$rootScope","$state","$uibModal","userFactory","contactPersonFactory","customerFactory","coreFactory","expenseService","invoicesFactory","$controller","$q","appFields","currencyFilter","currencyFactory",function(e,t,n,s,a,i,o,r,c,l,d,u,m,p,f){function h(t){return e.customers.findIndex(function(e){return t==e.entity.id})}function y(){var t=n.params.customerId,s=h(t);-1!=s?(e.selectedCustomer=e.customers[s],e.selectedCustomerId=t):n.go("dashboard.customers.all")}function g(){e.currencyObj={title:void 0,currencySymbol:void 0,decimalPlace:"0",format:"###,###,###",exchangeRate:void 0},$("#addCurrencyForm").validate({rules:{currencyCode:"required",currencySymbol:"required",exchangeRate:{number:!0,min:0,required:!0}}}),$("#addCurrencyForm").validate().resetForm(),$(".new-currency").addClass("show")}function v(){var t=[];t.push(u.when(c.getCustomerExpenses({organization:D,customer:e.selectedCustomer.entity}))),t.push(u.when(D.fetch())),u.all(t).then(function(t){e.selectedCustomer.expenses=t[0];var n=t[1].get("fiscalYearStart"),s=getrotateCount(n),a=0,i=0,o=[0,0,0,0,0,0,0,0,0,0,0,0],r=[0,0,0,0,0,0,0,0,0,0,0,0],c=["#0ea81c","#c31e1e"],l=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];e.selectedCustomer.invoices.forEach(function(e){var t=e.entity.invoiceDate.getMonth();o[t]+=e.entity.total,a+=e.entity.total}),e.selectedCustomer.expenses.forEach(function(e){var t=e.entity.expanseDate.getMonth();r[t]+=e.entity.amount,i+=e.entity.amount}),l.rotate(s),o.rotate(s),r.rotate(s),e.totalIncome=p(a,"$",2),e.totalExpense=p(i,"$",2);var d=$("#barchart");new Chart(d,{type:"bar",data:{labels:l,datasets:[{backgroundColor:c[0],data:o},{backgroundColor:c[1],data:r}]},options:{responsive:!0,legend:{display:!1},scales:{xAxes:[{gridLines:{display:!1}}],yAxes:[{gridLines:{display:!0},ticks:{beginAtZero:!0,userCallback:function(e,t,n){return b(e.toFixed(2))}}}]}}})})}function b(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function x(t){u.when(r.getAllCustomers(t)).then(function(t){e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),e.displayedCustomers=e.customers;var n=[];return n.push(r.getAllInvoices({method:"containedIn",name:"customer",val1:t.map(function(e){return e.entity})})),n.push(r.getAllCreditNotes({method:"containedIn",name:"customer",val1:t.map(function(e){return e.entity})})),u.all(n)}).then(function(t){var s=t[0],a=t[1];e.customers.length;e.customers.forEach(function(e){e.invoices=s.filter(function(t){return t.entity.get("customer").id==e.entity.id}),e.creditNotes=a.filter(function(t){return t.entity.get("customer").id==e.entity.id}),e.entity.unusedCredits||(e.entity.unusedCredits=0),e.entity.outstanding||(e.entity.outstanding=0),e.comments=e.invoices.reduce(function(e,t){return t.comments?e.concat(t.comments):e.concat([])},[])}),e.customers.forEach(function(e){var t=0;e.invoices.forEach(function(e){t+=e.entity.balanceDue}),e.entity.set("outstanding",t);var n=0;e.creditNotes.forEach(function(e){n+=e.entity.remainingCredits}),e.entity.set("unusedCredits",n)}),k.details(n.current.name)?L(w):k.edit(n.current.name)?(L(w),F()):k.emailContact(n.current.name)&&y(),e.sortByCustomerName(),hideLoader()},function(e){console.error(e)})}function C(){var e={translation:{Z:{pattern:/[1]/,optional:!0},Y:{pattern:/[0-02-9]/}}};$("#workPhone").mask("Z (Y00) 000-0000",e),$("#mobilePhone").mask("Z (Y00) 000-0000",e),$("#billFax").mask("Z (Y00) 000-0000",e),$("#shipFax").mask("Z (Y00) 000-0000",e)}var w=n.params.customerId,T=a,D=T.entity[0].get("organizations")[0];if(T.entity.length)if("Sales"!=a.entity[0].get("role")){a.getField("dateFormat").then(function(t){e.dateFormat=t}),e.displayNameClicked=!1,$(".tutorial").hide();u.defer();d("DashboardController",{$scope:e,$state:n}),e.nextClicked=function(){$(".tutorial").hide()},e.skipTutorial=function(){fromTutorial=!1,n.go("dashboard")},$("#edit-customer-form").validate({rules:{firstName:"required",mobilePhone:{required:!1,minlength:14}},messages:{firstName:"Please enter first name",mobilePhone:{minlength:"Please enter a valid phone number"}}}),e.selectedCustomer,e.selectedCustomerId,e.customers=[],e.comments=[],e.shipping={setShippingTheSame:!1,tempShippingAddress:{}};for(var N=function(e){var t="",n=function(e){return e||""};return(e.Street||e.City||e["State/Province"]||e["Zip/Postal Code"]||e.Country||e.Fax)&&(e.Fax?t+=n(e.Street)+"\n"+n(e.City)+"\n"+n(e["State/Province"])+"\n"+n(e["Zip/Postal Code"])+"\n"+n(e.Country)+"\nFax: "+n(e.Fax):t+=n(e.Street)+"\n"+n(e.City)+"\n"+n(e["State/Province"])+"\n"+n(e["Zip/Postal Code"])+"\n"+n(e.Country)+"\n"+n(e.Fax)),t},I=function(e){var t="",n=function(e){return e||""};return(e.Street||e.City||e["State/Province"]||e["Zip/Postal Code"]||e.Country||e.Fax)&&(e.Fax?t+=n(e.Street)+"\n"+n(e.City)+"\n"+n(e["State/Province"])+"\n"+n(e["Zip/Postal Code"])+"\n"+n(e.Country)+"\nFax: "+n(e.Fax):t+=n(e.Street)+"\n"+n(e.City)+"\n"+n(e["State/Province"])+"\n"+n(e["Zip/Postal Code"])+"\n"+n(e.Country)+"\n"+n(e.Fax)),t},L=function(t){var s=h(t);-1!=s?(S(e.customers[s]),e.selectedCustomerId=t):n.go("dashboard.customers.all")},P=["trixInitialize","trixChange","trixSelectionChange","trixFocus","trixBlur","trixFileAccept","trixAttachmentAdd","trixAttachmentRemove"],U=0;U<P.length;U++)e[P[U]]=function(e,t){console.info("Event type:",e.type)};e.trixBlur=function(t,n){console.info("Event type:",t.type),e.trix=n.element.innerHTML},e.sendMail=function(){if($("#send-email-form").validate({rules:{toEmail:"required",subject:"required"},messages:{toEmail:"Please select email",subject:"Please enter subject"}}),$("#send-email-form").valid()){e.selectedCustomer;var t=e.trix,s=$("#toEmail").val(),a=$("#subject").val();showLoader(),Parse.Cloud.run("sendMailgunHtml",{toEmail:s.join(", "),fromEmail:e.selectedCustomer.entity.displayName+" <no-reply@invoicesunlimited.com>",subject:a,html:t}).then(function(t){console.log(t),showSnackbar("Email sent. Redirecting..."),hideLoader(),setTimeout(function(){n.go("dashboard.customers.details",{customerId:e.selectedCustomerId})},2e3)})}},e.cancelSendingEmail=function(){n.go("dashboard.customers.details",{customerId:e.selectedCustomerId})};var F=function(){e.selectedCustomerEdit=$.extend(!0,{},e.selectedCustomer.entity),e.billingAddressEdit=$.extend(!0,{},e.selectedCustomer.billingAddressJSON),e.shippingAddressEdit=$.extend(!0,{},e.selectedCustomer.shippingAddressJSON),e.shipping.setShippingTheSame=e.selectedCustomer.entity.get("isSameAddress")};e.NewExpense=function(){n.go("dashboard.expenses.new",{customerId:e.selectedCustomer.entity.id})},e.NewInvoice=function(){n.go("dashboard.sales.invoices.new",{customerId:e.selectedCustomer.entity.id})},e.NewCreditNote=function(){n.go("dashboard.sales.creditnotes.new",{customerId:e.selectedCustomer.entity.id})},e.NewEstimate=function(){n.go("dashboard.sales.estimates.new",{customerId:e.selectedCustomer.entity.id})};var S=function(t){$("#toEmail").select2("close"),e.selectedCustomer=t;var n=e.dateFormat.toUpperCase().replace(/E/g,"d");e.selectedCustomer.invoices.forEach(function(e){e.invoiceDate=formatDate(e.entity.invoiceDate,n)}),e.selectedCustomer.comments.forEach(function(e){e&&(e.date=formatDate(e.entity.date,n))}),e.comments=e.selectedCustomer.comments,e.sortByDate();var s=e.selectedCustomer.entity;s.notes&&(e.selectedCustomer.notes=s.notes);var a={};s.billingAddress&&(a=JSON.parse(s.billingAddress));var i={};s.shippingAddress&&(i=JSON.parse(s.shippingAddress)),e.selectedCustomer.billingAddress=N(a),e.selectedCustomer.billingAddressJSON=a,e.selectedCustomer.shippingAddress=I(i),e.selectedCustomer.shippingAddressJSON=i,e.receivables=0;e.payments=[],e.selectedCustomer.invoices.forEach(function(t){t.payments&&t.payments.forEach(function(n){var s=n,a=e.dateFormat.toUpperCase().replace(/E/g,"d");"Credit Card"==n.entity.mode?n.mode="CC "+n.entity.lastFourDigits:n.mode=n.entity.mode,s.date=formatDate(n.entity.date,a),s.amount=p(n.entity.amount,"$",2),s.invoiceNumber=t.entity.invoiceNumber,e.payments.push(s)}),e.receivables+=t.entity.balanceDue}),e.receivables=e.receivables.toFixed(2),e.receivables=p(e.receivables,"$",2),v()};u.when(f.loadAll({organization:T.entity[0].get("selectedOrganization")})).then(function(t){e.currencies=t}),e.customerCurrencyChanged=function(){"dummy"==e.selectedCustomerEdit.currency&&(e.selectedCustomerEdit.currency="",g())},e.currencyChanged=function(){e.currencyObj&&(e.currencyObj.currencySymbol=e.currencyObj.title.split(" ")[0])},e.saveNewCurrency=function(){if($("#addCurrencyForm").valid()){showLoader();var t=e.currencyObj;t.userID=T.entity[0],t.organization=T.entity[0].get("selectedOrganization"),t.decimalPlace=Number(t.decimalPlace),t.exchangeRate=Number(t.exchangeRate)||void 0,u.when(r.getUserRole(T.entity[0])).then(function(e){return f.createNewCurrency(t,e)},function(e){console.log(e)}).then(function(t){e.currencies.push(t),e.selectedCustomerEdit.currency=t.entity.title,$(".new-currency").removeClass("show"),hideLoader()})}};var k={details:function(e){return e.endsWith("details")},customers:function(e){return e.endsWith("customers")},edit:function(e){return!!e.includes("customers")&&e.endsWith("edit")},newCustomer:function(e){return e.endsWith("new")},emailContact:function(e){return e.endsWith("emailContact")}};e.setShippingAddress=function(){!e.selectedCustomer||e.shipping.setShippingTheSame?e.selectedCustomer&&(e.shipping.tempShippingAddress=e.shippingAddressEdit,e.shippingAddressEdit=$.extend(!0,{},e.billingAddressEdit)):e.shippingAddressEdit=e.shipping.tempShippingAddress},e.saveSelectedCustomer=function(){if(e.selectedCustomer&&e.shipping.setShippingTheSame&&(e.shippingAddressEdit=$.extend(!0,{},e.billingAddressEdit)),$("#edit-customer-form").valid()){e.shipping.setShippingTheSame?e.selectedCustomer.entity.set("isSameAddress",!0):e.selectedCustomer.entity.isSameAddress=!1;var t=e.selectedCustomer;t.billingAddressJSON=e.billingAddressEdit,t.shippingAddressJSON=e.shippingAddressEdit,e.selectedCustomerEdit.billingAddress=JSON.stringify(t.billingAddressJSON),e.selectedCustomerEdit.shippingAddress=JSON.stringify(t.shippingAddressJSON);for(var s in e.selectedCustomerEdit)m.customer.some(function(e){return s==e})&&(t.entity[s]=e.selectedCustomerEdit[s]);e.shipping.setShippingTheSame?t.entity.set("isSameAddress",!0):t.entity.set("isSameAddress",!1);var a=[],i=t.entity.get("primaryContact");i?(i.set("email",t.entity.get("email")),i.set("mobile",t.entity.get("mobile")),i.set("phone",t.entity.get("phone")),a.push(i.save())):(i=t.contactPersons.filter(function(e){return e.entity.get("defaultPerson")})[0])&&(i.entity.set("email",t.entity.get("email")),i.entity.set("mobile",t.entity.get("mobile")),i.entity.set("phone",t.entity.get("phone")),t.entity.set("primaryContact",i.entity),a.push(i.save())),a.push(t.save()),u.all(a).then(function(){t.billingAddress=N(t.entity.billingAddress),e.selectedCustomerEdit=null,e.billingAddressEdit=null,e.shippingAddressEdit=I(t.entity.shippingAddress),n.go("dashboard.customers.details",{customerId:e.selectedCustomerId})},function(e){console.error(e)})}else{var o=$("#edit-customer-form").validate(),r=$(o.errorList[0].element).offset().top-30;scrollToOffset(r)}},e.deleteSelectedCustomer=function(){showLoader(),e.selectedCustomer.entity.set("isDeleted",1),u.when(e.selectedCustomer.entity.save()).then(function(){e.selectedCustomer=null,e.customers.splice(h(e.selectedCustomerId),1),e.selectedCustomerId=null,hideLoader(),n.go("dashboard.customers.all")})},e.deleteCustomer=function(t,s){t?(showLoader(),e.selectedCustomer.entity.set("isDeleted",1),u.when(e.selectedCustomer.entity.save()).then(function(){e.selectedCustomer=null,e.customers.splice(h(e.selectedCustomerId),1),e.selectedCustomerId=null,hideLoader(),n.go("dashboard.customers.all")})):$(".confirm-delete").removeClass("show")},e.confirmDelete=function(){$(".confirm-delete").addClass("show")},e.changeStatus=function(t){showLoader(),e.selectedCustomer.entity.set("status",t),e.selectedCustomer.entity.save().then(function(e){hideLoader()},function(e){console.log(e.message)})},e.cancelSaveSelectedCustomer=function(){e.selectedCustomerEdit=null,n.go("dashboard.customers.details",{customerId:e.selectedCustomerId})},e.sortByCustomerName=function(){"none"===$("#nameD").css("display")?(e.customers.sort(function(e,t){return e.entity.displayName||(e.entity.displayName=""),t.entity.displayName||(t.entity.displayName=""),e.entity.displayName.localeCompare(t.entity.displayName)}),$("#nameD").css({display:"inline-table"}),$("#nameDUp").css({display:"none"})):(e.customers.sort(function(e,t){return e.entity.displayName||(e.entity.displayName=""),t.entity.displayName||(t.entity.displayName=""),t.entity.displayName.localeCompare(e.entity.displayName)}),$("#nameDUp").css({display:"inline-table"}),$("#nameD").css({display:"none"})),$("#custNameD").css({display:"none"}),$("#emailD").css({display:"none"}),$("#workphoneD").css({display:"none"}),$("#receivableD").css({display:"none"}),$("#creditsD").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#emailDUp").css({display:"none"}),$("#workphoneDUp").css({display:"none"}),$("#receivableDUp").css({display:"none"}),$("#creditsDUp").css({display:"none"})},e.sortByCompanyName=function(){e.customers.sort(function(e,t){return e.entity.companyName||(e.entity.companyName=""),t.entity.companyName||(t.entity.companyName=""),e.entity.companyName.localeCompare(t.entity.companyName)}),"none"===$("#custNameD").css("display")?(e.customers.sort(function(e,t){return e.entity.companyName||(e.entity.companyName=""),t.entity.companyName||(t.entity.companyName=""),e.entity.companyName.localeCompare(t.entity.companyName)}),$("#custNameD").css({display:"inline-table"}),$("#custNameDUp").css({display:"none"})):(e.customers.sort(function(e,t){return e.entity.companyName||(e.entity.companyName=""),t.entity.companyName||(t.entity.companyName=""),t.entity.companyName.localeCompare(e.entity.companyName)}),$("#custNameDUp").css({display:"inline-table"}),$("#custNameD").css({display:"none"})),$("#nameD").css({display:"none"}),$("#emailD").css({display:"none"}),$("#workphoneD").css({display:"none"}),$("#receivableD").css({display:"none"}),$("#creditsD").css({display:"none"}),$("#nameDUp").css({display:"none"}),$("#emailDUp").css({display:"none"}),$("#workphoneDUp").css({display:"none"}),$("#receivableDUp").css({display:"none"}),$("#creditsDUp").css({display:"none"})},e.sortByEmail=function(){"none"===$("#emailD").css("display")?(e.customers.sort(function(e,t){return e.entity.email||(e.entity.email=""),t.entity.email||(t.entity.email=""),e.entity.email.localeCompare(t.entity.email)}),$("#emailD").css({display:"inline-table"}),$("#emailDUp").css({display:"none"})):(e.customers.sort(function(e,t){return e.entity.email||(e.entity.email=""),t.entity.email||(t.entity.email=""),t.entity.email.localeCompare(e.entity.email)}),$("#emailDUp").css({display:"inline-table"}),$("#emailD").css({display:"none"})),$("#nameD").css({display:"none"}),$("#custNameD").css({display:"none"}),$("#workphoneD").css({display:"none"}),$("#receivableD").css({display:"none"}),$("#creditsD").css({display:"none"}),$("#nameDUp").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#workphoneDUp").css({display:"none"}),$("#receivableDUp").css({display:"none"}),$("#creditsDUp").css({display:"none"})},e.sortByPhone=function(){e.customers.sort(function(e,t){return e.entity.mobile||(e.entity.mobile=""),t.entity.mobile||(t.entity.mobile=""),e.entity.mobile.localeCompare(t.entity.mobile)}),"none"===$("#workphoneD").css("display")?(e.customers.sort(function(e,t){return e.entity.mobile||(e.entity.mobile=""),t.entity.mobile||(t.entity.mobile=""),e.entity.mobile.localeCompare(t.entity.mobile)}),$("#workphoneD").css({display:"inline-table"}),$("#workphoneDUp").css({display:"none"})):(e.customers.sort(function(e,t){return e.entity.mobile||(e.entity.mobile=""),t.entity.mobile||(t.entity.mobile=""),t.entity.mobile.localeCompare(e.entity.mobile)}),$("#workphoneDUp").css({display:"inline-table"}),$("#workphoneD").css({display:"none"})),$("#nameD").css({display:"none"}),$("#custNameD").css({display:"none"}),$("#emailD").css({display:"none"}),$("#receivableD").css({display:"none"}),$("#creditsD").css({display:"none"}),$("#nameDUp").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#emailDUp").css({display:"none"}),$("#receivableDUp").css({display:"none"}),$("#creditsDUp").css({display:"none"})},e.sortByReceivable=function(){"none"===$("#receivableD").css("display")?(e.customers.sort(function(e,t){return e.entity.outstanding-t.entity.outstanding}),$("#receivableD").css({display:"inline-table"}),$("#receivableDUp").css({display:"none"})):(e.customers.sort(function(e,t){return t.entity.outstanding-e.entity.outstanding}),$("#receivableDUp").css({display:"inline-table"}),$("#receivableD").css({display:"none"})),$("#nameD").css({display:"none"}),$("#custNameD").css({display:"none"}),$("#emailD").css({display:"none"}),$("#workphoneD").css({display:"none"}),$("#creditsD").css({display:"none"}),$("#nameDUp").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#emailDUp").css({display:"none"}),$("#workphoneDUp").css({display:"none"}),$("#creditsDUp").css({display:"none"})},e.sortByCredits=function(){"none"===$("#creditsD").css("display")?(e.customers.sort(function(e,t){return e.entity.unusedCredits-t.entity.unusedCredits}),$("#creditsD").css({display:"inline-table"}),$("#creditsDUp").css({display:"none"})):(e.customers.sort(function(e,t){return t.entity.unusedCredits-e.entity.unusedCredits}),$("#creditsDUp").css({display:"inline-table"}),$("#creditsD").css({display:"none"})),$("#nameD").css({display:"none"}),$("#custNameD").css({display:"none"}),$("#emailD").css({display:"none"}),$("#workphoneD").css({display:"none"}),$("#receivableD").css({display:"none"}),$("#nameDUp").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#emailDUp").css({display:"none"}),$("#workphoneDUp").css({display:"none"}),$("#receivableDUp").css({display:"none"})},e.sortByDate=function(){"none"===$("#date").css("display")?(e.comments.sort(function(e,t){return e.entity.date>t.entity.date?-1:e.entity.date<t.entity.date?1:0}),$("#date").css({display:"inline-table"}),$("#dateUp").css({display:"none"})):(e.comments.sort(function(e,t){return t.entity.date>e.entity.date?-1:t.entity.date<e.entity.date?1:0}),$("#dateUp").css({display:"inline-table"}),$("#date").css({display:"none"})),$("#user").css({display:"none"}),$("#userUp").css({display:"none"})},e.sortByUser=function(){"none"===$("#user").css("display")?(e.comments.sort(function(e,t){e.entity.name.localeCompare(t.entity.name)}),$("#user").css({display:"inline-table"}),$("#userUp").css({display:"none"})):(e.comments.sort(function(e,t){t.entity.name.localeCompare(e.entity.name)}),$("#userUp").css({display:"inline-table"}),$("#user").css({display:"none"})),$("#date").css({display:"none"}),$("#dateUp").css({display:"none"}),e.comments.sort(function(e,t){return e.entity.name.localeCompare(t.entity.name)})},e.deleteContact=function(t){showLoader(),e.selectedCustomer.contactPersons[t].destroy(e.selectedCustomer).then(function(n){e.selectedCustomer.contactPersons.splice(t,1),e.$$phase||e.$apply(),hideLoader()},function(e){console.log(e.message)})},e.editContact=function(t,n){var a=t;e.selectedCustomer.contactPersons[n]=angular.copy(a),s.open({animation:!0,templateUrl:"modal-contact",controller:"ModalContactController",windowClass:"modalWindow fade in",backdropClass:"popup-modal show fade in",backdrop:!0,resolve:{title:function(){return"Edit Contact Person"},contact:function(){return a},customer:function(){return e.selectedCustomer}}}).result.then(function(t){e.selectedCustomer.contactPersons[n]=t},function(){console.log("dismiss modal")})},$("#addContactForm").validate({rules:{firstname:"required",lastname:"required"},messages:{firstname:"Please specify your estimated montly credit card sales!",lastname:"Please specify your bank name!"}}),e.createContact=function(){s.open({animation:!0,templateUrl:"modal-contact",controller:"ModalContactController",backdropClass:"popup-modal show fade in",windowClass:"modalWindow fade in",backdrop:!0,resolve:{title:function(){return"Add Contact Person"},contact:function(){console.log("Resolve Contact");var e=Parse.Object.extend("ContactPerson"),t=new i(new e);return t.entity.set("userID",T.entity[0]),t},customer:function(){return e.selectedCustomer}}}).result.then(function(t){e.selectedCustomer.contactPersons.push(t)},function(){console.log("dismiss modal")})},t.$on("$viewContentLoaded",function(t){if(k.edit(n.current.name)||k.newCustomer(n.current.name))C();else if(k.emailContact(n.current.name)){var s=[];e.selectedCustomer.contactPersons.forEach(function(e){e.entity.email&&s.push({id:e.entity.email,text:e.entity.email})}),$("#toEmail").html(""),$("#toEmail").select2({data:s,placeholder:"Select Email"}),e.trix=""}});var E=t.$on("$stateChangeStart",function(t,n,s,a,i,o){if(n.name.includes("customers")||(E(),E=null),k.customers(n.name)||k.newCustomer(n.name))e.selectedCustomer=null,e.selectedCustomerId=null;else if(k.details(n.name)){if(isNaN(parseInt(s.customerId))&&a.name.endsWith("new"))return void t.preventDefault();L(s.customerId)}else k.emailContact(n.name)?y():k.edit(n.name)?(L(s.customerId),F()):a.name.endsWith("new")&&x(!0)});x();var j=function(t,n){if(!e.displayNameClicked){var s=e.selectedCustomerEdit;if(s){if(!s.firstName&&!s.lastName)return void(s.displayName="");s.displayName="",s.displayName+=s.firstName?s.firstName:"",s.displayName+=" ",s.displayName+=s.lastName?s.lastName:""}}};e.searchObject={},e.search=function(){e.searchObject.searchText&&(e.searchObject.searchText.length?e.customers=e.displayedCustomers.filter(function(t){return t.entity.displayName||(t.entity.displayName=""),t.entity.companyName||(t.entity.companyName=""),t.entity.email||(t.entity.email=""),t.entity.phone||(t.entity.phone=""),t.entity.outstanding||(t.entity.outstanding=""),t.entity.unusedCredits||(t.entity.unusedCredits=""),t.entity.displayName.toLowerCase().includes(e.searchObject.searchText.toLowerCase())||t.entity.companyName.toLowerCase().includes(e.searchObject.searchText.toLowerCase())||t.entity.email.toLowerCase().includes(e.searchObject.searchText.toLowerCase())||t.entity.phone.toLowerCase().includes(e.searchObject.searchText.toLowerCase())||t.entity.outstanding.toLowerCase().includes(e.searchObject.searchText.toLowerCase())||t.entity.unusedCredits.toLowerCase().includes(e.searchObject.searchText.toLowerCase())}):e.customers=e.displayedCustomers)},e.$watch("selectedCustomerEdit.firstName",j),e.$watch("selectedCustomerEdit.lastName",j),e.availableCurrencies=["ADP - Andorran Peseta","AED - United Arab Emirates Dirham","AFN - Afghan Afghani","ALL - Albanian Lek","AMD - Armenian Dram","ANG - Netherlands Antillean Guilder","AOA - Angolan Kwanza","ARA - Argentine Austral","ARS - Argentine Peso","ATS - Austrian Schilling","AUD - Australian Dollar","AWG - Aruban Florin","AZN - Azerbaijani Manat","BAM - Bosnia-Herzegovina Convertible Mark","BBD - Barbadian Dollar","BDT - Bangladeshi Taka","BEC - Belgian Franc (convertible)","BEF - Belgian Franc","BEL - Belgian Franc (financial)","BGL - Bulgarian Hard Lev","BGM - Bulgarian Socialist Lev","BGN - Bulgarian Lev","BHD - Bahraini Dinar","BIF - Burundian Franc","BMD - Bermudan Dollar","BND - Brunei Dollar","BOB - Bolivian Boliviano","BOP - Bolivian Peso","BOV - Bolivian Mvdol","BRL - Brazilian Real","BSD - Bahamian Dollar","BTN - Bhutanese Ngultrum","BUK - Burmese Kyat","BWP - Botswanan Pula","BYR - Belarusian Ruble","BZD - Belize Dollar","CAD - Canadian Dollar","CDF - Congolese Franc","CHE - WIR Euro","CHF - Swiss Franc","CHW - WIR Franc","CLE - Chilean Escudo","CLF - Chilean Unit of Account (UF)","CLP - Chilean Peso","CNX - Chinese People’s Bank Dollar","CNY - Chinese Yuan","COP - Colombian Peso","COU - Colombian Real Value Unit","CRC - Costa Rican Colón","CSK - Czechoslovak Hard Koruna","CUC - Cuban Convertible Peso","CUP - Cuban Peso","CVE - Cape Verdean Escudo","CYP - Cypriot Pound","CZK - Czech Republic Koruna","DDM - East German Mark","DEM - German Mark","DJF - Djiboutian Franc","DKK - Danish Krone","DOP - Dominican Peso","DZD - Algerian Dinar","ECS - Ecuadorian Sucre","ECV - Ecuadorian Unit of Constant Value","EEK - Estonian Kroon","EGP - Egyptian Pound","ERN - Eritrean Nakfa","ESA - Spanish Peseta (A account)","ESB - Spanish Peseta (convertible account)","ESP - Spanish Peseta","ETB - Ethiopian Birr","EUR - Euro","FIM - Finnish Markka","FJD - Fijian Dollar","FKP - Falkland Islands Pound","FRF - French Franc","GBP - British Pound","GEK - Georgian Kupon Larit","GEL - Georgian Lari","GHS - Ghanaian Cedi","GIP - Gibraltar Pound","GMD - Gambian Dalasi","GNF - Guinean Franc","GNS - Guinean Syli","GQE - Equatorial Guinean Ekwele","GRD - Greek Drachma","GTQ - Guatemalan Quetzal","GWE - Portuguese Guinea Escudo","GWP - Guinea-Bissau Peso","GYD - Guyanaese Dollar","HKD - Hong Kong Dollar","HNL - Honduran Lempira","HRD - Croatian Dinar","HRK - Croatian Kuna","HTG - Haitian Gourde","HUF - Hungarian Forint","IDR - Indonesian Rupiah","IEP - Irish Pound","ILP - Israeli Pound","ILS - Israeli New Sheqel","INR - Indian Rupee","IQD - Iraqi Dinar","IRR - Iranian Rial","ISK - Icelandic Króna","ITL - Italian Lira","JMD - Jamaican Dollar","JOD - Jordanian Dinar","JPY - Japanese Yen","KES - Kenyan Shilling","KGS - Kyrgystani Som","KHR - Cambodian Riel","KMF - Comorian Franc","KPW - North Korean Won","KRW - South Korean Won","KWD - Kuwaiti Dinar","KYD - Cayman Islands Dollar","KZT - Kazakhstani Tenge","LAK - Laotian Kip","LBP - Lebanese Pound","LKR - Sri Lankan Rupee","LRD - Liberian Dollar","LSL - Lesotho Loti","LTL - Lithuanian Litas","LTT - Lithuanian Talonas","LUC - Luxembourgian Convertible Franc","LUF - Luxembourgian Franc","LUL - Luxembourg Financial Franc","LVL - Latvian Lats","LVR - Latvian Ruble","LYD - Libyan Dinar","MAD - Moroccan Dirham","MAF - Moroccan Franc","MCF - Monegasque Franc","MDC - Moldovan Cupon","MDL - Moldovan Leu","MGA - Malagasy Ariary","MGF - Malagasy Franc","MKD - Macedonian Denar","MLF - Malian Franc","MMK - Myanmar Kyat","MNT - Mongolian Tugrik","MOP - Macanese Pataca","MRO - Mauritanian Ouguiya","MTL - Maltese Lira","MTP - Maltese Pound","MUR - Mauritian Rupee","MVR - Maldivian Rufiyaa","MWK - Malawian Kwacha","MXN - Mexican Peso","MXV - Mexican Investment Unit","MYR - Malaysian Ringgit","MZE - Mozambican Escudo","MZN - Mozambican Metical","NAD - Namibian Dollar","NGN - Nigerian Naira","NIO - Nicaraguan Córdoba","NLG - Dutch Guilder","NOK - Norwegian Krone","NPR - Nepalese Rupee","NZD - New Zealand Dollar","OMR - Omani Rial","PAB - Panamanian Balboa","PEI - Peruvian Inti","PEN - Peruvian Nuevo Sol","PGK - Papua New Guinean Kina","PHP - Philippine Peso","PKR - Pakistani Rupee","PLN - Polish Zloty","PTE - Portuguese Escudo","PYG - Paraguayan Guarani","QAR - Qatari Rial","RHD - Rhodesian Dollar","RON - Romanian Leu","RSD - Serbian Dinar","RUB - Russian Ruble","RWF - Rwandan Franc","SAR - Saudi Riyal","SBD - Solomon Islands Dollar","SCR - Seychellois Rupee","SDG - Sudanese Pound","SEK - Swedish Krona","SGD - Singapore Dollar","SHP - St. Helena Pound","SIT - Slovenian Tolar","SKK - Slovak Koruna","SLL - Sierra Leonean Leone","SOS - Somali Shilling","SRD - Surinamese Dollar","SRG - Surinamese Guilder","SSP - South Sudanese Pound","STD - São Tomé & Príncipe Dobra","SUR - Soviet Rouble","SVC - Salvadoran Colón","SYP - Syrian Pound","SZL - Swazi Lilangeni","THB - Thai Baht","TJR - Tajikistani Ruble","TJS - Tajikistani Somoni","TMT - Turkmenistani Manat","TND - Tunisian Dinar","TOP - Tongan Paʻanga","TPE - Timorese Escudo","TRY - Turkish Lira","TTD - Trinidad & Tobago Dollar","TWD - New Taiwan Dollar","TZS - Tanzanian Shilling","UAH - Ukrainian Hryvnia","UAK - Ukrainian Karbovanets","UGX - Ugandan Shilling","USD - US Dollar","USN - US Dollar (Next day)","USS - US Dollar (Same day)","UYI - Uruguayan Peso (Indexed Units)","UYU - Uruguayan Peso","UZS - Uzbekistani Som","VEF - Venezuelan Bolívar","VND - Vietnamese Dong","VUV - Vanuatu Vatu","WST - Samoan Tala","XAF - Central African CFA Franc","XAG - Silver","XAU - Gold","XBA - European Composite Unit","XBB - European Monetary Unit","XBC - European Unit of Account (XBC)","XBD - European Unit of Account (XBD)","XCD - East Caribbean Dollar","XDR - Special Drawing Rights","XEU - European Currency Unit","XFO - French Gold Franc","XFU - French UIC-Franc","XOF - West African CFA Franc","XPD - Palladium","XPF - CFP Franc","XPT - Platinum","XRE - RINET Funds","XSU - Sucre","XTS - Testing Currency Code","XUA - ADB Unit of Account","XXX - Unknown Currency","YDD - Yemeni Dinar","YER - Yemeni Rial","ZAL - South African Rand (financial)","ZAR - South African Rand","ZMW - Zambian Kwacha"]}else n.go("dashboard.sales.invoices.all");else n.go("login")}]),invoicesUnlimited.controller("ModalContactController",["$scope","$uibModalInstance","contact","customer","title",function(e,t,n,s,a){e.contact=n,e.title=a,e.Save=function(){$("#addContactForm").validate({rules:{firstname:"required",lastname:"required",mobile:{required:!1,minlength:14},phone:{required:!1,minlength:14},email:{required:!1,email:!0}},messages:{firstname:"Please enter first name",lastname:"Please enter last name",mobile:{minlength:"Please enter a valid phone number"},phone:{minlength:"Please enter a valid phone number"},email:{email:"Please enter a valid email address"}}}),$("#addContactForm").valid()&&(showLoader(),e.contact.save().then(function(t){if(!s.contactPersons.some(function(t){return t.entity.id==e.contact.entity.id}))return s.entity.add("contactPersons",e.contact.entity),s.save()},function(e){}).then(function(n){hideLoader(),t.close(e.contact)}))},e.Cancel=function(){t.dismiss("Close")},$(".workPhone").mask("(000) 000-0000"),$(".mobilePhone").mask("9 (999) 999-9999",mobileOptions),e.maskPhones=function(){$(".workPhone").mask("(000) 000-0000"),$(".mobilePhone").mask("9 (999) 999-9999",mobileOptions)}}]),invoicesUnlimited.controller("NewCustomerController",["$scope","$rootScope","$state","userFactory","contactPersonFactory","customerFactory","$controller","$q","coreFactory","currencyFactory",function(e,t,n,s,a,i,o,r,c,l){function d(e){if(0==e.which||8==e.which||32==e.which)return!0;if(32==e.which)return!0;var t=new RegExp("[a-zA-Z0-9-]+$"),n=String.fromCharCode(e.charCode?e.charCode:e.which);return!!t.test(n)||(e.preventDefault(),!1)}function u(){var t=p.entity[0].get("currency");e.defaultCurrencyIndex=e.currencies.findIndex(function(e){return e.entity.id==t.id}),e.newCustomer.entity.currency=e.currencies[e.defaultCurrencyIndex].entity.title}function m(){e.currencyObj={title:void 0,currencySymbol:void 0,decimalPlace:"0",format:"###,###,###",exchangeRate:void 0},$("#addCurrencyForm").validate({rules:{currencyCode:"required",currencySymbol:"required",exchangeRate:{number:!0,min:0,required:!0}}}),$("#addCurrencyForm").validate().resetForm(),$(".new-currency").addClass("show")}var p=s;if(p.entity.length)if("Sales"!=s.entity[0].get("role")){fromTutorial?$(".tutorial").show():$(".tutorial").hide(),e.displayNameClicked=!1,$("#workPhone").mask("(999) 999-9999"),$("#mobilePhone").mask("9 (999) 999-9999",mobileOptions),$(".alphaNumericField").keypress(function(e){d(e)});r.defer();var f={Street:"",Fax:"",City:"","Zip/Postal Code":"",Country:"","State/Province":""};o("DashboardController",{$scope:e,$state:n}),hideLoader();var h=Parse.Object.extend("Customer");e.newCustomer=new i(new h),e.newCustomer.entity.set("userID",p.entity[0]),e.newCustomer.entity.set("status","active"),e.newCustomer.entity.paymentTerms="Due on Receipt",e.newCustomer.billingAddress=Object.create(f),e.newCustomer.shippingAddress=Object.create(f),r.when(l.loadAll({organization:p.entity[0].get("selectedOrganization")})).then(function(t){e.currencies=t,u()}),e.shipping={setShippingTheSame:!1,tempShippingAddress:{}},$("#new-customer-form").validate({rules:{firstName:"required",mobilePhone:{required:!1,minlength:14},phoneNumber:{required:!1,minlength:14},email:{required:!1,email:!0}},messages:{firstName:"Please enter first name",mobilePhone:{minlength:"Please enter a valid phone number"},phoneNumber:{minlength:"Please enter a valid phone number"},email:{email:"Please enter a valid email address"}}}),e.customerCurrencyChanged=function(){"dummy"==e.newCustomer.entity.currency&&(e.newCustomer.entity.currency="",m())},e.currencyChanged=function(){e.currencyObj&&(e.currencyObj.currencySymbol=e.currencyObj.title.split(" ")[0])},e.saveNewCurrency=function(){if($("#addCurrencyForm").valid()){showLoader();var t=e.currencyObj;t.userID=p.entity[0],t.organization=p.entity[0].get("selectedOrganization"),t.decimalPlace=Number(t.decimalPlace),t.exchangeRate=Number(t.exchangeRate)||void 0,r.when(c.getUserRole(p.entity[0])).then(function(e){return l.createNewCurrency(t,e)},function(e){console.log(e)}).then(function(t){e.currencies.push(t),e.newCustomer.entity.currency=t.entity.title,$(".new-currency").removeClass("show"),hideLoader()})}},e.setShippingAddress=function(){!e.newCustomer||e.shipping.setShippingTheSame?e.newCustomer&&(e.shipping.tempShippingAddress=e.newCustomer.shippingAddress,e.newCustomer.shippingAddress=$.extend(!0,{},e.newCustomer.billingAddress)):e.newCustomer.shippingAddress=e.shipping.tempShippingAddress},e.saveCustomer=function(){if(e.newCustomer&&e.shipping.setShippingTheSame&&(e.newCustomer.shippingAddress=$.extend(!0,{},e.newCustomer.billingAddress)),$("#new-customer-form").valid()){showLoader(),e.newCustomer.entity.billingAddress=JSON.stringify(e.newCustomer.billingAddress),e.newCustomer.entity.shippingAddress=JSON.stringify(e.newCustomer.shippingAddress),e.shipping.setShippingTheSame?e.newCustomer.entity.set("isSameAddress",!0):e.newCustomer.entity.set("isSameAddress",!1);var t=Parse.Object.extend("ContactPerson"),s=new a(new t);e.newCustomer;s.entity.set("userID",p.entity[0]),s.entity.set("defaultPerson",1),["email","phone","mobile","lastName","firstName","salutaion"].forEach(function(t){s.entity[t.toLowerCase()]=e.newCustomer.entity[t]}),e.newCustomer.entity.firstname||(s.entity.firstname=e.newCustomer.entity.displayName.split(" ")[0]),s.save().then(function(){e.newCustomer.entity.add("contactPersons",s.entity),e.newCustomer.entity.set("primaryContact",s.entity),e.newCustomer.entity.set("organization",p.entity[0].get("selectedOrganization")),e.newCustomer.save().then(function(t){e.newCustomer=new i(new h),e.newCustomer.entity.set("userID",p.entity[0]),e.newCustomer.billingAddress=Object.create(f),e.newCustomer.shippingAddress=Object.create(f),hideLoader(),n.params.backLink?(c.clearAllOnLogOut(),n.params.invoiceId?n.go(n.params.backLink,{customerId:t.id,invoiceId:n.params.invoiceId}):n.params.estimateId?n.go(n.params.backLink,{customerId:t.id,estimateId:n.params.estimateId}):n.params.creditNoteId?n.go(n.params.backLink,{customerId:t.id,creditNoteId:n.params.creditNoteId}):n.params.expenseId?n.go(n.params.backLink,{customerId:t.id,expenseId:n.params.expenseId}):n.go(n.params.backLink,{customerId:t.id})):fromTutorial?(fromTutorial=!1,n.go("dashboard")):n.go("dashboard.customers.all")})})}else{var o=$("#new-customer-form").validate(),r=$(o.errorList[0].element).offset().top-30;scrollToOffset(r)}};var y=function(t,n){if(!e.displayNameClicked){var s=e.newCustomer.entity;if(!s.firstName&&!s.lastName)return void(s.displayName="");s.displayName="",s.displayName+=s.firstName?s.firstName:"",s.displayName+=" ",s.displayName+=s.lastName?s.lastName:""}};e.$watch("newCustomer.entity.firstName",y),e.$watch("newCustomer.entity.lastName",y),e.cancelSaveCustomer=function(){window.history.go(-1)},e.nextClicked=function(){$(".tutorial").hide()},e.skipTutorial=function(){fromTutorial=!1,n.go("dashboard")},e.availableCurrencies=["ADP - Andorran Peseta","AED - United Arab Emirates Dirham","AFN - Afghan Afghani","ALL - Albanian Lek","AMD - Armenian Dram","ANG - Netherlands Antillean Guilder","AOA - Angolan Kwanza","ARA - Argentine Austral","ARS - Argentine Peso","ATS - Austrian Schilling","AUD - Australian Dollar","AWG - Aruban Florin","AZN - Azerbaijani Manat","BAM - Bosnia-Herzegovina Convertible Mark","BBD - Barbadian Dollar","BDT - Bangladeshi Taka","BEC - Belgian Franc (convertible)","BEF - Belgian Franc","BEL - Belgian Franc (financial)","BGL - Bulgarian Hard Lev","BGM - Bulgarian Socialist Lev","BGN - Bulgarian Lev","BHD - Bahraini Dinar","BIF - Burundian Franc","BMD - Bermudan Dollar","BND - Brunei Dollar","BOB - Bolivian Boliviano","BOP - Bolivian Peso","BOV - Bolivian Mvdol","BRL - Brazilian Real","BSD - Bahamian Dollar","BTN - Bhutanese Ngultrum","BUK - Burmese Kyat","BWP - Botswanan Pula","BYR - Belarusian Ruble","BZD - Belize Dollar","CAD - Canadian Dollar","CDF - Congolese Franc","CHE - WIR Euro","CHF - Swiss Franc","CHW - WIR Franc","CLE - Chilean Escudo","CLF - Chilean Unit of Account (UF)","CLP - Chilean Peso","CNX - Chinese People’s Bank Dollar","CNY - Chinese Yuan","COP - Colombian Peso","COU - Colombian Real Value Unit","CRC - Costa Rican Colón","CSK - Czechoslovak Hard Koruna","CUC - Cuban Convertible Peso","CUP - Cuban Peso","CVE - Cape Verdean Escudo","CYP - Cypriot Pound","CZK - Czech Republic Koruna","DDM - East German Mark","DEM - German Mark","DJF - Djiboutian Franc","DKK - Danish Krone","DOP - Dominican Peso","DZD - Algerian Dinar","ECS - Ecuadorian Sucre","ECV - Ecuadorian Unit of Constant Value","EEK - Estonian Kroon","EGP - Egyptian Pound","ERN - Eritrean Nakfa","ESA - Spanish Peseta (A account)","ESB - Spanish Peseta (convertible account)","ESP - Spanish Peseta","ETB - Ethiopian Birr","EUR - Euro","FIM - Finnish Markka","FJD - Fijian Dollar","FKP - Falkland Islands Pound","FRF - French Franc","GBP - British Pound","GEK - Georgian Kupon Larit","GEL - Georgian Lari","GHS - Ghanaian Cedi","GIP - Gibraltar Pound","GMD - Gambian Dalasi","GNF - Guinean Franc","GNS - Guinean Syli","GQE - Equatorial Guinean Ekwele","GRD - Greek Drachma","GTQ - Guatemalan Quetzal","GWE - Portuguese Guinea Escudo","GWP - Guinea-Bissau Peso","GYD - Guyanaese Dollar","HKD - Hong Kong Dollar","HNL - Honduran Lempira","HRD - Croatian Dinar","HRK - Croatian Kuna","HTG - Haitian Gourde","HUF - Hungarian Forint","IDR - Indonesian Rupiah","IEP - Irish Pound","ILP - Israeli Pound","ILS - Israeli New Sheqel","INR - Indian Rupee","IQD - Iraqi Dinar","IRR - Iranian Rial","ISK - Icelandic Króna","ITL - Italian Lira","JMD - Jamaican Dollar","JOD - Jordanian Dinar","JPY - Japanese Yen","KES - Kenyan Shilling","KGS - Kyrgystani Som","KHR - Cambodian Riel","KMF - Comorian Franc","KPW - North Korean Won","KRW - South Korean Won","KWD - Kuwaiti Dinar","KYD - Cayman Islands Dollar","KZT - Kazakhstani Tenge","LAK - Laotian Kip","LBP - Lebanese Pound","LKR - Sri Lankan Rupee","LRD - Liberian Dollar","LSL - Lesotho Loti","LTL - Lithuanian Litas","LTT - Lithuanian Talonas","LUC - Luxembourgian Convertible Franc","LUF - Luxembourgian Franc","LUL - Luxembourg Financial Franc","LVL - Latvian Lats","LVR - Latvian Ruble","LYD - Libyan Dinar","MAD - Moroccan Dirham","MAF - Moroccan Franc","MCF - Monegasque Franc","MDC - Moldovan Cupon","MDL - Moldovan Leu","MGA - Malagasy Ariary","MGF - Malagasy Franc","MKD - Macedonian Denar","MLF - Malian Franc","MMK - Myanmar Kyat","MNT - Mongolian Tugrik","MOP - Macanese Pataca","MRO - Mauritanian Ouguiya","MTL - Maltese Lira","MTP - Maltese Pound","MUR - Mauritian Rupee","MVR - Maldivian Rufiyaa","MWK - Malawian Kwacha","MXN - Mexican Peso","MXV - Mexican Investment Unit","MYR - Malaysian Ringgit","MZE - Mozambican Escudo","MZN - Mozambican Metical","NAD - Namibian Dollar","NGN - Nigerian Naira","NIO - Nicaraguan Córdoba","NLG - Dutch Guilder","NOK - Norwegian Krone","NPR - Nepalese Rupee","NZD - New Zealand Dollar","OMR - Omani Rial","PAB - Panamanian Balboa","PEI - Peruvian Inti","PEN - Peruvian Nuevo Sol","PGK - Papua New Guinean Kina","PHP - Philippine Peso","PKR - Pakistani Rupee","PLN - Polish Zloty","PTE - Portuguese Escudo","PYG - Paraguayan Guarani","QAR - Qatari Rial","RHD - Rhodesian Dollar","RON - Romanian Leu","RSD - Serbian Dinar","RUB - Russian Ruble","RWF - Rwandan Franc","SAR - Saudi Riyal","SBD - Solomon Islands Dollar","SCR - Seychellois Rupee","SDG - Sudanese Pound","SEK - Swedish Krona","SGD - Singapore Dollar","SHP - St. Helena Pound","SIT - Slovenian Tolar","SKK - Slovak Koruna","SLL - Sierra Leonean Leone","SOS - Somali Shilling","SRD - Surinamese Dollar","SRG - Surinamese Guilder","SSP - South Sudanese Pound","STD - São Tomé & Príncipe Dobra","SUR - Soviet Rouble","SVC - Salvadoran Colón","SYP - Syrian Pound","SZL - Swazi Lilangeni","THB - Thai Baht","TJR - Tajikistani Ruble","TJS - Tajikistani Somoni","TMT - Turkmenistani Manat","TND - Tunisian Dinar","TOP - Tongan Paʻanga","TPE - Timorese Escudo","TRY - Turkish Lira","TTD - Trinidad & Tobago Dollar","TWD - New Taiwan Dollar","TZS - Tanzanian Shilling","UAH - Ukrainian Hryvnia","UAK - Ukrainian Karbovanets","UGX - Ugandan Shilling","USD - US Dollar","USN - US Dollar (Next day)","USS - US Dollar (Same day)","UYI - Uruguayan Peso (Indexed Units)","UYU - Uruguayan Peso","UZS - Uzbekistani Som","VEF - Venezuelan Bolívar","VND - Vietnamese Dong","VUV - Vanuatu Vatu","WST - Samoan Tala","XAF - Central African CFA Franc","XAG - Silver","XAU - Gold","XBA - European Composite Unit","XBB - European Monetary Unit","XBC - European Unit of Account (XBC)","XBD - European Unit of Account (XBD)","XCD - East Caribbean Dollar","XDR - Special Drawing Rights","XEU - European Currency Unit","XFO - French Gold Franc","XFU - French UIC-Franc","XOF - West African CFA Franc","XPD - Palladium","XPF - CFP Franc","XPT - Platinum","XRE - RINET Funds","XSU - Sucre","XTS - Testing Currency Code","XUA - ADB Unit of Account","XXX - Unknown Currency","YDD - Yemeni Dinar","YER - Yemeni Rial","ZAL - South African Rand (financial)","ZAR - South African Rand","ZMW - Zambian Kwacha"]}else n.go("dashboard.sales.invoices.all");else n.go("login")}]),invoicesUnlimited.controller("ExpenseCategoryController",["$q","$scope","$state","$controller","userFactory","expenseService","coreFactory","expenseCategoryFactory","expenseCategoryService",function(e,t,n,s,a,i,o,r,c){if(a.entity.length)if("Sales"!=a.entity[0].get("role")){var l=a.entity[0],d=l.get("organizations")[0];s("DashboardController",{$scope:t,$state:n}),showLoader(),e.when(o.getExpenseCategories({organization:d})).then(function(e){t.categories=e.sort(function(e,t){return alphabeticalSort(e.entity.name,t.entity.name)}),colorCodeToValue,t.shouldDelete=new Array(t.categories.length);for(var n=0;n<t.categories.length;++n)t.shouldDelete[n]=!1,t.catColors.push(colorCodeToValue(t.categories[n].entity.get("color")));hideLoader()},function(e){hideLoader(),console.log(e.message)}),function(){for(var e=[],n=0;n<colorCount;++n)e.push(colorCodeToValue(n));t.colors=e}(),t.catColors=[],t.deleteCategories=function(){t.shouldDelete;for(var e=[],n=0;n<t.categories.length;++n)t.shouldDelete[n]&&e.push(t.categories[n].entity);e.length>0?(showLoader(),Parse.Object.destroyAll(e).then(function(){hideLoader(),window.location.reload()})):ShowMessage("No category selected!","error")},t.toggleCheck=function(){for(var e=0;e<t.categories.length;++e)t.shouldDelete[e]=t.selectAll},t.setColor=function(e){t.selectedColor=colorCodeToValue(e),t.newCategory&&(t.newCategory.colorCode=e),t.editCategory&&(t.editCategory.colorCode=e)},t.prepareAddCategory=function(){t.selectedColor=colorCodeToValue(0),t.newCategory={name:"",desc:"",colorCode:0},$("#addCategoryForm").validate({rules:{name:"required"}}),$("#addCategoryForm").validate().resetForm()},t.showCategoryDetail=function(e){var n=t.categories[e];t.editCategoryIndex=e,t.selectedColor=colorCodeToValue(n.entity.color),t.editCategory={name:n.entity.name,desc:n.entity.notes,colorCode:n.entity.color},$("#editCategoryForm").validate({rules:{name:"required"}}),$("#editCategoryForm").validate().resetForm(),$(".edit-category").addClass("show")},t.createNewCategory=function(){if($("#addCategoryForm").valid()){showLoader();var n={userID:l,organization:d,name:t.newCategory.name,notes:t.newCategory.desc,color:t.newCategory.colorCode};e.when(o.getUserRole(l)).then(function(e){return c.createNewCategory(n,e)}).then(function(e){t.categories.unshift(e),$(".new-category").removeClass("show"),window.location.reload(),hideLoader()})}},t.saveEditedCategory=function(){if($("#editCategoryForm").valid()){showLoader();var n=t.categories[t.editCategoryIndex];n.entity.set("name",t.editCategory.name),n.entity.set("notes",t.editCategory.desc),n.entity.set("color",t.editCategory.colorCode),e.when(c.saveEditedCategory(n.entity)).then(function(e){t.categories[t.editCategoryIndex]=e,$(".edit-category").removeClass("show"),window.location.reload(),hideLoader()})}}}else n.go("dashboard.sales.invoices.all");else console.log("User not logged in")}]),invoicesUnlimited.controller("ExpenseController",["$q","$scope","$state","$controller","userFactory","expenseService","coreFactory","taxService","currencyFilter",function(e,t,n,s,a,i,o,r,c){function l(e){e||(e=n.current.name),g.expenses(e)?f():g.details(e)?d():g.newExpense(e)?m():g.edit(e)&&u()}function d(){var s=n.params.expenseId;s&&(showLoader(),e.when(i.getExpenseDetails(s)).then(function(e){e.amount=c(e.entity.amount,"$",2),e.date=formatDate(e.entity.expanseDate,"dddd, MMMM DD, YYYY"),e.attachments?(t.attachments=e.attachments,t.attachments.forEach(function(e){e.fileName=e.name(),e.fileName1=e.fileName.substring(e.fileName.indexOf("_")+1,e.fileName.length),e.fileUrl=e.url()})):t.attachments=[],t.expense=e,hideLoader()},function(e){console.log(e.message),hideLoader()}))}function u(){var s=n.params.expenseId;if(s)return showLoader(),e.when(p()).then(function(t){return e.when(i.getExpense(s))}).then(function(e){t.expense=e.entity,t.expenseType={types:[{name:"Non Billable",value:"Non-Billable"},{name:"Billable",value:"Billable"}]};var s="Billable"==e.entity.status?1:0;t.expenseType.selectedType=t.expenseType.types[s],t.todayDate=e.entity.expanseDate,t.amount=e.entity.amount,t.refNumber=e.entity.referenceNumber,t.notes=e.entity.notes,t.selectedCategory=t.categories.filter(function(t){return e.entity.category==t.entity.name})[0];var a=n.params.customerId;if(a)t.selectedCustomer=t.customers.filter(function(e){return a===e.entity.id})[0];else{var i=e.entity.get("customer");i&&(t.selectedCustomer=t.customers.filter(function(e){return i.id==e.entity.id})[0])}e.entity.tax&&(t.selectedTax=t.taxes.filter(function(t){return e.entity.tax.id==t.id})[0]);var o=e.entity.expenseFiles;o?(o.forEach(function(e){e.fileName=e.name(),e.fileName1=e.fileName.substring(e.fileName.indexOf("_")+1,e.fileName.length),e.exist=!0}),t.files=o):t.files=[],hideLoader()})}function m(){showLoader();var s=n.params.expenseId;e.when(p()).then(function(a){if(s)e.when(i.getExpense(s)).then(function(e){t.expense=e,t.expenseType={types:[{name:"Non Billable",value:"Non-Billable"},{name:"Billable",value:"Billable"}],selectedType:{name:"Non Billable",value:"Non-Billable"}};var n="Billable"==e.entity.status?1:0;t.expenseType.selectedType=t.expenseType.types[n],t.todayDate=e.entity.expanseDate,t.amount=e.entity.amount,t.refNumber=e.entity.referenceNumber,t.notes=e.entity.notes,t.selectedCategory=t.categories.filter(function(t){return e.entity.category==t.entity.name})[0];var s=e.entity.get("customer");s&&(t.selectedCustomer=t.customers.filter(function(e){return s.id==e.entity.id})[0]),e.entity.tax&&(t.selectedTax=t.taxes.filter(function(t){return e.entity.tax.id==t.id})[0]);var a=e.entity.expenseFiles;a?(a.forEach(function(e){e.fileName=e.name(),e.fileName1=e.fileName.substring(e.fileName.indexOf("_")+1,e.fileName.length),e.exist=!0}),t.files=a):t.files=[]});else{t.expenseType={types:[{name:"Non Billable",value:"Non-Billable"},{name:"Billable",value:"Billable"}],selectedType:{name:"Non Billable",value:"Non-Billable"}};var o=n.params.customerId;o&&(t.expenseType.selectedType=t.expenseType.types[1],t.selectedCustomer=t.customers.filter(function(e){return e.entity.id==o})[0]),t.files=[],t.todayDate=new Date,hideLoader()}})}function p(){var s=[],a=null;return a=e.when(o.getExpenseCategories({organization:y})).then(function(e){t.categories=e.sort(function(e,t){return alphabeticalSort(e.entity.name,t.entity.name)})}),s.push(a),a=r.getTaxes(h,function(e){t.taxes=e}),s.push(a),a=e.when(o.getAllCustomers()).then(function(e){e=e.filter(function(e){return"active"==e.entity.status}),t.customers=e.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),t.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),g.newExpense(n.current.name)&&(t.customers=t.customers.concat([createCustomerOpener])),g.edit(n.current.name)&&(t.customers=t.customers.concat([createCustomerOpener]))}),s.push(a),a=e.when(o.getUserRole(h)).then(function(e){t.userRole=e}),s.push(a),e.all(s)}function f(){showLoader(),e.when(i.listExpenses(h)).then(function(e){var n=t.dateFormat.toUpperCase().replace(/E/g,"d");e.forEach(function(e){switch(e.entity.status){case"Non-Billable":e.statusClass="text-color-normalize";break;case"Billable":e.statusClass="text-positive";break;default:e.statusClass="text-danger"}e.entity.get("expenseFiles")&&(e.attachments=e.entity.get("expenseFiles").length),e.expenseDate=formatDate(e.entity.expanseDate,n),e.amount=c(e.entity.amount,"$",2)}),t.expenseList=e,t.allExpenses=e,t.displayedExpenses=e,t.currentExpenses="All Expenses",t.sortByDate(),hideLoader()},function(e){hideLoader(),console.log(e.message)})}if(a.entity.length){var h=a.entity[0],y=h.get("organizations")[0];s("DashboardController",{$scope:t,$state:n});var g={details:function(e){return e.endsWith("expenses.details")},expenses:function(e){return e.endsWith("expenses.all")},edit:function(e){return e.endsWith("expenses.edit")},newExpense:function(e){return e.endsWith("expenses.new")}};l(),$("#addExpenseForm").validate({rules:{expCategory:"required",date:"required",amount:{required:!0,min:.01}},messages:{expCategory:"Please select an expense category",date:"Please specify expense date",amount:{required:"Please enter expense amount"}}});var v=a.entity[0].currency.attributes;if(v.exchangeRate)t.currentCurrency=v;else{var b={currencySymbol:"$",exchangeRate:1};t.currentCurrency=b,v=b}a.getField("dateFormat").then(function(n){t.dateFormat=n,e.when(a.entity[0].currency.fetch()).then(function(e){if((v=e.attributes).exchangeRate)t.currentCurrency=v;else{var n={currencySymbol:"$",exchangeRate:1};t.currentCurrency=n,v=n}l()})}),$("#editExpenseForm").validate({rules:{expCategory:"required",date:"required",amount:{required:!0,min:.01}},messages:{expCategory:"Please select an expense category",date:"Please specify expense date",amount:{required:"Please enter expense amount"},customer:"Please select a customer"}}),t.dateOptions={showWeeks:!1},t.cloneExpense=function(e){n.go("dashboard.expenses.new",{expenseId:e})},t.sortByCatName=function(){"none"===$("#catname").css("display")?(t.expenseList.sort(function(e,t){return e.entity.category.localeCompare(t.entity.category)}),$("#catname").css({display:"inline-table"}),$("#catnameUp").css({display:"none"})):(t.expenseList.sort(function(e,t){return t.entity.category.localeCompare(e.entity.category)}),$("#catnameUp").css({display:"inline-table"}),$("#catname").css({display:"none"})),$("#date").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByDate=function(){"none"===$("#dateUp").css("display")?(t.expenseList.sort(function(e,t){return t.entity.expanseDate>e.entity.expanseDate?-1:t.entity.expanseDate<e.entity.expanseDate?1:0}),$("#dateUp").css({display:"inline-table"}),$("#date").css({display:"none"})):(t.expenseList.sort(function(e,t){return e.entity.expanseDate>t.entity.expanseDate?-1:e.entity.expanseDate<t.entity.expanseDate?1:0}),$("#date").css({display:"inline-table"}),$("#dateUp").css({display:"none"})),$("#catname").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#catnameUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByReferenceNumber=function(){"none"===$("#refno").css("display")?(t.expenseList.sort(function(e,t){return e.entity.referenceNumber.localeCompare(t.entity.referenceNumber)}),$("#refno").css({display:"inline-table"}),$("#refnoUp").css({display:"none"})):(t.expenseList.sort(function(e,t){return t.entity.referenceNumber.localeCompare(e.entity.referenceNumber)}),$("#refnoUp").css({display:"inline-table"}),$("#refno").css({display:"none"})),$("#date").css({display:"none"}),$("#catname").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#catnameUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByCustomerName=function(){"none"===$("#cusname").css("display")?(t.expenseList.sort(function(e,t){return e.customer.displayName.localeCompare(t.customer.displayName)}),$("#cusname").css({display:"inline-table"}),$("#cusnameUp").css({display:"none"})):(t.expenseList.sort(function(e,t){return t.customer.displayName.localeCompare(e.customer.displayName)}),$("#cusnameUp").css({display:"inline-table"}),$("#cusname").css({display:"none"})),$("#date").css({display:"none"}),$("#catname").css({display:"none"}),$("#refno").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#catnameUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByStatus=function(){"none"===$("#status").css("display")?(t.expenseList.sort(function(e,t){return e.entity.status.localeCompare(t.entity.status)}),$("#status").css({display:"inline-table"}),$("#statusUp").css({display:"none"})):(t.expenseList.sort(function(e,t){return t.entity.status.localeCompare(e.entity.status)}),$("#statusUp").css({display:"inline-table"}),$("#status").css({display:"none"})),$("#date").css({display:"none"}),$("#catname").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#catnameUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByAmount=function(){t.expenseList.sort(function(e,t){return t.entity.get("amount")-e.entity.get("amount")}),"none"===$("#amount").css("display")?(t.expenseList.sort(function(e,t){return t.entity.get("amount")-e.entity.get("amount")}),$("#amount").css({display:"inline-table"}),$("#amountUp").css({display:"none"})):(t.expenseList.sort(function(e,t){return e.entity.get("amount")-t.entity.get("amount")}),$("#amountUp").css({display:"inline-table"}),$("#amount").css({display:"none"})),$("#date").css({display:"none"}),$("#catname").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#catnameUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"})},t.deleteExpense=function(){t.expense&&(showLoader(),t.expense.entity.destroy().then(function(){hideLoader(),n.go("dashboard.expenses.all")}))},t.showMenu=function(){$(".filtermenu").hasClass("show")?$(".filtermenu").removeClass("show"):$(".filtermenu").addClass("show")},t.billableExpenses=function(){t.expenseList=t.allExpenses.filter(function(e){return"Billable"==e.entity.status}),t.displayedExpenses=t.expenseList,t.currentExpenses="Billable Expenses",$(".filtermenu").removeClass("show")},t.nonBillableExpenses=function(){t.expenseList=t.allExpenses.filter(function(e){return"Non-Billable"==e.entity.status}),t.displayedExpenses=t.expenseList,t.currentExpenses="Non-Billable Expenses",$(".filtermenu").removeClass("show")},t.invoicedExpenses=function(){t.expenseList=t.allExpenses.filter(function(e){return"Invoiced"==e.entity.status}),t.displayedExpenses=t.expenseList,t.currentExpenses="Invoiced Expenses",$(".filtermenu").removeClass("show")},t.showAllExpenses=function(){t.expenseList=t.allExpenses.filter(function(e){return!0}),t.displayedExpenses=t.expenseList,t.currentExpenses="All Expenses",$(".filtermenu").removeClass("show")},t.saveNewExpense=function(){if($("#addExpenseForm").valid()){showLoader();var e={userID:h,organization:y,tax:t.selectedTax,amount:t.amount,referenceNumber:t.refNumber,category:t.selectedCategory.entity.name,expanseDate:t.todayDate,notes:t.notes,status:t.expenseType.selectedType.value,currency:"USD - US Dollar"};t.selectedCustomer&&(e.customer=t.selectedCustomer.entity),e.billable="Billable"==e.status?"Yes":"No",i.createNewExpense(e,t.userRole,t.files).then(function(e){hideLoader(),console.log(e),n.go("dashboard.expenses.all")},function(e){hideLoader(),console.log(e.message)})}else{var s=$("#addExpenseForm").validate(),a=$(s.errorList[0].element).offset().top-30;scrollToOffset(a)}},t.saveEditedExpense=function(){if($("#editExpenseForm").valid()){showLoader();var e=t.expense;e.set("tax",t.selectedTax),e.set("amount",t.amount),e.set("referenceNumber",t.refNumber),e.set("category",t.selectedCategory.entity.name),e.set("expanseDate",t.todayDate),e.set("notes",t.notes),e.set("status",t.expenseType.selectedType.value),t.selectedCustomer?e.set("customer",t.selectedCustomer.entity):e.unset("customer"),"Billable"==t.expenseType.selectedType.value?e.set("billable","Yes"):e.set("billable","No"),i.updateExpense(e,t.files).then(function(e){console.log(e),hideLoader(),n.go("dashboard.expenses.all")},function(e){hideLoader(),console.log(e.message)})}else{var s=$("#editExpenseForm").validate(),a=$(s.errorList[0].element).offset().top-30;scrollToOffset(a)}},t.cancel=function(){n.go("dashboard.expenses.all")},t.addNewFile=function(e){var n=e.files[0];n.fileName=n.name,n.fileName1=n.fileName.substring(n.fileName.indexOf("_")+1,n.fileName.length),t.files.push(n),t.$$phase||t.$apply()},t.removeFile=function(e){t.files.splice(e,1)},t.customerSelected=function(){g.newExpense(n.current.name)&&t.selectedCustomer.dummy?n.go("dashboard.customers.new",{backLink:n.current.name}):g.edit(n.current.name)&&t.selectedCustomer.dummy?n.go("dashboard.customers.new",{backLink:n.current.name,expenseId:n.params.expenseId}):t.selectedCustomer||(t.expenseType.selectedType=t.expenseType.types[0])},t.openDatePicker=function(e){switch(e){case 1:t.openPicker1=!0}},t.addAttachment=function(s){var a=s.files[0];if(a){showLoader();var i=t.expense.entity,o=new Parse.File(a.name,a);e.when(o.save()).then(function(e){var t=i.get("expenseFiles");return t?t.push(e):t=[e],i.set("expenseFiles",t),i.save()}).then(function(e){n.reload(),hideLoader()})}},t.search=function(){t.searchText.length?t.expenseList=t.displayedExpenses.filter(function(e){return e.entity.referenceNumber||(e.entity.referenceNumber=""),e.expenseDate||(e.expenseDate=""),e.entity.category||(e.entity.category=""),e.entity.referenceNumber||(e.entity.referenceNumber=""),e.customer||(e.customer=""),e.entity.status||(e.entity.status=""),e.amount||(e.amount=""),e.customer?e.expenseDate.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.category.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.referenceNumber.toString().toLowerCase().includes(t.searchText.toLowerCase())||e.customer.displayName.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.status.toLowerCase().includes(t.searchText.toLowerCase())||e.amount.toLowerCase().includes(t.searchText.toLowerCase()):e.expenseDate.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.category.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.referenceNumber.toString().toLowerCase().includes(t.searchText.toLowerCase())||e.entity.status.toLowerCase().includes(t.searchText.toLowerCase())||e.amount.toLowerCase().includes(t.searchText.toLowerCase())}):t.expenseList=t.displayedExpenses}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CloneProjectController",["$scope","$state","$controller","$q","userFactory","projectService","coreFactory","taxService","commentFactory","taskFactory","currencyFilter","projectUserFactory","appFields","$uibModal",function(e,t,n,s,a,i,o,r,c,l,d,u,m,p,f,h,y,g,v,b){function x(){var n=t.params.projectId;n&&(showLoader(),s.when(I()).then(function(e){return s.when(i.getProject(n))}).then(function(t){return console.log(t),e.project=t,e.project.entity=t.entity.clone(),e.selectedCustomer=e.customers.filter(function(e){return t.entity.get("customer").id==e.entity.id})[0],s.when(D())}).then(function(){C()},function(e){hideLoader(),console.log(e.message)}))}function C(){var t=e.project;e.projectName=t.entity.get("projectName"),e.projectDescription=t.entity.get("projectDescription")||"",e.billingMethod=t.entity.get("billingMethod"),e.projectBillingHours=t.entity.get("projectBillingHours")||0,e.projectBillingAmount=t.entity.get("projectBillingAmount")||0,t.entity.get("hasBudget")?e.hasBudget=1:e.hasBudget=0,e.budgetType=t.entity.get("budgetType"),e.projectBudgetCost=t.entity.get("projectBudgetCost")||0,e.projectBudgetHours=t.entity.get("projectBudgetHours")||0,e.tasks=t.tasks,e.staffUsers=t.users,e.timesheets=[],t.timesheets.forEach(function(t){var n=e.dateFormat.toUpperCase().replace(/E/g,"d");t.date=formatDate(t.attributes.date,n),e.timesheets.push(t);var s=t.get("hoursSpent"),a=t.get("minutesSpent");s=s<10?"0"+s:""+s,a=a<10?"0"+a:""+a,t.hours=s,t.minutes=a}),e.timesheetTasks=[],t.tasks.forEach(function(t){e.timesheetTasks.push(t)}),e.timesheetTasks.push(createTaskOpener),e.timesheetDate=new Date,hideLoader()}function w(){var t=e.project.entity;t.set("customer",e.selectedCustomer.entity),t.set("projectName",e.projectName),t.set("projectDescription",e.projectDescription),t.set("billingMethod",e.billingMethod),t.set("projectBillingHours",e.projectBillingHours),t.set("projectBillingAmount",e.projectBillingAmount);var n=[];return e.tasks.forEach(function(e){e.entity?n.push(e.entity):n.push(e)}),t.set("tasks",angular.copy(n)),1==e.hasBudget?(t.set("hasBudget",!0),t.set("budgetType",e.budgetType),t.set("projectBudgetCost",e.projectBudgetCost),t.set("projectBudgetHours",e.projectBudgetHours)):t.set("hasBudget",!1),i.updateProject(e.project,g,e.userRole,e.timesheets,e.staffUsers).then(function(e){return e})}function T(){$("#editProjectForm").validate().showErrors({projectName:"Project with this name already exists"})}function D(){}function N(){p.open({animation:!0,templateUrl:"modal-user",controller:"NewUserController",backdrop:!0,appendTo:angular.element(document.querySelector("#view")),windowTemplateUrl:"modal-window",resolve:{user:function(){var e=new(Parse.Object.extend(Parse.User));return setObjectOperations({object:e,fields:m.user}),e},method:function(){return"create"},title:function(){return"Add User"}}}).result.then(function(t){setObjectOperations({object:t,fields:m.user});u.createNew({emailID:t.email,role:t.role,userName:t.username,country:t.country,title:t.fullName,organization:t.selectedOrganization,companyName:t.company,userID:a.entity[0],status:"Activated"}).then(function(t){e.$apply(function(){e.users.pop(),e.users.push(t),e.users.push(createUserOpener),e.fromTimesheet?e.timesheetUser=t:e.newUser=t,e.fromTimesheet=!1})},function(e){console.log(e.message)})},function(){console.log("Dismiss modal")})}function I(){var t=[],n=null;return n=s.when(o.getAllCustomers()).then(function(t){e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)})}),t.push(n),n=s.when(u.getAll()).then(function(t,n){e.users=t.map(function(e){return setObjectOperations({object:e,fields:m.projectUser}),e}),e.users.push(createUserOpener)}),t.push(n),n=s.when(o.getUserRole(g)).then(function(t){e.userRole=t}),t.push(n),s.all(t)}if(a.entity.length){var L=(g=a.entity[0]).get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),$("#editProjectForm").validate({rules:{customer:"required",projectName:"required",billingMethod:"required",projectBillingHours:"required",projectBillingAmount:"required",budgetType:"required",projectBudgetCost:"required",projectBudgetHours:"required"},messages:{customer:"Please select a customer",projectName:"Please enter project name",billingMethod:"Please select a billing method",projectBillingHours:"Please enter Rate/Hour",projectBillingAmount:"Please enter Project Cost",budgetType:"Please select budget type",projectBudgetCost:"Please enter amount",projectBudgetHours:"Please enter hours"}}),$("#addTimesheetForm").validate({rules:{timesheetDate:"required",timesheetHours:"required",timesheetMinutes:"required",timesheetUser:"required",timesheetTask:"required"},messages:{timesheetDate:"Please select a date",timesheetHours:"Please enter hours",timesheetMinutes:"Please enter minutes",timesheetUser:"Please select user",timesheetTask:"Please select task"}}),$("#editTimesheetForm").validate({rules:{editTimesheetDate:"required",editTimesheetHours:"required",editTimesheetMinutes:"required",editTimesheetUser:"required",editTimesheetTask:"required"},messages:{editTimesheetDate:"Please select a date",editTimesheetHours:"Please enter hours",editTimesheetMinutes:"Please enter minutes",editTimesheetUser:"Please select user",editTimesheetTask:"Please select task"}}),$("#addTaskForm").validate({rules:{newTaskName:"required"},messages:{newTaskName:"Please enter task name"}}),$("#editTaskForm").validate({rules:{editTaskName:"required"},messages:{editTaskName:"Please enter task name"}}),$("#addUserForm").validate({rules:{newUser:"required"},messages:{newTaskName:"Please select a user"}}),showLoader(),a.getField("dateFormat").then(function(t){e.dateFormat=t,x()}),e.dateOptions={showWeeks:!1},e.editTask=function(t){e.selectedTaskIndex=t,e.tasks[t].entity?(e.editTaskName=e.tasks[t].entity.taskName,e.editTaskDescription=e.tasks[t].entity.taskDescription,e.editTaskCost=e.tasks[t].entity.taskCost):(e.editTaskName=e.tasks[t].attributes.taskName,e.editTaskDescription=e.tasks[t].attributes.taskDescription,e.editTaskCost=e.tasks[t].attributes.taskCost),$(".edit-task").addClass("show")},e.updateTask=function(){if($("#editTaskForm").valid()){var t=e.selectedTaskIndex;showLoader(),e.tasks[t].entity?(e.tasks[t].entity.taskName=e.editTaskName,e.tasks[t].entity.taskDescription=e.editTaskDescription,e.tasks[t].entity.taskCost=e.editTaskCost,e.tasks[t].entity.save().then(function(e){$(".edit-task").removeClass("show"),hideLoader()})):(e.tasks[t].attributes.taskName=e.editTaskName,e.tasks[t].attributes.taskDescription=e.editTaskDescription,e.tasks[t].attributes.taskCost=e.editTaskCost,e.tasks[t].save().then(function(e){$(".edit-task").removeClass("show"),hideLoader()}))}},e.editTimesheet=function(t){e.selectedTimesheetIndex=t,e.selectedTimesheetList=e.timesheets[t],e.editTimesheetTask=new l(e.timesheets[t].attributes.task),setObjectOperations({object:e.timesheets[t].attributes.user,fields:m.projectUser}),e.staffUsers.forEach(function(n){n.user.userName==e.timesheets[t].attributes.user.userName&&(e.timesheetUser=n)});var n=e.dateFormat.toUpperCase().replace(/E/g,"d");e.editTimesheetDate=formatDate(e.timesheets[t].date,n),e.editTimesheetDescription=e.timesheets[t].attributes.notes,e.editTimesheetHours=parseInt(e.timesheets[t].hours),e.editTimesheetMinutes=parseInt(e.timesheets[t].minutes),$(".edit-timesheet").addClass("show")},e.updateTimesheet=function(){var t=e.selectedTimesheetIndex;showLoader(),e.timesheets[t].set("date",e.timesheetDate),e.timesheets[t].set("task",e.editTimesheetTask.entity),e.timesheets[t].set("user",e.timesheetUser);var n=new Date;n.subtractHours(e.editTimesheetHours),n.subtractMinutes(e.editTimesheetMinutes);var s=n,a=e.editTimesheetHours<10?"0"+e.editTimesheetHours:""+e.editTimesheetHours,i=e.editTimesheetMinutes<10?"0"+e.editTimesheetMinutes:""+e.editTimesheetMinutes;e.timesheets[t].set("timeSpent",s),e.timesheets[t].hours=a,e.timesheets[t].minutes=i,e.timesheets[t].set("notes",e.timesheetDescription),e.timesheets[t].save().then(function(e){$(".edit-timesheet").removeClass("show"),hideLoader()})},e.addTimesheet=function(){$(".new-timesheet").addClass("show")},e.saveTimesheet=function(){if($("#addTimesheetForm").valid()){var t=e.dateFormat.toUpperCase().replace(/E/g,"d"),n=void 0;n=e.timesheetTask.entity?e.timesheetTask.entity:e.timesheetTask;var s=new Date;s.subtractHours(e.timesheetHours),s.subtractMinutes(e.timesheetMinutes),e.timesheets.push({user:e.timesheetUser.attributes.chosenUser||e.timesheetUser,task:n,date:formatDate(e.timesheetDate,t),sheetDate:e.timesheetDate,notes:e.timesheetDescription,timeSpent:s,hours:e.timesheetHours<10?"0"+e.timesheetHours:""+e.timesheetHours,minutes:e.timesheetMinutes<10?"0"+e.timesheetMinutes:""+e.timesheetMinutes,hoursSpent:e.timesheetHours,minutesSpent:e.timesheetMinutes}),e.timesheetUser="",e.timesheetTask="",e.timesheetDate=new Date,e.timesheetDescription="",$(".new-timesheet").removeClass("show")}},e.removeTimesheet=function(t){e.timesheets.splice(t,1)},e.removeTask=function(t){e.tasks.splice(t,1),e.timesheetTasks.splice(t,1),e.timesheetTask="",e.$$phase||e.$apply()},e.addTask=function(){$(".new-task").addClass("show"),e.fromTimesheet=!1},e.taskChanged=function(){e.timesheetTask.dummy&&(e.fromTimesheet=!0,e.timesheetTask="",$(".new-task").addClass("show"))},e.addNewTask=function(){if($("#addTaskForm").valid()){showLoader();var t=new Parse.ACL;t.setPublicReadAccess(!0),t.setPublicWriteAccess(!0);var n=new(Parse.Object.extend("Task"));return n.set("userID",g),n.set("organization",L),n.setACL(t),n.set("taskName",e.newTaskName),n.set("taskDescription",e.newTaskDescription),n.set("taskCost",e.newTaskCost),n.save().then(function(t){t=new l(t),e.tasks.push(t),e.timesheetTasks.pop(),e.timesheetTasks.push(t),e.timesheetTasks.push(createTaskOpener),e.fromTimesheet&&(e.timesheetTask=t),$(".new-task").removeClass("show"),e.newTaskName="",e.newTaskDescription="",e.newTaskCost="",e.$$phase||e.$apply(),hideLoader()})}},e.addNewUser=function(){$("#addUserForm").valid()&&(e.staffUsers.push({user:e.newUser,staffHours:e.staffHours}),$(".add-user").removeClass("show"))},e.removeUser=function(t){e.staffUsers.splice(t,1)},e.addUser=function(){$(".add-user").addClass("show")},e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0;break;case 2:e.openPicker2=!0}},e.saveProject=function(){$("#editProjectForm").valid()&&(showLoader(),s.when(i.checkProjectNameAvailable({projectName:e.projectName,organization:L})).then(function(e){if(!e)return hideLoader(),T(),scrollToOffset(),Promise.reject("Project with this name already exists");w().then(function(e){hideLoader(),console.log(e),t.go("dashboard.projects.details",{projectId:e.id})},function(e){hideLoader(),console.log(e.message)})}))},e.cancel=function(){t.go("dashboard.projects.all")},e.userChanged=function(){if(e.newUser.dummy)return e.fromTimesheet=!1,N(),void(e.newUser="")},e.timesheetUserChanged=function(){if(e.timesheetUser.dummy)return e.fromTimesheet=!0,N(),void(e.newUser="")},e.customerChanged=function(){}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CreateProjectController",["$scope","$state","$controller","$q","userFactory","projectService","coreFactory","taxService","commentFactory","currencyFilter","projectUserFactory","appFields","$uibModal",function(e,t,n,s,a,i,o,r,c,l,d,u,m,p,f,h,y,g,v){function b(){e.projectUsers=[],e.tasks=[],e.timesheetTasks=[],e.timesheetTasks.push(createTaskOpener),e.timesheets=[],e.timesheetDate=new Date,e.hasBudget=0;for(var n=t.params.customerId,s=0;s<e.users.length;++s){var a=y.get("username");e.users[s].userName==a&&(e.projectUsers.push({user:e.users[s]}),e.users.splice(s,1))}n&&(e.selectedCustomer=e.customers.filter(function(e){return e.entity.id==n})[0],x()),hideLoader()}function x(){e.selectedCustomer.dummy&&t.go("dashboard.customers.new",{backLink:t.current.name})}function C(){m.open({animation:!0,templateUrl:"modal-user",controller:"NewUserController",backdrop:!0,appendTo:angular.element(document.querySelector("#view")),windowTemplateUrl:"modal-window",resolve:{user:function(){var e=new(Parse.Object.extend(Parse.User));return setObjectOperations({object:e,fields:u.user}),e},method:function(){return"create"},title:function(){return"Add User"}}}).result.then(function(t){setObjectOperations({object:t,fields:u.user});d.createNew({emailID:t.email,role:t.role,userName:t.username,country:t.country,title:t.fullName,organization:t.selectedOrganization,companyName:t.company,userID:a.entity[0],status:"Activated"}).then(function(t){e.$apply(function(){e.users.pop(),e.users.push(t),e.users.push(createUserOpener),e.newUser=t})},function(e){console.log(e.message)})},function(){console.log("Dismiss modal")})}function w(){$("#addProjectForm").validate().showErrors({projectName:"Project with this name already exists"})}if(a.entity.length){var T=(y=a.entity[0]).get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),function(){showLoader();var t=[],n=null;n=s.when(o.getAllCustomers()).then(function(t){t=t.filter(function(e){return"active"==e.entity.status}),e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),e.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),e.customers.push(createCustomerOpener)}),t.push(n),n=s.when(d.getAll()).then(function(t,n){e.users=t.map(function(e){return setObjectOperations({object:e,fields:u.projectUser}),e}),e.users.push(createUserOpener)}),t.push(n),n=s.when(o.getUserRole(y)).then(function(t){e.userRole=t}),t.push(n),n=a.getField("dateFormat").then(function(t){e.dateFormat=t}),t.push(n),s.all(t).then(function(){b()},function(e){hideLoader(),console.log(e.message)})}(),$("#addProjectForm").validate({rules:{customer:"required",projectName:"required",billingMethod:"required",projectBillingHours:"required",projectBillingAmount:"required",budgetType:"required",projectBudgetCost:"required",projectBudgetHours:"required"},messages:{customer:"Please select a customer",projectName:"Please enter project name",billingMethod:"Please select a billing method",projectBillingHours:"Please enter Rate/Hour",projectBillingAmount:"Please enter Project Cost",budgetType:"Please select budget type",projectBudgetCost:"Please enter amount",projectBudgetHours:"Please enter hours"}}),$("#addTimesheetForm").validate({rules:{timesheetDate:"required",timesheetHours:{required:!0,digits:!0,min:0},timesheetMinutes:{required:!0,digits:!0,min:0,max:59},timesheetUser:"required",timeSheetTask:"required"},messages:{timesheetDate:"Please select a date",timesheetHours:{required:"Please enter hours",digits:"Enter valid hours",min:"Please enter valid hours"},timesheetMinutes:{required:"Please enter minutes",digits:"Enter valid minutes",min:"Please enter valid minutes",max:"Minutes must be less than 60"},timesheetUser:"Please select user",timeSheetTask:"Please select task"}}),$("#addTaskForm").validate({rules:{newTaskName:"required"},messages:{newTaskName:"Please enter task name"}}),$("#addUserForm").validate({rules:{newUser:"required"},messages:{newTaskName:"Please select a user"}}),e.dateOptions={showWeeks:!1},e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0}},e.removeTimesheet=function(t){e.timesheets.splice(t,1)},e.customerChanged=x,e.timeSheetUserChanged=function(){if(e.timesheetUser.dummy)return C(),void(e.timesheetUser="")},e.userChanged=function(){if(e.newUser.dummy)return C(),void(e.newUser="")},e.prepareToEditUser=function(t){e.userIndex=t,e.editUser=e.projectUsers[e.userIndex].user,e.editStaffHours=e.projectUsers[e.userIndex].staffHours,e.editusers=[],angular.copy(e.users,e.editusers),e.editusers.pop(),e.editusers.push(e.editUser),e.editusers.push(createUserOpener),$(".edit-user").addClass("show")},e.updateUser=function(){e.projectUsers[e.userIndex].user=e.editUser,e.projectUsers[e.userIndex].staffHours=e.editStaffHours,$(".edit-user").removeClass("show")},e.saveTimesheet=function(){if($("#addTimesheetForm").valid()){var t=new Date;t.subtractHours(e.timesheetHours),t.subtractMinutes(e.timesheetMinutes);var n=e.timesheetTask.get("taskHours")||0;e.timesheetTask.set("taskHours",e.timesheetHours+e.timesheetMinutes/60+n),e.timesheetTask.save().then(function(e){}),e.timesheets.push({user:e.timesheetUser.user,task:e.timesheetTask,date:e.timesheetDate,notes:e.timesheetDescription,timeSpent:t,hours:e.timesheetHours<10?"0"+e.timesheetHours:""+e.timesheetHours,minutes:e.timesheetMinutes<10?"0"+e.timesheetMinutes:""+e.timesheetMinutes,hoursSpent:e.timesheetHours,minutesSpent:e.timesheetMinutes}),e.timesheetUser="",e.timesheetTask="",e.timesheetDate=new Date,e.timesheetDescription="",e.timesheetHours=void 0,e.timesheetMinutes=void 0,$(".new-timesheet").removeClass("show")}},e.$watch("hasBudget",function(t){0==t&&(e.budgetType="")}),e.saveProject=function(){$("#addProjectForm").valid()&&(showLoader(),s.when(i.checkProjectNameAvailable({projectName:e.projectName,organization:T})).then(function(n){if(n){var s=!1;1==e.hasBudget&&(s=!0);var a={userID:y,organization:T,customer:e.selectedCustomer.entity,projectName:e.projectName,projectDescription:e.projectDescription,billingMethod:e.billingMethod,hasBudget:s,projectBillingAmount:e.projectBillingAmount,projectBillingHours:e.projectBillingHours,budgetType:e.budgetType,projectBudgetCost:e.projectBudgetCost,projectBudgetHours:e.projectBudgetHours,tasks:e.tasks};return i.createNewProject(a,e.userRole,e.projectUsers,e.timesheets).then(function(e){hideLoader(),t.go("dashboard.projects.all")})}return hideLoader(),w(),scrollToOffset(),Promise.reject("Project with this name already exists")}))},e.cancel=function(){t.go("dashboard.projects.all")},e.addTask=function(){$(".new-task").addClass("show"),e.fromTimesheet=!1},e.addNewTask=function(){if($("#addTaskForm").valid()){showLoader();var t=new Parse.ACL;t.setPublicReadAccess(!0),t.setPublicWriteAccess(!0);var n=new(Parse.Object.extend("Task"));return n.set("userID",y),n.set("organization",T),n.setACL(t),n.set("taskName",e.newTaskName),n.set("taskDescription",e.newTaskDescription),e.newTaskCost&&n.set("taskCost",e.newTaskCost),n.save().then(function(t){e.tasks.push(t),e.timesheetTasks.pop(),e.timesheetTasks.push(t),e.timesheetTasks.push(createTaskOpener),e.fromTimesheet&&(e.timesheetTask=t),$(".new-task").removeClass("show"),e.newTaskName="",e.newTaskDescription="",e.newTaskCost="",e.$$phase||e.$apply(),hideLoader()},function(e){console.log(e)})}},e.taskChanged=function(){e.timesheetTask.dummy&&(e.fromTimesheet=!0,e.timesheetTask="",$(".new-task").addClass("show"))},e.addTimesheet=function(){$(".new-timesheet").addClass("show")},e.addNewUser=function(){$("#addUserForm").valid()&&(e.projectUsers.push({user:e.newUser,staffHours:e.staffHours}),e.users=e.users.filter(function(t){return t!==e.newUser}),$(".add-user").removeClass("show"))},e.removeUser=function(t){e.users.pop(),e.users.push(e.projectUsers[t].user),e.users.push(createUserOpener),e.projectUsers.splice(t,1)},e.removeTask=function(t){e.tasks.splice(t,1),e.timesheetTasks.splice(t,1),e.timesheetTask="",e.$$phase||e.$apply()},e.addUser=function(){$(".add-user").addClass("show")}}else console.log("User not logged in")}]),invoicesUnlimited.controller("ProjectDetailController",["$q","$scope","$state","$sce","$controller","userFactory","projectService","coreFactory","projectUserFactory","commentFactory","currencyFilter","appFields",function(e,t,n,s,a,i,o,r,c,l,d,u){function m(){var s=n.params.projectId;if(s){var a=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"],i=["#0ea81c","#c31e1e"],r=[0,0,0,0,0,0,0,0,0,0,0,0],c=[0,0,0,0,0,0,0,0,0,0,0,0];showLoader(),e.when(o.getProjectDetails(s)).then(function(e){t.project=e.entity,t.customer=e.entity.get("customer"),t.tasks=e.tasks,t.staff=e.users,t.actualProject=e,t.staff&&t.staff.forEach(function(e){for(var n=0;n<t.users.length;++n)if(t.users[n].id==e.user.id){t.users.splice(n,1);break}}),t.unbilledHours=0,t.billedHours=0,t.billableHours=0;var n=0,s=0,o=0,l=0,d=0,u=0;e.timesheets?(e.timesheets.forEach(function(e){var n=e.get("hoursSpent"),s=e.get("minutesSpent");t.staff&&t.staff.forEach(function(t){if(t.user.userName==e.get("user").get("userName")){if(t.loggedHours?(t.loggedHours+=n,t.loggedHours+=parseInt(Math.floor((t.loggedMinutes+s)/60)),t.loggedMinutes=(t.loggedMinutes+s)%60):(t.loggedHours=n+parseInt(Math.floor(s/60)),t.loggedMinutes=s%60,t.unbilledHours=0,t.unbilledMinutes=0,t.unbilledTime="00:00"),!e.get("isBilled")){t.unbilledHours+=n,t.unbilledHours+=parseInt(Math.floor((t.unbilledMinutes+s)/60)),t.unbilledMinutes=(t.unbilledMinutes+s)%60;var a=t.unbilledHours<10?"0"+t.unbilledHours:t.unbilledHours+"",i=t.unbilledMinutes<10?"0"+t.unbilledMinutes:t.unbilledMinutes+"";t.unbilledTime=p(a)+":"+i}var a=t.loggedHours<10?"0"+t.loggedHours:t.loggedHours+"",i=t.loggedMinutes<10?"0"+t.loggedMinutes:t.loggedMinutes+"";t.loggedTime=p(a)+":"+i}else t.loggedHours||(t.loggedHours=0,t.loggedMinutes=0,t.loggedTime="00:00",t.unbilledHours=0,t.unbilledMinutes=0,t.unbilledTime="00:00")}),t.tasks&&t.tasks.forEach(function(t){if(t.loggedHours||(t.loggedHours=0,t.loggedMinutes=0,t.billedHours=0,t.billedMinutes=0,t.unbilledHours=0,t.unbilledMinutes=0,t.loggedTime="00:00",t.billedTime="00:00",t.unbilledTime="00:00"),t.entity.id==e.get("task").id){t.loggedHours+=n,t.loggedHours+=parseInt(Math.floor((t.loggedMinutes+s)/60)),t.loggedMinutes=(t.loggedMinutes+s)%60;var a=t.loggedHours<10?"0"+t.loggedHours:t.loggedHours+"",i=t.loggedMinutes<10?"0"+t.loggedMinutes:t.loggedMinutes+"";t.loggedTime=p(a)+":"+i,e.get("isBilled")?(t.billedHours+=n,t.billedHours+=parseInt(Math.floor((t.billedMinutes+s)/60)),t.billedMinutes=(t.billedMinutes+s)%60,a=t.billedHours<10?"0"+t.billedHours:t.billedHours+"",i=t.billedMinutes<10?"0"+t.billedMinutes:t.billedMinutes+"",t.billedTime=p(a)+":"+i):(t.unbilledHours+=n,t.unbilledHours+=parseInt(Math.floor((t.unbilledMinutes+s)/60)),t.unbilledMinutes=(t.unbilledMinutes+s)%60,a=t.unbilledHours<10?"0"+t.unbilledHours:t.unbilledHours+"",i=t.unbilledMinutes<10?"0"+t.unbilledMinutes:t.unbilledMinutes+"",t.unbilledTime=p(a)+":"+i)}});var a=e.get("date").getMonth();r[a]+=n+parseInt(Math.floor(s/60)),e.get("isBilled")?(d+=n,u+=s):(o+=n,l+=s,c[a]+=n+parseInt(Math.floor(s/60))),n+=parseInt(Math.floor(s/60)),s%=60,n=n<10?"0"+n:""+n,s=s<10?"0"+s:""+s,e.time=p(n)+":"+s}),e.timesheets.length<1&&(t.staff&&t.staff.forEach(function(e){e.loggedHours||(e.loggedHours=0,e.loggedMinutes=0,e.loggedTime="00:00",e.unbilledHours=0,e.unbilledMinutes=0,e.unbilledTime="00:00")}),t.tasks&&t.tasks.forEach(function(e){e.loggedHours||(e.loggedHours=0,e.loggedMinutes=0,e.billedHours=0,e.billedMinutes=0,e.unbilledHours=0,e.unbilledMinutes=0,e.loggedTime="00:00",e.billedTime="00:00",e.unbilledTime="00:00")}))):(t.staff&&t.staff.forEach(function(e){e.loggedHours||(e.loggedHours=0,e.loggedMinutes=0,e.loggedTime="00:00",e.unbilledHours=0,e.unbilledMinutes=0,e.unbilledTime="00:00")}),t.tasks&&t.tasks.forEach(function(e){e.loggedHours||(e.loggedHours=0,e.loggedMinutes=0,e.billedHours=0,e.billedMinutes=0,e.unbilledHours=0,e.unbilledMinutes=0,e.loggedTime="00:00",e.billedTime="00:00",e.unbilledTime="00:00")})),n=o+d,n+=(s=l+u)/60,s%=60,n=n<10?"0"+Math.floor(n):Math.floor(n),s=s<10?"0"+Math.floor(s):Math.floor(s),t.billableHours=p(n)+":"+s,o+=l/60,l%=60,o=o<10?"0"+Math.floor(o):Math.floor(o),l=l<10?"0"+Math.floor(l):Math.floor(l),t.unbilledHours=p(o)+":"+l,d+=u/60,u%=60,d=d<10?"0"+Math.floor(d):Math.floor(d),u=u<10?"0"+Math.floor(u):Math.floor(u),t.billedHours=p(d)+":"+u,t.timesheets=e.timesheets,"Based on task hours"!=t.project.billingMethod&&$(".task").addClass("tasks-detail"),f(a,r,c,i),hideLoader()})}}function p(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function f(e,t,n,s){var a=v.get("fiscalYearStart"),i=getrotateCount(a);e.rotate(i),t.rotate(i),n.rotate(i);var o=$("#projectchart");new Chart(o,{type:"bar",data:{labels:e,datasets:[{label:"Billable Hours",backgroundColor:s[0],data:t},{label:"Unbilled Hours",backgroundColor:s[1],data:n}]},options:{responsive:!1,tooltipTemplate:"<%if (labels){%><%=labels%>:: <%}%><%= value %>",tooltips:{mode:"single",custom:function(e){e&&(e.title=[])},callbacks:{label:function(e,t){var n=t.datasets[e.datasetIndex].data[e.index];t.labels[e.index];return[e.xLabel+": "+p(parseFloat(n).toFixed(0))]}}},legend:{display:!0,position:"bottom"},scales:{yAxes:[{ticks:{beginAtZero:!0,userCallback:function(e,t,n){return p(e.toFixed(2))}}}]}}})}function h(e,s){Parse.Promise.as([]);var a=[],i=new(Parse.Object.extend("Staff"));return i.set("userID",s.user),i.set("organization",s.organization),i.setACL(s.acl),i.set("chosenUser",e),i.set("staffHours",t.staffHours),a.push(i),Parse.Object.saveAll(a).then(function(e){var s=t.project.get("users");s?t.project.set("users",e.concat(s)):t.project.set("users",e),t.project.save().then(function(e){$(".add-user").removeClass("show"),hideLoader(),n.reload()})})}function y(e,s){s.timesheets=[],Parse.Promise.as([]);var a=[],i=new(Parse.Object.extend("Timesheets"));return i.set("userID",s.user),i.set("organization",s.organization),i.setACL(s.acl),i.set("user",e.user),i.set("task",e.task),i.set("date",e.date),i.set("notes",e.notes),i.set("hoursSpent",e.hoursSpent),i.set("minutesSpent",e.minutesSpent),a.push(i),Parse.Object.saveAll(a).then(function(s){(a=t.project.get("timeSheets"))?t.project.set("timeSheets",s.concat(a)):t.project.set("timeSheets",s);var a=e.task.get("taskHours")||0;e.task.set("taskHours",t.timesheetHours+t.timesheetMinutes/60+a),e.task.save().then(function(e){t.project.save().then(function(e){$(".new-timesheet").removeClass("show"),hideLoader(),n.reload()})})})}if(i.entity.length){var g=i.entity[0],v=g.get("organizations")[0];a("DashboardController",{$scope:t,$state:n}),r.getUserRole(g).then(function(e){t.userRole=e}),i.getField("dateFormat").then(function(e){t.dateFormat=e}),c.getAll().then(function(e){t.users=e.map(function(e){return setObjectOperations({object:e,fields:u.projectUser}),e}),m()}),$("#addTaskForm").validate({rules:{newTaskName:"required"},messages:{newTaskName:"Please enter task name"}}),$("#addUserForm").validate({rules:{newUser:"required"},messages:{newUser:"Please select a user"}}),$("#addTimesheetForm").validate({rules:{timesheetDate:"required",timesheetHours:{required:!0,digits:!0,min:0},timesheetMinutes:{required:!0,digits:!0,min:0,max:59},timesheetUser:"required",timeSheetTask:"required"},messages:{timesheetDate:"Please select a date",timesheetHours:{required:"Please enter hours",digits:"Enter valid hours",min:"Please enter valid hours"},timesheetMinutes:{required:"Please enter minutes",digits:"Enter valid minutes",min:"Please enter valid minutes",max:"Minutes must be less than 60"},timesheetUser:"Please select user",timeSheetTask:"Please select task"}}),t.dateOptions={showWeeks:!1},t.deleteProjectClicked=function(){$(".confirmation-pop-up").addClass("show")},t.deleteProject=function(){var s=[],a=[];t.staff&&t.staff.forEach(function(e){s.push(e.entity)}),t.tasks&&t.tasks.forEach(function(e){a.push(e.entity)});t.timesheets;var i,o=[];i=e.when(Parse.Object.destroyAll(s)).then(function(){}),o.push(i),i=e.when(Parse.Object.destroyAll(a)).then(function(){}),o.push(i),showLoader(),e.all(o).then(function(){t.project.destroy().then(function(){hideLoader(),n.go("dashboard.projects.all")})})},t.prepareToAddTask=function(){$("#addTaskForm")[0].reset()},t.prepareToAddTimesheet=function(){t.timesheetDate=new Date},t.addNewTask=function(){if($("#addTaskForm").valid()){showLoader();var e=new Parse.ACL;e.setPublicReadAccess(!0),e.setPublicWriteAccess(!0);var n=new(Parse.Object.extend("Task"));return n.set("userID",g),n.set("organization",v),n.setACL(e),n.set("taskName",t.newTaskName),n.set("taskDescription",t.newTaskDescription),n.set("taskCost",t.newTaskCost),n.save().then(function(e){var n=t.project.get("tasks");n?n.push(e):(n=[]).push(e),t.project.set("tasks",n),t.project.save().then(function(e){$(".new-task").removeClass("show"),hideLoader(),window.location.reload()})})}},t.addNewUser=function(){if($("#addUserForm").valid()){showLoader();var e=new Parse.ACL;e.setPublicReadAccess(!0),e.setPublicWriteAccess(!0);var n={user:g,organization:t.project.get("organization"),acl:e};h(t.newUser,n)}},t.openDatePicker=function(e){switch(e){case 1:t.openPicker1=!0;break;case 2:t.openPicker2=!0}},t.addToInvoice=function(){t.invoiceDate=new Date,t.dataOnInvoice="1",t.itemName="1",$(".convert-invoice").addClass("show")},t.SavetoInvoice=function(){var e={invoiceDueDate:t.invoiceDate,dataOnInvoice:t.dataOnInvoice,itemNameToShow:t.itemName,project:t.actualProject};n.go("dashboard.sales.invoices.new",{projectId:e})},t.saveTimesheet=function(){if($("#addTimesheetForm").valid()){showLoader();var e=new Parse.ACL;e.setPublicReadAccess(!0),e.setPublicWriteAccess(!0);var n={user:g,organization:t.project.get("organization"),acl:e},s=new Date;s.subtractHours(t.timesheetHours),s.subtractMinutes(t.timesheetMinutes),y({user:t.timesheetUser.user,task:t.timesheetTask.entity,date:t.timesheetDate,notes:t.timesheetDescription,timeSpent:s,hours:t.timesheetHours<10?"0"+t.timesheetHours:""+t.timesheetHours,minutes:t.timesheetMinutes<10?"0"+t.timesheetMinutes:""+t.timesheetMinutes,hoursSpent:t.timesheetHours,minutesSpent:t.timesheetMinutes},n),t.timesheetUser="",t.timesheetHours=void 0,t.timesheetMinutes=void 0,t.timesheetTask="",t.timesheetDate=new Date,t.timesheetDescription=""}}}else console.log("User not logged in")}]),invoicesUnlimited.controller("ProjectsController",["$q","$scope","$state","$controller","userFactory","projectService","coreFactory","taxService","expenseService","commentFactory","taskFactory","currencyFilter","projectUserFactory","appFields","$uibModal",function(e,t,n,s,a,i,o,r,c,l,d,u,m,p,f,h,y,g,v,b,x){function C(e){e||(e=n.current.name),F.projects(e)?(console.log("its in list"),w()):F.newProject(e)?console.log("its in new"):F.edit(e)&&(console.log("its in edit"),T())}function w(){showLoader(),e.when(i.listProjects(v)).then(function(e){t.projectList=[],t.displayedProject=[],e.forEach(function(e){e.entity.projectBillingAmount||(e.entity.projectBillingAmount=0)}),"General Employee"==v.get("role")?e.forEach(function(e){var n=e.entity.get("users");if(n)for(var s=0;s<n.length;++s)if(n[s].get("chosenUser").get("userName")==v.get("username")){t.projectList.push(e),t.displayedProject.push(e);break}}):(t.projectList=e,t.displayedProject=e),t.sortByLatest(),hideLoader()},function(e){hideLoader(),console.log(e.message)})}function T(){var s=n.params.projectId;s&&(showLoader(),e.when(P()).then(function(t){return e.when(i.getProject(s))}).then(function(n){return console.log(n),t.project=n,t.selectedCustomer=t.customers.filter(function(e){return n.entity.get("customer").id==e.entity.id})[0],e.when(I())}).then(function(){D()},function(e){hideLoader(),console.log(e.message)}))}function D(){var e=t.project;if(t.projectName=e.entity.get("projectName"),t.projectDescription=e.entity.get("projectDescription")||"",t.billingMethod=e.entity.get("billingMethod"),t.projectBillingHours=e.entity.get("projectBillingHours")||0,t.projectBillingAmount=e.entity.get("projectBillingAmount")||0,e.entity.get("hasBudget")?t.hasBudget=1:t.hasBudget=0,t.budgetType=e.entity.get("budgetType"),t.projectBudgetCost=e.entity.get("projectBudgetCost")||0,t.projectBudgetHours=e.entity.get("projectBudgetHours")||0,t.projectUsers=[],t.tasks=e.tasks,t.staffUsers=e.users,t.staffUsers)for(var n=0;n<t.users.length;++n)for(var s=0;s<t.staffUsers.length;++s)t.users[n].userName==t.staffUsers[s].user.get("userName")&&t.users.splice(n,1);t.timesheets=[],e.timesheets&&e.timesheets.forEach(function(e){var n=t.dateFormat.toUpperCase().replace(/E/g,"d");e.date=formatDate(e.attributes.date,n),t.timesheets.push(e);var s=e.get("hoursSpent"),a=e.get("minutesSpent");s=s<10?"0"+s:""+s,a=a<10?"0"+a:""+a,e.hours=s,e.minutes=a}),t.timesheetTasks=[],e.tasks&&e.tasks.forEach(function(e){t.timesheetTasks.push(e)}),t.timesheetTasks.push(createTaskOpener),t.timesheetDate=new Date,hideLoader()}function N(){var e=t.project.entity;e.set("customer",t.selectedCustomer.entity),e.set("projectName",t.projectName),e.set("projectDescription",t.projectDescription),e.set("billingMethod",t.billingMethod),e.set("projectBillingHours",t.projectBillingHours),e.set("projectBillingAmount",t.projectBillingAmount);var n=[];return t.tasks.forEach(function(e){e.entity?n.push(e.entity):n.push(e)}),e.set("tasks",angular.copy(n)),1==t.hasBudget?(e.set("hasBudget",!0),e.set("budgetType",t.budgetType),e.set("projectBudgetCost",t.projectBudgetCost),e.set("projectBudgetHours",t.projectBudgetHours)):e.set("hasBudget",!1),i.updateProject(t.project,v,t.userRole,t.timesheets,t.staffUsers).then(function(e){return e})}function I(){}function L(){f.open({animation:!0,templateUrl:"modal-user",controller:"NewUserController",backdrop:!0,appendTo:angular.element(document.querySelector("#view")),windowTemplateUrl:"modal-window",resolve:{user:function(){var e=new(Parse.Object.extend(Parse.User));return setObjectOperations({object:e,fields:p.user}),e},method:function(){return"create"},title:function(){return"Add User"}}}).result.then(function(e){setObjectOperations({object:e,fields:p.user});m.createNew({emailID:e.email,role:e.role,userName:e.username,country:e.country,title:e.fullName,organization:e.selectedOrganization,companyName:e.company,userID:a.entity[0],status:"Activated"}).then(function(e){t.$apply(function(){t.users.pop(),t.users.push(e),t.users.push(createUserOpener),t.fromTimesheet?t.timesheetUser=e:t.newUser=e,t.fromTimesheet=!1})},function(e){console.log(e.message)})},function(){console.log("Dismiss modal")})}function P(){var n=[],s=null;return s=e.when(o.getAllCustomers()).then(function(e){t.customers=e.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),t.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName})}),n.push(s),s=e.when(m.getAll()).then(function(e,n){t.users=e.map(function(e){return setObjectOperations({object:e,fields:p.projectUser}),e}),t.users.push(createUserOpener)}),n.push(s),s=e.when(o.getUserRole(v)).then(function(e){t.userRole=e}),n.push(s),e.all(n)}if(a.entity.length){var U=(v=a.entity[0]).get("organizations")[0];s("DashboardController",{$scope:t,$state:n}),$("#editProjectForm").validate({rules:{customer:"required",projectName:"required",billingMethod:"required",projectBillingHours:"required",projectBillingAmount:"required",budgetType:"required",projectBudgetCost:"required",projectBudgetHours:"required"},messages:{customer:"Please select a customer",projectName:"Please enter project name",billingMethod:"Please select a billing method",projectBillingHours:"Please enter Rate/Hour",projectBillingAmount:"Please enter Project Cost",budgetType:"Please select budget type",projectBudgetCost:"Please enter amount",projectBudgetHours:"Please enter hours"}}),$("#addTimesheetForm").validate({rules:{timesheetDate:"required",timesheetHours:{required:!0,digits:!0,min:0},timesheetMinutes:{required:!0,digits:!0,min:0,max:59},timesheetUser:"required",timeSheetTask:"required"},messages:{timesheetDate:"Please select a date",timesheetHours:{required:"Please enter hours",digits:"Enter valid hours",min:"Please enter valid hours"},timesheetMinutes:{required:"Please enter minutes",digits:"Enter valid minutes",min:"Please enter valid minutes",max:"Minutes must be less than 60"},timesheetUser:"Please select user",timeSheetTask:"Please select task"}}),$("#editTimesheetForm").validate({rules:{editTimesheetDate:"required",editTimesheetHours:"required",editTimesheetMinutes:"required",editTimesheetUser:"required",editTimesheetTask:"required"},messages:{editTimesheetDate:"Please select a date",editTimesheetHours:"Please enter hours",editTimesheetMinutes:"Please enter minutes",editTimesheetUser:"Please select user",editTimesheetTask:"Please select task"}}),$("#addTaskForm").validate({rules:{newTaskName:"required"},messages:{newTaskName:"Please enter task name"}}),$("#editTaskForm").validate({rules:{editTaskName:"required"},messages:{editTaskName:"Please enter task name"}}),$("#addUserForm").validate({rules:{newUser:"required"},messages:{newTaskName:"Please select a user"}});var F={details:function(e){return e.endsWith("projects.details")},projects:function(e){return e.endsWith("projects.all")},edit:function(e){return e.endsWith("projects.edit")},newProject:function(e){return e.endsWith("projects.new")}};showLoader(),a.getField("dateFormat").then(function(e){t.dateFormat=e,C()}),t.dateOptions={showWeeks:!1},t.editTask=function(e){t.selectedTaskIndex=e,t.editTaskName=t.tasks[e].entity.taskName,t.editTaskDescription=t.tasks[e].entity.taskDescription,t.editTaskCost=t.tasks[e].entity.taskCost,$(".edit-task").addClass("show")},t.updateTask=function(){if($("#editTaskForm").valid()){var e=t.selectedTaskIndex;showLoader(),t.tasks[e].entity.taskName=t.editTaskName,t.tasks[e].entity.taskDescription=t.editTaskDescription,t.tasks[e].entity.taskCost=t.editTaskCost,t.tasks[e].entity.save().then(function(e){$(".edit-task").removeClass("show"),hideLoader()})}},t.editTimesheet=function(e){t.selectedTimesheetIndex=e,t.selectedTimesheetList=t.timesheets[e],t.editTimesheetTask=new d(t.timesheets[e].attributes.task),setObjectOperations({object:t.timesheets[e].attributes.user,fields:p.projectUser}),t.staffUsers.forEach(function(n){n.user.userName==t.timesheets[e].attributes.user.userName&&(t.timesheetUser=n)});var n=t.dateFormat.toUpperCase().replace(/E/g,"d");t.editTimesheetDate=formatDate(t.timesheets[e].date,n),t.editTimesheetDescription=t.timesheets[e].attributes.notes,t.editTimesheetHours=parseInt(t.timesheets[e].hours),t.editTimesheetMinutes=parseInt(t.timesheets[e].minutes),$(".edit-timesheet").addClass("show")},t.updateTimesheet=function(){var e=t.selectedTimesheetIndex;showLoader(),t.timesheets[e].set("date",t.timesheetDate),t.timesheets[e].set("task",t.editTimesheetTask.entity),t.timesheets[e].set("user",t.timesheetUser.user);var n=new Date;n.subtractHours(t.editTimesheetHours),n.subtractMinutes(t.editTimesheetMinutes);var s=t.editTimesheetHours<10?"0"+t.editTimesheetHours:""+t.editTimesheetHours,a=t.editTimesheetMinutes<10?"0"+t.editTimesheetMinutes:""+t.editTimesheetMinutes;t.timesheets[e].set("hoursSpent",t.editTimesheetHours),t.timesheets[e].set("minutesSpent",t.editTimesheetMinutes),t.timesheets[e].hours=s,t.timesheets[e].minutes=a,t.timesheets[e].set("notes",t.timesheetDescription),t.timesheets[e].save().then(function(e){$(".edit-timesheet").removeClass("show"),hideLoader()})},t.addTimesheet=function(){$(".new-timesheet").addClass("show")},t.saveTimesheet=function(){if($("#addTimesheetForm").valid()){var e=t.dateFormat.toUpperCase().replace(/E/g,"d"),n=void 0;n=t.timesheetTask.entity,t.timesheets.push({user:t.timesheetUser.user,task:n,date:formatDate(t.timesheetDate,e),sheetDate:t.timesheetDate,notes:t.timesheetDescription,hours:t.timesheetHours<10?"0"+t.timesheetHours:""+t.timesheetHours,minutes:t.timesheetMinutes<10?"0"+t.timesheetMinutes:""+t.timesheetMinutes,hoursSpent:t.timesheetHours,minutesSpent:t.timesheetMinutes}),t.timesheetUser="",t.timesheetTask="",t.timesheetDate=new Date,t.timesheetDescription="",$(".new-timesheet").removeClass("show")}},t.removeTimesheet=function(e){t.timesheets.splice(e,1)},t.removeTask=function(e){t.tasks.splice(e,1),t.timesheetTasks.splice(e,1),t.timesheetTask="",t.$$phase||t.$apply()},t.addTask=function(){$(".new-task").addClass("show"),t.fromTimesheet=!1},t.taskChanged=function(){t.timesheetTask.dummy&&(t.fromTimesheet=!0,t.timesheetTask="",$(".new-task").addClass("show"))},t.addNewTask=function(){if($("#addTaskForm").valid()){showLoader();var e=new Parse.ACL;e.setPublicReadAccess(!0),e.setPublicWriteAccess(!0);var n=new(Parse.Object.extend("Task"));return n.set("userID",v),n.set("organization",U),n.setACL(e),n.set("taskName",t.newTaskName),n.set("taskDescription",t.newTaskDescription),n.set("taskCost",t.newTaskCost),n.save().then(function(e){e=new d(e),t.tasks.push(e),t.timesheetTasks.pop(),t.timesheetTasks.push(e),t.timesheetTasks.push(createTaskOpener),t.fromTimesheet&&(t.timesheetTask=e),$(".new-task").removeClass("show"),t.newTaskName="",t.newTaskDescription="",t.newTaskCost="",t.$$phase||t.$apply(),hideLoader()})}},t.addNewUser=function(){$("#addUserForm").valid()&&(t.staffUsers.push({user:t.newUser,staffHours:t.staffHours}),$(".add-user").removeClass("show"))},t.prepareToEditUser=function(e){t.userIndex=e,t.editUser=t.staffUsers[t.userIndex].user,t.editStaffHours=t.staffUsers[t.userIndex].staffHours,t.editusers=[],angular.copy(t.users,t.editusers),t.editusers.pop(),t.editusers.push(t.editUser),t.editusers.push(createUserOpener),$(".edit-user").addClass("show")},t.updateUser=function(){t.staffUsers[t.userIndex].user=t.editUser,t.staffUsers[t.userIndex].staffHours=t.editStaffHours,$(".edit-user").removeClass("show")},t.removeUser=function(e){t.users.pop(),t.users.push(t.staffUsers[e].user),t.users.push(createUserOpener),t.staffUsers.splice(e,1)},t.addUser=function(){$(".add-user").addClass("show")},t.openDatePicker=function(e){switch(e){case 1:t.openPicker1=!0;break;case 2:t.openPicker2=!0}},t.saveProject=function(){$("#editProjectForm").valid()&&(showLoader(),N().then(function(e){hideLoader(),console.log(e),n.go("dashboard.projects.details",{projectId:e.id})},function(e){hideLoader(),console.log(e.message)}))},t.cancel=function(){n.go("dashboard.projects.all")},t.userChanged=function(){if(t.newUser.dummy)return t.fromTimesheet=!1,L(),void(t.newUser="")},t.sortByLatest=function(){t.projectList.sort(function(e,t){return e.entity.createdAt>t.entity.createdAt?-1:e.entity.createdAt<t.entity.createdAt?1:0})},t.sortByName=function(){"none"===$("#nameD").css("display")?(t.projectList.sort(function(e,t){return t.entity.projectName.localeCompare(e.entity.projectName)}),$("#nameD").css({display:"inline-table"}),$("#nameDUp").css({display:"none"})):(t.projectList.sort(function(e,t){return e.entity.projectName.localeCompare(t.entity.projectName)}),$("#nameDUp").css({display:"inline-table"}),$("#nameD").css({display:"none"})),$("#custNameD").css({display:"none"}),$("#descD").css({display:"none"}),$("#billMD").css({display:"none"}),$("#priceD").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#descDUp").css({display:"none"}),$("#billMDUp").css({display:"none"}),$("#priceDUp").css({display:"none"})},t.sortByCustomer=function(){"none"===$("#custNameD").css("display")?(t.projectList.sort(function(e,t){return e.customer.displayName.localeCompare(t.customer.displayName)}),$("#custNameD").css({display:"inline-table"}),$("#custNameDUp").css({display:"none"})):(t.projectList.sort(function(e,t){return t.customer.displayName.localeCompare(e.customer.displayName)}),$("#custNameDUp").css({display:"inline-table"}),$("#custNameD").css({display:"none"})),$("#nameD").css({display:"none"}),$("#descD").css({display:"none"}),$("#billMD").css({display:"none"}),$("#priceD").css({display:"none"}),$("#nameDUp").css({display:"none"}),$("#descDUp").css({display:"none"}),$("#billMDUp").css({display:"none"}),$("#priceDUp").css({display:"none"})},t.timesheetUserChanged=function(){if(t.timesheetUser.dummy)return t.fromTimesheet=!0,L(),void(t.newUser="")},t.sortByDesc=function(){"none"===$("#descD").css("display")?(t.projectList.sort(function(e,t){return e.entity.projectDescription||(e.entity.projectDescription=""),t.entity.projectDescription||(t.entity.projectDescription=""),t.entity.projectDescription.localeCompare(e.entity.projectDescription)}),$("#descD").css({display:"inline-table"}),$("#descDUp").css({display:"none"})):(t.projectList.sort(function(e,t){return e.entity.projectDescription||(e.entity.projectDescription=""),t.entity.projectDescription||(t.entity.projectDescription=""),e.entity.projectDescription.localeCompare(t.entity.projectDescription)}),$("#descDUp").css({display:"inline-table"}),$("#descD").css({display:"none"})),$("#nameDUp").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#billMDUp").css({display:"none"}),$("#priceDUp").css({display:"none"}),$("#nameD").css({display:"none"}),$("#custNameD").css({display:"none"}),$("#billMD").css({display:"none"}),$("#priceD").css({display:"none"})},t.sortByBilling=function(){"none"===$("#billMD").css("display")?(t.projectList.sort(function(e,t){return e.entity.billingMethod?t.entity.billingMethod?e.entity.billingMethod.localeCompare(t.entity.billingMethod):1:-1}),$("#billMD").css({display:"inline-table"}),$("#billMDUp").css({display:"none"})):(t.projectList.sort(function(e,t){return e.entity.billingMethod?t.entity.billingMethod?t.entity.billingMethod.localeCompare(e.entity.billingMethod):1:-1}),$("#billMDUp").css({display:"inline-table"}),$("#billMD").css({display:"none"})),$("#nameDUp").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#descDUp").css({display:"none"}),$("#priceDUp").css({display:"none"}),$("#nameD").css({display:"none"}),$("#custNameD").css({display:"none"}),$("#descD").css({display:"none"}),$("#priceD").css({display:"none"})},t.sortByAmount=function(){"none"===$("#priceD").css("display")?(t.projectList.sort(function(e,t){return e.entity.projectBillingAmount||(e.entity.projectBillingAmount=0),t.entity.projectBillingAmount||(t.entity.projectBillingAmount=0),e.entity.projectBillingAmount-t.entity.projectBillingAmount}),$("#priceD").css({display:"inline-table"}),$("#priceDUp").css({display:"none"})):(t.projectList.sort(function(e,t){return e.entity.projectBillingAmount||(e.entity.projectBillingAmount=0),t.entity.projectBillingAmount||(t.entity.projectBillingAmount=0),t.entity.projectBillingAmount-e.entity.projectBillingAmount}),$("#priceDUp").css({display:"inline-table"}),$("#priceD").css({display:"none"})),$("#nameDUp").css({display:"none"}),$("#custNameDUp").css({display:"none"}),$("#descDUp").css({display:"none"}),$("#billMDUp").css({display:"none"}),$("#nameD").css({display:"none"}),$("#custNameD").css({display:"none"}),$("#descD").css({display:"none"}),$("#billMD").css({display:"none"})},t.customerChanged=function(){},t.search=function(){t.searchText.length?t.projectList=t.displayedProject.filter(function(e){return e.entity.projectName||(e.entity.projectName=""),e.customer.displayName||(e.customer.displayName=""),e.entity.projectDescription||(e.entity.projectDescription=""),e.entity.billingMethod||(e.entity.billingMethod=""),e.entity.projectBillingAmount||(e.entity.projectBillingAmount=""),e.entity.projectName.toLowerCase().includes(t.searchText.toLowerCase())||e.customer.displayName.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.projectDescription.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.billingMethod.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.projectBillingAmount.toString().toLowerCase().includes(t.searchText.toLowerCase())}):t.projectList=t.displayedProject}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CustomerBalanceController",["$scope","$state","$controller","$q","userFactory","reportsService","reportsCommon","currencyFilter","creditNoteService",function(e,t,n,s,a,i,o,r,c){if(a.entity.length){var l=a.entity[0].get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),e.dateRanges=o.getDateRanges(),e.selectedDateRange=e.dateRanges[1],e.fromDate=new Date,e.fromDate.setHours(0),e.fromDate.setMinutes(0),e.toDate=new Date,a.getField("dateFormat").then(function(t){e.dateFormat=t,e.generateReport()}),e.dateOptions={showWeeks:!1},e.dateRangeChanged=function(){o.dateRangeChanged({_scope:e})},e.openDatePicker=function(t){o.openDatePicker({_scope:e,n:t})},e.generateReport=function(){e.toDate,new Date,e.toDate;showLoader();var t={toDate:e.toDate,organization:l},n=[];n.push(i.customerBalance(t)),n.push(i.customerCredit(t)),s.all(n).then(function(t){var n=t[0],s=t[1],a=[],i={},o=0;n.forEach(function(e){var t=e.customer.id,n=e.entity.balanceDue;i[t]?(i[t].balanceDue+=n,i[t].count+=1):(i[t]={name:e.customer.displayName,balanceDue:n,count:1,availableCredit:0},a.push(t)),o+=n});var c=0;s.forEach(function(e){var t=e.customer.id,n=e.entity.remainingCredits;i[t]?i[t].availableCredit+=n:(i[t]={name:e.customer.displayName,availableCredit:n,balanceDue:0,count:1},a.push(t)),c+=n});var l=0;a.forEach(function(e){console.log("info[id].balanceDue = "+i[e].balanceDue),i[e].customerBalance=i[e].balanceDue-i[e].availableCredit,l+=i[e].customerBalance,i[e].customerBalanceStr=r(i[e].customerBalance,"$",2),i[e].balanceDueStr=r(i[e].balanceDue,"$",2),i[e].availableCreditStr=r(i[e].availableCredit,"$",2)}),e.info=i,e.ids=a,e.totalBalanceStr=r(o,"$",2),e.totalCreditStr=r(c,"$",2),e.totalCustomerBalanceStr=r(l,"$",2);var d=e.dateFormat.toUpperCase().replace(/E/g,"d");e.toDateStr=formatDate(e.toDate,d),e.sortByName(),hideLoader()})},e.sortByName=function(){e.ids.sort(function(t,n){return e.info[t].name.localeCompare(e.info[n].name)}),"none"===$("#name").css("display")?(e.ids.sort(function(t,n){return e.info[t].name.localeCompare(e.info[n].name)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.info[n].name.localeCompare(e.info[t].name)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#credit").css({display:"none"}),$("#balance").css({display:"none"}),$("#creditUp").css({display:"none"}),$("#balanceUp").css({display:"none"}),$("#customerbalance").css({display:"none"}),$("#customerbalanceUp").css({display:"none"})},e.sortByCredit=function(){"none"===$("#credit").css("display")?(e.ids.sort(function(t,n){return e.info[n].availableCredit-e.info[t].availableCredit}),$("#credit").css({display:"inline-table"}),$("#creditUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.info[t].availableCredit-e.info[n].availableCredit}),$("#creditUp").css({display:"inline-table"}),$("#credit").css({display:"none"})),$("#balanceUp").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#balance").css({display:"none"}),$("#name").css({display:"none"}),$("#customerbalance").css({display:"none"}),$("#customerbalanceUp").css({display:"none"})},e.sortByBalance=function(){e.ids.sort(function(t,n){return e.info[n].balanceDue-e.info[t].balanceDue}),"none"===$("#balance").css("display")?(e.ids.sort(function(t,n){return e.info[n].balanceDue-e.info[t].balanceDue}),$("#balance").css({display:"inline-table"}),$("#balanceUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.info[t].balanceDue-e.info[n].balanceDue}),$("#balanceUp").css({display:"inline-table"}),$("#balance").css({display:"none"})),$("#name").css({display:"none"}),$("#credit").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#creditUp").css({display:"none"}),$("#customerbalance").css({display:"none"}),$("#customerbalanceUp").css({display:"none"})},e.sortByCustomerBalance=function(){"none"===$("#customerbalance").css("display")?(e.ids.sort(function(t,n){return e.info[n].customerBalance-e.info[t].customerBalance}),$("#customerbalance").css({display:"inline-table"}),$("#customerbalanceUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.info[t].customerBalance-e.info[n].customerBalance}),$("#customerbalanceUp").css({display:"inline-table"}),$("#customerbalance").css({display:"none"})),$("#balance").css({display:"none"}),$("#name").css({display:"none"}),$("#credit").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#creditUp").css({display:"none"}),$("#balanceUp").css({display:"none"})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("ExpenseByCategoryController",["$scope","$state","$controller","$q","userFactory","reportsService","reportsCommon","currencyFilter",function(e,t,n,s,a,i,o,r){if(a.entity.length){var c=a.entity[0].get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),e.dateRanges=o.getDateRanges(),e.selectedDateRange=e.dateRanges[1],e.fromDate=new Date,e.fromDate.setHours(0),e.fromDate.setMinutes(0),e.toDate=new Date,a.getField("dateFormat").then(function(t){e.dateFormat=t,e.generateReport()}),e.dateOptions={showWeeks:!1},e.dateRangeChanged=function(){o.dateRangeChanged({_scope:e})},e.openDatePicker=function(t){o.openDatePicker({_scope:e,n:t})},e.generateReport=function(){var t=e.toDate,n=new Date,a=e.fromDate,o=e.toDate;if(t>n)return ShowMessage("Select a valid Date!","error"),!1;if(a>o)return ShowMessage("The from date can't be after the to date.","error"),!1;showLoader();var l={fromDate:e.fromDate,toDate:e.toDate,organization:c};s.when(i.expenseByCategory(l)).then(function(t){var n=[],s={},a=0;t.forEach(function(e){var t=e.get("category"),i=e.get("amount");a+=i,s[t]?(s[t].amount+=i,s[t].count+=1):(n.push(t),s[t]={amount:i,count:1})}),n.forEach(function(e){s[e].amountStr=r(s[e].amount,"$",2)}),e.categories=n,e.info=s;var i=e.dateFormat.toUpperCase().replace(/E/g,"d");e.totalStr=r(a,"$",2),e.fromDateStr=formatDate(e.fromDate,i),e.toDateStr=formatDate(e.toDate,i),e.sortByName(),hideLoader()})},e.sortByName=function(){"none"===$("#name").css("display")?(e.categories.sort(function(e,t){return e.localeCompare(t)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.categories.sort(function(e,t){return t.localeCompare(e)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#count").css({display:"none"}),$("#amount").css({display:"none"}),$("#countUp").css({display:"none"}),$("#amountUp").css({display:"none"})},e.sortByCount=function(){"none"===$("#count").css("display")?(e.categories.sort(function(t,n){return e.info[n].count-e.info[t].count}),$("#count").css({display:"inline-table"}),$("#countUp").css({display:"none"})):(e.categories.sort(function(t,n){return e.info[t].count-e.info[n].count}),$("#countUp").css({display:"inline-table"}),$("#count").css({display:"none"})),$("#name").css({display:"none"}),$("#amount").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#amountUp").css({display:"none"})},e.sortByAmount=function(){"none"===$("#amount").css("display")?(e.categories.sort(function(t,n){return e.info[n].amount-e.info[t].amount}),$("#amount").css({display:"inline-table"}),$("#amountUp").css({display:"none"})):(e.categories.sort(function(t,n){return e.info[t].amount-e.info[n].amount}),$("#amountUp").css({display:"inline-table"}),$("#amount").css({display:"none"})),$("#name").css({display:"none"}),$("#count").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#countUp").css({display:"none"})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("InvoiceAgingController",["$scope","$state","$controller","$q","userFactory","reportsService","reportsCommon","currencyFilter",function(e,t,n,s,a,i,o,r){if(a.entity.length){var c=a.entity[0].get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),e.dateRanges=o.getDateRanges(),e.selectedDateRange=e.dateRanges[1],e.fromDate=new Date,e.fromDate.setHours(0),e.fromDate.setMinutes(0),e.toDate=new Date,a.getField("dateFormat").then(function(t){e.dateFormat=t,e.generateReport()}),e.dateRangeChanged=function(){o.dateRangeChanged({_scope:e})},e.openDatePicker=function(t){o.openDatePicker({_scope:e,n:t})},e.generateReport=function(){e.toDate,new Date,e.toDate;showLoader();var t={toDate:e.toDate,organization:c};s.when(i.invoiceAging(t)).then(function(t){var n=[],s={},a=0,i=0,o=e.toDate.getTime(),c=0;t.forEach(function(e){var l=e.customer.id,d=e.entity.balanceDue;if(e.entity.lateFee){var u=e.entity.lateFee,m=u.get("price"),p=u.get("type"),f=0;"$"==p?f=m:"%"==p&&(f=d*m*.01),d+=f}s[l]?(s[l].balanceDue+=d,s[l].count+=1):(s[l]={name:e.customer.displayName,balanceDue:d,count:1,overDueDays:0},n.push(l));var h=e.entity.invoiceDate.getTime(),y=Math.round(Math.ceil(Math.abs(o-h)/864e5));s[l].overDueDays+=y-1,i+=y-1,a+=d,t[c].overDueDays1=y-1,t[c].entity.balanceDueStr=r(d,"$",2),c++}),n.forEach(function(e){s[e].balanceDueStr=r(s[e].balanceDue,"$",2)}),e.invoices1=t,e.info=s,e.ids=n,e.totalOverDueDays=i,e.totalBalanceStr=r(a,"$",2);var l=e.dateFormat.toUpperCase().replace(/E/g,"d");e.toDateStr=formatDate(e.toDate,l),e.sortByInvoiceNo(),hideLoader()})},e.sortByInvoiceNo=function(){"none"===$("#invoiceno").css("display")?(e.invoices1.sort(function(e,t){return parseInt(e.entity.invoiceNumber.split("-")[1])-parseInt(t.entity.invoiceNumber.split("-")[1])}),$("#invoiceno").css({display:"inline-table"}),$("#invoicenoUp").css({display:"none"})):(e.invoices1.sort(function(e,t){var n=parseInt(e.entity.invoiceNumber.split("-")[1]);return parseInt(t.entity.invoiceNumber.split("-")[1])-n}),$("#invoicenoUp").css({display:"inline-table"}),$("#invoiceno").css({display:"none"})),$("#name").css({display:"none"}),$("#days").css({display:"none"}),$("#balance").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#daysUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},e.sortByName=function(){"none"===$("#name").css("display")?(e.invoices1.sort(function(e,t){return e.customer.displayName.localeCompare(t.customer.displayName)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.invoices1.sort(function(e,t){return t.customer.displayName.localeCompare(e.customer.displayName)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#days").css({display:"none"}),$("#balance").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#daysUp").css({display:"none"}),$("#balanceUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"})},e.sortByDays=function(){e.invoices1.sort(function(e,t){return t.overDueDays1-e.overDueDays1}),"none"===$("#days").css("display")?(e.invoices1.sort(function(e,t){return t.overDueDays1-e.overDueDays1}),$("#days").css({display:"inline-table"}),$("#daysUp").css({display:"none"})):(e.invoices1.sort(function(e,t){return e.overDueDays1-t.overDueDays1}),$("#daysUp").css({display:"inline-table"}),$("#days").css({display:"none"})),$("#name").css({display:"none"}),$("#balance").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#balanceUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"})},e.sortByBalance=function(){"none"===$("#balance").css("display")?(e.invoices1.sort(function(e,t){return t.entity.balanceDue-e.entity.balanceDue}),$("#balance").css({display:"inline-table"}),$("#balanceUp").css({display:"none"})):(e.invoices1.sort(function(e,t){return e.entity.balanceDue-t.entity.balanceDue}),$("#balanceUp").css({display:"inline-table"}),$("#balance").css({display:"none"})),$("#name").css({display:"none"}),$("#days").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#daysUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("PaymentsReceivedController",["$scope","$state","$controller","$q","userFactory","reportsService","reportsCommon","currencyFilter",function(e,t,n,s,a,i,o,r){if(a.entity.length){var c=a.entity[0].get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),e.dateRanges=o.getDateRanges(),e.selectedDateRange=e.dateRanges[1],e.fromDate=new Date,e.fromDate.setHours(0),e.fromDate.setMinutes(0),e.toDate=new Date,a.getField("dateFormat").then(function(t){e.dateFormat=t,e.generateReport()}),e.dateOptions={showWeeks:!1},e.dateRangeChanged=function(){o.dateRangeChanged({_scope:e})},e.openDatePicker=function(t){o.openDatePicker({_scope:e,n:t})},e.generateReport=function(){var t=e.toDate,n=new Date,a=e.fromDate,o=e.toDate;if(t>n)return ShowMessage("Select a valid Date!","error"),!1;if(a>o)return ShowMessage("The from date can't be after the to date.","error"),!1;showLoader();var l={fromDate:e.fromDate,toDate:e.toDate,organization:c};s.when(i.paymentsReceived(l)).then(function(t){var n=[],s=0,a=e.dateFormat.toUpperCase().replace(/E/g,"d");t.forEach(function(e){e.payments.forEach(function(t){n.push({displayName:e.customer.get("displayName"),date:formatDate(e.entity.invoiceDate,a),amount:r(t.entity.amount,"$",2)}),s+=t.entity.amount})}),e.info=n,e.totalStr=r(s,"$",2),e.fromDateStr=formatDate(e.fromDate,a),e.toDateStr=formatDate(e.toDate,a),e.sortByDate(),hideLoader()})},e.sortByName=function(){e.info.sort(function(e,t){return e.displayName.localeCompare(t.displayName)}),"none"===$("#name").css("display")?(e.info.sort(function(e,t){return e.displayName.localeCompare(t.displayName)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.info.sort(function(e,t){return t.displayName.localeCompare(e.displayName)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#date").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#amountUp").css({display:"none"})},e.sortByDate=function(){"none"===$("#date").css("display")?(e.info.sort(function(e,t){return e.date.localeCompare(t.date)}),$("#date").css({display:"inline-table"}),$("#dateUp").css({display:"none"})):(e.info.sort(function(e,t){return t.date.localeCompare(e.date)}),$("#dateUp").css({display:"inline-table"}),$("#date").css({display:"none"})),$("#nameUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#name").css({display:"none"}),$("#amount").css({display:"none"})},e.sortByAmount=function(){"none"===$("#amount").css("display")?(e.info.sort(function(e,t){return e.amount.localeCompare(t.amount)}),$("#amount").css({display:"inline-table"}),$("#amountUp").css({display:"none"})):(e.info.sort(function(e,t){return t.amount.localeCompare(e.amount)}),$("#amountUp").css({display:"inline-table"}),$("#amount").css({display:"none"})),$("#name").css({display:"none"}),$("#date").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#dateUp").css({display:"none"})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("SalesByCustomerController",["$scope","$state","$controller","$q","userFactory","reportsService","reportsCommon","currencyFilter",function(e,t,n,s,a,i,o,r){if(a.entity.length){var c=a.entity[0].get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),e.dateRanges=o.getDateRanges(),e.selectedDateRange=e.dateRanges[1],e.fromDate=new Date,e.fromDate.setHours(0),e.fromDate.setMinutes(0),e.toDate=new Date,a.getField("dateFormat").then(function(t){e.dateFormat=t,e.generateReport()}),e.dateOptions={showWeeks:!1},e.dateRangeChanged=function(){o.dateRangeChanged({_scope:e})},e.openDatePicker=function(t){o.openDatePicker({_scope:e,n:t})},e.generateReport=function(){var t=e.toDate,n=new Date,a=e.fromDate,o=e.toDate;if(t>n)return ShowMessage("Select a valid Date!","error"),!1;if(a>o)return ShowMessage("The from date can't be after the to date.","error"),!1;showLoader();var l={fromDate:e.fromDate,toDate:e.toDate,organization:c};s.when(i.salesByCustomer(l)).then(function(t){var n=[],s={},a=0,i=0;t.forEach(function(e){var t=e.customer.id,i=e.entity.total;s[t]?(s[t].amount+=i,s[t].count+=1):(s[t]={name:e.customer.displayName,amount:i,count:1},n.push(t)),a+=i}),n.forEach(function(e){s[e].amountStr=r(s[e].amount,"$",2),i+=s[e].count}),e.infoObj=s,e.ids=n,e.totalInvoices=i,e.totalSalesStr=r(a,"$",2);var o=e.dateFormat.toUpperCase().replace(/E/g,"d");e.fromDateStr=formatDate(e.fromDate,o),e.toDateStr=formatDate(e.toDate,o),e.sortByName(),hideLoader()})},e.sortByName=function(){"none"===$("#name").css("display")?(e.ids.sort(function(t,n){return e.infoObj[t].name.localeCompare(e.infoObj[n].name)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.infoObj[n].name.localeCompare(e.infoObj[t].name)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#count").css({display:"none"}),$("#tax").css({display:"none"}),$("#countUp").css({display:"none"}),$("#taxUp").css({display:"none"})},e.sortByInvoiceCount=function(){"none"===$("#count").css("display")?(e.ids.sort(function(t,n){return e.infoObj[n].count-e.infoObj[t].count}),$("#count").css({display:"inline-table"}),$("#countUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.infoObj[t].count-e.infoObj[n].count}),$("#countUp").css({display:"inline-table"}),$("#count").css({display:"none"})),$("#name").css({display:"none"}),$("#tax").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#taxUp").css({display:"none"})},e.sortByTax=function(){e.ids.sort(function(t,n){return e.infoObj[n].amount-e.infoObj[t].amount}),"none"===$("#tax").css("display")?(e.ids.sort(function(t,n){return e.infoObj[t].name.localeCompare(e.infoObj[n].name)}),$("#tax").css({display:"inline-table"}),$("#taxUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.infoObj[n].name.localeCompare(e.infoObj[t].name)}),$("#taxUp").css({display:"inline-table"}),$("#tax").css({display:"none"})),$("#name").css({display:"none"}),$("#count").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#countUp").css({display:"none"})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("SalesByItemController",["$scope","$state","$controller","$q","userFactory","reportsService","reportsCommon","itemService","currencyFilter",function(e,t,n,s,a,i,o,r,c){function l(t){var n=[],s={};t.forEach(function(e){var t=e.entity.id;e.invoiceItems.forEach(function(e){var a=e.entity.item.id,i=s[a];i?(i.amount+=e.entity.amount,i.inv_ids.find(function(e){return e==t})||i.inv_ids.push(t)):(n.push(a),s[a]={amount:e.entity.amount,inv_ids:[t]})})});var a=0,i=0;n.forEach(function(t){s[t].amountStr=c(s[t].amount,"$",2),s[t].count=s[t].inv_ids.length+1,a+=s[t].amount,i+=s[t].count,s[t].name=e.items.find(function(e){return e.id==t}).get("title")}),e.ids=n,e.info=s,e.totalInvoices=i,e.totalStr=c(a,"$",2),e.sortByName();var o=e.dateFormat.toUpperCase().replace(/E/g,"d");e.fromDateStr=formatDate(e.fromDate,o),e.toDateStr=formatDate(e.toDate,o)}if(a.entity.length){var d=a.entity[0].get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),function(){e.dateRanges=o.getDateRanges(),e.selectedDateRange=e.dateRanges[1],e.fromDate=new Date,e.fromDate.setHours(0),e.fromDate.setMinutes(0),e.toDate=new Date;var t=[],n=void 0;n=a.getField("dateFormat").then(function(t){e.dateFormat=t}),t.push(n),n=r.getItemNames({organization:d}).then(function(t){e.items=t}),t.push(n),s.all(t).then(function(){e.generateReport()})}(),e.dateOptions={showWeeks:!1},e.dateRangeChanged=function(){o.dateRangeChanged({_scope:e})},e.openDatePicker=function(t){o.openDatePicker({_scope:e,n:t})},e.generateReport=function(){var t=e.toDate,n=new Date,a=e.fromDate,o=e.toDate;if(t>n)return ShowMessage("Select a valid Date!","error"),!1;if(a>o)return ShowMessage("The from date can't be after the to date.","error"),!1;showLoader();var r={fromDate:e.fromDate,toDate:e.toDate,organization:d};s.when(i.salesByItem(r)).then(function(e){l(e),hideLoader()})},e.sortByName=function(){"none"===$("#name").css("display")?(e.ids.sort(function(t,n){return e.info[t].name.localeCompare(e.info[n].name)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.info[n].name.localeCompare(e.info[t].name)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#count").css({display:"none"}),$("#tax").css({display:"none"}),$("#countUp").css({display:"none"}),$("#taxUp").css({display:"none"})},e.sortByInvoiceCount=function(){"none"===$("#count").css("display")?(e.ids.sort(function(t,n){return e.info[n].count-e.info[t].count}),$("#count").css({display:"inline-table"}),$("#countUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.info[t].count-e.info[n].count}),$("#countUp").css({display:"inline-table"}),$("#count").css({display:"none"})),$("#name").css({display:"none"}),$("#tax").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#taxUp").css({display:"none"})},e.sortByTax=function(){"none"===$("#tax").css("display")?(e.ids.sort(function(t,n){return e.info[n].amount-e.info[t].amount}),$("#tax").css({display:"inline-table"}),$("#taxUp").css({display:"none"})):(e.ids.sort(function(t,n){return e.info[t].amount-e.info[n].amount}),$("#taxUp").css({display:"inline-table"}),$("#tax").css({display:"none"})),$("#name").css({display:"none"}),$("#count").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#countUp").css({display:"none"})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CreateCreditNoteController",["$scope","$state","$controller","$q","userFactory","creditNoteService","coreFactory","taxService","expenseService","currencyFilter","commentFactory","salesCommon",function(e,t,n,s,a,i,o,r,c,l,d,u){function m(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:1,digits:!0,messages:{required:"Please provide item quantity",min:"quantity should be >= 1",digits:"quantity must be integer"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0",number:"Please enter a valid price"}})})}function p(){1==e.prefs.numAutoGen?(e.creditNo=e.prefs.creditNumber,e.disableCreditNo=!0):(e.creditNo="",e.disableCreditNo=!1),e.notes=e.prefs.notes,e.terms=e.prefs.terms,e.todayDate=new Date,e.subTotalStr=l(0,"$",2),e.creditItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var n=t.params.customerId,a=t.params.expenseId;n&&(e.selectedCustomer=e.customers.filter(function(e){return e.entity.id==n})[0],w(),a&&s.when(C()).then(function(){e.addCreditItem(),e.creditItems[0].selectedItem=e.items.filter(function(e){return e.entity.expanseId==a})[0],e.creditItems[0].selectedItem.create=!0,e.itemChanged(0)})),hideLoader()}function f(){var t={userID:D,organization:N,customer:e.selectedCustomer.entity,creditNoteDate:e.todayDate,creditNumber:e.creditNo,status:"Open",subTotal:Number(e.subTotal),creditsUsed:0,refundsMade:0,total:Number(e.total),remainingCredits:Number(e.total),reference:e.refNumber,notes:e.notes,terms:e.terms},n=e.selectedCustomer.entity.email;return n&&(t.customerEmails=[n]),i.createNewCreditNote(t,e.creditItems,e.userRole).then(function(e){return b("Credit Note created for "+l(e.attributes.total,"$",2)+" amount",!0,e)})}function h(){return f().then(function(e){return i.createCreditNoteReceipt(e.id).then(function(e){return y(e),e})})}function y(t){e.contacts.forEach(function(e){e.selected&&i.sendCreditNoteReceiptToEmail(t,e.contact).then(function(n){b("Credit Note emailed to "+e.contact,!0,t)})}),e.mobileContacts.forEach(function(e){e.selected&&i.sendCreditNoteTextToNumber(t,e.contact).then(function(n){b("Credit Note texted to "+e.contact,!0,t)})})}function g(){m();var e=$("#addCreditNoteForm").valid(),t=$("#itemInfoForm").valid();if(e&&t)return!0;var n=void 0;e?t||(n=$("#itemInfoForm").validate()):n=$("#addCreditNoteForm").validate();var s=$(n.errorList[0].element).offset().top-30;return scrollToOffset(s),!1}function v(){g()&&(showLoader(),s.when(i.checkCreditNoteNumAvailable({creditNumber:e.creditNo,organization:N})).then(function(e){return e?h():(x(),scrollToOffset(),Promise.reject("Credit Note with this number already exists"))}).then(function(e){hideLoader(),t.go("dashboard.sales.creditnotes.details",{creditNoteId:e.id})},function(e){hideLoader(),console.log(e)}))}function b(e,t,n){var a={userID:D,organization:N,name:D.get("username"),date:new Date,isAutomaticallyGenerated:t,comment:e};if(D.get("isTrackUsage")||!t){var i={};return s.when(o.getUserRole(D)).then(function(e){return d.createNewComment(a,e)}).then(function(e){i.commentObj=e;var t=n.get("comments");return t?t.push(e):t=[e],n.set("comments",t),n.save()})}}function x(){$("#addCreditNoteForm").validate().showErrors({creditNumber:"Credit Note with this number already exists"})}function C(){return s.when(c.getCustomerExpenses({organization:N,customer:e.selectedCustomer.entity})).then(function(t){for(var n=[],s=0;s<t.length;++s)if("Yes"==t[s].entity.get("billable"))for(var a=0;a<e.expenseItems.length;++a)t[s].entity.id==e.expenseItems[a].entity.expanseId&&n.push(e.expenseItems[a]);for(var i=[],s=0;s<t.length;++s)if("No"!=t[s].entity.get("billable")){var o=t[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}e.actualItems.pop();var r=e.actualItems.concat(n,i);return e.creditItems=e.creditItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),"Sales"!=D.get("role")&&r.push(createItemOpener),e.items=r})}function w(){e.selectedCustomer.dummy?t.go("dashboard.customers.new",{backLink:t.current.name}):(showLoader(),s.when(C()).then(function(){e.creditItems.length<1?(e.addCreditItem(),e.totalTax=0,e.subTotal=0,e.subTotalStr=l(0,"$",2),e.reCalculateTotal()):T(),hideLoader()}))}function T(){var t=e.creditItems,n=0,s=0;e.itemTaxes=[],t.forEach(function(t){if(n+=t.amount*(.01*(100-t.discount)),t.taxValue=calculateTax(t.amount,t.selectedTax),s+=t.taxValue,t.selectedTax){var a=-1;e.itemTaxes.length&&(a=e.itemTaxes.findIndex(function(e){return e.name==t.selectedTax.name})),-1==a?e.itemTaxes.push({nameValue:t.selectedTax.name+" ("+t.selectedTax.rate+"%)",amount:l(t.taxValue,"$",2),count:1,name:t.selectedTax.name,amountValue:t.taxValue}):(e.itemTaxes[a].amountValue+=t.taxValue,e.itemTaxes[a].count++,e.itemTaxes[a].amount=l(e.itemTaxes[a].amountValue,"$",2),e.itemTaxes[a].nameValue=t.selectedTax.name+" ("+t.selectedTax.rate+"%)")}}),e.totalTax=s,e.subTotal=n,e.subTotalStr=l(n,"$",2),e.reCalculateTotal()}if(a.entity.length){var D=a.entity[0],N=D.get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),function(){showLoader();var t=[],n=null;n=s.when(o.getAllCustomers()).then(function(t){t=t.filter(function(e){return"active"==e.entity.status}),e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),e.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),"Sales"!=D.get("role")&&e.customers.push(createCustomerOpener)}),t.push(n),n=s.when(o.getAllItems({organization:N})).then(function(t){e.actualItems=t.filter(function(e){return!e.entity.expanseId}),e.expenseItems=t.filter(function(e){return e.entity.expanseId}),e.items=e.actualItems,"Sales"!=D.get("role")&&e.items.push(createItemOpener)}),t.push(n),n=s.when(i.getPreferences(D)).then(function(t){e.prefs=t}),t.push(n),n=s.when(o.getUserRole(D)).then(function(t){e.userRole=t}),t.push(n),n=r.getTaxes(D,function(t){e.taxes=t}),t.push(n),n=a.getField("dateFormat").then(function(t){e.dateFormat=t}),t.push(n),s.all(t).then(function(){p()},function(e){hideLoader(),console.log(e.message)})}(),$("#addCreditNoteForm").validate({rules:{customer:"required",creditNumber:"required",creditCreateDate:"required"},messages:{customer:"Please select a customer",creditNumber:"Please enter credit note number",creditCreateDate:"Please provide credit note Create date"}}),$("#itemInfoForm").validate(),e.dateOptions={showWeeks:!1},e.save=function(){g()&&(showLoader(),s.when(i.checkCreditNoteNumAvailable({creditNumber:e.creditNo,organization:N})).then(function(e){return e?f():(x(),scrollToOffset(),Promise.reject("Credit Note with this number already exists"))}).then(function(e){hideLoader(),t.go("dashboard.sales.creditnotes.details",{creditNoteId:e.id})},function(e){hideLoader(),console.log(e)}))},e.saveAndSend=function(){if(g()){$("#emailText-error").hide();var t=e.selectedCustomer.entity.get("contactPersons");e.contacts=[],e.mobileContacts=[],t.length&&t.forEach(function(t){var n=t.get("firstname")?t.get("firstname"):"",s=t.get("lastname")?t.get("lastname"):"",a=1==t.get("defaultPerson"),i=n+" "+s;t.get("email")&&e.contacts.push({selected:a,contact:t.get("email"),contactName:"("+i+") "+t.get("email")}),t.get("phone")&&e.mobileContacts.push({selected:!1,contact:t.get("phone"),contactName:"("+i+") "+t.get("phone")}),t.get("mobile")&&e.mobileContacts.push({selected:a,contact:t.get("mobile"),contactName:"("+i+") "+t.get("mobile")})}),e.contacts.length||e.mobileContacts.length?$(".email-text").addClass("show"):ShowMessage("The customer does not have a email or phone number in their profile. Please select save.","error")}},e.sendReceipt=function(){var t=0,n=0;e.contacts.forEach(function(e){e.selected&&t++}),e.mobileContacts.forEach(function(e){e.selected&&n++}),t>0||n>0?v():$("#emailText-error").show()},e.cancel=function(){t.go("dashboard.sales.creditnotes.all")},e.customerChanged=w,e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0}},e.addCreditItem=function(){e.creditItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},e.removeCreditItem=function(t){e.creditItems.length>1?(e.creditItems.splice(t,1),T()):console.log("there should be atleast 1 item in a creditNote")},e.prepareCreateItem=function(){u.prepareCreateItem({_scope:e})},e.createNewItem=function(){u.createNewCreditItem({_scope:e,user:D,organization:N})},e.itemChanged=function(t){console.log("item changed");var n=e.creditItems[t];if(n.selectedItem.dummy)return n.selectedItem=null,$(".new-item").addClass("show"),e.itemChangedIndex=t,void e.prepareCreateItem();n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=e.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";e.reCalculateItemAmount(t)},e.reCalculateTotal=function(){var t=(Number(e.subTotal)||0)+(Number(e.totalTax)||0);e.total=t,e.totalStr=l(e.total,"$",2)},e.taxChanged=function(t){if(console.log("tax changed"),-1==t){if(e.newItem.tax.dummy)return e.currentItem=t,e.newItem.tax=null,e.taxName=null,e.taxRate=null,void $(".new-tax").addClass("show")}else{var n=e.creditItems[t];if(n.selectedTax){if(n.selectedTax.dummy)return e.currentItem=t,e.taxName=null,e.taxRate=null,n.selectedTax=null,void $(".new-tax").addClass("show")}else T()}T()},e.saveNewTax=function(){u.createNewCreditTax({_scope:e,user:D},function(){T(),e.$$phase||e.$apply()})},e.reCalculateItemAmount=function(t){var n=e.creditItems[t];n.selectedItem&&(n.amount=n.rate*n.quantity,T())}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CreditNoteController",["$q","$scope","$state","$controller","userFactory","creditNoteService","coreFactory","taxService","expenseService","commentFactory","currencyFilter",function(e,t,n,s,a,i,o,r,c,l,d){function u(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:1,digits:!0,messages:{required:"Please provide item quantity",min:"quantity should be >= 1",digits:"quantity must be integer"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0",number:"Please enter a valid price"}})})}function m(e){e||(e=n.current.name),I.creditnotes(e)?(console.log("its in list"),T()):I.newCreditnotes(e)?console.log("its in new"):I.edit(e)&&(console.log("its in edit"),p())}function p(){var s=n.params.creditNoteId;if(s){var a=n.params.customerId;showLoader(),e.when(w()).then(function(t){return e.when(i.getCreditNote(s))}).then(function(n){return console.log(n),t.creditNote=n,t.creditItems=[],t.deletedItems=[],t.itemsWithOutId=0,t.itemsWithIdinDel=0,t.selectedCustomer=a?t.customers.filter(function(e){return a===e.entity.id})[0]:t.customers.filter(function(e){return n.entity.get("customer").id===e.entity.id})[0],e.when(C())}).then(function(){f()},function(e){hideLoader(),console.log(e.message)})}}function f(){var e=t.creditNote;t.creditNo=e.entity.creditNumber,t.refNumber=e.entity.reference,t.disableCreditNo=1==t.prefs.numAutoGen,t.todayDate=e.entity.creditNoteDate,t.notes=e.entity.notes,t.terms=e.entity.terms,"Sent"==e.entity.status&&(t.previouslySent=!0);for(var n=0;n<e.creditItems.length;++n){var s=e.creditItems[n].entity,a=s.get("item"),i={};i.selectedItem=t.items.filter(function(e){if(e.entity.id===a.id){i.id=s.id,i.rate=s.amount/s.quantity,i.quantity=s.quantity,i.discount=0,i.taxValue=0,i.amount=s.amount;var n=s.get("tax");return i.selectedTax=n?t.taxes.filter(function(e){return e.id==n.id})[0]:void 0,!0}return!1})[0],t.creditItems.push(i)}x(),hideLoader()}function h(e){var n=t.creditNote.entity;n.set("customer",t.selectedCustomer.entity),n.set("creditNoteDate",t.todayDate),n.set("creditNumber",t.creditNo),n.set("subTotal",Number(t.subTotal)),n.set("total",Number(t.total)),n.set("remainingCredits",Number(t.total)),n.set("reference",t.refNumber),n.set("notes",t.notes),n.set("terms",t.terms);var s=t.selectedCustomer.entity.email;return s?n.set("customerEmails",[s]):n.unset("customerEmails"),i.updateCreditNote(t.creditNote,t.creditItems,t.deletedItems,D,t.userRole).then(function(t){return y("Credit Note edited",!0),e.generateReceipt?i.createCreditNoteReceipt(t.id):t})}function y(n,s){var a={userID:D,organization:N,name:D.get("username"),date:new Date,isAutomaticallyGenerated:s,comment:n};if(D.get("isTrackUsage")||!s){var i={};e.when(o.getUserRole(D)).then(function(e){return l.createNewComment(a,e)}).then(function(e){i.commentObj=e;var n=t.creditNote.entity,s=n.get("comments");return s?s.push(e):s=[e],n.set("comments",s),n.save()})}}function g(){return h({generateReceipt:!1}).then(function(e){return i.createCreditNoteReceipt(e.id).then(function(e){return i.sendCreditNoteReceipt(e)})})}function v(){u();var e=$("#editCreditNoteForm").valid(),t=$("#itemInfoForm").valid();if(e&&t)return!0;var n=void 0;e?t||(n=$("#itemInfoForm").validate()):n=$("#editCreditNoteForm").validate();var s=$(n.errorList[0].element).offset().top-30;return scrollToOffset(s),!1}function b(){var e=t.itemsWithIdinDel,n=t.itemsWithOutId;if(!(e<=0||n<=0)){var s=0,a=t.creditItems;t.deletedItems.forEach(function(e){if(e.id)for(;s<a.length;++s)if(!a[s].id)return a[s].id=e.id,e.id=void 0,--t.itemsWithIdinDel,void--t.itemsWithOutId}),t.deletedItems=t.deletedItems.filter(function(e){return!!e.id})}}function x(){var e=t.creditItems,n=0,s=0;t.itemTaxes=[],e.forEach(function(e){if(n+=e.amount*(.01*(100-e.discount)),e.taxValue=calculateTax(e.amount,e.selectedTax),s+=e.taxValue,e.selectedTax){var a=-1;t.itemTaxes.length&&(a=t.itemTaxes.findIndex(function(t){return t.name==e.selectedTax.name})),-1==a?t.itemTaxes.push({nameValue:e.selectedTax.name+" ("+e.selectedTax.rate+"%)",amount:d(e.taxValue,"$",2),count:1,name:e.selectedTax.name,amountValue:e.taxValue}):(t.itemTaxes[a].amountValue+=e.taxValue,t.itemTaxes[a].count++,t.itemTaxes[a].amount=d(t.itemTaxes[a].amountValue,"$",2),t.itemTaxes[a].nameValue=e.selectedTax.name+" ("+e.selectedTax.rate+"%)")}}),t.totalTax=s,t.subTotal=n,t.subTotalStr=d(n,"$",2),t.reCalculateTotal()}function C(){return e.when(c.getCustomerExpenses({organization:N,customer:t.selectedCustomer.entity})).then(function(e){for(var n=[],s=0;s<e.length;++s)if("Yes"==e[s].entity.get("billable"))for(var a=0;a<t.expenseItems.length;++a)e[s].entity.id==t.expenseItems[a].entity.expanseId&&n.push(t.expenseItems[a]);for(var i=[],s=0;s<e.length;++s)if("No"!=e[s].entity.get("billable")){var o=e[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}var r=t.actualItems.concat(n,i);return t.creditItems=t.creditItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),t.items=r})}function w(){var n=[],s=null;return o.clearAllOnLogOut(),s=e.when(o.getAllCustomers()).then(function(e){t.customers=e.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),t.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),"Sales"!=D.get("role")&&t.customers.push(createCustomerOpener)}),n.push(s),s=e.when(o.getAllItemsIncludingDelete({organization:N})).then(function(e){t.actualItems=e.filter(function(e){return!e.entity.expanseId}),t.expenseItems=e.filter(function(e){return e.entity.expanseId}),t.items=t.actualItems}),n.push(s),s=e.when(i.getPreferences(D)).then(function(e){t.prefs=e}),n.push(s),s=e.when(o.getUserRole(D)).then(function(e){t.userRole=e}),n.push(s),s=r.getTaxes(D,function(e){t.taxes=e}),n.push(s),e.all(n)}function T(){showLoader(),e.when(i.listCreditNotes(D)).then(function(e){var n=t.dateFormat.toUpperCase().replace(/E/g,"d");e.forEach(function(e){switch(e.entity.status){case"Open":e.statusClass="text-positive";break;case"Closed":e.statusClass="text-danger";break;default:e.statusClass="text-color-normalize"}e.creditNoteDate=formatDate(e.entity.creditNoteDate,n),e.total=d(e.entity.total,"$",2),e.remainingCredits=d(e.entity.remainingCredits,"$",2)}),t.creditNoteList=e,t.allcreditNoteList=e,t.displayedCreditNotes=e,t.sortByDate(),hideLoader()},function(e){hideLoader(),console.log(e.message)})}if(a.entity.length){var D=a.entity[0],N=D.get("organizations")[0];s("DashboardController",{$scope:t,$state:n});var I={details:function(e){return e.endsWith("creditnotes.details")},creditnotes:function(e){return e.endsWith("creditnotes.all")},edit:function(e){return e.endsWith("creditnotes.edit")},newCreditnotes:function(e){return e.endsWith("creditnotes.new")}};a.getField("dateFormat").then(function(e){t.dateFormat=e,m()}),$("#editCreditNoteForm").validate({rules:{customer:"required",creditNumber:"required",creditCreateDate:"required"},messages:{customer:"Please select a customer",creditNumber:"Please enter credit note number",creditCreateDate:"Please provide credit note Create date"}}),$("#itemInfoForm").validate(),t.dateOptions={showWeeks:!1},t.save=function(){v()&&(showLoader(),b(),h({generateReceipt:!0}).then(function(e){hideLoader(),console.log(e),n.go("dashboard.sales.creditnotes.details",{creditNoteId:e.id})},function(e){hideLoader(),console.log(e.message)}))},t.saveAndSend=function(){v()&&(showLoader(),b(),g().then(function(e){hideLoader(),console.log(e),n.go("dashboard.sales.creditnotes.all")},function(e){hideLoader(),console.log(e)}))},t.cancel=function(){n.go("dashboard.sales.creditnotes.all")},t.addCreditItem=function(){var e=t.deletedItems.pop();e?--t.itemsWithIdinDel:(e={id:void 0},++t.itemsWithOutId),e.selectedItem=void 0,e.selectedTax=void 0,e.rate=0,e.quantity=1,e.discount=0,e.taxValue=0,e.amount=0,t.creditItems.push(e)},t.removeCreditItem=function(e){if(t.creditItems.length>1){var n=t.creditItems.splice(e,1)[0];n.id?(++t.itemsWithIdinDel,t.deletedItems.push(n)):--t.itemsWithOutId,x()}else console.log("there should be atleast 1 item in a creditNote")},t.openDatePicker=function(e){switch(e){case 1:t.openPicker1=!0}},t.reCalculateTotal=function(){var e=(Number(t.subTotal)||0)+(Number(t.totalTax)||0);t.total=e,t.totalStr=d(t.total,"$",2)},t.reCalculateItemAmount=function(e){var n=t.creditItems[e];n.selectedItem&&(n.amount=n.rate*n.quantity,x())},t.itemChanged=function(e){var n=t.creditItems[e];n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=t.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";t.reCalculateItemAmount(e)},t.customerChanged=function(){t.selectedCustomer.dummy?n.go("dashboard.customers.new",{backLink:n.current.name,creditNoteId:n.params.creditNoteId}):(showLoader(),e.when(C()).then(function(){t.creditItems.length<1?(t.addCreditItem(),t.totalTax=0,t.subTotal=0,t.subTotalStr=d(0,"$",2),t.reCalculateTotal()):x(),hideLoader()}))},t.sortByCreditNote=function(){"none"===$("#creditnote").css("display")?(t.creditNoteList.sort(function(e,t){return e.entity.creditNumber.localeCompare(t.entity.creditNumber)}),$("#creditnote").css({display:"inline-table"}),$("#creditnoteUp").css({display:"none"})):(t.creditNoteList.sort(function(e,t){return t.entity.creditNumber.localeCompare(e.entity.creditNumber)}),$("#creditnoteUp").css({display:"inline-table"}),$("#creditnote").css({display:"none"})),$("#date").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByDate=function(){"none"===$("#date").css("display")?(t.creditNoteList.sort(function(e,t){return e.entity.creditNoteDate>t.entity.creditNoteDate?-1:e.entity.creditNoteDate<t.entity.creditNoteDate?1:0}),$("#date").css({display:"inline-table"}),$("#dateUp").css({display:"none"})):(t.creditNoteList.sort(function(e,t){return t.entity.creditNoteDate>e.entity.creditNoteDate?-1:t.entity.creditNoteDate<e.entity.creditNoteDate?1:0}),$("#dateUp").css({display:"inline-table"}),$("#date").css({display:"none"})),$("#creditnote").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#creditnoteUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByRefNum=function(){"none"===$("#refno").css("display")?(t.creditNoteList.sort(function(e,t){return e.entity.reference||(e.entity.reference=""),t.entity.reference||(t.entity.reference=""),e.entity.reference.localeCompare(t.entity.reference)}),$("#refno").css({display:"inline-table"}),$("#refnoUp").css({display:"none"})):(t.creditNoteList.sort(function(e,t){return e.entity.reference||(e.entity.reference=""),t.entity.reference||(t.entity.reference=""),t.entity.reference.localeCompare(e.entity.reference)}),$("#refnoUp").css({display:"inline-table"}),$("#refno").css({display:"none"})),$("#date").css({display:"none"}),$("#creditnote").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#creditnoteUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByCusName=function(){t.creditNoteList.sort(function(e,t){return e.customer.displayName.localeCompare(t.customer.displayName)}),"none"===$("#cusname").css("display")?(t.creditNoteList.sort(function(e,t){return e.customer.displayName.localeCompare(t.customer.displayName)}),$("#cusname").css({display:"inline-table"}),$("#cusnameUp").css({display:"none"})):(t.creditNoteList.sort(function(e,t){return t.customer.displayName.localeCompare(e.customer.displayName)}),$("#cusnameUp").css({display:"inline-table"}),$("#cusname").css({display:"none"})),$("#date").css({display:"none"}),$("#creditnote").css({display:"none"}),$("#refno").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#creditnoteUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByStatus=function(){"none"===$("#status").css("display")?(t.creditNoteList.sort(function(e,t){return e.entity.status.localeCompare(t.entity.status)}),$("#status").css({display:"inline-table"}),$("#statusUp").css({display:"none"})):(t.creditNoteList.sort(function(e,t){return t.entity.status.localeCompare(e.entity.status)}),$("#statusUp").css({display:"inline-table"}),$("#status").css({display:"none"})),$("#date").css({display:"none"}),$("#creditnote").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#creditnoteUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByAmount=function(){t.creditNoteList.sort(function(e,t){return t.entity.total-e.entity.total}),"none"===$("#amount").css("display")?(t.creditNoteList.sort(function(e,t){return t.entity.total-e.entity.total}),$("#amount").css({display:"inline-table"}),$("#amountUp").css({display:"none"})):(t.creditNoteList.sort(function(e,t){return e.entity.total-t.entity.total}),$("#amountUp").css({display:"inline-table"}),$("#amount").css({display:"none"})),$("#date").css({display:"none"}),$("#creditnote").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#balance").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#creditnoteUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByBalance=function(){"none"===$("#balance").css("display")?(t.creditNoteList.sort(function(e,t){return t.entity.remainingCredits-e.entity.remainingCredits}),$("#balance").css({display:"inline-table"}),$("#balanceUp").css({display:"none"})):(t.creditNoteList.sort(function(e,t){return e.entity.remainingCredits-t.entity.remainingCredits}),$("#balanceUp").css({display:"inline-table"}),$("#balance").css({display:"none"})),$("#date").css({display:"none"}),$("#creditnote").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#creditnoteUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.showMenu=function(){$(".filtermenu").hasClass("show")?$(".filtermenu").removeClass("show"):$(".filtermenu").addClass("show")},t.currentCreditNotes="All Credit Notes",t.allCreditNotes=function(){t.creditNoteList=t.allcreditNoteList.filter(function(e){return!0}),t.displayedCreditNotes=t.creditNoteList,t.currentCreditNotes="All Credit Notes",$(".filtermenu").removeClass("show")},t.openCreditNotes=function(){t.creditNoteList=t.allcreditNoteList.filter(function(e){return"Open"==e.entity.status}),t.displayedCreditNotes=t.creditNoteList,t.currentCreditNotes="Open Credit Notes",$(".filtermenu").removeClass("show")},t.closedCreditNotes=function(){t.creditNoteList=t.allcreditNoteList.filter(function(e){return"Closed"==e.entity.status}),t.displayedCreditNotes=t.creditNoteList,t.currentCreditNotes="Closed Credit Notes",$(".filtermenu").removeClass("show")},t.voidCreditNotes=function(){t.estimateList=t.allcreditNoteList.filter(function(e){return"Void"==e.entity.status}),t.displayedCreditNotes=t.estimateList,t.currentCreditNotes="Void Credit Notes",$(".filtermenu").removeClass("show")},t.search=function(){t.searchText.length?t.creditNoteList=t.displayedCreditNotes.filter(function(e){return e.creditNoteDate||(e.creditNoteDate=""),e.entity.creditNumber||(e.entity.creditNumber=""),e.entity.reference||(e.entity.reference=""),e.customer.displayName||(e.customer.displayName=""),e.entity.status||(e.entity.status=""),e.total||(e.total=""),e.remainingCredits||(e.remainingCredits=""),e.creditNoteDate.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.creditNumber.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.reference.toLowerCase().includes(t.searchText.toLowerCase())||e.customer.displayName.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.status.toLowerCase().includes(t.searchText.toLowerCase())||e.total.toLowerCase().includes(t.searchText.toLowerCase())||e.remainingCredits.toLowerCase().includes(t.searchText.toLowerCase())}):t.creditNoteList=t.displayedCreditNotes}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CreditNoteDetailController",["$q","$scope","$state","$sce","$controller","userFactory","creditNoteService","coreFactory","commentFactory","currencyFilter",function(e,t,n,s,a,i,o,r,c,l){function d(){var a=n.params.creditNoteId;a&&(scrollToOffset(),showLoader(),e.when(o.getCreditNoteDetails(a)).then(function(e){var n=e.entity.get("userID");"General Employee"==i.entity[0].get("role")?i.entity[0].id==n.id&&(t.isOwner=!0):t.isOwner=!0,1==e.entity.get("customer").get("isDeleted")&&(t.isOwner=!1),console.log(e),t.creditNote=e,t.creditNo=e.entity.creditNumber,e.payments?(e.payments.forEach(function(e){e.date=formatDate(e.entity.date,g),e.amount=l(e.entity.amount*h.exchangeRate,h.currencySymbol,2)}),t.payments=e.payments):t.payments=[],e.comments&&e.comments.forEach(function(e){e.date=formatDate(e.entity.date,g)}),t.comments=e.comments;var s=e.entity.creditReceipt;return s?Promise.resolve(s):o.createCreditNoteReceipt(a).then(function(e){return e.get("creditReceipt")})}).then(function(e){return t.templateUrl=s.trustAsResourceUrl(e.url()),$.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:e.url()}}).then(function(e){var t=document.getElementById("creditFrame");t.src="about:blank",t.contentWindow.document.open(),t.contentWindow.document.write(e),t.contentWindow.document.close(),hideLoader()})},function(e){hideLoader(),console.log(e.message)}))}function u(n,s){var a={userID:p,organization:f,name:p.get("username"),date:new Date,isAutomaticallyGenerated:s,comment:n};if(p.get("isTrackUsage")||!s){var i={};return e.when(r.getUserRole(p)).then(function(e){return c.createNewComment(a,e)}).then(function(e){i.commentObj=e;var n=t.creditNote.entity,s=n.get("comments");return s?s.push(e):s=[e],n.set("comments",s),n.save()}).then(function(e){var n=new c(i.commentObj);return n.date=formatDate(n.entity.date,g),t.comments?t.comments.push(n):t.comments=[n],console.log(n),e})}}function m(e){var t=$(e).find("itemRow"),n=($(e).find("modsRow"),$(e).find("attachment")),s=$(e).find("customField"),a=$(e).find("tax");$("<td></td>");$(e).find("billType").text().includes("estimate")&&($(".footer .info").hide(),$(".payment-due").hide()),/^[\s]*$/.test(t.first().find("discount").text())?$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),t.each(function(e){if(/^[\s]*$/.test(t.first().find("discount").text())){var n=$("<tr class='invoice-items'></tr>"),s=$("<td class='ff1 fc0 invoice-item-title' style='width: 50mm;' colspan='2'>"+$(this).children("name").text()+"</td>"),a=$("<td class='ff1 fc0  invoice-item-qty' colspan='2'>"+$(this).children("qty").text()+"</td>"),i=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");n.append(s).append(a).append(i),$("#invoice-items-header").after($(n))}else{var n=$("<tr class='invoice-items'></tr>"),s=$("<td class='ff1 fc0 invoice-item-title' style='width: 50mm;' colspan='2'>"+$(this).children("name").text()+"</td>"),a=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("qty").text()+"</td>"),o=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("discount").text()+"</td>"),i=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");n.append(s).append(a).append(o).append(i),$("#invoice-items-header").after($(n))}}),a.each(function(){var e=$("<tr class='invoice-taxes'></tr>"),t=$("<td colspan='3' class=''></td>"),n=$("<td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).children("name").text()+"</td>"),s=$("<td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).children("value").text()+"</td>");e.append(t).append(n).append(s),$("#invoice-subtotal").after($(e))});var o=$('<tr class="salestax"></tr>');$("tr.adjustments").after(o),s.each(function(){$(".customFields").append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children("name").text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children("value").text()+"</p></div>"))}),n.each(function(){var e=$(this).text();e=(e=e.substring(e.indexOf("_")+1,e.length)).replace(/%20/g," "),$(".attach").append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+"'>"+e+"</a><br><br>")}),$("table tbody tr").each(function(){0==$(this).children().text().length&&$(this).addClass("hideOnMob")});var r=$(e).find("invoiceId").text();$("#pay-link").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+r),$("#pay-link-2").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+r);var c=$(e).find("items");console.log(c),c.each(function(){var e=new Date(Date.parse($(this).find("past-due").text())),t=new Date(Date.now());e=new Date(e.setHours(0,0,0,0)),t=new Date(e.setHours(0,0,0,0)),e.getTime()>=t.getTime()||"Invalid Date"===e.toString()?($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("green-status")):($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("red-status"));o=$(this).find("headerTitle").text();$(".payment-due p:first").append(o);"true"===$(this).find("disablePay").text()&&($(".btn-border-pay").addClass("disable"),$(".info.cl").addClass("disable"),$(".payment-due").removeClass("red-status"),$(".payment-due").addClass("green-status"));var n=$(this).find("discountAmount").text(),s=$('<tr class="discount"></tr>');s.append($('<td class="discountNm" colspan="3"></td>').html("Discount")),s.append($('<td class="discountPr"></td>').html(n)),"after"==$(this).find("discountPlace text").text()?$(".salestax:last").after(s):"before"==$(this).find("discountPlace text").text()&&$(".salestax:first").before(s);a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountNameBottom").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountAmount").text()+"</td></tr>");if("after"==$(this).find("discountPlace text").text()?$(".invoice-taxes:last").after($(a)):"before"==$(this).find("discountPlace text").text()&&$("#invoice-subtotal").after($(a)),$(this).find("adjustments").text().length>0){var a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustments").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustmentsPrice").text()+"</td></tr>");$("#invoice-subtotal").after($(a))}$(this).find("shippingCharges").text().length>0&&(a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingCharges").text()+"</td><td class='ff1 fc1 ' style=' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingChargesPrice").text()+"</td></tr>"),$("#invoice-subtotal").after($(a)));var o=$(this).find("headerTitle").text(),r=$(this).find("past-due").text();o?$("#pdf-title").text(o+"   "+r):($("#pdf-title").text(""),$(".top-bar").css("height","0mm"),$(".top-bar").css("border-bottom","0mm")),$("#pdf-business-name").text(i.entity[0].get("company")),$("#pdf-invoice-title").text($(this).find("invoice-title").text()),$("#pdf-invoice-number").text($(this).find("refid").text()),$("#pdf-amount-received").text($(this).find("body-price").text()),$("#pdf-date").text($(this).find("body-date").text()),$("#pdf-subtotal").text($(this).find("subtotalprice").text()),$("#pdf-payment-made").text($(this).find("paymentMadePrice").text()),$("#pdf-total").text($(this).find("total-price3").text()),$("#pdf-total-top").text($(this).find("total-price3").text()),$("#pdf-credit-applied").text($(this).find("creditsAppliedPrice").text()),$("#pdf-amount-due").text($(this).find("refundtotal").text()),$("#pdf-payment-name").text($(this).find("title").text()),$("#pdf-currency").text($(this).find("body-currency").text()),$("#pdf-total-text").text($(this).find("refundedText").text()),$("#pdf-payment-text").text($(this).find("paymentMadeText").text()),$("#pdf-credit-text").text($(this).find("creditsAppliedText").text());var c=$(this).find("addres1").text();$("#pdf-address").html(c);var l=$(this).find("longmsg").text();if(0!=l.length){I=$(this).find("longmsg-title").text();$("#pdf-notes-title").html(I),$("#pdf-notes").html(l)}else $("#pdf-notes-title").html(""),$("#pdf-notes").html(""),$("#pdf-notes-title").hide(),$("#pdf-notes").hide();k=$(this).find("ordernotes-title").text();(E=$(this).find("ordernotes").text())?($("#pdf-terms-title").text(k),$("#pdf-terms").text(E)):($("#pdf-terms-title").text(""),$("#pdf-terms").text(""),$("#pdf-terms-title").hide(),$("#pdf-terms").hide());w=$(this).find("mailto").text();$("#user-mail").attr("href",w);T=$(this).find("mailtotxt").text();$("#user-mail").text(T);F=$(this).find("clientmailto").text();$("#client-mail").attr("href",F);S=$(this).find("clientmail").text();$("#client-mail").text(S);P=$(this).find("clientname").text();$("#client-name").text(P);D=$(this).find("nr").text();$("#user-phone").attr("href","tel:"+D),$("#user-phone").text(D);var d=$(this).find("refid").text();$(".visa-card").append(d);var u=$(this).find("purchaseOrderNumber").text();$(".purchase-order").append(u);var m=$(this).find("invoice-title").text();$(".invoice-details-1 h1").append(m);var p=$(this).find("list-header-total").text();$(".list-header li:first-child span").append(p);var f=$(this).find("list-header-date").text();$(".list-header li:nth-child(2) span").append(f);var h=$(this).find("list-header-currency").text();$(".list-header li:nth-child(3) span").append(h);var y=$(this).find("body-price").text();$(".list-body li:first-child span").append(y);g=$(this).find("body-date").text();$(".list-body li:nth-child(2) span").append(g);var g=$(this).find("body-currency").text();$(".list-body li:nth-child(3) span").append(g);var v=$(this).find("th1").text();$(".content.cl th.item").append(v);var b=$(this).find("addres1").text();$(".invoice-details-1 .info-2 p .adr").append(b);var x=$(this).find("website-link").text();$(".invoice-details-1 .info-2 .website a").attr("href",x);var C=$(this).find("website-name").text();$(".invoice-details-1 .info-2 .website a span").append(C);var w=$(this).find("mailto").text();$(".invoice-details-1 .info-2 .mailto a").attr("href",w);var T=$(this).find("mailtotxt").text();$(".invoice-details-1 .info-2 .mailto a span").append(T);var D=$(this).find("nr").text();$(".invoice-details-1 .info-2 .nr a").attr("href",D),$(".invoice-details-1 .info-2 .nr a span").append(D);var N=$(this).find("thanksmsg").text();if($(".invoice-details-2 .info-1 p:nth-child(1)").append(N),0!=(l=$(this).find("longmsg").text()).length){var I=$(this).find("longmsg-title").text();$(".notes_para_head").html(I),$(".notes_para").html(l)}var L=$(this).find("to").text();$(".invoice-details-2 .info-2 p:first-child").append(L);var P=$(this).find("clientname").text();$(".invoice-details-2 .info-2 .list-client li:first-child span").append(P);var U=$(this).find("clientnr").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(2) a").attr("href",U),$(".invoice-details-2 .info-2 .list-client li:nth-child(2) a span").append(U);var F=$(this).find("clientmailto").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(3) a").attr("href",F);var S=$(this).find("clientmail").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(3) a span").append(S);var k=$(this).find("ordernotes-title").text(),E=$(this).find("ordernotes").text();$(".orderNotes").append(k),$(".orderNotesValues").append(E);var j=$(this).find("subtotal").text();$("td.subtotal").append(j);var R=$(this).find("adjustments").text();$("td.adjustments").append(R);var A=$(this).find("adjustmentsPrice").text();$("td.adjustments-price").append(A);var M=$(this).find("shippingCharges").text();$("td.shippingCharges").append(M);var B=$(this).find("shippingChargesPrice").text();$("td.shipping-charges-price").append(B);$(this).find("total-price").text();var O=$(this).find("salestax").text();$(".salestax").append(O);var q=$(this).find("paymentMadeText").text(),z=$(this).find("paymentMadePrice").text();$("td.payment-made-text").append(q),$("td.payment-made-price").append(z);var H=$(this).find("paymentRefundMadeText").text(),G=$(this).find("paymentRefundMadePrice").text();""==H?($("td.payment-refund-made-text").hide(),$("td.payment-refund-made-price").hide()):($("td.payment-refund-made-text").append(H),$("td.payment-refund-made-price").append(G));var W=$(this).find("creditsAppliedText").text(),V=$(this).find("creditsAppliedPrice").text();$("td.credits-applied-text").append(W),$("td.credits-applied-price").append(V);var K=$(this).find("total-price2").text();$(".total-price2").append(K);var _=$(this).find("total-price3").text();$(".total-price3").append(_);var Y=$(this).find("totaltext").text();$(".totl").append(Y);var X=$(this).find("refundtotal").text();$("td.refund-total").append(X);var Z=$(this).find("refundedText").text();$(".refund-price").append(Z);var J=$(this).find("total-price4").text();$(".total-price4").append(J);var Q=$(this).find("saletax").text();$(".saletax").append(Q);var ee=$(this).find("paymentmsg").text();$(".footer .info p:first-child").append(ee);var te=$(this).find("signup").text();$(".footer .info p span").append(te);var ne=$(this).find("copyright").text();$(".copyright p").append(ne);var se=$(this).find("title").text();$("head title").append(se);var ae=$(this).find("item4price").text();$(".price .item4price").append(ae);var ie=$(this).find("subtotalprice").text();$(".subtotal-price").append(ie);var oe=$(this).find("received-text").text();$(".received-text").append(oe);var re=$(this).find("received-price").text();$(".received-price").append(re);var ce=$(this).find("due-text").text();$(".due-text").append(ce);var le=$(this).find("due-price");$(".due-price").append(le);var de=$(this).find("tip-text");$(".tip-text").append(de);var ue=$(this).find("tip-price");$(".tip-price").append(ue)}),$.ajax({method:"POST",type:"POST",url:"generatePDF.php",data:{html:$(".pdf-page").html()}}).then(function(e){var t=document.getElementById("pdfLink"),n="data:application/octet-stream;base64,"+e;t.href=n,t.click()},function(e){console.error(e)})}if(i.entity.length){var p=i.entity[0],f=p.get("organizations")[0];a("DashboardController",{$scope:t,$state:n});var h=i.entity[0].currency.attributes;if(h.exchangeRate)t.currentCurrency=h;else{var y={currencySymbol:"$",exchangeRate:1};t.currentCurrency=y,h=y}var g=void 0;i.getField("dateFormat").then(function(e){t.dateFormat=e,g=t.dateFormat.toUpperCase().replace(/E/g,"d"),d()}),t.isOwner=!1,t.dateOptions={showWeeks:!1},t.changeTemplate=function(){showLoader(),e.when(r.getInvoiceTemplates()).then(function(e){var n=p.get("defaultTemplate"),s=[];e.forEach(function(e){var t={entity:e,name:e.get("name"),url:e.get("templatePreview").url()};n||"Template 1"!=t.name?t.isDefault=n.id==e.id:t.isDefault=!0,s.push(t)}),t.templates=s,$(".change-template").addClass("show"),hideLoader()},function(e){console.log(e.message),hideLoader()})},t.setDefaultTemplate=function(s){showLoader(),t.templates.forEach(function(e){e.isDefault=!1}),t.templates[s].isDefault=!0,t.creditNote.entity.unset("creditReceipt"),p.set("defaultTemplate",t.templates[s].entity);var a=[];a.push(p.save()),a.push(t.creditNote.entity.save()),e.all(a).then(function(){hideLoader(),$(".change-template").removeClass("show"),console.log("default template selected"),n.reload()},function(e){hideLoader(),console.log(e,message)})},t.prepareAddPayment=function(){t.paymentDate=new Date,t.paymentAmount=t.creditNote.entity.remainingCredits.toFixed(2),t.paymentRef=""+Math.random().toString(10).substr(2,6),t.paymentModes=["Check","Cash","Bank Transfer","Bank Remittance"],t.selectedPaymentMode="Cash",$("#paymentForm").validate({rules:{paymentDate:"required",paymentAmount:{required:!0,number:!0,min:.01,max:t.creditNote.entity.remainingCredits.toFixed(2)},paymentRef:"required",paymentMode:"required"},messages:{paymentDate:"Please select date",paymentAmount:{required:"Please enter refund amount",number:"Please enter valid amount",min:"Amount must be greater than 0",max:"Amount cannot be greater than remaining credits"},paymentRef:"Please enter reference number",paymentMode:"Please select refund mode"}}),$("#paymentForm").validate().resetForm()},t.addPayment=function(){if($("#paymentForm").valid()){showLoader();var s={userID:p,organization:f,date:t.paymentDate,mode:t.selectedPaymentMode,amount:Number(t.paymentAmount),reference:t.paymentRef,notes:t.paymentNotes,deleted:!1},a=t.creditNote.entity;a.unset("creditReceipt"),a.increment("refundsMade",s.amount),a.increment("remainingCredits",-s.amount),a.remainingCredits<=0?a.set("status","Closed"):a.set("status","Open"),e.when(r.getUserRole(p)).then(function(t){return e.when(o.addRefunds([s],t))}).then(function(e){var t=a.get("refunds");return t=t?t.concat(e):e,a.set("refunds",t),a.save()}).then(function(){u("Refund made for "+l(t.paymentAmount,"$",2)+" amount",!0).then(function(e){hideLoader(),n.reload()})})}},t.textReceipt=function(){$("#text-error").hide();var e=t.creditNote.entity.get("customer").get("contactPersons");t.mobileContacts=[],e.length&&e.forEach(function(e){var n=e.get("firstname")?e.get("firstname"):"",s=e.get("lastname")?e.get("lastname"):"",a=1==e.get("defaultPerson"),i=n+" "+s;e.get("phone")&&t.mobileContacts.push({selected:!1,contact:e.get("phone"),contactName:"("+i+") "+e.get("phone")}),e.get("mobile")&&t.mobileContacts.push({selected:a,contact:e.get("mobile"),contactName:"("+i+") "+e.get("mobile")})}),t.mobileContacts.length?$(".text-popup").addClass("show"):ShowMessage("Please Enter Mobile for Customer!","error")},t.sendText=function(){var e=0;t.mobileContacts.forEach(function(t){t.selected&&e++}),e<1?$("#text-error").show():(showLoader(),t.mobileContacts.forEach(function(e){e.selected&&o.sendCreditNoteTextToNumber(t.creditNote.entity,e.contact).then(function(t){u("Credit Note texted to "+e.contact,!0),$(".text-popup").removeClass("show"),hideLoader()})}))},t.emailReceipt=function(){$("#email-error").hide();var e=t.creditNote.entity.get("customer").get("contactPersons");t.contacts=[],e.length&&e.forEach(function(e){var n=e.get("firstname")?e.get("firstname"):"",s=e.get("lastname")?e.get("lastname"):"",a=1==e.get("defaultPerson"),i=n+" "+s;e.get("email")&&t.contacts.push({selected:a,contact:e.get("email"),contactName:"("+i+") "+e.get("email")})}),t.contacts.length?$(".email-popup").addClass("show"):ShowMessage("Please Enter Email for Customer!","error")},t.sendEmail=function(){var e=0;t.contacts.forEach(function(t){t.selected&&e++}),e<1?$("#email-error").show():(showLoader(),t.contacts.forEach(function(e){e.selected&&o.sendCreditNoteReceiptToEmail(t.creditNote.entity,e.contact).then(function(t){u("Credit Note emailed to "+e.contact,!0),$(".email-popup").removeClass("show"),hideLoader()})}))},t.creditNotePrinted=function(){u("Credit Note printed",!0)},t.addComment=function(){if(t.newComment){showLoader();var n={userID:p,organization:f,name:p.get("username"),date:new Date,isAutomaticallyGenerated:!1,comment:t.newComment},s={};e.when(r.getUserRole(p)).then(function(e){return c.createNewComment(n,e)}).then(function(e){s.commentObj=e;var n=t.creditNote.entity,a=n.get("comments");return a?a.push(e):a=[e],n.set("comments",a),n.save()}).then(function(){var e=new c(s.commentObj);e.date=formatDate(e.entity.date,g),t.comments?t.comments.push(e):t.comments=[e],console.log(e),$(".add-comment").removeClass("show"),t.newComment="",hideLoader()})}else $(".add-comment").removeClass("show")},t.downloadInvoice=function(){var e=t.creditNote.entity.get("creditLabels")._url,n=new XMLHttpRequest;n.open("GET",e,!1),n.setRequestHeader("Content-Type","text/xml"),n.send(null),m(n.responseXML)}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CloneEstimateController",["$scope","$state","$controller","$q","userFactory","estimateService","coreFactory","taxService","expenseService","currencyFilter",function(e,t,n,s,a,i,o,r,c,l){function d(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:1,digits:!0,messages:{required:"Please provide item quantity",min:"quantity should be >= 1",digits:"quantity must be integer"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0"}})}),$(".check-discount").each(function(){$(this).rules("remove"),$(this).rules("add",{min:0,max:100,number:!0,messages:{min:"discount should be >= 0",max:"discount should be <= 100"}})})}function u(){var t=[],n=null;return n=s.when(o.getAllCustomers()).then(function(t){e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)})}),t.push(n),n=s.when(o.getAllItems({organization:x})).then(function(t){e.actualItems=t.filter(function(e){return!e.entity.expanseId}),e.expenseItems=t.filter(function(e){return e.entity.expanseId}),e.items=e.actualItems}),t.push(n),n=s.when(i.getPreferences(b)).then(function(t){e.prefs=t}),t.push(n),n=s.when(o.getUserRole(b)).then(function(t){e.userRole=t}),t.push(n),n=r.getTaxes(b,function(t){e.taxes=t}),t.push(n),s.all(t)}function m(){var t=e.estimate;switch(1==e.prefs.numAutoGen?(e.estimateNo=e.prefs.estimateNumber,e.disableEstNo=!0):(e.estimateNo="",e.disableEstNo=!1),e.refNumber=t.entity.referenceNumber||"",e.todayDate=new Date,e.prefs.discountType){case 0:e.itemLevelTax=!1,e.invoiceLevelTax=!1;break;case 1:e.itemLevelTax=!0,e.invoiceLevelTax=!1;break;case 2:case 3:e.itemLevelTax=!1,e.invoiceLevelTax=!0}e.discount=t.entity.discounts,e.notes=t.entity.notes,e.terms=t.entity.termsConditions,e.showShippingCharges=!1,e.showAdjustments=!1,e.prefs.salesPerson&&(e.salesPerson=t.entity.salesPerson||"",e.showSalesPerson=!0),"Draft"!=t.entity.status&&(e.previouslySent=!0);var n=t.entity.estimateFiles;n?(n.forEach(function(e){e.fileName=e.name(),e.exist=!0}),e.files=n):e.files=[];for(var s=0;s<t.estimateItems.length;++s){var a=t.estimateItems[s].entity,i=a.get("item"),o={};o.selectedItem=e.items.filter(function(t){if(t.entity.id===i.id){o.id=a.id,o.rate=a.amount/a.quantity,o.quantity=a.quantity,o.discount=a.discount||0,o.taxValue=0,o.amount=a.amount;var n=a.get("tax");return o.selectedTax=n?e.taxes.filter(function(e){return e.id===n.id})[0]:void 0,!0}return!1})[0],e.estimateItems.push(o)}var r=[];e.prefs.customFields&&e.prefs.customFields.forEach(function(e){"YES"==e.isChecked&&r.push({name:e.name,value:""})});var c=t.entity.customFields;c&&c.length&&r.forEach(function(e){for(var t=0;t<c.length;++t)if(c[t][e.name]){e.value=c[t][e.name];break}}),e.customFields=r,f(),hideLoader()}function p(){return s.when(c.getCustomerExpenses({organization:x,customer:e.selectedCustomer.entity})).then(function(t){for(var n=[],s=0;s<t.length;++s)for(var a=0;a<e.expenseItems.length;++a)t[s].entity.id==e.expenseItems[a].entity.expanseId&&n.push(e.expenseItems[a]);for(var i=[],s=0;s<t.length;++s){var o=t[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}var r=e.actualItems.concat(n,i);return e.estimateItems=e.estimateItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),e.items=r})}function f(){var t=e.estimateItems,n=0,s=0;e.itemTaxes=[],t.forEach(function(t){n+=t.amount*(.01*(100-t.discount)),t.taxValue=calculateTax(t.amount,t.selectedTax),s+=t.taxValue,t.selectedTax&&e.itemTaxes.push({nameValue:t.selectedTax.name+" ("+t.selectedTax.rate+"%)",amount:l(t.taxValue,"$",2)})}),e.totalTax=s,e.subTotal=n,e.subTotalStr=l(n,"$",2),e.reCalculateTotal()}function h(){var t={userID:b,organization:x,customer:e.selectedCustomer.entity,estimateDate:e.todayDate,estimateNumber:e.estimateNo,status:"Draft",discountType:e.prefs.discountType,discounts:e.discount,shippingCharges:e.shippingCharges,adjustments:e.adjustments,subTotal:Number(e.subTotal),totalAmount:Number(e.total),referenceNumber:e.refNumber,salesPerson:e.salesPerson,notes:e.notes,termsConditions:e.terms};if(e.customFields.length){var n=[];e.customFields.forEach(function(e){if(e.value){var t={};t[e.name]=e.value,n.push(t)}}),n.length&&(t.customFields=n)}var s=e.selectedCustomer.entity.email;return s&&(t.customerEmails=[s]),i.createNewEstimate(t,e.estimateItems,e.userRole,e.files)}function y(){return h().then(function(e){return i.createEstimateReceipt(e.id).then(function(e){return i.sendEstimateReceipt(e)})})}function g(){d();var e=$("#addEstimateForm").valid(),t=$("#itemInfoForm").valid(),n=$("#extrasForm").valid();if(e&&t&&n)return!0;var s=void 0;e?t?n||(s=$("#extrasForm").validate()):s=$("#itemInfoForm").validate():s=$("#addEstimateForm").validate();var a=$(s.errorList[0].element).offset().top-30;return scrollToOffset(a),!1}function v(){$("#addEstimateForm").validate().showErrors({estimateNumber:"Estimate with this number already exists"})}if(a.entity.length){var b=a.entity[0],x=b.get("organizations")[0];n("DashboardController",{$scope:e,$state:t});var C=t.params.estimateId;C&&(showLoader(),s.when(u()).then(function(e){return s.when(i.getEstimate(C))}).then(function(t){return console.log(t),e.estimate=t,e.estimateItems=[],e.deletedItems=[],e.itemsWithOutId=0,e.itemsWithIdinDel=0,e.selectedCustomer=e.customers.filter(function(e){return t.entity.get("customer").id==e.entity.id})[0],s.when(p())}).then(function(){m()},function(e){hideLoader(),console.log(e.message)}),$("#addEstimateForm").validate({rules:{customer:"required",estimateNumber:"required",estimateCreateDate:"required"},messages:{customer:"Please select a customer",estimateNumber:"Please enter estimate number",estimateCreateDate:"Please provide estimate Create date"}}),$("#extrasForm").validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$("#itemInfoForm").validate(),e.dateOptions={showWeeks:!1},e.addNewFile=function(t){var n=t.files[0],s=n.name;s.toLowerCase().endsWith(".pdf")||s.toLowerCase().endsWith(".png")||s.toLowerCase().endsWith(".jpg")||s.toLowerCase().endsWith(".jpeg")?($("#file-error").hide(),n.fileName=n.name,e.files.push(n),e.$$phase||e.$apply()):$("#file-error").show()},e.removeFile=function(t){e.files.splice(t,1)},e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0}},e.addEstimateItem=function(){e.estimateItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},e.removeEstimateItem=function(t){e.estimateItems.length>1?(e.estimateItems.splice(t,1),f()):console.log("there should be atleast 1 item in an estimate")},e.reCalculateTotal=function(){var t=Number(e.subTotal)||0,n=Number(e.discount)||0,s=Number(e.shippingCharges)||0,a=Number(e.adjustments)||0,i=Number(e.totalTax)||0,o=t+i,r=.01*(100-n);2==e.prefs.discountType?o=t*r+i:3==e.prefs.discountType&&(o=(t+i)*r),n=Math.abs(o-t-i),e.total=o+s+a,e.discountStr=l(n,"$",2),e.shippingChargesStr=l(s,"$",2),e.adjustmentsStr=l(a,"$",2),e.totalStr=l(e.total,"$",2)},e.reCalculateItemAmount=function(t){var n=e.estimateItems[t];n.selectedItem&&(n.amount=n.rate*n.quantity,f())},e.itemChanged=function(t){var n=e.estimateItems[t];n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=e.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";e.reCalculateItemAmount(t)},e.customerChanged=function(){showLoader(),s.when(p()).then(function(){e.estimateItems.length<1?(e.addEstimateItem(),e.totalTax=0,e.subTotal=0,e.subTotalStr=l(0,"$",2),e.reCalculateTotal()):f(),hideLoader()})},e.cancel=function(){t.go("dashboard.sales.estimates.all")},e.save=function(){g()&&(showLoader(),s.when(i.checkEstimateNumAvailable({estimateNumber:e.estimateNo,organization:x})).then(function(e){return e?h():(v(),scrollToOffset(),Promise.reject("Estimate with this number already exists"))}).then(function(e){hideLoader(),t.go("dashboard.sales.estimates.all")},function(e){hideLoader(),console.log(e)}))},e.saveAndSend=function(){g()&&(showLoader(),s.when(i.checkEstimateNumAvailable({estimateNumber:e.estimateNo,organization:x})).then(function(e){return e?y():(v(),scrollToOffset(),Promise.reject("Estimate with this number already exists"))}).then(function(e){hideLoader(),t.go("dashboard.sales.estimates.all")},function(e){hideLoader(),console.log(e)}))})}else console.log("User not logged in")}]),invoicesUnlimited.controller("CreateEstimateController",["$scope","$state","$controller","$q","userFactory","estimateService","coreFactory","taxService","commentFactory","expenseService","currencyFilter","salesCommon",function(e,t,n,s,a,i,o,r,c,l,d,u){function m(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:1,digits:!0,messages:{required:"Please provide item quantity",min:"quantity should be >= 1",digits:"quantity must be integer"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0",number:"Please enter a valid price"}})}),$(".check-discount").each(function(){$(this).rules("remove"),$(this).rules("add",{min:0,max:100,number:!0,messages:{min:"discount should be >= 0",max:"discount should be <= 100"}})})}function p(){switch(1==e.prefs.numAutoGen?(e.estimateNo=e.prefs.estimateNumber,e.disableEstNo=!0):(e.estimateNo="",e.disableEstNo=!1),e.notes=e.prefs.notes,e.terms=e.prefs.terms,e.files=[],e.todayDate=new Date,e.subTotalStr=d(0,"$",2),e.prefs.discountType){case 0:e.itemLevelTax=!1,e.invoiceLevelTax=!1;break;case 1:e.itemLevelTax=!0,e.invoiceLevelTax=!1;break;case 2:case 3:e.itemLevelTax=!1,e.invoiceLevelTax=!0,e.discountStr=d(0,"$",2)}e.showShippingCharges=!1,e.showAdjustments=!1,e.prefs.salesPerson&&(e.showSalesPerson=!0),e.estimateItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var n=t.params.customerId,a=t.params.expenseId;n&&(e.selectedCustomer=e.customers.filter(function(e){return e.entity.id==n})[0],y(),a&&s.when(h()).then(function(){e.addEstimateItem(),e.estimateItems[0].selectedItem=e.items.filter(function(e){return e.entity.expanseId==a})[0],e.estimateItems[0].selectedItem.create=!0,e.itemChanged(0)}));var i=[];e.prefs.customFields&&e.prefs.customFields.forEach(function(e){"YES"==e.isChecked&&i.push({name:e.name,value:""})}),e.customFields=i,hideLoader()}function f(){var t=e.estimateItems,n=0,s=0;e.itemTaxes=[],t.forEach(function(t){n+=t.amount*(.01*(100-t.discount));var a=Number(e.discount)||0;if(2==e.prefs.discountType?t.taxValue=calculateTax(t.amount*(.01*(100-a)),t.selectedTax):t.taxValue=calculateTax(t.amount,t.selectedTax),s+=t.taxValue,t.selectedTax){var i=-1;e.itemTaxes.length&&(i=e.itemTaxes.findIndex(function(e){return e.name==t.selectedTax.name})),-1==i?e.itemTaxes.push({nameValue:t.selectedTax.name+" ("+t.selectedTax.rate+"%)",amount:d(t.taxValue,"$",2),count:1,name:t.selectedTax.name,amountValue:t.taxValue}):(e.itemTaxes[i].amountValue+=t.taxValue,e.itemTaxes[i].count++,e.itemTaxes[i].amount=d(e.itemTaxes[i].amountValue,"$",2),e.itemTaxes[i].nameValue=t.selectedTax.name+" ("+t.selectedTax.rate+"%)")}}),e.totalTax=s,e.subTotal=n,e.subTotalStr=d(n,"$",2),e.reCalculateTotal()}function h(){return s.when(l.getCustomerExpenses({organization:N,customer:e.selectedCustomer.entity})).then(function(t){for(var n=[],s=0;s<t.length;++s)if("Yes"==t[s].entity.get("billable"))for(var a=0;a<e.expenseItems.length;++a)t[s].entity.id==e.expenseItems[a].entity.expanseId&&n.push(e.expenseItems[a]);for(var i=[],s=0;s<t.length;++s)if("No"!=t[s].entity.get("billable")){var o=t[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}e.actualItems.pop();var r=e.actualItems.concat(n,i);return e.estimateItems=e.estimateItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),"Sales"!=D.get("role")&&r.push(createItemOpener),e.items=r})}function y(){e.selectedCustomer.dummy?t.go("dashboard.customers.new",{backLink:t.current.name}):(showLoader(),s.when(h()).then(function(){e.estimateItems.length<1?(e.addEstimateItem(),e.totalTax=0,e.subTotal=0,e.subTotalStr=d(0,"$",2),e.reCalculateTotal()):f(),hideLoader()}))}function g(){var t={userID:D,organization:N,customer:e.selectedCustomer.entity,estimateDate:e.todayDate,estimateNumber:e.estimateNo,status:"Draft",discountType:e.prefs.discountType,discounts:e.discount,shippingCharges:e.shippingCharges,adjustments:e.adjustments,subTotal:Number(e.subTotal),totalAmount:Number(e.total),referenceNumber:e.refNumber,salesPerson:e.salesPerson,notes:e.notes,termsConditions:e.terms};if(e.customFields.length){var n=[];e.customFields.forEach(function(e){if(e.value){var t={};t[e.name]=e.value,n.push(t)}}),n.length&&(t.customFields=n)}var s=e.selectedCustomer.entity.email;return s&&(t.customerEmails=[s]),i.createNewEstimate(t,e.estimateItems,e.userRole,e.files).then(function(e){return C("Estimate created for "+d(e.attributes.totalAmount,"$",2)+" amount",!0,e),e})}function v(){return g().then(function(e){return i.createEstimateReceipt(e.id).then(function(e){return"Draft"==e.get("status")&&(e.set("status","Sent"),e.save()),b(e),e})})}function b(t){e.contacts.forEach(function(e){e.selected&&i.sendEstimateReceiptToEmail(t,e.contact).then(function(n){C("Estimate emailed to "+e.contact,!0,t)})}),e.mobileContacts.forEach(function(e){e.selected&&i.sendEstimetTextToNumber(t,e.contact).then(function(n){C("Estimate texted to "+e.contact,!0,t)})})}function x(){m();var e=$("#addEstimateForm").valid(),t=$("#itemInfoForm").valid(),n=$("#extrasForm").valid();if(e&&t&&n)return!0;var s=void 0;e?t?n||(s=$("#extrasForm").validate()):s=$("#itemInfoForm").validate():s=$("#addEstimateForm").validate();var a=$(s.errorList[0].element).offset().top-30;return scrollToOffset(a),!1}function C(e,t,n){var a={userID:D,organization:N,name:D.get("username"),date:new Date,isAutomaticallyGenerated:!1,comment:e};if(D.get("isTrackUsage")||!t){var i={};s.when(o.getUserRole(D)).then(function(e){return c.createNewComment(a,e)}).then(function(e){i.commentObj=e;var t=n.get("comments");t?t.push(e):t=[e],n.set("comments",t),n.save()})}}function w(){x()&&(showLoader(),s.when(i.checkEstimateNumAvailable({estimateNumber:e.estimateNo,organization:N})).then(function(e){return e?v():(T(),scrollToOffset(),Promise.reject("Estimate with this number already exists"))}).then(function(e){hideLoader(),t.go("dashboard.sales.estimates.details",{estimateId:e.id})},function(e){hideLoader(),t.go("dashboard.sales.estimates.all"),console.log(e)}))}function T(){$("#addEstimateForm").validate().showErrors({estimateNumber:"Estimate with this number already exists"})}if(a.entity.length){var D=a.entity[0],N=D.get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),function(){showLoader();var t=[],n=null;n=s.when(o.getAllCustomers()).then(function(t){t=t.filter(function(e){return"active"==e.entity.status}),e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),e.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),"Sales"!=D.get("role")&&e.customers.push(createCustomerOpener)}),t.push(n),n=s.when(o.getAllItems({organization:N})).then(function(t){e.actualItems=t.filter(function(e){return!e.entity.expanseId}),e.expenseItems=t.filter(function(e){return e.entity.expanseId}),e.items=e.actualItems,"Sales"!=D.get("role")&&e.items.push(createItemOpener)}),t.push(n),n=s.when(i.getPreferences(D)).then(function(t){e.prefs=t}),t.push(n),n=s.when(o.getUserRole(D)).then(function(t){e.userRole=t}),t.push(n),n=r.getTaxes(D,function(t){e.taxes=t,"Sales"!=D.get("role")&&e.taxes.push(createTaxOpener)}),t.push(n),n=a.getField("dateFormat").then(function(t){e.dateFormat=t}),t.push(n),s.all(t).then(function(){p()},function(e){hideLoader(),console.log(e.message)})}(),$("#addEstimateForm").validate({rules:{customer:"required",estimateNumber:"required",estimateCreateDate:"required"},messages:{customer:"Please select a customer",estimateNumber:"Please enter estimate number",estimateCreateDate:"Please provide estimate Create date"}}),$("#extrasForm").validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$("#itemInfoForm").validate(),e.dateOptions={showWeeks:!1},e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0}},e.addNewFile=function(t){var n=t.files[0],s=n.name;s.toLowerCase().indexOf("^")>=0&&(s=s.replace("^","")),s.toLowerCase().endsWith(".pdf")||s.toLowerCase().endsWith(".png")||s.toLowerCase().endsWith(".jpg")||s.toLowerCase().endsWith(".jpeg")?($("#file-error").hide(),t.files[0].size>5242880?$("#file-size-error").show():($("#file-size-error").hide(),n.fileName=s,e.files.push(n),e.$$phase||e.$apply())):$("#file-error").show()},e.removeFile=function(t){e.files.splice(t,1)},e.addEstimateItem=function(){e.estimateItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},e.removeEstimateItem=function(t){e.estimateItems.length>1?(e.estimateItems.splice(t,1),f()):console.log("there should be atleast 1 item in an estimate")},e.reCalculateTotal=function(){var t=Number(e.subTotal)||0,n=Number(e.discount)||0,s=Number(e.shippingCharges)||0,a=Number(e.adjustments)||0,i=Number(e.totalTax)||0,o=t+i,r=.01*(100-n);2==e.prefs.discountType?o=t*r+i:3==e.prefs.discountType&&(o=(t+i)*r),n=Math.abs(o-t-i),e.total=o+s+a,e.discountStr=d(n,"$",2),e.shippingChargesStr=d(s,"$",2),e.adjustmentsStr=d(a,"$",2),e.totalStr=d(e.total,"$",2)},e.reCalculateSubTotal=f,e.reCalculateItemAmount=function(t){var n=e.estimateItems[t];n.selectedItem&&(n.amount=n.rate*n.quantity,f())},e.prepareCreateItem=function(){u.prepareCreateItem({_scope:e})},e.createNewItem=function(){u.createNewEstimateItem({_scope:e,user:D,organization:N})},e.itemChanged=function(t){var n=e.estimateItems[t];if(n.selectedItem.dummy)return n.selectedItem=null,$(".new-item").addClass("show"),e.itemChangedIndex=t,void e.prepareCreateItem();n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=e.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";e.reCalculateItemAmount(t)},e.customerChanged=y,e.cancel=function(){t.go("dashboard.sales.estimates.all")},e.save=function(){x()&&(showLoader(),s.when(i.checkEstimateNumAvailable({estimateNumber:e.estimateNo,organization:N})).then(function(e){return e?g():(T(),scrollToOffset(),Promise.reject("Estimate with this number already exists"))}).then(function(e){hideLoader(),t.go("dashboard.sales.estimates.details",{estimateId:e.id})},function(e){hideLoader(),console.log(e)}))},e.saveAndSend=function(){if(x()){$("#emailText-error").hide();var t=e.selectedCustomer.entity.get("contactPersons");e.contacts=[],e.mobileContacts=[],t.length&&t.forEach(function(t){var n=t.get("firstname")?t.get("firstname"):"",s=t.get("lastname")?t.get("lastname"):"",a=1==t.get("defaultPerson"),i=n+" "+s;t.get("email")&&e.contacts.push({selected:a,contact:t.get("email"),contactName:"("+i+") "+t.get("email")}),t.get("phone")&&e.mobileContacts.push({selected:!1,contact:t.get("phone"),contactName:"("+i+") "+t.get("phone")}),t.get("mobile")&&e.mobileContacts.push({selected:a,contact:t.get("mobile"),contactName:"("+i+") "+t.get("mobile")})}),e.contacts.length||e.mobileContacts.length?$(".email-text").addClass("show"):ShowMessage("The customer does not have a email or phone number in their profile. Please select save.","error")}},e.sendReceipt=function(){var t=0,n=0;e.contacts.forEach(function(e){e.selected&&t++}),e.mobileContacts.forEach(function(e){e.selected&&n++}),t>0||n>0?w():$("#emailText-error").show()},e.taxChanged=function(t){if(console.log("tax changed"),-1==t){if(e.newItem.tax.dummy)return e.currentItem=t,e.newItem.tax=null,e.taxName=null,e.taxRate=null,void $(".new-tax").addClass("show")}else{var n=e.estimateItems[t];if(n.selectedTax){if(n.selectedTax.dummy)return e.currentItem=t,e.taxName=null,e.taxRate=null,n.selectedTax=null,void $(".new-tax").addClass("show")}else f()}f()},e.saveNewTax=function(){u.createNewEstimateTax({_scope:e,user:D},function(){f(),e.$$phase||e.$apply()})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("EstimateController",["$q","$scope","$state","$controller","userFactory","estimateService","coreFactory","taxService","expenseService","commentFactory","currencyFilter",function(e,t,n,s,a,i,o,r,c,l,d){function u(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:1,digits:!0,messages:{required:"Please provide item quantity",min:"quantity should be >= 1",digits:"quantity must be integer"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0",number:"Please enter a valid price"}})}),$(".check-discount").each(function(){$(this).rules("remove"),$(this).rules("add",{min:0,max:100,number:!0,messages:{min:"discount should be >= 0",max:"discount should be <= 100"}})})}function m(e){e||(e=n.current.name),I.estimates(e)?(console.log("its in list"),T()):I.newEstimate(e)?console.log("its in new"):I.edit(e)&&(console.log("its in edit"),p())}function p(){var s=n.params.estimateId;if(s){var a=n.params.customerId;showLoader(),e.when(w()).then(function(t){return e.when(i.getEstimate(s))}).then(function(n){return console.log(n),t.estimate=n,t.estimateItems=[],t.deletedItems=[],t.itemsWithOutId=0,t.itemsWithIdinDel=0,t.selectedCustomer=a?t.customers.filter(function(e){return a===e.entity.id})[0]:t.customers.filter(function(e){return n.entity.get("customer").id===e.entity.id})[0],e.when(C())}).then(function(){f()},function(e){hideLoader(),console.log(e.message)})}}function f(){var e=t.estimate;switch(t.estimateNo=e.entity.estimateNumber,t.refNumber=e.entity.referenceNumber||"",t.disableEstNo=1==t.prefs.numAutoGen,t.todayDate=e.entity.estimateDate,t.prefs.discountType){case 0:t.itemLevelTax=!1,t.invoiceLevelTax=!1;break;case 1:t.itemLevelTax=!0,t.invoiceLevelTax=!1;break;case 2:case 3:t.itemLevelTax=!1,t.invoiceLevelTax=!0}t.discount=e.entity.discounts,t.notes=e.entity.notes,t.terms=e.entity.termsConditions,t.showShippingCharges=!1,t.showAdjustments=!1,t.prefs.salesPerson&&(t.salesPerson=e.entity.salesPerson||"",t.showSalesPerson=!0),"Draft"!=e.entity.status&&(t.previouslySent=!0);for(var n=0;n<e.estimateItems.length;++n){var s=e.estimateItems[n].entity,a=s.get("item"),i={};i.selectedItem=t.items.filter(function(e){if(e.entity.id===a.id){i.id=s.id,i.rate=s.amount/s.quantity,i.quantity=s.quantity,i.discount=s.discount||0,i.taxValue=0,i.amount=s.amount;var n=s.get("tax");return i.selectedTax=n?t.taxes.filter(function(e){return e.id===n.id})[0]:void 0,!0}return!1})[0],t.estimateItems.push(i)}var o=e.entity.estimateFiles;o?(o.forEach(function(e){e.fileName=e.name(),e.fileName1=e.fileName.substring(e.fileName.indexOf("_")+1,e.fileName.length),e.exist=!0}),t.files=o):t.files=[];var r=[];t.prefs.customFields&&t.prefs.customFields.forEach(function(e){"YES"==e.isChecked&&r.push({name:e.name,value:""})});var c=e.entity.customFields;c&&c.length&&r.forEach(function(e){for(var t=0;t<c.length;++t)if(c[t][e.name]){e.value=c[t][e.name];break}}),t.customFields=r,x(),hideLoader()}function h(){var e=t.itemsWithIdinDel,n=t.itemsWithOutId;if(!(e<=0||n<=0)){var s=0,a=t.estimateItems;t.deletedItems.forEach(function(e){if(e.id)for(;s<a.length;++s)if(!a[s].id)return a[s].id=e.id,e.id=void 0,--t.itemsWithIdinDel,void--t.itemsWithOutId}),t.deletedItems=t.deletedItems.filter(function(e){return!!e.id})}}function y(e){var n=t.estimate.entity;if(n.set("customer",t.selectedCustomer.entity),n.set("estimateDate",t.todayDate),n.set("estimateNumber",t.estimateNo),n.set("discountType",t.prefs.discountType),n.set("discounts",t.discount),n.set("shippingCharges",t.shippingCharges),n.set("adjustments",t.adjustments),n.set("subTotal",Number(t.subTotal)),n.set("totalAmount",Number(t.total)),n.set("referenceNumber",t.refNumber),n.set("salesPerson",t.salesPerson),n.set("notes",t.notes),n.set("termsConditions",t.terms),t.customFields.length){var s=[];t.customFields.forEach(function(e){if(e.value){var t={};t[e.name]=e.value,s.push(t)}}),s.length?n.set("customFields",s):n.unset("customFields")}var a=t.selectedCustomer.entity.email;return a?n.set("customerEmails",[a]):n.unset("customerEmails"),i.updateEstimate(t.estimate,t.estimateItems,t.deletedItems,D,t.userRole,t.files).then(function(t){return g("Estimate edited",!0),e.generateReceipt?i.createEstimateReceipt(t.id):t})}function g(n,s){var a={userID:D,organization:N,name:D.get("username"),date:new Date,isAutomaticallyGenerated:!1,comment:n};if(D.get("isTrackUsage")||!s){var i={};e.when(o.getUserRole(D)).then(function(e){return l.createNewComment(a,e)}).then(function(e){i.commentObj=e;var n=t.estimate.entity,s=n.get("comments");return s?s.push(e):s=[e],n.set("comments",s),n.save()})}}function v(){return y({generateReceipt:!1}).then(function(e){return i.createEstimateReceipt(e.id).then(function(e){return i.sendEstimateReceipt(e)})})}function b(){u();var e=$("#editEstimateForm").valid(),t=$("#itemInfoForm").valid(),n=$("#extrasForm").valid();if(e&&t&&n)return!0;var s=void 0;e?t?n||(s=$("#extrasForm").validate()):s=$("#itemInfoForm").validate():s=$("#editEstimateForm").validate();var a=$(s.errorList[0].element).offset().top-30;return scrollToOffset(a),!1}function x(){var e=t.estimateItems,n=0,s=0;t.itemTaxes=[],e.forEach(function(e){n+=e.amount*(.01*(100-e.discount));var a=Number(t.discount)||0;if(2==t.prefs.discountType?e.taxValue=calculateTax(e.amount*(.01*(100-a)),e.selectedTax):e.taxValue=calculateTax(e.amount,e.selectedTax),s+=e.taxValue,e.selectedTax){var i=-1;t.itemTaxes.length&&(i=t.itemTaxes.findIndex(function(t){return t.name==e.selectedTax.name})),-1==i?t.itemTaxes.push({nameValue:e.selectedTax.name+" ("+e.selectedTax.rate+"%)",amount:d(e.taxValue,"$",2),count:1,name:e.selectedTax.name,amountValue:e.taxValue}):(t.itemTaxes[i].amountValue+=e.taxValue,t.itemTaxes[i].count++,t.itemTaxes[i].amount=d(t.itemTaxes[i].amountValue,"$",2),t.itemTaxes[i].nameValue=e.selectedTax.name+" ("+e.selectedTax.rate+"%)")}}),t.totalTax=s,t.subTotal=n,t.subTotalStr=d(n,"$",2),t.reCalculateTotal()}function C(){return e.when(c.getCustomerExpenses({organization:N,customer:t.selectedCustomer.entity})).then(function(e){for(var n=[],s=0;s<e.length;++s)if("Yes"==e[s].entity.get("billable"))for(var a=0;a<t.expenseItems.length;++a)e[s].entity.id==t.expenseItems[a].entity.expanseId&&n.push(t.expenseItems[a]);for(var i=[],s=0;s<e.length;++s)if("No"!=e[s].entity.get("billable")){var o=e[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}var r=t.actualItems.concat(n,i);return t.estimateItems=t.estimateItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),t.items=r})}function w(){var n=[],s=null;return s=e.when(o.getAllCustomers()).then(function(e){t.customers=e.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),t.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),"Sales"!=D.get("role")&&t.customers.push(createCustomerOpener)}),n.push(s),s=e.when(o.getAllItems({organization:N})).then(function(e){t.actualItems=e.filter(function(e){return!e.entity.expanseId}),t.expenseItems=e.filter(function(e){return e.entity.expanseId}),t.items=t.actualItems}),n.push(s),s=e.when(i.getPreferences(D)).then(function(e){t.prefs=e}),n.push(s),s=e.when(o.getUserRole(D)).then(function(e){t.userRole=e}),n.push(s),s=r.getTaxes(D,function(e){t.taxes=e}),n.push(s),e.all(n)}function T(){showLoader(),e.when(i.listEstimates(D)).then(function(e){var n=t.dateFormat.toUpperCase().replace(/E/g,"d");e.forEach(function(e){switch(e.entity.status){case"Draft":case"Sent":e.statusClass="text-color-normalize";break;case"Invoiced":case"Accepted":e.statusClass="text-positive";break;case"Declined":e.statusClass="text-danger";break;default:e.statusClass="text-color-normalize"}e.entity.get("estimateFiles")&&(e.attachments=1),e.estimateDate=formatDate(e.entity.estimateDate,n),e.totalAmount=d(e.entity.totalAmount,"$",2)}),t.estimateList=e,t.allestimateList=e,t.displayInvoice=e,t.sortByDate(),hideLoader()},function(e){hideLoader(),console.log(e.message)})}if(a.entity.length){var D=a.entity[0],N=D.get("organizations")[0];s("DashboardController",{$scope:t,$state:n});var I={details:function(e){return e.endsWith("estimates.details")},estimates:function(e){return e.endsWith("estimates.all")},edit:function(e){return e.endsWith("estimates.edit")},newEstimate:function(e){return e.endsWith("estimates.new")}};a.getField("dateFormat").then(function(e){t.dateFormat=e,m()}),$("#editEstimateForm").validate({rules:{customer:"required",estimateNumber:"required",estimateCreateDate:"required"},messages:{customer:"Please select a customer",estimateNumber:"Please enter estimate number",estimateCreateDate:"Please provide estimate Create date"}}),$("#extrasForm").validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$("#itemInfoForm").validate(),t.dateOptions={showWeeks:!1},t.addNewFile=function(e){var n=e.files[0],s=n.name;s.toLowerCase().indexOf("^")>=0&&(s=s.replace("^","")),s.toLowerCase().endsWith(".pdf")||s.toLowerCase().endsWith(".png")||s.toLowerCase().endsWith(".jpg")||s.toLowerCase().endsWith(".jpeg")?($("#file-error").hide(),e.files[0].size>5242880?$("#file-size-error").show():($("#file-size-error").hide(),n.fileName=s,t.files.push(n),t.$$phase||t.$apply())):$("#file-error").show()},t.removeFile=function(e){t.files.splice(e,1)},t.addEstimateItem=function(){var e=t.deletedItems.pop();e?--t.itemsWithIdinDel:(e={id:void 0},++t.itemsWithOutId),e.selectedItem=void 0,e.selectedTax=void 0,e.rate=0,e.quantity=1,e.discount=0,e.taxValue=0,e.amount=0,t.estimateItems.push(e)},t.removeEstimateItem=function(e){if(t.estimateItems.length>1){var n=t.estimateItems.splice(e,1)[0];n.id?(++t.itemsWithIdinDel,t.deletedItems.push(n)):--t.itemsWithOutId,x()}else console.log("there should be atleast 1 item in an estimate")},t.save=function(){b()&&(showLoader(),h(),y({generateReceipt:!0}).then(function(e){hideLoader(),console.log(e),n.go("dashboard.sales.estimates.details",{estimateId:e.id})},function(e){hideLoader(),console.log(e.message)}))},t.saveAndSend=function(){b()&&(showLoader(),h(),v().then(function(e){hideLoader(),console.log(e),n.go("dashboard.sales.estimates.all")},function(e){hideLoader(),console.log(e)}))},t.cancel=function(){n.go("dashboard.sales.estimates.all")},t.openDatePicker=function(e){switch(e){case 1:t.openPicker1=!0}},t.reCalculateTotal=function(){var e=Number(t.subTotal)||0,n=Number(t.discount)||0,s=Number(t.shippingCharges)||0,a=Number(t.adjustments)||0,i=Number(t.totalTax)||0,o=e+i,r=.01*(100-n);2==t.prefs.discountType?o=e*r+i:3==t.prefs.discountType&&(o=(e+i)*r),n=Math.abs(o-e-i),t.total=o+s+a,t.discountStr=d(n,"$",2),t.shippingChargesStr=d(s,"$",2),t.adjustmentsStr=d(a,"$",2),t.totalStr=d(t.total,"$",2)},t.reCalculateSubTotal=x,t.reCalculateItemAmount=function(e){var n=t.estimateItems[e];n.selectedItem&&(n.amount=n.rate*n.quantity,x())},t.itemChanged=function(e){var n=t.estimateItems[e];n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=t.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";t.reCalculateItemAmount(e)},t.customerChanged=function(){t.selectedCustomer.dummy?n.go("dashboard.customers.new",{backLink:n.current.name,estimateId:n.params.estimateId}):(showLoader(),e.when(C()).then(function(){t.estimateItems.length<1?(t.addEstimateItem(),t.totalTax=0,t.subTotal=0,t.subTotalStr=d(0,"$",2),t.reCalculateTotal()):x(),hideLoader()}))},t.sortByEstimateNumber=function(){t.estimateList.sort(function(e,t){return e.entity.estimateNumber.localeCompare(t.entity.estimateNumber)}),"none"===$("#estimate").css("display")?(t.estimateList.sort(function(e,t){return e.entity.estimateNumber.localeCompare(t.entity.estimateNumber)}),$("#estimate").css({display:"inline-table"}),$("#estimateUp").css({display:"none"})):(t.estimateList.sort(function(e,t){return t.entity.estimateNumber.localeCompare(e.entity.estimateNumber)}),$("#estimateUp").css({display:"inline-table"}),$("#estimate").css({display:"none"})),$("#date").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByDate=function(){"none"===$("#date").css("display")?(t.estimateList.sort(function(e,t){return e.entity.estimateDate>t.entity.estimateDate?-1:e.entity.estimateDate<t.entity.estimateDate?1:0}),$("#date").css({display:"inline-table"}),$("#dateUp").css({display:"none"})):(t.estimateList.sort(function(e,t){return t.entity.estimateDate>e.entity.estimateDate?-1:t.entity.estimateDate<e.entity.estimateDate?1:0}),$("#dateUp").css({display:"inline-table"}),$("#date").css({display:"none"})),$("#estimate").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#estimateUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByRefNo=function(){"none"===$("#refno").css("display")?(t.estimateList.sort(function(e,t){return e.entity.referenceNumber.localeCompare(t.entity.referenceNumber)}),$("#refno").css({display:"inline-table"}),$("#refnoUp").css({display:"none"})):(t.estimateList.sort(function(e,t){return t.entity.referenceNumber.localeCompare(e.entity.referenceNumber)}),$("#refnoUp").css({display:"inline-table"}),$("#refno").css({display:"none"})),$("#date").css({display:"none"}),$("#estimate").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#estimateUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByCustomerName=function(){"none"===$("#cusname").css("display")?(t.estimateList.sort(function(e,t){return e.customer.displayName.localeCompare(t.customer.displayName)}),$("#cusname").css({display:"inline-table"}),$("#cusnameUp").css({display:"none"})):(t.estimateList.sort(function(e,t){return t.customer.displayName.localeCompare(e.customer.displayName)}),$("#cusnameUp").css({display:"inline-table"}),$("#cusname").css({display:"none"})),$("#date").css({display:"none"}),$("#estimate").css({display:"none"}),$("#refno").css({display:"none"}),$("#status").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#estimateUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByStatus=function(){"none"===$("#status").css("display")?(t.estimateList.sort(function(e,t){return e.entity.status.localeCompare(t.entity.status)}),$("#status").css({display:"inline-table"}),$("#statusUp").css({display:"none"})):(t.estimateList.sort(function(e,t){return t.entity.status.localeCompare(e.entity.status)}),$("#statusUp").css({display:"inline-table"}),$("#status").css({display:"none"})),$("#date").css({display:"none"}),$("#estimate").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#estimateUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByAmount=function(){"none"===$("#amount").css("display")?(t.estimateList.sort(function(e,t){return e.entity.totalAmount-t.entity.totalAmount}),$("#amount").css({display:"inline-table"}),$("#amountUp").css({display:"none"})):(t.estimateList.sort(function(e,t){return t.entity.totalAmount-e.entity.totalAmount}),$("#amountUp").css({display:"inline-table"}),$("#amount").css({display:"none"})),$("#date").css({display:"none"}),$("#estimate").css({display:"none"}),$("#refno").css({display:"none"}),$("#cusname").css({display:"none"}),$("#status").css({display:"none"}),$("#duedate").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#estimateUp").css({display:"none"}),$("#refnoUp").css({display:"none"}),$("#cusnameUp").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#duedateUp").css({display:"none"})},t.showMenu=function(){$(".filtermenu").hasClass("show")?$(".filtermenu").removeClass("show"):$(".filtermenu").addClass("show")},t.currentEstimates="All Estimates",t.allEstimates=function(){t.estimateList=t.allestimateList.filter(function(e){return!0}),t.displayInvoice=t.estimateList,t.currentEstimates="All Estimates",$(".filtermenu").removeClass("show")},t.draftEstimates=function(){t.estimateList=t.allestimateList.filter(function(e){return"Draft"==e.entity.status}),t.displayInvoice=t.estimateList,t.currentEstimates="Draft Estimate",$(".filtermenu").removeClass("show")},t.sentEstimates=function(){t.estimateList=t.allestimateList.filter(function(e){return"Sent"==e.entity.status}),t.displayInvoice=t.estimateList,t.currentEstimates="Sent Estimates",$(".filtermenu").removeClass("show")},t.invoicedEstimates=function(){t.estimateList=t.allestimateList.filter(function(e){return"Invoiced"==e.entity.status}),t.displayInvoice=t.estimateList,t.currentEstimates="Invoiced Estimates",$(".filtermenu").removeClass("show")},t.search=function(){t.searchText.length?t.estimateList=t.displayInvoice.filter(function(e){return e.estimateDate||(e.estimateDate=""),e.entity.estimateNumber||(e.entity.estimateNumber=""),e.entity.referenceNumber||(e.entity.referenceNumber=""),e.customer.displayName||(e.customer.displayName=""),e.statusClass||(e.statusClass=""),e.entity.status||(e.entity.status=""),e.totalAmount||(e.totalAmount=""),e.estimateDate.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.estimateNumber.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.referenceNumber.toLowerCase().includes(t.searchText.toLowerCase())||e.customer.displayName.toLowerCase().includes(t.searchText.toLowerCase())||e.statusClass.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.status.toLowerCase().includes(t.searchText.toLowerCase())||e.totalAmount.toLowerCase().includes(t.searchText.toLowerCase())}):t.estimateList=t.displayInvoice}}else console.log("User not logged in")}]),invoicesUnlimited.controller("EstimateDetailController",["$q","$scope","$state","$sce","$controller","userFactory","estimateService","coreFactory","commentFactory","currencyFilter",function(e,t,n,s,a,i,o,r,c,l){function d(){scrollToOffset();var a=n.params.estimateId;a&&(showLoader(),e.when(o.getEstimateDetails(a)).then(function(e){var n=e.entity.get("userID");"General Employee"==i.entity[0].get("role")?i.entity[0].id==n.id&&(t.isOwner=!0):t.isOwner=!0,1==e.entity.get("customer").get("isDeleted")&&(t.isOwner=!1),t.estimate=e,t.estimateNo=e.entity.estimateNumber,e.comments&&e.comments.forEach(function(e){e.date=formatDate(e.entity.date,h)}),t.comments=e.comments;var s=e.entity.estimateReceipt;return e.attachments?(e.attachments.forEach(function(e){e.fileName=e.name(),e.fileName1=e.fileName.substring(e.fileName.indexOf("_")+1,e.fileName.length),e.fileUrl=e.url()}),t.attachments=e.attachments):t.attachments=[],s?Promise.resolve(s):o.createEstimateReceipt(a).then(function(e){return e.get("estimateReceipt")})}).then(function(e){return t.templateUrl=s.trustAsResourceUrl(e.url()),$.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:e.url()}}).then(function(e){var t=document.getElementById("estimateFrame");t.src="about:blank",t.contentWindow.document.open(),t.contentWindow.document.write(e),t.contentWindow.document.close(),hideLoader()})},function(e){hideLoader(),console.log(e.message)}))}function u(n,s){var a={userID:p,organization:f,name:p.get("username"),date:new Date,isAutomaticallyGenerated:!1,comment:n};if(p.get("isTrackUsage")||!s){var i={};e.when(r.getUserRole(p)).then(function(e){return c.createNewComment(a,e)}).then(function(e){i.commentObj=e;var n=t.estimate.entity,s=n.get("comments");return s?s.push(e):s=[e],n.set("comments",s),n.save()}).then(function(){var e=new c(i.commentObj);e.date=formatDate(e.entity.date,h),t.comments?t.comments.push(e):t.comments=[e],console.log(e)})}}function m(e){var t=$(e).find("itemRow"),n=($(e).find("modsRow"),$(e).find("attachment")),s=$(e).find("customField"),a=$(e).find("tax");$("<td></td>");$(e).find("billType").text().includes("estimate")&&($(".footer .info").hide(),$(".payment-due").hide()),/^[\s]*$/.test(t.first().find("discount").text())?$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),t.each(function(e){if(/^[\s]*$/.test(t.first().find("discount").text())){var n=$("<tr class='invoice-items'></tr>"),s=$("<td class='ff1 fc0 invoice-item-title' style='width: 50mm;' colspan='2'>"+$(this).children("name").text()+"</td>"),a=$("<td class='ff1 fc0  invoice-item-qty' colspan='2'>"+$(this).children("qty").text()+"</td>"),i=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");n.append(s).append(a).append(i),$("#invoice-items-header").after($(n))}else{var n=$("<tr class='invoice-items'></tr>"),s=$("<td class='ff1 fc0 invoice-item-title' style='width: 50mm;' colspan='2'>"+$(this).children("name").text()+"</td>"),a=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("qty").text()+"</td>"),o=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("discount").text()+"</td>"),i=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");n.append(s).append(a).append(o).append(i),$("#invoice-items-header").after($(n))}}),a.each(function(){var e=$("<tr class='invoice-taxes'></tr>"),t=$("<td colspan='3' class=''></td>"),n=$("<td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).children("name").text()+"</td>"),s=$("<td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).children("value").text()+"</td>");e.append(t).append(n).append(s),$("#invoice-subtotal").after($(e))});var o=$('<tr class="salestax"></tr>');$("tr.adjustments").after(o),s.each(function(){$(".customFields").append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children("name").text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children("value").text()+"</p></div>"))}),n.each(function(){var e=$(this).text();e=(e=e.substring(e.indexOf("_")+1,e.length)).replace(/%20/g," "),$(".attach").append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+"'>"+e+"</a><br><br>")}),$("table tbody tr").each(function(){0==$(this).children().text().length&&$(this).addClass("hideOnMob")});var r=$(e).find("invoiceId").text();$("#pay-link").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+r),$("#pay-link-2").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+r);var c=$(e).find("items");console.log(c),c.each(function(){var e=new Date(Date.parse($(this).find("past-due").text())),t=new Date(Date.now());e=new Date(e.setHours(0,0,0,0)),t=new Date(e.setHours(0,0,0,0)),e.getTime()>=t.getTime()||"Invalid Date"===e.toString()?($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("green-status")):($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("red-status"));o=$(this).find("headerTitle").text();$(".payment-due p:first").append(o);"true"===$(this).find("disablePay").text()&&($(".btn-border-pay").addClass("disable"),$(".info.cl").addClass("disable"),$(".payment-due").removeClass("red-status"),$(".payment-due").addClass("green-status"));var n=$(this).find("discountAmount").text(),s=$('<tr class="discount"></tr>');s.append($('<td class="discountNm" colspan="3"></td>').html("Discount")),s.append($('<td class="discountPr"></td>').html(n)),"after"==$(this).find("discountPlace text").text()?$(".salestax:last").after(s):"before"==$(this).find("discountPlace text").text()&&$(".salestax:first").before(s);a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountNameBottom").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountAmount").text()+"</td></tr>");if("after"==$(this).find("discountPlace text").text()?$(".invoice-taxes:last").after($(a)):"before"==$(this).find("discountPlace text").text()&&$("#invoice-subtotal").after($(a)),$(this).find("adjustments").text().length>0){var a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustments").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustmentsPrice").text()+"</td></tr>");$("#invoice-subtotal").after($(a))}$(this).find("shippingCharges").text().length>0&&(a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingCharges").text()+"</td><td class='ff1 fc1 ' style=' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingChargesPrice").text()+"</td></tr>"),$("#invoice-subtotal").after($(a)));var o=$(this).find("headerTitle").text(),r=$(this).find("past-due").text();o?$("#pdf-title").text(o+"   "+r):($("#pdf-title").text(""),$(".top-bar").css("height","0mm"),$(".top-bar").css("border-bottom","0mm"));k=$(this).find("ordernotes-title").text();(E=$(this).find("ordernotes").text())?($("#pdf-terms-title").text(k),$("#pdf-terms").text(E)):($("#pdf-terms-title").text(""),$("#pdf-terms").text(""),$("#pdf-terms-title").hide(),$("#pdf-terms").hide()),$("#pdf-business-name").text(i.entity[0].get("company")),$("#pdf-invoice-title").text($(this).find("invoice-title").text()),$("#pdf-invoice-number").text($(this).find("refid").text()),$("#pdf-amount-received").text($(this).find("body-price").text()),$("#pdf-date").text($(this).find("body-date").text()),$("#pdf-subtotal").text($(this).find("subtotalprice").text()),$("#pdf-payment-made").text($(this).find("paymentMadePrice").text()),$("#pdf-total").text($(this).find("total-price3").text()),$("#pdf-total-top").text($(this).find("total-price3").text()),$("#pdf-credit-applied").text($(this).find("creditsAppliedPrice").text()),$("#pdf-amount-due").text($(this).find("refundtotal").text()),$("#pdf-payment-name").text($(this).find("title").text()),$("#pdf-currency").text($(this).find("body-currency").text()),$("#pdf-total-text").text($(this).find("refundedText").text()),$("#pdf-payment-text").text($(this).find("paymentMadeText").text()),$("#pdf-credit-text").text($(this).find("creditsAppliedText").text());var c=$(this).find("addres1").text();$("#pdf-address").html(c);var l=$(this).find("longmsg").text();if(0!=l.length){I=$(this).find("longmsg-title").text();$("#pdf-notes-title").html(I),$("#pdf-notes").html(l)}else $("#pdf-notes-title").html(""),$("#pdf-notes").html(""),$("#pdf-notes-title").hide(),$("#pdf-notes").hide();w=$(this).find("mailto").text();$("#user-mail").attr("href",w);T=$(this).find("mailtotxt").text();$("#user-mail").text(T);F=$(this).find("clientmailto").text();$("#client-mail").attr("href",F);S=$(this).find("clientmail").text();$("#client-mail").text(S);P=$(this).find("clientname").text();$("#client-name").text(P);D=$(this).find("nr").text();$("#user-phone").attr("href","tel:"+D),$("#user-phone").text(D);var d=$(this).find("refid").text();$(".visa-card").append(d);var u=$(this).find("purchaseOrderNumber").text();$(".purchase-order").append(u);var m=$(this).find("invoice-title").text();$(".invoice-details-1 h1").append(m);var p=$(this).find("list-header-total").text();$(".list-header li:first-child span").append(p);var f=$(this).find("list-header-date").text();$(".list-header li:nth-child(2) span").append(f);var h=$(this).find("list-header-currency").text();$(".list-header li:nth-child(3) span").append(h);var y=$(this).find("body-price").text();$(".list-body li:first-child span").append(y);g=$(this).find("body-date").text();$(".list-body li:nth-child(2) span").append(g);var g=$(this).find("body-currency").text();$(".list-body li:nth-child(3) span").append(g);var v=$(this).find("th1").text();$(".content.cl th.item").append(v);var b=$(this).find("addres1").text();$(".invoice-details-1 .info-2 p .adr").append(b);var x=$(this).find("website-link").text();$(".invoice-details-1 .info-2 .website a").attr("href",x);var C=$(this).find("website-name").text();$(".invoice-details-1 .info-2 .website a span").append(C);var w=$(this).find("mailto").text();$(".invoice-details-1 .info-2 .mailto a").attr("href",w);var T=$(this).find("mailtotxt").text();$(".invoice-details-1 .info-2 .mailto a span").append(T);var D=$(this).find("nr").text();$(".invoice-details-1 .info-2 .nr a").attr("href",D),$(".invoice-details-1 .info-2 .nr a span").append(D);var N=$(this).find("thanksmsg").text();if($(".invoice-details-2 .info-1 p:nth-child(1)").append(N),0!=(l=$(this).find("longmsg").text()).length){var I=$(this).find("longmsg-title").text();$(".notes_para_head").html(I),$(".notes_para").html(l)}var L=$(this).find("to").text();$(".invoice-details-2 .info-2 p:first-child").append(L);var P=$(this).find("clientname").text();$(".invoice-details-2 .info-2 .list-client li:first-child span").append(P);var U=$(this).find("clientnr").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(2) a").attr("href",U),$(".invoice-details-2 .info-2 .list-client li:nth-child(2) a span").append(U);var F=$(this).find("clientmailto").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(3) a").attr("href",F);var S=$(this).find("clientmail").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(3) a span").append(S);var k=$(this).find("ordernotes-title").text(),E=$(this).find("ordernotes").text();$(".orderNotes").append(k),$(".orderNotesValues").append(E);var j=$(this).find("subtotal").text();$("td.subtotal").append(j);var R=$(this).find("adjustments").text();$("td.adjustments").append(R);var A=$(this).find("adjustmentsPrice").text();$("td.adjustments-price").append(A);var M=$(this).find("shippingCharges").text();$("td.shippingCharges").append(M);var B=$(this).find("shippingChargesPrice").text();$("td.shipping-charges-price").append(B);$(this).find("total-price").text();var O=$(this).find("salestax").text();$(".salestax").append(O);var q=$(this).find("paymentMadeText").text(),z=$(this).find("paymentMadePrice").text();$("td.payment-made-text").append(q),$("td.payment-made-price").append(z);var H=$(this).find("paymentRefundMadeText").text(),G=$(this).find("paymentRefundMadePrice").text();""==H?($("td.payment-refund-made-text").hide(),$("td.payment-refund-made-price").hide()):($("td.payment-refund-made-text").append(H),$("td.payment-refund-made-price").append(G));var W=$(this).find("creditsAppliedText").text(),V=$(this).find("creditsAppliedPrice").text();$("td.credits-applied-text").append(W),$("td.credits-applied-price").append(V);var K=$(this).find("total-price2").text();$(".total-price2").append(K);var _=$(this).find("total-price3").text();$(".total-price3").append(_);var Y=$(this).find("totaltext").text();$(".totl").append(Y);var X=$(this).find("refundtotal").text();$("td.refund-total").append(X);var Z=$(this).find("refundedText").text();$(".refund-price").append(Z);var J=$(this).find("total-price4").text();$(".total-price4").append(J);var Q=$(this).find("saletax").text();$(".saletax").append(Q);var ee=$(this).find("paymentmsg").text();$(".footer .info p:first-child").append(ee);var te=$(this).find("signup").text();$(".footer .info p span").append(te);var ne=$(this).find("copyright").text();$(".copyright p").append(ne);var se=$(this).find("title").text();$("head title").append(se);var ae=$(this).find("item4price").text();$(".price .item4price").append(ae);var ie=$(this).find("subtotalprice").text();$(".subtotal-price").append(ie);var oe=$(this).find("received-text").text();$(".received-text").append(oe);var re=$(this).find("received-price").text();$(".received-price").append(re);var ce=$(this).find("due-text").text();$(".due-text").append(ce);var le=$(this).find("due-price");$(".due-price").append(le);var de=$(this).find("tip-text");$(".tip-text").append(de);var ue=$(this).find("tip-price");$(".tip-price").append(ue)}),$.ajax({method:"POST",type:"POST",url:"generatePDF.php",data:{html:$(".pdf-page").html()}}).then(function(e){var t=document.getElementById("pdfLink"),n="data:application/octet-stream;base64,"+e;t.href=n,t.click()},function(e){console.error(e)})}if(i.entity.length){var p=i.entity[0],f=p.get("organizations")[0];a("DashboardController",{$scope:t,$state:n});var h=void 0;i.getField("dateFormat").then(function(e){t.dateFormat=e,h=t.dateFormat.toUpperCase().replace(/E/g,"d"),d()}),t.isOwner=!1,t.dateOptions={showWeeks:!1},t.changeTemplate=function(){showLoader(),e.when(r.getInvoiceTemplates()).then(function(e){var n=p.get("defaultTemplate"),s=[];e.forEach(function(e){var t={entity:e,name:e.get("name"),url:e.get("templatePreview").url()};n||"Template 1"!=t.name?t.isDefault=n.id==e.id:t.isDefault=!0,s.push(t)}),t.templates=s,$(".change-template").addClass("show"),hideLoader()},function(e){console.log(e.message),hideLoader()})},t.setDefaultTemplate=function(s){showLoader(),t.templates.forEach(function(e){e.isDefault=!1}),t.templates[s].isDefault=!0,t.estimate.entity.unset("estimateReceipt"),p.set("defaultTemplate",t.templates[s].entity);var a=[];a.push(p.save()),a.push(t.estimate.entity.save()),e.all(a).then(function(){hideLoader(),$(".change-template").removeClass("show"),console.log("default template selected"),n.reload()},function(e){hideLoader(),console.log(e,message)})},t.textReceipt=function(){$("#text-error").hide();var e=t.estimate.entity.get("customer").get("contactPersons");t.mobileContacts=[],e.length&&e.forEach(function(e){var n=e.get("firstname")?e.get("firstname"):"",s=e.get("lastname")?e.get("lastname"):"",a=1==e.get("defaultPerson"),i=n+" "+s;e.get("phone")&&t.mobileContacts.push({selected:!1,contact:e.get("phone"),contactName:"("+i+") "+e.get("phone")}),e.get("mobile")&&t.mobileContacts.push({selected:a,contact:e.get("mobile"),contactName:"("+i+") "+e.get("mobile")})}),t.mobileContacts.length?$(".text-popup").addClass("show"):ShowMessage("Please Enter Mobile for Customer!","error")},t.sendText=function(){var e=0;t.mobileContacts.forEach(function(t){t.selected&&e++}),e<1?$("#text-error").show():(showLoader(),t.mobileContacts.forEach(function(e){e.selected&&o.sendEstimetTextToNumber(t.estimate.entity,e.contact).then(function(t){u("Estimate texted to "+e.contact,!0),$(".text-popup").removeClass("show"),hideLoader()})}))},t.emailReceipt=function(){$("#email-error").hide();var e=t.estimate.entity.get("customer").get("contactPersons");t.contacts=[],e.length&&e.forEach(function(e){var n=e.get("firstname")?e.get("firstname"):"",s=e.get("lastname")?e.get("lastname"):"",a=1==e.get("defaultPerson"),i=n+" "+s;e.get("email")&&t.contacts.push({selected:a,contact:e.get("email"),contactName:"("+i+") "+e.get("email")})}),t.contacts.length?$(".email-popup").addClass("show"):ShowMessage("Please Enter Email for Customer!","error")},t.sendEmail=function(){var e=0;t.contacts.forEach(function(t){t.selected&&e++}),e<1?$("#email-error").show():(showLoader(),t.contacts.forEach(function(e){e.selected&&o.sendEstimateReceiptToEmail(t.estimate.entity,e.contact).then(function(t){u("Estimate emailed to "+e.contact,!0),$(".email-popup").removeClass("show"),hideLoader()})}))},t.deleteEstimate=function(){showLoader();var e=t.estimate.entity,s=[],a=void 0;["comments","estimateItems"].forEach(function(t){(a=e.get(t))&&(s=s.concat(a))}),Parse.Object.destroyAll(s).then(function(){return e.destroy()}).then(function(){hideLoader(),n.go("dashboard.sales.estimates.all")})},t.addAttachment=function(s){var a=s.files[0];if(a){var i=a.name;if(i.toLowerCase().endsWith(".pdf")||i.toLowerCase().endsWith(".png")||i.toLowerCase().endsWith(".jpg")||i.toLowerCase().endsWith(".jpeg"))if($("#file-error").hide(),i.toLowerCase().indexOf("^")>=0&&(i=i.replace("^","")),s.files[0].size>5242880)$("#file-size-error").show();else{$("#file-size-error").hide(),showLoader();var o=t.estimate.entity,r=new Parse.File(i,a);e.when(r.save()).then(function(e){var t=o.get("estimateFiles");return t?t.push(e):t=[e],o.set("estimateFiles",t),o.unset("estimateReceipt"),o.save()}).then(function(e){n.reload(),hideLoader()})}else $("#file-error").show()}},t.estimatePrinted=function(){u("Estimate printed",!0)},t.estimateCloned=function(){u("Estimate cloned",!0)},t.copyToClipboard=function(){var e=document.createElement("input");e.setAttribute("value",t.templateUrl),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),showSnackbar("Estimate link copied to your clipboard.")},t.addComment=function(){if(t.newComment){showLoader();var n={userID:p,organization:f,name:p.get("username"),date:new Date,isAutomaticallyGenerated:!1,comment:t.newComment},s={};e.when(r.getUserRole(p)).then(function(e){return c.createNewComment(n,e)}).then(function(e){s.commentObj=e;var n=t.estimate.entity,a=n.get("comments");return a?a.push(e):a=[e],n.set("comments",a),n.save()}).then(function(){var e=new c(s.commentObj);e.date=formatDate(e.entity.date,h),t.comments?t.comments.push(e):t.comments=[e],console.log(e),$(".add-comment").removeClass("show"),hideLoader()})}else $(".add-comment").removeClass("show")},t.downloadInvoice=function(){var e=t.estimate.entity.get("estimateLabels")._url,n=new XMLHttpRequest;n.open("GET",e,!1),n.setRequestHeader("Content-Type","text/xml"),n.send(null),m(n.responseXML)}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CloneInvoiceController",["$scope","$state","$controller","$q","userFactory","invoiceService","coreFactory","commentFactory","taxService","expenseService","lateFeeService","currencyFilter","itemService","salesCommon",function(e,t,n,s,a,i,o,r,c,l,d,u,m,p){function f(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:.01,number:!0,messages:{required:"Please provide item quantity",min:"Quantity should be > 0",number:"Quantity must be number"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0",number:"Please enter a valid price"}})}),$(".check-discount").each(function(){$(this).rules("remove"),$(this).rules("add",{min:0,max:100,number:!0,messages:{min:"Discount should be greater than 0",max:"Discount should be less than 100%"}})})}function h(e){var t=e.entity;return t.name+" "+t.price+" ("+t.type+")"}function y(){return e.invoiceItems=[],e.selectedCustomer=e.customers.filter(function(t){return e.invoice.entity.get("customer").id===t.entity.id})[0],s.when(p.customerChangedHelper({organization:S,_scope:e})).then(function(){return p.fillInvoiceForm(e)}).then(function(){e.invoiceNo=e.prefs.invoiceNumber,p.addValidationExceptItems(e),p.reCalculateSubTotal(e),hideLoader()})}function g(){e.prefs.shipCharges&&(e.shippingCharges||(e.shippingCharges=0)),e.prefs.adjustments&&(e.adjustments||(e.adjustments=0));var n={userID:F,organization:S,customer:e.selectedCustomer.entity,invoiceDate:e.todayDate,invoiceNumber:e.invoiceNo,status:"Draft",discountType:e.prefs.discountType,discounts:e.discount,shippingCharges:e.shippingCharges,adjustments:e.adjustments,subTotal:Number(Number(e.subTotal).toFixed(2)),total:Number(Number(e.total).toFixed(2)),balanceDue:Number(Number(e.total).toFixed(2)),poNumber:e.poNumber,salesPerson:e.salesPerson,notes:e.notes,terms:e.terms,paymentTerms:e.paymentTerms.selectedTerm.name};if(e.customFields.length){var s=[];e.customFields.forEach(function(e){if(e.value){var t={};t[e.name]=e.value,s.push(t)}}),s.length&&(n.customFields=s)}e.selectedLateFee&&(n.lateFee=e.selectedLateFee.entity),e.paymentTerms.selectedTerm.value>0&&(n.dueDate=e.dueDate);var a=e.selectedCustomer.entity.email;if(a&&(n.customerEmails=[a]),e.projectId&&(e.projectId.project.timesheets.forEach(function(e){e.set("isBilled",1);var t=e.get("task");t.set("billedHours",t.get("taskHours")),e.set("task",t)}),Parse.Object.saveAll(e.projectId.project.timesheets)),t.params.expenseId){var o=new Parse.Query("Expanses");o.equalTo("objectId",t.params.expenseId),o.first().then(function(e){e.set("status","Invoiced"),e.save()})}return i.createNewInvoice(n,e.invoiceItems,e.userRole,e.files).then(function(t){return i.copyInInvoiceInfo(t).then(function(n){return e.invoiceInfo=n,t})})}function v(){return g().then(function(t){return i.createInvoiceReceipt(t.id,e.invoiceInfo.id).then(function(e){return"Draft"==e.get("status")&&(e.set("status","Sent"),e.save()),b(e),e})})}function b(t){e.contacts.forEach(function(e){e.selected&&i.sendInvoiceReceiptToEmail(t,e.contact).then(function(n){T("Invoice emailed to "+e.contact,!0,t)})}),e.mobileContacts.forEach(function(e){e.selected&&i.sendInvoiceTextToNumber(t,e.contact).then(function(n){T("Invoice texted to "+e.contact,!0,t)})})}function x(){$("#addInvoiceForm").validate().showErrors({invoiceNumber:"Invoice with this number already exists"})}function C(){f();var e=$("#addInvoiceForm").valid(),t=$("#itemInfoForm").valid(),n=$("#extrasForm").valid();if(e&&t&&n)return!0;var s=void 0;e?t?n||(s=$("#extrasForm").validate()):s=$("#itemInfoForm").validate():s=$("#addInvoiceForm").validate();var a=$(s.errorList[0].element).offset().top-30;return scrollToOffset(a),!1}function w(){e.latefeeName="",e.latefeeTypes=["%","$"],e.selectedFeeType=e.latefeeTypes[0],e.latefeeAmount="",$("#addLateFeeForm").validate({rules:{name:"required",type:"required",amount:{required:!0,number:!0,min:.01}}}),$("#addLateFeeForm").validate().resetForm()}function T(e,t,n){var a={userID:F,organization:S,name:F.get("username"),date:new Date,isAutomaticallyGenerated:t,comment:e};if(F.get("isTrackUsage")||!t){var i={};return s.when(o.getUserRole(F)).then(function(e){return r.createNewComment(a,e)}).then(function(e){i.commentObj=e;var t=n.get("comments");return t?t.push(e):t=[e],n.set("comments",t),n.save()}).then(function(e){return e})}}function D(){C()&&(showLoader(),s.when(i.checkInvoiceNumAvailable({invoiceNumber:e.invoiceNo,organization:S})).then(function(e){return e?v():($(".email-text").removeClass("show"),x(),scrollToOffset(),Promise.reject("Invoice with this number already exists"))}).then(function(e){T("Invoice created for "+u(e.attributes.balanceDue,"$",2)+" amount",!0,e).then(function(e){hideLoader(),t.go("dashboard.sales.invoices.details",{invoiceId:e.id})})},function(e){hideLoader(),console.log(e)}))}function N(e){return e<10&&(e="0"+e),e}function I(e){return"."+e.split(".").pop()}function L(){var t=e.invoiceItems,n=0,s=0;e.itemTaxes=[],t.forEach(function(t){n+=t.amount*(.01*(100-t.discount));var a=Number(e.discount)||0;if(2==e.prefs.discountType?t.taxValue=calculateTax(t.amount*(.01*(100-a)),t.selectedTax):t.taxValue=calculateTax(t.amount*(.01*(100-t.discount)),t.selectedTax),s+=t.taxValue,t.selectedTax){var i=-1;2==t.selectedTax.type?t.selectedTax.entity.get("associatedTaxes").forEach(function(n){i=-1,e.itemTaxes.length&&(i=e.itemTaxes.findIndex(function(e){return e.name==n.get("title")}));var s=0;n.get("compound")?(s=t.amount*(t.selectedTax.rate-n.get("value"))*.01,s=(t.amount+s)*n.get("value")*.01):s=t.amount*n.get("value")*.01,-1==i?e.itemTaxes.push({nameValue:n.get("title")+" ("+n.get("value")+"%)",amount:u(s,"$",2),count:1,name:n.get("title"),amountValue:s}):(e.itemTaxes[i].amountValue+=s,e.itemTaxes[i].count++,e.itemTaxes[i].amount=u(e.itemTaxes[i].amountValue,"$",2))}):(e.itemTaxes.length&&(i=e.itemTaxes.findIndex(function(e){return e.name==t.selectedTax.name})),-1==i?e.itemTaxes.push({nameValue:t.selectedTax.name+" ("+t.selectedTax.rate+"%)",amount:u(t.taxValue,"$",2),count:1,name:t.selectedTax.name,amountValue:t.taxValue}):(e.itemTaxes[i].amountValue+=t.taxValue,e.itemTaxes[i].count++,e.itemTaxes[i].amount=u(e.itemTaxes[i].amountValue,"$",2)))}}),e.totalTax=s,e.subTotal=n,e.subTotalStr=u(n*k.exchangeRate,k.currencySymbol,2),e.reCalculateTotal()}function P(){e.items.pop();var t=e.selectedCustomer.entity.get("paymentTerms");return t?e.paymentTerms.terms.forEach(function(n){n.name==t&&(e.paymentTerms.selectedTerm=n)}):e.paymentTerms.selectedTerm={name:"Due on Receipt",value:1},e.hasDueDate=!0,e.calculateDueDate(),s.when(l.getCustomerExpenses({organization:S,customer:e.selectedCustomer.entity})).then(function(t){for(var n=[],s=0;s<t.length;++s)if("Yes"==t[s].entity.get("billable"))for(var a=0;a<e.expenseItems.length;++a)t[s].entity.id==e.expenseItems[a].entity.expanseId&&n.push(e.expenseItems[a]);for(var i=[],s=0;s<t.length;++s)if("No"!=t[s].entity.get("billable")){var o=t[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}var r=e.actualItems.concat(n,i);return e.invoiceItems=e.invoiceItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),"Sales"!=F.get("role")&&r.push(createItemOpener),e.items=r})}function U(e){if(-1!==(e=e.split(",").join("")).indexOf(".")){for(;/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");3==e.length-e.indexOf(".")&&$(".add_item_price").attr("maxlength",e.length)}else for($(".add_item_price").attr("maxlength",50);/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}if(a.entity.length){var F=a.entity[0],S=F.get("organizations")[0];n("DashboardController",{$scope:e,$state:t});var k=a.entity[0].currency.attributes;if(k.exchangeRate)e.currentCurrency=k;else{var E={currencySymbol:"$",exchangeRate:1};e.currentCurrency=E,k=E}$.validator.addMethod("notBackDate",function(t,n){return e.todayDate<=e.dueDate}),$("#addTaxForm").validate({rules:{name:"required",rate:{required:!0,number:!0}},messages:{name:"Please enter Tax name",rate:{required:"tax rate is required",number:"please enter a valid rate(number)"}}}),$("#addInvoiceForm").validate({onkeyup:function(e){$(e).valid()},rules:{customer:"required",invoiceNumber:"required",invoiceCreateDate:"required",invoiceDueDate:{required:!0}},messages:{customer:"Please select a customer",invoiceNumber:"Please enter invoice number",invoiceCreateDate:"Please provide invoice Create date",invoiceDueDate:{required:"Please provide invoice Due date"}}}),$("#extrasForm").validate({rules:{discount:{number:!0,min:0,max:100},shipCharges:{number:!0,min:0},adjustment:{number:!0}},messages:{discount:{number:"Must be a number",min:"Discount can not be less than 0",max:"Discount should be less than 100%"}}}),$("#itemInfoForm").validate();var j=t.params.invoiceId;j||t.go("dashboard.sales.invoices.all"),e.dateOptions={showWeeks:!1};var R=[],A=null;A=s.when(i.getInvoice(j)).then(function(t){e.invoice=t}),R.push(A),A=s.when(p.loadRequiredData({user:F,organization:S,_scope:e})),R.push(A),s.all(R).then(function(){y()}),e.save=function(){C()&&(showLoader(),s.when(i.checkInvoiceNumAvailable({invoiceNumber:e.invoiceNo,organization:S})).then(function(e){return e?g():(x(),scrollToOffset(),Promise.reject("Invoice with this number already exists"))}).then(function(e){T("Invoice created for "+u(e.attributes.balanceDue,"$",2)+" amount",!0,e).then(function(e){hideLoader(),t.go("dashboard.sales.invoices.details",{invoiceId:e.id})})},function(e){hideLoader(),console.log(e)}))},e.lateFeeChanged=function(){e.selectedLateFee&&e.selectedLateFee.dummy&&(e.selectedLateFee="",w(),$(".add-latefee").addClass("show"))},e.addLateFee=function(){if($("#addLateFeeForm").valid()){showLoader();var t={userID:F,organization:S,name:e.latefeeName,type:e.selectedFeeType,price:Number(e.latefeeAmount)};s.when(o.getUserRole(F)).then(function(e){return d.createLateFee(t,e)}).then(function(t){t.toStr=h(t),e.lateFeeList.pop(),e.lateFeeList.push(t),"Sales"!=F.get("role")&&e.lateFeeList.push(createLateFeeOpener),e.selectedLateFee=t,$(".add-latefee").removeClass("show"),hideLoader()})}},e.saveAndSend=function(){if(C()){$("#emailText-error").hide();var t=e.selectedCustomer.entity.get("contactPersons");e.contacts=[],e.mobileContacts=[],t.length&&t.forEach(function(t){var n=t.get("firstname")?t.get("firstname"):"",s=t.get("lastname")?t.get("lastname"):"",a=1==t.get("defaultPerson"),i=n+" "+s;t.get("email")&&e.contacts.push({selected:a,contact:t.get("email"),contactName:"("+i+") "+t.get("email")}),t.get("phone")&&e.mobileContacts.push({selected:!1,contact:t.get("phone"),contactName:"("+i+") "+t.get("phone")}),t.get("mobile")&&e.mobileContacts.push({selected:a,contact:t.get("mobile"),contactName:"("+i+") "+t.get("mobile")})}),e.contacts.length||e.mobileContacts.length?$(".email-text").addClass("show"):ShowMessage("The customer does not have a email or phone number in their profile. Please select save.","error")}},e.sendReceipt=function(){var t=0,n=0;e.contacts.forEach(function(e){e.selected&&t++}),e.mobileContacts.forEach(function(e){e.selected&&n++}),t>0||n>0?D():$("#emailText-error").show()},e.cancel=function(){t.go("dashboard.sales.invoices.all")},e.addNewFile=function(t){var n=t.files[0],s=n.name;if(s.toLowerCase().indexOf("^")>=0&&(s=s.replace("^","")),s.toLowerCase().endsWith(".pdf")||s.toLowerCase().endsWith(".png")||s.toLowerCase().endsWith(".jpg")||s.toLowerCase().endsWith(".jpeg"))if($("#file-error").hide(),t.files[0].size>5242880)$("#file-size-error").show();else{$("#file-size-error").hide(),n.fileName=s,e.files.push(n);for(var a=0;a<e.files.length;++a)e.files[a].fileName="Attachment "+N(a+1)+I(e.files[a].fileName);e.$$phase||e.$apply()}else $("#file-error").show()},e.removeFile=function(t){e.files.splice(t,1);for(var n=0;n<e.files.length;++n)e.files[n].fileName="Attachment "+N(n+1)+I(e.files[n].fileName)},e.calculateDueDate=function(){var t=new Date(e.todayDate);t.setHours(0),1!=e.paymentTerms.selectedTerm.value&&(t=t.addDays(e.paymentTerms.selectedTerm.value)),e.dueDate=t},e.paymentTermsChanged=function(){0==e.paymentTerms.selectedTerm.value?e.hasDueDate=!1:e.hasDueDate=!0,e.hasDueDate&&e.calculateDueDate()},e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0;break;case 2:e.openPicker2=!0}},e.addInvoiceItem=function(){e.invoiceItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},e.reCalculateTotal=function(){var t=Number(e.subTotal)||0,n=Number(e.discount)||0,s=Number(e.shippingCharges)||0,a=Number(e.adjustments)||0,i=Number(e.totalTax)||0,o=t+i,r=.01*(100-n);2==e.prefs.discountType?o=t*r+i:3==e.prefs.discountType&&(o=(t+i)*r),n=Math.abs(o-t-i),e.total=o+s+a,e.discountStr=u(n*k.exchangeRate,k.currencySymbol,2),e.shippingChargesStr=u(s*k.exchangeRate,k.currencySymbol,2),e.adjustmentsStr=u(a*k.exchangeRate,k.currencySymbol,2),e.totalStr=u(e.total*k.exchangeRate,k.currencySymbol,2)},e.reCalculateSubTotal=L,e.reCalculateItemAmount=function(t){var n=e.invoiceItems[t];n.selectedItem&&(n.amount=n.rate*n.quantity,L())},e.removeInvoiceItem=function(t){e.invoiceItems.length>1?(e.invoiceItems.splice(t,1),L()):console.log("there should be atleast 1 item in an invoice")},e.itemChanged=function(t){console.log("item changed");var n=e.invoiceItems[t];if(n.selectedItem.dummy)return n.selectedItem=null,$(".new-item").addClass("show"),e.itemChangedIndex=t,void e.prepareCreateItem();n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=e.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";e.reCalculateItemAmount(t)},e.taxChanged=function(t){if(console.log("tax changed"),-1==t){if(e.newItem.tax.dummy)return e.currentItem=t,e.newItem.tax=null,e.taxName=null,e.taxRate=null,void $(".new-tax").addClass("show")}else{var n=e.invoiceItems[t];if(n.selectedTax){if(n.selectedTax.dummy)return e.currentItem=t,e.taxName=null,e.taxRate=null,n.selectedTax=null,void $(".new-tax").addClass("show")}else L()}L()},e.customerChanged=function(){e.selectedCustomer.dummy?t.go("dashboard.customers.new",{backLink:t.current.name}):(showLoader(),s.when(P()).then(function(){e.invoiceItems.length<1?(e.addInvoiceItem(),e.totalTax=0,e.subTotal=0,e.subTotalStr=u(0*k.exchangeRate,k.currencySymbol,2),e.reCalculateTotal()):L(),hideLoader()}))},e.prepareCreateItem=function(){p.prepareCreateItem({_scope:e})},e.createNewItem=function(){p.createNewItem({_scope:e,user:F,organization:S})},e.saveNewTax=function(){$("#addTaxForm").valid()&&p.createNewTax({_scope:e,user:F},function(){L(),e.$$phase||e.$apply()})},$(".add_item_price").keyup(function(){$(this).val(U($(this).val()))})}else console.log("User not logged in")}]),invoicesUnlimited.controller("CreateInvoiceController",["$scope","$state","$controller","$q","userFactory","invoiceService","coreFactory","commentFactory","taxService","expenseService","lateFeeService","currencyFilter","itemService","salesCommon","estimateService","$rootScope",function(e,t,n,s,a,i,o,r,c,l,d,u,m,p,f,h){function y(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:.01,number:!0,messages:{required:"Please provide item quantity",min:"Quantity should be > 0",number:"Quantity must be number"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0",number:"Please enter a valid price"}})}),$(".check-discount").each(function(){$(this).rules("remove"),$(this).rules("add",{min:0,max:100,number:!0,messages:{min:"Discount should be greater than 0",max:"Discount should be less than 100%"}})})}function g(e){var t=e.entity;return t.name+" "+t.price+" ("+t.type+")"}function v(){showLoader();var t=[],n=null;n=s.when(o.getAllCustomers()).then(function(t){t=t.filter(function(e){return"active"==e.entity.status}),e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),e.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),"Sales"!=B.get("role")&&e.customers.push(createCustomerOpener)}),t.push(n),n=s.when(o.getAllItems({organization:O})).then(function(t){e.actualItems=t.filter(function(e){return!e.entity.expanseId&&e.entity.title.indexOf("Misc. Item")<0}),e.expenseItems=t.filter(function(e){return e.entity.expanseId}),e.items=e.actualItems,"Sales"!=B.get("role")&&e.items.push(createItemOpener)}),t.push(n),n=s.when(i.getPreferences(B)).then(function(t){e.prefs=t}),t.push(n),n=s.when(o.getUserRole(B)).then(function(t){e.userRole=t}),t.push(n),n=c.getTaxes(B,function(t){e.taxes=t,"Sales"!=B.get("role")&&e.taxes.push(createTaxOpener)}),t.push(n),n=d.getAllLateFees({organization:O}).then(function(t){e.lateFeeList=t.map(function(e){return e.toStr=g(e),e}),"Sales"!=B.get("role")&&e.lateFeeList.push(createLateFeeOpener)}),t.push(n),n=a.getField("dateFormat").then(function(t){e.dateFormat=t}),t.push(n),s.all(t).then(function(){b()},function(e){hideLoader(),console.log(e.message)})}function b(){switch(1==e.prefs.numAutoGen?(e.invoiceNo=e.prefs.invoiceNumber,e.disableInvNo=!0):(e.invoiceNo="",e.disableInvNo=!1),e.notes=e.prefs.notes,e.terms=e.prefs.terms,e.paymentTerms={terms:[{name:"Off",value:0},{name:"Due on Receipt",value:1},{name:"Net 7",value:7},{name:"Net 10",value:10},{name:"Net 30",value:30},{name:"Net 60",value:60},{name:"Net 90",value:90}],selectedTerm:{name:"Due on Receipt",value:1}},e.files=[],e.hasDueDate=!0,e.todayDate=new Date,e.calculateDueDate(),e.subTotalStr=u(0*A.exchangeRate,A.currencySymbol,2),e.prefs.discountType){case 0:e.itemLevelTax=!1,e.invoiceLevelTax=!1;break;case 1:e.itemLevelTax=!0,e.invoiceLevelTax=!1;break;case 2:e.itemLevelTax=!1,e.invoiceLevelTax=!0,e.discountStr=u(0*A.exchangeRate,A.currencySymbol,2);break;case 3:$("#discountD").insertAfter("#taxD"),e.itemLevelTax=!1,e.invoiceLevelTax=!0,e.discountStr=u(0*A.exchangeRate,A.currencySymbol,2)}e.prefs.shipCharges&&(e.showShippingCharges=!0,e.shippingChargesStr=u(0*A.exchangeRate,A.currencySymbol,2)),e.prefs.adjustments&&(e.showAdjustments=!0,e.adjustmentsStr=u(0*A.exchangeRate,A.currencySymbol,2)),e.prefs.salesPerson&&(e.showSalesPerson=!0),e.invoiceItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var n=t.params.customerId,a=t.params.expenseId,i=t.params.projectId,o=t.params.estimateId;n&&(e.selectedCustomer=e.customers.filter(function(e){return e.entity.id==n})[0],j(),a&&s.when(E()).then(function(){e.invoiceItems.length||e.addInvoiceItem(),e.invoiceItems[0].selectedItem=e.items.filter(function(e){return e.entity.expanseId==a})[0],e.invoiceItems[0].selectedItem.create=!0,e.itemChanged(0);var n=new Parse.Query("Expanses");n.equalTo("objectId",t.params.expenseId),n.first().then(function(t){e.notes=t.get("notes"),e.dueDate=t.get("expanseDate"),e.todayDate=t.get("expanseDate"),e.poNumber=t.get("referenceNumber"),e.$$phase||e.$apply()})})),i&&C(i),o&&x(o);var r=[];e.prefs.customFields&&e.prefs.customFields.forEach(function(e){"YES"==e.isChecked&&r.push({name:e.name,value:""})}),e.customFields=r,hideLoader()}function x(t){s.when(f.getEstimate(t)).then(function(t){e.estimate=t,e.selectedCustomer=e.customers.filter(function(t){return e.estimate.entity.get("customer").id===t.entity.id})[0],j(),s.when(E()).then(function(){e.poNumber=t.entity.referenceNumber||"",e.files=[];var n=t.entity.estimateFiles;switch(n?(n.forEach(function(e){e.fileName=e.name(),e.exist=!0}),e.files=n):e.files=[],e.prefs.discountType){case 0:e.itemLevelTax=!1,e.invoiceLevelTax=!1;break;case 1:e.itemLevelTax=!0,e.invoiceLevelTax=!1;break;case 2:case 3:e.itemLevelTax=!1,e.invoiceLevelTax=!0}e.notes=t.entity.notes,e.terms=t.entity.termsConditions,e.prefs.salesPerson&&(e.salesPerson=t.entity.salesPerson||"",e.showSalesPerson=!0),e.invoiceItems=[];for(var s=0;s<t.estimateItems.length;++s){var a=t.estimateItems[s].entity,i=a.get("item"),o={};o.selectedItem=e.items.filter(function(t){if(t.entity.id===i.id){o.id=a.id,o.rate=a.amount/a.quantity,o.quantity=a.quantity,o.discount=a.discount||0,o.taxValue=0,o.amount=a.amount;var n=a.get("tax");return o.selectedTax=n?e.taxes.filter(function(e){return e.id===n.id})[0]:void 0,!0}return!1})[0],e.invoiceItems.push(o)}e.reCalculateSubTotal(),hideLoader()})})}function C(t){e.selectedCustomer=e.customers.filter(function(e){return e.entity.id==t.project.entity.customer.id})[0],j(),e.invoiceItems=[{selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}],s.when(E()).then(function(){if(1==t.dataOnInvoice){var n=0,s=0;if("Based on project hours"==t.project.entity.get("billingMethod")){n=t.project.entity.get("projectBillingHours");for(var a=t.project.timesheets,i=0;i<a.length;++i)if(!a[i].get("isBilled")){var o=a[i].time,r=parseInt(o.split(":")[0]);r+=(m=parseInt(o.split(":")[1]))/60,s+=r=parseFloat(r.toFixed(2))}}else if("Fixed cost for project"==t.project.entity.get("billingMethod"))n=t.project.entity.projectBillingAmount,s=1;else if("Based on task hours"==t.project.entity.get("billingMethod")){n=0;a=t.project.timesheets;s=1;for(i=0;i<a.length;++i)if(!a[i].get("isBilled")){var o=a[i].time,r=parseInt(o.split(":")[0]);r+=(m=parseInt(o.split(":")[1]))/60,r=parseFloat(r.toFixed(2));var c=a[i].get("task").get("taskCost");c||(c=0),n+=r*c}}else if("Based on staff hours"==t.project.entity.get("billingMethod")){n=0;a=t.project.timesheets;s=1;for(i=0;i<a.length;++i)if(!a[i].get("isBilled")){var o=a[i].time,r=parseInt(o.split(":")[0]);r+=(m=parseInt(o.split(":")[1]))/60,r=parseFloat(r.toFixed(2));h=t.project.users.findIndex(function(e){return e.user.id==a[i].get("user").id});(y=t.project.users[h].entity.staffHours)||(y=0),n+=r*y}}d={create:!0,entity:{rate:n,title:t.project.entity.projectName}};e.items.pop(),e.items.push(d),"Sales"!=B.get("role")&&e.items.push(createItemOpener),e.invoiceItems[0]={selectedItem:d,selectedTax:void 0,rate:n,quantity:s,discount:0,amount:0},e.itemChanged(0)}else if(2==t.dataOnInvoice){if(t.project.timesheets){e.items.pop();u=0;"Based on project hours"==t.project.entity.get("billingMethod")&&(u=t.project.entity.get("projectBillingHours"));for(var a=t.project.timesheets,l=[],i=0;i<a.length;++i)if(!a[i].get("isBilled")){var o=a[i].time,r=parseInt(o.split(":")[0]);r+=(m=parseInt(o.split(":")[1]))/60,r=parseFloat(r.toFixed(2));p=a[i].get("task");(f=l.findIndex(function(e){return e.id==p.id}))>=0?l[f].quantity+=r:"Based on project hours"==t.project.entity.get("billingMethod")?l.push({taskName:p.get("taskName"),quantity:r,taskRate:u,id:p.id}):"Based on task hours"==t.project.entity.get("billingMethod")&&l.push({taskName:p.get("taskName"),quantity:r,taskRate:p.get("taskCost"),id:p.id})}g=0;l.forEach(function(n){var s=void 0;1==t.itemNameToShow&&(s=t.project.entity.projectName);var a={create:!0,entity:{rate:n.taskRate,title:s}};e.items.push(a),e.addInvoiceItem(),e.invoiceItems[g]={selectedItem:a,selectedTax:void 0,rate:n.taskRate,quantity:n.quantity,discount:0,amount:0},e.itemChanged(g),g++}),"Sales"!=B.get("role")&&e.items.push(createItemOpener)}}else if(3==t.dataOnInvoice){if(t.project.timesheets){e.items.pop();u=0;"Based on project hours"==t.project.entity.get("billingMethod")&&(u=t.project.entity.get("projectBillingHours"));for(var a=t.project.timesheets,i=0;i<a.length;++i)if(!a[i].get("isBilled")){var o=a[i].time,r=parseInt(o.split(":")[0]);r+=(m=parseInt(o.split(":")[1]))/60,r=parseFloat(r.toFixed(2));n=0;if("Based on task hours"==t.project.entity.get("billingMethod"))(n=a[i].get("task").get("taskCost"))||(n=0);else if("Based on staff hours"==t.project.entity.get("billingMethod")){h=t.project.users.findIndex(function(e){return e.user.id==a[i].get("user").id});(n=t.project.users[h].entity.staffHours)||(n=0)}else n=u;var d={create:!0,entity:{rate:n,title:t.project.entity.projectName}};e.items.push(d),e.addInvoiceItem(),e.invoiceItems[i]={selectedItem:d,selectedTax:void 0,rate:n,quantity:r,discount:0,amount:0},e.itemChanged(i)}"Sales"!=B.get("role")&&e.items.push(createItemOpener)}}else if(4==t.dataOnInvoice&&t.project.timesheets){e.items.pop();var u=0;"Based on project hours"==t.project.entity.get("billingMethod")&&(u=t.project.entity.get("projectBillingHours"));for(var a=t.project.timesheets,l=[],i=0;i<a.length;++i)if(!a[i].get("isBilled")){var o=a[i].time,r=parseInt(o.split(":")[0]),m=parseInt(o.split(":")[1]);r+=m/60,r=parseFloat(r.toFixed(2));var p=a[i].get("user"),f=l.findIndex(function(e){return e.id==p.id});if(f>=0)l[f].quantity+=r;else if("Based on project hours"==t.project.entity.get("billingMethod"))l.push({taskName:p.get("userName"),quantity:r,taskRate:u,id:p.id});else if("Based on staff hours"==t.project.entity.get("billingMethod")){var h=t.project.users.findIndex(function(e){return e.user.id==p.id}),y=t.project.users[h].entity.staffHours;y||(y=0),l.push({taskName:p.get("userName"),quantity:r,taskRate:y,id:p.id})}}var g=0;l.forEach(function(n){var s=void 0;1==t.itemNameToShow&&(s=t.project.entity.projectName);var a={create:!0,entity:{rate:n.taskRate,title:s}};e.items.push(a),e.addInvoiceItem(),e.invoiceItems[g]={selectedItem:a,selectedTax:void 0,rate:n.taskRate,quantity:n.quantity,discount:0,amount:0},e.itemChanged(g),g++}),"Sales"!=B.get("role")&&e.items.push(createItemOpener)}})}function w(){e.prefs.shipCharges&&(e.shippingCharges||(e.shippingCharges=0)),e.prefs.adjustments&&(e.adjustments||(e.adjustments=0));var n={userID:B,organization:O,customer:e.selectedCustomer.entity,invoiceDate:e.todayDate,invoiceNumber:e.invoiceNo,status:"Draft",discountType:e.prefs.discountType,discounts:e.discount,shippingCharges:e.shippingCharges,adjustments:e.adjustments,subTotal:Number(Number(e.subTotal).toFixed(2)),total:Number(Number(e.total).toFixed(2)),balanceDue:Number(Number(e.total).toFixed(2)),poNumber:e.poNumber,salesPerson:e.salesPerson,notes:e.notes,terms:e.terms,paymentTerms:e.paymentTerms.selectedTerm.name};if(e.customFields.length){var s=[];e.customFields.forEach(function(e){if(e.value){var t={};t[e.name]=e.value,s.push(t)}}),s.length&&(n.customFields=s)}e.selectedLateFee&&(n.lateFee=e.selectedLateFee.entity),e.paymentTerms.selectedTerm.value>0&&(n.dueDate=e.dueDate);var a=e.selectedCustomer.entity.email;if(a&&(n.customerEmails=[a]),e.projectId&&(e.projectId.project.timesheets.forEach(function(e){e.set("isBilled",1);var t=e.get("task");t.set("billedHours",t.get("taskHours")),e.set("task",t)}),Parse.Object.saveAll(e.projectId.project.timesheets)),t.params.expenseId){var o=new Parse.Query("Expanses");o.equalTo("objectId",t.params.expenseId),o.first().then(function(e){e.set("status","Invoiced"),e.save()})}return e.estimate&&(e.estimate.entity.set("status","Invoiced"),e.estimate.entity.save().then(function(e){})),i.createNewInvoice(n,e.invoiceItems,e.userRole,e.files).then(function(t){return i.copyInInvoiceInfo(t).then(function(n){return e.invoiceInfo=n,t})})}function T(){return w().then(function(t){return i.createInvoiceReceipt(t.id,e.invoiceInfo.id).then(function(e){return"Draft"==e.get("status")&&(e.set("status","Sent"),e.save()),D(e),e})})}function D(t){e.sendEmail(e.contacts,t),e.sendText(e.mobileContacts,t)}function N(){$("#addInvoiceForm").validate().showErrors({invoiceNumber:"Invoice with this number already exists"})}function I(){y();var e=$("#addInvoiceForm").valid(),t=$("#itemInfoForm").valid(),n=$("#extrasForm").valid();if(e&&t&&n)return!0;var s=void 0;e?t?n||(s=$("#extrasForm").validate()):s=$("#itemInfoForm").validate():s=$("#addInvoiceForm").validate();var a=$(s.errorList[0].element).offset().top-30;return scrollToOffset(a),!1}function L(){e.latefeeName="",e.latefeeTypes=["%","$"],e.selectedFeeType=e.latefeeTypes[0],e.latefeeAmount="",$("#addLateFeeForm").validate({rules:{name:"required",type:"required",amount:{required:!0,number:!0,min:.01}}}),$("#addLateFeeForm").validate().resetForm()}function P(e,t,n){var a={userID:B,organization:O,name:B.get("username"),date:new Date,isAutomaticallyGenerated:t,comment:e};if(B.get("isTrackUsage")||!t){var i={};return s.when(o.getUserRole(B)).then(function(e){return r.createNewComment(a,e)}).then(function(e){i.commentObj=e;var t=n.get("comments");return t?t.push(e):t=[e],n.set("comments",t),n.save()}).then(function(e){return e})}}function U(){I()&&(showLoader(),s.when(i.checkInvoiceNumAvailable({invoiceNumber:e.invoiceNo,organization:O})).then(function(e){return e?T():($(".email-text").removeClass("show"),N(),scrollToOffset(),Promise.reject("Invoice with this number already exists"))}).then(function(e){P("Invoice created for "+u(e.attributes.balanceDue,"$",2)+" amount",!0,e).then(function(e){hideLoader(),t.go("dashboard.sales.invoices.details",{invoiceId:e.id})})},function(e){hideLoader(),console.log(e)}))}function F(e){return e<10&&(e="0"+e),e}function S(e){return"."+e.split(".").pop()}function k(){var t=e.invoiceItems,n=0,s=0;e.itemTaxes=[],t.forEach(function(t){n+=t.amount*(.01*(100-t.discount));var a=Number(e.discount)||0;if(2==e.prefs.discountType?t.taxValue=calculateTax(t.amount*(.01*(100-a)),t.selectedTax):t.taxValue=calculateTax(t.amount*(.01*(100-t.discount)),t.selectedTax),s+=t.taxValue,t.selectedTax){var i=-1;2==t.selectedTax.type?t.selectedTax.entity.get("associatedTaxes").forEach(function(n){i=-1,e.itemTaxes.length&&(i=e.itemTaxes.findIndex(function(e){return e.name==n.get("title")}));var s=0;n.get("compound")?(s=t.amount*(t.selectedTax.rate-n.get("value"))*.01,s=(t.amount+s)*n.get("value")*.01):s=t.amount*n.get("value")*.01,-1==i?e.itemTaxes.push({nameValue:n.get("title")+" ("+n.get("value")+"%)",amount:u(s,"$",2),count:1,name:n.get("title"),amountValue:s}):(e.itemTaxes[i].amountValue+=s,e.itemTaxes[i].count++,e.itemTaxes[i].amount=u(e.itemTaxes[i].amountValue,"$",2))}):(e.itemTaxes.length&&(i=e.itemTaxes.findIndex(function(e){return e.name==t.selectedTax.name})),-1==i?e.itemTaxes.push({nameValue:t.selectedTax.name+" ("+t.selectedTax.rate+"%)",amount:u(t.taxValue,"$",2),count:1,name:t.selectedTax.name,amountValue:t.taxValue}):(e.itemTaxes[i].amountValue+=t.taxValue,e.itemTaxes[i].count++,e.itemTaxes[i].amount=u(e.itemTaxes[i].amountValue,"$",2)))}}),e.totalTax=s,e.subTotal=n,e.subTotalStr=u(n*A.exchangeRate,A.currencySymbol,2),e.reCalculateTotal()}function E(){e.items[e.items.length-1].dummy&&e.items.pop();var t=e.selectedCustomer.entity.get("paymentTerms");return t?e.paymentTerms.terms.forEach(function(n){n.name==t&&(e.paymentTerms.selectedTerm=n)}):e.paymentTerms.selectedTerm={name:"Due on Receipt",value:1},e.hasDueDate=!0,e.calculateDueDate(),s.when(l.getCustomerExpenses({organization:O,customer:e.selectedCustomer.entity})).then(function(t){for(var n=[],s=0;s<t.length;++s)if("Yes"==t[s].entity.get("billable"))for(var a=0;a<e.expenseItems.length;++a)t[s].entity.id==e.expenseItems[a].entity.expanseId&&n.push(e.expenseItems[a]);for(var i=[],s=0;s<t.length;++s)if("No"!=t[s].entity.get("billable")){var o=t[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}var r=e.actualItems.concat(n,i);return e.invoiceItems=e.invoiceItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),"Sales"!=B.get("role")&&r.push(createItemOpener),e.items=r})}function j(){e.selectedCustomer.dummy?t.go("dashboard.customers.new",{backLink:t.current.name}):(showLoader(),s.when(E()).then(function(){e.invoiceItems.length<1?(e.addInvoiceItem(),e.totalTax=0,e.subTotal=0,e.subTotalStr=u(0*A.exchangeRate,A.currencySymbol,2),e.reCalculateTotal()):k(),hideLoader()}))}function R(e){if(-1!==(e=e.split(",").join("")).indexOf(".")){for(;/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");3==e.length-e.indexOf(".")&&$(".add_item_price").attr("maxlength",e.length)}else for($(".add_item_price").attr("maxlength",50);/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}if(a.entity.length){var A=a.entity[0].currency.attributes;if(A.exchangeRate)e.currentCurrency=A;else{var M={currencySymbol:"$",exchangeRate:1};e.currentCurrency=M,A=M}var B=a.entity[0],O=B.get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),s.when(a.entity[0].currency.fetch()).then(function(t){if((A=t.attributes).exchangeRate)e.currentCurrency=A;else{var n={currencySymbol:"$",exchangeRate:1};e.currentCurrency=n,A=n}v()}),$.validator.addMethod("notBackDate",function(t,n){return e.todayDate<=e.dueDate}),$("#addTaxForm").validate({rules:{name:"required",rate:{required:!0,number:!0}},messages:{name:"Please enter Tax name",rate:{required:"tax rate is required",number:"please enter a valid rate(number)"}}}),$("#addInvoiceForm").validate({onkeyup:function(e){$(e).valid()},rules:{customer:"required",invoiceNumber:"required",invoiceCreateDate:"required",invoiceDueDate:{required:!0}},messages:{customer:"Please select a customer",invoiceNumber:"Please enter invoice number",invoiceCreateDate:"Please provide invoice Create date",invoiceDueDate:{required:"Please provide invoice Due date"}}}),$("#extrasForm").validate({rules:{discount:{number:!0,min:0,max:100},shipCharges:{number:!0,min:0},adjustment:{number:!0}},messages:{discount:{number:"Must be a number",min:"Discount can not be less than 0",max:"Discount should be less than 100%"}}}),$("#itemInfoForm").validate(),e.projectId=t.params.projectId,e.dateOptions={showWeeks:!1},e.save=function(){I()&&(showLoader(),s.when(i.checkInvoiceNumAvailable({invoiceNumber:e.invoiceNo,organization:O})).then(function(e){return e?w():(N(),scrollToOffset(),Promise.reject("Invoice with this number already exists"))}).then(function(e){P("Invoice created for "+u(e.attributes.balanceDue,"$",2)+" amount",!0,e).then(function(e){hideLoader(),t.go("dashboard.sales.invoices.details",{invoiceId:e.id})})},function(e){hideLoader(),console.log(e)}))},e.lateFeeChanged=function(){e.selectedLateFee&&e.selectedLateFee.dummy&&(e.selectedLateFee="",L(),$(".add-latefee").addClass("show"))},e.addLateFee=function(){if($("#addLateFeeForm").valid()){showLoader();var t={userID:B,organization:O,name:e.latefeeName,type:e.selectedFeeType,price:Number(e.latefeeAmount)};s.when(o.getUserRole(B)).then(function(e){return d.createLateFee(t,e)}).then(function(t){t.toStr=g(t),e.lateFeeList.pop(),e.lateFeeList.push(t),"Sales"!=B.get("role")&&e.lateFeeList.push(createLateFeeOpener),e.selectedLateFee=t,$(".add-latefee").removeClass("show"),hideLoader()})}},e.saveAndSend=function(){if(I()){$("#emailText-error").hide();var t=e.selectedCustomer.entity.get("contactPersons");e.contacts=[],e.mobileContacts=[],t.length&&t.forEach(function(t){var n=t.get("firstname")?t.get("firstname"):"",s=t.get("lastname")?t.get("lastname"):"",a=1==t.get("defaultPerson"),i=n+" "+s;t.get("email")&&e.contacts.push({selected:a,contact:t.get("email"),contactName:"("+i+") "+t.get("email")}),t.get("phone")&&e.mobileContacts.push({selected:!1,contact:t.get("phone"),contactName:"("+i+") "+t.get("phone")}),t.get("mobile")&&e.mobileContacts.push({selected:a,contact:t.get("mobile"),contactName:"("+i+") "+t.get("mobile")})}),e.contacts.length||e.mobileContacts.length?$(".email-text").addClass("show"):ShowMessage("The customer does not have a email or phone number in their profile. Please select save.","error")}},e.sendReceipt=function(){var t=0,n=0;e.contacts.forEach(function(e){e.selected&&t++}),e.mobileContacts.forEach(function(e){e.selected&&n++}),t>0||n>0?U():$("#emailText-error").show()},e.cancel=function(){t.go("dashboard.sales.invoices.all")},e.addNewFile=function(t){var n=t.files[0],s=n.name;if(s.toLowerCase().indexOf("^")>=0&&(s=s.replace("^","")),s.toLowerCase().endsWith(".pdf")||s.toLowerCase().endsWith(".png")||s.toLowerCase().endsWith(".jpg")||s.toLowerCase().endsWith(".jpeg"))if($("#file-error").hide(),t.files[0].size>5242880)$("#file-size-error").show();else{$("#file-size-error").hide(),n.fileName=s,e.files.push(n);for(var a=0;a<e.files.length;++a)e.files[a].fileName="Attachment "+F(a+1)+S(e.files[a].fileName);e.$$phase||e.$apply()}else $("#file-error").show()},e.removeFile=function(t){e.files.splice(t,1);for(var n=0;n<e.files.length;++n)e.files[n].fileName="Attachment "+F(n+1)+S(e.files[n].fileName)},e.calculateDueDate=function(){var t=new Date(e.todayDate);t.setHours(0),1!=e.paymentTerms.selectedTerm.value&&(t=t.addDays(e.paymentTerms.selectedTerm.value)),e.dueDate=t},e.paymentTermsChanged=function(){0==e.paymentTerms.selectedTerm.value?e.hasDueDate=!1:e.hasDueDate=!0,e.hasDueDate&&e.calculateDueDate()},e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0;break;case 2:e.openPicker2=!0}},e.addInvoiceItem=function(){e.invoiceItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},e.reCalculateTotal=function(){var t=Number(e.subTotal)||0,n=Number(e.discount)||0,s=Number(e.shippingCharges)||0,a=Number(e.adjustments)||0,i=Number(e.totalTax)||0,o=t+i,r=.01*(100-n);2==e.prefs.discountType?o=t*r+i:3==e.prefs.discountType&&(o=(t+i)*r),n=Math.abs(o-t-i),e.total=o+s+a,e.discountStr=u(n*A.exchangeRate,A.currencySymbol,2),e.shippingChargesStr=u(s*A.exchangeRate,A.currencySymbol,2),e.adjustmentsStr=u(a*A.exchangeRate,A.currencySymbol,2),e.totalStr=u(e.total*A.exchangeRate,A.currencySymbol,2)},e.reCalculateSubTotal=k,e.reCalculateItemAmount=function(t){var n=e.invoiceItems[t];n.selectedItem&&(n.amount=n.rate*n.quantity,k())},e.removeInvoiceItem=function(t){e.invoiceItems.length>1?(e.invoiceItems.splice(t,1),k()):console.log("there should be atleast 1 item in an invoice")},e.itemChanged=function(t){console.log("item changed");var n=e.invoiceItems[t];if(n.selectedItem.dummy)return n.selectedItem=null,$(".new-item").addClass("show"),e.itemChangedIndex=t,void e.prepareCreateItem();n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=e.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";e.reCalculateItemAmount(t)},e.taxChanged=function(t){if(console.log("tax changed"),-1==t){if(e.newItem.tax.dummy)return e.currentItem=t,e.newItem.tax=null,e.taxName=null,e.taxRate=null,void $(".new-tax").addClass("show")}else{var n=e.invoiceItems[t];if(n.selectedTax){if(n.selectedTax.dummy)return e.currentItem=t,e.taxName=null,e.taxRate=null,n.selectedTax=null,void $(".new-tax").addClass("show")}else k()}k()},e.customerChanged=j,e.printSelected=function(){},e.prepareCreateItem=function(){p.prepareCreateItem({_scope:e})},e.createNewItem=function(){p.createNewItem({_scope:e,user:B,organization:O})},e.saveNewTax=function(){$("#addTaxForm").valid()&&p.createNewTax({_scope:e,user:B},function(){k(),e.$$phase||e.$apply()})},$(".add_item_price").keyup(function(){$(this).val(R($(this).val()))})}else console.log("User not logged in")}]),invoicesUnlimited.controller("EstimateToInvoiceController",["$scope","$state","$controller","$q","userFactory","invoiceService","salesCommon","estimateService",function(e,t,n,s,a,i,o,r){function c(){return e.invoiceItems=[],e.selectedCustomer=e.customers.filter(function(t){return e.estimate.entity.get("customer").id===t.entity.id})[0],s.when(o.customerChangedHelper({organization:d,_scope:e})).then(function(){var t=e.estimate;e.invoiceNo=e.prefs.invoiceNumber,e.poNumber=t.entity.referenceNumber||"",e.disableInvNo=1==e.prefs.numAutoGen,e.paymentTerms={terms:[{name:"Off",value:0},{name:"Due on Receipt",value:1},{name:"Net 7",value:7},{name:"Net 10",value:10},{name:"Net 30",value:30},{name:"Net 60",value:60},{name:"Net 90",value:90}],selectedTerm:{name:"Due on Receipt",value:1}},e.hasDueDate=!0,e.todayDate=new Date,o.calculateDueDate(e),e.files=[];var n=t.entity.estimateFiles;switch(n?(n.forEach(function(e){e.fileName=e.name(),e.exist=!0}),e.files=n):e.files=[],e.prefs.discountType){case 0:e.itemLevelTax=!1,e.invoiceLevelTax=!1;break;case 1:e.itemLevelTax=!0,e.invoiceLevelTax=!1;break;case 2:case 3:e.itemLevelTax=!1,e.invoiceLevelTax=!0}e.notes=t.entity.notes,e.terms=t.entity.termsConditions,e.prefs.shipCharges&&(e.shippingCharges=t.entity.shippingCharges,e.showShippingCharges=!0),e.prefs.adjustments&&(e.adjustments=t.entity.adjustments,e.showAdjustments=!0),e.prefs.salesPerson&&(e.salesPerson=t.entity.salesPerson||"",e.showSalesPerson=!0),e.invoiceItems=[];for(var s=0;s<t.estimateItems.length;++s){var a=t.estimateItems[s].entity,i=a.get("item"),r={};r.selectedItem=e.items.filter(function(t){if(t.entity.id===i.id){r.id=a.id,r.rate=a.amount/a.quantity,r.quantity=a.quantity,r.discount=a.discount||0,r.taxValue=0,r.amount=a.amount;var n=a.get("tax");return r.selectedTax=n?e.taxes.filter(function(e){return e.id===n.id})[0]:void 0,!0}return!1})[0],e.invoiceItems.push(r)}var c=[];e.prefs.customFields&&e.prefs.customFields.forEach(function(e){"YES"==e.isChecked&&c.push({name:e.name,value:""})}),e.customFields=c,o.addValidationExceptItems(e),o.reCalculateSubTotal(e),hideLoader()})}if(a.entity.length){var l=a.entity[0],d=l.get("organizations")[0];n("DashboardController",{$scope:e,$state:t});var u=t.params.estimateId;if(u){var m=[],p=null;p=s.when(r.getEstimate(u)).then(function(t){e.estimate=t}),m.push(p),p=s.when(o.loadRequiredData({user:l,organization:d,_scope:e})),m.push(p),s.all(m).then(function(){c()}),e.save=function(){o.save({_scope:e,user:l,organization:d})},e.saveAndSend=function(){o.saveAndSend({_scope:e,user:l,organization:d})},e.cancel=function(){t.go("dashboard.sales.invoices.all")},e.addNewFile=function(t){var n=t.files[0];n.fileName=n.name,e.files.push(n),e.$$phase||e.$apply()},e.removeFile=function(t){e.files.splice(t,1)},e.calculateDueDate=function(){o.calculateDueDate(e)},e.paymentTermsChanged=function(){o.paymentTermsChanged(e)},e.openDatePicker=function(t){switch(t){case 1:e.openPicker1=!0;break;case 2:e.openPicker2=!0}},e.addInvoiceItem=function(){o.addInvoiceItem(e)},e.reCalculateTotal=function(){o.reCalculateTotal(e)},e.reCalculateItemAmount=function(t){o.reCalculateItemAmount({index:t,_scope:e})},e.removeInvoiceItem=function(t){o.removeInvoiceItem({index:t,_scope:e})},e.itemChanged=function(t){o.itemChanged({index:t,_scope:e})},e.customerChanged=function(){o.customerChanged({organization:d,_scope:e})},e.prepareCreateItem=function(){o.prepareCreateItem({_scope:e})},e.createNewItem=function(){o.createNewItem({_scope:e,user:l,organization:d})}}}else console.log("User not logged in")}]),invoicesUnlimited.controller("InvoiceController",["$q","$scope","$state","$controller","userFactory","invoiceService","coreFactory","taxService","expenseService","lateFeeService","commentFactory","currencyFilter","salesCommon",function(e,t,n,s,a,i,o,r,c,l,d,u,m){function p(){$(".check-item").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please select an item"}})}),$(".check-qty").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:1,number:!0,messages:{required:"Please provide item quantity",min:"Quantity should be greater than 1",number:"Quantity must be number"}})}),$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:0,number:!0,messages:{required:"Please provide item rate",min:"rate should be >= 0",number:"Please enter a valid price"}})}),$(".check-discount").each(function(){$(this).rules("remove"),$(this).rules("add",{min:0,max:100,number:!0,messages:{min:"Discount should be greater than 0",max:"Discount should be less than 100%"}})})}function f(e){e||(e=n.current.name),j.invoices(e)?P():j.newInvoice(e)||j.edit(e)&&h()}function h(){var s=n.params.invoiceId;if(s){var a=n.params.customerId;showLoader(),e.when(L()).then(function(t){return e.when(i.getInvoice(s))}).then(function(n){return t.invoice=n,t.invoiceItems=[],t.deletedItems=[],t.itemsWithOutId=0,t.itemsWithIdinDel=0,t.selectedCustomer=a?t.customers.filter(function(e){return a===e.entity.id})[0]:t.customers.filter(function(e){return n.entity.get("customer").id===e.entity.id})[0],e.when(N())}).then(function(){y()},function(e){hideLoader(),console.log(e.message)})}}function y(){var e=t.invoice;t.invoiceNo=e.entity.invoiceNumber,t.poNumber=e.entity.poNumber||"",t.disableInvNo=1==t.prefs.numAutoGen,t.todayDate=e.entity.invoiceDate,t.dueDate=e.entity.dueDate,t.paymentTerms={terms:[{name:"Off",value:0},{name:"Due on Receipt",value:1},{name:"Net 7",value:7},{name:"Net 10",value:10},{name:"Net 30",value:30},{name:"Net 60",value:60},{name:"Net 90",value:90}]},t.hasDueDate=!!e.entity.dueDate,t.hasDueDate?e.entity.paymentTerms?t.paymentTerms.selectedTerm=t.paymentTerms.terms.filter(function(t){return t.name==e.entity.paymentTerms})[0]:t.paymentTerms.selectedTerm=t.paymentTerms.terms[1]:t.paymentTerms.selectedTerm=t.paymentTerms.terms[0];var n=e.entity.lateFee;if(n)for(var s=t.lateFeeList,a=0;a<s.length;++a)if(s[a].entity.id==n.id){t.selectedLateFee=s[a];break}var i=e.entity.invoiceFiles;switch(i?(i.forEach(function(e){e.fileName=e.name(),e.fileName1=e.fileName.substring(e.fileName.indexOf("_")+1,e.fileName.length),e.exist=!0}),t.files=i):t.files=[],t.lastFileNumber=t.files.length,t.prefs.discountType){case 0:t.itemLevelTax=!1,t.invoiceLevelTax=!1;break;case 1:t.itemLevelTax=!0,t.invoiceLevelTax=!1;break;case 2:case 3:t.itemLevelTax=!1,t.invoiceLevelTax=!0}t.discount=e.entity.discounts,t.notes=e.entity.notes,t.terms=e.entity.terms,(t.prefs.shipCharges||e.entity.shippingCharges)&&(t.shippingCharges=e.entity.shippingCharges,t.showShippingCharges=!0),(t.prefs.adjustments||e.entity.adjustments)&&(t.adjustments=e.entity.adjustments,t.showAdjustments=!0),t.prefs.salesPerson&&(t.salesPerson=e.entity.salesPerson||"",t.showSalesPerson=!0),"Sent"==e.entity.status&&(t.previouslySent=!0);for(var o=[],a=0;a<e.invoiceItems.length;++a){var r=e.invoiceItems[a].entity,c=r.get("item"),l={};l.selectedItem=t.items.filter(function(e){if(e.entity.id===c.id){l.id=r.id,l.rate=r.amount/r.quantity,l.quantity=r.quantity,l.discount=r.discount||0,l.taxValue=0,l.amount=r.amount;var n=r.get("tax");return l.selectedTax=n?t.taxes.filter(function(e){return e.id===n.id})[0]:void 0,e.entity.title.indexOf("Misc. Item")>=0&&o.push(e.entity.id),!0}return!1})[0],t.invoiceItems.push(l)}t.items=t.items.filter(function(e){return!(e.entity.title.indexOf("Misc. Item")>=0)||o.indexOf(e.entity.id)>=0});var d=[];t.prefs.customFields&&t.prefs.customFields.forEach(function(e){"YES"==e.isChecked&&d.push({name:e.name,value:""})});var u=e.entity.customFields;u&&u.length&&d.forEach(function(e){for(var t=0;t<u.length;++t)if(u[t][e.name]){e.value=u[t][e.name];break}}),t.customFields=d,D(),hideLoader()}function g(){console.log("came");var e=t.itemsWithIdinDel,n=t.itemsWithOutId;if(!(e<=0||n<=0)){var s=0,a=t.invoiceItems;t.deletedItems.forEach(function(e){if(e.id)for(;s<a.length;++s)if(!a[s].id)return a[s].id=e.id,e.id=void 0,--t.itemsWithIdinDel,void--t.itemsWithOutId}),t.deletedItems=t.deletedItems.filter(function(e){return!!e.id})}}function v(e){var n=t.invoice.entity;if(n.set("customer",t.selectedCustomer.entity),n.set("invoiceDate",t.todayDate),n.set("invoiceNumber",t.invoiceNo),n.set("discountType",t.prefs.discountType),n.set("discounts",t.discount),n.set("shippingCharges",t.shippingCharges),n.set("adjustments",t.adjustments),n.set("subTotal",Number(Number(t.subTotal).toFixed(2))),n.set("balanceDue",Number(Number(t.total).toFixed(2))-n.get("total")+n.get("balanceDue")),n.set("total",Number(Number(t.total).toFixed(2))),n.set("poNumber",t.poNumber),n.set("salesPerson",t.salesPerson),n.set("notes",t.notes),n.set("terms",t.terms),t.customFields.length){var s=[];t.customFields.forEach(function(e){if(e.value){var t={};t[e.name]=e.value,s.push(t)}}),s.length?n.set("customFields",s):n.unset("customFields")}if(t.selectedLateFee?n.set("lateFee",t.selectedLateFee.entity):n.unset("lateFee"),n.set("paymentTerms",t.paymentTerms.selectedTerm.name),t.paymentTerms.selectedTerm.value>0){n.set("dueDate",t.dueDate);var a=new Date;a.setHours(23),"Overdue"==n.get("status")&&t.dueDate>a&&n.set("status","Draft")}else n.unset("dueDate"),"Overdue"==n.get("status")&&n.set("status","Draft");var o=t.selectedCustomer.entity.email;return o?n.set("customerEmails",[o]):n.unset("customerEmails"),i.updateInvoice(t.invoice,t.invoiceItems,t.deletedItems,k,t.userRole,t.files).then(function(t){return i.copyInInvoiceInfo(t).then(function(n){if(b("Invoice edited",!0),e.generateReceipt){var s=t.get("invoiceInfo");return s&&(s=s.id),i.createInvoiceReceipt(t.id,s)}return t})})}function b(n,s){var a={userID:k,organization:E,name:k.get("username"),date:new Date,isAutomaticallyGenerated:s,comment:n};if(k.get("isTrackUsage")||!s){var i={};e.when(o.getUserRole(k)).then(function(e){return d.createNewComment(a,e)}).then(function(e){i.commentObj=e;var n=t.invoice.entity,s=n.get("comments");return s?s.push(e):s=[e],n.set("comments",s),n.save()})}}function x(){return v({generateReceipt:!1}).then(function(e){return i.copyInInvoiceInfo(e).then(function(t){return i.createInvoiceReceipt(e.id,t.id)}).then(function(e){return i.sendInvoiceReceipt(e)})})}function C(){p();var e=$("#editInvoiceForm").valid(),t=$("#itemInfoForm").valid(),n=$("#extrasForm").valid();if(e&&t&&n)return!0;var s=void 0;e?t?n||(s=$("#extrasForm").validate()):s=$("#itemInfoForm").validate():s=$("#editInvoiceForm").validate();var a=$(s.errorList[0].element).offset().top-30;return scrollToOffset(a),!1}function w(e){return e<10&&(e="0"+e),e}function T(e){return"."+e.split(".").pop()}function D(){var e=t.invoiceItems,n=0,s=0;t.itemTaxes=[],e.forEach(function(e){n+=e.amount*(.01*(100-e.discount));var a=Number(t.discount)||0;if(2==t.prefs.discountType?e.taxValue=calculateTax(e.amount*(.01*(100-a)),e.selectedTax):e.taxValue=calculateTax(e.amount*(.01*(100-e.discount)),e.selectedTax),s+=e.taxValue,e.selectedTax){var i=-1;2==e.selectedTax.type?e.selectedTax.entity.get("associatedTaxes").forEach(function(n){i=-1,t.itemTaxes.length&&(i=t.itemTaxes.findIndex(function(e){return e.name==n.get("title")}));var s=0;n.get("compound")?(s=e.amount*(e.selectedTax.rate-n.get("value"))*.01,s=(e.amount+s)*n.get("value")*.01):s=e.amount*n.get("value")*.01,-1==i?t.itemTaxes.push({nameValue:n.get("title")+" ("+n.get("value")+"%)",amount:u(s,"$",2),count:1,name:n.get("title"),amountValue:s}):(t.itemTaxes[i].amountValue+=s,t.itemTaxes[i].count++,t.itemTaxes[i].amount=u(t.itemTaxes[i].amountValue,"$",2))}):(t.itemTaxes.length&&(i=t.itemTaxes.findIndex(function(t){return t.name==e.selectedTax.name})),-1==i?t.itemTaxes.push({nameValue:e.selectedTax.name+" ("+e.selectedTax.rate+"%)",amount:u(e.taxValue,"$",2),count:1,name:e.selectedTax.name,amountValue:e.taxValue}):(t.itemTaxes[i].amountValue+=e.taxValue,t.itemTaxes[i].count++,t.itemTaxes[i].amount=u(t.itemTaxes[i].amountValue,"$",2)))}}),t.totalTax=s,t.subTotal=n,t.subTotalStr=u(n*F.exchangeRate,F.currencySymbol,2),t.reCalculateTotal()}function N(){return t.items.pop(),e.when(c.getCustomerExpenses({organization:E,customer:t.selectedCustomer.entity})).then(function(e){for(var n=[],s=0;s<e.length;++s)if("No"!=e[s].entity.get("billable"))for(var a=0;a<t.expenseItems.length;++a)e[s].entity.id==t.expenseItems[a].entity.expanseId&&n.push(t.expenseItems[a]);for(var i=[],s=0;s<e.length;++s)if("No"!=e[s].entity.get("billable")){var o=e[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}var r=t.actualItems.concat(n,i);return t.invoiceItems=t.invoiceItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),"Sales"!=k.get("role")&&r.push(createItemOpener),t.items=r})}function I(e){var t=e.entity;return t.name+" "+t.price+" ("+t.type+")"}function L(){var n=[],s=null;return s=e.when(o.getAllCustomers()).then(function(e){e=e.filter(function(e){return"active"==e.entity.status}),t.customers=e.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),t.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),"Sales"!=k.get("role")&&t.customers.push(createCustomerOpener)}),n.push(s),s=e.when(o.getAllItemsIncludingDelete({organization:E})).then(function(e){t.actualItems=e.filter(function(e){return!e.entity.expanseId}),t.expenseItems=e.filter(function(e){return e.entity.expanseId}),t.items=t.actualItems,"Sales"!=k.get("role")&&t.items.push(createItemOpener)}),n.push(s),s=e.when(i.getPreferences(k)).then(function(e){t.prefs=e}),n.push(s),s=e.when(o.getUserRole(k)).then(function(e){t.userRole=e}),n.push(s),s=r.getTaxes(k,function(e){t.taxes=e,"Sales"!=k.get("role")&&t.taxes.push(createTaxOpener)}),n.push(s),s=l.getAllLateFees({organization:E}).then(function(e){t.lateFeeList=e.map(function(e){return e.toStr=I(e),e}),"Sales"!=k.get("role")&&t.lateFeeList.push(createLateFeeOpener)}),n.push(s),e.all(n)}function P(){showLoader(),e.when(i.listInvoices(k)).then(function(e){var n=t.dateFormat.toUpperCase().replace(/E/g,"d");e.forEach(function(e){switch(e.entity.status){case"Unpaid":e.statusClass="text-color-normalize";break;case"Paid":e.statusClass="text-paid";break;case"Overdue":e.statusClass="text-overdue";break;case"Partial Paid":e.statusClass="text-partialpaid";break;case"Sent":e.statusClass="text-sent";break;case"Refunded":case"Partial Refunded":e.statusClass="text-danger";break;default:e.statusClass="text-color-normalize"}e.entity.get("invoiceFiles")&&(e.attachments=e.entity.get("invoiceFiles").length),e.invoiceDate=formatDate(e.entity.invoiceDate,n);var t=0;if(e.entity.dueDate){e.dueDate=formatDate(e.entity.dueDate,n);var s=e.entity.dueDate;s.setHours(23),s.setMinutes(59),s.setSeconds(59);var a=new Date,i=e.entity.balanceDue*F.exchangeRate,o=e.entity.total*F.exchangeRate;if(a>s&&e.entity.get("lateFee")){var r=e.entity.get("lateFee"),c=r.get("price"),l=r.get("type");"$"==l?t=c:"%"==l&&(t=i*c*.01)}}else e.dueDate="";e.balanceDue=u(i+t,F.currencySymbol,2),e.total=u(o+t,F.currencySymbol,2)}),e=e.reverse(),t.invoiceList=e,t.allInvoices=e,t.displayedInvoices=e,t.sortByDate(),hideLoader()},function(e){hideLoader(),console.log(e.message)})}function U(){t.latefeeName="",t.latefeeTypes=["%","$"],t.selectedFeeType=t.latefeeTypes[0],t.latefeeAmount="",$("#addLateFeeForm").validate({rules:{name:"required",type:"required",amount:{required:!0,number:!0,min:.01}}}),$("#addLateFeeForm").validate().resetForm()}if(a.entity.length){var F=a.entity[0].currency.attributes;if(F.exchangeRate)t.currentCurrency=F;else{var S={currencySymbol:"$",exchangeRate:1};t.currentCurrency=S,F=S}var k=a.entity[0],E=k.get("organizations")[0];s("DashboardController",{$scope:t,$state:n});var j={details:function(e){return e.endsWith("invoices.details")},invoices:function(e){return e.endsWith("invoices.all")},edit:function(e){return e.endsWith("invoices.edit")},newInvoice:function(e){return e.endsWith("invoices.new")}};a.getField("dateFormat").then(function(n){t.dateFormat=n,e.when(a.entity[0].currency.fetch()).then(function(e){if((F=e.attributes).exchangeRate)t.currentCurrency=F;else{var n={currencySymbol:"$",exchangeRate:1};t.currentCurrency=n,F=n}f()})}),$.validator.addMethod("notBackDate",function(e,n){return t.todayDate<=t.dueDate}),$("#addTaxForm").validate({rules:{name:"required",rate:{required:!0,number:!0}},messages:{name:"Please enter Tax name",rate:{required:"tax rate is required",number:"please enter a valid rate(number)"}}}),$("#editInvoiceForm").validate({rules:{customer:"required",invoiceNumber:"required",invoiceCreateDate:"required",invoiceDueDate:{required:!0}},messages:{customer:"Please select a customer",invoiceNumber:"Please enter invoice number",invoiceCreateDate:"Please provide invoice Create date",invoiceDueDate:{required:"Please provide invoice Due date"}}}),$("#extrasForm").validate({rules:{discount:{number:!0,min:0},shipCharges:{number:!0,min:0},adjustment:{number:!0}}}),$("#itemInfoForm").validate(),t.dateOptions={showWeeks:!1},t.addInvoiceItem=function(){var e=t.deletedItems.pop();e?--t.itemsWithIdinDel:(e={id:void 0},++t.itemsWithOutId),e.selectedItem=void 0,e.selectedTax=void 0,e.rate=0,e.quantity=1,e.discount=0,e.taxValue=0,e.amount=0,t.invoiceItems.push(e)},t.removeInvoiceItem=function(e){if(t.invoiceItems.length>1){var n=t.invoiceItems.splice(e,1)[0];n.id?(++t.itemsWithIdinDel,t.deletedItems.push(n)):--t.itemsWithOutId,D()}else console.log("there should be atleast 1 item in an invoice")},t.save=function(){C()&&(showLoader(),g(),v({generateReceipt:!0}).then(function(e){hideLoader(),console.log(e),n.go("dashboard.sales.invoices.details",{invoiceId:e.id})},function(e){hideLoader(),console.log(e.message)}))},t.saveAndSend=function(){C()&&(showLoader(),g(),x().then(function(e){hideLoader(),console.log(e),n.go("dashboard.sales.invoices.all")},function(e){hideLoader(),console.log(e)}))},t.addNewFile=function(e){var n=e.files[0],s=n.name;s.toLowerCase().indexOf("^")>=0&&(s=s.replace("^","")),s.toLowerCase().endsWith(".pdf")||s.toLowerCase().endsWith(".png")||s.toLowerCase().endsWith(".jpg")||s.toLowerCase().endsWith(".jpeg")?($("#file-error").hide(),e.files[0].size>5242880?$("#file-size-error").show():($("#file-size-error").hide(),s="Attachment "+w(++t.lastFileNumber)+T(s),n.fileName=s,n.fileName1=s,t.files.push(n),t.$$phase||t.$apply())):$("#file-error").show()},t.removeFile=function(e){t.files.splice(e,1)},t.cancel=function(){n.go("dashboard.sales.invoices.all")},t.calculateDueDate=function(){var e=new Date(t.todayDate);e.setHours(0),1!=t.paymentTerms.selectedTerm.value&&(e=e.addDays(t.paymentTerms.selectedTerm.value)),t.dueDate=e},t.paymentTermsChanged=function(){0==t.paymentTerms.selectedTerm.value?t.hasDueDate=!1:t.hasDueDate=!0,t.hasDueDate&&t.calculateDueDate()},t.openDatePicker=function(e){if(!(2==e&&t.paymentTerms.selectedTerm.value>1))switch(e){case 2:t.openPicker2=!0}},t.reCalculateTotal=function(){var e=Number(t.subTotal)||0,n=Number(t.discount)||0,s=Number(t.shippingCharges)||0,a=Number(t.adjustments)||0,i=Number(t.totalTax)||0,o=e+i,r=.01*(100-n);2==t.prefs.discountType?o=e*r+i:3==t.prefs.discountType&&(o=(e+i)*r),n=Math.abs(o-e-i),t.total=o+s+a,t.discountStr=u(n*F.exchangeRate,F.currencySymbol,2),t.shippingChargesStr=u(s*F.exchangeRate,F.currencySymbol,2),t.adjustmentsStr=u(a*F.exchangeRate,F.currencySymbol,2),t.totalStr=u(t.total*F.exchangeRate,F.currencySymbol,2)},t.reCalculateItemAmount=function(e){var n=t.invoiceItems[e];n.selectedItem&&(n.amount=n.rate*n.quantity,D())},t.taxChanged=function(e){if(console.log("tax changed"),-1==e){if(t.newItem.tax.dummy)return t.currentItem=e,t.newItem.tax=null,t.taxName=null,t.taxRate=null,void $(".new-tax").addClass("show")}else{var n=t.invoiceItems[e];if(n.selectedTax){if(n.selectedTax.dummy)return t.currentItem=e,t.taxName=null,t.taxRate=null,n.selectedTax=null,void $(".new-tax").addClass("show")}else D()}D()},t.itemChanged=function(e){var n=t.invoiceItems[e];if(n.selectedItem.dummy)return n.selectedItem=null,$(".new-item").addClass("show"),t.itemChangedIndex=e,void t.prepareCreateItem();n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=t.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";t.reCalculateItemAmount(e)},t.customerChanged=function(){t.selectedCustomer.dummy?n.go("dashboard.customers.new",{backLink:n.current.name,invoiceId:n.params.invoiceId}):(showLoader(),e.when(N()).then(function(){t.invoiceItems.length<1?(t.addInvoiceItem(),t.totalTax=0,t.subTotal=0,t.subTotalStr=u(0,F.currencySymbol,2),t.reCalculateTotal()):D(),hideLoader()}))},t.sortByStatus=function(){t.invoiceList.sort(function(e,t){return e.entity.status.localeCompare(t.entity.status)}),"none"===$("#status").css("display")?(t.invoiceList.sort(function(e,t){return e.entity.status.localeCompare(t.entity.status)}),$("#status").css({display:"inline-table"}),$("#statusUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return t.entity.status.localeCompare(e.entity.status)}),$("#statusUp").css({display:"inline-table"}),$("#status").css({display:"none"})),$("#date").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#orderno").css({display:"none"}),$("#custname").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"}),$("#ordernoUp").css({display:"none"}),$("#custnameUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByInvoiveNumber=function(){"none"===$("#invoiceno").css("display")?(t.invoiceList.sort(function(e,t){return t.entity.invoiceNumber.localeCompare(e.entity.invoiceNumber)}),$("#invoiceno").css({display:"inline-table"}),$("#invoicenoUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return e.entity.invoiceNumber.localeCompare(t.entity.invoiceNumber)}),$("#invoicenoUp").css({display:"inline-table"}),$("#invoiceno").css({display:"none"})),$("#status").css({display:"none"}),$("#date").css({display:"none"}),$("#orderno").css({display:"none"}),$("#custname").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#ordernoUp").css({display:"none"}),$("#custnameUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByOrderNumber=function(){$("#status").css({display:"none"}),$("#date").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#custname").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"}),$("#custnameUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"}),"none"===$("#orderno").css("display")?(t.invoiceList.sort(function(e,t){return e.entity.poNumber.localeCompare(t.entity.poNumber)}),$("#orderno").css({display:"inline-table"}),$("#ordernoUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return t.entity.poNumber.localeCompare(e.entity.poNumber)}),$("#ordernoUp").css({display:"inline-table"}),$("#orderno").css({display:"none"}))},t.sortByBalance=function(){"none"===$("#balance").css("display")?(t.invoiceList.sort(function(e,t){return t.entity.balanceDue-e.entity.balanceDue}),$("#balance").css({display:"inline-table"}),$("#balanceUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return e.entity.balanceDue-t.entity.balanceDue}),$("#balanceUp").css({display:"inline-table"}),$("#balance").css({display:"none"})),$("#status").css({display:"none"}),$("#date").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#orderno").css({display:"none"}),$("#custname").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"}),$("#ordernoUp").css({display:"none"}),$("#custnameUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"})},t.sortByAmount=function(){"none"===$("#amount").css("display")?(t.invoiceList.sort(function(e,t){return t.entity.total-e.entity.total}),$("#amount").css({display:"inline-table"}),$("#amountUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return e.entity.total-t.entity.total}),$("#amountUp").css({display:"inline-table"}),$("#amount").css({display:"none"})),$("#status").css({display:"none"}),$("#date").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#orderno").css({display:"none"}),$("#custname").css({display:"none"}),$("#duedate").css({display:"none"}),$("#balance").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"}),$("#ordernoUp").css({display:"none"}),$("#custnameUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByCustomerName=function(){"none"===$("#custname").css("display")?(t.invoiceList.sort(function(e,t){return e.customer.displayName.localeCompare(t.customer.displayName)}),$("#custname").css({display:"inline-table"}),$("#custnameUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return t.customer.displayName.localeCompare(e.customer.displayName)}),$("#custnameUp").css({display:"inline-table"}),$("#custname").css({display:"none"})),$("#status").css({display:"none"}),$("#date").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#orderno").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"}),$("#ordernoUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByDate=function(){"none"===$("#date").css("display")?(t.invoiceList.sort(function(e,t){return e.entity.invoiceDate>t.entity.invoiceDate?-1:e.entity.invoiceDate<t.entity.invoiceDate?1:0}),$("#date").css({display:"inline-table"}),$("#dateUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return t.entity.invoiceDate>e.entity.invoiceDate?-1:t.entity.invoiceDate<e.entity.invoiceDate?1:0}),$("#dateUp").css({display:"inline-table"}),$("#date").css({display:"none"})),$("#status").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#orderno").css({display:"none"}),$("#custname").css({display:"none"}),$("#duedate").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"}),$("#ordernoUp").css({display:"none"}),$("#custnameUp").css({display:"none"}),$("#duedateUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.sortByDueDate=function(){t.invoiceList.sort(function(e,t){return t.dueDate.localeCompare(e.dueDate)}),"none"===$("#duedate").css("display")?(t.invoiceList.sort(function(e,t){return e.entity.dueDate>t.entity.dueDate?-1:e.entity.dueDate<t.entity.dueDate?1:0}),$("#duedate").css({display:"inline-table"}),$("#duedateUp").css({display:"none"})):(t.invoiceList.sort(function(e,t){return t.entity.dueDate>e.entity.dueDate?-1:t.entity.dueDate<e.entity.dueDate?1:0}),$("#duedateUp").css({display:"inline-table"}),$("#duedate").css({display:"none"})),$("#status").css({display:"none"}),$("#date").css({display:"none"}),$("#invoiceno").css({display:"none"}),$("#orderno").css({display:"none"}),$("#custname").css({display:"none"}),$("#amount").css({display:"none"}),$("#balance").css({display:"none"}),$("#statusUp").css({display:"none"}),$("#dateUp").css({display:"none"}),$("#invoicenoUp").css({display:"none"}),$("#ordernoUp").css({display:"none"}),$("#custnameUp").css({display:"none"}),$("#amountUp").css({display:"none"}),$("#balanceUp").css({display:"none"})},t.lateFeeChanged=function(){t.selectedLateFee&&t.selectedLateFee.dummy&&(t.selectedLateFee="",U(),$(".add-latefee").addClass("show"))},t.addLateFee=function(){if($("#addLateFeeForm").valid()){showLoader();var n={userID:k,organization:E,name:t.latefeeName,type:t.selectedFeeType,price:Number(t.latefeeAmount)};e.when(o.getUserRole(k)).then(function(e){return l.createLateFee(n,e)}).then(function(e){e.toStr=I(e),t.lateFeeList.pop(),t.lateFeeList.push(e),"Sales"!=k.get("role")&&t.lateFeeList.push(createLateFeeOpener),t.selectedLateFee=e,$(".add-latefee").removeClass("show"),hideLoader()})}},t.prepareCreateItem=function(){m.prepareCreateItem({_scope:t})},t.createNewItem=function(){m.createNewItem({_scope:t,user:k,organization:E})},t.saveNewTax=function(){$("#addTaxForm").valid()&&m.createNewTax({_scope:t,user:k},function(){D(),t.$$phase||t.$apply()})},t.showMenu=function(){$(".filtermenu").hasClass("show")?$(".filtermenu").removeClass("show"):$(".filtermenu").addClass("show")},t.currentInvoice="All Invoices",t.showAllInvoices=function(){t.invoiceList=t.allInvoices.filter(function(e){return!0}),t.displayedInvoices=t.allInvoices,t.currentInvoice="All Expenses",$(".filtermenu").removeClass("show")},t.sentInvoices=function(){t.invoiceList=t.allInvoices.filter(function(e){return"Sent"==e.entity.status}),t.displayedInvoices=t.invoiceList,t.currentInvoice="Sent Invoices",$(".filtermenu").removeClass("show")},t.overdueInvoices=function(){t.invoiceList=t.allInvoices.filter(function(e){return"Overdue"==e.entity.status}),t.displayedInvoices=t.invoiceList,t.currentInvoice="Overdue Invoices",$(".filtermenu").removeClass("show")},t.draftInvoices=function(){t.invoiceList=t.allInvoices.filter(function(e){return"Draft"==e.entity.status}),t.displayedInvoices=t.invoiceList,t.currentInvoice="Draft Invoices",$(".filtermenu").removeClass("show")},t.paidInvoices=function(){t.invoiceList=t.allInvoices.filter(function(e){return"Paid"==e.entity.status}),t.currentInvoice="Paid Invoices",t.displayedInvoices=t.invoiceList,$(".filtermenu").removeClass("show")},t.partialPaidInvoices=function(){t.invoiceList=t.allInvoices.filter(function(e){return"Partial Paid"==e.entity.status}),t.displayedInvoices=t.invoiceList,t.currentInvoice="Partial Paid Invoices",$(".filtermenu").removeClass("show")},t.refundedInvoices=function(){t.invoiceList=t.allInvoices.filter(function(e){return"Refunded"==e.entity.status}),t.displayedInvoices=t.invoiceList,t.currentInvoice="Refunded Invoices",$(".filtermenu").removeClass("show")},t.search=function(){t.searchText.length?t.invoiceList=t.displayedInvoices.filter(function(e){return e.entity.status||(e.entity.status=""),e.invoiceDate||(e.invoiceDate=""),e.entity.invoiceNumber||(e.entity.invoiceNumber=""),e.entity.poNumber||(e.entity.poNumber=""),e.customer.displayName||(e.customer.displayName=""),e.dueDate||(e.dueDate=""),e.total||(e.total=""),e.balanceDue||(e.balanceDue=""),e.entity.status.toLowerCase().includes(t.searchText.toLowerCase())||e.invoiceDate.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.invoiceNumber.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.poNumber.toLowerCase().includes(t.searchText.toLowerCase())||e.customer.displayName.toLowerCase().includes(t.searchText.toLowerCase())||e.dueDate.toLowerCase().includes(t.searchText.toLowerCase())||e.total.toLowerCase().includes(t.searchText.toLowerCase())||e.balanceDue.toLowerCase().includes(t.searchText.toLowerCase())}):t.invoiceList=t.displayedInvoices}}else console.log("User not logged in")}]),invoicesUnlimited.controller("InvoiceDetailController",["$q","$scope","$state","$sce","$controller","userFactory","invoiceService","creditNoteService","coreFactory","commentFactory","currencyFilter","$rootScope",function(e,t,n,s,a,i,o,r,c,l,d,u){function m(){scrollToOffset();var a=n.params.invoiceId;a&&(showLoader(),e.when(o.getInvoiceDetails(a)).then(function(e){var n=e.entity.get("userID");"General Employee"==i.entity[0].get("role")?i.entity[0].id==n.id&&(t.isOwner=!0):t.isOwner=!0,1==e.entity.get("customer").get("isDeleted")&&(t.isOwner=!1);var s=t.dateFormat.toUpperCase().replace(/E/g,"d");t.invoice=e,t.invoiceNo=e.entity.invoiceNumber,e.comments&&e.comments.forEach(function(e){e.date=formatDate(e.entity.date,s)}),t.comments=e.comments,t.invoiceInfo=e.entity.invoiceInfo,t.showPayLink=!1,e.entity.balanceDue>0&&(t.showPayLink=!0),e.payments?(e.payments.forEach(function(e){e.date=formatDate(e.entity.date,s),e.amount=d(e.entity.amount*C.exchangeRate,C.currencySymbol,2),"Credit Card"==e.entity.mode?e.mode="CC "+e.entity.lastFourDigits:e.mode=e.entity.mode}),t.payments=e.payments):t.payments=[],e.attachments?(e.attachments.forEach(function(e){e.fileName=e.name(),e.fileName1=e.fileName.substring(e.fileName.indexOf("_")+1,e.fileName.length),e.fileUrl=e.url()}),t.attachments=e.attachments):t.attachments=[];var r=e.entity.invoiceReceipt,c=e.entity.invoiceInfo;return c&&(c=c.id),r&&e.entity.get("hasPdfReceipt")?(t.payLink="https://invoicesunlimited.net/pay/?InvoiceInfoID="+c,Promise.resolve(r)):c?(t.payLink="https://invoicesunlimited.net/pay/?InvoiceInfoID="+c,o.createInvoiceReceipt(a,c).then(function(e){return e.get("invoiceReceipt")})):o.copyInInvoiceInfo(e.entity).then(function(e){return c=e.id,t.payLink="https://invoicesunlimited.net/pay/?InvoiceInfoID="+c,o.createInvoiceReceipt(a,c).then(function(e){return e.get("invoiceReceipt")})})}).then(function(e){return t.templateUrl=s.trustAsResourceUrl(e.url()),$.ajax({type:"GET",url:"proxy.php",dataType:"html",data:{address:e.url()}}).then(function(e){var t=document.getElementById("targetframe");t.src="about:blank",t.contentWindow.document.open(),t.contentWindow.document.write(e),t.contentWindow.document.close(),hideLoader()})},function(e){hideLoader(),console.log(e.message)}))}function p(){t.selectedPayment.entity.mode,t.selectedPayment.entity.deleted;var s=t.invoiceInfo.get("paymentStatus");s=(s=(s=s.split(":"))[s.length-1]).replace(" ","");var a=T.get("AuthNet"),i=T.get("AuthKey"),o=t.selectedPayment.entity.get("amount"),r=t.selectedPayment.entity.get("lastFourDigits"),c=t.selectedPayment.entity.get("date"),l=new Date,u="";u=Math.abs(l-c)/36e5<12?"voidTransaction":"refundTransaction";var m={HTML:"No",AuthNet:a,AuthKey:i,TransID:s,CardNo:parseInt(r),TranType:u,Amount:parseFloat(o)},p=Object.assign({},m,{});showLoader(),$.ajax({method:"POST",type:"POST",url:"refundAuth.php",data:p,complete:function(e){console.log("Reguest is done: "+e)},error:function(e){alert("ERROR: "+e)},success:function(s){s.match(/[^,]+/g);if(s.indexOf("Error")<0){var a=t.selectedPayment.entity;a.set("deleted",!0);var i=t.invoiceInfo;i.set("paymentStatus",s);var o=t.invoice.entity;o.unset("invoiceReceipt"),o.increment("paymentMade",-a.amount),o.increment("balanceDue",a.amount),o.get("paymentMade")<=0?o.set("status","Refunded"):o.set("status","Partial Refunded");var r=[];r.push(a.save()),r.push(o.save()),r.push(i.save());var c="Refund made for "+d(a.amount,"$",2)+" amount";r.push(v(c,!0)),e.all(r).then(function(){$(".confirm-refund").removeClass("show"),$(".refund-payment").removeClass("show"),showSnackbar("Payment Refunded"),hideLoader(),setTimeout(function(){n.reload()},2e3)})}}})}function f(){t.selectedPayment.entity.mode,t.selectedPayment.entity.deleted;var s=t.invoiceInfo.get("paymentStatus");s=(s=(s=s.split(","))[s.length-1]).replace(/\"/g,"");var a=T.get("EPNusername"),i=T.get("EPNrestrictKey"),o=t.selectedPayment.entity.get("amount"),r=t.selectedPayment.entity.get("date"),c=new Date,l="",u={HTML:"No",ePNAccount:a,RestrictKey:i,TransID:s,TranType:l=Math.abs(c-r)/36e5<12?"Void":"Return",Total:o},m=Object.assign({},u,{});showLoader(),$.ajax({method:"GET",url:"refund.php",data:m,complete:function(e){console.log("Reguest is done: "+e)},error:function(e){alert("ERROR: "+e)},success:function(s){if(s.match(/[^,]+/g).length){var a=t.selectedPayment.entity;a.set("deleted",!0);var i=t.invoiceInfo;i.set("paymentStatus",s);var o=t.invoice.entity;o.unset("invoiceReceipt"),o.increment("paymentMade",-a.amount),o.increment("balanceDue",a.amount),o.get("paymentMade")<=0?o.set("status","Refunded"):o.set("status","Partial Refunded");var r=[];r.push(a.save()),r.push(o.save()),r.push(i.save());var c="Refund made for "+d(a.amount,"$",2)+" amount";r.push(v(c,!0)),e.all(r).then(function(){$(".confirm-refund").removeClass("show"),$(".refund-payment").removeClass("show"),showSnackbar("Payment Refunded"),hideLoader(),setTimeout(function(){n.reload()},2e3)})}}})}function h(){showLoader();var s=t.selectedPayment.entity,a=s.get("creditNote");e.when(a.fetch()).then(function(i){var o=a.get("creditsUsed"),r=a.get("remainingCredits");a.set("creditsUsed",o-s.amount),a.set("remainingCredits",r+s.amount),"Closed"==a.get("status")&&a.set("status","Open"),s.set("deleted",!0);var c=t.invoice.entity;c.unset("invoiceReceipt"),c.increment("paymentMade",-s.amount),c.increment("balanceDue",s.amount),c.get("paymentMade")<=0?c.set("status","Refunded"):c.set("status","Partial Refunded");var l=[];l.push(s.save()),l.push(a.save()),l.push(c.save());var u="Refund made for "+d(s.amount,"$",2)+" amount";l.push(v(u,!0)),e.all(l).then(function(){$(".confirm-refund").removeClass("show"),$(".refund-payment").removeClass("show"),showSnackbar("Payment Refunded"),hideLoader(),setTimeout(function(){n.reload()},2e3)})})}function y(e){return e<10&&(e="0"+e),e}function g(e){return"."+e.split(".").pop()}function v(n,s){var a={userID:T,organization:D,name:T.get("username"),date:new Date,isAutomaticallyGenerated:s,comment:n};if(!T.get("isTrackUsage")&&s)return Promise.resolve("");var i={};return e.when(c.getUserRole(T)).then(function(e){return l.createNewComment(a,e)}).then(function(e){i.commentObj=e;var n=t.invoice.entity,s=n.get("comments");return s?s.push(e):s=[e],n.set("comments",s),n.save()}).then(function(e){var n=new l(i.commentObj);return n.date=formatDate(n.entity.date,N),t.comments?t.comments.push(n):t.comments=[n],e})}function b(s,a){var i={userID:T,organization:D,name:T.get("username"),date:new Date,isAutomaticallyGenerated:a,comment:s};if(T.get("isTrackUsage")||!a){var o={};e.when(c.getUserRole(T)).then(function(e){return l.createNewComment(i,e)}).then(function(e){o.commentObj=e;var n=t.invoice.entity,s=n.get("comments");return s?s.push(e):s=[e],n.set("comments",s),n.save()}).then(function(e){var s=new l(o.commentObj);return s.date=formatDate(s.entity.date,N),t.comments?t.comments.push(s):t.comments=[s],hideLoader(),n.reload(),e})}}function x(e){var s=$(e).find("itemRow"),a=($(e).find("modsRow"),$(e).find("attachment")),o=$(e).find("customField"),r=$(e).find("tax");$("<td></td>");$(e).find("billType").text().includes("estimate")&&($(".footer .info").hide(),$(".payment-due").hide()),/^[\s]*$/.test(s.first().find("discount").text())?$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'):$("#invoice-items-header").append('<td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; font-size: 16px; vertical-align: middle; /*background: #317cf4;*/ padding-left: 14pt;">Item</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Quantity</td> <td class="ff1 fc0 btm-line top-line" colspan="1" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/">Discount</td> <td class="ff1 fc0 btm-line top-line" colspan="2" style="height: 9mm; vertical-align: middle; text-align: right; font-size: 16px; /*background: #317cf4;*/ padding-right: 14pt;">Amount</td>'),s.each(function(e){var t="<span>"+$(this).children("name").text()+"</span><br><span style='white-space: pre-wrap;word-wrap: break-word; color: #727272; font-size: 10pt;'>"+$(this).children("desc").text()+"</span>";if(/^[\s]*$/.test(s.first().find("discount").text())){var n=$("<tr class='invoice-items'></tr>"),a=$("<td class='ff1 fc0 invoice-item-title' style='width: 50mm;' colspan='2'>"+t+"</td>"),i=$("<td class='ff1 fc0  invoice-item-qty' colspan='2'>"+$(this).children("qty").text()+"</td>"),o=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");n.append(a).append(i).append(o),$("#invoice-items-header").after($(n))}else{var n=$("<tr class='invoice-items'></tr>"),a=$("<td class='ff1 fc0 invoice-item-title' style='width: 50mm;' colspan='2'>"+t+"</td>"),i=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("qty").text()+"</td>"),r=$("<td class='ff1 fc0  invoice-item-qty' colspan='1'>"+$(this).children("discount").text()+"</td>"),o=$("<td class='ff1 fc0  invoice-item-cost' colspan='2'>"+$(this).children("price").text()+"</td>");n.append(a).append(i).append(r).append(o),$("#invoice-items-header").after($(n))}}),r.each(function(){var e=$("<tr class='invoice-taxes'></tr>"),t=$("<td colspan='3' class=''></td>"),n=$("<td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).children("name").text()+"</td>"),s=$("<td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).children("value").text()+"</td>");e.append(t).append(n).append(s),$("#invoice-subtotal").after($(e))});var c=$('<tr class="salestax"></tr>');$("tr.adjustments").after(c),o.each(function(){$(".customFields").append($('<div class="info-1" style="margin: 0;border: 0;font-size: 100%;font: inherit;float: left;box-sizing: border-box;width: 70%; float: left; margin-left: 3%;margin-left: 0px"><p class="" style="margin: 0;padding: 10px 0px 0px 0px;border: 0;font-size: 16px;vertical-align: baseline;line-height: 30px;margin-bottom: 10px;color: #989898;">'+$(this).children("name").text()+'</p><p class="" style="margin: 0;padding: 0;border: 0;font-size: 16px;margin-bottom: 10px;color: #000;">'+$(this).children("value").text()+"</p></div>"))}),a.each(function(){var e=$(this).text();e=(e=e.substring(e.indexOf("_")+1,e.length)).replace(/%20/g," "),$(".attach").append('<a style="color: #989898" target="_blank" href=\''+$(this).text()+"'>"+e+"</a><br><br>")}),$("table tbody tr").each(function(){0==$(this).children().text().length&&$(this).addClass("hideOnMob")});var l=$(e).find("invoiceId").text();$("#pay-link").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+l),$("#pay-link-2").attr("href","https://invoicesunlimited.net/pay/?InvoiceInfoID="+l);var d=$(e).find("items");console.log(d),d.each(function(){var e=new Date(Date.parse($(this).find("past-due").text())),t=new Date(Date.now());e=new Date(e.setHours(0,0,0,0)),t=new Date(e.setHours(0,0,0,0)),e.getTime()>=t.getTime()||"Invalid Date"===e.toString()?($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("green-status")):($(".payment-due p:last").append($(this).find("past-due").text()),$(".payment-due").addClass("red-status"));o=$(this).find("headerTitle").text();$(".payment-due p:first").append(o);"true"===$(this).find("disablePay").text()&&($(".btn-border-pay").addClass("disable"),$(".info.cl").addClass("disable"),$(".payment-due").removeClass("red-status"),$(".payment-due").addClass("green-status"));var n=$(this).find("discountAmount").text(),s=$('<tr class="discount"></tr>');s.append($('<td class="discountNm" colspan="3"></td>').html("Discount")),s.append($('<td class="discountPr"></td>').html(n)),"after"==$(this).find("discountPlace text").text()?$(".salestax:last").after(s):"before"==$(this).find("discountPlace text").text()&&$(".salestax:first").before(s);a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountNameBottom").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("discountAmount").text()+"</td></tr>");if("after"==$(this).find("discountPlace text").text()?$(".invoice-taxes:last").after($(a)):"before"==$(this).find("discountPlace text").text()&&$("#invoice-subtotal").after($(a)),$(this).find("adjustments").text().length>0){var a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustments").text()+"</td><td class='ff1 fc1 ' style='padding-bottom: 4mm; text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("adjustmentsPrice").text()+"</td></tr>");$("#invoice-subtotal").after($(a))}$(this).find("shippingCharges").text().length>0&&(a=$("<tr class='invoice-adjustments'><td colspan='3' class=''></td><td class='ff1 fc1 ' colspan='2' style = 'padding-bottom: 4mm; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingCharges").text()+"</td><td class='ff1 fc1 ' style=' padding-bottom: 4mm;text-align: right; vertical-align: middle; font-size: 16px;'>"+$(this).find("shippingChargesPrice").text()+"</td></tr>"),$("#invoice-subtotal").after($(a)));var o=$(this).find("headerTitle").text(),r=$(this).find("past-due").text();o?$("#pdf-title").text(o+"   "+r):($("#pdf-title").text(""),$(".top-bar").css("height","0mm"),$(".top-bar").css("border-bottom","0mm"));k=$(this).find("ordernotes-title").text();(E=$(this).find("ordernotes").text())?($("#pdf-terms-title").text(k),$("#pdf-terms").text(E)):($("#pdf-terms-title").text(""),$("#pdf-terms").text(""),$("#pdf-terms-title").hide(),$("#pdf-terms").hide()),$("#pdf-business-name").text(i.entity[0].get("company")),$("#pdf-invoice-title").text($(this).find("invoice-title").text()),$("#pdf-invoice-number").text($(this).find("refid").text()),$("#pdf-amount-received").text($(this).find("body-price").text()),$("#pdf-date").text($(this).find("body-date").text()),$("#pdf-subtotal").text($(this).find("subtotalprice").text()),$("#pdf-payment-made").text($(this).find("paymentMadePrice").text()),$("#pdf-total").text($(this).find("total-price3").text()),$("#pdf-total-top").text($(this).find("total-price3").text()),$("#pdf-credit-applied").text($(this).find("creditsAppliedPrice").text()),$("#pdf-amount-due").text($(this).find("refundtotal").text()),$("#pdf-payment-name").text($(this).find("title").text()),$("#pdf-currency").text($(this).find("body-currency").text()),$("#pdf-total-text").text($(this).find("refundedText").text()),$("#pdf-payment-text").text($(this).find("paymentMadeText").text()),$("#pdf-credit-text").text($(this).find("creditsAppliedText").text());var c=$(this).find("addres1").text();$("#pdf-address").html(c);var l=$(this).find("longmsg").text();if(0!=l.length){I=$(this).find("longmsg-title").text();$("#pdf-notes-title").html(I),$("#pdf-notes").html(l)}else $("#pdf-notes-title").html(""),$("#pdf-notes").html(""),$("#pdf-notes-title").hide(),$("#pdf-notes").hide();w=$(this).find("mailto").text();$("#user-mail").attr("href",w);T=$(this).find("mailtotxt").text();$("#user-mail").text(T);F=$(this).find("clientmailto").text();$("#client-mail").attr("href",F);S=$(this).find("clientmail").text();$("#client-mail").text(S);P=$(this).find("clientname").text();$("#client-name").text(P);D=$(this).find("nr").text();$("#user-phone").attr("href","tel:"+D),$("#user-phone").text(D);var d=$(this).find("refid").text();$(".visa-card").append(d);var u=$(this).find("purchaseOrderNumber").text();$(".purchase-order").append(u);var m=$(this).find("invoice-title").text();$(".invoice-details-1 h1").append(m);var p=$(this).find("list-header-total").text();$(".list-header li:first-child span").append(p);var f=$(this).find("list-header-date").text();$(".list-header li:nth-child(2) span").append(f);var h=$(this).find("list-header-currency").text();$(".list-header li:nth-child(3) span").append(h);var y=$(this).find("body-price").text();$(".list-body li:first-child span").append(y);g=$(this).find("body-date").text();$(".list-body li:nth-child(2) span").append(g);var g=$(this).find("body-currency").text();$(".list-body li:nth-child(3) span").append(g);var v=$(this).find("th1").text();$(".content.cl th.item").append(v);var b=$(this).find("addres1").text();$(".invoice-details-1 .info-2 p .adr").append(b);var x=$(this).find("website-link").text();$(".invoice-details-1 .info-2 .website a").attr("href",x);var C=$(this).find("website-name").text();$(".invoice-details-1 .info-2 .website a span").append(C);var w=$(this).find("mailto").text();$(".invoice-details-1 .info-2 .mailto a").attr("href",w);var T=$(this).find("mailtotxt").text();$(".invoice-details-1 .info-2 .mailto a span").append(T);var D=$(this).find("nr").text();$(".invoice-details-1 .info-2 .nr a").attr("href",D),$(".invoice-details-1 .info-2 .nr a span").append(D);var N=$(this).find("thanksmsg").text();if($(".invoice-details-2 .info-1 p:nth-child(1)").append(N),0!=(l=$(this).find("longmsg").text()).length){var I=$(this).find("longmsg-title").text();$(".notes_para_head").html(I),$(".notes_para").html(l)}var L=$(this).find("to").text();$(".invoice-details-2 .info-2 p:first-child").append(L);var P=$(this).find("clientname").text();$(".invoice-details-2 .info-2 .list-client li:first-child span").append(P);var U=$(this).find("clientnr").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(2) a").attr("href",U),$(".invoice-details-2 .info-2 .list-client li:nth-child(2) a span").append(U);var F=$(this).find("clientmailto").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(3) a").attr("href",F);var S=$(this).find("clientmail").text();$(".invoice-details-2 .info-2 .list-client li:nth-child(3) a span").append(S);var k=$(this).find("ordernotes-title").text(),E=$(this).find("ordernotes").text();$(".orderNotes").append(k),$(".orderNotesValues").append(E);var j=$(this).find("subtotal").text();$("td.subtotal").append(j);var R=$(this).find("adjustments").text();$("td.adjustments").append(R);var A=$(this).find("adjustmentsPrice").text();$("td.adjustments-price").append(A);var M=$(this).find("shippingCharges").text();$("td.shippingCharges").append(M);var B=$(this).find("shippingChargesPrice").text();$("td.shipping-charges-price").append(B);$(this).find("total-price").text();var O=$(this).find("salestax").text();$(".salestax").append(O);var q=$(this).find("paymentMadeText").text(),z=$(this).find("paymentMadePrice").text();$("td.payment-made-text").append(q),$("td.payment-made-price").append(z);var H=$(this).find("paymentRefundMadeText").text(),G=$(this).find("paymentRefundMadePrice").text();""==H?($("td.payment-refund-made-text").hide(),$("td.payment-refund-made-price").hide()):($("td.payment-refund-made-text").append(H),$("td.payment-refund-made-price").append(G));var W=$(this).find("creditsAppliedText").text(),V=$(this).find("creditsAppliedPrice").text();$("td.credits-applied-text").append(W),$("td.credits-applied-price").append(V);var K=$(this).find("total-price2").text();$(".total-price2").append(K);var _=$(this).find("total-price3").text();$(".total-price3").append(_);var Y=$(this).find("totaltext").text();$(".totl").append(Y);var X=$(this).find("refundtotal").text();$("td.refund-total").append(X);var Z=$(this).find("refundedText").text();$(".refund-price").append(Z);var J=$(this).find("total-price4").text();$(".total-price4").append(J);var Q=$(this).find("saletax").text();$(".saletax").append(Q);var ee=$(this).find("paymentmsg").text();$(".footer .info p:first-child").append(ee);var te=$(this).find("signup").text();$(".footer .info p span").append(te);var ne=$(this).find("copyright").text();$(".copyright p").append(ne);var se=$(this).find("title").text();$("head title").append(se);var ae=$(this).find("item4price").text();$(".price .item4price").append(ae);var ie=$(this).find("subtotalprice").text();$(".subtotal-price").append(ie);var oe=$(this).find("received-text").text();$(".received-text").append(oe);var re=$(this).find("received-price").text();$(".received-price").append(re);var ce=$(this).find("due-text").text();$(".due-text").append(ce);var le=$(this).find("due-price");$(".due-price").append(le);var de=$(this).find("tip-text");$(".tip-text").append(de);var ue=$(this).find("tip-price");$(".tip-price").append(ue)}),$.ajax({method:"POST",type:"POST",url:"generatePDF.php",data:{html:$(".pdf-page").html()}}).then(function(e){if(t.isPrint)return window.open("data:application/pdf;base64,"+escape(e)).print(),void n.reload();var s=document.getElementById("pdfLink"),a="data:application/octet-stream;base64,"+e;s.href=a,s.click(),n.reload()},function(e){console.error(e)})}if(i.entity.length){var C=i.entity[0].currency.attributes;if(C.exchangeRate)t.currentCurrency=C;else{var w={currencySymbol:"$",exchangeRate:1};t.currentCurrency=w,C=w}var T=i.entity[0],D=T.get("organizations")[0];a("DashboardController",{$scope:t,$state:n});var N=void 0;i.getField("dateFormat").then(function(e){t.dateFormat=e,N=t.dateFormat.toUpperCase().replace(/E/g,"d"),m()}),t.isOwner=!1,t.dateOptions={showWeeks:!1},t.changeTemplate=function(){showLoader(),e.when(c.getInvoiceTemplates()).then(function(e){var n=T.get("defaultTemplate"),s=[];e.forEach(function(e){var t={entity:e,name:e.get("name"),url:e.get("templatePreview").url()};n||"Template 1"!=t.name?t.isDefault=n.id==e.id:t.isDefault=!0,s.push(t)}),t.templates=s,$(".change-template").addClass("show"),hideLoader()},function(e){console.log(e.message),hideLoader()})},t.setDefaultTemplate=function(s){showLoader(),t.templates.forEach(function(e){e.isDefault=!1}),t.templates[s].isDefault=!0,t.invoice.entity.unset("invoiceReceipt"),T.set("defaultTemplate",t.templates[s].entity);var a=[];a.push(T.save()),a.push(t.invoice.entity.save()),e.all(a).then(function(){hideLoader(),$(".change-template").removeClass("show"),console.log("default template selected"),n.reload()},function(e){hideLoader(),console.log(e,message)})},t.cloneInvoice=function(){e.when(v("Invoice cloned",!0)).then(function(){n.go("dashboard.sales.invoices.clone",{invoiceId:t.invoice.entity.id})})},t.editInvoice=function(){n.go("dashboard.sales.invoices.edit",{invoiceId:t.invoice.entity.id})},t.showAvailableCredits=function(){showLoader(),e.when(r.getCustomerCreditNotes(t.invoice.entity.get("customer"))).then(function(e){t.creditNotes=e;var n=0;e.forEach(function(e){n+=e.entity.remainingCredits}),t.totalCredit=n,t.balanceDue=t.invoice.entity.get("balanceDue"),t.totalCreditStr=d(n*C.exchangeRate,C.currencySymbol,2),t.balanceDueStr=d(t.balanceDue*C.exchangeRate,C.currencySymbol,2),t.creditUsed=t.balanceDue>n?n:t.balanceDue;var s=n-t.balanceDue;s=s>0?s:0,t.remainingCreditStr=d(s*C.exchangeRate,C.currencySymbol,2);var a=t.totalCredit>t.balanceDue?t.balanceDue:t.totalCredit;$("#applyCreditForm").validate({rules:{usedCredit:{required:!0,number:!0,min:.01,max:a}}}),$("#applyCreditForm").validate().resetForm(),$(".apply-credit").addClass("show"),hideLoader()})},t.applyCredit=function(){if($("#applyCreditForm").valid()){showLoader(),t.creditNotes=t.creditNotes.sort(function(e,t){return e.entity.remainingCredits-t.entity.remainingCredits});for(var n=[],s=[],a=t.creditNotes,i=t.creditUsed,r=0;r<a.length&&!(i<=0);++r){var l=a[r].entity.remainingCredits,u=a[r].entity.creditsUsed,m=a[r].entity,p=0;l<=i?(i-=l,p=l,m.set("creditsUsed",u+l),m.set("remainingCredits",0),m.set("status","Closed")):(l-=i,p=i,m.set("creditsUsed",u+i),m.set("remainingCredits",l),i=0),m.unset("creditReceipt"),n.push(m),s.push({userID:T,organization:D,creditNote:m,date:new Date,mode:"Credit Note",amount:p,reference:m.creditNumber})}i=t.creditUsed;var f=t.invoice.entity;if(h=(h=f.balanceDue-i)<=.001?0:h){var h=f.get("dueDate"),y=new Date;h.setHours(0,0,0,0),y.setHours(0,0,0,0),h>y?f.set("status","Partial Paid"):f.set("status","Overdue")}else f.set("status","Paid");f.set("balanceDue",h),f.creditApplied?f.set("creditApplied",f.creditApplied+i):f.set("creditApplied",i),f.unset("invoiceReceipt");var g=[];g.push(Parse.Object.saveAll(n)),e.when(c.getUserRole(T)).then(function(e){return o.addPayments(s,e)}).then(function(t){var n=f.get("payment");return n=n?n.concat(t):t,f.set("payment",n),g.push(f.save()),e.all(g)}).then(function(){b("Credit Note applied for "+d(t.creditUsed,"$",2)+" amount",!0)})}},t.openDatePicker=function(e){switch(e){case 1:t.openPicker1=!0}},t.prepareAddPayment=function(){t.paymentDate=new Date,t.paymentAmount=t.invoice.entity.balanceDue.toFixed(2),t.paymentRef=""+Math.random().toString(10).substr(2,6),t.paymentModes=["Check","Cash","Bank Transfer","Bank Remittance"],t.selectedPaymentMode="Cash",$("#paymentForm").validate({rules:{paymentDate:"required",paymentAmount:{required:!0,number:!0,min:.01,max:t.paymentAmount},paymentRef:"required",paymentMode:"required"},messages:{paymentDate:"Please select date",paymentAmount:{required:"Please enter payment amount",number:"Please enter valid amount",min:"Amount must be greater than 0",max:"Amount cannot be greater than balance due"},paymentRef:"Please enter reference number",paymentMode:"Please select payment mode"}}),$("#paymentForm").validate().resetForm()},t.addPayment=function(){if($("#paymentForm").valid()){showLoader();var s={userID:T,organization:D,date:t.paymentDate,mode:t.selectedPaymentMode,amount:Number(t.paymentAmount),reference:t.paymentRef,notes:t.paymentNotes},a=t.invoice.entity;if(a.unset("invoiceReceipt"),a.increment("paymentMade",s.amount),a.increment("balanceDue",-s.amount),a.balanceDue<=0)a.set("status","Paid");else{var i=a.get("dueDate"),r=new Date;i.setHours(0,0,0,0),r.setHours(0,0,0,0),i>r?a.set("status","Partial Paid"):a.set("status","Overdue")}e.when(c.getUserRole(T)).then(function(t){return e.when(o.addPayments([s],t))}).then(function(e){var t=a.get("payment");return t=t?t.concat(e):e,a.set("payment",t),a.save()}).then(function(){v("Payment made for "+d(t.paymentAmount,"$",2)+" amount",!0).then(function(e){hideLoader(),n.reload()})})}},t.showPaymentDetail=function(e){t.selectedPayment=t.payments[e];var n=t.selectedPayment.entity,s=(n.mode,n.deleted);t.selectedPayment.disableRefund=!!s},t.refundPayment=function(){$(".confirm-refund").addClass("show")},t.doRefundPayment=function(){var s=t.selectedPayment.entity.mode,a=t.selectedPayment.entity.deleted;if(!a)if("Credit Card"==s&&(t.invoiceInfo.get("paymentStatus").indexOf("YAUTH")>=0?f():p()),"Credit Note"!=s){if(!(a||"Cash"!=s&&"Check"!=s&&"Bank Transfer"!=s&&"Bank Remittance"!=s)){showLoader();var i=t.selectedPayment.entity;i.set("deleted",!0);var o=t.invoice.entity;o.unset("invoiceReceipt"),o.increment("paymentMade",-i.amount),o.increment("balanceDue",i.amount),o.get("paymentMade")<=0?o.set("status","Refunded"):o.set("status","Partial Refunded");var r=[];r.push(i.save()),r.push(o.save());var c="Refund made for "+d(i.amount,"$",2)+" amount";r.push(v(c,!0)),e.all(r).then(function(){$(".confirm-refund").removeClass("show"),$(".refund-payment").removeClass("show"),showSnackbar("Payment Refunded"),hideLoader(),setTimeout(function(){n.reload()},2e3)})}}else h()},t.addAttachment=function(s){var a=s.files[0];if(a){var i=a.name;if(i.toLowerCase().endsWith(".pdf")||i.toLowerCase().endsWith(".png")||i.toLowerCase().endsWith(".jpg")||i.toLowerCase().endsWith(".jpeg"))if($("#file-error").hide(),i="Attachment "+y(t.attachments.length+1)+g(i),s.files[0].size>5242880)$("#file-size-error").show();else{$("#file-size-error").hide(),showLoader();var o=t.invoice.entity,r=new Parse.File(i,a);e.when(r.save()).then(function(e){var t=o.get("invoiceFiles");return t?t.push(e):t=[e],o.set("invoiceFiles",t),o.unset("invoiceReceipt"),o.save()}).then(function(e){v("File Attached",!0).then(function(e){n.reload(),hideLoader()})})}else $("#file-error").show()}},t.copyToClipboard=function(){var e=document.createElement("input");e.setAttribute("value",t.templateUrl),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),showSnackbar("Invoice link copied to your clipboard.")},t.textReceipt=function(){$("#text-error").hide();var e=t.invoice.entity.get("customer").get("contactPersons");t.mobileContacts=[],e.length&&e.forEach(function(e){var n=e.get("firstname")?e.get("firstname"):"",s=e.get("lastname")?e.get("lastname"):"",a=1==e.get("defaultPerson"),i=n+" "+s;e.get("phone")&&t.mobileContacts.push({selected:!1,contact:e.get("phone"),contactName:"("+i+") "+e.get("phone")}),e.get("mobile")&&t.mobileContacts.push({selected:a,contact:e.get("mobile"),contactName:"("+i+") "+e.get("mobile")})}),t.mobileContacts.length?$(".text-popup").addClass("show"):ShowMessage("Please Enter Mobile for Customer!","error")},t.sendText=function(){var e=0;if(t.mobileContacts.forEach(function(t){t.selected&&e++}),e<1)$("#text-error").show();else{if(showLoader(),"Draft"==t.invoice.entity.get("status")||"Sent"==t.invoice.entity.get("status")){var n=t.invoice.entity.get("dueDate"),s=new Date;n.setHours(0,0,0,0),s.setHours(0,0,0,0),n<s?t.invoice.entity.set("status","Overdue"):t.invoice.entity.set("status","Sent"),t.invoice.entity.save()}t.mobileContacts.forEach(function(e){e.selected&&o.sendInvoiceTextToNumber(t.invoice.entity,e.contact).then(function(t){v("Invoice texted to "+e.contact,!0),$(".text-popup").removeClass("show"),hideLoader()})})}},t.emailReceipt=function(){$("#email-error").hide();var e=t.invoice.entity.get("customer").get("contactPersons");t.contacts=[],e.length&&e.forEach(function(e){var n=e.get("firstname")?e.get("firstname"):"",s=e.get("lastname")?e.get("lastname"):"",a=1==e.get("defaultPerson"),i=n+" "+s;e.get("email")&&t.contacts.push({selected:a,contact:e.get("email"),contactName:"("+i+") "+e.get("email")})}),t.contacts.length?$(".email-popup").addClass("show"):ShowMessage("Please Enter Email for Customer!","error")},t.sendEmail=function(){var e=0;if(t.contacts.forEach(function(t){t.selected&&e++}),e<1)$("#email-error").show();else{if(showLoader(),"Draft"==t.invoice.entity.get("status")||"Sent"==t.invoice.entity.get("status")){var s=t.invoice.entity.get("dueDate"),a=new Date;s.setHours(0,0,0,0),a.setHours(0,0,0,0),s<a?t.invoice.entity.set("status","Overdue"):t.invoice.entity.set("status","Sent"),t.invoice.entity.save()}u.sendEmail(t.contacts,t.invoice.entity),hideLoader(),n.reload()}},t.canDeleteInvoice=function(){t.invoice.entity.get("payment")?$(".cannot-delete").addClass("show"):$(".confirm-delete").addClass("show")},t.deleteInvoice=function(){if(t.invoice.entity.get("payment"))console.log("invoice cannot be deleted, it contains payments");else{showLoader();var e=t.invoice.entity,s=[],a=void 0;["comments","invoiceItems"].forEach(function(t){(a=e.get(t))&&(s=s.concat(a))}),["invoiceInfo","lateFee"].forEach(function(t){(a=e.get(t))&&s.push(a)}),Parse.Object.destroyAll(s).then(function(){return e.destroy()}).then(function(){hideLoader(),n.go("dashboard.sales.invoices.all")})}},t.addComment=function(){if(t.newComment){showLoader();var n={userID:T,organization:D,name:T.get("username"),date:new Date,isAutomaticallyGenerated:!1,comment:t.newComment},s={};e.when(c.getUserRole(T)).then(function(e){return l.createNewComment(n,e)}).then(function(e){s.commentObj=e;var n=t.invoice.entity,a=n.get("comments");return a?a.push(e):a=[e],n.set("comments",a),n.save()}).then(function(){var e=new l(s.commentObj);e.date=formatDate(e.entity.date,N),t.comments?t.comments.push(e):t.comments=[e],console.log(e),$(".add-comment").removeClass("show"),hideLoader()})}else $(".add-comment").removeClass("show")},t.invoicePrinted=function(){v("Invoice printed",!0),t.isPrint=!0;var e=void 0;if(t.invoice.entity.get("pdfReceipt")&&t.invoice.entity.get("hasPdfReceipt")&&(e=t.invoice.entity.get("pdfReceipt")._url),e)window.open(e);else{var n=t.invoice.entity.get("invoiceLabels")._url,s=new XMLHttpRequest;s.open("GET",n,!1),s.setRequestHeader("Content-Type","text/xml"),s.send(null),x(s.responseXML)}},t.downloadInvoice=function(){t.isPrint=!1;var e=void 0;if(t.invoice.entity.get("pdfReceipt")&&t.invoice.entity.get("hasPdfReceipt")&&(e=t.invoice.entity.get("pdfReceipt")._url),e){var n=document.getElementById("pdfLink"),s=e;return n.href=s,n.download="invoice.pdf",void n.click()}var a=t.invoice.entity.get("invoiceLabels")._url,i=new XMLHttpRequest;i.open("GET",a,!1),i.setRequestHeader("Content-Type","text/xml"),i.send(null),x(i.responseXML)}}else console.log("User not logged in")}]),invoicesUnlimited.controller("QuickInvoiceController",["$scope","$state","$controller","$q","userFactory","invoiceService","coreFactory","commentFactory","taxService","expenseService","lateFeeService","currencyFilter","itemService","salesCommon",function(e,t,n,s,a,i,o,r,c,l,d,u,m,p){function f(){$(".check-rate").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,min:.01,number:!0,messages:{required:"Please enter an amount",min:"Please enter an amount",number:"Please enter a valid amount"}})})}function h(e){var t=e.entity;return t.name+" "+t.price+" ("+t.type+")"}function y(){showLoader();var t=[],n=null;n=s.when(o.getAllCustomers()).then(function(t){t=t.filter(function(e){return"active"==e.entity.status}),e.customers=t.sort(function(e,t){return alphabeticalSort(e.entity.displayName,t.entity.displayName)}),e.customers.forEach(function(e){e.entity.salutation?e.fullName=e.entity.salutation+" "+e.entity.displayName:e.fullName=e.entity.displayName}),"Sales"!=S.get("role")&&e.customers.push(createCustomerOpener)}),t.push(n),n=s.when(o.getAllItems({organization:k})).then(function(t){e.actualItems=t.filter(function(e){return!e.entity.expanseId}),e.expenseItems=t.filter(function(e){return e.entity.expanseId}),e.items=e.actualItems,e.items.push(createItemOpener)}),t.push(n),n=s.when(i.getPreferences(S)).then(function(t){e.prefs=t}),t.push(n),n=s.when(o.getUserRole(S)).then(function(t){e.userRole=t}),t.push(n),n=c.getTaxes(S,function(t){e.taxes=t,e.taxes.push(createTaxOpener)}),t.push(n),n=d.getAllLateFees({organization:k}).then(function(t){e.lateFeeList=t.map(function(e){return e.toStr=h(e),e}),e.lateFeeList.push(createLateFeeOpener)}),t.push(n),n=a.getField("dateFormat").then(function(t){e.dateFormat=t}),t.push(n),s.all(t).then(function(){g()},function(e){hideLoader(),console.log(e.message)})}function g(){switch(1==e.prefs.numAutoGen?(e.invoiceNo=e.prefs.invoiceNumber,e.disableInvNo=!0):(e.invoiceNo="",e.disableInvNo=!1),e.notes=e.prefs.notes,e.terms=e.prefs.terms,e.paymentTerms={terms:[{name:"Off",value:0},{name:"Due on Receipt",value:1},{name:"Net 7",value:7},{name:"Net 10",value:10},{name:"Net 30",value:30},{name:"Net 60",value:60},{name:"Net 90",value:90}],selectedTerm:{name:"Due on Receipt",value:1}},e.files=[],e.hasDueDate=!0,e.todayDate=new Date,e.calculateDueDate(),e.subTotalStr=u(0*U.exchangeRate,U.currencySymbol,2),e.prefs.discountType){case 0:e.itemLevelTax=!1,e.invoiceLevelTax=!1;break;case 1:e.itemLevelTax=!0,e.invoiceLevelTax=!1;break;case 2:case 3:e.itemLevelTax=!1,e.invoiceLevelTax=!0,e.discountStr=u(0*U.exchangeRate,U.currencySymbol,2)}e.prefs.shipCharges&&(e.showShippingCharges=!0,e.shippingChargesStr=u(0*U.exchangeRate,U.currencySymbol,2)),e.prefs.adjustments&&(e.showAdjustments=!0,e.adjustmentsStr=u(0*U.exchangeRate,U.currencySymbol,2)),e.prefs.salesPerson&&(e.showSalesPerson=!0);var n={create:!0,entity:{rate:0,title:"Misc. Item"}};e.invoiceItems=[{selectedItem:n,selectedTax:void 0,rate:0,quantity:1,discount:0,amount:0}];var s=t.params.customerId;s&&(e.selectedCustomer=e.customers.filter(function(e){return e.entity.id==s})[0],L()),hideLoader()}function v(){var t={userID:S,organization:k,customer:e.selectedCustomer.entity,invoiceDate:e.todayDate,invoiceNumber:e.invoiceNo,status:"Draft",discountType:e.prefs.discountType,discounts:e.discount,shippingCharges:e.shippingCharges,adjustments:e.adjustments,subTotal:Number(e.subTotal),total:Number(e.total),balanceDue:Number(e.total),poNumber:e.poNumber,salesPerson:e.salesPerson,notes:e.notes,terms:e.terms,paymentTerms:"Due on Receipt"};t.dueDate=new Date;var n=e.selectedCustomer.entity.email;if(n&&(t.customerEmails=[n]),1==e.invoiceItems.length){a={create:!0,entity:{rate:e.invoiceItems[0].amount,title:"Misc. Item"}};e.invoiceItems[0].selectedItem=a}else for(var s=0;s<e.invoiceItems.length;s++){var a={create:!0,entity:{rate:e.invoiceItems[s].amount,title:"Misc. Item "+(s+1)}};e.invoiceItems[s].selectedItem=a}return i.createNewInvoice(t,e.invoiceItems,e.userRole,e.files).then(function(t){return i.copyInInvoiceInfo(t).then(function(n){return e.invoiceInfo=n,t})})}function b(){return v().then(function(t){return i.createInvoiceReceipt(t.id,e.invoiceInfo.id).then(function(e){return e.set("status","Sent"),e.save(),x(e),e})})}function x(t){e.contacts.forEach(function(e){e.selected&&i.sendInvoiceReceiptToEmail(t,e.contact).then(function(n){T("Invoice emailed to "+e.contact,!0,t)})}),e.mobileContacts.forEach(function(e){e.selected&&i.sendInvoiceTextToNumber(t,e.contact).then(function(n){T("Invoice texted to "+e.contact,!0,t)})})}function C(){$("#addInvoiceForm").validate().showErrors({invoiceNumber:"Invoice with this number already exists"})}function w(){f();var e=$("#addInvoiceForm").valid(),t=$("#itemInfoForm").valid(),n=$("#extrasForm").valid();if(e&&t&&n)return!0;var s=void 0;e?t?n||(s=$("#extrasForm").validate()):s=$("#itemInfoForm").validate():s=$("#addInvoiceForm").validate();var a=$(s.errorList[0].element).offset().top-30;return scrollToOffset(a),!1}function T(e,t,n){var a={userID:S,organization:k,name:S.get("username"),date:new Date,isAutomaticallyGenerated:t,comment:e};if(S.get("isTrackUsage")||!t){var i={};return s.when(o.getUserRole(S)).then(function(e){return r.createNewComment(a,e)}).then(function(e){i.commentObj=e;var t=n.get("comments");return t?t.push(e):t=[e],n.set("comments",t),n.save()}).then(function(e){return e})}}function D(){w()&&(showLoader(),s.when(i.checkInvoiceNumAvailable({invoiceNumber:e.invoiceNo,organization:k})).then(function(e){return e?b():(C(),scrollToOffset(),Promise.reject("Invoice with this number already exists"))}).then(function(e){T("Invoice created for "+u(e.attributes.balanceDue,"$",2)+" amount",!0,e).then(function(e){hideLoader(),t.go("dashboard.sales.invoices.details",{invoiceId:e.id})})},function(e){hideLoader(),console.log(e)}))}function N(){var t=e.invoiceItems,n=0,s=0;e.itemTaxes=[],t.forEach(function(e){n+=e.amount*(.01*(100-e.discount)),e.taxValue=calculateTax(e.amount,e.selectedTax),s+=e.taxValue}),e.totalTax=s,e.subTotal=n,e.subTotalStr=u(n*U.exchangeRate,U.currencySymbol,2),e.reCalculateTotal()}function I(){e.items.pop();var t=e.selectedCustomer.entity.get("paymentTerms");return t?e.paymentTerms.terms.forEach(function(n){n.name==t&&(e.paymentTerms.selectedTerm=n)}):e.paymentTerms.selectedTerm={name:"Due on Receipt",value:1},e.hasDueDate=!0,e.calculateDueDate(),s.when(l.getCustomerExpenses({organization:k,customer:e.selectedCustomer.entity})).then(function(t){for(var n=[],s=0;s<t.length;++s)if("Yes"==t[s].entity.get("billable"))for(var a=0;a<e.expenseItems.length;++a)t[s].entity.id==e.expenseItems[a].entity.expanseId&&n.push(e.expenseItems[a]);for(var i=[],s=0;s<t.length;++s)if("No"!=t[s].entity.get("billable")){var o=t[s].entity;n.some(function(e){return o.category==e.entity.title&&o.amount==Number(e.entity.rate)})||i.push({create:!0,tax:o.tax,entity:{title:o.category,rate:String(o.amount),expanseId:o.id}})}var r=e.actualItems.concat(n,i);return e.invoiceItems=e.invoiceItems.filter(function(e){return!(!e.selectedItem||e.selectedItem.create)&&r.some(function(t){return t.entity.id==e.selectedItem.entity.id})}),r.push(createItemOpener),e.items=r})}function L(){e.selectedCustomer.dummy?t.go("dashboard.customers.new",{backLink:t.current.name}):(showLoader(),s.when(I()).then(function(){e.invoiceItems.length<1?(e.addInvoiceItem(),e.totalTax=0,e.subTotal=0,e.subTotalStr=u(0*U.exchangeRate,U.currencySymbol,2),e.reCalculateTotal()):N(),hideLoader()}))}function P(e){if(-1!==(e=e.split(",").join("")).indexOf(".")){for(;/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");3==e.length-e.indexOf(".")&&$(".add_item_price").attr("maxlength",e.length)}else for($(".add_item_price").attr("maxlength",50);/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}if(a.entity.length){var U=a.entity[0].currency.attributes;if(U.exchangeRate)e.currentCurrency=U;else{var F={currencySymbol:"$",exchangeRate:1};e.currentCurrency=F,U=F}var S=a.entity[0],k=S.get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),s.when(a.entity[0].currency.fetch()).then(function(t){if((U=t.attributes).exchangeRate)e.currentCurrency=U;else{var n={currencySymbol:"$",exchangeRate:1};e.currentCurrency=n,U=n}y()}),$("#addInvoiceForm").validate({onkeyup:function(e){$(e).valid()},rules:{customer:"required"},messages:{customer:"Please select a customer"}}),$("#itemInfoForm").validate(),e.save=function(){w()&&(showLoader(),s.when(i.checkInvoiceNumAvailable({invoiceNumber:e.invoiceNo,organization:k})).then(function(e){return e?v():(C(),scrollToOffset(),Promise.reject("Invoice with this number already exists"))}).then(function(e){T("Invoice created for "+u(e.attributes.balanceDue,"$",2)+" amount",!0,e).then(function(e){hideLoader(),t.go("dashboard.sales.invoices.details",{invoiceId:e.id})})},function(e){hideLoader(),console.log(e)}))},e.saveAndSend=function(){if(w()){var t=e.selectedCustomer.entity.get("contactPersons");e.contacts=[],e.mobileContacts=[],t.length&&t.forEach(function(t){var n=t.get("firstname")?t.get("firstname"):"",s=t.get("lastname")?t.get("lastname"):"",a=1==t.get("defaultPerson"),i=n+" "+s;t.get("email")&&e.contacts.push({selected:a,contact:t.get("email"),contactName:"("+i+") "+t.get("email")}),t.get("phone")&&e.mobileContacts.push({selected:!1,contact:t.get("phone"),contactName:"("+i+") "+t.get("phone")}),t.get("mobile")&&e.mobileContacts.push({selected:a,contact:t.get("mobile"),contactName:"("+i+") "+t.get("mobile")})}),e.contacts.length||e.mobileContacts.length?$(".email-text").addClass("show"):ShowMessage("The customer does not have a email or phone number in their profile. Please select save.","error")}},e.sendReceipt=function(){var t=0,n=0;e.contacts.forEach(function(e){e.selected&&t++}),e.mobileContacts.forEach(function(e){e.selected&&n++}),t>0||n>0?D():$("#emailText-error").show()},e.cancel=function(){t.go("dashboard.sales.invoices.all")},e.calculateDueDate=function(){var t=new Date(e.todayDate);t.setHours(0),1!=e.paymentTerms.selectedTerm.value&&(t=t.addDays(e.paymentTerms.selectedTerm.value)),e.dueDate=t},e.addInvoiceItem=function(){e.invoiceItems.push({selectedItem:void 0,selectedTax:void 0,rate:0,quantity:1,discount:0,taxValue:0,amount:0})},e.reCalculateTotal=function(){var t=Number(e.subTotal)||0,n=Number(e.discount)||0,s=Number(e.shippingCharges)||0,a=Number(e.adjustments)||0,i=Number(e.totalTax)||0,o=t+i,r=.01*(100-n);2==e.prefs.discountType?o=t*r+i:3==e.prefs.discountType&&(o=(t+i)*r),n=Math.abs(o-t-i),e.total=o+s+a,e.discountStr=u(n*U.exchangeRate,U.currencySymbol,2),e.shippingChargesStr=u(s*U.exchangeRate,U.currencySymbol,2),e.adjustmentsStr=u(a*U.exchangeRate,U.currencySymbol,2),e.totalStr=u(e.total*U.exchangeRate,U.currencySymbol,2)},e.reCalculateSubTotal=N,e.reCalculateItemAmount=function(t){var n=e.invoiceItems[t];n.amount=n.rate*n.quantity,N()},e.removeInvoiceItem=function(t){e.invoiceItems.length>1?(e.invoiceItems.splice(t,1),N()):console.log("there should be atleast 1 item in an invoice")},e.itemChanged=function(t){console.log("item changed");var n=e.invoiceItems[t];if(n.selectedItem.dummy)return n.selectedItem=null,$(".new-item").addClass("show"),e.itemChangedIndex=t,void e.prepareCreateItem();n.rate=Number(n.selectedItem.entity.rate);var s=n.selectedItem.tax;if(s){for(var a=e.taxes,i=0;i<a.length;++i)if(s.id==a[i].id){n.selectedTax=a[i];break}}else n.selectedTax="";e.reCalculateItemAmount(t)},e.customerChanged=L,e.prepareCreateItem=function(){p.prepareCreateItem({_scope:e})},e.createNewItem=function(){p.createNewItem({_scope:e,user:S,organization:k})},$(".add_item_price").keyup(function(){$(this).val(P($(this).val()))})}else console.log("User not logged in")}]),invoicesUnlimited.controller("AppPreferencesController",["$scope","$state","$controller","userFactory","businessFactory",function(e,t,n,s,a){var i=s;if(n("DashboardController",{$scope:e,$state:t}),i.entity[0].get("colorTheme")){var o=i.entity[0].get("colorTheme");o&&(o=o.replace(/app|Color/g,"").toLowerCase()),o&&$(".colors li a."+o).parent().addClass("active")}if(!e.userLogo){var r=s.entity[0].get("selectedOrganization");new Parse.Query("Organization").get(r.id,{success:function(t){e.org=t;var n=t.get("logo");e.userLogo=n?n._url:"./assets/images/user-icon.png",e.$$phase||e.$apply()},error:function(e,t){}})}hideLoader(),fromTutorial?$(".tutorial").show():$(".tutorial").hide(),e.openingScreens=["Dashboard","Customer List","Invoices List","Expense List","Estimate List","Credit Notes List","Reports","Settings"],e.selectedScreen=i.entity[0].get("firstScreen"),i.entity[0].get("isTrackUsage")&&(e.trackUsage=!0),e.showConfirmationPopUp=function(){$(".confirmation-pop-up").addClass("show")},e.saveAppPreferences=function(){showLoader();var n=$(".colors li.active").find("a").attr("class"),a="app"+n[0].toUpperCase()+n.slice(1)+"Color";s.save({colorTheme:a,firstScreen:e.selectedScreen,isTrackUsage:e.trackUsage?1:0}).then(function(){hideLoader(),fromTutorial?t.go("dashboard.settings.taxes"):(showSnackbar("Save Successful. Reloading page in 3 sec..."),setTimeout(function(){window.location.reload()},2e3),hideLoader())})},e.nextClicked=function(){$(".tutorial").hide()}}]),$(document).ready(function(){$.validator.addMethod("ConfirmPasswordMatch",function(e,t){return e==$("input[name='newPassword']").val()},""),$.validator.addMethod("UserNameExists",function(e,t){return!parseInt($("#username-exists").val())},"")}),invoicesUnlimited.controller("CompanyProfileController",["$scope","$state","$controller","userFactory","organizationFactory","businessFactory","$q",function(e,t,n,s,a,i,o){function r(e){return"."+e.split(".").pop()}if(s.entity.length){if($("#businessInfoForm").validate({onkeyup:function(e){$(e).valid()},onfocusout:!1,rules:{businessName:{required:!0},streetName:{required:!0},city:{required:!0},state:{required:!0},zipCode:{required:!0,minlength:5,digits:!0},country:{required:!0},phone:{required:!0}},messages:{businessName:{required:"Please enter business name"},streetName:{required:"Please enter street name"},city:{required:"Please enter city"},state:{required:"Please enter state"},zipCode:{required:"Please enter zip code",minlength:"Please enter valid zip code",digits:"Please enter valid zip code"},country:{required:"Please enter country"},phone:{required:"Please enter phone"}}}),$("#phoneForm").validate({onkeyup:function(e){$(e).valid()},onfocusout:!1,rules:{phoneNumber:{required:!0}},messages:{phoneNumber:{required:"Please enter Phone Number"}}}),$(".phone").mask("(999) 999-9999"),e.userLogo)e.tempLogo=e.userLogo;else{var c=s.entity[0].get("selectedOrganization");new Parse.Query("Organization").get(c.id,{success:function(t){e.org=t;var n=t.get("logo");n?(e.userLogo=n._url,e.tempLogo=n._url):(e.userLogo="./assets/images/user-icon.png",e.tempLogo=void 0),e.$$phase||e.$apply()},error:function(e,t){}})}var l=s.entity[0];l.get("organizations")[0];l?loadColorTheme(l):t.go("login"),n("DashboardController",{$scope:e,$state:t}),hideLoader(),l.get("EPNusername")&&l.get("EPNrestrictKey")&&l.get("merchantID")?e.enableBusinessInfo=!1:e.enableBusinessInfo=!0,e.removeLogo=function(){e.isDeleteLogo=!0,e.tempLogo=void 0,e.$apply()},e.saveAppPreferences=function(){var e=$(".colors li.active").find("a").attr("class"),t="app"+e[0].toUpperCase()+e.slice(1)+"Color";s.save({colorTheme:t}).then(function(){window.location.reload()})},e.addNewLogo=function(t){var n=t.files[0].name;if(n.endsWith(".png")||n.endsWith(".jpg")||n.endsWith(".jpeg")||n.endsWith(".PNG")||n.endsWith(".JPG")||n.endsWith(".JPEG")){var s=new FileReader;s.onload=function(t){e.tempLogo=t.target.result,e.$apply()},s.readAsDataURL(t.files[0]),e.newLogo=t.files[0]}else ShowMessage("Invalid file format!","error")},e.saveBusiness=function(){if(e.enableBusinessInfo){if(!$("#businessInfoForm").valid())return}else if(!$("#phoneForm").valid())return;showLoader();var t=[];if(t.push(e.businessInfo.save()),e.newLogo){var n=new Parse.File("logo"+r(e.newLogo.name),e.newLogo);t.push(n.save().then(function(t){e.org.set("logo",t),e.org.save().then(function(t){var n=t.get("logo");return e.userLogo=n._url,e.tempLogo=n._url,Promise.Resolve("")})}))}else e.isDeleteLogo&&(e.org.unset("logo"),t.push(e.org.save()));o.all(t).then(function(){hideLoader(),showSnackbar("Save Successful. Reloading page in 3 sec..."),setTimeout(function(){window.location.reload()},2e3)})}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CreditNoteSettingsController",["$q","$scope","$state","$controller","userFactory","creditNoteService",function(e,t,n,s,a,i){if(a.entity.length){var o=a.entity[0];s("DashboardController",{$scope:t,$state:n}),showLoader(),e.when(i.getPreferences(o)).then(function(e){t.prefs=e,console.log(e),t.creditAg=1==e.numAutoGen?"yes":"no",t.notes=e.notes,t.terms=e.terms;var n=e.creditNumber.split("-");t.prefix=n[0],t.nxtNumber=n[1],hideLoader()},function(e){hideLoader(),console.log(e.message)}),$("#settingsForm").validate({rules:{prefix:"required",nextNumber:{required:!0,digits:!0,min:1}}}),t.save=function(){if($("#settingsForm").valid()){showLoader();var s={creditAg:"yes"==t.creditAg?1:0,notes:t.notes,terms:t.terms};"yes"==t.creditAg&&(s.creditNumber=[t.prefix,t.nxtNumber].join("-")),e.when(i.setPreferences(o,s)).then(function(){showSnackbar("Save Successful. Reloading page in 3 sec..."),setTimeout(function(){n.reload()},2e3),hideLoader()},function(e){console.log(e.message),hideLoader()})}else{var a=$("#settingsForm").validate(),r=$(a.errorList[0].element).offset().top-30;scrollToOffset(r)}}}else console.log("User not logged in")}]),invoicesUnlimited.controller("CurrencyController",["$q","$scope","$state","$controller","userFactory","currencyFactory","coreFactory",function(e,t,n,s,a,i,o){function r(){e.when(i.loadAll({organization:d})).then(function(e){t.currencies=e,c(),hideLoader(),t.displayedCurrencies=e})}function c(){var e=l.get("currency");t.defaultCurrencyIndex=t.currencies.findIndex(function(t){return t.entity.id==e.id})}if(!a.entity.length)return console.log("User not logged in"),void n.go("login");var l=void 0,d=void 0;s("DashboardController",{$scope:t,$state:n}),e.when(a.entity[0].fetch()).then(function(e){d=(l=e).get("organizations")[0],r()}),t.availableCurrencies=["ADP - Andorran Peseta","AED - United Arab Emirates Dirham","AFN - Afghan Afghani","ALL - Albanian Lek","AMD - Armenian Dram","ANG - Netherlands Antillean Guilder","AOA - Angolan Kwanza","ARA - Argentine Austral","ARS - Argentine Peso","ATS - Austrian Schilling","AUD - Australian Dollar","AWG - Aruban Florin","AZN - Azerbaijani Manat","BAM - Bosnia-Herzegovina Convertible Mark","BBD - Barbadian Dollar","BDT - Bangladeshi Taka","BEC - Belgian Franc (convertible)","BEF - Belgian Franc","BEL - Belgian Franc (financial)","BGL - Bulgarian Hard Lev","BGM - Bulgarian Socialist Lev","BGN - Bulgarian Lev","BHD - Bahraini Dinar","BIF - Burundian Franc","BMD - Bermudan Dollar","BND - Brunei Dollar","BOB - Bolivian Boliviano","BOP - Bolivian Peso","BOV - Bolivian Mvdol","BRL - Brazilian Real","BSD - Bahamian Dollar","BTN - Bhutanese Ngultrum","BUK - Burmese Kyat","BWP - Botswanan Pula","BYR - Belarusian Ruble","BZD - Belize Dollar","CAD - Canadian Dollar","CDF - Congolese Franc","CHE - WIR Euro","CHF - Swiss Franc","CHW - WIR Franc","CLE - Chilean Escudo","CLF - Chilean Unit of Account (UF)","CLP - Chilean Peso","CNX - Chinese People’s Bank Dollar","CNY - Chinese Yuan","COP - Colombian Peso","COU - Colombian Real Value Unit","CRC - Costa Rican Colón","CSK - Czechoslovak Hard Koruna","CUC - Cuban Convertible Peso","CUP - Cuban Peso","CVE - Cape Verdean Escudo","CYP - Cypriot Pound","CZK - Czech Republic Koruna","DDM - East German Mark","DEM - German Mark","DJF - Djiboutian Franc","DKK - Danish Krone","DOP - Dominican Peso","DZD - Algerian Dinar","ECS - Ecuadorian Sucre","ECV - Ecuadorian Unit of Constant Value","EEK - Estonian Kroon","EGP - Egyptian Pound","ERN - Eritrean Nakfa","ESA - Spanish Peseta (A account)","ESB - Spanish Peseta (convertible account)","ESP - Spanish Peseta","ETB - Ethiopian Birr","EUR - Euro","FIM - Finnish Markka","FJD - Fijian Dollar","FKP - Falkland Islands Pound","FRF - French Franc","GBP - British Pound","GEK - Georgian Kupon Larit","GEL - Georgian Lari","GHS - Ghanaian Cedi","GIP - Gibraltar Pound","GMD - Gambian Dalasi","GNF - Guinean Franc","GNS - Guinean Syli","GQE - Equatorial Guinean Ekwele","GRD - Greek Drachma","GTQ - Guatemalan Quetzal","GWE - Portuguese Guinea Escudo","GWP - Guinea-Bissau Peso","GYD - Guyanaese Dollar","HKD - Hong Kong Dollar","HNL - Honduran Lempira","HRD - Croatian Dinar","HRK - Croatian Kuna","HTG - Haitian Gourde","HUF - Hungarian Forint","IDR - Indonesian Rupiah","IEP - Irish Pound","ILP - Israeli Pound","ILS - Israeli New Sheqel","INR - Indian Rupee","IQD - Iraqi Dinar","IRR - Iranian Rial","ISK - Icelandic Króna","ITL - Italian Lira","JMD - Jamaican Dollar","JOD - Jordanian Dinar","JPY - Japanese Yen","KES - Kenyan Shilling","KGS - Kyrgystani Som","KHR - Cambodian Riel","KMF - Comorian Franc","KPW - North Korean Won","KRW - South Korean Won","KWD - Kuwaiti Dinar","KYD - Cayman Islands Dollar","KZT - Kazakhstani Tenge","LAK - Laotian Kip","LBP - Lebanese Pound","LKR - Sri Lankan Rupee","LRD - Liberian Dollar","LSL - Lesotho Loti","LTL - Lithuanian Litas","LTT - Lithuanian Talonas","LUC - Luxembourgian Convertible Franc","LUF - Luxembourgian Franc","LUL - Luxembourg Financial Franc","LVL - Latvian Lats","LVR - Latvian Ruble","LYD - Libyan Dinar","MAD - Moroccan Dirham","MAF - Moroccan Franc","MCF - Monegasque Franc","MDC - Moldovan Cupon","MDL - Moldovan Leu","MGA - Malagasy Ariary","MGF - Malagasy Franc","MKD - Macedonian Denar","MLF - Malian Franc","MMK - Myanmar Kyat","MNT - Mongolian Tugrik","MOP - Macanese Pataca","MRO - Mauritanian Ouguiya","MTL - Maltese Lira","MTP - Maltese Pound","MUR - Mauritian Rupee","MVR - Maldivian Rufiyaa","MWK - Malawian Kwacha","MXN - Mexican Peso","MXV - Mexican Investment Unit","MYR - Malaysian Ringgit","MZE - Mozambican Escudo","MZN - Mozambican Metical","NAD - Namibian Dollar","NGN - Nigerian Naira","NIO - Nicaraguan Córdoba","NLG - Dutch Guilder","NOK - Norwegian Krone","NPR - Nepalese Rupee","NZD - New Zealand Dollar","OMR - Omani Rial","PAB - Panamanian Balboa","PEI - Peruvian Inti","PEN - Peruvian Nuevo Sol","PGK - Papua New Guinean Kina","PHP - Philippine Peso","PKR - Pakistani Rupee","PLN - Polish Zloty","PTE - Portuguese Escudo","PYG - Paraguayan Guarani","QAR - Qatari Rial","RHD - Rhodesian Dollar","RON - Romanian Leu","RSD - Serbian Dinar","RUB - Russian Ruble","RWF - Rwandan Franc","SAR - Saudi Riyal","SBD - Solomon Islands Dollar","SCR - Seychellois Rupee","SDG - Sudanese Pound","SEK - Swedish Krona","SGD - Singapore Dollar","SHP - St. Helena Pound","SIT - Slovenian Tolar","SKK - Slovak Koruna","SLL - Sierra Leonean Leone","SOS - Somali Shilling","SRD - Surinamese Dollar","SRG - Surinamese Guilder","SSP - South Sudanese Pound","STD - São Tomé & Príncipe Dobra","SUR - Soviet Rouble","SVC - Salvadoran Colón","SYP - Syrian Pound","SZL - Swazi Lilangeni","THB - Thai Baht","TJR - Tajikistani Ruble","TJS - Tajikistani Somoni","TMT - Turkmenistani Manat","TND - Tunisian Dinar","TOP - Tongan Paʻanga","TPE - Timorese Escudo","TRY - Turkish Lira","TTD - Trinidad & Tobago Dollar","TWD - New Taiwan Dollar","TZS - Tanzanian Shilling","UAH - Ukrainian Hryvnia","UAK - Ukrainian Karbovanets","UGX - Ugandan Shilling","USD - US Dollar","USN - US Dollar (Next day)","USS - US Dollar (Same day)","UYI - Uruguayan Peso (Indexed Units)","UYU - Uruguayan Peso","UZS - Uzbekistani Som","VEF - Venezuelan Bolívar","VND - Vietnamese Dong","VUV - Vanuatu Vatu","WST - Samoan Tala","XAF - Central African CFA Franc","XAG - Silver","XAU - Gold","XBA - European Composite Unit","XBB - European Monetary Unit","XBC - European Unit of Account (XBC)","XBD - European Unit of Account (XBD)","XCD - East Caribbean Dollar","XDR - Special Drawing Rights","XEU - European Currency Unit","XFO - French Gold Franc","XFU - French UIC-Franc","XOF - West African CFA Franc","XPD - Palladium","XPF - CFP Franc","XPT - Platinum","XRE - RINET Funds","XSU - Sucre","XTS - Testing Currency Code","XUA - ADB Unit of Account","XXX - Unknown Currency","YDD - Yemeni Dinar","YER - Yemeni Rial","ZAL - South African Rand (financial)","ZAR - South African Rand","ZMW - Zambian Kwacha"],t.prepareAddCurrency=function(){t.currencyObj={title:void 0,currencySymbol:void 0,decimalPlace:"2",format:"###,###,###",exchangeRate:void 0},$("#addCurrencyForm").validate({rules:{currencyCode:"required",currencySymbol:"required",exchangeRate:{number:!0,min:0,required:!0}}}),$("#addCurrencyForm").validate().resetForm()},t.prepareEditCurrency=function(e){var n=t.currencies[e].entity;t.selectedIndex=e,t.currencyObj={title:n.title,currencySymbol:n.currencySymbol,decimalPlace:n.decimalPlace+"",format:n.format,exchangeRate:n.exchangeRate},$(".edit-currency").addClass("show"),$("#editCurrencyForm").validate({rules:{currencyCode:"required",currencySymbol:"required",exchangeRate:{number:!0,min:0}}}),$("#editCurrencyForm").validate().resetForm()},t.saveNewCurrency=function(){if($("#addCurrencyForm").valid()){showLoader();var n=t.currencyObj;n.userID=l,n.organization=d,n.decimalPlace=Number(n.decimalPlace),n.exchangeRate=Number(n.exchangeRate)||void 0,e.when(o.getUserRole(l)).then(function(e){return i.createNewCurrency(n,e)}).then(function(e){t.currencies.push(e),$(".new-currency").removeClass("show"),hideLoader()})}},t.saveEditedCurrency=function(){if($("#editCurrencyForm").valid()){showLoader();var n=t.currencies[t.selectedIndex].entity,s=t.currencyObj;s.decimalPlace=Number(s.decimalPlace),s.exchangeRate=Number(s.exchangeRate)||void 0,["title","currencySymbol","decimalPlace","format"].forEach(function(e){n.set(e,s[e])}),s.exchangeRate?n.set("exchangeRate",s.exchangeRate):n.unset("exchangeRate"),e.when(i.saveEditedCurrency(n)).then(function(e){t.currencies[t.selectedIndex]=e,$(".edit-currency").removeClass("show"),hideLoader()})}},t.setDefaultCurrency=function(){if(t.currencies[t.selectedIndex].entity.exchangeRate){showLoader();var n=t.currencies[t.selectedIndex].entity;l.set("currency",n),e.when(l.save()).then(function(){c(),$(".edit-currency").removeClass("show"),hideLoader()})}else $(".add-exchangeRate").addClass("show")},t.deleteCurrency=function(){if(t.selectedIndex!=t.defaultCurrencyIndex){showLoader();var n=t.currencies.splice(t.selectedIndex,1)[0];e.when(n.entity.destroy()).then(function(){c(),$(".edit-currency").removeClass("show"),hideLoader()})}else $(".cannot-delete").addClass("show")},t.deleteCurrencyClicked=function(e){e!=t.defaultCurrencyIndex?(t.selectedIndex=e,$(".delete-currency").addClass("show")):$(".cannot-delete").addClass("show")},t.confirmDeleteCurrency=function(){if(t.selectedIndex!=t.defaultCurrencyIndex){showLoader();var n=t.currencies.splice(t.selectedIndex,1)[0];e.when(n.entity.destroy()).then(function(){c(),$(".delete-currency").removeClass("show"),hideLoader()})}else $(".cannot-delete").addClass("show")},t.currencyChanged=function(){t.currencyObj&&(t.currencyObj.currencySymbol=t.currencyObj.title.split(" ")[0])},t.search=function(){t.searchText.length?t.currencies=t.displayedCurrencies.filter(function(e){return e.entity.title||(e.entity.title=""),e.entity.currencySymbol||(e.entity.currencySymbol=""),e.entity.exchangeRate||(e.entity.exchangeRate=""),e.entity.title.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.currencySymbol.toLowerCase().includes(t.searchText.toLowerCase())||e.entity.exchangeRate.toString().toLowerCase().includes(t.searchText.toLowerCase())}):t.currencies=t.displayedCurrencies}}]),invoicesUnlimited.controller("EstimateSettingsController",["$q","$scope","$state","$controller","userFactory","estimateService",function(e,t,n,s,a,i){function o(){$(".check-name").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please provide field name"}})})}if(a.entity.length){var r=a.entity[0];s("DashboardController",{$scope:t,$state:n}),showLoader(),e.when(i.getPreferences(r)).then(function(e){t.prefs=e,console.log(e),t.estimateAg=1==e.numAutoGen?"yes":"no",t.notes=e.notes,t.terms=e.terms;var n=e.estimateNumber.split("-");t.prefix=n[0],t.nxtNumber=n[1],t.customFields=e.customFields||[],t.customFields.forEach(function(e){e.checked="YES"==e.isChecked}),hideLoader()},function(e){hideLoader(),console.log(e.message)}),$("#settingsForm").validate({rules:{prefix:"required",nextNumber:{required:!0,digits:!0,min:1}}}),t.removeField=function(e){t.customFields.length>0&&t.customFields.splice(e,1)},t.addField=function(){t.customFields.push({name:"",isChecked:"",checked:!1})},t.save=function(){if(o(),$("#settingsForm").valid()){showLoader();var s={estimateAg:"yes"==t.estimateAg?1:0,notes:t.notes,terms:t.terms};"yes"==t.estimateAg&&(s.estimateNumber=[t.prefix,t.nxtNumber].join("-"));var a=[];t.customFields.forEach(function(e){e.isChecked=e.checked?"YES":"NO",delete e.checked,a.push({isChecked:e.isChecked,name:e.name})}),s.customFields=a,e.when(i.setPreferences(r,s)).then(function(){showSnackbar("Save Successful. Reloading page in 3 sec..."),setTimeout(function(){n.reload()},2e3),hideLoader()},function(e){console.log(e.message),hideLoader()})}else{var c=$("#settingsForm").validate(),l=$(c.errorList[0].element).offset().top-30;scrollToOffset(l)}}}else console.log("User not logged in")}]),invoicesUnlimited.controller("InvoiceSettingsController",["$q","$scope","$state","$controller","userFactory","invoiceService","coreFactory","lateFeeService",function(e,t,n,s,a,i,o,r){function c(){$(".check-name").each(function(){$(this).rules("remove"),$(this).rules("add",{required:!0,messages:{required:"Please provide field name"}})})}function l(e){var t=e.entity;return t.name+" "+t.price+" ("+t.type+")"}if(a.entity.length){var d=a.entity[0],u=d.get("organizations")[0];s("DashboardController",{$scope:t,$state:n}),function(){showLoader();var n=e.when(r.getAllLateFees({organization:u}));e.when(i.getPreferences(d)).then(function(e){t.prefs=e,t.invoiceAg=1==e.numAutoGen?"yes":"no",t.shipCharges=1==e.shipCharges?"yes":"no",t.adjustments=1==e.adjustments?"yes":"no",t.salesPerson=1==e.salesPerson?"yes":"no",t.itemDesc=1==e.itemDescOnInvoice?"yes":"no",t.invoiceNotification=1==d.get("getInvoiceNotification")?"yes":"no",t.notes=e.notes,t.terms=e.terms,t.showLateFee="no",t.invoiceThanksNotes=e.thanksNote,t.paymentConfirmation=e.thanksNote.length>0?"yes":"no";var s=e.invoiceNumber.split("-");switch(t.prefix=s[0],t.nxtNumber=s[1],t.customFields=e.customFields||[],t.customFields.forEach(function(e){e.checked="YES"==e.isChecked}),e.discountType){case 0:t.discounts="nodiscounts";break;case 1:t.discounts="atindividual";break;case 2:t.discounts="atinvoicelevel",t.discountPlace="before";break;case 3:t.discounts="atinvoicelevel",t.discountPlace="after"}return n}).then(function(e){t.lateFees=e,t.feeList=e.map(l),t.latefeeTypes=["%","$"],t.selectedFeeType="%",hideLoader()},function(e){hideLoader(),console.log(e.message)})}(),$("#settingsForm").validate({rules:{prefix:"required",nextNumber:{required:!0,digits:!0,min:1},discntplace:"required"}}),t.prepareAddFeeForm=function(){t.latefeeName="",t.selectedFeeType=t.latefeeTypes[0],t.latefeeAmount="",$("#addLateFeeForm").validate({rules:{name:"required",type:"required",amount:{required:!0,number:!0,min:.01}}}),$("#addLateFeeForm").validate().resetForm()},t.addLateFee=function(){if($("#addLateFeeForm").valid()){showLoader();var n={userID:d,organization:u,name:t.latefeeName,type:t.selectedFeeType,price:Number(t.latefeeAmount)};e.when(o.getUserRole(d)).then(function(e){return r.createLateFee(n,e)}).then(function(e){t.lateFees.push(e),t.feeList.push(l(e)),$(".add-latefee").removeClass("show"),hideLoader()})}},t.prepareEditFeeForm=function(){if(e=t.lateFees[t.feeList.indexOf(t.selectedFee)]){var e=e.entity;t.latefeeName=e.name,t.selectedFeeType=e.type,t.latefeeAmount=e.price,$("#editLateFeeForm").validate({rules:{name:"required",type:"required",amount:{required:!0,number:!0,min:.01}}}),$("#editLateFeeForm").validate().resetForm()}},t.updateLateFee=function(){var n=t.feeList.indexOf(t.selectedFee),s=t.lateFees[n];s&&$("#editLateFeeForm").valid()&&(showLoader(),(s=s.entity).set("name",t.latefeeName),s.set("type",t.selectedFeeType),s.set("price",Number(t.latefeeAmount)),e.when(r.updateLateFee(s)).then(function(e){t.lateFees[n]=e,t.feeList[n]=l(e),t.selectedFee=t.feeList[n],$(".edit-latefee").removeClass("show"),hideLoader()}))},t.removeField=function(e){t.customFields.length>0&&t.customFields.splice(e,1)},t.addField=function(){t.customFields.push({name:"",isChecked:"",checked:!1})},t.save=function(){if(c(),$("#settingsForm").valid()){showLoader();var s={invoiceAg:"yes"==t.invoiceAg?1:0,shipCharges:"yes"==t.shipCharges?1:0,adjustments:"yes"==t.adjustments?1:0,salesPerson:"yes"==t.salesPerson?1:0,itemDescOnInvoice:"yes"==t.itemDesc?1:0,notes:t.notes,terms:t.terms,thanksNote:"yes"==t.paymentConfirmation?t.invoiceThanksNotes:""};"yes"==t.invoiceAg&&(s.invoiceNumber=[t.prefix,t.nxtNumber].join("-"));var a=[];switch(t.customFields.forEach(function(e){e.isChecked=e.checked?"YES":"NO",delete e.checked,a.push({isChecked:e.isChecked,name:e.name})}),s.customFields=a,t.discounts){case"nodiscounts":s.discountType=0;break;case"atindividual":s.discountType=1;break;case"atinvoicelevel":s.discountType="before"==t.discountPlace?2:3}d.set("getInvoiceNotification","yes"==t.invoiceNotification?1:0),d.save(),e.when(i.setPreferences(d,s)).then(function(){console.log("invoice prefs updated."),showSnackbar("Save Successful. Reloading page in 3 sec..."),setTimeout(function(){n.reload()},2e3),hideLoader()},function(e){console.log(e.message),hideLoader()})}else{var o=$("#settingsForm").validate(),r=$(o.errorList[0].element).offset().top-30;scrollToOffset(r)}}}else console.log("User not logged in")}]),invoicesUnlimited.controller("ItemController",["$scope","$state","$controller","$q","userFactory","coreFactory","taxService","itemService",function(e,t,n,s,a,i,o,r){function c(e){if(-1!==(e=e.split(",").join("")).indexOf(".")){for(;/(\d+)(\d{2})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{2})/,"$1,$2");3==e.length-e.indexOf(".")&&$(".add_item_price").attr("maxlength",e.length)}else for($(".add_item_price").attr("maxlength",50);/(\d+)(\d{2})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{2})/,"$1,$2");return e}function l(e){if(-1!=e.indexOf("."))return 3==e.length-e.indexOf(".")&&$(".add_item_price").attr("maxlength",e.length),e;if((e=e.split(",").join("")).length>4){$(".add_item_price").attr("maxlength",50);var t=e.substring(e.length-4,e.length);return d(e.substring(0,e.length-4))+","+t}return e}function d(e){for(e=e.split(",").join("");/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}function u(e){if(-1!==(e=e.split(",").join("")).indexOf(".")){for(;/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");3==e.length-e.indexOf(".")&&$(".add_item_price").attr("maxlength",e.length)}else for($(".add_item_price").attr("maxlength",50);/(\d+)(\d{3})/.test(e.toString());)e=e.toString().replace(/(\d+)(\d{3})/,"$1,$2");return e}function m(){e.itemName="",e.itemRate1="",e.itemDesc="",e.itemTax=void 0}if(a.entity.length){var p=a.entity[0];e.currency=p.get("currency"),e.currencyFormat=e.currency.get("format");var f=p.get("organizations")[0];n("DashboardController",{$scope:e,$state:t}),initalizeModalClasses(),function(){showLoader();var t=void 0,n=[];t=s.when(i.getAllItems({organization:f})).then(function(t){e.items=t.filter(function(e){return!e.entity.expanseId&&e.entity.title.indexOf("Misc. Item")<0}),e.displayedItems=e.items}),n.push(t),t=o.getTaxes(p,function(t){e.taxes=t}),n.push(t),s.all(n).then(function(){hideLoader(),e.sortByItemName()},function(e){console.log(e.message),hideLoader()})}(),$.validator.addMethod("CheckNumber",function(e,t){return!(e.split(".").length>2)}),$("#addItemForm").validate({rules:{name:"required",rate:{required:!0,CheckNumber:!0}},messages:{name:"Please enter Item name",rate:{required:"Item rate is required",CheckNumber:"Please enter a valid price."}}}),$("#editItemForm").validate({rules:{name:"required",rate:{required:!0,CheckNumber:!0}},messages:{name:"Please enter Item name",rate:{required:"Item rate is required",CheckNumber:"Please enter a valid price."}}}),$(".add_item_price").keyup(function(){"#,###,####"==e.currencyFormat?$(this).val(l($(this).val())):"##,##,##,##"==e.currencyFormat?$(this).val(c($(this).val())):$(this).val(u($(this).val()))}),e.sortByItemName=function(){"none"===$("#name").css("display")?(e.items.sort(function(e,t){return e.entity.title.localeCompare(t.entity.title)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.items.sort(function(e,t){return t.entity.title.localeCompare(e.entity.title)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#price").css({display:"none"}),$("#description").css({display:"none"}),$("#priceUp").css({display:"none"}),$("#descriptionUp").css({display:"none"})},e.sortByPrice=function(){"none"===$("#price").css("display")?(e.items.sort(function(e,t){return t.entity.rate-e.entity.rate}),$("#price").css({display:"inline-table"}),$("#priceUp").css({display:"none"})):(e.items.sort(function(e,t){return e.entity.rate-t.entity.rate}),$("#priceUp").css({display:"inline-table"}),$("#price").css({display:"none"})),$("#name").css({display:"none"}),$("#description").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#descriptionUp").css({display:"none"})},e.sortByDescription=function(){"none"===$("#description").css("display")?(e.items.sort(function(e,t){return e.entity.itemDescription.localeCompare(t.entity.itemDescription)}),$("#description").css({display:"inline-table"}),$("#descriptionUp").css({display:"none"})):(e.items.sort(function(e,t){return t.entity.itemDescription.localeCompare(e.entity.itemDescription)}),$("#descriptionUp").css({display:"inline-table"}),$("#description").css({display:"none"})),$("#name").css({display:"none"}),$("#price").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#priceUp").css({display:"none"})},e.clearAddItemFields=function(){m(),$("#addItemForm").validate().resetForm()},e.showItemDetail=function(t){$("#editItemForm").validate().resetForm(),$(".edit-item").addClass("show");var n=e.items[t];if(e.confirmItem=n,e.itemIndex=t,e.itemName=n.entity.title,e.itemRate1=n.entity.rate,e.itemDesc=n.entity.itemDescription,e.itemTax=void 0,n.tax)for(var s=e.taxes,a=0;a<s.length;++a)if(n.tax.id==s[a].id){e.itemTax=s[a];break}},e.confirmDelete=function(t){var n=e.items[t];n&&(e.itemIndex=t,e.confirmItem=n,$(".confirm-delete").addClass("show"))},e.deleteIteminModal=function(){$(".confirm-delete").addClass("show")},e.deleteItem=function(n,s){n?(showLoader(),e.items[e.itemIndex].entity.set("isDeleted",1),e.items[e.itemIndex].entity.save().then(function(){$(".confirm-delete").removeClass("show"),hideLoader(),t.reload()})):$(".confirm-delete").removeClass("show")},e.saveNewItem=function(){if($("#addItemForm").valid()){showLoader();var n={user:p,organization:f,items:[{title:e.itemName,rate:e.itemRate1.split(",").join(""),tax:e.itemTax,desc:e.itemDesc}]};s.when(i.getUserRole(p)).then(function(e){var t=new Parse.ACL;return t.setPublicReadAccess(!0),t.setPublicWriteAccess(!0),n.acl=t,r.createItems(n)}).then(function(n){hideLoader(),fromTutorial?t.go("dashboard.customers.new"):(e.items.push(n[0]),$(".new-item").removeClass("show"))},function(e){$(".new-item").removeClass("show"),hideLoader(),console.log(e.message)})}},e.saveEditedItem=function(){if($("#editItemForm").valid()){var n=e.items[e.itemIndex];n&&(showLoader(),(n=n.entity).set("title",e.itemName),n.set("rate",e.itemRate1.split(",").join("")),n.set("itemDescription",e.itemDesc),e.itemTax?n.set("tax",Parse.Object.extend("Tax").createWithoutData(e.itemTax.id)):n.unset("tax"),n.save().then(function(){t.reload()},function(e){$(".edit-item").removeClass("show"),hideLoader(),console.log(e.message)}))}},e.nextClicked=function(){$(".tutorial").hide()},e.closeAddItem=function(){$(".new-item").removeClass("show")},fromTutorial?($(".tutorial").show(),m(),$("#addItemForm").validate().resetForm(),$(".new-item").addClass("show")):$(".tutorial").hide(),e.search=function(){e.searchText.length?e.items=e.displayedItems.filter(function(t){return t.entity.title||(t.entity.title=""),t.entity.rate||(t.entity.rate=""),t.entity.itemDescription||(t.entity.itemDescription=""),t.entity.title.toLowerCase().includes(e.searchText.toLowerCase())||t.entity.rate.toLowerCase().includes(e.searchText.toLowerCase())||t.entity.itemDescription.toLowerCase().includes(e.searchText.toLowerCase())}):e.items=e.displayedItems}}else console.log("User not logged in")}]),invoicesUnlimited.controller("PaymentsController",["$rootScope","$scope","$state","$controller","$q","userFactory","signUpFactory",function(e,t,n,s,a,i,o){if(i.entity.length){var r=i.entity[0];r.get("organizations")[0];if(s("DashboardController",{$scope:t,$state:n}),o.setDefaultValues(),!t.userLogo){var c=i.entity[0].get("selectedOrganization");new Parse.Query("Organization").get(c.id,{success:function(e){t.org=e;var n=e.get("logo");t.userLogo=n?n._url:"./assets/images/user-icon.png",t.$$phase||t.$apply()},error:function(e,t){}})}var l="You have been approved to process credit cards.",d=r.get("businessInfo"),u=r.get("principalInfo"),m=r.get("accountInfo"),p=r.get("signatureImage"),f=r.get("merchantID");r.get("EPNusername"),r.get("EPNrestrictKey");f?(t.approved=!0,t.infoMsg=l,t.merchantID=f,t.businessName=r.get("company"),t.accountSupportNumber="(800) 554-4777",t.softwareSupportNumber="(888) 995-1840",t.email="support@invoicesunlimited.com"):d&&u&&m&&p?f?(t.approved=!0,t.infoMsg=l,t.merchantID=f,t.businessName=r.get("company"),t.accountSupportNumber="(800) 554-4777",t.softwareSupportNumber="(888) 995-1840",t.email="support@invoicesunlimited.com"):(t.processingRequest=!0,t.infoMsg="Your application has been submitted. Please wait two business days for the approval process. <br/>If you have not heard anything from us within two business days, please call or email us at:",t.phoneNumber="(800) 554-4777",t.email="support@invoicesunlimited.com"):(t.incompleteProfile=!0,t.infoMsg="You have not completed the merchant account application. Please click continue below to resume where you left off."),hideLoader(),t.sendEmail=function(){window.open("mailto:support@invoicesunlimited.com","_self")},t.continueProcess=function(){e.fromPaymentSettings=!0,d&&u?m?p||n.go("signup.signature"):n.go("signup.account-info"):n.go("signup.business-info")}}else console.log("User not logged in")}]),String.prototype.capitilize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},invoicesUnlimited.controller("SettingsController",["$q","$scope","$state","$controller","userFactory","coreFactory",function(e,t,n,s,a,i){function o(){console.log("xyzz"),t.users=[{name:d.get("username"),email:d.get("email"),role:d.get("role"),status:"Active",textClass:"text-positive"}],hideLoader()}function r(e){for(var t=[["dd","mm","yy"],["mm","dd","yy"],["yy","mm","dd"],["dd","mm","yyyy"],["mm","dd","yyyy"],["yyyy","mm","dd"]],n=["dd mmm yyyy","eee, mmmm dd, yyyy","eeee, mmmm dd, yyyy","mmm dd, yyyy","mmmm dd, yyyy","yyyy mm dd"],s=[],a=0;a<t.length;++a)s.push({format:t[a].join(e),formatExample:t[a].join(e)+" ("+f[a].join(e)+")"});for(a=0;a<n.length;++a)s.push({format:n[a],formatExample:n[a]+" ("+h[a]+")"});return s}function c(){showLoader(),t.timeZones={timeZones:["( PDT ) America/Los_Angeles ( Pacific Standard Time )","( GMT 5:00 ) Asia/Karachi ( Pakistan Standard Time )","( GMT 0:00 ) Dublin, Edinburgh, Lisbon, London ( Greenwich Mean Time )","( GMT -4:00 ) Canada ( Atlantic Standard Time )","( GMT -4:00 ) Santiago ( Pacific SA Standard Time )","( GMT -5:00 ) US & Canada ( Eastern Standard Time )","( GMT -5:00 ) Indiana (East) ( US Eastern Standard Time )","( GMT -6:00 ) ( Central America Standard Time )","( GMT -6:00 ) US & Canada ( Central Standard Time )","( GMT -7:00 ) US & Canada ( Mountain Standard Time )","( GMT -8:00 ) US & Canada ( Pacific Standard Time )","( GMT -9:00 ) ( Alaskan Standard Time )","( GMT -10:00 ) ( Hawaiian Standard Time )"],selectedTimeZone:""},t.months={months:["January","February","March","April","May","June","July","August","September","October","November","December"],selectedMonth:""},t.dateFormats={formats:[],selectedFormat:""},t.fieldSeparators={separators:["/",".",",","-"],selectedSeparator:""},e.when(i.getGeneralPrefs(d)).then(function(e){var n=e.get("timeZone"),s=e.get("fiscalYearStart"),a=e.get("dateFormat").toLowerCase(),i=e.get("fieldSeparator"),o=e.get("displayCountry");t.displayCountry=o?"yes":"no",t.timeZones.selectedTimeZone=t.timeZones.timeZones.filter(function(e){return e==n})[0],t.months.selectedMonth=t.months.months.filter(function(e){return e==s})[0],t.fieldSeparators.selectedSeparator=t.fieldSeparators.separators.filter(function(e){return e==i})[0],t.dateFormats.formats=r(t.fieldSeparators.selectedSeparator),t.dateFormats.selectedFormat=t.dateFormats.formats.filter(function(e){return e.format==a})[0],hideLoader()},function(e){hideLoader(),console.log(e.message)})}function l(){showLoader(),e.when(i.getInvoiceTemplates()).then(function(e){var n=d.get("defaultTemplate"),s=[];e.forEach(function(e){var t={entity:e,name:e.get("name"),url:e.get("templatePreview").url()};t.btnName="Set as Default",n||"Template 1"!=t.name?n&&(t.isDefault=n.id==e.id,t.isDefault?t.btnName="Default":t.btnName="Set as Default"):t.isDefault=!0,s.push(t)}),t.templates=s,hideLoader()},function(e){hideLoader(),console.log(e.message)})}if(!a.entity.length)return console.log("User not logged in"),void n.go("login");var d=a.entity[0],u=d.get("organizations")[0];if(s("DashboardController",{$scope:t,$state:n}),!t.userLogo){var m=a.entity[0].get("selectedOrganization");new Parse.Query("Organization").get(m.id,{success:function(e){t.org=e;var n=e.get("logo");t.userLogo=n?n._url:"./assets/images/user-icon.png",t.$$phase||t.$apply()},error:function(e,t){}})}var p={users:function(e){return e.endsWith("users")},general:function(e){return e.endsWith("general-preferences")},payments:function(e){return e.endsWith("payments")},templates:function(e){return e.endsWith("invoice-templates")}};!function(e){e||(e=n.current.name),p.users(e)?o():p.templates(e)?l():p.general(e)?c():hideLoader()}();var f=[["23","10","16"],["10","23","16"],["16","10","23"],["23","10","2016"],["10","23","2016"],["2016","10","23"]],h=["10 Oct 2016","Mon, October 23, 2016","Monday, October 23, 2016","Oct 23, 2016","October 23, 2016","2016 10 23"];t.dateSeperatorChanged=function(){var e=t.dateFormats.formats.indexOf(t.dateFormats.selectedFormat);t.dateFormats.formats=r(t.fieldSeparators.selectedSeparator),t.dateFormats.selectedFormat=t.dateFormats.formats[e]},t.setDefaultPrefs=function(){showLoader();var e=t.dateFormats.selectedFormat.format.split("m").join("M");e=e.split("e").join("E"),u.set("timeZone",t.timeZones.selectedTimeZone),u.set("fiscalYearStart",t.months.selectedMonth),u.set("dateFormat",e),u.set("fieldSeparator",t.fieldSeparators.selectedSeparator),u.set("displayCountry","yes"==t.displayCountry),u.save().then(function(){a.commonData={},hideLoader(),showSnackbar("Save Successful"),console.log("general preferences are saved.")},function(e){hideLoader(),console.log(e.message)})},t.setDefaultTemplate=function(e){showLoader(),t.templates.forEach(function(e){e.isDefault=!1,e.btnName="Set as Default"}),t.templates[e].isDefault=!0,t.templates[e].btnName="Default",d.set("defaultTemplate",t.templates[e].entity),d.save().then(function(){hideLoader(),showSnackbar("Save Successful")},function(e){hideLoader(),console.log(e,message)})}}]);var digitsOnly=/[1234567890]/g,integerOnly=/[0-9\.]/g,alphaOnly=/[A-Za-z]/g,usernameOnly=/[0-9A-Za-z\._-]/g;invoicesUnlimited.controller("TaxController",["$scope","$state","$controller","userFactory","taxService",function(e,t,n,s,a){function i(){e.taxId=0,e.taxName="",e.taxRate="",e.isCompound=!1}function o(){a.getTaxes(l,function(t){e.taxes=t,e.displayedTaxes=e.taxes,e.sortByTaxName()})}function r(){e.taxGroupId=0,e.taxGroupName="",e.taxesForGroup=[],e.shouldAdd=[],e.taxes.forEach(function(t){2!=t.type&&(e.taxesForGroup.push(t),e.shouldAdd.push(!1))})}function c(t){e.taxGroupId=t.id,e.taxGroupName=t.entity.get("title"),e.taxesForGroup=[],e.shouldAdd=[],e.taxes.forEach(function(t){2!=t.type&&(e.taxesForGroup.push(t),e.shouldAdd.push(!1))});for(var n=t.entity.get("associatedTaxes"),s=0;s<n.length;++s)for(var a=0;a<e.taxesForGroup.length;++a)n[s].id==e.taxesForGroup[a].id&&(e.shouldAdd[a]=!0)}if(s.entity.length){fromTutorial?($(".tutorial").show(),i(),$("#addTaxForm").validate().resetForm(),$(".new-tax").addClass("show")):$(".tutorial").hide();var l=s.entity[0];n("DashboardController",{$scope:e,$state:t}),o(),initalizeModalClasses(),i(),$("#addTaxForm").validate({rules:{name:"required",rate:{required:!0,number:!0}},messages:{name:"Please enter Tax name",rate:{required:"Tax percentage is required.",number:"Please enter a valid percentage."}}}),$("#addTaxGroupForm").validate({rules:{name:"required"},messages:{name:"Please enter Tax Group name"}}),$("#editTaxGroupForm").validate({rules:{name:"required"},messages:{name:"Please enter Tax Group name"}}),$("#editTaxForm").validate({rules:{name:"required",rate:{required:!0,number:!0}},messages:{name:"Please enter Tax name",rate:{required:"Tax percentage is required.",number:"Please enter a valid percentage."}}}),e.sortByTaxName=function(){"none"===$("#name").css("display")?(e.taxes.sort(function(e,t){return t.name.toLowerCase().localeCompare(e.name.toLowerCase())}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.taxes.sort(function(e,t){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#percentage").css({display:"none"}),$("#percentageUp").css({display:"none"})},e.sortByPercentage=function(){"none"===$("#percentage").css("display")?(e.taxes.sort(function(e,t){return e.rate<t.rate}),$("#percentage").css({display:"inline-table"}),$("#percentageUp").css({display:"none"})):(e.taxes.sort(function(e,t){return t.rate<e.rate}),$("#percentageUp").css({display:"inline-table"}),$("#percentage").css({display:"none"})),$("#name").css({display:"none"}),$("#nameUp").css({display:"none"})},e.print_values=function(){console.log("tax name: "+e.taxName),console.log("tax rate: "+e.taxRate),console.log("is compound: "+e.isCompound)},e.clearAddItemFields=function(){i(),$("#addTaxForm").validate().resetForm()},e.clearAddTaxGroupFields=function(){r(),$("#addTaxGroupForm").validate().resetForm()},e.saveNewGroupTax=function(){if($("#addTaxGroupForm").valid()){showLoader();for(var n=[],s=0,i=0,r=0,c=0;c<e.taxesForGroup.length;++c)e.shouldAdd[c]&&(n.push(e.taxesForGroup[c].entity),r+=e.taxesForGroup[c].rate,e.taxesForGroup[c].isCompound&&(i+=e.taxesForGroup[c].rate,s++));if(s>1)return ShowMessage("You can assign only one compund tax to a tax group.","error"),void hideLoader();if(n.length<1)return ShowMessage("You must select at least 1 tax.","error"),void hideLoader();var d={title:e.taxGroupName,value:r,compound:i,user:l,associatedTaxes:n};a.saveNewGroupTax(d,function(e){console.log(e),hideLoader(),fromTutorial?t.go("dashboard.settings.items"):($(".new-tax-group").removeClass("show"),o())})}},e.updateGroupTax=function(){if($("#editTaxGroupForm").valid()){showLoader();for(var t=[],n=0,s=0,a=0,i=0;i<e.taxesForGroup.length;++i)e.shouldAdd[i]&&(t.push(e.taxesForGroup[i].entity),a+=e.taxesForGroup[i].rate,e.taxesForGroup[i].isCompound&&(s+=e.taxesForGroup[i].rate,n++));if(n>1)return ShowMessage("You can assign only one compund tax to a tax group.","error"),void hideLoader();if(t.length<1)return ShowMessage("You must select at least 1 tax.","error"),void hideLoader();var r=e.selectedTax.entity;r.set("title",e.taxGroupName),r.set("value",a),r.set("compound",s),r.set("associatedTaxes",t),r.save().then(function(e){$(".edit-tax-group").removeClass("show"),o()})}},e.saveNewTax=function(){if($("#addTaxForm").valid()){showLoader();var n={title:e.taxName,value:Number(e.taxRate),compound:e.isCompound?1:0,user:l};a.saveNewTax(n,function(e){console.log(e),hideLoader(),fromTutorial?t.go("dashboard.settings.items"):($(".new-tax").removeClass("show"),o())})}},e.nextClicked=function(){$(".tutorial").hide()},e.editTax=function(t){1==t.type?($("#editTaxForm").validate().resetForm(),$(".edit-tax").addClass("show"),e.taxId=t.id,e.taxName=t.name,e.taxRate=t.rate,e.isCompound=t.isCompound):(e.selectedTax=t,$("#editTaxGroupForm").validate().resetForm(),$(".edit-tax-group").addClass("show"),c(t))},e.saveEditedTax=function(){if($("#editTaxForm").valid()){var t={taxId:e.taxId,taxName:e.taxName,taxRate:e.taxRate,isCompound:e.isCompound},n=a.saveEditedTax(t);$(".edit-tax").removeClass("show"),n.then(function(e){console.log("all done"),o()},function(e){console.log("from controller: "+e.message)})}},e.deleteTax=function(t){console.log("delete Click Now"),e.taxToDelete=t.id,$(".delete-tax").addClass("show")},e.confirmDelete=function(){showLoader();var t=Parse.Object.extend("Tax");new Parse.Query(t).get(e.taxToDelete,{success:function(e){e.destroy().then(function(){hideLoader(),window.location.reload()})},error:function(e,t){hideLoader(),console.log(t)}})},e.deleteTaxWithotConfirm=function(){showLoader();var t=Parse.Object.extend("Tax");new Parse.Query(t).get(e.taxId,{success:function(e){e.destroy().then(function(){hideLoader(),window.location.reload()})},error:function(e,t){hideLoader(),console.log(t)}})},e.search=function(){e.searchText.length?e.taxes=e.displayedTaxes.filter(function(t){return t.name||(t.name=""),t.rate||(t.rate=""),t.name.toLowerCase().includes(e.searchText.toLowerCase())||t.rate.toString().toLowerCase().includes(e.searchText.toLowerCase())}):e.taxes=e.displayedTaxes}}else console.log("User not logged in")}]),$(document).ready(function(){$.validator.addMethod("ConfirmPasswordMatch",function(e,t){return e==$("input[name='newPassword']").val()},""),$.validator.addMethod("UserNameExists",function(e,t){return!parseInt($("#username-exists").val())},"")}),invoicesUnlimited.controller("UserProfileController",["$scope","$state","$controller","userFactory","organizationFactory","projectUserFactory","$q",function(e,t,n,s,a,i,o){function r(){e.existingPassword="",e.newPassword="",e.confirmPassword=""}if(!s.entity.length)return console.log("User not logged in"),void t.go("login");if(n("DashboardController",{$scope:e,$state:t}),!e.userLogo){var c=s.entity[0].get("selectedOrganization");new Parse.Query("Organization").get(c.id,{success:function(t){e.org=t;var n=t.get("logo");e.userLogo=n?n._url:"./assets/images/user-icon.png",e.$$phase||e.$apply()},error:function(e,t){}})}$("#user-info-form").validate({onkeyup:function(e){$(e).valid()},onfocusout:function(e){$(e).valid()},rules:{name:{required:!0},email:{required:!0,email:!0},username:{required:!0}},messages:{name:{required:"Please enter name!"},email:{required:"Please enter email!",email:"Please enter valid email"},username:{required:"Please enter username!"}}});var l=s.entity[0];i.getByUsername(l.get("username")).then(function(t){e.projectUser=t}),o.when(l.fetch()).then(function(){e.UserInfo={name:l.get("fullName"),email:l.get("email"),username:l.get("username"),country:l.get("country")},hideLoader()}),e.saveBusiness=function(){$("#user-info-form").valid()&&(showLoader(),l.set("fullName",e.UserInfo.name),l.set("email",e.UserInfo.email),l.set("username",e.UserInfo.username),l.set("country",e.UserInfo.country),l.save().then(function(){e.projectUser?(e.projectUser.set("userName",l.get("username")),e.projectUser.set("country",l.get("country")),e.projectUser.set("emailID",l.get("email")),e.projectUser.set("title",l.get("fullName")),e.projectUser.save().then(function(){hideLoader(),showSnackbar("Save Successful. Reloading page in 3 sec..."),setTimeout(function(){window.location.reload()},2e3)})):(hideLoader(),showSnackbar("Save Successful. Reloading page in 3 sec..."),setTimeout(function(){window.location.reload()},2e3))},function(t){t.message.toLowerCase().includes("email")&&(e.emailError=t.message),t.message.toLowerCase().includes("username")&&(e.usernameError=t.message),e.$$phase||e.$apply(),hideLoader(),console.log(t.message)}))},$("#changePasswordForm").validate({onkeyup:function(e){$(e).valid()},onfocusout:!1,rules:{existingPassword:{required:!0},newPassword:{required:!0,minlength:6},confirmPassword:{required:!0,ConfirmPasswordMatch:!0}},messages:{existingPassword:{required:"Please enter existing password !",minlength:"Password should contain atleast 6 characters"},newPassword:{required:"Please enter new password !",minlength:"Password should contain atleast 6 characters"},confirmPassword:{required:"Please confirm password !",ConfirmPasswordMatch:"Passwords do not match!"}}}),e.showModal=function(){$("#changePasswordModal").show()},e.closeModal=function(){$("#changePasswordModal").hide(),r()},e.updatePassword=function(){$("#changePasswordForm").valid()&&(showLoader(),Parse.User.logIn(s.entity[0].username,e.existingPassword,{success:function(t){t.set("password",e.newPassword),t.save().then(function(){$("#changePasswordModal").hide(),r(),hideLoader()})},error:function(e,t){console.log(t.message),hideLoader(),ShowMessage("Incorrect Existing Password!","error")}}))}}]),invoicesUnlimited.controller("NewUserController",["$scope","$state","userFactory","roleFactory","$controller","$q","$uibModalInstance","user","method","title","appFields","queryService",function(e,t,n,s,a,i,o,r,c,l,d,u){function m(){e.user.set("password",e.user.password),e.user.set("colorTheme","appBlueColor"),e.user.set("isTrackUsage",1),e.user.set("getInvoiceNotification",1),e.user.set("subscription",!1),e.user.set("firstScreen","Dashboard"),e.user.set("tutorial",1),d.newCustomer.forEach(function(t){e.user.set(t,n.entity[0].get(t))});var t="Hello "+e.user.fullName+",<br/><br/>You have been invited by "+e.user.company+" to use Invoice Unlimited as "+e.user.role+".<br/>Please visit the <a href='http://invoicesunlimited.net/app/'>Link</a> and log in with your username and password listed below.<br/><br/>Username: "+e.user.username+"<br/>Password: "+e.user.password+"<br/><br/>Sent from Invoices Unlimited";e.user.save().then(function(e){var t=new(Parse.Object.extend("Preferencies"));return t.set("invoiceShippingCharges",0),t.set("creditNotes","Thank you for your business. If you have any questions, please contact us as soon as possible."),t.set("invoiceThanksNotes","Thank you for your payment. We appreciate your business and look forward to assisting you in the future."),t.set("creditTerms",""),t.set("invoiceDiscount",0),t.set("invoiceNotes","Thank you for your business. If you have any questions, please contact us as soon as possible."),t.set("estimateNotes","Thank you for your business. If you have any questions, please contact us as soon as possible."),t.set("invoiceTerms",""),t.set("estimateTerms",""),t.set("invoiceAdjustments",0),t.set("invoiceSalesPerson",0),t.set("invoiceAg",1),t.set("estimateAg",1),t.set("creditAg",1),t.set("userID",e),t.set("organization",e.get("selectedOrganization")),t.save().then(function(e){console.log("Preferencies created")},function(e){console.error(e)}),s.addUser(e)},function(e){return $("#userError").html(e.message),hideLoader(),i.reject()}).then(function(n){return e.user.sendInvite?Parse.Cloud.run("sendMailgunHtml",{toEmail:e.user.email,fromEmail:"no-reply@invoicesunlimited.com",subject:"Invoice Unlimited Login",html:t}).then(function(e){return e},function(e){return e}):Parse.Promise.as(!0)},p).then(function(t){hideLoader(),o.close(e.user)},p)}if(!n.entity.length)return o.dismiss("No signed in user"),void t.go("login");$("#userForm").validate({rules:{newusername:"required"},messages:{newusername:"Please enter username"}});var p=function(e){if(!e)return i.reject();console.log(e),hideLoader(),o.dismiss(e.message)};e.user=r,e.user.status=r.status,e.mustInvite=r.mustInvite,e.projectUser=r.projectUser,e.oldUserName=r.username,setObjectOperations({object:e.user,fields:d.user}),e.method=c,e.title=l,e.user.password="",e.user.sendInvite=!1,e.mustInvite&&(e.user.sendInvite=!0),e.delete=function(){$(".confirmation-pop-up").addClass("show")},e.update=function(){var t={};["username","fullName","email","role"].forEach(function(n){t[n]=e.user[n]}),showLoader(),Parse.Cloud.run("UpdateUser",{user:{id:e.user.id,params:t}}).then(function(t){return u.ext.find({className:"ProjectUser",field:"userName",value:e.oldUserName,methods:[{name:"include",param:"userID"}]})},p).then(function(t){return t.length?t[0].save({role:e.user.role,userName:e.user.username,title:e.user.fullName,emailID:e.user.email,status:e.user.status}):Parse.Promise.as(!1)},p).then(function(e){hideLoader(),o.close(e)},p)};var f="";e.save=function(){$("#userForm").validate({rules:{newusername:"required",fullName:"required",newemail:{required:!0,email:!0},password:{required:!0,minlength:6},role:"required"},messages:{newusername:"Please enter username",fullName:"Please enter full name",newemail:{required:"Please enter email",email:"Please enter valid email"},password:{required:"Please enter password",minlength:"Password must be at least 6 characters long"},role:"Please select role"}}),$("#userForm").valid()&&(f!=e.user.email&&(f=e.user.email),document.querySelector(".modal-content form").checkValidity()&&(showLoader(),m()))},e.closeModal=function(){o.dismiss("Close")}}]),invoicesUnlimited.controller("UsersController",["$scope","$state","$uibModal","$controller","$document","userFactory","projectUserFactory","queryService","appFields","$q",function(e,t,n,s,a,i,o,r,c,l){if(i.entity.length){if(s("DashboardController",{$scope:e,$state:t}),!e.userLogo){var d=i.entity[0].get("selectedOrganization");new Parse.Query("Organization").get(d.id,{success:function(t){e.org=t;var n=t.get("logo");e.userLogo=n?n._url:"./assets/images/user-icon.png",e.$$phase||e.$apply()},error:function(e,t){}})}e.users=[],hideLoader(),e.deleteUserConfirm=function(t){e.currenDeleteIndex=t,$(".confirmation-pop-up").addClass("show")},e.deleteUser=function(t){showLoader();var n=e.users[t].get("userID");if($(".confirmation-pop-up").removeClass("show"),n){var s=Parse.Object.extend("User"),a=new Parse.Query(s);return a.equalTo("username",e.users[t].userName),a.first({success:function(n){Parse.Cloud.run("deleteUser",{identificator:n.id}).then(function(n){return e.users[t].destroy()},function(e){console.log(e.message),hideLoader()}).then(function(n){window.location.reload(),e.$apply(function(){e.users.splice(t,1)}),hideLoader()},function(e){e&&console.log(e.message),hideLoader()})},error:function(e){alert("Error: "+e.code+" "+e.message)}})}},e.editUser=function(t){e.currenDeleteIndex=t,n.open({animation:!0,templateUrl:"modal-user",controller:"NewUserController",backdrop:!0,appendTo:angular.element(document.querySelector("#view")),windowTemplateUrl:"modal-window",resolve:{user:function(){var n=Parse.Object.extend("User"),s=new Parse.Query(n);return s.equalTo("username",e.users[t].userName),s.first({success:function(n){return setObjectOperations({object:n,fields:c.user}),n.status=e.users[t].status,n.projectUser=e.users[t],n},error:function(e){alert("Error: "+e.code+" "+e.message)}})},method:function(){return"update"},title:function(){return"Edit user"}}}).result.then(function(n){setObjectOperations({object:n,fields:c.projectUser}),e.users[t]=n},function(n){console.log("Dismiss modal"),n&&n.deleted&&e.users.splice(t,1)})},e.createUser=function(){n.open({animation:!0,templateUrl:"modal-user",controller:"NewUserController",backdrop:!0,appendTo:angular.element(document.querySelector("#view")),windowTemplateUrl:"modal-window",resolve:{user:function(){var e=new(Parse.Object.extend(Parse.User));return setObjectOperations({object:e,fields:c.user}),e},method:function(){return"create"},title:function(){return"Add User"}}}).result.then(function(t){setObjectOperations({object:t,fields:c.user});o.createNew({emailID:t.email,role:t.role,userName:t.username,country:t.country,title:t.fullName,organization:t.selectedOrganization,companyName:t.company,userID:i.entity[0],status:"Activated",organization:i.entity[0].get("selectedOrganization")}).then(function(t){showSnackbar("User Added successfully."),e.$apply(function(){e.users.push(t)})},function(e){console.log(e.message)})},function(){console.log("Dismiss modal")})},e.inviteUser=function(){n.open({animation:!0,templateUrl:"modal-user",controller:"NewUserController",backdrop:!0,appendTo:angular.element(document.querySelector("#view")),windowTemplateUrl:"modal-window",resolve:{user:function(){var e=new(Parse.Object.extend(Parse.User));return setObjectOperations({object:e,fields:c.user}),e.mustInvite=!0,e},method:function(){return"create"},title:function(){return"Add User"}}}).result.then(function(t){setObjectOperations({object:t,fields:c.user});o.createNew({emailID:t.email,role:t.role,userName:t.username,country:t.country,title:t.fullName,organization:t.selectedOrganization,companyName:t.company,userID:i.entity[0],status:"Activated"}).then(function(t){e.$apply(function(){e.users.push(t)})},function(e){console.log(e.message)})},function(){console.log("Dismiss modal")})},l.when(o.getAll()).then(function(t,n){e.users=t.map(function(e){return setObjectOperations({object:e,fields:c.projectUser}),e}),e.users=e.users.filter(function(e){return"Main"!=e.role&&e.userName!=i.entity[0].get("username")}),e.dispalyedUsers=e.users,e.sortByUserName()}),e.sortByUserName=function(){"none"===$("#name").css("display")?(e.users.sort(function(e,t){return e.userName.localeCompare(t.userName)}),$("#name").css({display:"inline-table"}),$("#nameUp").css({display:"none"})):(e.users.sort(function(e,t){return t.userName.localeCompare(e.userName)}),$("#nameUp").css({display:"inline-table"}),$("#name").css({display:"none"})),$("#email").css({display:"none"}),$("#role").css({display:"none"}),$("#status").css({display:"none"}),$("#emailUp").css({display:"none"}),$("#roleUp").css({display:"none"}),$("#statusUp").css({display:"none"})},e.sortByemail=function(){e.users.sort(function(e,t){return e.emailID.localeCompare(t.emailID)}),"none"===$("#email").css("display")?(e.users.sort(function(e,t){return e.userName.localeCompare(t.userName)}),$("#email").css({display:"inline-table"}),$("#emailUp").css({display:"none"})):(e.users.sort(function(e,t){return t.userName.localeCompare(e.userName)}),$("#emailUp").css({display:"inline-table"}),$("#email").css({display:"none"})),$("#name").css({display:"none"}),$("#role").css({display:"none"}),$("#status").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#roleUp").css({display:"none"}),$("#statusUp").css({display:"none"})},e.sortByRole=function(){"none"===$("#role").css("display")?(e.users.sort(function(e,t){return e.role.localeCompare(t.role)}),$("#role").css({display:"inline-table"}),$("#roleUp").css({display:"none"})):(e.users.sort(function(e,t){return t.role.localeCompare(e.role)}),$("#roleUp").css({display:"inline-table"}),$("#role").css({display:"none"})),$("#name").css({display:"none"}),$("#email").css({display:"none"}),$("#status").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#emailUp").css({display:"none"}),$("#statusUp").css({display:"none"})},e.sortByStatus=function(){"none"===$("#status").css("display")?(e.users.sort(function(e,t){return e.status.localeCompare(t.status)}),$("#status").css({display:"inline-table"}),$("#statusUp").css({display:"none"})):(e.users.sort(function(e,t){return t.status.localeCompare(e.status)}),$("#statusUp").css({display:"inline-table"}),$("#status").css({display:"none"})),$("#name").css({display:"none"}),$("#email").css({display:"none"}),$("#role").css({display:"none"}),$("#nameUp").css({display:"none"}),$("#emailUp").css({display:"none"}),$("#roleUp").css({display:"none"})},e.search=function(){e.searchText.length?e.users=e.dispalyedUsers.filter(function(t){return t.userName||(t.userName=""),t.emailID||(t.emailID=""),t.role||(t.role=""),t.status||(t.status=""),t.userName.toLowerCase().includes(e.searchText.toLowerCase())||t.emailID.toLowerCase().includes(e.searchText.toLowerCase())||t.role.toLowerCase().includes(e.searchText.toLowerCase())||t.status.toLowerCase().includes(e.searchText.toLowerCase())}):e.users=e.dispalyedUsers}}else t.go("login")}]);